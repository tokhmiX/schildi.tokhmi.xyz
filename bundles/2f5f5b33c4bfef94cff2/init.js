(window.webpackJsonp=window.webpackJsonp||[]).push([[14],[,,,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ClientReady="im.vector.ready",e.HangupCall="im.vector.hangup",e.StartLiveStream="im.vector.start_live_stream",e.OpenIntegrationManager="integration_manager_open",e.ViewRoom="io.element.view_room"}(n||(n={}))},,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(13),i=s.n(n);async function a(e=""){""===e||e.endsWith("/")||(e+="/");const t=o(`${e}config.${document.domain}.json`),s=o(e+"config.json");try{const e=await t;if(0===Object.keys(e).length)throw new Error;return e}catch(e){return await s}}function o(e){return new Promise((function(t,s){i()({method:"GET",url:e,qs:{cachebuster:Date.now()}},(e,n,i)=>{try{if(e||n.status<200||n.status>=300)return n&&(404==n.status||0==n.status&&""==i)&&t({}),void s({err:e,response:n});t(JSON.parse(i))}catch(e){s({err:e})}})}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"rageshakePromise",(function(){return $})),s.d(t,"preparePlatform",(function(){return z})),s.d(t,"setupLogStorage",(function(){return J})),s.d(t,"loadConfig",(function(){return Y})),s.d(t,"loadOlm",(function(){return Q})),s.d(t,"loadLanguage",(function(){return X})),s.d(t,"loadSkin",(function(){return Z})),s.d(t,"loadTheme",(function(){return ee})),s.d(t,"loadApp",(function(){return te})),s.d(t,"showError",(function(){return se})),s.d(t,"showIncompatibleBrowser",(function(){return ne})),s.d(t,"_t",(function(){return ie}));var n=s(1048),i=s(1049),a=s.n(i),o=s(148),r=s(82),c=s.n(r),l=s(84),d=s(89),h=s(246),u=s.n(h),m=s(279);var p=s(87),g=s(93),v=s(455),f=s(90),b=s(166),y=s(96),E=s(398),S=s(108),_=s(197),w=s(92),C=s(582),O=s(146),k=s(1020),R=s(14),I=s(1643);class x extends m.e{constructor(...e){super(...e),u()(this,"_favicon",void 0)}async getConfig(){return Object(R.a)()}getHumanReadableName(){return"Vector Base Platform"}get favicon(){return this._favicon?this._favicon:this._favicon=new I.a}updateFavicon(){let e="#d00",t=this.notificationCount;this.errorDidOccur&&(t=t||"×",e="#f00"),this.favicon.badge(t,{bgColor:e})}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),this.updateFavicon())}setErrorStatus(e){this.errorDidOccur!==e&&(super.setErrorStatus(e),this.updateFavicon())}startUpdater(){}getDefaultDeviceDisplayName(){return Object(l.a)("Unknown device")}}var T=s(1);function j(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const N=window.electron,P=navigator.platform.toUpperCase().includes("MAC");function D(e){["call_state"].includes(e.action)&&N.send("app_onAction",e)}class M extends class{async supportsEventIndexing(){return!0}async initEventIndex(e,t){throw new Error("Unimplemented")}async addEventToIndex(e,t){throw new Error("Unimplemented")}async deleteEvent(e){throw new Error("Unimplemented")}async isEventIndexEmpty(){throw new Error("Unimplemented")}indexIsEmpty(){throw new Error("Unimplemented")}isRoomIndexed(e){throw new Error("Unimplemented")}async getStats(){throw new Error("Unimplemented")}async getUserVersion(){throw new Error("Unimplemented")}async setUserVersion(e){throw new Error("Unimplemented")}async commitLiveEvents(){throw new Error("Unimplemented")}async searchEventIndex(e){throw new Error("Unimplemented")}async addHistoricEvents(e,t,s){throw new Error("Unimplemented")}async addCrawlerCheckpoint(e){throw new Error("Unimplemented")}async removeCrawlerCheckpoint(e){throw new Error("Unimplemented")}async loadCheckpoints(){throw new Error("Unimplemented")}async loadFileEvents(e){throw new Error("Unimplemented")}async closeEventIndex(){throw new Error("Unimplemented")}async deleteEventIndex(){throw new Error("Unimplemented")}}{constructor(){super(),u()(this,"pendingIpcCalls",{}),u()(this,"nextIpcCallId",0),u()(this,"onIpcReply",(e,t)=>{if(void 0===t.id)return void T.a.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void T.a.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),N.on("seshatReply",this.onIpcReply)}async ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,i)=>{this.pendingIpcCalls[s]={resolve:n,reject:i},window.electron.send("seshat",{id:s,name:e,args:t})})}async supportsEventIndexing(){return this.ipcCall("supportsEventIndexing")}async initEventIndex(e,t){return this.ipcCall("initEventIndex",e,t)}async addEventToIndex(e,t){return this.ipcCall("addEventToIndex",e,t)}async deleteEvent(e){return this.ipcCall("deleteEvent",e)}async isEventIndexEmpty(){return this.ipcCall("isEventIndexEmpty")}async isRoomIndexed(e){return this.ipcCall("isRoomIndexed",e)}async commitLiveEvents(){return this.ipcCall("commitLiveEvents")}async searchEventIndex(e){return this.ipcCall("searchEventIndex",e)}async addHistoricEvents(e,t,s){return this.ipcCall("addHistoricEvents",e,t,s)}async addCrawlerCheckpoint(e){return this.ipcCall("addCrawlerCheckpoint",e)}async removeCrawlerCheckpoint(e){return this.ipcCall("removeCrawlerCheckpoint",e)}async loadFileEvents(e){return this.ipcCall("loadFileEvents",e)}async loadCheckpoints(){return this.ipcCall("loadCheckpoints")}async closeEventIndex(){return this.ipcCall("closeEventIndex")}async getStats(){return this.ipcCall("getStats")}async getUserVersion(){return this.ipcCall("getUserVersion")}async setUserVersion(e){return this.ipcCall("setUserVersion",e)}async deleteEventIndex(){return this.ipcCall("deleteEventIndex")}}class A extends x{constructor(){super(),u()(this,"eventIndexManager",new M),u()(this,"pendingIpcCalls",{}),u()(this,"nextIpcCallId",0),u()(this,"ssoID",Object(_.b)(32)),u()(this,"onUpdateDownloaded",async(e,{releaseNotes:t,releaseName:s})=>{p.a.dispatch({action:w.a.CheckUpdates,status:m.d.Ready}),this.shouldShowUpdate(s)&&Object(C.b)(await this.getAppVersion(),s,t)}),u()(this,"onIpcReply",(e,t)=>{if(void 0===t.id)return void T.a.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void T.a.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),p.a.register(D),N.on("check_updates",(e,t)=>{p.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?j(Object(s),!0).forEach((function(t){u()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):j(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:w.a.CheckUpdates},function(e){return!0===e?{status:m.d.Downloading}:!1===e?{status:m.d.NotAvailable}:{status:m.d.Error,detail:e}}(t)))}),N.on("before-quit",(function(){T.a.log("element-desktop closing"),v.b()})),N.on("ipcReply",this.onIpcReply),N.on("update-downloaded",this.onUpdateDownloaded),N.on("preferences",()=>{p.a.fire(w.a.ViewUserSettings)}),N.on("userDownloadCompleted",(e,{path:t,name:s})=>{const n="DOWNLOAD_TOAST_"+t;O.a.sharedInstance().addOrReplaceToast({key:n,title:Object(l.a)("Download Completed"),props:{description:s,acceptLabel:Object(l.a)("Open"),onAccept:()=>{N.send("userDownloadOpen",{path:t}),O.a.sharedInstance().dismissToast(n)},dismissLabel:Object(l.a)("Dismiss"),numSeconds:10},component:k.a,priority:99})}),Object(E.e)(E.b.NAVIGATION,{keybinds:[{modifiers:[E.a],key:E.c}],description:Object(l.b)("Switch to space by number")}),P?(Object(E.e)(E.b.NAVIGATION,{keybinds:[{modifiers:[E.d.COMMAND],key:S.a.COMMA}],description:Object(l.b)("Open user settings")}),Object(E.e)(E.b.NAVIGATION,{keybinds:[{modifiers:[E.d.COMMAND],key:S.a.SQUARE_BRACKET_LEFT},{modifiers:[E.d.COMMAND],key:S.a.SQUARE_BRACKET_RIGHT}],description:Object(l.b)("Previous/next recently visited room or community")})):Object(E.e)(E.b.NAVIGATION,{keybinds:[{modifiers:[E.d.ALT],key:S.a.ARROW_LEFT},{modifiers:[E.d.ALT],key:S.a.ARROW_RIGHT}],description:Object(l.b)("Previous/next recently visited room or community")}),this.ipcCall("startSSOFlow",this.ssoID)}async getConfig(){return this.ipcCall("getConfig")}getHumanReadableName(){return"Electron Platform"}supportsMultiLanguageSpellCheck(){return!P}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),N.send("setBadgeCount",e))}supportsNotifications(){return!0}maySendNotifications(){return!0}displayNotification(e,t,s,n){navigator.userAgent.includes("Linux")&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"));const i={body:t,silent:!0};s&&(i.icon=s);const a=new window.Notification(e,i);return a.onclick=()=>{p.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),this.ipcCall("focusWindow")},a}loudNotification(e,t){N.send("loudNotification")}async getAppVersion(){return this.ipcCall("getAppVersion")}supportsAutoLaunch(){return!0}async getAutoLaunchEnabled(){return this.ipcCall("getAutoLaunchEnabled")}async setAutoLaunchEnabled(e){return this.ipcCall("setAutoLaunchEnabled",e)}supportsWarnBeforeExit(){return!0}async shouldWarnBeforeExit(){return this.ipcCall("shouldWarnBeforeExit")}async setWarnBeforeExit(e){return this.ipcCall("setWarnBeforeExit",e)}supportsAutoHideMenuBar(){return!P}async getAutoHideMenuBarEnabled(){return this.ipcCall("getAutoHideMenuBarEnabled")}async setAutoHideMenuBarEnabled(e){return this.ipcCall("setAutoHideMenuBarEnabled",e)}supportsMinimizeToTray(){return!P}async getMinimizeToTrayEnabled(){return this.ipcCall("getMinimizeToTrayEnabled")}async setMinimizeToTrayEnabled(e){return this.ipcCall("setMinimizeToTrayEnabled",e)}async canSelfUpdate(){const e=await this.ipcCall("getUpdateFeedUrl");return Boolean(e)}startUpdateCheck(){super.startUpdateCheck(),N.send("check_updates")}installUpdate(){N.send("install_update")}getDefaultDeviceDisplayName(){const e=g.a.get().brand;return Object(l.a)("%(brand)s Desktop (%(platformName)s)",{brand:e,platformName:navigator.userAgent.includes("Macintosh")?"macOS":navigator.userAgent.includes("FreeBSD")?"FreeBSD":navigator.userAgent.includes("OpenBSD")?"OpenBSD":navigator.userAgent.includes("SunOS")?"SunOS":navigator.userAgent.includes("Windows")?"Windows":navigator.userAgent.includes("Linux")?"Linux":"Unknown"})}screenCaptureErrorString(){return null}requestNotificationPermission(){return Promise.resolve("granted")}reload(){window.location.reload()}async ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,i)=>{this.pendingIpcCalls[s]={resolve:n,reject:i},window.electron.send("ipcCall",{id:s,name:e,args:t})})}getEventIndexingManager(){return this.eventIndexManager}async setLanguage(e){return this.ipcCall("setLanguage",e)}setSpellCheckLanguages(e){this.ipcCall("setSpellCheckLanguages",e).catch(e=>{T.a.log("Failed to send setSpellCheckLanguages IPC to Electron"),T.a.error(e)})}async getSpellCheckLanguages(){return this.ipcCall("getSpellCheckLanguages")}async getAvailableSpellCheckLanguages(){return this.ipcCall("getAvailableSpellCheckLanguages")}getSSOCallbackUrl(e){const t=super.getSSOCallbackUrl(e);return t.protocol="element",t.searchParams.set("element-desktop-ssoid",this.ssoID),t}startSingleSignOn(e,t,s,n){super.startSingleSignOn(e,t,s,n),f.a.createTrackedDialog("Electron","SSO",b.a,{title:Object(l.a)("Go to your browser to complete Sign In"),description:c.a.createElement(y.a,null)})}navigateForwardBack(e){this.ipcCall(e?"navigateBack":"navigateForward")}navigateToSpace(e){p.a.dispatch({action:w.a.SwitchSpace,num:e})}onKeyDown(e){let t=!1;switch(e.key){case S.a.SQUARE_BRACKET_LEFT:case S.a.SQUARE_BRACKET_RIGHT:!P||!e.metaKey||e.altKey||e.ctrlKey||e.shiftKey||(this.navigateForwardBack(e.key===S.a.SQUARE_BRACKET_LEFT),t=!0);break;case S.a.ARROW_LEFT:case S.a.ARROW_RIGHT:P||!e.altKey||e.metaKey||e.ctrlKey||e.shiftKey||(this.navigateForwardBack(e.key===S.a.ARROW_LEFT),t=!0)}if(!t&&!d.b.getValue("showCommunitiesInsteadOfSpaces")&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&Object(S.d)(e)){const s=e.code.slice(5);this.navigateToSpace(parseInt(s,10)),t=!0}return t}async getPickleKey(e,t){try{return await this.ipcCall("getPickleKey",e,t)}catch(e){return null}}async createPickleKey(e,t){try{return await this.ipcCall("createPickleKey",e,t)}catch(e){return null}}async destroyPickleKey(e,t){try{await this.ipcCall("destroyPickleKey",e,t)}catch(e){}}}var U=s(13),L=s.n(U),F=s(1644),B=s.n(F);function V(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class K extends x{constructor(){super(),u()(this,"pollForUpdate",()=>this.getMostRecentVersion().then(e=>{const t=this.getNormalizedAppVersion("!!UNSET!!");return t!==e?(this.shouldShowUpdate(e)&&Object(C.b)(t,e),{status:m.d.Ready}):(Object(C.a)(),{status:m.d.NotAvailable})},e=>(T.a.error("Failed to poll for update",e),{status:m.d.Error,detail:e.message||e.status?e.status.toString():"Unknown Error"}))),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js")}getHumanReadableName(){return"Web Platform"}supportsNotifications(){return Boolean(window.Notification)}maySendNotifications(){return"granted"===window.Notification.permission}requestNotificationPermission(){return new Promise((function(e,t){window.Notification.requestPermission(t=>{e(t)})}))}displayNotification(e,t,s,n){const i={body:t,tag:"vector",silent:!0};s&&(i.icon=s);const a=new window.Notification(e,i);return a.onclick=function(){p.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),a.close()},a}getMostRecentVersion(){return new Promise((e,t)=>{L()({method:"GET",url:"version",qs:{cachebuster:Date.now()}},(s,n,i)=>{if(s||n.status<200||n.status>=300)return null===s&&(s={status:n.status}),void t(s);e(this.getNormalizedAppVersion(i.trim()))})})}getNormalizedAppVersion(e){return new RegExp("^v[0-9]+.[0-9]+.[0-9]+(-.+)?$").test(e)?e.substr(1):e}getAppVersion(){return Promise.resolve(this.getNormalizedAppVersion("!!UNSET!!"))}startUpdater(){this.pollForUpdate(),setInterval(this.pollForUpdate,6e5)}async canSelfUpdate(){return!0}startUpdateCheck(){super.startUpdateCheck(),this.pollForUpdate().then(e=>{p.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?V(Object(s),!0).forEach((function(t){u()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):V(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:w.a.CheckUpdates},e))})}installUpdate(){window.location.reload()}getDefaultDeviceDisplayName(){const e=new URL(window.location.href),t=[e.host,e.pathname.replace(/\/$/,"")].join(""),s=new B.a,n=s.getBrowser().name||"unknown browser";let i=s.getOS().name||"unknown OS";return"Mac OS"===i&&(i="macOS"),Object(l.a)("%(appName)s (%(browserName)s, %(osName)s)",{appName:t,browserName:n,osName:i})}screenCaptureErrorString(){return"https:"!==window.location.protocol?Object(l.a)("You need to be using HTTPS to place a screen-sharing call."):null}reload(){window.location.reload()}}class W extends K{setNotificationCount(e){if(!navigator.setAppBadge)return super.setNotificationCount(e);this.notificationCount!==e&&(this.notificationCount=e,navigator.setAppBadge(e).catch(e=>{T.a.error("Failed to update PWA app badge",e)}))}}var G=s(121),H=s(309),q=s(453);window.mxSendRageshake=function(e,t){const s=g.a.get().bug_report_endpoint_url;s?(void 0===t&&(t=!0),e&&e.trim()?Object(q.a)(s,{userText:e,sendLogs:t,progressCallback:T.a.log.bind(console)}).then(()=>{T.a.log("Bug report sent!")},e=>{T.a.error(e)}):T.a.error("Cannot send a rageshake without a message - please tell us what went wrong")):T.a.error("Cannot send a rageshake - no bug_report_endpoint_url configured")};const $=function(){const e=v.d(!1);return e.then(()=>{T.a.log("Initialised rageshake."),T.a.log("To fix line numbers in Chrome: Meatball menu → Settings → Ignore list → Add /rageshake\\.js$"),window.addEventListener("beforeunload",e=>{T.a.log("element-web closing"),v.b()}),v.a()},e=>{T.a.error("Failed to initialise rageshake: "+e)}),e}();function z(){window.electron?(T.a.log("Using Electron platform"),G.a.set(new A)):window.matchMedia("(display-mode: standalone)").matches?(T.a.log("Using PWA platform"),G.a.set(new W)):(T.a.log("Using Web platform"),G.a.set(new K))}function J(){return g.a.get().bug_report_endpoint_url?v.e():(T.a.warn("No bug report endpoint set - logs will not be persisted"),Promise.resolve())}async function Y(){g.a.put(await G.a.get().getConfig()||{})}function Q(){return a.a.init({locateFile:()=>n.a}).then(()=>{T.a.log("Using WebAssembly Olm")}).catch(e=>(T.a.log("Failed to load Olm: trying legacy version",e),new Promise((e,t)=>{const s=document.createElement("script");s.src="olm_legacy.js",s.onload=e,s.onerror=t,document.body.appendChild(s)}).then(()=>window.Olm.init()).then(()=>{T.a.log("Using legacy Olm")}).catch(e=>{T.a.log("Both WebAssembly and asm.js Olm failed!",e)})))}async function X(){const e=d.b.getValue("language",null,!0);let t=[];e?t=[e]:l.e().forEach(e=>{t.push(...l.f(e))});try{await l.k(t),document.documentElement.setAttribute("lang",l.d())}catch(e){T.a.error("Unable to set language",e)}}async function Z(){T.a.log("Loading skin...");const[e,t]=await Promise.all([Promise.resolve().then(s.bind(null,107)),s.e(12).then(s.bind(null,1667))]);e.loadSkin(t),T.a.log("Skin loaded!")}async function ee(){Object(H.f)()}async function te(e){const t=await s.e(11).then(s.bind(null,1662));window.matrixChat=o.render(await t.loadApp(e),document.getElementById("matrixchat"))}async function se(e,t){const n=(await s.e(13).then(s.bind(null,1663))).default;window.matrixChat=o.render(r.createElement(n,{title:e,messages:t}),document.getElementById("matrixchat"))}async function ne(e){const t=(await s.e(10).then(s.bind(null,1664))).default;window.matrixChat=o.render(r.createElement(t,{onAccept:e}),document.getElementById("matrixchat"))}const ie=l.a},,,function(e,t,s){"use strict";s.d(t,"h",(function(){return g})),s.d(t,"g",(function(){return v})),s.d(t,"b",(function(){return f})),s.d(t,"a",(function(){return b})),s.d(t,"j",(function(){return y})),s.d(t,"k",(function(){return S})),s.d(t,"c",(function(){return _})),s.d(t,"e",(function(){return w})),s.d(t,"f",(function(){return C})),s.d(t,"d",(function(){return k})),s.d(t,"i",(function(){return R}));var n=s(340),i=s.n(n),a=s(1054),o=s.n(a),r=s(82),c=s.n(r),l=s(89),d=s(121),h=s.p+"i18n/languages.1a2a11c.json",u=s(100),m=s(370),p=s(1);function g(e){const t=new Error(e);return t.translatedMessage=b(e),t}function v(){const e=l.b.getValue("language",null,!0);return e||O(w()[0])}function f(e){return e}function b(e,t,s){const n=function(e,t,s){let n=e;if(void 0!==t){const e={};for(const s in t)e[`%\\(${s}\\)s`]=t[s];n=E(n,e)}if(void 0!==s){const e={};for(const t in s)e[`(<${t}>(.*?)<\\/${t}>|<${t}>|<${t}\\s*\\/>)`]=s[t];n=E(n,e)}return n}(function(e,t){let s;t&&"object"==typeof t&&(s=t.count,Object.keys(t).forEach(e=>{void 0===t[e]&&(p.a.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),t[e]="undefined"),null===t[e]&&(p.a.warn("safeCounterpartTranslate called with null interpolation name: "+e),t[e]="null")}));let n=o.a.translate(e,t);return void 0===n&&void 0!==s&&(n=o.a.translate(e,Object.assign({},t,{locale:"en"}))),n}(e,Object.assign({interpolate:!1},t)),t,s);return n}function y(e){return e.replace(/%\(([^)]*)\)/g,"% ($1)")}function E(e,t){const s=[e];let n=!1;for(const i in t){const a=new RegExp(i,"g");let o=!1;for(let e=0;e<s.length;e++){const r=s[e];if("string"!=typeof r)continue;let c=a.exec(r);if(!c)continue;o=!0;const l=r.substr(0,c.index),d=[];let h;for(;c;){h=c;const e=c.slice(2);let s,o;if(s=t[i]instanceof Function?t[i](...e):t[i],"object"==typeof s&&(n=!0),"string"==typeof s&&""===s||d.push(s),c=a.exec(r),c){const e=h.index+h[0].length;o=r.substr(e,c.index-e)}else o=r.substr(h.index+h[0].length);o&&d.push(o)}s.splice(e,1,...d),""!==l&&s.splice(e,0,l)}o||"%\\(count\\)s"!==i&&p.a.log(`Could not find ${a} in ${e}`)}return n?c.a.createElement("span",null,...s):s.join("")}function S(e){Array.isArray(e)||(e=[e]);const t=d.a.get();let s,n;return t&&t.setLanguage(e),I().then(t=>{n=t;for(let t=0;t<e.length;++t)if(n.hasOwnProperty(e[t])){s=e[t];break}return s||(s="en",p.a.error("Unable to find an appropriate language")),x("i18n/"+n[s].fileName)}).then(e=>{if(o.a.registerTranslations(s,e),o.a.setLocale(s),l.b.setValue("language",null,u.a.DEVICE,s),p.a.log("set language to "+s),"en"!==s)return x("i18n/"+n.en.fileName)}).then(e=>{e&&o.a.registerTranslations("en",e)})}function _(){return I().then(e=>{const t=[];for(const s in e)e.hasOwnProperty(s)&&t.push({value:s,label:e[s].label});return t})}function w(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]}function C(e){const t=[],s=O(e),n=s.split("-");return 2===n.length&&n[0]===n[1]?t.push(n[0]):(t.push(s),2===n.length&&t.push(n[0])),t}function O(e){return e.toLowerCase().replace("_","-")}function k(){return o.a.getLocale()}function R(e){const t=k(),s=e.map(O);{const n=s.indexOf(t);if(n>-1)return e[n]}{const n=s.findIndex(e=>e.substr(0,2)===t.substr(0,2));if(n>-1)return e[n]}{const t=s.findIndex(e=>e.startsWith("en"));if(t>-1)return e[t]}return e[0]}function I(){return new Promise((e,t)=>{let s;s="string"==typeof h?h:"i18n/languages.json",i()({method:"GET",url:s},(n,i,a)=>{n?t(n):i.status<200||i.status>=300?t(new Error(`Failed to load ${s}, got ${i.status}`)):e(JSON.parse(a))})})}async function x(e,t=3){return Object(m.a)(()=>function(e){return new Promise((t,s)=>{i()({method:"GET",url:e},(n,i,a)=>{n?s(n):i.status<200||i.status>=300?s(new Error(`Failed to load ${e}, got ${i.status}`)):t(function(e){const t={};for(const s of Object.keys(e)){const n=s.split("|",2);if(2===n.length){let i=t[n[0]];void 0===i&&(i={},t[n[0]]=i),i[n[1]]=e[s]}else t[s]=e[s]}return t}(JSON.parse(a)))})})}(e),t,t=>(p.a.log("Failed to load i18n",e),p.a.error(t),!0))}o.a.setSeparator("|"),o.a.setFallbackLocale("en")},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(107);function i(e,t){return()=>n.getComponent(e)||t}},function(e,t,s){"use strict";s.d(t,"a",(function(){return A}));var n=s(83),i=s.n(n),a=s(156),o=s(286),r=s(4),c=s(157),l=s(281),d=s(107),h=s(659),u=s(89),m=s(87);function p(e,t,s){return{action:"MatrixActions.sync",state:t,prevState:s,matrixClient:e}}function g(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function v(e,t,s){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:s}}function f(e,t){return{action:"MatrixActions.Room",room:t}}function b(e,t,s){return{action:"MatrixActions.Room.tags",room:s}}function y(e,t,s){return{action:"MatrixActions.Room.receipt",event:t,room:s,matrixClient:e}}function E(e,t,s,n,i,a){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:a.liveEvent,isLiveUnfilteredRoomTimelineEvent:s&&a.timeline.getTimelineSet()===s.getUnfilteredTimelineSet()}}function S(e,t,s,n){return{action:"MatrixActions.Room.myMembership",room:t,membership:s,oldMembership:n}}function _(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}let w=[];function C(e,t,s){const n=(...t)=>{const n=s(e,...t);n&&m.a.dispatch(n,!0)};e.on(t,n),w.push(()=>{e.removeListener(t,n)})}var O={start(e){C(e,"sync",p),C(e,"accountData",g),C(e,"Room.accountData",v),C(e,"Room",f),C(e,"Room.tags",b),C(e,"Room.receipt",y),C(e,"Room.timeline",E),C(e,"Room.myMembership",S),C(e,"Event.decrypted",_)},stop(){w.forEach(e=>e()),w=[]}},k=s(90),R=s(347),I=s(408),x=s(391),T=s(210),j=s(188),N=s(351),P=s(230),D=s(1);class M{constructor(){i()(this,"opts",{initialSyncLimit:20}),i()(this,"matrixClient",null),i()(this,"justRegisteredUserId",void 0),i()(this,"currentClientCreds",void 0)}get(){return this.matrixClient}unset(){this.matrixClient=null,O.stop()}setJustRegisteredUserId(e){this.justRegisteredUserId=e,e&&window.localStorage.setItem("mx_registration_time",String((new Date).getTime()))}currentUserIsJustRegistered(){return this.matrixClient&&this.matrixClient.credentials.userId===this.justRegisteredUserId}userRegisteredWithinLastHours(e){try{const t=new Date(window.localStorage.getItem("mx_registration_time"));return((new Date).getTime()-t.getTime())/36e5<=e}catch(e){return!1}}replaceUsingCreds(e){this.currentClientCreds=e,this.createClient(e)}async assign(){for(const e of["indexeddb","memory"])try{const e=this.matrixClient.store.startup();D.a.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await e;break}catch(t){if("indexeddb"!==e)throw D.a.error("Failed to start memory store!",t),t;D.a.error("Error starting matrixclient store - falling back to memory store",t),this.matrixClient.store=new o.a({localStorage:localStorage})}x.f(this.matrixClient);try{!u.b.getValue("lowBandwidth")&&this.matrixClient.initCrypto&&(await this.matrixClient.initCrypto(),this.matrixClient.setCryptoTrustCrossSignedDevices(!u.b.getValue("e2ee.manuallyVerifyAllSessions")),await Object(j.f)(this.matrixClient),x.e(!0))}catch(e){if(e&&"InvalidCryptoStoreError"===e.name){const e=d.getComponent("views.dialogs.CryptoStoreTooNewDialog");k.a.createDialog(e)}D.a.warn("Unable to initialise e2e",e)}const e=r.j(this.opts);return e.pendingEventOrdering=a.PendingEventOrdering.Detached,e.lazyLoadMembers=!0,e.clientWellKnownPollPeriod=7200,e.experimentalThreadSupport=u.b.getValue("feature_thread"),O.start(this.matrixClient),I.a.matrixClient=this.matrixClient,e}async start(){const e=await this.assign();D.a.log("MatrixClientPeg: really starting MatrixClient"),await this.get().startClient(e),D.a.log("MatrixClientPeg: MatrixClient started")}getCredentials(){return{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()}}getHomeserverName(){const e=/^@[^:]+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}createClient(e){const t={baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,pickleKey:e.pickleKey,timelineSupport:!0,forceTURN:!u.b.getValue("webRtcAllowPeerToPeer"),fallbackICEServerAllowed:!!u.b.getValue("fallbackICEServerAllowed"),iceCandidatePoolSize:20,verificationMethods:[R.d.SAS,N.d,R.d.RECIPROCATE_QR_CODE],unstableClientRelationAggregation:!0,identityServer:new T.a,cryptoCallbacks:{}};Object.assign(t.cryptoCallbacks,j.c),P.a.getDehydrationKey&&(t.cryptoCallbacks.getDehydrationKey=P.a.getDehydrationKey),this.matrixClient=Object(h.a)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));const s=new l.b(null,{timelineSupport:!0,pendingEvents:!1});s.getLiveTimeline().setPaginationToken("",c.b.BACKWARDS),this.matrixClient.setNotifTimelineSet(s)}}window.mxMatrixClientPeg||(window.mxMatrixClientPeg=new M);const A=window.mxMatrixClientPeg},function(e,t,s){"use strict";(function(e){var n=s(1137),i=s(432);class a extends n.Dispatcher{dispatch(e,t=!1){e instanceof i.a?e.fn(e=>{this.dispatch(e,t)}):t?super.dispatch(e):setTimeout(super.dispatch.bind(this,e),0)}fire(e,t=!1){this.dispatch({action:e},t)}}const o=new a,r=e;r.mxDispatcher||(r.mxDispatcher=o),t.a=o}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(102),i=s.n(n),a=s(82),o=s.n(a),r=s(108),c=s(91),l=s.n(c);const d=["element","onClick","children","kind","disabled","inputRef","className","onKeyDown","onKeyUp"];function h(e){let{element:t,onClick:s,children:n,kind:a,disabled:c,inputRef:h,className:u,onKeyDown:m,onKeyUp:p}=e;const g=i()(e,d);return c?g["aria-disabled"]=!0:(g.onClick=s,g.onKeyDown=e=>{if(e.key===r.a.ENTER)return e.stopPropagation(),e.preventDefault(),s(e);e.key===r.a.SPACE?(e.stopPropagation(),e.preventDefault()):null==m||m(e)},g.onKeyUp=e=>{if(e.key===r.a.SPACE)return e.stopPropagation(),e.preventDefault(),s(e);e.key===r.a.ENTER?(e.stopPropagation(),e.preventDefault()):null==p||p(e)}),g.ref=h,g.className=l()("mx_AccessibleButton",u,{mx_AccessibleButton_hasKind:a,["mx_AccessibleButton_kind_"+a]:a,mx_AccessibleButton_disabled:c}),o.a.createElement(t,g,n)}h.defaultProps={element:"div",role:"button",tabIndex:0},h.displayName="AccessibleButton"},function(e,t,s){"use strict";s.d(t,"a",(function(){return D})),s.d(t,"b",(function(){return M}));var n=s(83),i=s.n(n),a=s(248),o=s(86),r=s(100),c=s(133),l=s(266);class d extends a.a{constructor(e,t){super(),this.featureNames=e,this.watchers=t}getValue(e,t){if(this.featureNames.includes(e))return this.readFeature(e);if("notificationsEnabled"===e){const e=localStorage.getItem("notifications_enabled");return"string"==typeof e?"true"===e:null}if("notificationBodyEnabled"===e){const e=localStorage.getItem("notifications_body_enabled");return"string"==typeof e?"true"===e:null}if("audioNotificationsEnabled"===e){const e=localStorage.getItem("audio_notifications_enabled");return"string"==typeof e?"true"===e:null}if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e)){return JSON.parse(localStorage.getItem("mx_"+e)||"{}").value}if("layout"===e){const t=this.getSettings()||{};let s=!1;return t.useIRCLayout&&(t.layout=c.a.IRC,delete t.useIRCLayout,s=!0),"useBubbleLayout"in t&&(!1===t.useBubbleLayout&&(t.layout=c.a.Group),delete t.useBubbleLayout,s=!0),s&&localStorage.setItem("mx_local_settings",JSON.stringify(t)),t[e]}if("theme_in_use"===e){const t=this.getSettings()||{};return t.use_system_theme?l.a.System:t[e]}if("light_theme"===e||"dark_theme"===e){const t=this.getSettings()||{},s=t.theme;return s&&!t.use_system_theme?s:t[e]}return(this.getSettings()||{})[e]}setValue(e,t,s){if(this.featureNames.includes(e))return this.writeFeature(e,s),Promise.resolve();if("notificationsEnabled"===e)return localStorage.setItem("notifications_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("notificationBodyEnabled"===e)return localStorage.setItem("notifications_body_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("audioNotificationsEnabled"===e)return localStorage.setItem("audio_notifications_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e))return localStorage.setItem("mx_"+e,JSON.stringify({value:s})),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("layout"===e){const t=this.getSettings()||{};return delete t.useBubbleLayout,delete t.useIRCLayout,t.layout=s,localStorage.setItem("mx_local_settings",JSON.stringify(t)),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve()}if("theme_in_use"===e){const e=this.getSettings()||{};return e.theme&&!e.use_system_theme&&(e.dark_theme=e.theme,e.light_theme=e.theme),delete e.use_system_theme,delete e.theme,e.theme_in_use=s,localStorage.setItem("mx_local_settings",JSON.stringify(e)),this.watchers.notifyUpdate("theme_in_use",null,r.a.DEVICE,e.theme_in_use),this.watchers.notifyUpdate("light_theme",null,r.a.DEVICE,e.light_theme),this.watchers.notifyUpdate("dark_theme",null,r.a.DEVICE,e.dark_theme),Promise.resolve()}if("light_theme"===e||"dark_theme"===e){const t=this.getSettings()||{};return t.theme&&!t.use_system_theme&&("light_theme"===e&&(t.dark_theme=t.theme),"dark_theme"===e&&(t.light_theme=t.theme)),delete t.use_system_theme,delete t.theme,t[e]=s,localStorage.setItem("mx_local_settings",JSON.stringify(t)),this.watchers.notifyUpdate("theme_in_use",null,r.a.DEVICE,t.theme_in_use),this.watchers.notifyUpdate("light_theme",null,r.a.DEVICE,t.light_theme),this.watchers.notifyUpdate("dark_theme",null,r.a.DEVICE,t.dark_theme),Promise.resolve()}const n=this.getSettings()||{};return n[e]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}watchSetting(e,t,s){this.watchers.watchSetting(e,t,s)}unwatchSetting(e){this.watchers.unwatchSetting(e)}getSettings(){const e=localStorage.getItem("mx_local_settings");return e?JSON.parse(e):null}readFeature(e){if(o.a.get()&&o.a.get().isGuest())return!1;const t=localStorage.getItem("mx_labs_feature_"+e);return"true"===t||"false"!==t&&null}writeFeature(e,t){localStorage.setItem("mx_labs_feature_"+e,""+t),this.watchers.notifyUpdate(e,null,r.a.DEVICE,t)}}class h extends a.a{constructor(e){super(),this.watchers=e}getValue(e,t){if("blacklistUnverifiedDevices"===e){const e=this.read("mx_local_settings");if(e&&e.blacklistUnverifiedDevicesPerRoom)return e.blacklistUnverifiedDevicesPerRoom[t]}const s=this.read(this.getKey(e,t));return s?s.value:null}setValue(e,t,s){if("blacklistUnverifiedDevices"===e){let n=this.read("mx_local_settings");return n||(n={}),n.blacklistUnverifiedDevicesPerRoom||(n.blacklistUnverifiedDevicesPerRoom={}),n.blacklistUnverifiedDevicesPerRoom[t]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,t,r.a.ROOM_DEVICE,s),Promise.resolve()}return null===s?localStorage.removeItem(this.getKey(e,t)):(s=JSON.stringify({value:s}),localStorage.setItem(this.getKey(e,t),s)),this.watchers.notifyUpdate(e,t,r.a.ROOM_DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}read(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}getKey(e,t){return"mx_setting_"+e+"_"+t}}class u extends a.a{constructor(e,t){super(),this.defaults=e,this.invertedDefaults=t}getValue(e,t){let s=this.defaults[e];return void 0===s&&(s=this.invertedDefaults[e]),s}async setValue(e,t,s){throw new Error("Cannot set values on the default level handler")}canSetValue(e,t){return!1}isSupported(){return!0}}var m=s(408),p=s(144);class g extends m.a{constructor(e){super(),this.watchers=e,i()(this,"onAccountData",(e,t,s)=>{const n=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,r.a.ROOM_ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},i=Object(p.e)(t,e.getContent());for(const t of i){const s=e.getContent()[t];this.watchers.notifyUpdate(t,n,r.a.ROOM_ACCOUNT,s)}}else"im.vector.setting.allowed_widgets"===e.getType()&&this.watchers.notifyUpdate("allowedWidgets",n,r.a.ROOM_ACCOUNT,e.getContent())})}initMatrixClient(e,t){e&&e.removeListener("Room.accountData",this.onAccountData),t.on("Room.accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("allowedWidgets"===e)return this.getSettings(t,"im.vector.setting.allowed_widgets");return(this.getSettings(t)||{})[e]}async setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,void await o.a.get().setRoomAccountData(t,"org.matrix.room.preview_urls",e)}if("allowedWidgets"===e)return void await o.a.get().setRoomAccountData(t,"im.vector.setting.allowed_widgets",s);const n=this.getSettings(t)||{};n[e]=s,await o.a.get().setRoomAccountData(t,"im.vector.web.settings",n)}canSetValue(e,t){const s=o.a.get().getRoom(t);return null!=s}isSupported(){const e=o.a.get();return null!=e&&!e.isGuest()}getSettings(e,t="im.vector.web.settings"){const s=o.a.get().getRoom(e);if(!s)return null;const n=s.getAccountData(t);return n&&n.getContent()?Object(p.a)(n.getContent()):null}}const v=["im.vector.riot.breadcrumb_rooms","im.vector.setting.breadcrumbs"];class f extends m.a{constructor(e){super(),this.watchers=e,i()(this,"onAccountData",(e,t)=>{if("org.matrix.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",null,r.a.ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){const s=t?t.getContent():{},n=Object(p.e)(s,e.getContent());for(const t of n){const s=e.getContent()[t];this.watchers.notifyUpdate(t,null,r.a.ACCOUNT,s)}}else if(v.includes(e.getType()))this.notifyBreadcrumbsUpdate(e);else if("im.vector.setting.integration_provisioning"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("integrationProvisioning",null,r.a.ACCOUNT,t)}else if("io.element.recent_emoji"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("recent_emoji",null,r.a.ACCOUNT,t)}})}initMatrixClient(e,t){e&&e.removeListener("accountData",this.onAccountData),t.on("accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms"),e&&(e.recent_rooms=e.rooms)),e&&e.recent_rooms?e.recent_rooms:[]}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji");return e?e.recent_emoji:null}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning");return e?e.enabled:null}if(["autoplayGifs","autoplayVideo"].includes(e)){const s=this.getSettings()||{},n=s[e];if(null==n){const e=s.autoplayGifsAndVideos;return null!=e&&(this.setValue("autoplayGifs",t,e),this.setValue("autoplayVideo",t,e)),e}return n}const s=this.getSettings()||{};let n=s[e];return null==n&&("hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(n=s.hideAvatarDisplaynameChanges)),n}async setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return e.disable=!s,void await o.a.get().setAccountData("org.matrix.preview_urls",e)}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms")),e||(e={}),e.recent_rooms=s,void await o.a.get().setAccountData("im.vector.setting.breadcrumbs",e)}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji")||{};return e.recent_emoji=s,void await o.a.get().setAccountData("io.element.recent_emoji",e)}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning")||{};return e.enabled=s,void await o.a.get().setAccountData("im.vector.setting.integration_provisioning",e)}const n=this.getSettings()||{};n[e]=s,await o.a.get().setAccountData("im.vector.web.settings",n)}canSetValue(e,t){return!0}isSupported(){const e=o.a.get();return null!=e&&!e.isGuest()}getSettings(e="im.vector.web.settings"){const t=o.a.get();if(!t)return null;const s=t.getAccountData(e);return s&&s.getContent()?Object(p.a)(s.getContent()):null}notifyBreadcrumbsUpdate(e){let t=[];if("im.vector.riot.breadcrumb_rooms"===e.getType()){const s=this.getSettings("im.vector.setting.breadcrumbs");t=s?s.recent_rooms:e.getContent().rooms}else{if("im.vector.setting.breadcrumbs"!==e.getType())return;t=e.getContent().recent_rooms}this.watchers.notifyUpdate("breadcrumb_rooms",null,r.a.ACCOUNT,t||[])}}class b extends m.a{constructor(e){super(),this.watchers=e,i()(this,"onEvent",(e,t,s)=>{const n=e.getRoomId(),i=this.client.getRoom(n);if(i&&(!i||t===i.currentState))if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,r.a.ROOM,t)}else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},i=Object(p.e)(t,e.getContent());for(const t of i)this.watchers.notifyUpdate(t,n,r.a.ROOM,e.getContent()[t])}})}initMatrixClient(e,t){e&&e.removeListener("RoomState.events",this.onEvent),t.on("RoomState.events",this.onEvent)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}return(this.getSettings(t)||{})[e]}async setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,void await o.a.get().sendStateEvent(t,"org.matrix.room.preview_urls",e)}const n=this.getSettings(t)||{};n[e]=s,await o.a.get().sendStateEvent(t,"im.vector.web.settings",n,"")}canSetValue(e,t){const s=o.a.get(),n=s.getRoom(t);let i="im.vector.web.settings";return"urlPreviewsEnabled"===e&&(i="org.matrix.room.preview_urls"),!!n&&n.currentState.maySendStateEvent(i,s.getUserId())}isSupported(){const e=o.a.get();return null!=e}getSettings(e,t="im.vector.web.settings"){const s=o.a.get().getRoom(e);if(!s)return null;const n=s.currentState.getStateEvents(t,"");return n&&n.getContent()?Object(p.a)(n.getContent()):null}}var y=s(93),E=s(4);class S extends a.a{constructor(e){super(),this.featureNames=e}getValue(e,t){const s=y.a.get()||{};if(this.featureNames.includes(e)){const t=(s.features||{})[e];return Object(E.v)(t)?null:!0===t||!1===t?t:"enable"===t||"disable"!==t&&null}if("theme_in_use"===e&&s.default_theme){if("light"===s.default_theme)return l.a.Light;if("dark"===s.default_theme)return l.a.Dark;"system"===s.default_theme&&l.a.System}const n=s.settingDefaults;return!n||Object(E.v)(n[e])?null:n[e]}async setValue(e,t,s){throw new Error("Cannot change settings at the config level")}canSetValue(e,t){return!1}isSupported(){return!0}}var _=s(84),w=s(87),C=s(593);class O extends a.a{constructor(e){super(),this.handler=e,i()(this,"cache",{})}getValue(e,t){const s=t||"UNDEFINED",n=this.cache[e];return n&&n.hasOwnProperty(s)?n[s]:this.handler.getValue(e,t)}setValue(e,t,s){this.cache[e]||(this.cache[e]={});const n=this.cache[e],i=t||"UNDEFINED";n[i]=s;const a=this.handler.setValue(e,t,s);return Promise.resolve(a).finally(()=>{delete n[i]})}canSetValue(e,t){return this.handler.canSetValue(e,t)}isSupported(){return this.handler.isSupported()}}const k=Symbol("irrelevant-room");var R=s(92),I=s(1);const x=new class{constructor(){i()(this,"watchers",new Map)}watchSetting(e,t,s){this.watchers.has(e)||this.watchers.set(e,new Map),this.watchers.get(e).has(t)||this.watchers.get(e).set(t,[]),this.watchers.get(e).get(t).push(s)}unwatchSetting(e){this.watchers.forEach(t=>{t.forEach(t=>{let s;for(;-1!==(s=t.indexOf(e));)t.splice(s,1)})})}notifyUpdate(e,t,s,n){if(!this.watchers.has(e))return;const i=this.watchers.get(e),a=[];null!==t&&i.has(t)&&a.push(...i.get(t)),t?i.has(k)&&a.push(...i.get(k)):a.push(...Array.from(i.values()).flat(1));for(const e of a)e(t,s,n)}},T={},j={},N=[];for(const e of Object.keys(C.b))T[e]=C.b[e].default,C.b[e].isFeature&&N.push(e),C.b[e].invertedSettingName&&(j[C.b[e].invertedSettingName]=!C.b[e].default);const P={[r.a.DEVICE]:new d(N,x),[r.a.ROOM_DEVICE]:new h(x),[r.a.ROOM_ACCOUNT]:new g(x),[r.a.ACCOUNT]:new f(x),[r.a.ROOM]:new b(x),[r.a.CONFIG]:new S(N),[r.a.DEFAULT]:new u(T,j)};for(const e of Object.keys(P))P[e]=new O(P[e]);const D=[r.a.DEVICE,r.a.ROOM_DEVICE,r.a.ROOM_ACCOUNT,r.a.ACCOUNT,r.a.ROOM,r.a.CONFIG,r.a.DEFAULT];class M{static getFeatureSettingNames(){return Object.keys(C.b).filter(e=>M.isFeature(e))}static watchSetting(e,t,s){const n=C.b[e],i=e;if(!n)throw new Error(e+" is not a setting");n.invertedSettingName&&(e=n.invertedSettingName);const a=`${(new Date).getTime()}_${M.watcherCount++}_${e}_${t}`,o=(e,t,n)=>{var a;const o=M.getValue(i),r=null!==(a=M.getValueAt(t,i))&&void 0!==a?a:n;s(i,e,t,r,o)};return M.watchers.set(a,o),x.watchSetting(e,t,o),a}static unwatchSetting(e){M.watchers.has(e)?(x.unwatchSetting(M.watchers.get(e)),M.watchers.delete(e)):I.a.warn("Ending non-existent watcher ID "+e)}static monitorSetting(e,t){t=t||null,this.monitors.has(e)||this.monitors.set(e,new Map);const s=()=>{this.monitors.get(e).set(t,M.watchSetting(e,t,(e,t,s,n,i)=>{w.a.dispatch({action:R.a.SettingUpdated,settingName:e,roomId:t,level:s,newValueAtLevel:n,newValue:i})}))},n=Array.from(this.monitors.get(e).keys());n.find(e=>e===t||null===e)?null===t&&(n.forEach(t=>{M.unwatchSetting(this.monitors.get(e).get(t))}),this.monitors.get(e).clear(),s()):s()}static getDisplayName(e,t=r.a.DEFAULT){if(!C.b[e]||!C.b[e].displayName)return null;let s=C.b[e].displayName;return s instanceof Object&&(s=s[t]?s[t]:s.default),Object(_.a)(s)}static getDescription(e){var t;return null!==(t=C.b[e])&&void 0!==t&&t.description?Object(_.a)(C.b[e].description):null}static isFeature(e){return!!C.b[e]&&C.b[e].isFeature}static getBetaInfo(e){var t;if(M.isFeature(e)&&!1!==M.getValueAt(r.a.CONFIG,e,null,!0,!0))return null===(t=C.b[e])||void 0===t?void 0:t.betaInfo}static getLabGroup(e){if(M.isFeature(e))return C.b[e].labsGroup}static isEnabled(e){return!!C.b[e]&&(!C.b[e].controller||!C.b[e].controller.settingDisabled)}static getValue(e,t=null,s=!1){if(!C.b[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");const n=C.b[e],i=n.supportedLevelsAreOrdered?n.supportedLevels:D;return M.getValueAt(i[0],e,t,!1,s)}static getValueAt(e,t,s=null,n=!1,i=!1){const a=C.b[t];if(!a)throw new Error("Setting '"+t+"' does not appear to be a setting.");const o=a.supportedLevelsAreOrdered?a.supportedLevels:D;o.includes(r.a.DEFAULT)||o.push(r.a.DEFAULT);const c=o.indexOf(e);if(-1===c)throw new Error("Level "+e+" is not prioritized");const l=M.getHandlers(t);if(a.invertedSettingName&&(t=a.invertedSettingName),n){const n=l[e];if(!n)return M.getFinalValue(a,e,s,null,null);const i=n.getValue(t,s);return M.getFinalValue(a,e,s,i,e)}for(let n=c;n<o.length;n++){const r=l[o[n]];if(!r)continue;if(i&&"default"===o[n])continue;const c=r.getValue(t,s);if(null!=c)return M.getFinalValue(a,e,s,c,o[n])}return M.getFinalValue(a,e,s,null,null)}static getDefaultValue(e){if(!C.b[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");return C.b[e].default}static getFinalValue(e,t,s,n,i){let a=n;if(e.controller){const o=e.controller.getValueOverride(t,s,n,i);null!=o&&(a=o)}return e.invertedSettingName&&(a=!a),a}static async setValue(e,t,s,n){const i=C.b[e];if(!i)throw new Error("Setting '"+e+"' does not appear to be a setting.");const a=M.getHandler(e,s);if(!a)throw new Error("Setting "+e+" does not have a handler for "+s);if(i.invertedSettingName&&(e=i.invertedSettingName,n=!n),!a.canSetValue(e,t))throw new Error("User cannot set "+e+" at "+s+" in "+t);await a.setValue(e,t,n);const o=i.controller;o&&o.onChange(s,t,n)}static canSetValue(e,t,s){var n;if(!C.b[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");if(!M.isEnabled(e))return!1;if(M.isFeature(e)&&(null===(n=C.b[e])||void 0===n||!n.betaInfo)){const s=M.getValueAt(r.a.CONFIG,e,t,!0,!0);if(!0===s||!1===s)return!1}const i=M.getHandler(e,s);return!!i&&i.canSetValue(e,t)}static isLevelSupported(e){return!!P[e]&&P[e].isSupported()}static firstSupportedLevel(e){const t=C.b[e];if(!t)throw new Error("Setting '"+e+"' does not appear to be a setting.");const s=t.supportedLevelsAreOrdered?t.supportedLevels:D;s.includes(r.a.DEFAULT)||s.push(r.a.DEFAULT);const n=M.getHandlers(e);for(const e of s){if(n[e])return e}return null}static debugSetting(e,t){I.a.log("--- DEBUG "+e);const s=C.b[e];I.a.log("--- definition: "+(s?JSON.stringify(s):"<NOT_FOUND>")),I.a.log("--- default level order: "+JSON.stringify(D)),I.a.log("--- registered handlers: "+JSON.stringify(Object.keys(P)));const n=e=>{for(const s of Object.keys(P)){const n=P[s];try{const i=n.getValue(e,t);I.a.log(`---     ${s}@${t||"<no_room>"} = ${JSON.stringify(i)}`)}catch(e){I.a.log(`---     ${n}@${t||"<no_room>"} THREW ERROR: ${e.message}`),I.a.error(e)}if(t)try{const t=n.getValue(e,null);I.a.log(`---     ${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){I.a.log(`---     ${n}@<no_room> THREW ERROR: ${e.message}`),I.a.error(e)}}I.a.log("--- calculating as returned by SettingsStore"),I.a.log("--- these might not match if the setting uses a controller - be warned!");try{const s=M.getValue(e,t);I.a.log(`---     SettingsStore#generic@${t||"<no_room>"}  = ${JSON.stringify(s)}`)}catch(e){I.a.log(`---     SettingsStore#generic@${t||"<no_room>"} THREW ERROR: ${e.message}`),I.a.error(e)}if(t)try{const t=M.getValue(e,null);I.a.log("---     SettingsStore#generic@<no_room>  = "+JSON.stringify(t))}catch(e){I.a.log("---     SettingsStore#generic@$<no_room> THREW ERROR: "+e.message),I.a.error(e)}for(const s of D){try{const n=M.getValueAt(s,e,t);I.a.log(`---     SettingsStore#${s}@${t||"<no_room>"} = ${JSON.stringify(n)}`)}catch(e){I.a.log(`---     SettingsStore#${s}@${t||"<no_room>"} THREW ERROR: ${e.message}`),I.a.error(e)}if(t)try{const t=M.getValueAt(s,e,null);I.a.log(`---     SettingsStore#${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){I.a.log(`---     SettingsStore#${s}@$<no_room> THREW ERROR: ${e.message}`),I.a.error(e)}}};n(e),s.invertedSettingName&&(I.a.log("--- TESTING INVERTED SETTING NAME"),I.a.log("--- inverted: "+s.invertedSettingName),n(s.invertedSettingName)),I.a.log("--- END DEBUG")}static getHandler(e,t){const s=M.getHandlers(e);return s[t]?s[t]:null}static getHandlers(e){if(!C.b[e])return{};const t={};for(const s of C.b[e].supportedLevels){if(!P[s])throw new Error("Unexpected level "+s);M.isLevelSupported(s)&&(t[s]=P[s])}return t.default||(t.default=P.default),t}}i()(M,"watchers",new Map),i()(M,"monitors",new Map),i()(M,"watcherCount",1),window.mxSettingsStore=M},function(e,t,s){"use strict";(function(e){var n=s(95),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(148),d=s.n(l),h=s(91),u=s.n(h),m=s(4),p=s(140),g=s(87),v=s(1165);class f{constructor(){o()(this,"counter",0),o()(this,"priorityModal",null),o()(this,"staticModal",null),o()(this,"modals",[]),o()(this,"onBackgroundClick",()=>{const e=this.getCurrentModal();e&&(e.closeReason="backgroundClick",e.close(),e.closeReason=null)})}static getOrCreateContainer(){let e=document.getElementById("mx_Dialog_Container");return e||(e=document.createElement("div"),e.id="mx_Dialog_Container",document.body.appendChild(e)),e}static getOrCreateStaticContainer(){let e=document.getElementById("mx_Dialog_StaticContainer");return e||(e=document.createElement("div"),e.id="mx_Dialog_StaticContainer",document.body.appendChild(e)),e}toggleCurrentDialogVisibility(){const e=this.getCurrentModal();e&&(e.hidden=!e.hidden)}hasDialogs(){return this.priorityModal||this.staticModal||this.modals.length>0}createTrackedDialog(e,t,...s){return p.a.trackEvent("Modal",e,t),this.createDialog(...s)}appendTrackedDialog(e,t,...s){return p.a.trackEvent("Modal",e,t),this.appendDialog(...s)}createDialog(e,...t){return this.createDialogAsync(Promise.resolve(e),...t)}appendDialog(e,...t){return this.appendDialogAsync(Promise.resolve(e),...t)}createTrackedDialogAsync(e,t,...s){return p.a.trackEvent("Modal",e,t),this.createDialogAsync(...s)}appendTrackedDialogAsync(e,t,...s){return p.a.trackEvent("Modal",e,t),this.appendDialogAsync(...s)}closeCurrentModal(e){const t=this.getCurrentModal();t&&(t.closeReason=e,t.close())}buildModal(e,t,s,n){const a={onFinished:t?t.onFinished:null,onBeforeClose:n.onBeforeClose,beforeClosePromise:null,closeReason:null,className:s,elem:null,close:null},[o,r]=this.getCloseFn(a,t),l=this.counter++;return a.elem=c.a.createElement(v.a,i()({key:l,prom:e},t,{onFinished:o})),a.close=o,{modal:a,closeDialog:o,onFinishedProm:r}}getCloseFn(e,t){const s=Object(m.l)();return[async(...n)=>{if(e.beforeClosePromise)await e.beforeClosePromise;else if(e.onBeforeClose){e.beforeClosePromise=e.onBeforeClose(e.closeReason);const t=await e.beforeClosePromise;if(e.beforeClosePromise=null,!t)return}s.resolve(n),t&&t.onFinished&&t.onFinished.apply(null,n);const i=this.modals.indexOf(e);i>=0&&this.modals.splice(i,1),this.priorityModal===e&&(this.priorityModal=null,this.modals=[]),this.staticModal===e&&(this.staticModal=null,this.modals=[]),this.reRender()},s.promise]}createDialogAsync(e,t,s,n=!1,i=!1,a={}){const{modal:o,closeDialog:r,onFinishedProm:c}=this.buildModal(e,t,s,a);return n?this.priorityModal=o:i?this.staticModal=o:this.modals.unshift(o),this.reRender(),{close:r,finished:c}}appendDialogAsync(e,t,s){const{modal:n,closeDialog:i,onFinishedProm:a}=this.buildModal(e,t,s,{});return this.modals.push(n),this.reRender(),{close:i,finished:a}}getCurrentModal(){return this.priorityModal?this.priorityModal:this.modals[0]||this.staticModal}async reRender(){if(await Object(m.I)(0),0===this.modals.length&&!this.priorityModal&&!this.staticModal)return g.a.dispatch({action:"aria_unhide_main_app"}),d.a.unmountComponentAtNode(f.getOrCreateContainer()),void d.a.unmountComponentAtNode(f.getOrCreateStaticContainer());if(g.a.dispatch({action:"aria_hide_main_app"}),this.staticModal){const e=u()("mx_Dialog_wrapper mx_Dialog_staticWrapper",this.staticModal.className),t=c.a.createElement("div",{className:e},c.a.createElement("div",{className:"mx_Dialog"},this.staticModal.elem),c.a.createElement("div",{className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.onBackgroundClick}));d.a.render(t,f.getOrCreateStaticContainer())}else d.a.unmountComponentAtNode(f.getOrCreateStaticContainer());const t=this.getCurrentModal();if(t===this.staticModal||t.hidden)d.a.unmountComponentAtNode(f.getOrCreateContainer());else{const s=u()("mx_Dialog_wrapper",t.className,{mx_Dialog_wrapperWithStaticUnder:this.staticModal}),n=c.a.createElement("div",{className:s},c.a.createElement("div",{className:"mx_Dialog"},t.elem),c.a.createElement("div",{className:"mx_Dialog_background",onClick:this.onBackgroundClick}));e(()=>d.a.render(n,f.getOrCreateContainer()))}}}window.singletonModalManager||(window.singletonModalManager=new f),t.a=window.singletonModalManager}).call(this,s(175).setImmediate)},,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ViewUser="view_user",e.ViewUserSettings="view_user_settings",e.ViewRoomDirectory="view_room_directory",e.RecheckTheme="recheck_theme",e.CheckUpdates="check_updates",e.FocusSendMessageComposer="focus_send_message_composer",e.FocusEditMessageComposer="focus_edit_message_composer",e.FocusAComposer="focus_a_composer",e.ToggleUserMenu="toggle_user_menu",e.UpdateFontSize="update_font_size",e.UpdateSystemFont="update_system_font",e.ViewRoom="view_room",e.ViewRoomDelta="view_room_delta",e.SetRightPanelPhase="set_right_panel_phase",e.ToggleRightPanel="toggle_right_panel",e.AfterRightPanelPhaseChange="after_right_panel_phase_change",e.OpenDialPad="open_dial_pad",e.DialNumber="dial_number",e.TransferCallToMatrixID="transfer_call_to_matrix_id",e.TransferCallToPhoneNumber="transfer_call_to_phone_number",e.PstnSupportUpdated="pstn_support_updated",e.VirtualRoomSupportUpdated="virtual_room_support_updated",e.UploadStarted="upload_started",e.UploadProgress="upload_progress",e.UploadFinished="upload_finished",e.UploadFailed="upload_failed",e.UploadCanceled="upload_canceled",e.JoinRoom="join_room",e.JoinRoomReady="join_room_ready",e.JoinRoomError="join_room_error",e.ComposerInsert="composer_insert",e.SwitchSpace="switch_space",e.UpdateSpaceHierarchy="update_space_hierarchy",e.SettingUpdated="setting_updated",e.EditEvent="edit_event"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r}));var n=s(83),i=s.n(n);const a={brand:"SchildiChat",integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",bug_report_endpoint_url:null,jitsi:{preferredDomain:"meet.jit.si"},desktopBuilds:{available:!0,logo:s(1163),url:"https://schildi.chat/desktop"}};class o{static setInstance(e){o.instance=e,window.mxReactSdkConfig=e}static get(){return o.instance||{}}static put(e){const t=Object.keys(a);for(let s=0;s<t.length;++s)void 0===e[t[s]]&&(e[t[s]]=a[t[s]]);o.setInstance(e)}static unset(){o.setInstance({})}static add(e){const t=o.get(),s=Object.assign({},t,e);o.put(s)}}function r(e){return e.sso_redirect_options?e.sso_redirect_options:e.sso_immediate_redirect?{immediate:!0}:{}}i()(o,"instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return a})),s.d(t,"b",(function(){return o})),s.d(t,"d",(function(){return r})),s.d(t,"e",(function(){return c})),s.d(t,"h",(function(){return l})),s.d(t,"g",(function(){return d})),s.d(t,"k",(function(){return h})),s.d(t,"j",(function(){return u})),s.d(t,"i",(function(){return m})),s.d(t,"f",(function(){return p}));var n=s(342);let i,a,o;!function(e){e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomAliases="m.room.aliases",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy"}(i||(i={})),function(e){e.Annotation="m.annotation",e.Replace="m.replace",e.Thread="io.element.thread"}(a||(a={})),function(e){e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request"}(o||(o={}));const r="type";let c;!function(e){e.Space="m.space"}(c||(c={}));const l=new n.a("m.room.purpose","org.matrix.msc3088.purpose"),d=new n.a("m.enabled","org.matrix.msc3088.enabled"),h=new n.a("m.data_tree","org.matrix.msc3089.data_tree"),u=new n.a("m.leaf","org.matrix.msc3089.leaf"),m=new n.a("m.branch","org.matrix.msc3089.branch"),p=new n.a("io.element.functional_members","io.element.functional_members")},,function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(447);class c extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_Spinner"},this.props.message&&o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_Spinner_Msg"},this.props.message)," "),o.a.createElement(r.a,{w:this.props.w,h:this.props.h,className:"mx_Spinner_icon"}))}}i()(c,"defaultProps",{w:32,h:32})},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(357),h=s.n(d),u=s(91),m=s.n(u),p=s(108),g=s(88),v=s(86),f=s(84),b=s(98),y=s(85);let E=Object(y.a)("views.dialogs.BaseDialog")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"matrixClient",void 0),r()(this,"onKeyDown",e=>{this.props.onKeyDown&&this.props.onKeyDown(e),this.props.hasCancel&&e.key===p.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1))}),r()(this,"onCancelClick",e=>{this.props.onFinished(!1)}),this.matrixClient=v.a.get()}render(){let e,t;return this.props.hasCancel&&(e=l.a.createElement(g.a,{onClick:this.onCancelClick,className:"mx_Dialog_cancelButton","aria-label":Object(f.a)("Close dialog")})),this.props.headerImage&&(t=l.a.createElement("img",{className:"mx_Dialog_titleImage",src:this.props.headerImage,alt:""})),l.a.createElement(b.a.Provider,{value:this.matrixClient},l.a.createElement(h.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog","aria-labelledby":"mx_BaseDialog_title","aria-describedby":this.props.contentId},className:m()({[this.props.className]:!0,mx_Dialog_fixedWidth:this.props.fixedWidth})},l.a.createElement("div",{className:m()("mx_Dialog_header",{mx_Dialog_headerWithButton:!!this.props.headerButton,mx_Dialog_headerWithCancel:!!e})},l.a.createElement("div",{className:m()("mx_Dialog_title",this.props.titleClass),id:"mx_BaseDialog_title"},t,this.props.title),this.props.headerButton,e),this.props.children))}},r()(i,"defaultProps",{hasCancel:!0,fixedWidth:!0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return c}));var n=s(95),i=s.n(n),a=s(82),o=s.n(a);const r=Object(a.createContext)(void 0);r.displayName="MatrixClientContext",t.a=r;const c=e=>{const t=e;return Object(a.forwardRef)((e,s)=>{const n=Object(a.useContext)(r);return o.a.createElement(t,i()({ref:s},e,{mxClient:n}))})}},,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.DEVICE="device",e.ROOM_DEVICE="room-device",e.ROOM_ACCOUNT="room-account",e.ACCOUNT="account",e.ROOM="room",e.CONFIG="config",e.DEFAULT="default"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(102),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(107),u=s(112);const m=["element","prefixComponent","postfixComponent","className","onValidate","children","tooltipContent","forceValidity","tooltipClassName","list","validateOnBlur","validateOnChange","validateOnFocus","usePlaceholderAsHint"];function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let v=1;class f extends c.a.PureComponent{constructor(e){super(e),o()(this,"id",void 0),o()(this,"input",void 0),o()(this,"validateOnChange",Object(u.debounce)(()=>{this.validate({focused:!0})},200)),o()(this,"onFocus",e=>{this.setState({focused:!0}),this.props.validateOnFocus&&this.validate({focused:!0}),this.props.onFocus&&this.props.onFocus(e)}),o()(this,"onChange",e=>{this.props.validateOnChange&&this.validateOnChange(),this.props.onChange&&this.props.onChange(e)}),o()(this,"onBlur",e=>{this.setState({focused:!1}),this.props.validateOnBlur&&this.validate({focused:!1}),this.props.onBlur&&this.props.onBlur(e)}),this.state={valid:void 0,feedback:void 0,feedbackVisible:!1,focused:!1},this.id=this.props.id||"mx_Field_"+v++}focus(){this.input.focus(),this.setState({focused:!0})}async validate({focused:e,allowEmpty:t=!0}){if(!this.props.onValidate)return;const s=this.input?this.input.value:null,{valid:n,feedback:i}=await this.props.onValidate({value:s,focused:e,allowEmpty:t});return this.state.focused&&i?this.setState({valid:n,feedback:i,feedbackVisible:!0}):this.setState({valid:n,feedbackVisible:!1}),n}render(){const e=this.props,{element:t,prefixComponent:s,postfixComponent:n,className:a,onValidate:o,children:r,tooltipContent:l,forceValidity:u,tooltipClassName:p,list:v,validateOnBlur:f,validateOnChange:b,validateOnFocus:y,usePlaceholderAsHint:E}=e,S=i()(e,m);S.placeholder=S.placeholder||S.label,S.id=this.id,S.onFocus=this.onFocus,S.onChange=this.onChange,S.onBlur=this.onBlur;const _=g(g({},S),{},{ref:e=>this.input=e,list:v}),w=c.a.createElement(this.props.element,_,r);let C=null;s&&(C=c.a.createElement("span",{className:"mx_Field_prefix"},s));let O=null;n&&(O=c.a.createElement("span",{className:"mx_Field_postfix"},n));const k=null!=u,R=d()("mx_Field","mx_Field_"+this.props.element,a,{mx_Field_labelAlwaysTopLeft:s||E,mx_Field_placeholderIsHint:E,mx_Field_valid:k?u:o&&!0===this.state.valid,mx_Field_invalid:k?!u:o&&!1===this.state.valid}),I=h.getComponent("elements.Tooltip");let x;return(l||this.state.feedback)&&(x=c.a.createElement(I,{tooltipClassName:d()("mx_Field_tooltip",p),visible:this.state.focused&&this.props.forceTooltipVisible||this.state.feedbackVisible,label:l||this.state.feedback,alignment:I.Alignment.Right})),c.a.createElement("div",{className:R},C,w,c.a.createElement("label",{htmlFor:this.id},this.props.label),O,x)}}o()(f,"defaultProps",{element:"input",type:"text",validateOnFocus:!0,validateOnBlur:!0,validateOnChange:!0})},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(83),i=s.n(n),a=s(86);class o{constructor(e,t){if(this.prepared=e,i()(this,"client",void 0),this.client=null!=t?t:a.a.get(),!this.client)throw new Error("No possible MatrixClient for media resolution. Please provide one or log in.")}get isEncrypted(){return!!this.prepared.file}get srcMxc(){return this.prepared.mxc}get thumbnailMxc(){var e;return null===(e=this.prepared.thumbnail)||void 0===e?void 0:e.mxc}get hasThumbnail(){return!!this.thumbnailMxc}get srcHttp(){return this.client.mxcUrlToHttp(this.srcMxc)}get thumbnailHttp(){return this.hasThumbnail?this.client.mxcUrlToHttp(this.thumbnailMxc):null}getThumbnailHttp(e,t,s="scale"){return this.hasThumbnail?(e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.thumbnailMxc,e,t,s)):null}getThumbnailOfSourceHttp(e,t,s="scale"){return e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.srcMxc,e,t,s)}getSquareThumbnailHttp(e){return e=Math.floor(e*window.devicePixelRatio),this.hasThumbnail?this.getThumbnailHttp(e,e,"crop"):this.getThumbnailOfSourceHttp(e,e,"crop")}downloadSource(){return fetch(this.srcHttp)}}function r(e,t){return new o(function(e){var t,s,n,i;let a=null;if(null!=e&&null!==(t=e.info)&&void 0!==t&&t.thumbnail_url?a={mxc:e.info.thumbnail_url,file:e.info.thumbnail_file}:null!=e&&null!==(s=e.info)&&void 0!==s&&null!==(n=s.thumbnail_file)&&void 0!==n&&n.url&&(a={mxc:e.info.thumbnail_file.url,file:e.info.thumbnail_file}),null!=e&&e.url)return{thumbnail:a,mxc:e.url,file:e.file};if(null!=e&&null!==(i=e.file)&&void 0!==i&&i.url)return{thumbnail:a,mxc:e.file.url,file:e.file};throw new Error("Invalid file provided: cannot determine MXC URI. Has it been redacted?")}(e),t)}function c(e,t){return r({url:e},t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(85),u=s(97);let m=Object(h.a)("views.dialogs.ErrorDialog")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"onClick",()=>{this.props.onFinished(!0)})}render(){return l.a.createElement(u.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:this.props.title||Object(d.a)("Error"),headerImage:this.props.headerImage,contentId:"mx_Dialog_content"},l.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description||Object(d.a)("An error has occurred.")),l.a.createElement("div",{className:"mx_Dialog_buttons"},l.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onClick,autoFocus:this.props.focus},this.props.button||Object(d.a)("OK"))))}},r()(i,"defaultProps",{focus:!0,title:null,description:null,button:null}),n=a))||n},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return N})),s.d(t,"n",(function(){return P})),s.d(t,"o",(function(){return D})),s.d(t,"j",(function(){return M})),s.d(t,"k",(function(){return A})),s.d(t,"l",(function(){return U})),s.d(t,"p",(function(){return L})),s.d(t,"m",(function(){return F}));var n=s(83),i=s.n(n),a=s(95),o=s.n(a),r=s(82),c=s.n(r),l=s(148),d=s.n(l),h=s(91),u=s.n(h),m=s(357),p=s.n(m),g=s(108),v=s(85),f=s(139),b=s(431);s.d(t,"b",(function(){return b.a}));var y=s(291);s.d(t,"c",(function(){return y.a}));var E=s(622);s.d(t,"d",(function(){return E.a}));var S=s(623);s.d(t,"e",(function(){return S.a}));var _=s(624);s.d(t,"f",(function(){return _.a}));var w=s(625);s.d(t,"g",(function(){return w.a}));var C=s(626);s.d(t,"h",(function(){return C.a}));var O,k,R,I=s(627);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function T(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}s.d(t,"i",(function(){return I.a}));function j(){let e=document.getElementById("mx_ContextualMenu_Container");return e||(e=document.createElement("div"),e.id="mx_ContextualMenu_Container",document.body.appendChild(e)),e}let N;!function(e){e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.None="none"}(N||(N={}));let P=Object(v.a)("structures.ContextMenu")((R=k=class extends c.a.PureComponent{constructor(t,s){super(t,s),i()(this,"initialFocus",void 0),i()(this,"collectContextMenuRect",e=>{if(!e)return;const t=e.querySelector('[role^="menuitem"]')||e.querySelector("[tab-index]");t&&t.focus(),this.setState({contextMenuElem:e})}),i()(this,"onContextMenu",t=>{if(this.props.onFinished){this.props.onFinished(),t.preventDefault(),t.stopPropagation();const s=t.clientX,n=t.clientY;e(()=>{const e=document.createEvent("MouseEvents");e.initMouseEvent("contextmenu",!0,!0,window,0,0,0,s,n,!1,!1,!1,!1,0,null),document.elementFromPoint(s,n).dispatchEvent(e)})}}),i()(this,"onContextMenuPreventBubbling",e=>{e.stopPropagation()}),i()(this,"onFinished",e=>{e.stopPropagation(),e.preventDefault(),this.props.onFinished&&this.props.onFinished()}),i()(this,"onMoveFocus",(e,t)=>{let s=!1;do{var n;const i=t?e.lastElementChild:e.firstElementChild,a=t?e.previousElementSibling:e.nextElementSibling;s?i?e=i:a?e=a:(s=!1,e=e.parentElement):a?(e=a,s=!0):e=e.parentElement,e&&e.classList.contains("mx_ContextualMenu")&&(e=t?e.lastElementChild:e.firstElementChild,s=!0)}while(e&&(null===(n=e.getAttribute("role"))||void 0===n||!n.startsWith("menuitem")));e&&e.focus()}),i()(this,"onMoveFocusHomeEnd",(e,t)=>{let s=e.querySelectorAll('[role^="menuitem"]');s||(s=e.querySelectorAll("[tab-index]")),s&&s.length&&(t?s[0].focus():s[s.length-1].focus())}),i()(this,"onClick",e=>{e.stopPropagation()}),i()(this,"onKeyDown",e=>{if(e.stopPropagation(),!this.props.managed)return void(e.key===g.a.ESCAPE&&(this.props.onFinished(),e.preventDefault()));let t=!0;switch(e.key){case g.a.TAB:case g.a.ESCAPE:case g.a.ARROW_LEFT:case g.a.ARROW_RIGHT:this.props.onFinished();break;case g.a.ARROW_UP:this.onMoveFocus(e.target,!0);break;case g.a.ARROW_DOWN:this.onMoveFocus(e.target,!1);break;case g.a.HOME:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!0);break;case g.a.END:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!1);break;default:t=!1}t&&e.preventDefault()}),this.state={contextMenuElem:null},this.initialFocus=document.activeElement}componentWillUnmount(){this.initialFocus.focus()}renderMenu(e=this.props.hasBackground){const t={},s=this.props;let n;s.top?t.top=s.top:t.bottom=s.bottom,s.left?(t.left=s.left,n=N.Left):(t.right=s.right,n=N.Right);const i=this.state.contextMenuElem?this.state.contextMenuElem.getBoundingClientRect():null,a={};s.chevronFace&&(n=s.chevronFace);const o=n&&n!==N.None;if(n===N.Top||n===N.Bottom)a.left=s.chevronOffset;else if(void 0!==t.top){const e=t.top;let n=e;if(i){const e=10;n=Math.min(t.top,document.body.clientHeight-i.height-e)}t.top=n,a.top=Math.max(s.chevronOffset,s.chevronOffset+e-n)}let r;o&&(r=c.a.createElement("div",{style:a,className:"mx_ContextualMenu_chevron_"+n}));const l=u()({mx_ContextualMenu:!0,mx_ContextualMenu_left:!o&&void 0!==t.left&&!t.right,mx_ContextualMenu_right:!o&&void 0!==t.right&&!t.left,mx_ContextualMenu_top:!o&&void 0!==t.top&&!t.bottom,mx_ContextualMenu_bottom:!o&&void 0!==t.bottom&&!t.top,mx_ContextualMenu_withChevron_left:n===N.Left,mx_ContextualMenu_withChevron_right:n===N.Right,mx_ContextualMenu_withChevron_top:n===N.Top,mx_ContextualMenu_withChevron_bottom:n===N.Bottom,mx_ContextualMenu_rightAligned:!0===this.props.rightAligned,mx_ContextualMenu_bottomAligned:!0===this.props.bottomAligned}),d={};s.menuWidth&&(d.width=s.menuWidth),s.menuHeight&&(d.height=s.menuHeight),isNaN(Number(s.menuPaddingTop))||(d.paddingTop=s.menuPaddingTop),isNaN(Number(s.menuPaddingLeft))||(d.paddingLeft=s.menuPaddingLeft),isNaN(Number(s.menuPaddingBottom))||(d.paddingBottom=s.menuPaddingBottom),isNaN(Number(s.menuPaddingRight))||(d.paddingRight=s.menuPaddingRight);const h={};let m;isNaN(Number(s.zIndex))||(d.zIndex=s.zIndex+1,h.zIndex=s.zIndex),e&&(m=c.a.createElement("div",{className:"mx_ContextualMenu_background",style:h,onClick:this.onFinished,onContextMenu:this.onContextMenu}));let g=c.a.createElement(c.a.Fragment,null,r,s.children);return s.focusLock&&(g=c.a.createElement(p.a,null,g)),c.a.createElement("div",{className:u()("mx_ContextualMenu_wrapper",this.props.wrapperClassName),style:T(T({},t),h),onKeyDown:this.onKeyDown,onClick:this.onClick,onContextMenu:this.onContextMenuPreventBubbling},m,c.a.createElement("div",{className:l,style:d,ref:this.collectContextMenuRect,role:this.props.managed?"menu":void 0},g))}render(){return this.props.mountAsChild?this.renderMenu():d.a.createPortal(this.renderMenu(),j())}},i()(k,"defaultProps",{hasBackground:!0,managed:!0}),O=R))||O;const D=(e,t=12)=>{const s=e.right+window.pageXOffset+3;let n=e.top+e.height/2+window.pageYOffset;return n-=t+8,{left:s,top:n,chevronOffset:t}},M=(e,t=N.None,s=0)=>{const n={chevronFace:t},i=e.right+window.pageXOffset,a=e.bottom+window.pageYOffset,o=e.top+window.pageYOffset;return n.right=f.b.instance.windowWidth-i,a<f.b.instance.windowHeight/2?n.top=a+s:n.bottom=f.b.instance.windowHeight-o+s,n},A=(e,t=N.None,s=0)=>{const n={chevronFace:t},i=e.right+window.pageXOffset,a=e.bottom+window.pageYOffset,o=e.top+window.pageYOffset;return n.right=f.b.instance.windowWidth-i,a<f.b.instance.windowHeight/2?n.top=a+s:n.bottom=f.b.instance.windowHeight-o+s,n},U=(e,t=N.None,s=0)=>{const n={chevronFace:t},i=e.left+window.pageXOffset,a=e.top+window.pageYOffset;return n.left=i,n.bottom=f.b.instance.windowHeight-a+s,n},L=()=>{const e=Object(r.useRef)(null),[t,s]=Object(r.useState)(!1);return[t,e,e=>{null==e||e.preventDefault(),null==e||e.stopPropagation(),s(!0)},e=>{null==e||e.preventDefault(),null==e||e.stopPropagation(),s(!1)},s]};function F(e,t){const s=function(...e){var s;d.a.unmountComponentAtNode(j()),null==t||null===(s=t.onFinished)||void 0===s||s.apply(null,e)},n=c.a.createElement(P,o()({},t,{mountAsChild:!0,hasBackground:!1,onFinished:s,windowResize:s}),c.a.createElement(e,o()({},t,{onFinished:s})));return d.a.render(n,j()),{close:s}}}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"b",(function(){return M})),s.d(t,"a",(function(){return L}));var n=s(83),i=s.n(n),a=s(112),o=s(94),r=s(1),c=s(164),l=s(87),d=s(165),h=s(89),u=s(130),m=s(184),p=s(116),g=s(213);class v extends g.b{constructor(e,t){super(),this.spaceId=e,this.getRoomFn=t,i()(this,"rooms",[]),i()(this,"states",{}),i()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return this._color===m.a.Unsent?"!":null}setRooms(e){const t=this.rooms,s=Object(p.a)(t,e);this.rooms=e;for(const e of s.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(g.a,this.onRoomNotificationStateUpdate))}for(const e of s.added){const t=this.getRoomFn(e);t.on(g.a,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getFirstRoomWithNotifications(){var e;return null===(e=Object.values(this.states).find(e=>e.color>=this.color))||void 0===e?void 0:e.room.roomId}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(g.a,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();this._count=0,this._color=m.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color);this.emitIfUpdated(e)}}var f=s(173),b=s(147),y=s(378),E=s(459),S=s(132),_=s(92),w=s(144),C=s(4);const O=(e,t,s,n=50)=>{var i,a,o,r,c,l;if(t<0||s<0||t>e.length||s>e.length||t===s)return[];const d=e.map((e,t)=>({index:t,order:e})),h=Object(p.l)(d,t,s),u=void 0===(null===(i=h[s-1])||void 0===i?void 0:i.order);let m=s,g=s,v=!0;const f=void 0!==(null===(a=h[s+1])||void 0===a?void 0:a.order)?Object(C.J)(h[s+1].order):BigInt(Number.MAX_VALUE);for(let e=s-1,t=1;e>=0;e--,t++){var b;if(void 0!==(null===(b=h[e])||void 0===b?void 0:b.order)&&f-Object(C.J)(h[e].order)>t)break;m=e}const y=void 0===h[0].order?void 0:Object(C.J)(h[0].order),E=BigInt(s);0===m&&void 0!==y&&f-y<=E&&y<=E&&(v=!1);const S=!u;let _=S;if(S){var w,O;const e=void 0!==(null===(w=h[s-1])||void 0===w?void 0:w.order)?Object(C.J)(null===(O=h[s-1])||void 0===O?void 0:O.order):BigInt(Number.MIN_VALUE);for(let t=s+1,n=1;t<h.length;t++,n++){var k;if(void 0===(null===(k=h[t])||void 0===k?void 0:k.order)||Object(C.J)(h[t].order)-e>n)break;g=t}g===h.length-1&&(h[g]?Object(C.J)(h[g].order):BigInt(Number.MAX_VALUE))-e<=g-s&&(_=!1)}const R=v?s-m:Number.MAX_SAFE_INTEGER,I=_?g-s:Number.MAX_SAFE_INTEGER;u||R<I?g=s:m=s;const x=null!==(o=null===(r=h[m-1])||void 0===r?void 0:r.order)&&void 0!==o?o:"";return function e(t,s,n,i,a=C.a){const o=Math.min(Math.max(t.length,s.length),i),r=Object(C.b)(t,o,a),c=Object(C.b)(s,o,a),l=Object(C.J)(r,a),d=Object(C.J)(c,a);if(d-l-BigInt(1)<n)return o<i?e(Object(C.b)(r,o+1,a),Object(C.b)(c,o+1,a),n,o+1,a):[];const h=(d-l)/BigInt(n+1),u=BigInt(l+h);return Array(n).fill(void 0).map((e,t)=>Object(C.d)(u+BigInt(t)*h,a))}(x,null!==(c=null===(l=h[g+1])||void 0===l?void 0:l.order)&&void 0!==c?c:C.a.charAt(C.a.length-1).repeat(x.length||1),1+g-m,n).map((e,t)=>({index:h[m+t].index,order:e}))};var k=s(517),R=s(185);function I(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function x(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?I(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):I(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const T=[R.a.Home,R.a.Favourites,R.a.People,R.a.Orphans],j=!h.b.getValue("showCommunitiesInsteadOfSpaces"),N=e=>"mx_space_context_"+e,P=e=>e.reduce((e,t)=>(e[t.isSpaceRoom()?0:1].push(t),e),[[],[]]),D=e=>{if("string"==typeof e&&e.length<=50&&Array.from(e).every(e=>{const t=e.charCodeAt(0);return t>=32&&t<=126}))return e},M=(e,t,s)=>{var n;return[null!==(n=D(e))&&void 0!==n?n:NaN,t,s]},A=e=>f.a.instance.getRoomState(e);class U extends c.a{constructor(){super(l.a,{}),i()(this,"rootSpaces",[]),i()(this,"orphanedRooms",new Set),i()(this,"parentMap",new y.a),i()(this,"notificationStateMap",new Map),i()(this,"spaceFilteredRooms",new Map),i()(this,"_activeSpace",R.a.Home),i()(this,"_suggestedRooms",[]),i()(this,"_invitedSpaces",new Set),i()(this,"spaceOrderLocalEchoMap",new Map),i()(this,"_restrictedJoinRuleSupport",void 0),i()(this,"_allRoomsInHome",h.b.getValue("Spaces.allRoomsInHome")),i()(this,"_showSpaceMemberDMs",h.b.getValue("Spaces.showSpaceMemberDMs")),i()(this,"_showSpaceDMBadges",h.b.getValue("Spaces.showSpaceDMBadges")),i()(this,"_enabledMetaSpaces",[]),i()(this,"fetchSuggestedRooms",async(e,t=20)=>{try{const{rooms:s}=await this.matrixClient.getRoomHierarchy(e.roomId,t,1,!0),n=new y.a;return s.forEach(e=>{e.children_state.forEach(e=>{var t;e.type===o.a.SpaceChild&&null!==(t=e.content.via)&&void 0!==t&&t.length&&e.content.via.forEach(t=>{n.getOrCreate(e.state_key,new Set).add(t)})})}),s.filter(e=>{var t;return e.room_type!==o.e.Space&&"join"!==(null===(t=this.matrixClient.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())}).map(e=>x(x({},e),{},{viaServers:Array.from(n.get(e.room_id)||[])}))}catch(e){r.a.error(e)}return[]}),i()(this,"getSpaceFilteredRoomIds",e=>e===R.a.Home&&this.allRoomsInHome?new Set(this.matrixClient.getVisibleRooms().map(e=>e.roomId)):this.spaceFilteredRooms.get(e)||new Set),i()(this,"rebuild",Object(a.throttle)(()=>{if(!this.matrixClient)return;const[e,t]=P(this.matrixClient.getVisibleRooms()),[s,n]=e.reduce((e,t)=>("join"===t.getMyMembership()?e[0].push(t):"invite"===t.getMyMembership()&&e[1].push(t),e),[[],[]]),i=new Set([...t,...s]),o=new y.a,r=Object(a.sortBy)(s,e=>e.roomId);r.forEach(e=>{this.getChildren(e.roomId).forEach(t=>{i.delete(t),o.getOrCreate(t.roomId,new Set).add(e.roomId)})});const[c,l]=P(Array.from(i)),d=new Set(r),h=(e,t)=>{const s=[e];for(;s.length;){const e=s.pop();t.delete(e),this.getChildSpaces(e.roomId).forEach(e=>{t.has(e)&&s.push(e)})}};c.forEach(e=>{h(e,d)}),Array.from(d).forEach(e=>{d.has(e)&&(d.delete(e),c.push(e),h(e,d))}),this.orphanedRooms=new Set(l.map(e=>e.roomId)),this.rootSpaces=this.sortRootSpaces(c),this.parentMap=o,"!"===this._activeSpace[0]&&d.has(this.matrixClient.getRoom(this._activeSpace))&&this.goToFirstSpace(),this.onRoomsUpdate(),this.emit(R.f,this.spacePanelSpaces,this.enabledMetaSpaces),this._invitedSpaces=new Set(this.sortRootSpaces(n)),this.emit(R.c,this.invitedSpaces)},100,{trailing:!0,leading:!0})),i()(this,"onSpaceUpdate",()=>{this.rebuild()}),i()(this,"showInHomeSpace",e=>{var t;return!!this.allRoomsInHome||!e.isSpaceRoom()&&(!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size)||u.a.shared().getUserIdForRoomId(e.roomId))}),i()(this,"onRoomUpdate",e=>{var t;if(new Set(this.enabledMetaSpaces).has(R.a.Home))if(this.showInHomeSpace(e))null===(t=this.spaceFilteredRooms.get(R.a.Home))||void 0===t||t.add(e.roomId),this.emit(R.a.Home);else if(!this.orphanedRooms.has(e.roomId)){var s;null===(s=this.spaceFilteredRooms.get(R.a.Home))||void 0===s||s.delete(e.roomId),this.emit(R.a.Home)}}),i()(this,"onSpaceMembersChange",e=>{u.a.shared().getDMRoomsForUserId(e.getStateKey()).length<1||this.onRoomsUpdate()}),i()(this,"onRoomsUpdate",Object(a.throttle)(()=>{const e=this.matrixClient.getVisibleRooms(),t=this.spaceFilteredRooms;this.spaceFilteredRooms=new Map;const s=new Set(this.enabledMetaSpaces);if(s.has(R.a.Home)&&!this.allRoomsInHome){const t=e.filter(e=>!e.isSpaceRoom()&&"invite"===e.getMyMembership());this.spaceFilteredRooms.set(R.a.Home,new Set(t.map(e=>e.roomId))),e.forEach(e=>{this.showInHomeSpace(e)&&this.spaceFilteredRooms.get(R.a.Home).add(e.roomId)})}if(s.has(R.a.Favourites)){const t=e.filter(e=>e.tags[b.a.Favourite]);this.spaceFilteredRooms.set(R.a.Favourites,new Set(t.map(e=>e.roomId)))}if(s.has(R.a.People)){const t=e.filter(e=>u.a.shared().getUserIdForRoomId(e.roomId));this.spaceFilteredRooms.set(R.a.People,new Set(t.map(e=>e.roomId)))}if(s.has(R.a.Orphans)){const t=e.filter(e=>{var t;return!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size||u.a.shared().getUserIdForRoomId(e.roomId))});this.spaceFilteredRooms.set(R.a.Orphans,new Set(t.map(e=>e.roomId)))}const n=new y.a;e.forEach(e=>{"join"===e.getMyMembership()&&this.getParents(e.roomId).forEach(t=>{n.getOrCreate(t.roomId,new Set).add(e.roomId)})}),this.rootSpaces.forEach(e=>{const t=(e,s)=>{var i,a;if(s.has(e))return;if(this.spaceFilteredRooms.has(e))return this.spaceFilteredRooms.get(e);const[o,r]=P(this.getChildren(e)),c=new Set(r.map(e=>e.roomId)),l=null===(i=this.matrixClient)||void 0===i?void 0:i.getRoom(e);this.showSpaceMemberDMs&&(null==l||l.getMembers().forEach(e=>{"join"!==e.membership&&"invite"!==e.membership||u.a.shared().getDMRoomsForUserId(e.userId).forEach(e=>{c.add(e)})}));const d=new Set(s).add(e);o.forEach(e=>{var s;null===(s=t(e.roomId,d))||void 0===s||s.forEach(e=>{c.add(e)})}),null===(a=n.get(e))||void 0===a||a.forEach(e=>{c.add(e)});const h=new Set(Array.from(c).flatMap(e=>this.matrixClient.getRoomUpgradeHistory(e,!0).map(e=>e.roomId)));return this.spaceFilteredRooms.set(e,h),h};t(e.roomId,new Set)});const i=Object(y.b)(t,this.spaceFilteredRooms),a=i.changed.filter(e=>Object(E.a)(t.get(e),this.spaceFilteredRooms.get(e)));let o;[...i.added,...i.removed,...a].forEach(e=>{this.emit(e)}),s.has(R.a.People)?o=R.a.People:s.has(R.a.Home)&&(o=R.a.Home),this.spaceFilteredRooms.forEach((t,s)=>{this.allRoomsInHome&&s===R.a.Home||this.getNotificationState(s).setRooms(e.filter(e=>!(!t.has(e.roomId)||e.isSpaceRoom())&&(!u.a.shared().getUserIdForRoomId(e.roomId)||(o&&s===o||this.showSpaceDMBadges))))})},100,{trailing:!0,leading:!0})),i()(this,"switchToRelatedSpace",e=>{var t,s;if(this.suggestedRooms.find(t=>t.room_id===e))return;let n=this.getCanonicalParent(e);if(n||(n=this.rootSpaces.find(t=>{var s;return null===(s=this.spaceFilteredRooms.get(t.roomId))||void 0===s?void 0:s.has(e)})),!n){const t=Array.from(this.parentMap.get(e)||[]);for(const e of t){const t=this.matrixClient.getRoom(e);if(t){n=t;break}}}this.setActiveSpace(null!==(t=null===(s=n)||void 0===s?void 0:s.roomId)&&void 0!==t?t:R.a.Home,!1)}),i()(this,"onRoom",(e,t,s)=>{const n=e.getMyMembership();if(!n)return;const i=t||n;if(e.isSpaceRoom())"invite"===i?(this._invitedSpaces.add(e),this.emit(R.c,this.invitedSpaces)):"invite"===s&&"join"!==i?(this._invitedSpaces.delete(e),this.emit(R.c,this.invitedSpaces)):(this.onSpaceUpdate(),this.emit(e.roomId)),"join"===i&&e.roomId===S.a.getRoomId()?this.setActiveSpace(e.roomId,!1):"leave"===i&&e.roomId===this.activeSpace&&this.goToFirstSpace(!0);else if(this.rebuild(),"join"===i){const s=this._suggestedRooms.length;this._suggestedRooms=this._suggestedRooms.filter(t=>t.room_id!==e.roomId),s!==this._suggestedRooms.length&&this.emit(R.e,this._suggestedRooms),"join"===t&&e.roomId===S.a.getRoomId()&&this.switchToRelatedSpace(e.roomId)}}),i()(this,"onRoomState",e=>{var t;const s=this.matrixClient.getRoom(e.getRoomId());if(s)switch(e.getType()){case o.a.SpaceChild:s.isSpaceRoom()&&(this.onSpaceUpdate(),this.emit(s.roomId)),s.roomId===this.activeSpace&&"join"!==(null===(t=this.matrixClient.getRoom(e.getStateKey()))||void 0===t?void 0:t.getMyMembership())&&e.getPrevContent().suggested!==e.getContent().suggested&&this.loadSuggestedRooms(s);break;case o.a.SpaceParent:s.isSpaceRoom()?this.onSpaceUpdate():this.allRoomsInHome||this.onRoomUpdate(s),this.emit(s.roomId);break;case o.a.RoomPowerLevels:s.isSpaceRoom()&&this.onRoomsUpdate()}}),i()(this,"onRoomStateMembers",e=>{const t=this.matrixClient.getRoom(e.getRoomId());null!=t&&t.isSpaceRoom()&&this.onSpaceMembersChange(e)}),i()(this,"onRoomAccountData",(e,t,s)=>{if(t.isSpaceRoom())if(e.getType()===o.a.SpaceOrder){var n,i;this.spaceOrderLocalEchoMap.delete(t.roomId);(null===(n=e.getContent())||void 0===n?void 0:n.order)!==(null==s||null===(i=s.getContent())||void 0===i?void 0:i.order)&&this.notifyIfOrderChanged()}else if(e.getType()===o.a.Tag){var a,r;const n=(null==s||null===(a=s.getContent())||void 0===a?void 0:a.tags)||{},i=(null===(r=e.getContent())||void 0===r?void 0:r.tags)||{};!!n[b.a.Favourite]!=!!i[b.a.Favourite]&&this.onRoomUpdate(t)}}),i()(this,"onAccountData",(e,t)=>{if(!this.allRoomsInHome&&e.getType()===o.a.Direct){var s;const n=null!==(s=null==t?void 0:t.getContent())&&void 0!==s?s:{},i=e.getContent(),a=Object(w.b)(n,i),o=a.changed.filter(e=>Object(p.d)(n[e],i[e]));new Set([...a.added,...a.removed,...o]).forEach(e=>{var t;const s=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e);s&&this.onRoomUpdate(s)})}}),i()(this,"getSpaceTagOrdering",e=>{var t,s;return this.spaceOrderLocalEchoMap.has(e.roomId)?this.spaceOrderLocalEchoMap.get(e.roomId):D(null===(t=e.getAccountData(o.a.SpaceOrder))||void 0===t||null===(s=t.getContent())||void 0===s?void 0:s.order)}),h.b.monitorSetting("Spaces.allRoomsInHome",null),h.b.monitorSetting("Spaces.showSpaceMemberDMs",null),h.b.monitorSetting("Spaces.showSpaceDMBadges",null),h.b.monitorSetting("Spaces.enabledMetaSpaces",null)}get invitedSpaces(){return Array.from(this._invitedSpaces)}get enabledMetaSpaces(){return this._enabledMetaSpaces}get spacePanelSpaces(){return this.rootSpaces}get activeSpace(){return this._activeSpace}get activeSpaceRoom(){var e;return"!"!==this._activeSpace[0]?null:null===(e=this.matrixClient)||void 0===e?void 0:e.getRoom(this._activeSpace)}get suggestedRooms(){return this._suggestedRooms}get allRoomsInHome(){return this._allRoomsInHome}get showSpaceMemberDMs(){return this._showSpaceMemberDMs}get showSpaceDMBadges(){return this._showSpaceDMBadges}setActiveRoomInSpace(e){var t,s;if("!"!==e[0]||null!==(t=this.matrixClient)&&void 0!==t&&null!==(s=t.getRoom(e))&&void 0!==s&&s.isSpaceRoom())if(e!==this.activeSpace&&this.setActiveSpace(e),e){const t=this.getNotificationState(e).getFirstRoomWithNotifications();l.a.dispatch({action:"view_room",room_id:t,context_switch:!0})}else{const e=d.b.instance.unfilteredLists;for(let t=0;t<k.a.length;t++){const s=e[k.a[t]].find(e=>{if(this.showInHomeSpace(e)){return f.a.instance.getRoomState(e).isUnread}});if(s){l.a.dispatch({action:"view_room",room_id:s.roomId,context_switch:!0});break}}}}get restrictedJoinRuleSupport(){return this._restrictedJoinRuleSupport}setActiveSpace(e,t=!0){if(!e||!this.matrixClient||e===this.activeSpace)return;let s;var n;if("!"===e[0]){if(s=this.matrixClient.getRoom(e),null===(n=s)||void 0===n||!n.isSpaceRoom())return}else if(!this.enabledMetaSpaces.includes(e))return;if(this._activeSpace=e,this.emit(R.d,this.activeSpace),this.emit(R.e,this._suggestedRooms=[]),t){var i,a;const t=window.localStorage.getItem(N(this.activeSpace));h.b.getValue("Spaces.returnToPreviouslyOpenedRoom")&&"invite"!==(null===(i=s)||void 0===i?void 0:i.getMyMembership())&&"join"===(null===(a=this.matrixClient.getRoom(t))||void 0===a?void 0:a.getMyMembership())&&this.getSpaceFilteredRoomIds(e).has(t)?l.a.dispatch({action:"view_room",room_id:t,context_switch:!0}):s?l.a.dispatch({action:"view_room",room_id:e,context_switch:!0}):l.a.dispatch({action:"view_home_page",context_switch:!0})}window.localStorage.setItem("mx_active_space",e),s&&this.loadSuggestedRooms(s)}async loadSuggestedRooms(e){const t=await this.fetchSuggestedRooms(e);this._activeSpace===e.roomId&&(this._suggestedRooms=t,this.emit(R.e,this._suggestedRooms))}addRoomToSpace(e,t,s,n=!1,i=!1){return this.matrixClient.sendStateEvent(e.roomId,o.a.SpaceChild,{via:s,suggested:n,auto_join:i},t)}getChildren(e){var t;const s=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e),n=null==s?void 0:s.currentState.getStateEvents(o.a.SpaceChild).filter(e=>{var t;return null===(t=e.getContent())||void 0===t?void 0:t.via});return Object(a.sortBy)(n,e=>{var t,s;const n=e.getStateKey(),i=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(n),a=null==i||null===(s=i.currentState.getStateEvents(o.a.RoomCreate,""))||void 0===s?void 0:s.getTs();return M(e.getContent().order,a,n)}).map(e=>{const t=this.matrixClient.getRoomUpgradeHistory(e.getStateKey(),!0);return t[t.length-1]}).filter(e=>"join"===(null==e?void 0:e.getMyMembership())||"invite"===(null==e?void 0:e.getMyMembership()))||[]}getChildRooms(e){return this.getChildren(e).filter(e=>!e.isSpaceRoom())}getChildSpaces(e){return this.getChildren(e).filter(e=>e.isSpaceRoom()&&"join"===e.getMyMembership())}getParents(e,t=!1){var s,n;const i=null===(s=this.matrixClient)||void 0===s?void 0:s.getUserId(),a=null===(n=this.matrixClient)||void 0===n?void 0:n.getRoom(e);return(null==a?void 0:a.currentState.getStateEvents(o.a.SpaceParent).map(s=>{const n=s.getContent();if(!Array.isArray(n.via)||t&&!n.canonical)return;const a=this.matrixClient.getRoom(s.getStateKey()),r=null==a?void 0:a.currentState.getStateEvents(o.a.SpaceChild,e);return null==a||!a.currentState.maySendStateEvent(o.a.SpaceChild,i)||r&&!Array.isArray(r.getContent().via)?void 0:a}).filter(Boolean))||[]}getCanonicalParent(e){var t;const s=this.getParents(e,!0);return(null===(t=Object(a.sortBy)(s,e=>e.roomId))||void 0===t?void 0:t[0])||null}getKnownParents(e){return this.parentMap.get(e)||new Set}notifyIfOrderChanged(){const e=this.sortRootSpaces(this.rootSpaces);Object(p.e)(this.rootSpaces,e)&&(this.rootSpaces=e,this.emit(R.f,this.spacePanelSpaces,this.enabledMetaSpaces))}async reset(){this.rootSpaces=[],this.orphanedRooms=new Set,this.parentMap=new y.a,this.notificationStateMap=new Map,this.spaceFilteredRooms=new Map,this._activeSpace=R.a.Home,this._suggestedRooms=[],this._invitedSpaces=new Set,this._enabledMetaSpaces=[]}async onNotReady(){L.spacesEnabled&&(this.matrixClient&&(this.matrixClient.removeListener("Room",this.onRoom),this.matrixClient.removeListener("Room.myMembership",this.onRoom),this.matrixClient.removeListener("Room.accountData",this.onRoomAccountData),this.matrixClient.removeListener("RoomState.events",this.onRoomState),this.matrixClient.removeListener("RoomState.members",this.onRoomStateMembers),this.matrixClient.removeListener("accountData",this.onAccountData)),await this.reset())}async onReady(){if(!j)return;this.matrixClient.on("Room",this.onRoom),this.matrixClient.on("Room.myMembership",this.onRoom),this.matrixClient.on("Room.accountData",this.onRoomAccountData),this.matrixClient.on("RoomState.events",this.onRoomState),this.matrixClient.on("RoomState.members",this.onRoomStateMembers),this.matrixClient.on("accountData",this.onAccountData),this.matrixClient.getCapabilities().then(e=>{var t,s;this._restrictedJoinRuleSupport=null==e||null===(t=e["m.room_versions"])||void 0===t||null===(s=t["org.matrix.msc3244.room_capabilities"])||void 0===s?void 0:s.restricted});const e=h.b.getValue("Spaces.enabledMetaSpaces");this._enabledMetaSpaces=T.filter(t=>e[t]),await this.onSpaceUpdate();const t=window.localStorage.getItem("mx_active_space");t&&("!"===t[0]?this.matrixClient.getRoom(t):e[t])?this.setActiveSpace(t,!1):this.goToFirstSpace()}goToFirstSpace(e=!1){var t,s;this.setActiveSpace(null!==(t=this.enabledMetaSpaces[0])&&void 0!==t?t:null===(s=this.spacePanelSpaces[0])||void 0===s?void 0:s.roomId,e)}async onAction(e){if(j)switch(e.action){case"view_room":{var t;if(e.context_switch)break;const s=e.room_id,n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(s);null!=n&&n.isSpaceRoom()?this.setActiveSpace(n.roomId,!1):this.allRoomsInHome&&"!"!==this.activeSpace[0]||this.getSpaceFilteredRoomIds(this.activeSpace).has(s)||this.switchToRelatedSpace(s),window.localStorage.setItem(N(this.activeSpace),e.room_id);break}case"view_home_page":!e.context_switch&&this.enabledMetaSpaces.includes(R.a.Home)&&(this.setActiveSpace(R.a.Home,!1),window.localStorage.setItem(N(this.activeSpace),""));break;case"after_leave_room":"!"===this._activeSpace[0]&&e.room_id===this._activeSpace&&this.goToFirstSpace();break;case _.a.SwitchSpace:{if(e.num<1||e.num>9)break;const t=this.enabledMetaSpaces.length;e.num<=t?this.setActiveSpace(this.enabledMetaSpaces[e.num-1]):this.spacePanelSpaces.length>e.num-t-1&&this.setActiveSpace(this.spacePanelSpaces[e.num-t-1].roomId);break}case _.a.SettingUpdated:switch(e.settingName){case"Spaces.allRoomsInHome":{const e=h.b.getValue("Spaces.allRoomsInHome");this.allRoomsInHome!==e&&(this._allRoomsInHome=e,this.emit(R.b,this.allRoomsInHome),this.rebuild());break}case"Spaces.showSpaceMemberDMs":{const e=h.b.getValue("Spaces.showSpaceMemberDMs");this.showSpaceMemberDMs!==e&&(this._showSpaceMemberDMs=e,this.rebuild());break}case"Spaces.showSpaceDMBadges":{const e=h.b.getValue("Spaces.showSpaceDMBadges");this.showSpaceDMBadges!==e&&(this._showSpaceDMBadges=e,this.rebuild());break}case"Spaces.enabledMetaSpaces":{const e=h.b.getValue("Spaces.enabledMetaSpaces"),t=T.filter(t=>e[t]);Object(p.d)(this._enabledMetaSpaces,t)&&(this._enabledMetaSpaces=t,"!"===this.activeSpace[0]||t.includes(this.activeSpace)||this.goToFirstSpace(),this.emit(R.f,this.spacePanelSpaces,this.enabledMetaSpaces),this.rebuild());break}}}}getNotificationState(e){if(this.notificationStateMap.has(e))return this.notificationStateMap.get(e);const t=new v(e,A);return this.notificationStateMap.set(e,t),t}traverseSpace(e,t,s=!1,n){if(n&&n.has(e))return;t(e);const i=new Set(n).add(e),[a,o]=P(this.getChildren(e));s&&o.forEach(e=>t(e.roomId)),a.forEach(e=>this.traverseSpace(e.roomId,t,s,i))}sortRootSpaces(e){return Object(a.sortBy)(e,[this.getSpaceTagOrdering,"roomId"])}async setRootSpaceOrder(e,t){this.spaceOrderLocalEchoMap.set(e.roomId,t);try{await this.matrixClient.setRoomAccountData(e.roomId,o.a.SpaceOrder,{order:t})}catch(s){r.a.warn("Failed to set root space order",s),this.spaceOrderLocalEchoMap.get(e.roomId)===t&&this.spaceOrderLocalEchoMap.delete(e.roomId)}}moveRootSpace(e,t){const s=this.rootSpaces.map(this.getSpaceTagOrdering);O(s,e,t).forEach(({index:e,order:t})=>{this.setRootSpaceOrder(this.rootSpaces[e],t)}),this.notifyIfOrderChanged()}}class L{static get instance(){return L.internalInstance}}i()(L,"spacesEnabled",j),i()(L,"internalInstance",new U),window.mxSpaceStore=L.instance},function(e,t,s){"use strict";s.r(t),s.d(t,"loadSkin",(function(){return r})),s.d(t,"resetSkin",(function(){return c})),s.d(t,"getComponent",(function(){return l}));var n=s(83),i=s.n(n);class a{constructor(){i()(this,"components",null)}getComponent(e){if(!e)throw new Error("Invalid component name: "+e);if(null===this.components)throw new Error(`Attempted to get a component (${e}) before a skin has been loaded. This is probably because either: a) Your app has not called sdk.loadSkin(), or b) A component has called getComponent at the root level`);const t=(t=>{if(!t)return null;let s=t[e];return s||(s=t["views."+e]),s})(this.components);if(!t)return null;if(!("function"==typeof t||t.render))throw new Error(`Not a valid component: ${e} (type = ${typeof t}).`);return t}load(e){if(null!==this.components)throw new Error("Attempted to load a skin while a skin is already loadedIf you want to change the active skin, call resetSkin first");this.components={};const t=Object.keys(e.components);for(let s=0;s<t.length;++s){const n=e.components[t[s]];this.addComponent(t[s],n)}const n=s(1656);if(!n||!n.components)throw new Error("Invalid react-sdk component index");for(const e in n.components)this.components[e]||(this.components[e]=n.components[e])}addComponent(e,t){let s=e;void 0!==t.replaces&&(s=t.replaces.indexOf(".")>-1?t.replaces:e.substr(0,e.lastIndexOf(".")+1)+t.replaces.split(".").pop()),this.components[s]=t}reset(){this.components=null}}void 0===window.mxSkinner&&(window.mxSkinner=new a);var o=window.mxSkinner;s(1629);function r(e){o.load(e)}function c(){o.reset()}function l(e){return o.getComponent(e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i})),s.d(t,"d",(function(){return a})),s.d(t,"c",(function(){return o}));const n={HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",BACKSPACE:"Backspace",DELETE:"Delete",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",TAB:"Tab",ESCAPE:"Escape",ENTER:"Enter",ALT:"Alt",CONTROL:"Control",META:"Meta",SHIFT:"Shift",CONTEXT_MENU:"ContextMenu",COMMA:",",PERIOD:".",LESS_THAN:"<",GREATER_THAN:">",BACKTICK:"`",SPACE:" ",SLASH:"/",SQUARE_BRACKET_LEFT:"[",SQUARE_BRACKET_RIGHT:"]",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z"},i=navigator.platform.toUpperCase().indexOf("MAC")>=0;function a(e){return i?e.metaKey&&!e.altKey&&!e.ctrlKey&&!e.shiftKey:e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey}function o(e){return i?e.metaKey&&!e.altKey&&!e.ctrlKey:e.ctrlKey&&!e.altKey&&!e.metaKey}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(85);let u=Object(h.a)("views.elements.DialogButtons")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"onCancelClick",e=>{this.props.onCancel(e)})}render(){let e,t="mx_Dialog_primary";this.props.primaryButtonClass&&(t+=" "+this.props.primaryButtonClass),(this.props.cancelButton||this.props.hasCancel)&&(e=l.a.createElement("button",{type:"button",onClick:this.onCancelClick,className:this.props.cancelButtonClass,disabled:this.props.disabled},this.props.cancelButton||Object(d.a)("Cancel")));let s=null;return this.props.additive&&(s=l.a.createElement("div",{className:"mx_Dialog_buttons_additive"},this.props.additive)),l.a.createElement("div",{className:"mx_Dialog_buttons"},s,e,this.props.children,l.a.createElement("button",{type:this.props.primaryIsSubmit?"submit":"button",className:t,onClick:this.props.onPrimaryButtonClick,autoFocus:this.props.focus,disabled:this.props.disabled||this.props.primaryDisabled},this.props.primaryButton))}},r()(i,"defaultProps",{hasCancel:!0,disabled:!1}),n=a))||n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(88),u=s(150),m=s(85);const p=["title","tooltip","children","tooltipClassName","forceHide","yOffset","alignment"];var g;let v=Object(m.a)("views.elements.AccessibleTooltipButton")(g=class extends d.a.PureComponent{constructor(e){super(e),c()(this,"onMouseOver",()=>{this.props.forceHide||this.setState({hover:!0})}),c()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}componentDidUpdate(e){!e.forceHide&&this.props.forceHide&&this.state.hover&&this.setState({hover:!1})}render(){const e=this.props,{title:t,tooltip:s,children:n,tooltipClassName:a,forceHide:r,yOffset:c,alignment:l}=e,m=o()(e,p),g=this.state.hover&&d.a.createElement(u.b,{tooltipClassName:a,label:s||t,yOffset:c,alignment:l});return d.a.createElement(h.a,i()({},m,{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,"aria-label":t}),n,this.props.label,(s||t)&&g)}})||g},,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(107),d=s(84);class h extends o.a.Component{constructor(...e){super(...e),i()(this,"onOk",()=>{this.props.onFinished(!0)}),i()(this,"onCancel",()=>{this.props.onFinished(!1)})}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("views.elements.DialogButtons");let s="";return this.props.danger&&(s="danger"),o.a.createElement(e,{className:c()("mx_QuestionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",headerImage:this.props.headerImage,hasCancel:this.props.hasCancelButton,fixedWidth:this.props.fixedWidth},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description),o.a.createElement(t,{primaryButton:this.props.button||Object(d.a)("OK"),primaryButtonClass:s,primaryDisabled:this.props.buttonDisabled,cancelButton:this.props.cancelButton,hasCancel:this.props.hasCancelButton&&!this.props.quitOnly,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:this.onCancel},this.props.extraButtons))}}i()(h,"defaultProps",{title:"",description:"",extraButtons:null,focus:!0,hasCancelButton:!0,danger:!1,quitOnly:!1})},,function(e,t,s){"use strict";let n,i;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),function(e){e.AdvancedEncryption="UIFeature.advancedEncryption",e.URLPreviews="UIFeature.urlPreviews",e.Widgets="UIFeature.widgets",e.Voip="UIFeature.voip",e.Feedback="UIFeature.feedback",e.Registration="UIFeature.registration",e.PasswordReset="UIFeature.passwordReset",e.Deactivate="UIFeature.deactivate",e.ShareQRCode="UIFeature.shareQrCode",e.ShareSocial="UIFeature.shareSocial",e.IdentityServer="UIFeature.identityServer",e.ThirdPartyID="UIFeature.thirdPartyId",e.Flair="UIFeature.flair",e.Communities="UIFeature.communities",e.AdvancedSettings="UIFeature.advancedSettings",e.RoomHistorySettings="UIFeature.roomHistorySettings"}(n||(n={})),function(e){e.InviteUsers="UIComponent.sendInvites",e.CreateRooms="UIComponent.roomCreation"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"i",(function(){return a})),s.d(t,"g",(function(){return o})),s.d(t,"h",(function(){return r})),s.d(t,"j",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"e",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"a",(function(){return u})),s.d(t,"k",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"l",(function(){return g}));var n=s(233);function i(e,t){if(e.length===t)return e;const s=[];if(e.length>t){const n=Math.round(e.length/t);for(let t=0;t<e.length;t+=n)s.push(e[t])}else{const n=Math.ceil(t/e.length);for(const t of e)s.push(...r(t,n))}return c(s,t,r(e[e.length-1],t))}function a(e,t){if(e.length===t)return e;let s=[];if(e.length>t){for(;s.length>2*t||0===s.length;){s=[];for(let t=1;t<e.length-1;t+=2){const n=(e[t-1]+e[t+1]+e[t])/3;s.push(n)}e=s}return i(s,t)}return i(e,t)}function o(e,t,s){const i=Math.min(...e),a=Math.max(...e);return e.map(e=>Object(n.d)(Object(n.c)(e,i,a),t,s))}function r(e,t){return new Array(t).fill(e)}function c(e,t,s){return e.length===t?e:e.length>t?e.slice(0,t):e.concat(s.slice(0,t-e.length))}function l(e){return e.slice(0,e.length)}function d(e,t){if(e.length===t.length){for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!0;return!1}return!0}function h(e,t){return e.length!==t.length||(!!t.some(t=>!e.includes(t))||!!e.some(e=>!t.includes(e)))}function u(e,t){return{added:t.filter(t=>!e.includes(t)),removed:e.filter(e=>!t.includes(e))}}function m(e,t){return e.filter(e=>t.includes(e))}function p(...e){return Array.from(e.reduce((e,t)=>(t.forEach(t=>e.add(t)),e),new Set))}function g(e,t,s){const n=Array.from(e),[i]=n.splice(t,1);return n.splice(s,0,i),n}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return p}));var n=s(99),i=s.n(n),a=s(5),o=s(1),r=s(94),c=s(4),l=s(282),d=s(343);let h;!function(e){e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled"}(h||(h={}));const u={};function m(e){return u[e]||(u[e]=e),u[e]}class p extends a.EventEmitter{constructor(e={}){super(),this.event=e,i()(this,"pushActions",null),i()(this,"_replacingEvent",null),i()(this,"_localRedactionEvent",null),i()(this,"_isCancelled",!1),i()(this,"clearEvent",void 0),i()(this,"senderCurve25519Key",null),i()(this,"claimedEd25519Key",null),i()(this,"forwardingCurve25519KeyChain",[]),i()(this,"untrusted",null),i()(this,"_decryptionPromise",null),i()(this,"retryDecryption",!1),i()(this,"txnId",null),i()(this,"thread",null),i()(this,"localTimestamp",void 0),i()(this,"sender",null),i()(this,"target",null),i()(this,"status",null),i()(this,"error",null),i()(this,"forwardLooking",!0),i()(this,"verificationRequest",null),i()(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(t=>{"string"==typeof e[t]&&(e[t]=m(e[t]))}),["membership","avatar_url","displayname"].forEach(t=>{var s;"string"==typeof(null===(s=e.content)||void 0===s?void 0:s[t])&&(e.content[t]=m(e.content[t]))}),["rel_type"].forEach(t=>{var s,n;"string"==typeof(null===(s=e.content)||void 0===s||null===(n=s["m.relates_to"])||void 0===n?void 0:n[t])&&(e.content["m.relates_to"][t]=m(e.content["m.relates_to"][t]))}),this.txnId=e.txn_id||null,this.localTimestamp=Date.now()-this.getAge(),this.reEmitter=new d.a(this)}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===r.a.RoomMessageEncrypted)for(const[t,s]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=s);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===r.c.Thread)return t.event_id}get isThreadRelation(){return!!this.threadRootId}get isThreadRoot(){const e=this.getThread();return(null==e?void 0:e.id)===this.getId()}get parentEventId(){return this.replyEventId||this.relationEventId}get replyEventId(){var e;const t=this.getWireContent()["m.relates_to"];return null==t||null===(e=t["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e,t;return null===(e=this.getWireContent())||void 0===e||null===(t=e["m.relates_to"])||void 0===t?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,s,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=s,this.claimedEd25519Key=n}isBeingDecrypted(){return null!=this._decryptionPromise}getDecryptionPromise(){return this._decryptionPromise}isDecryptionFailure(){var e,t;return"m.bad.encrypted"===(null===(e=this.clearEvent)||void 0===e||null===(t=e.content)||void 0===t?void 0:t.msgtype)}shouldAttemptDecryption(){return this.isEncrypted()&&!this.isBeingDecrypted()&&!this.clearEvent}async attemptDecryption(e,t={}){if("boolean"==typeof t&&(t={isRetry:t}),!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this.clearEvent&&!this.isDecryptionFailure())throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(o.a.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this.decryptionLoop(e,t),this._decryptionPromise)}cancelAndResendKeyRequest(e,t){const s=this.getWireContent();return e.requestRoomKey({algorithm:s.algorithm,room_id:this.getRoomId(),session_id:s.session_id,sender_key:s.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){const t=this.getWireContent(),s=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&s.push({userId:n,deviceId:t.device_id}),s}async decryptionLoop(e,t={}){for(await Promise.resolve();;){let s,n;this.retryDecryption=!1;try{e?(s=await e.decryptEvent(this),!0===t.isRetry&&o.a.info(`Decrypted event on retry (id=${this.getId()})`)):s=this.badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name){const s=t.isRetry?"re":"";return o.a.error(`Error ${s}decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this.retryDecryption=!1)}if(n=e,this.retryDecryption){o.a.log(`Got error decrypting event (id=${this.getId()}: `+e+"), but retrying");continue}o.a.warn(`Error decrypting event (id=${this.getId()}): ${e.detailedString}`),s=this.badEncryptedMessage(e.message)}return this._decryptionPromise=null,this.retryDecryption=!1,this.setClearData(s),this.setPushActions(null),void(!1!==t.emit&&this.emit("Event.decrypted",this,n))}}badEncryptedMessage(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}}setClearData(e){this.clearEvent=e.clearEvent,this.senderCurve25519Key=e.senderCurve25519Key||null,this.claimedEd25519Key=e.claimedEd25519Key||null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&"m.room.encrypted"===this.event.type}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return{ed25519:this.claimedEd25519Key}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return this.untrusted}getUnsigned(){return this.event.unsigned||{}}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}makeRedacted(e){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");let t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(g.has(t)||delete this.event[t]);const s=v[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(s[t]||delete n[t])}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return"m.room.redaction"===this.getType()}getRedactionEvent(){var e,t;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null===(t=this.clearEvent)||void 0===t?void 0:t.unsigned.redacted_because:this.event.unsigned.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(e){this.pushActions=e}handleRemoteEcho(e){const t=this.getUnsigned(),s=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==s&&this.emit("Event.localEventIdReplaced",this)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit("Event.status",this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)}isRelation(e){const t=this.getWireContent(),s=t&&t["m.relates_to"];return s&&s.rel_type&&s.event_id&&(e&&s.rel_type===e||!e)}getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null}makeReplaced(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){const t=this.getUnsigned()["m.relations"];if(t)return t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(r.c.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(r.c.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new p(JSON.parse(JSON.stringify(this.event)));for(const[t,s]of Object.entries(this))"event"!==t&&(e[t]=s);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=Object(c.k)(this.event),s=Object(c.k)(e.event);return JSON.stringify(t)===JSON.stringify(s)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.thread=e,this.reEmitter.reEmit(e,[l.b.Ready,l.b.Update])}getThread(){return this.thread}}const g=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),v={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(82),i=s(133);let a;!function(e){e.Room="Room",e.Thread="Thread",e.ThreadsList="ThreadsList",e.File="File",e.Notification="Notification"}(a||(a={}));const o=Object(n.createContext)({roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!1,numUnreadMessages:0,draggingFile:!1,searching:!1,guestsCanJoin:!1,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:!0,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,layout:i.a.Group,singleSideBubbles:!1,adaptiveSideBubbles:!1,lowBandwidth:!1,alwaysShowTimestamps:!1,showTwelveHourTimestamps:!1,readMarkerInViewThresholdMs:3e3,readMarkerOutOfViewThresholdMs:3e4,showHiddenEventsInTimeline:!1,showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:!1,dragCounter:0,timelineRenderingType:a.Room,liveTimeline:void 0});o.displayName="RoomContext",t.b=o},,function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"e",(function(){return f})),s.d(t,"h",(function(){return b})),s.d(t,"g",(function(){return y})),s.d(t,"f",(function(){return E})),s.d(t,"d",(function(){return S})),s.d(t,"k",(function(){return _})),s.d(t,"l",(function(){return w})),s.d(t,"c",(function(){return C})),s.d(t,"j",(function(){return k})),s.d(t,"i",(function(){return R})),s.d(t,"b",(function(){return N}));var n=s(83),i=s.n(n),a=s(1167),o=s.n(a),r=s(4),c=s(94),l=s(86),d=s(661),h=s(662);class u extends h.b{constructor(e){if(super(),i()(this,"elementUrl",void 0),this.elementUrl=e,!this.elementUrl.startsWith("http:")&&!this.elementUrl.startsWith("https:"))throw new Error("Element prefix URL does not appear to be an HTTP(S) URL")}forEvent(e,t,s){return`${this.elementUrl}/#/room/${e}/${t}${this.encodeServerCandidates(s)}`}forRoom(e,t){return`${this.elementUrl}/#/room/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${this.elementUrl}/#/user/${e}`}forGroup(e){return`${this.elementUrl}/#/group/${e}`}forEntity(e){if("!"===e[0]||"#"===e[0])return this.forRoom(e);if("@"===e[0])return this.forUser(e);if("+"===e[0])return this.forGroup(e);throw new Error("Unrecognized entity")}isPermalinkHost(e){const t=new URL(this.elementUrl);return e===(t.host||t.hostname)}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(this.elementUrl))throw new Error("Does not appear to be a permalink");const t=e.substring((this.elementUrl+"/#/").length);return u.parseAppRoute(t)}static parseAppRoute(e){const t=e.split("/");if(t.length<2)throw new Error("URL is missing parts");const[s]=t.splice(-1,1),[n,i=""]=s.split("?");t.push(n);const a=t[0],o=t[1];if("user"===a)return h.a.forUser(o);if("group"===a)return h.a.forGroup(o);if("room"===a){const e=t.length>2?t.slice(2).join("/"):"",s=i.split(/&?via=/).filter(e=>!!e);return h.a.forEvent(o,e,s)}throw new Error("Unknown entity type in permalink")}}var m=s(450),p=s(93),g=s(1);class v{constructor(e,t=null){if(i()(this,"room",void 0),i()(this,"roomId",void 0),i()(this,"highestPlUserId",void 0),i()(this,"populationMap",void 0),i()(this,"bannedHostsRegexps",void 0),i()(this,"allowedHostsRegexps",void 0),i()(this,"_serverCandidates",void 0),i()(this,"started",void 0),i()(this,"onRoomState",e=>{switch(e.getType()){case c.a.RoomServerAcl:return this.updateAllowedServers(),this.updateHighestPlUser(),this.updatePopulationMap(),void this.updateServerCandidates();case c.a.RoomPowerLevels:return this.updateHighestPlUser(),void this.updateServerCandidates()}}),i()(this,"onMembership",(e,t,s)=>{const n=t.userId,i=t.membership,a=I(n),o="join"!==s&&"join"===i;"join"===s&&"join"!==i?this.populationMap[a]--:o&&this.populationMap[a]++,this.updateHighestPlUser(),this.updateServerCandidates()}),this.room=e,this.roomId=e?e.roomId:t,this.highestPlUserId=null,this.populationMap=null,this.bannedHostsRegexps=null,this.allowedHostsRegexps=null,this._serverCandidates=null,this.started=!1,!this.roomId)throw new Error("Failed to resolve a roomId for the permalink creator to use")}load(){this.room&&this.room.currentState?(this.updateAllowedServers(),this.updateHighestPlUser(),this.updatePopulationMap(),this.updateServerCandidates()):g.a.warn("Tried to load a permalink creator with no room state")}start(){this.load(),this.room.on("RoomMember.membership",this.onMembership),this.room.on("RoomState.events",this.onRoomState),this.started=!0}stop(){this.room.removeListener("RoomMember.membership",this.onMembership),this.room.removeListener("RoomState.events",this.onRoomState),this.started=!1}get serverCandidates(){return this._serverCandidates}isStarted(){return this.started}forEvent(e){return O().forEvent(this.roomId,e,this._serverCandidates)}forShareableRoom(){if(this.room){const e=this.room.getCanonicalAlias();if(e)return O().forRoom(e)}return O().forRoom(this.roomId,this._serverCandidates)}forRoom(){return O().forRoom(this.roomId,this._serverCandidates)}updateHighestPlUser(){const e=this.room.currentState.getStateEvents("m.room.power_levels","");if(e){const t=e.getContent();if(t){const e=t.users;if(e){const t=Object.entries(e).filter(([e])=>{const t=this.room.getMember(e);if(!t||"join"!==t.membership)return!1;const s=I(e);return!j(s)&&!T(s,this.bannedHostsRegexps)&&T(s,this.allowedHostsRegexps)}).reduce((e,t)=>t[1]>e[1]?t:e,[null,0]),[s,n]=t;if(null!==s&&n>=50)return void(this.highestPlUserId=s)}}}this.highestPlUserId=null}updateAllowedServers(){const e=[];let t=[new RegExp(".*")];if(this.room.currentState){const s=this.room.currentState.getStateEvents("m.room.server_acl","");if(s&&s.getContent()){const n=e=>new RegExp("^"+r.s(e,!1)+"$");(s.getContent().deny||[]).forEach(t=>e.push(n(t)));const i=s.getContent().allow||[];t=[],i.forEach(e=>t.push(n(e)))}}this.bannedHostsRegexps=e,this.allowedHostsRegexps=t}updatePopulationMap(){const e={};for(const t of this.room.getJoinedMembers()){const s=I(t.userId);e[s]||(e[s]=0),e[s]++}this.populationMap=e}updateServerCandidates(){let e=[];this.highestPlUserId&&e.push(I(this.highestPlUserId));const t=Object.keys(this.populationMap).sort((e,t)=>this.populationMap[t]-this.populationMap[e]).filter(t=>!e.includes(t)&&!j(t)&&!T(t,this.bannedHostsRegexps)&&T(t,this.allowedHostsRegexps)).slice(0,3-e.length);e=e.concat(t),this._serverCandidates=e}}function f(e){return O().forEntity(e)}function b(e){return O().forUser(e)}function y(e){if(!e)throw new Error("can't permalink a falsey roomId");if("!"!==e[0])return O().forRoom(e,[]);const t=l.a.get().getRoom(e);if(!t)return O().forRoom(e,[]);const s=new v(t);return s.load(),s.forShareableRoom()}function E(e){return O().forGroup(e)}function S(e){return!!(new d.b).isPermalinkHost(e)||O().isPermalinkHost(e)}function _(e){return e?"#"===e[0]||"!"===e[0]?y(e):"@"===e[0]?b(e):"+"===e[0]?E(e):w(e):null}function w(e){if(!e.startsWith("http:")&&!e.startsWith("https:"))return e;try{const t=decodeURIComponent(e).match(m.a.ELEMENT_URL_PATTERN);if(t)return t[1]}catch(t){return e}try{const t=k(e);if(t)if(t.roomIdOrAlias){const s=t.eventId?"/"+t.eventId:"";e=`#/room/${t.roomIdOrAlias}${s}`,t.viaServers.length>0&&(e+=(new d.b).encodeServerCandidates(t.viaServers))}else t.groupId?e="#/group/"+t.groupId:t.userId&&(e="#/user/"+t.userId)}catch(e){}return e}function C(e){try{let t=k(e);if(!t){const s=e.match(m.a.ELEMENT_URL_PATTERN);if(s){const e=new u("http://localhost"),n=s[1].split("#").slice(1).join("#");t=e.parsePermalink("http://localhost/#"+n)}}if(!t)return null;if(t.userId)return t.userId;if(t.groupId)return t.groupId;if(t.roomIdOrAlias)return t.roomIdOrAlias}catch(e){}return null}function O(){const e=p.a.get().permalinkPrefix;return e&&e!==d.a?new u(e):new d.b}function k(e){const t=p.a.get().permalinkPrefix;return decodeURIComponent(e).startsWith(d.a)?(new d.b).parsePermalink(decodeURIComponent(e)):t&&e.startsWith(t)?new u(t).parsePermalink(e):null}function R(e){try{const t=e.replace("#/","");return u.parseAppRoute(t)}catch(e){}return null}function I(e){return e.split(":").splice(1).join(":")}function x(e){return e?new URL("https://"+e).hostname:null}function T(e,t){if(!(e=x(e)))return!0;if(t.length>0&&!t[0].test)throw new Error(t[0].toString());return t.filter(t=>t.test(e)).length>0}function j(e){return!!(e=x(e))&&(e.startsWith("[")&&e.endsWith("]")&&(e=e.substring(1,e.length-1)),o()(e))}const N=e=>{const t=new v(e);return t.load(),t.serverCandidates}},function(e,t,s){"use strict";var n=s(83),i=s.n(n);class a{constructor(){i()(this,"platform",null)}get(){return this.platform}set(e){this.platform=e}}window.mxPlatformPeg||(window.mxPlatformPeg=new a),t.a=window.mxPlatformPeg},function(e,t,s){"use strict";let n;s.d(t,"c",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a})),function(e){e.RoomMemberList="RoomMemberList",e.FilePanel="FilePanel",e.NotificationPanel="NotificationPanel",e.RoomMemberInfo="RoomMemberInfo",e.EncryptionPanel="EncryptionPanel",e.RoomSummary="RoomSummary",e.Widget="Widget",e.PinnedMessages="PinnedMessages",e.Timeline="Timeline",e.Room3pidMemberInfo="Room3pidMemberInfo",e.GroupMemberList="GroupMemberList",e.GroupRoomList="GroupRoomList",e.GroupRoomInfo="GroupRoomInfo",e.GroupMemberInfo="GroupMemberInfo",e.SpaceMemberList="SpaceMemberList",e.SpaceMemberInfo="SpaceMemberInfo",e.Space3pidMemberInfo="Space3pidMemberInfo",e.ThreadView="ThreadView",e.ThreadPanel="ThreadPanel"}(n||(n={}));const i=[n.RoomSummary,n.NotificationPanel,n.PinnedMessages,n.FilePanel,n.RoomMemberList,n.GroupMemberList,n.GroupRoomList,n.Timeline],a=[n.SpaceMemberList,n.Space3pidMemberInfo,n.SpaceMemberInfo]},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(5),o=s(1164),r=s.n(o);const c="update";class l extends a.EventEmitter{constructor(e,t={}){super(),this.dispatcher=e,i()(this,"storeState",void 0),i()(this,"lock",new r.a),i()(this,"dispatcherRef",void 0),this.dispatcherRef=e.register(this.onDispatch.bind(this)),this.storeState=t}get state(){return this.storeState}stop(){this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async updateState(e){await this.lock.acquireAsync();try{this.storeState=Object.freeze(Object.assign({},this.storeState,e)),this.emit(c,this)}finally{await this.lock.release()}}async reset(e=null,t=!1){await this.lock.acquireAsync();try{this.storeState=Object.freeze(e||{}),t||this.emit(c,this)}finally{await this.lock.release()}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n=s(102),i=s.n(n),a=s(83),o=s.n(a),r=s(197),c=s(4),l=s(84),d=s(121),h=s(93),u=s(86),m=s(132),p=s(92),g=s(1);const v=["count"];function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var y;!function(e){e.Landscape="landscape",e.Portrait="portrait"}(y||(y={}));const E=async e=>{const t=(new TextEncoder).encode(e),s=await window.crypto.subtle.digest("sha-256",t);return[...new Uint8Array(s)].map(e=>e.toString(16).padStart(2,"0")).join("")},S=new Set(["register","login","forgot_password","soft_logout","new","settings","welcome","home","start","directory","start_sso","start_cas","groups","complete_security","post_registration","room","user","group"]);const _=e=>{var t,s;const n=u.a.get(),i=null==n?void 0:n.getRoom(e);return{num_users:null==i?void 0:i.getJoinedMemberCount(),is_encrypted:null==n?void 0:n.isRoomEncrypted(e),is_public:"public"===(null==i||null===(t=i.currentState.getStateEvents("m.room.join_rules",""))||void 0===t||null===(s=t.getContent())||void 0===s?void 0:s.join_rule)}};class w{constructor(){o()(this,"baseUrl",null),o()(this,"appKey",null),o()(this,"userKey",null),o()(this,"anonymous",void 0),o()(this,"appPlatform",void 0),o()(this,"appVersion","unknown"),o()(this,"initTime",w.getTimestamp()),o()(this,"firstPage",!0),o()(this,"heartbeatIntervalId",void 0),o()(this,"activityIntervalId",void 0),o()(this,"trackTime",!0),o()(this,"lastBeat",void 0),o()(this,"storedDuration",0),o()(this,"lastView",void 0),o()(this,"lastViewTime",0),o()(this,"lastViewStoredDuration",0),o()(this,"sessionStarted",!1),o()(this,"heartbeatEnabled",!1),o()(this,"inactivityCounter",0),o()(this,"pendingEvents",[]),o()(this,"lastMsTs",0),o()(this,"getOrientation",()=>window.matchMedia("(orientation: landscape)").matches?y.Landscape:y.Portrait),o()(this,"reportOrientation",()=>{this.track("[CLY]_orientation",{mode:this.getOrientation()})}),o()(this,"endSession",()=>{this.sessionStarted&&(window.removeEventListener("resize",this.reportOrientation),this.reportViewDuration(),this.request({end_session:1,session_duration:w.getTimestamp()-this.lastBeat})),this.sessionStarted=!1}),o()(this,"onVisibilityChange",()=>{document.hidden?this.stopTime():this.startTime()}),o()(this,"onUserActivity",()=>{this.inactivityCounter>=20&&this.startTime(),this.inactivityCounter=0})}static get instance(){return w.internalInstance}get disabled(){return!this.baseUrl}canEnable(){var e,t;const s=h.a.get();return Boolean("1"!==navigator.doNotTrack&&(null==s||null===(e=s.countly)||void 0===e?void 0:e.url)&&(null==s||null===(t=s.countly)||void 0===t?void 0:t.appKey))}async changeUserKey(e,t=!1){const s=this.userKey;this.userKey=e,s&&t&&await this.request({old_device_id:s})}async enable(e=!0){if(!this.disabled&&this.anonymous===e)return;if(!this.canEnable())return;this.disabled||this.request();const t=h.a.get();this.baseUrl=new URL("/i",t.countly.url),this.appKey=t.countly.appKey,this.anonymous=e,e?await this.changeUserKey(Object(r.b)(64)):await this.changeUserKey(await E(u.a.get().getUserId()),!0);const s=d.a.get();this.appPlatform=s.getHumanReadableName();try{this.appVersion=await s.getAppVersion()}catch(e){g.a.warn("Failed to get app version, using 'unknown'")}this.heartbeatIntervalId=setInterval(this.heartbeat.bind(this),5e3),this.trackSessions(),this.trackErrors()}async disable(){this.disabled||(await this.track("Opt-Out"),this.endSession(),window.clearInterval(this.heartbeatIntervalId),window.clearTimeout(this.activityIntervalId),this.baseUrl=null,window.removeEventListener("beforeunload",this.endSession),window.removeEventListener("unload",this.endSession),window.removeEventListener("visibilitychange",this.onVisibilityChange),window.removeEventListener("mousemove",this.onUserActivity),window.removeEventListener("click",this.onUserActivity),window.removeEventListener("keydown",this.onUserActivity),window.removeEventListener("scroll",this.onUserActivity))}reportFeedback(e,t){this.track("[CLY]_star_rating",{rating:e,comment:t},null,{},!0)}trackPageChange(e){this.disabled||this.trackPageView()}async trackPageView(){this.reportViewDuration(),await Object(c.I)(0);const e=await async function(e=!0){const t=Object(r.b)(8),{origin:s,hash:n}=window.location;let{pathname:i}=window.location;s.startsWith("file://")&&(i=`/<redacted_${t}>/`);let[a,o,...c]=n.split("/");S.has(o)||(o=`<redacted_${t}>`);for(let s=0;s<c.length;s++)c[s]=e?`<redacted_${t}>`:await E(c[s]);const l=s+i+`${a}/${o}/${c.join("/")}`,d={};let h="$/"+n;switch(o){case"room":{h="view_room";const e=m.a.getRoomId();h+=" "+c[0],d.room_id=c[0],Object.assign(d,_(e));break}}return{name:h,url:l,meta:d}}(this.anonymous),t=e.name;this.lastView=t,this.lastViewTime=w.getTimestamp();const s=b(b({},e.meta),{},{name:t,visit:1,domain:window.location.hostname,view:e.url,segment:this.appPlatform,start:this.firstPage});this.firstPage&&(this.firstPage=!1),this.track("[CLY]_view",s)}static getTimestamp(){return Math.floor((new Date).getTime()/1e3)}getMsTimestamp(){const e=(new Date).getTime();return this.lastMsTs>=e?this.lastMsTs++:this.lastMsTs=e,this.lastMsTs}async recordError(e,t=!1){if(this.disabled||this.anonymous)return;let s="";"object"==typeof e?void 0!==e.stack?s=e.stack:(void 0!==e.name&&(s+=e.name+":"),void 0!==e.message&&(s+=e.message+"\n"),void 0!==e.fileName&&(s+="in "+e.fileName+"\n"),void 0!==e.lineNumber&&(s+="on "+e.lineNumber),void 0!==e.columnNumber&&(s+=":"+e.columnNumber)):s=e+"",s=await(async(e,t,s)=>{const n=[];e.replace(t,(...e)=>(n.push(s(...e)),""));const i=await Promise.all(n);return e.replace(t,()=>i.shift())})(s,/([!@+#]).+?:[\w:.]+/g,async(e,t)=>t+await E(e.substring(1)));const n=this.getMetrics(),i={_resolution:null==n?void 0:n._resolution,_error:s,_app_version:this.appVersion,_run:w.getTimestamp()-this.initTime,_nonfatal:!t,_view:this.lastView};void 0!==navigator.onLine&&(i._online=navigator.onLine),i._background=document.hasFocus(),this.request({crash:JSON.stringify(i)})}trackErrors(){window.onerror=(e,t,s,n,i)=>{if(void 0!==i)this.recordError(i,!1);else{let i="";void 0!==e&&(i+=e+"\n"),void 0!==t&&(i+="at "+t),void 0!==s&&(i+=":"+s),void 0!==n&&(i+=":"+n),i+="\n";try{const e=[];let t=arguments.callee.caller;for(;t;)e.push(t.name),t=t.caller;i+=e.join("\n")}catch(e){}this.recordError(i,!1)}},window.addEventListener("unhandledrejection",e=>{var t;this.recordError(new Error(`Unhandled rejection (reason: ${(null===(t=e.reason)||void 0===t?void 0:t.stack)||e.reason}).`),!0)})}heartbeat(){const e={};if(this.sessionStarted&&this.trackTime){const t=w.getTimestamp();t-this.lastBeat>=60&&(e.session_duration=t-this.lastBeat,this.lastBeat=t)}(this.pendingEvents.length>0||e.session_duration)&&this.request(e)}async request(e={}){const t=b(b({app_key:this.appKey,device_id:this.userKey},this.getTimeParams()),e);if(this.pendingEvents.length>0){const e=10,s=this.pendingEvents.splice(0,e);t.events=JSON.stringify(s)}const s=new URLSearchParams(t);try{await window.fetch(this.baseUrl.toString(),{method:"POST",mode:"no-cors",cache:"no-cache",redirect:"follow",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s})}catch(e){g.a.error("Analytics error: ",e)}}getTimeParams(){const e=new Date;return{timestamp:this.getMsTimestamp(),hour:e.getHours(),dow:e.getDay()}}queue(e){const{count:t=1}=e,s=i()(e,v),n=b(b(b({},this.getTimeParams()),s),{},{count:t,platform:this.appPlatform,app_version:this.appVersion});this.pendingEvents.push(n),this.pendingEvents.length>1e3&&this.pendingEvents.shift()}startTime(){this.trackTime||(this.trackTime=!0,this.lastBeat=w.getTimestamp()-this.storedDuration,this.lastViewTime=w.getTimestamp()-this.lastViewStoredDuration,this.lastViewStoredDuration=0)}stopTime(){this.trackTime&&(this.trackTime=!1,this.storedDuration=w.getTimestamp()-this.lastBeat,this.lastViewStoredDuration=w.getTimestamp()-this.lastViewTime)}getMetrics(){if(this.anonymous)return;const e={};return e._app_version=this.appVersion,e._ua=navigator.userAgent,screen.width&&screen.height&&(e._resolution=`${screen.width}x${screen.height}`),window.devicePixelRatio&&(e._density=window.devicePixelRatio),e._locale=Object(l.d)(),e}async beginSession(e=!0){if(!this.sessionStarted){this.reportOrientation(),window.addEventListener("resize",this.reportOrientation),this.lastBeat=w.getTimestamp(),this.sessionStarted=!0,this.heartbeatEnabled=e;const t={custom:{home_server:u.a.get()&&u.a.getHomeserverName(),anonymous:this.anonymous}},s={begin_session:1,user_details:JSON.stringify(t)},n=this.getMetrics();n&&(s.metrics=JSON.stringify(n)),await this.request(s)}}reportViewDuration(){this.lastView&&(this.track("[CLY]_view",{name:this.lastView},null,{dur:this.trackTime?w.getTimestamp()-this.lastViewTime:this.lastViewStoredDuration}),this.lastView=null)}trackSessions(){this.beginSession(),this.startTime(),window.addEventListener("beforeunload",this.endSession),window.addEventListener("unload",this.endSession),window.addEventListener("visibilitychange",this.onVisibilityChange),window.addEventListener("mousemove",this.onUserActivity),window.addEventListener("click",this.onUserActivity),window.addEventListener("keydown",this.onUserActivity),window.addEventListener("scroll",this.onUserActivity,{passive:!0}),this.activityIntervalId=setInterval(()=>{this.inactivityCounter++,this.inactivityCounter>=20&&this.stopTime()},6e4)}trackBeginInvite(e){this.track("begin_invite",{},e)}trackSendInvite(e,t,s){this.track("send_invite",{},t,{dur:w.getTimestamp()-e,sum:s})}async trackRoomCreate(e,t){if(this.disabled)return;let s=w.getTimestamp();const n=u.a.get();n.getRoom(t)||(await new Promise(e=>{const s=i=>{i.roomId===t&&(n.off("Room",s),e())};n.on("Room",s)}),s=w.getTimestamp()),this.track("create_room",{},t,{dur:s-e})}trackRoomJoin(e,t,s){this.track(p.a.JoinRoom,{type:s},t,{dur:w.getTimestamp()-e})}async trackSendMessage(e,t,s,n,i,a){if(this.disabled)return;const o=u.a.get().getRoom(s),r=(await t).event_id;let c=w.getTimestamp();o.findEventById(r)||(await new Promise(e=>{const t=s=>{s.getId()===r&&(o.off("Room.localEchoUpdated",t),e())};o.on("Room.localEchoUpdated",t)}),c=w.getTimestamp()),this.track("send_message",{is_edit:n,is_reply:i,msgtype:a.msgtype,format:a.format},s,{dur:c-e})}trackStartCall(e,t=!1,s=!1){this.track("start_call",{is_video:t,is_jitsi:s},e)}trackJoinCall(e,t=!1,s=!1){this.track("join_call",{is_video:t,is_jitsi:s},e)}trackRoomDirectoryBegin(){this.track("room_directory")}trackRoomDirectory(e){this.track("room_directory_done",{},null,{dur:w.getTimestamp()-e})}trackRoomDirectorySearch(e,t){this.track("room_directory_search",{query_length:t.length,query_num_words:t.split(" ").length},null,{sum:e})}async track(e,t,s,n,i=!1){if(this.disabled&&!i)return;let a=t||{};s&&(a=b(b({room_id:await E(s)},_(s)),t)),this.queue(b({key:e,count:1,segmentation:a},n)),this.disabled&&i&&await this.request({device_id:Object(r.b)(64)})}}o()(w,"internalInstance",new w),window.mxCountlyAnalytics=w},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(199),u=s(89),m=s(88),p=s(118),g=s(98),v=s(135),f=s(376),b=s(84);const y=["name","idName","title","url","urls","width","height","resizeMethod","defaultToInitialLetter","onClick","inputRef","className"],E=(e,t,s)=>{let n=[];return s||(n=t||[],e&&(n=[e,...n])),Array.from(new Set(n))};t.a=e=>{const{name:t,idName:s,title:n,url:a,urls:l,width:S=40,height:_=40,resizeMethod:w="crop",defaultToInitialLetter:C=!0,onClick:O,inputRef:k,className:R}=e,I=o()(e,y),[x,T]=(({url:e,urls:t})=>{const s=Object(r.useContext)(p.b),n=s?s.lowBandwidth:u.b.getValue("lowBandwidth"),[i,a]=Object(r.useState)(E(e,t,n)),[o,c]=Object(r.useState)(0),l=Object(r.useCallback)(()=>{c(e=>e+1)},[]);Object(r.useEffect)(()=>{a(E(e,t,n)),c(0)},[e,JSON.stringify(t)]);const d=Object(r.useContext)(g.a),h=Object(r.useCallback)((e,t)=>{"ERROR"!==e&&t!==e&&c(0)},[]);Object(v.a)(d,"sync",h);return[i[o],l]})({url:a,urls:l});if(!x&&C){const e=h.e(t),a=c.a.createElement("span",{className:"mx_BaseAvatar_initial","aria-hidden":"true",style:{fontSize:Object(f.a)(.65*S),width:Object(f.a)(S),lineHeight:Object(f.a)(_)}},e),o=c.a.createElement("img",{className:"mx_BaseAvatar_image",src:h.d(s||t),alt:"",title:n,onError:T,style:{width:Object(f.a)(S),height:Object(f.a)(_)},"aria-hidden":"true"});return O?c.a.createElement(m.a,i()({"aria-label":Object(b.a)("Avatar"),"aria-live":"off"},I,{element:"span",className:d()("mx_BaseAvatar",R),onClick:O,inputRef:k}),a,o):c.a.createElement("span",i()({className:d()("mx_BaseAvatar",R),ref:k},I,{role:"presentation"}),a,o)}return O?c.a.createElement(m.a,i()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",R),element:"img",src:x,onClick:O,onError:T,style:{width:Object(f.a)(S),height:Object(f.a)(_)},title:n,alt:Object(b.a)("Avatar"),inputRef:k},I)):c.a.createElement("img",i()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",R),src:x,onError:T,style:{width:Object(f.a)(S),height:Object(f.a)(_)},title:n,alt:"",ref:k},I))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(91),u=s.n(h),m=s(125),p=s(283),g=s(86),v=s(90),f=s(199),b=s(130),y=s(85),E=s(103);const S=["room","oobData","viewAvatarOnClick","onClick","className"];var _,w,C;let O=Object(y.a)("views.avatars.RoomAvatar")((C=w=class e extends d.a.Component{constructor(t){super(t),c()(this,"onRoomStateEvents",t=>{this.props.room&&t.getRoomId()===this.props.room.roomId&&"m.room.avatar"===t.getType()&&this.setState({urls:e.getImageUrls(this.props)})}),c()(this,"onRoomAvatarClick",()=>{const e={src:f.b(this.props.room,null,null,null),name:this.props.room.name};v.a.createDialog(p.a,e,"mx_Dialog_lightbox",null,!0)}),this.state={urls:e.getImageUrls(this.props)}}componentDidMount(){g.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=g.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}static getDerivedStateFromProps(t){return{urls:e.getImageUrls(t)}}static getImageUrls(t){let s=null;return t.oobData.avatarUrl&&(s=Object(E.b)(t.oobData.avatarUrl).getThumbnailOfSourceHttp(t.width,t.height,t.resizeMethod)),[s,e.getRoomAvatarUrl(t)].filter((function(e){return null!==e&&""!==e}))}static getRoomAvatarUrl(e){return e.room?f.b(e.room,e.width,e.height,e.resizeMethod):null}render(){var e;const t=this.props,{room:s,oobData:n,viewAvatarOnClick:a,onClick:r,className:c}=t,l=o()(t,S),h=s?s.name:n.name,p=s?null!==(e=b.a.shared().getUserIdForRoomId(s.roomId))&&void 0!==e?e:s.roomId:n.roomId;return d.a.createElement(m.a,i()({},l,{className:u()(c,{mx_RoomAvatar_isSpaceRoom:null==s?void 0:s.isSpaceRoom()}),name:h,idName:p,urls:this.state.urls,onClick:a&&this.state.urls[0]?this.onRoomAvatarClick:r}))}},c()(w,"defaultProps",{width:36,height:36,resizeMethod:"crop",oobData:{}}),_=C))||_},function(e,t,s){"use strict";let n,i,a,o,r,c;s.d(t,"f",(function(){return n})),s.d(t,"d",(function(){return i})),s.d(t,"c",(function(){return a})),s.d(t,"e",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c})),function(e){e.Public="public",e.Private="private"}(n||(n={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(i||(i={})),function(e){e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted"}(a||(a={})),function(e){e.RoomMembership="m.room_membership"}(o||(o={})),function(e){e.CanJoin="can_join",e.Forbidden="forbidden"}(r||(r={})),function(e){e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable"}(c||(c={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l);const h=["className","onScroll","onWheel","style","tabIndex","wrappedRef","children"];class u extends d.a.Component{constructor(...e){super(...e),c()(this,"containerRef",d.a.createRef())}componentDidMount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.addEventListener("scroll",this.props.onScroll,{passive:!0}),this.props.wrappedRef&&this.props.wrappedRef(this.containerRef.current)}componentWillUnmount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.removeEventListener("scroll",this.props.onScroll)}getScrollTop(){return this.containerRef.current.scrollTop}render(){const e=this.props,{className:t,onScroll:s,onWheel:n,style:a,tabIndex:r,wrappedRef:c,children:l}=e,u=o()(e,h);return d.a.createElement("div",i()({},u,{ref:this.containerRef,style:a,className:["mx_AutoHideScrollbar",t].join(" "),onWheel:n,tabIndex:null!=r?r:-1}),l)}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(112),o=s(86),r=s(1);class c{constructor(e){this.matrixClient=e,i()(this,"roomToUser",null),i()(this,"userToRooms",null),i()(this,"hasSentOutPatchDirectAccountDataPatch",void 0),i()(this,"mDirectEvent",void 0),i()(this,"onAccountData",e=>{"m.direct"==e.getType()&&(this.mDirectEvent=this.matrixClient.getAccountData("m.direct").getContent()||{},this.userToRooms=null,this.roomToUser=null)}),this.hasSentOutPatchDirectAccountDataPatch=!1;const t=e.getAccountData("m.direct");this.mDirectEvent=t?t.getContent():{}}static makeShared(){return c.sharedInstance=new c(o.a.get()),c.sharedInstance}static setShared(e){c.sharedInstance=e}static shared(){return c.sharedInstance}start(){this.populateRoomToUser(),this.matrixClient.on("accountData",this.onAccountData)}stop(){this.matrixClient.removeListener("accountData",this.onAccountData)}patchUpSelfDMs(e){const t=this.matrixClient.getUserId(),s=e[t];if(s){const n=s.map(e=>{const s=this.matrixClient.getRoom(e);if(s){const n=s.guessDMUserId();if(n&&n!==t)return{userId:n,roomId:e}}}).filter(e=>!!e);return!!n.length&&(e[t]=s.filter(e=>!n.some(t=>t.roomId===e)),n.forEach(({userId:t,roomId:s})=>{const n=e[t];n?(n.push(s),e[t]=Object(a.uniq)(n)):e[t]=[s]}),!0)}}getDMRoomsForUserId(e){return this.getUserToRooms()[e]||[]}getDMRoomForIdentifiers(e){let t=this.getDMRoomsForUserId(e[0]);for(let s=1;s<e.length;s++){const n=this.getDMRoomsForUserId(e[s]);t=t.filter(e=>n.includes(e))}return t.map(e=>o.a.get().getRoom(e)).filter(e=>e&&"join"===e.getMyMembership())[0]}getUserIdForRoomId(e){if(null==this.roomToUser&&this.populateRoomToUser(),void 0===this.roomToUser[e]){const t=this.matrixClient.getRoom(e);if(t)return t.getDMInviter()}return this.roomToUser[e]}getUniqueRoomsWithIndividuals(){return this.roomToUser?Object.keys(this.roomToUser).map(e=>({userId:this.getUserIdForRoomId(e),room:this.matrixClient.getRoom(e)})).filter(e=>e.userId&&e.room&&2===e.room.getInvitedAndJoinedMemberCount()).reduce((e,t)=>(e[t.userId]=t.room)&&e,{}):{}}getUserToRooms(){if(!this.userToRooms){const e=this.mDirectEvent,t=e[this.matrixClient.getUserId()];if(t&&t.length){const t=this.patchUpSelfDMs(e);r.a.warn("Invalid m.direct account data detected (self-chats that shouldn't be), patching it up."),t&&!this.hasSentOutPatchDirectAccountDataPatch&&(this.hasSentOutPatchDirectAccountDataPatch=!0,this.matrixClient.setAccountData("m.direct",e))}this.userToRooms=e}return this.userToRooms}populateRoomToUser(){this.roomToUser={};for(const e of Object.keys(this.getUserToRooms()))for(const t of this.userToRooms[e])this.roomToUser[t]=e}}i()(c,"sharedInstance",void 0)},function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"c",(function(){return m}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a),r=s(449),c=s(183),l=s(86),d=s(87),h=s(1);function u(e){return e.chunk.map(e=>Object(r.c)(e))}function m(e){return e.chunk.map(e=>Object(r.d)(e))}let p=0;const g=[];async function v(e){p>=3&&await new Promise((e,t)=>{g.push(e)}),p++;try{return await e()}catch(e){throw e}finally{p--,function(){const e=g.shift();"function"==typeof e&&e()}()}}class f extends o.a{constructor(){super(),i()(this,"STATE_KEY",{GroupMembers:"GroupMembers",GroupInvitedMembers:"GroupInvitedMembers",Summary:"Summary",GroupRooms:"GroupRooms"}),this._state={},this._state[this.STATE_KEY.Summary]={},this._state[this.STATE_KEY.GroupRooms]={},this._state[this.STATE_KEY.GroupMembers]={},this._state[this.STATE_KEY.GroupInvitedMembers]={},this._ready={},this._ready[this.STATE_KEY.Summary]={},this._ready[this.STATE_KEY.GroupRooms]={},this._ready[this.STATE_KEY.GroupMembers]={},this._ready[this.STATE_KEY.GroupInvitedMembers]={},this._fetchResourcePromise={[this.STATE_KEY.Summary]:{},[this.STATE_KEY.GroupRooms]:{},[this.STATE_KEY.GroupMembers]:{},[this.STATE_KEY.GroupInvitedMembers]:{}},this._resourceFetcher={[this.STATE_KEY.Summary]:e=>v(()=>l.a.get().getGroupSummary(e)),[this.STATE_KEY.GroupRooms]:e=>v(()=>l.a.get().getGroupRooms(e).then(m)),[this.STATE_KEY.GroupMembers]:e=>v(()=>l.a.get().getGroupUsers(e).then(u)),[this.STATE_KEY.GroupInvitedMembers]:e=>v(()=>l.a.get().getGroupInvitedUsers(e).then(u))}}_fetchResource(e,t){if(this._fetchResourcePromise[e][t])return;const s=this._resourceFetcher[e](t);return this._fetchResourcePromise[e][t]=s,s.then(s=>{this._state[e][t]=s,this._ready[e][t]=!0,this._notifyListeners()}).catch(s=>{e===this.STATE_KEY.GroupInvitedMembers&&403===s.httpStatus||(h.a.error(`Failed to get resource ${e} for ${t}`,s),this.emit("error",s,t,e))}).finally(()=>{delete this._fetchResourcePromise[e][t]}),s}_notifyListeners(){this.emit("update")}registerListener(e,t){return this.on("update",t),this.emit("update"),e&&(this._fetchResource(this.STATE_KEY.Summary,e),this._fetchResource(this.STATE_KEY.GroupRooms,e),this._fetchResource(this.STATE_KEY.GroupMembers,e),this._fetchResource(this.STATE_KEY.GroupInvitedMembers,e)),{unregister:()=>{this.unregisterListener(t)}}}unregisterListener(e){this.removeListener("update",e)}isStateReady(e,t){return this._ready[t][e]}getGroupIdsForRoomId(e){return Object.keys(this._state[this.STATE_KEY.GroupRooms]).filter(t=>(this._state[this.STATE_KEY.GroupRooms][t]||[]).some(t=>t.roomId===e))}getSummary(e){return this._state[this.STATE_KEY.Summary][e]||{}}getGroupRooms(e){return this._state[this.STATE_KEY.GroupRooms][e]||[]}getGroupMembers(e){return this._state[this.STATE_KEY.GroupMembers][e]||[]}getGroupInvitedMembers(e){return this._state[this.STATE_KEY.GroupInvitedMembers][e]||[]}getGroupPublicity(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_publicised:null}isUserPrivileged(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_privileged:null}refreshGroupRooms(e){return this._fetchResource(this.STATE_KEY.GroupRooms,e)}refreshGroupMembers(e){return this._fetchResource(this.STATE_KEY.GroupMembers,e)}addRoomToGroup(e,t,s){return l.a.get().addRoomToGroup(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}updateGroupRoomVisibility(e,t,s){return l.a.get().updateGroupRoomVisibility(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}removeRoomFromGroup(e,t){return l.a.get().removeRoomFromGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}inviteUserToGroup(e,t){return l.a.get().inviteUserToGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}acceptGroupInvite(e){return l.a.get().acceptGroupInvite(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}joinGroup(e){return l.a.get().joinGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}leaveGroup(e){return d.a.dispatch({action:"deselect_tags",tag:e}),l.a.get().leaveGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e))}addRoomToGroupSummary(e,t,s){return l.a.get().addRoomToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}addUserToGroupSummary(e,t,s){return l.a.get().addUserToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeRoomFromGroupSummary(e,t){return l.a.get().removeRoomFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeUserFromGroupSummary(e,t){return l.a.get().removeUserFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}setGroupPublicity(e,t){return l.a.get().setGroupPublicity(e,t).then(()=>{c.a.invalidatePublicisedGroups(l.a.get().credentials.userId)}).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}}let b=null;b||(b=new f),t.a=b},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(367),c=s(87),l=s(86),d=s(107),h=s(90),u=s(84),m=s(675),p=s(92),g=s(370),v=s(124),f=s(1),b=s(118);function y(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?y(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):y(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const S={joining:!1,joinError:null,roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,roomAlias:null,roomLoading:!1,roomLoadError:null,quotingEvent:null,replyingToEvent:null,shouldPeek:!1,viaServers:[],wasContextSwitch:!1};class _ extends r.Store{constructor(){super(c.a),i()(this,"state",S)}setState(e){let t=!1;for(const s of Object.keys(e))if(this.state[s]!==e[s]){t=!0;break}t&&(this.state=Object.assign(this.state,e),this.__emitChange())}__onDispatch(e){switch(e.action){case p.a.ViewRoom:this.viewRoom(e);break;case"view_create_group":case"view_welcome_page":case"view_home_page":case"view_my_groups":case"view_group":this.setState({roomId:null,roomAlias:null,viaServers:[],wasContextSwitch:!1});break;case"view_room_error":this.viewRoomError(e);break;case"will_join":this.setState({joining:!0});break;case"cancel_join":this.setState({joining:!1});break;case p.a.JoinRoom:this.joinRoom(e);break;case p.a.JoinRoomError:this.joinRoomError(e);break;case p.a.JoinRoomReady:this.setState({shouldPeek:!1});break;case"on_client_not_viable":case"on_logged_out":this.reset();break;case"reply_to_event":e.context===b.a.Room&&(e.event&&e.event.getRoomId()!==this.state.roomId?c.a.dispatch({action:p.a.ViewRoom,room_id:e.event.getRoomId(),replyingToEvent:e.event}):this.setState({replyingToEvent:e.event}));break;case"open_room_settings":{const t=d.getComponent("dialogs.RoomSettingsDialog");h.a.createTrackedDialog("Room settings","",t,{roomId:e.room_id||this.state.roomId,initialTabId:e.initial_tab_id},null,!1,!0);break}}}async viewRoom(e){if(e.room_id){const t={roomId:e.room_id,roomAlias:e.room_alias,initialEventId:e.event_id,isInitialEventHighlighted:e.highlighted,roomLoading:!1,roomLoadError:null,shouldPeek:void 0===e.should_peek||e.should_peek,joining:e.joining||!1,replyingToEvent:null,isEditingSettings:!1,viaServers:e.via_servers,wasContextSwitch:e.context_switch};e.replyingToEvent&&e.replyingToEvent.getRoomId()===e.room_id&&(t.replyingToEvent=e.replyingToEvent),this.setState(t),e.auto_join&&c.a.dispatch(E(E({},e),{},{action:p.a.JoinRoom,roomId:e.room_id}))}else if(e.room_alias){let t=Object(m.a)(e.room_alias);if(!t){this.setState({roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:null,roomAlias:e.room_alias,roomLoading:!0,roomLoadError:null,viaServers:e.via_servers,wasContextSwitch:e.context_switch});try{const s=await l.a.get().getRoomIdForAlias(e.room_alias);Object(m.b)(e.room_alias,s.room_id),t=s.room_id}catch(t){return f.a.error("RVS failed to get room id for alias: ",t),void c.a.dispatch({action:"view_room_error",room_id:null,room_alias:e.room_alias,err:t})}}c.a.dispatch({action:p.a.ViewRoom,room_id:t,event_id:e.event_id,highlighted:e.highlighted,room_alias:e.room_alias,auto_join:e.auto_join,oob_data:e.oob_data,viaServers:e.via_servers,wasContextSwitch:e.context_switch})}}viewRoomError(e){this.setState({roomId:e.room_id,roomAlias:e.room_alias,roomLoading:!1,roomLoadError:e.err})}async joinRoom(e){const t=v.a.getTimestamp();this.setState({joining:!0});const s=l.a.get(),n=this.state.roomAlias||this.state.roomId,i=this.state.viaServers||[];try{await Object(g.a)(()=>s.joinRoom(n,E({viaServers:i},e.opts)),5,e=>504===e.httpStatus),v.a.instance.trackRoomJoin(t,this.state.roomId,e._type),c.a.dispatch({action:p.a.JoinRoomReady,roomId:this.state.roomId})}catch(e){c.a.dispatch({action:p.a.JoinRoomError,roomId:this.state.roomId,err:e})}}static getInvitingUserId(e){const t=l.a.get(),s=t.getRoom(e);if(s&&"invite"===s.getMyMembership()){const e=s.getMember(t.getUserId()),n=e?e.events.member:null;return n&&n.getSender()}}showJoinRoomError(e,t){let s=e.message?e.message:JSON.stringify(e);if(f.a.log("Failed to join room:",s),"ConnectionError"===e.name)s=Object(u.a)("There was an error joining the room");else if("M_INCOMPATIBLE_ROOM_VERSION"===e.errcode)s=o.a.createElement("div",null,Object(u.a)("Sorry, your homeserver is too old to participate in this room."),o.a.createElement("br",null),Object(u.a)("Please contact your homeserver administrator."));else if(404===e.httpStatus){const e=_.getInvitingUserId(t);e&&(s=e.endsWith(":"+l.a.get().getDomain())?Object(u.a)("The person who invited you already left the room."):Object(u.a)("The person who invited you already left the room, or their server is offline."))}const n=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Failed to join room","",n,{title:Object(u.a)("Failed to join room"),description:s})}joinRoomError(e){this.setState({joining:!1,joinError:e.err}),this.showJoinRoomError(e.err,this.state.roomId)}reset(){this.state=Object.assign({},S)}getRoomId(){return this.state.roomId}getInitialEventId(){return this.state.initialEventId}isInitialEventHighlighted(){return this.state.isInitialEventHighlighted}getRoomAlias(){return this.state.roomAlias}isRoomLoading(){return this.state.roomLoading}getRoomLoadError(){return this.state.roomLoadError}isJoining(){return this.state.joining}getJoinError(){return this.state.joinError}getQuotingEvent(){return this.state.replyingToEvent}shouldPeek(){return this.state.shouldPeek}getWasContextSwitch(){return this.state.wasContextSwitch}}let w=null;w||(w=new _),t.a=w},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(110),i=s.n(n);let a;!function(e){e.IRC="irc",e.Group="group",e.Bubble="bubble"}(a||(a={}));i.a.oneOf(Object.values(a))},function(e,t,s){"use strict";s.d(t,"c",(function(){return ae})),s.d(t,"a",(function(){return oe})),s.d(t,"b",(function(){return re})),s.d(t,"d",(function(){return de}));var n,i,a,o=s(83),r=s.n(o),c=s(95),l=s.n(c),d=s(82),h=s.n(d),u=s(91),m=s.n(u),p=s(94),g=s(117),v=s(282),f=s(234),b=s(84),y=s(255),E=s(107),S=s(87),_=s(133),w=s(136),C=s(86),O=s(415),k=s(98),R=s(215),I=s(376),x=s(178),T=s(126),j=s(154),N=s(144),P=s(85),D=s(150),M=s(264),A=s(192),U=s(92),L=s(142),F=s(375),B=s(501),V=s(510),K=s(1033),W=s(755),G=s(763),H=s(167),q=s(89),$=s(766),z=s(318),J=s(1027),Y=s(1),Q=s(597),X=s(511),Z=s(263),ee=s(512),te=s(516);const se={[p.a.RoomMessage]:"messages.MessageEvent",[p.a.Sticker]:"messages.MessageEvent",[Z.c.name]:"messages.MessageEvent",[p.a.KeyVerificationCancel]:"messages.MKeyVerificationConclusion",[p.a.KeyVerificationDone]:"messages.MKeyVerificationConclusion",[p.a.CallInvite]:"messages.CallEvent"},ne={[p.a.RoomEncryption]:"messages.EncryptionEvent",[p.a.RoomCanonicalAlias]:"messages.TextualEvent",[p.a.RoomCreate]:"messages.RoomCreate",[p.a.RoomMember]:"messages.TextualEvent",[p.a.RoomName]:"messages.TextualEvent",[p.a.RoomAvatar]:"messages.RoomAvatarEvent",[p.a.RoomThirdPartyInvite]:"messages.TextualEvent",[p.a.RoomHistoryVisibility]:"messages.TextualEvent",[p.a.RoomTopic]:"messages.TextualEvent",[p.a.RoomPowerLevels]:"messages.TextualEvent",[p.a.RoomPinnedEvents]:"messages.TextualEvent",[p.a.RoomServerAcl]:"messages.TextualEvent","im.vector.modular.widgets":"messages.TextualEvent",[j.c]:"messages.TextualEvent",[p.a.RoomTombstone]:"messages.TextualEvent",[p.a.RoomJoinRules]:"messages.TextualEvent",[p.a.RoomGuestAccess]:"messages.TextualEvent","m.room.related_groups":"messages.TextualEvent"},ie=new Set([p.a.RoomEncryption,p.a.RoomCanonicalAlias,p.a.RoomCreate,p.a.RoomName,p.a.RoomAvatar,p.a.RoomHistoryVisibility,p.a.RoomTopic,p.a.RoomPowerLevels,p.a.RoomPinnedEvents,p.a.RoomServerAcl,j.c,p.a.RoomTombstone,p.a.RoomJoinRules,p.a.RoomGuestAccess,"m.room.related_groups"]);for(const e of O.a)ne[e]="messages.TextualEvent";function ae(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t&&t.msgtype===p.b.KeyVerificationRequest){const s=C.a.get(),n=s&&s.getUserId();return e.getSender()!==n&&t.to!==n?void 0:"messages.MKeyVerificationRequest"}}if("m.key.verification.done"===t){const t=C.a.get(),s=t&&t.getUserId();if(e.getSender()!==s)return}if("m.key.verification.cancel"!==t&&"m.key.verification.done"!==t||$.a.shouldRender(e,e.request)){if("im.vector.modular.widgets"===t){let t=e.getContent().type;if(t||(t=e.getPrevContent().type),x.a.JITSI.matches(t))return"messages.MJitsiWidgetEvent"}if(e.isState()){if(ie.has(t)&&""!==e.getStateKey())return;return ne[t]}return se[t]}}let oe;!function(e){e.Notif="notif",e.FileGrid="file_grid",e.Pinned="pinned",e.Thread="thread",e.ThreadPanel="thread_list"}(oe||(oe={}));let re=Object(P.a)("views.rooms.EventTile")((a=i=class extends h.a.Component{constructor(e,t){var s;super(e,t),r()(this,"suppressReadReceiptAnimation",void 0),r()(this,"isListeningForReceipts",void 0),r()(this,"tile",h.a.createRef()),r()(this,"replyChain",h.a.createRef()),r()(this,"ref",Object(d.createRef)()),r()(this,"updateThread",e=>{this.setState({thread:e}),this.forceUpdate()}),r()(this,"onNewThread",e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);this.context.getRoom(this.props.mxEvent.getRoomId()).off(v.b.New,this.onNewThread)}}),r()(this,"onRoomReceipt",(e,t)=>{t===C.a.get().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate(()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(this.context.removeListener("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!1)})}),r()(this,"onDecrypted",()=>{this.verifyEvent(this.props.mxEvent),this.forceUpdate()}),r()(this,"onDeviceVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent(this.props.mxEvent)}),r()(this,"onUserVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent(this.props.mxEvent)}),r()(this,"toggleAllReadAvatars",()=>{this.setState({allReadAvatars:!this.state.allReadAvatars})}),r()(this,"onSenderProfileClick",()=>{this.props.timelineRenderingType&&S.a.dispatch({action:U.a.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.props.timelineRenderingType})}),r()(this,"onRequestKeysClick",()=>{this.setState({previouslyRequestedKeys:!0}),this.context.cancelAndResendEventRoomKeyRequest(this.props.mxEvent)}),r()(this,"onPermalinkClicked",e=>{e.preventDefault(),S.a.dispatch({action:U.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()})}),r()(this,"onActionBarFocusChange",e=>{this.setState({actionBarFocused:e})}),r()(this,"getTile",()=>this.tile.current),r()(this,"getReplyChain",()=>this.replyChain.current),r()(this,"getReactions",()=>{if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const e=this.props.mxEvent.getId();return this.props.getRelationsForEvent(e,"m.annotation","m.reaction")}),r()(this,"onReactionsCreated",(e,t)=>{"m.annotation"===e&&"m.reaction"===t&&(this.props.mxEvent.removeListener("Event.relationsCreated",this.onReactionsCreated),this.setState({reactions:this.getReactions()}))}),r()(this,"setQuoteExpanded",e=>{this.setState({isQuoteExpanded:e})}),this.state={actionBarFocused:!1,allReadAvatars:!1,verified:null,previouslyRequestedKeys:!1,reactions:this.getReactions(),hover:!1,thread:null===(s=this.props.mxEvent)||void 0===s?void 0:s.getThread()},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!this.context.getRoom(this.props.mxEvent.getRoomId()))return!1;const e=C.a.get().getUserId();if(this.props.mxEvent.getSender()!==e)return!1;return!![p.a.Sticker,p.a.RoomMessage,p.a.RoomMessageEncrypted].includes(this.props.mxEvent.getType())}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&"sent"!==this.props.eventSendStatus)return!1;const e=this.props.readReceipts||[],t=C.a.get().getUserId();return!e.some(e=>e.userId!==t)}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||"sent"===this.props.eventSendStatus)}UNSAFE_componentWillMount(){this.verifyEvent(this.props.mxEvent)}componentDidMount(){this.suppressReadReceiptAnimation=!1;const e=this.context;this.props.forExport||(e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),e.on("userTrustStatusChanged",this.onUserVerificationChanged),this.props.mxEvent.on("Event.decrypted",this.onDecrypted),this.props.showReactions&&this.props.mxEvent.on("Event.relationsCreated",this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!0)),q.b.getValue("feature_thread")&&(this.props.mxEvent.once(v.b.Ready,this.updateThread),this.props.mxEvent.on(v.b.Update,this.updateThread));const t=this.context.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(v.b.New,this.onNewThread)}UNSAFE_componentWillReceiveProps(e){e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent(e.mxEvent)}shouldComponentUpdate(e,t,s){return!!Object(N.d)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=this.context;e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),e.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),e.removeListener("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!1,this.props.mxEvent.removeListener("Event.decrypted",this.onDecrypted),this.props.showReactions&&this.props.mxEvent.removeListener("Event.relationsCreated",this.onReactionsCreated),q.b.getValue("feature_thread")&&(this.props.mxEvent.off(v.b.Ready,this.updateThread),this.props.mxEvent.off(v.b.Update,this.updateThread));const t=this.context.getRoom(this.props.mxEvent.getRoomId());null==t||t.off(v.b.New,this.onNewThread)}componentDidUpdate(e,t,s){this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(this.context.on("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!0)}get thread(){if(!q.b.getValue("feature_thread"))return null;const e=C.a.get().getRoom(this.props.mxEvent.getRoomId()),t=null==e?void 0:e.threads.get(this.props.mxEvent.getId());return t&&0!==t.length?t:null}renderThreadPanelSummary(){return this.thread?h.a.createElement("div",{className:"mx_ThreadPanel_replies"},h.a.createElement("span",{className:"mx_ThreadPanel_repliesSummary"},this.thread.length),this.renderThreadLastMessagePreview()):null}renderThreadLastMessagePreview(){if(!this.thread)return null;const[e]=this.thread.events.filter(e=>e.isThreadRelation).slice(-1),t=J.a.instance.generatePreviewForEvent(e);return t&&e.sender?h.a.createElement(h.a.Fragment,null,h.a.createElement(L.a,{member:e.sender,width:24,height:24,className:"mx_ThreadInfo_avatar"}),h.a.createElement("div",{className:"mx_ThreadInfo_content"},h.a.createElement("span",{className:"mx_ThreadInfo_message-preview"},t))):null}renderThreadInfo(){return this.thread?h.a.createElement("div",{className:"mx_ThreadInfo",onClick:()=>{Object(z.a)(this.props.mxEvent)}},h.a.createElement("span",{className:"mx_ThreadInfo_threads-amount"},Object(b.a)("%(count)s reply",{count:this.thread.length})),this.renderThreadLastMessagePreview()):null}async verifyEvent(e){if(!e.isEncrypted())return;const t=this.context.getEventEncryptionInfo(e),s=e.getSender(),n=this.context.checkUserTrust(s);if(t.mismatchedSender)return void this.setState({verified:R.a.Warning},this.props.onHeightChanged);if(!n.isCrossSigningVerified())return void this.setState({verified:R.a.Normal},this.props.onHeightChanged);const i=t.sender&&this.context.checkDeviceTrust(s,t.sender.deviceId);i?i.isVerified()?t.authenticated?this.setState({verified:R.a.Verified},this.props.onHeightChanged):this.setState({verified:R.a.Unauthenticated},this.props.onHeightChanged):this.setState({verified:R.a.Warning},this.props.onHeightChanged):this.setState({verified:R.a.Unknown},this.props.onHeightChanged)}propsEqual(e,t){const s=Object.keys(e),n=Object.keys(t);if(s.length!==n.length)return!1;for(let n=0;n<s.length;n++){const i=s[n];if(!t.hasOwnProperty(i))return!1;if("readReceipts"===i){const s=e[i],n=t[i];if(s===n)continue;if(!s||!n)return!1;if(s.length!==n.length)return!1;for(let e=0;e<s.length;e++){if(s[e].userId!==n[e].userId)return!1;if(s[e].roomMember!==n[e].roomMember)return!1}}else if(e[i]!==t[i])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;const e=this.context.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent);if(!e||!e.tweaks)return!1;if(this.props.mxEvent.getSender()===this.context.credentials.userId)return!1;const t=this.context.getRoom(this.props.mxEvent.getRoomId());return(!t||2!==t.currentState.getJoinedMemberCount())&&e.tweaks.highlight}getReadAvatars(){if(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)return h.a.createElement(be,{messageState:this.props.mxEvent.getAssociatedStatus()});const e=this.props.layout==_.a.Bubble?16:5;if(!this.props.readReceipts||0===this.props.readReceipts.length)return h.a.createElement("span",{className:"mx_EventTile_readAvatars"});const t=[];let s=0;const n=this.props.readReceipts;for(let i=0;i<n.length;++i){const a=n[i];let o=!0;(i<e||this.state.allReadAvatars)&&(o=!1),s=this.props.layout===_.a.Bubble?15*(o?e-1:i):-15*(o?e-1:i);const r=a.userId;let c;this.props.readReceiptMap&&(c=this.props.readReceiptMap[r],c||(c={},this.props.readReceiptMap[r]=c)),t.unshift(h.a.createElement(K.a,{key:r,member:a.roomMember,fallbackUserId:r,leftOffset:s,hidden:o,readReceiptInfo:c,checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,onClick:this.toggleAllReadAvatars,timestamp:a.ts,showTwelveHour:this.props.isTwelveHour}))}let i;if(!this.state.allReadAvatars){const t=n.length-e;let a;a=this.props.layout===_.a.Bubble?{left:"calc("+Object(I.b)(s)+" + 15px)"}:{right:"calc("+Object(I.b)(-s)+" + 15px)"},t>0&&(i=h.a.createElement("span",{className:"mx_EventTile_readAvatarRemainder",onClick:this.toggleAllReadAvatars,style:a,"aria-live":"off"},t,"+"))}return h.a.createElement("span",{className:"mx_EventTile_readAvatars"},i,t)}renderE2EPadlock(){const e=this.props.mxEvent;if("m.bad.encrypted"===e.getContent().msgtype)return h.a.createElement(he,null);if(e.isEncrypted())return this.state.verified===R.a.Normal||this.state.verified===R.a.Verified?void 0:this.state.verified===R.a.Unauthenticated?h.a.createElement(ge,null):this.state.verified===R.a.Unknown?h.a.createElement(pe,null):h.a.createElement(ue,null);if(this.context.isRoomEncrypted(e.getRoomId())){if(e.status===g.a.ENCRYPTING)return;if(e.status===g.a.NOT_SENT)return;if(e.isState())return;return h.a.createElement(me,null)}return null}render(){var e;const t=this.props.mxEvent.getContent().msgtype,s=this.props.mxEvent.getType(),{tileHandler:n,isBubbleMessage:i,isInfoMessage:a,isLeftAlignedBubbleMessage:o}=Object(H.d)(this.props.mxEvent),{isQuoteExpanded:r}=this.state;if(!n){const{mxEvent:e}=this.props;return Y.a.warn(`Event type not supported: type:${s} isState:${e.isState()}`),h.a.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},h.a.createElement("div",{className:"mx_EventTile_line"},Object(b.a)("This event could not be displayed")))}const c=E.getComponent(n),l=Q.a.isEligible(this.props.mxEvent),d=m()({mx_EventTile_line:!0,mx_EventTile_mediaLine:l}),u=-1!==["sending","queued","encrypting"].indexOf(this.props.eventSendStatus),g=le(this.props.mxEvent)&&this.props.isRedacted,v=this.props.mxEvent.isDecryptionFailure(),y=C.a.get(),S=y&&y.getUserId(),O=this.props.layout===_.a.Bubble&&this.props.tileShape!==oe.Notif&&this.props.tileShape!==oe.FileGrid,k=S===this.props.mxEvent.getSender(),I=k&&!this.props.singleSideBubbles,x=!k||this.props.singleSideBubbles,j=!!this.props.editState,N=m()({mx_EventTile_bubbleContainer:i&&this.props.layout!=_.a.Bubble,mx_EventTile_leftAlignedBubble:o,mx_EventTile:!0,mx_EventTile_isEditing:j,mx_EventTile_info:a&&this.props.layout!==_.a.Bubble,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!j&&u,mx_EventTile_highlight:this.props.tileShape!==oe.Notif&&this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent,mx_EventTile_continuation:!a&&!i&&((this.props.tileShape?"":this.props.continuation)||s===p.a.CallInvite),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_verified:!i&&this.state.verified===R.a.Verified,mx_EventTile_unverified:!i&&this.state.verified===R.a.Warning,mx_EventTile_unknown:!i&&this.state.verified===R.a.Unknown,mx_EventTile_bad:v,mx_EventTile_emote:"m.emote"===t,sc_EventTile_bubbleContainer:O,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.props.tileShape===oe.ThreadPanel}),P=null!==this.props.eventSendStatus?"off":void 0;let D="#";this.props.permalinkCreator&&(D=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const M=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let A,U,K,q;if(!a&&O&&I?(K=0,q=!1):this.props.tileShape===oe.Notif?(K=24,q=!0):"messages.RoomCreate"===n||i?(K=0,q=!1):a?(K=14,q=!1):this.props.layout==_.a.IRC?(K=14,q=!0):this.props.continuation&&this.props.tileShape!==oe.FileGrid||s===p.a.CallInvite?(K=0,q=!1):(K=30,q=!0),this.props.mxEvent.sender&&K){let e;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender,A=h.a.createElement("div",{className:"mx_EventTile_avatar"},h.a.createElement(L.a,{member:e,width:K,height:K,viewUserOnClick:!0}))}q&&!0!==this.props.hideSender&&(U=this.props.tileShape&&this.props.tileShape!==oe.Thread?h.a.createElement(F.a,{mxEvent:this.props.mxEvent,enableFlair:this.props.enableFlair,userNameColorMode:this.props.userNameColorMode}):h.a.createElement(F.a,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent,enableFlair:this.props.enableFlair,userNameColorMode:this.props.userNameColorMode}));const $=!j&&!this.props.forExport?h.a.createElement(W.a,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:r,toggleThreadExpanded:()=>this.setQuoteExpanded(!r)}):void 0,Z=this.props.mxEvent.getTs()&&(O||this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused),se=C.a.get().getRoom(this.props.mxEvent.getRoomId()),ne=null==se||null===(e=se.findThreadForEvent)||void 0===e?void 0:e.call(se,this.props.mxEvent),ie=this.props.tileShape!==oe.ThreadPanel?this.props.mxEvent.getTs():null==ne?void 0:ne.lastReply.getTs(),ae=Z&&ie?h.a.createElement(B.a,{showRelative:this.props.tileShape===oe.ThreadPanel,showTwelveHour:this.props.isTwelveHour,ts:ie}):null,re=h.a.createElement("div",{className:"mx_EventTile_keyRequestInfo_tooltip_contents"},h.a.createElement("p",null,this.state.previouslyRequestedKeys?Object(b.a)("Your key share request has been sent - please check your other sessions for key share requests."):Object(b.a)("Key share requests are sent to your other sessions automatically. If you rejected or dismissed the key share request on your other sessions, click here to request the keys for this session again.")),h.a.createElement("p",null,Object(b.a)("If your other sessions do not have the key for this message you will not be able to decrypt them."))),ce=this.state.previouslyRequestedKeys?Object(b.a)("Key request sent."):Object(b.a)("<requestLink>Re-request encryption keys</requestLink> from your other sessions.",{},{requestLink:e=>h.a.createElement("a",{onClick:this.onRequestKeysClick},e)}),he=v&&!g?h.a.createElement("div",{className:"mx_EventTile_keyRequestInfo"},h.a.createElement("span",{className:"mx_EventTile_keyRequestInfo_text"},ce),h.a.createElement(V.a,{helpText:re})):null;let ue;g||(ue=h.a.createElement(G.a,{mxEvent:this.props.mxEvent,reactions:this.state.reactions}));const me=h.a.createElement("a",{className:"sc_LinkedTimestamp",href:D,onClick:this.onPermalinkClicked,"aria-label":Object(w.j)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour)},ae),pe=h.a.createElement("span",{className:"sc_PlaceholderTimestamp"},ae),ge=this.props.layout==_.a.IRC,ve=ge?null:me,fe=ge?me:null,be=!ge&&!i&&this.renderE2EPadlock(),ye=ge&&!i&&this.renderE2EPadlock(),Ee=m()("mx_EventTile_msgOption",{sc_readReceipts_empty:!(this.props.readReceipts&&0!==this.props.readReceipts.length||this.shouldShowSentReceipt||this.shouldShowSendingReceipt)});let Se;if(this.props.showReadReceipts){const e=this.getReadAvatars();Se=h.a.createElement("div",{className:Ee},e)}const _e=de(this.props.mxEvent)&&f.a.hasReply(this.props.mxEvent)?h.a.createElement(f.a,{parentEv:this.props.mxEvent,onHeightChanged:this.props.onHeightChanged,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,userNameColorMode:this.props.userNameColorMode,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:r,setQuoteExpanded:this.setQuoteExpanded}):null;switch(this.props.tileShape){case oe.Notif:{const e=this.context.getRoom(this.props.mxEvent.getRoomId());return h.a.createElement(this.props.as||"li",{className:N,"aria-live":P,"aria-atomic":!0,"data-scroll-tokens":M},[h.a.createElement("div",{className:"mx_EventTile_roomName",key:"mx_EventTile_roomName"},h.a.createElement(T.a,{room:e,width:28,height:28}),h.a.createElement("a",{href:D,onClick:this.onPermalinkClicked},e?e.name:"")),h.a.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},A,h.a.createElement("a",{href:D,onClick:this.onPermalinkClicked},U,ae)),h.a.createElement("div",{className:d,key:"mx_EventTile_line"},h.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged,tileShape:this.props.tileShape,editState:this.props.editState,getRelationsForEvent:this.props.getRelationsForEvent}))])}case oe.Thread:{const e=this.context.getRoom(this.props.mxEvent.getRoomId());return h.a.createElement(this.props.as||"li",{className:N,"aria-live":P,"aria-atomic":!0,"data-scroll-tokens":M,"data-has-reply":!!_e,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[h.a.createElement("div",{className:"mx_EventTile_roomName",key:"mx_EventTile_roomName"},h.a.createElement(T.a,{room:e,width:28,height:28}),h.a.createElement("a",{href:D,onClick:this.onPermalinkClicked},e?e.name:"")),h.a.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},A,h.a.createElement("a",{href:D,onClick:this.onPermalinkClicked},U)),h.a.createElement("div",{className:d,key:"mx_EventTile_line"},_e,h.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged,tileShape:this.props.tileShape,editState:this.props.editState,replacingEventId:this.props.replacingEventId,getRelationsForEvent:this.props.getRelationsForEvent}),$,ae),ue])}case oe.ThreadPanel:{var we,Ce;const e=(null===(we=this.props.mxEvent)||void 0===we||null===(Ce=we.sender)||void 0===Ce?void 0:Ce.userId)===C.a.get().getUserId();return h.a.createElement(this.props.as||"li",{ref:this.ref,className:N,tabIndex:-1,"aria-live":P,"aria-atomic":"true","data-scroll-tokens":M,"data-layout":this.props.layout,"data-shape":this.props.tileShape,"data-self":e,"data-has-reply":!!_e,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},h.a.createElement(h.a.Fragment,null,U,A,h.a.createElement("div",{className:d,onClick:()=>Object(z.a)(this.props.mxEvent),key:"mx_EventTile_line"},me,this.renderE2EPadlock(),h.a.createElement("div",{className:"mx_EventTile_body"},J.a.instance.generatePreviewForEvent(this.props.mxEvent)),this.renderThreadPanelSummary()),h.a.createElement(X.a,{className:"mx_MessageActionBar","aria-label":Object(b.a)("Message Actions"),"aria-live":"off"},h.a.createElement(ee.a,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_threadButton",title:Object(b.a)("Reply in thread"),onClick:()=>Object(z.a)(this.props.mxEvent),key:"thread"}),h.a.createElement(te.a,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,onMenuToggle:this.onActionBarFocusChange})),Se))}case oe.FileGrid:return h.a.createElement(this.props.as||"li",{className:N,"aria-live":P,"aria-atomic":!0,"data-scroll-tokens":M},[h.a.createElement("div",{className:d,key:"mx_EventTile_line"},h.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,onHeightChanged:this.props.onHeightChanged,editState:this.props.editState,getRelationsForEvent:this.props.getRelationsForEvent})),h.a.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:D,onClick:this.onPermalinkClicked},h.a.createElement("div",{className:"mx_EventTile_senderDetails"},U,ae))]);default:{var Oe,ke;const e=(null===(Oe=this.props.mxEvent)||void 0===Oe||null===(ke=Oe.sender)||void 0===ke?void 0:ke.userId)===C.a.get().getUserId();if(O){const t=a||i,s=["m.image","m.video"],n=["m.sticker"];let o=!1,r=!1,l=!1;const u=this.props.mxEvent.getContent(),p=this.props.mxEvent.getType(),g=u.msgtype;g&&-1!=s.indexOf(g)&&(o=!0),p&&-1!=n.indexOf(p)&&(o=!0,r=!0),g&&"m.notice"==g&&(l=!0);const v=m()("sc_EventTile_bubbleLine",{sc_EventTile_bubbleLine_info:t}),f=m()("sc_EventTile_bubbleArea",{sc_EventTile_bubbleArea_right:!t&&I,sc_EventTile_bubbleArea_left:!t&&x,sc_EventTile_bubbleArea_center:t,sc_EventTile_bubbleArea_info:t}),b=m()({sc_EventTile_bubble:!o,sc_EventTile_bubble_media:o,sc_EventTile_bubble_info:t,sc_EventTile_bubble_self:!t&&k,sc_EventTile_bubble_right:!t&&I,sc_EventTile_bubble_left:!t&&x,sc_EventTile_bubble_center:t,sc_EventTile_bubble_tail:!t&&!this.props.continuation,sc_EventTile_bubble_notice:l,sc_EventTile_bubble_sticker:r});return h.a.createElement(this.props.as||"li",{ref:this.ref,className:N,tabIndex:-1,"aria-live":P,"aria-atomic":"true","data-scroll-tokens":M,"data-layout":this.props.layout,"data-self":e,"data-has-reply":!!_e,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},h.a.createElement(h.a.Fragment,null,h.a.createElement("div",{className:`${d} ${v}`,key:"mx_EventTile_line"},be,h.a.createElement("div",{className:f},h.a.createElement("div",{className:b},U,_e,t?A:null,h.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,forExport:this.props.forExport,replacingEventId:this.props.replacingEventId,editState:this.props.editState,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged,callEventGrouper:this.props.callEventGrouper,getRelationsForEvent:this.props.getRelationsForEvent,layout:this.props.layout,scBubble:!0,scBubbleActionBar:o?$:null,scBubbleGroupTimestamp:h.a.createElement(h.a.Fragment,null,pe,me)}),o?null:$),he,ue,this.renderThreadInfo())),t?null:A,Se))}return h.a.createElement(this.props.as||"li",{ref:this.ref,className:N,tabIndex:-1,"aria-live":P,"aria-atomic":"true","data-scroll-tokens":M,"data-layout":this.props.layout,"data-self":e,"data-has-reply":!!_e,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},h.a.createElement(h.a.Fragment,null,fe,U,ye,A,h.a.createElement("div",{className:d,key:"mx_EventTile_line"},ve,be,_e,h.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,forExport:this.props.forExport,replacingEventId:this.props.replacingEventId,editState:this.props.editState,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,permalinkCreator:this.props.permalinkCreator,onHeightChanged:this.props.onHeightChanged,callEventGrouper:this.props.callEventGrouper,getRelationsForEvent:this.props.getRelationsForEvent}),he,$,this.props.layout===_.a.IRC&&h.a.createElement(h.a.Fragment,null,ue,this.renderThreadInfo())),Se))}}}},r()(i,"defaultProps",{onHeightChanged:function(){},forExport:!1,layout:_.a.Group}),r()(i,"contextType",k.a),n=a))||n;const ce=["m.room.message","m.sticker"];function le(e){return ce.includes(e.getType())}function de(e,t){if(e.isRedacted()&&!le(e))return!1;if(e.isRelation("m.replace"))return!1;const s=ae(e);return void 0!==s&&("messages.TextualEvent"===s?Object(y.a)(e,t):"messages.RoomCreate"!==s||Boolean(e.getContent().predecessor))}function he(e){return h.a.createElement(fe,l()({title:Object(b.a)("This message cannot be decrypted"),icon:ve.Warning},e))}function ue(e){return h.a.createElement(fe,l()({title:Object(b.a)("Encrypted by an unverified session"),icon:ve.Warning},e))}function me(e){return h.a.createElement(fe,l()({title:Object(b.a)("Unencrypted"),icon:ve.Warning},e))}function pe(e){return h.a.createElement(fe,l()({title:Object(b.a)("Encrypted by a deleted session"),icon:ve.Normal},e))}function ge(e){return h.a.createElement(fe,l()({title:Object(b.a)("The authenticity of this encrypted message can't be guaranteed on this device."),icon:ve.Normal},e))}var ve;!function(e){e.Normal="normal",e.Warning="warning"}(ve||(ve={}));class fe extends h.a.Component{constructor(e){super(e),r()(this,"onHoverStart",()=>{this.setState({hover:!0})}),r()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){let e=null;this.state.hover&&(e=h.a.createElement(D.b,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title}));const t="mx_EventTile_e2eIcon mx_EventTile_e2eIcon_"+this.props.icon;return h.a.createElement("div",{className:t,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},e)}}class be extends h.a.PureComponent{constructor(e){super(e),r()(this,"onHoverStart",()=>{this.setState({hover:!0})}),r()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=!this.props.messageState||"sent"===this.props.messageState,t="not_sent"===this.props.messageState,s=m()({mx_EventTile_receiptSent:e,mx_EventTile_receiptSending:!e&&!t});let n=null;t&&(n=h.a.createElement(A.a,{notification:M.a.RED_EXCLAMATION}));let i=null;if(this.state.hover){let s=Object(b.a)("Sending your message...");"encrypting"===this.props.messageState?s=Object(b.a)("Encrypting your message..."):e?s=Object(b.a)("Your message was sent"):t&&(s=Object(b.a)("Failed to send")),i=h.a.createElement(D.b,{className:"mx_EventTile_readAvatars_receiptTooltip",label:s,yOffset:20})}return h.a.createElement("span",{className:"mx_EventTile_readAvatars"},h.a.createElement("span",{className:s,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},n,i))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a}));var n=s(82);const i=(e,t,s)=>{const i=Object(n.useRef)(s);Object(n.useEffect)(()=>{i.current=s},[s]),Object(n.useEffect)(()=>{if(!e)return;const s=(...e)=>i.current(...e);return e.on(t,s),()=>{e.removeListener(t,s)}},[t,e])},a=(e,t,s)=>{const[a,o]=Object(n.useState)(s()),r=Object(n.useCallback)((...e)=>{o(s(...e))},[s]);return i(e,t,r),a}},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"f",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"g",(function(){return h})),s.d(t,"j",(function(){return u})),s.d(t,"a",(function(){return m})),s.d(t,"i",(function(){return p})),s.d(t,"k",(function(){return v})),s.d(t,"d",(function(){return f})),s.d(t,"e",(function(){return b})),s.d(t,"h",(function(){return y}));var n=s(84);function i(){return[Object(n.a)("Sun"),Object(n.a)("Mon"),Object(n.a)("Tue"),Object(n.a)("Wed"),Object(n.a)("Thu"),Object(n.a)("Fri"),Object(n.a)("Sat")]}function a(){return[Object(n.a)("Jan"),Object(n.a)("Feb"),Object(n.a)("Mar"),Object(n.a)("Apr"),Object(n.a)("May"),Object(n.a)("Jun"),Object(n.a)("Jul"),Object(n.a)("Aug"),Object(n.a)("Sep"),Object(n.a)("Oct"),Object(n.a)("Nov"),Object(n.a)("Dec")]}function o(e){return(e<10?"0":"")+e}function r(e,t=!1){let s=e.getHours()%12;const i=o(e.getMinutes()),a=e.getHours()>=12?Object(n.a)("PM"):Object(n.a)("AM");if(s=s||12,t){return`${s}:${i}:${o(e.getSeconds())}${a}`}return`${s}:${i}${a}`}function c(e,t=!1){const s=new Date,o=i(),r=a();return e.toDateString()===s.toDateString()?u(e,t):s.getTime()-e.getTime()<5184e5?Object(n.a)("%(weekDayName)s %(time)s",{weekDayName:o[e.getDay()],time:u(e,t)}):s.getFullYear()===e.getFullYear()?Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(time)s",{weekDayName:o[e.getDay()],monthName:r[e.getMonth()],day:e.getDate(),time:u(e,t)}):d(e,t)}function l(e){const t=i(),s=a();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s",{weekDayName:t[e.getDay()],monthName:s[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear()})}function d(e,t=!1,s=!0){const o=i(),r=a();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s %(time)s",{weekDayName:o[e.getDay()],monthName:r[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear(),time:s?h(e,t):u(e,t)})}function h(e,t=!1){return t?r(e,!0):o(e.getHours())+":"+o(e.getMinutes())+":"+o(e.getSeconds())}function u(e,t=!1){return t?r(e):o(e.getHours())+":"+o(e.getMinutes())}function m(e){const t=e.getUTCHours(),s=e.getUTCMinutes(),n=e.getUTCSeconds();let i="";return t&&(i+=t+"h "),(s||i)&&(i+=s+"m "),(n||i)&&(i+=n+"s"),i}function p(e){const t=Math.floor(e/3600).toFixed(0).padStart(2,"0");let s="";return"00"!==t&&(s+=t+":"),s+=`${Math.floor(e%3600/60).toFixed(0).padStart(2,"0")}:${Math.floor(e%3600%60).toFixed(0).padStart(2,"0")}`,s}function g(e,t){return Math.abs(e.getTime()-t.getTime())<=864e5}function v(e,t){return!(!t||!e)&&(!g(e,t)||e.getDay()!==t.getDay())}function f(e){return Object(n.a)("%(date)s at %(time)s",{date:e.toLocaleDateString().replace(/\//g,"-"),time:e.toLocaleTimeString().replace(/:/g,"-")})}function b(e){return e.getFullYear()+"/"+o(e.getMonth()+1)+"/"+o(e.getDate())}function y(e,t=!1){const s=new Date(Date.now());if(g(e,s))return u(e,t);{let t=`${a()[e.getMonth()]} ${e.getDate()}`;return n=s,e.getFullYear()!==n.getFullYear()&&(t+=", "+e.getFullYear()),t}var n}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y})),s.d(t,"b",(function(){return E}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(197),u=s(85),m=s(91),p=s.n(m);const g=["children","className","kind"];var v,f,b;let y;!function(e){e.Solid="solid",e.Outline="outline"}(y||(y={}));let E=Object(u.a)("views.elements.StyledCheckbox")((b=f=class extends d.a.PureComponent{constructor(e){super(e),c()(this,"id",void 0),this.id="checkbox_"+Object(h.b)(10)}render(){const e=this.props,{children:t,className:s,kind:n=y.Solid}=e,a=o()(e,g),r=p()("mx_Checkbox",s,{mx_Checkbox_hasKind:n,["mx_Checkbox_kind_"+n]:n});return d.a.createElement("span",{className:r},d.a.createElement("input",i()({id:this.id},a,{type:"checkbox"})),d.a.createElement("label",{htmlFor:this.id},d.a.createElement("div",{className:"mx_Checkbox_background"},d.a.createElement("div",{className:"mx_Checkbox_checkmark"})),d.a.createElement("div",null,this.props.children)))}},c()(f,"defaultProps",{className:""}),v=b))||v},function(e,t,s){"use strict";s.d(t,"a",(function(){return U})),s.d(t,"i",(function(){return F})),s.d(t,"h",(function(){return B})),s.d(t,"d",(function(){return V})),s.d(t,"e",(function(){return K})),s.d(t,"b",(function(){return $})),s.d(t,"g",(function(){return z})),s.d(t,"f",(function(){return J})),s.d(t,"c",(function(){return Y}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(362),c=s.n(r),l=s(678),d=s.n(l),h=s(1231),u=s(1236),m=s.n(u),p=s(1238),g=s.n(p),v=s(91),f=s.n(v),b=s(706),y=s.n(b),E=s(1240),S=s.n(E),_=s(474),w=s(450),C=s(89),O=s(120),k=s(305),R=s(234),I=s(103);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function T(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}Object(w.a)(h);const j=/([\ud800-\udbff])([\udc00-\udfff])/,N=/([\u2100-\u2bff])/,P=new RegExp("‍| ","g"),D=new RegExp("\\s","g"),M=new RegExp(`^(${y.a.source})+$`,"i"),A=/^#[0-9a-fA-F]{6}$/,U=["bitcoin","ftp","geo","http","https","im","irc","ircs","magnet","mailto","matrix","mms","news","nntp","openpgp4fpr","sip","sftp","sms","smsto","ssh","tel","urn","webcal","wtai","xmpp"],L=/\/_matrix\/media\/r0\/(?:download|thumbnail)\/(.+?)\/(.+?)(?:[?/]|$)/;function F(e){var t;const s=null===(t=Object(k.d)(e))||void 0===t?void 0:t.shortcodes;return null!=s&&s.length?`:${s[0]}:`:""}function B(e){const t=c()(e,G);return o.a.createElement("div",{dangerouslySetInnerHTML:{__html:t},dir:"auto"})}function V(e){return c()(e,{allowedTags:[],allowedAttributes:{},selfClosing:[],allowedSchemes:[],disallowedTagsMode:"discard"})}function K(e){try{return U.includes(new URL(e).protocol.slice(0,-1))}catch(e){return!1}}const W={a:function(e,t){if(t.href){t.target="_blank";const e=Object(O.l)(t.href);(e!==t.href||t.href.match(w.a.ELEMENT_URL_PATTERN))&&(t.href=e,delete t.target)}return t.rel="noreferrer noopener",{tagName:e,attribs:t}},img:function(e,t){let s=t.src;if(!s||!C.b.getValue("showImages"))return{tagName:e,attribs:{}};if(!s.startsWith("mxc://")){const e=L.exec(s);e&&(s=`mxc://${e[1]}/${e[2]}`)}if(!s.startsWith("mxc://"))return{tagName:e,attribs:{}};const n=Number(t.width)||800,i=Number(t.height)||600;return t.src=Object(I.b)(s).getThumbnailOfSourceHttp(n,i),{tagName:e,attribs:t}},code:function(e,t){if(void 0!==t.class){const e=t.class.split(/\s/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")}));t.class=e.join(" ")}return{tagName:e,attribs:t}},"*":function(e,t){delete t.style;const s={"data-mx-color":"color","data-mx-bg-color":"background-color"};let n="";return Object.keys(s).forEach(e=>{const i=s[e],a=t[e];a&&"string"==typeof a&&A.test(a)&&(n+=i+":"+a+";",delete t[e])}),n&&(t.style=n),{tagName:e,attribs:t}}},G={allowedTags:["font","del","h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","sup","sub","nl","li","b","i","u","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","span","img","details","summary"],allowedAttributes:{font:["color","data-mx-bg-color","data-mx-color","style"],span:["data-mx-maths","data-mx-bg-color","data-mx-color","data-mx-spoiler","style"],div:["data-mx-maths"],a:["href","name","target","rel"],img:["src","width","height","alt","title"],ol:["start"],code:["class"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:U,allowProtocolRelative:!1,transformTags:W,nestingLimit:50},H=T(T({},G),{},{transformTags:{code:W.code,"*":W["*"]}});class q extends class{constructor(e,t){this.highlightClass=e,this.highlightLink=t}applyHighlights(e,t){let s,n=0,i=[];const a=t[0];for(;(s=e.toLowerCase().indexOf(a.toLowerCase(),n))>=0;){if(s>n){const a=e.substring(n,s);i=i.concat(this.applySubHighlights(a,t))}const o=s+a.length;i.push(this.processSnippet(e.substring(s,o),!0)),n=o}if(n!==e.length){const s=e.substring(n,void 0);i=i.concat(this.applySubHighlights(s,t))}return i}applySubHighlights(e,t){return t[1]?this.applyHighlights(e,t.slice(1)):[this.processSnippet(e,!1)]}}{processSnippet(e,t){if(!t)return e;let s=`<span class="${this.highlightClass}">${e}</span>`;return this.highlightLink&&(s=`<a href="${encodeURI(this.highlightLink)}">${s}</a>`),s}}function $(e,t,s={}){const n="org.matrix.custom.html"===e.format&&e.formatted_body;let i,a,r,l=!1,h=G;s.forComposerQuote&&(h=H);try{if(t&&t.length>0){const e=new q("mx_EventTile_searchHighlight",s.highlightLink),n=t.filter(e=>!e.includes("<")).map(e=>c()(e,h));h.textFilter=function(t){return e.applyHighlights(t,n).join("")}}let o="string"==typeof e.formatted_body?e.formatted_body:null;const m="string"==typeof e.body?e.body:"";if(s.stripReplyFallback&&o&&(o=R.a.stripHTMLReply(o)),i=s.stripReplyFallback?R.a.stripPlainReply(m):m,u=n?o:m,l=j.test(u)||N.test(u),n&&(r=!0,a=c()(o,h),C.b.getValue("feature_latex_maths"))){const e=d.a.load(a,{_useHtmlParser2:!0,decodeEntities:!1});e('div, span[data-mx-maths!=""]').replaceWith((function(t,s){return S.a.renderToString(_.AllHtmlEntities.decode(e(s).attr("data-mx-maths")),{throwOnError:!1,displayMode:"div"==s.name,output:"htmlAndMathml"})})),a=e.html()}}finally{delete h.textFilter}var u;const m=r?a:i;if(s.returnString)return m;let p=!1;if(!s.disableBigEmoji&&l){let t=void 0!==m?m.trim():"";t=t.replace(D,""),t=t.replace(P,"");const s=M.exec(t);p=s&&s[0]&&s[0].length===t.length&&(i===a||void 0===e.formatted_body||!e.formatted_body.includes("http:")&&!e.formatted_body.includes("https:"))}const g=f()({mx_EventTile_body:!0,mx_EventTile_bigEmoji:p,"markdown-body":n&&!p});return r?o.a.createElement("span",{key:"body",ref:s.ref,className:g,dangerouslySetInnerHTML:{__html:a}}):o.a.createElement("span",{key:"body",ref:s.ref,className:g},i)}function z(e,t=w.a.options){return m()(e,t)}function J(e,t=w.a.options){return c()(function(e,t=w.a.options){return g()(e,t)}(e,t),G)}function Y(e){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"PRE":case"BLOCKQUOTE":case"P":case"UL":case"OL":case"LI":case"HR":case"TABLE":case"THEAD":case"TBODY":case"TR":case"TH":case"TD":return!0;case"DIV":return!e.hasAttribute("data-mx-maths");default:return!1}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a);const r=s(1092);let c;!function(e){e.Resize="resize"}(c||(c={}));class l extends o.a{constructor(){super(),i()(this,"resizeObserver",void 0),i()(this,"uiElementDimensions",new Map),i()(this,"trackedUiElements",new Map),i()(this,"windowWidth",void 0),i()(this,"windowHeight",void 0),i()(this,"resizeObserverCallback",e=>{const t=e.find(e=>e.target===document.body);t&&(this.windowWidth=t.contentRect.width,this.windowHeight=t.contentRect.height),e.forEach(e=>{const t=this.trackedUiElements.get(e.target);t&&(this.uiElementDimensions.set(t,e.contentRect),this.emit(t,c.Resize,e))}),this.emit(c.Resize,e)}),this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,this.resizeObserver=new r(this.resizeObserverCallback),this.resizeObserver.observe(document.body)}static get instance(){return l._instance||(l._instance=new l),l._instance}static destroy(){l._instance&&(l._instance.resizeObserver.disconnect(),l._instance.removeAllListeners(),l._instance=null)}getElementDimensions(e){return this.uiElementDimensions.get(e)}trackElementDimensions(e,t){this.trackedUiElements.set(t,e),this.resizeObserver.observe(t)}stopTrackingElementDimensions(e){let t;this.trackedUiElements.forEach((s,n)=>{s===e&&(t=n)}),t&&(this.resizeObserver.unobserve(t),this.uiElementDimensions.delete(e),this.trackedUiElements.delete(t))}isTrackingElementDimensions(e){return this.uiElementDimensions.has(e)}}i()(l,"_instance",null),window.mxUIStore=l.instance},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(121),l=s(93),d=s(90),h=s(107),u=s(1);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const g=/#\/(groups?|room|user|settings|register|login|forgot_password|home|directory)/,v=/#\/(group|room|user)\/.*$/;function f(){const{origin:e,hash:t}=window.location;let{pathname:s}=window.location;return e.startsWith("file://")&&(s="/<redacted>/"),e+s+function(e){return g.exec(e)?v.test(e)?e.replace(v,"#/$1/<redacted>"):e.replace(g,"#/$1"):(u.a.warn(`Unexpected hash location "${e}"`),"#/<unexpected hash location>")}(t)}const b={"App Platform":{id:1,expl:Object(r.b)("The platform you're on"),example:"Electron Platform"},"App Version":{id:2,expl:Object(r.b)("The version of %(brand)s"),getTextVariables:()=>({brand:l.a.get().brand}),example:"15.0.0"},"User Type":{id:3,expl:Object(r.b)("Whether or not you're logged in (we don't record your username)"),example:"Logged In"},"Chosen Language":{id:4,expl:Object(r.b)("Your language of choice"),example:"en"},Instance:{id:5,expl:Object(r.b)("Which officially provided instance you are using, if any"),example:"app"},"RTE: Uses Richtext Mode":{id:6,expl:Object(r.b)("Whether or not you're using the Richtext mode of the Rich Text Editor"),example:"off"},"Homeserver URL":{id:7,expl:Object(r.b)("Your homeserver's URL"),example:"https://matrix.org"},"Touch Input":{id:8,expl:Object(r.b)("Whether you're using %(brand)s on a device where touch is the primary input mechanism"),getTextVariables:()=>({brand:l.a.get().brand}),example:"false"},Breadcrumbs:{id:9,expl:Object(r.b)("Whether or not you're using the 'breadcrumbs' feature (avatars above the room list)"),example:"disabled"},"Installed PWA":{id:10,expl:Object(r.b)("Whether you're using %(brand)s as an installed Progressive Web App"),getTextVariables:()=>({brand:l.a.get().brand}),example:"false"}};const y="mx_Riot_Analytics_uid";class E{constructor(){i()(this,"baseUrl",null),i()(this,"siteId",null),i()(this,"visitVariables",{}),i()(this,"firstPage",!0),i()(this,"heartbeatIntervalID",null),i()(this,"creationTs",void 0),i()(this,"lastVisitTs",void 0),i()(this,"visitCount",void 0),i()(this,"showDetailsModal",()=>{let e=[];e=this.disabled?Object.keys(b).map(e=>[e,Object(r.a)("e.g. %(exampleValue)s",{exampleValue:b[e].example})]):Object.values(this.visitVariables);const t=`${window.screen.width}x${window.screen.height}`,s=[{expl:Object(r.b)("Every page you use in the app"),value:Object(r.a)("e.g. <CurrentPageURL>",{},{CurrentPageURL:f})},{expl:Object(r.b)("Your user agent"),value:navigator.userAgent},{expl:Object(r.b)("Your device resolution"),value:t}],n=h.getComponent("dialogs.ErrorDialog");d.a.createTrackedDialog("Analytics Details","",n,{title:Object(r.a)("Analytics"),description:o.a.createElement("div",{className:"mx_AnalyticsModal"},o.a.createElement("div",null,Object(r.a)("The information being sent to us to help make %(brand)s better includes:",{brand:l.a.get().brand})),o.a.createElement("table",null,e.map(e=>o.a.createElement("tr",{key:e[0]},o.a.createElement("td",null,Object(r.a)(b[e[0]].expl,b[e[0]].getTextVariables?b[e[0]].getTextVariables():null)),void 0!==e[1]&&o.a.createElement("td",null,o.a.createElement("code",null,e[1])))),s.map((e,t)=>o.a.createElement("tr",{key:t},o.a.createElement("td",null,Object(r.a)(e.expl)),o.a.createElement("td",null,o.a.createElement("code",null,e.value))))),o.a.createElement("div",null,Object(r.a)("Where this page includes identifiable information, such as a room, user or group ID, that data is removed before being sent to the server.")))})}),this.creationTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_cts"),!this.creationTs&&localStorage&&localStorage.setItem("mx_Riot_Analytics_cts",this.creationTs=String((new Date).getTime())),this.lastVisitTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_lvts"),this.visitCount=localStorage&&localStorage.getItem("mx_Riot_Analytics_vc")||"0",this.visitCount=String(parseInt(this.visitCount,10)+1),localStorage&&localStorage.setItem("mx_Riot_Analytics_vc",this.visitCount)}get disabled(){return!this.baseUrl}canEnable(){const e=l.a.get();return"1"!==navigator.doNotTrack&&e&&e.piwik&&e.piwik.url&&e.piwik.siteId}async enable(){if(!this.disabled)return;if(!this.canEnable())return;const e=l.a.get();this.baseUrl=new URL("piwik.php",e.piwik.url),this.baseUrl.searchParams.set("rec","1"),this.baseUrl.searchParams.set("idsite",e.piwik.siteId),this.baseUrl.searchParams.set("apiv","1"),this.baseUrl.searchParams.set("send_image","0"),this.baseUrl.searchParams.set("_id",function(){try{let e=localStorage&&localStorage.getItem(y);return!e&&localStorage&&localStorage.setItem(y,e=[...Array(16)].map(()=>Math.random().toString(16)[2]).join("")),e}catch(e){return u.a.error("Analytics error: ",e),""}}()),this.baseUrl.searchParams.set("_idts",this.creationTs),this.baseUrl.searchParams.set("_idvc",this.visitCount),this.lastVisitTs&&this.baseUrl.searchParams.set("_viewts",this.lastVisitTs);const t=c.a.get();this.setVisitVariable("App Platform",t.getHumanReadableName());try{this.setVisitVariable("App Version",await t.getAppVersion())}catch(e){this.setVisitVariable("App Version","unknown")}this.setVisitVariable("Chosen Language",Object(r.d)());const s=window.location.hostname;"riot.im"===s?this.setVisitVariable("Instance",window.location.pathname):s.endsWith(".element.io")&&this.setVisitVariable("Instance",s.replace(".element.io",""));let n="unknown";try{n=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}this.setVisitVariable("Installed PWA",n);let i="unknown";try{i=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}this.setVisitVariable("Touch Input",i),this.heartbeatIntervalID=window.setInterval(this.ping.bind(this),3e4)}disable(){this.disabled||(this.trackEvent("Analytics","opt-out"),window.clearInterval(this.heartbeatIntervalID),this.baseUrl=null,this.visitVariables={},localStorage.removeItem(y),localStorage.removeItem("mx_Riot_Analytics_cts"),localStorage.removeItem("mx_Riot_Analytics_vc"),localStorage.removeItem("mx_Riot_Analytics_lvts"))}async track(e){if(this.disabled)return;const t=new Date,s=p(p({},e),{},{url:f(),_cvar:JSON.stringify(this.visitVariables),res:`${window.screen.width}x${window.screen.height}`,rand:String(Math.random()).slice(2,8),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()}),n=new URL(this.baseUrl.toString());for(const e in s)n.searchParams.set(e,s[e]);try{await window.fetch(n.toString(),{method:"GET",mode:"no-cors",cache:"no-cache",redirect:"follow"})}catch(e){u.a.error("Analytics error: ",e)}}ping(){this.track({ping:"1"}),localStorage.setItem("mx_Riot_Analytics_lvts",String((new Date).getTime()))}trackPageChange(e){this.disabled||(this.firstPage?this.firstPage=!1:("number"!=typeof e&&u.a.warn("Analytics.trackPageChange: expected generationTimeMs to be a number"),this.track({gt_ms:String(e)})))}trackEvent(e,t,s,n){this.disabled||this.track({e_c:e,e_a:t,e_n:s,e_v:n})}setVisitVariable(e,t){this.disabled||(this.visitVariables[b[e].id]=[e,t])}setLoggedIn(e,t){if(this.disabled)return;const s=l.a.get();if(!s.piwik)return;const n=s.piwik.whitelistedHSUrls||[];var i;this.setVisitVariable("User Type",e?"Guest":"Logged In"),this.setVisitVariable("Homeserver URL",(i=t,n.includes(i)?i:"<redacted>"))}setBreadcrumbs(e){this.disabled||this.setVisitVariable("Breadcrumbs",e?"enabled":"disabled")}}window.mxAnalytics||(window.mxAnalytics=new E),t.a=window.mxAnalytics},function(e,t,s){"use strict";s.d(t,"b",(function(){return R})),s.d(t,"e",(function(){return I})),s.d(t,"a",(function(){return x})),s.d(t,"d",(function(){return T})),s.d(t,"c",(function(){return j})),s.d(t,"f",(function(){return N}));var n=s(83),i=s.n(n),a=s(94),o=s(127),r=s(86),c=s(90),l=s(84),d=s(87),h=s(180),u=s(130),m=s(295),p=s(268),g=s(131),v=s(124),f=s(191),b=s(151),y=s(106),E=s(186),S=s(92),_=s(104),w=s(96),C=s(1);function O(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function k(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?O(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):O(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}async function R(e){void 0===(e=e||{}).spinner&&(e.spinner=!0),void 0===e.guestAccess&&(e.guestAccess=!0),void 0===e.encryption&&(e.encryption=!1);const t=v.a.getTimestamp(),s=r.a.get();if(s.isGuest())return d.a.dispatch({action:"require_registration"}),null;const n=e.dmUserId?o.d.TrustedPrivateChat:o.d.PrivateChat,i=e.createOpts||{};if(i.preset=i.preset||n,i.visibility=i.visibility||o.f.Private,e.dmUserId&&void 0===i.invite)switch(Object(m.c)(e.dmUserId)){case"mx-user-id":i.invite=[e.dmUserId];break;case"email":i.invite_3pid=[{id_server:r.a.get().getIdentityServerUrl(!0),medium:"email",address:e.dmUserId}]}var u;(e.dmUserId&&void 0===i.is_direct&&(i.is_direct=!0),e.roomType&&(i.creation_content=k(k({},i.creation_content),{},{[a.d]:e.roomType})),void 0===e.andView&&(e.andView=!0),i.initial_state=i.initial_state||[],e.guestAccess&&i.initial_state.push({type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}}),e.encryption&&i.initial_state.push({type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}),e.parentSpace)&&(i.initial_state.push(Object(E.d)(e.parentSpace,!0)),e.historyVisibility||(e.historyVisibility=i.preset===o.d.PublicChat?o.b.WorldReadable:o.b.Invited),e.joinRule===o.c.Restricted&&null!==(u=y.a.instance.restrictedJoinRuleSupport)&&void 0!==u&&u.preferred&&(i.room_version=y.a.instance.restrictedJoinRuleSupport.preferred,i.initial_state.push({type:a.a.RoomJoinRules,content:{join_rule:o.c.Restricted,allow:[{type:o.e.RoomMembership,room_id:e.parentSpace.roomId}]}})));if(e.joinRule&&e.joinRule!==o.c.Restricted&&i.initial_state.push({type:a.a.RoomJoinRules,content:{join_rule:e.joinRule}}),e.avatar){let t=e.avatar;e.avatar instanceof File&&(t=await s.uploadContent(e.avatar)),i.initial_state.push({type:a.a.RoomAvatar,content:{url:t}})}let p,f;return e.historyVisibility&&i.initial_state.push({type:a.a.RoomHistoryVisibility,content:{history_visibility:e.historyVisibility}}),e.spinner&&(p=c.a.createDialog(w.a,null,"mx_Dialog_spinner")),s.createRoom(i).catch((function(e){return 403===e.httpStatus&&"M_UNKNOWN"===e.errcode&&"Not allowed to publish room"===e.data.error?(C.a.warn("Failed to publish room, try again without publishing it"),i.visibility=o.f.Private,s.createRoom(i)):Promise.reject(e)})).finally((function(){p&&p.close()})).then((function(t){return f=t.room_id,e.dmUserId?h.g(f,e.dmUserId):Promise.resolve()})).then(()=>e.parentSpace?y.a.instance.addRoomToSpace(e.parentSpace,f,[s.getDomain()],e.suggested):e.associatedWithCommunity?g.a.addRoomToGroup(e.associatedWithCommunity,f,!1):void 0).then((function(){return e.andView&&d.a.dispatch({action:S.a.ViewRoom,room_id:f,should_peek:!1,joining:!0,justCreatedOpts:e}),v.a.instance.trackRoomCreate(t,f),f}),(function(t){if(e.inlineErrors)throw t;d.a.dispatch({action:S.a.JoinRoomError,roomId:f}),C.a.error("Failed to create room "+f+" "+t);let s=Object(l.a)("Server may be unavailable, overloaded, or you hit a bug.");return"M_UNSUPPORTED_ROOM_VERSION"===t.errcode&&(s=Object(l.a)("The server does not support the room version specified.")),c.a.createTrackedDialog("Failure to create room","",_.a,{title:Object(l.a)("Failure to create room"),description:s}),null}))}function I(e,t){const s=u.a.shared().getDMRoomsForUserId(t).map(t=>e.getRoom(t)).filter(e=>{if(e&&"join"===e.getMyMembership()){const s=e.currentState.getMembers().filter(e=>Object(f.c)(e.membership));return s.find(e=>e.userId===t)&&2===s.length}return!1}).sort((e,t)=>t.getLastActiveTimestamp()-e.getLastActiveTimestamp());if(s.length)return s[0]}async function x(e,t){try{const s=await e.downloadKeys(t);return Object.values(s).every(e=>Object.keys(e).length>0)}catch(e){return C.a.error("Error determining if it's possible to encrypt to all users: ",e),!1}}async function T(e,t,s){const n=I(e,t);let i;return i=n?n.roomId:await R({dmUserId:t,spinner:!1,andView:!1,createOpts:{creation_content:{[b.c]:s}}}),i}async function j(e,t){const s=I(e,t);let n;if(s)n=s.roomId;else{let s=void 0;N()&&(s=await x(e,[t])),n=await R({encryption:s,dmUserId:t,spinner:!1,andView:!1}),await async function(e,t,s,n={timeout:1500}){const{timeout:i}=n;let a;return new Promise(n=>{a=function(e,i,a){a.userId===s&&a.roomId===t&&n(!0)},e.on("RoomState.newMember",a),setTimeout(n,i,!1)}).finally(()=>{e.removeListener("RoomState.newMember",a)})}(e,n,t)}return n}function N(){const e=Object(p.c)();if(e){return!(!1===e.default)}return!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(87),u=s(92),m=s(125),p=s(85),g=s(103),v=s(1);const f=["member","fallbackUserId","onClick","viewUserOnClick"];var b,y,E;let S=Object(p.a)("views.avatars.MemberAvatar")((E=y=class e extends d.a.Component{constructor(t){super(t),this.state=e.getState(t)}static getDerivedStateFromProps(t){return e.getState(t)}static getState(e){var t;if(null!==(t=e.member)&&void 0!==t&&t.name){let t=null;return e.member.getMxcAvatarUrl()&&(t=Object(g.b)(e.member.getMxcAvatarUrl()).getThumbnailOfSourceHttp(e.width,e.height,e.resizeMethod)),{name:e.member.name,title:e.title||e.member.userId,imageUrl:t}}if(e.fallbackUserId)return{name:e.fallbackUserId,title:e.fallbackUserId};v.a.error("MemberAvatar called somehow with null member or fallbackUserId")}render(){let e=this.props,{member:t,fallbackUserId:s,onClick:n,viewUserOnClick:a}=e,r=o()(e,f);const c=t?t.userId:s;return a&&(n=()=>{h.a.dispatch({action:u.a.ViewUser,member:this.props.member})}),d.a.createElement(m.a,i()({},r,{name:this.state.name,title:this.state.title,idName:c,url:this.state.imageUrl,onClick:n}))}},c()(y,"defaultProps",{width:40,height:40,resizeMethod:"crop",viewUserOnClick:!1}),b=E))||b},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"d",(function(){return a})),s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return c}));var n=s(1);async function i(e){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const s=document.getSelection(),n=document.createRange();n.selectNode(t),s.removeAllRanges(),s.addRange(n);const i=document.execCommand("copy");return s.removeAllRanges(),document.body.removeChild(t),i}}catch(e){n.a.error("copyPlaintext failed",e)}return!1}function a(e){const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t)}function o(e){return a(e),document.execCommand("copy")}const r=new Intl.Collator;function c(e,t){return r.compare(e,t)}},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"g",(function(){return a})),s.d(t,"f",(function(){return o})),s.d(t,"d",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"e",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(116);function i(e,t){const s=new Map(Object.entries(e));for(const e of t)s.delete(e);return Array.from(s.entries()).reduce((e,[t,s])=>(e[t]=s,e),{})}function a(e,t){const s=Object.keys(e),a=Object(n.a)(s,t);return 0===a.removed.length?o(e):i(e,a.removed)}function o(e,t){const s={};for(const[n,i]of Object.entries(e))s[n]=i,t&&(s[n]=t(n,i));return s}function r(e,t){if(e===t)return!1;const s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!0;const a=Object(n.k)(s,i);return a.length!==s.length||a.some(s=>e[s]!==t[s])}function c(e,t){const s=Object.keys(e),i=Object.keys(t),a=Object(n.a)(s,i);return{changed:Object(n.k)(s,i).filter(s=>e[s]!==t[s]),added:a.added,removed:a.removed}}function l(e,t){const s=c(e,t);return Object(n.f)(s.removed,s.added,s.changed)}function d(e){return JSON.parse(JSON.stringify(e))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(85),h=s(447);let u=Object(d.a)("views.elements.InlineSpinner")((a=i=class extends l.a.PureComponent{render(){return l.a.createElement("div",{className:"mx_InlineSpinner"},l.a.createElement(h.a,{w:this.props.w,h:this.props.h,className:"mx_InlineSpinner_icon mx_Spinner_icon"}))}},r()(i,"defaultProps",{w:32,h:32}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a);class r extends o.a{constructor(...e){super(...e),i()(this,"toasts",[]),i()(this,"countSeen",0)}static sharedInstance(){return window.mxToastStore||(window.mxToastStore=new r),window.mxToastStore}reset(){this.toasts=[],this.countSeen=0}addOrReplaceToast(e){const t=this.toasts.findIndex(t=>t.key===e.key);if(-1===t){let t=this.toasts.length;for(;t>0&&this.toasts[t-1].priority<e.priority;)--t;this.toasts.splice(t,0,e)}else this.toasts[t]=e;this.emit("update")}dismissToast(e){this.toasts[0]&&this.toasts[0].key===e&&this.countSeen++;const t=this.toasts.length;this.toasts=this.toasts.filter(t=>t.key!==e),t!==this.toasts.length&&(0===this.toasts.length&&(this.countSeen=0),this.emit("update"))}getToasts(){return this.toasts}getCountSeen(){return this.countSeen}}},function(e,t,s){"use strict";function n(e,t){return function(e){const t=Object.keys(e),s=[];for(const n of t){const t=e[n];(Number.isFinite(t)||e[t.toString()]!==Number(n))&&s.push(t)}return s}(e).includes(t)}let i;s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return r})),function(e){e.Invite="im.vector.fake.invite",e.Untagged="im.vector.fake.recent",e.Archived="im.vector.fake.archived",e.LowPriority="m.lowpriority",e.Favourite="m.favourite",e.DM="im.vector.fake.direct",e.Unified="de.spiritcroc.fake.unified",e.ServerNotice="m.server_notice",e.Suggested="im.vector.fake.suggested"}(i||(i={}));const a=[i.Invite,i.Favourite,i.Unified,i.DM,i.Untagged,i.LowPriority,i.ServerNotice,i.Suggested,i.Archived];function o(e){return!n(i,e)}let r;!function(e){e.Timeline="TIMELINE",e.PossibleTagChange="POSSIBLE_TAG_CHANGE",e.ReadReceipt="READ_RECEIPT",e.NewRoom="NEW_ROOM",e.RoomRemoved="ROOM_REMOVED"}(r||(r={}))},,function(e,t,s){"use strict";s.r(t),function(e,n){s.d(t,"OLM_ALGORITHM",(function(){return l})),s.d(t,"MEGOLM_ALGORITHM",(function(){return d})),s.d(t,"MEGOLM_BACKUP_ALGORITHM",(function(){return h})),s.d(t,"encryptMessageForDevice",(function(){return u})),s.d(t,"getExistingOlmSessions",(function(){return m})),s.d(t,"ensureOlmSessionsForDevices",(function(){return p})),s.d(t,"verifySignature",(function(){return v})),s.d(t,"pkSign",(function(){return f})),s.d(t,"pkVerify",(function(){return b})),s.d(t,"encodeBase64",(function(){return y})),s.d(t,"encodeUnpaddedBase64",(function(){return E})),s.d(t,"decodeBase64",(function(){return S}));var i,a=s(346),o=s.n(a),r=s(1),c=s(4);!function(e){e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2"}(i||(i={}));const l=i.Olm,d=i.Megolm,h=i.MegolmBackup;async function u(e,t,s,n,i,a,o){const l=a.getIdentityKey(),d=await n.getSessionIdForDevice(l);if(null===d)return;r.a.log("Using sessionid "+d+" for device "+i+":"+a.deviceId);const h={sender:t,sender_device:s,keys:{ed25519:n.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:a.getFingerprint()}};c.q(h,o),e[l]=await n.encryptMessage(l,d,JSON.stringify(h))}async function m(e,t,s){const n={},i={},a=[];for(const[t,o]of Object.entries(s))for(const s of o){const o=s.deviceId,r=s.getIdentityKey();a.push((async()=>{const a=await e.getSessionIdForDevice(r,!0);null===a?(n[t]=n[t]||[],n[t].push(s)):(i[t]=i[t]||{},i[t][o]={device:s,sessionId:a})})())}return await Promise.all(a),[n,i]}async function p(e,t,s,n=!1,i,a,o=r.a){"number"==typeof n&&(o=a,a=i,i=n,n=!1);const c=[],l={},d={};for(const[,t]of Object.entries(s))for(const s of t){const t=s.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise(s=>{d[t]=n=>{delete e.sessionsInProgress[t],s(n)}})))}for(const[t,i]of Object.entries(s)){l[t]={};for(const s of i){const i=s.deviceId,a=s.getIdentityKey();if(a===e.deviceCurve25519Key){o.info("Attempted to start session with ourself! Ignoring"),l[t][i]={device:s,sessionId:null};continue}const r=`for ${a} (${t}:${i})`,h=await e.getSessionIdForDevice(a,!!d[a],o);null!==h&&d[a]&&d[a](),(null===h||n)&&(n?o.info("Forcing new Olm session "+r):o.info("Making new Olm session "+r),c.push([t,i])),l[t][i]={device:s,sessionId:h}}}if(0===c.length)return l;let h,u=`one-time keys for ${c.length} devices`;try{o.debug("Claiming "+u),h=await t.claimOneTimeKeys(c,"signed_curve25519",i),o.debug("Claimed "+u)}catch(e){for(const e of Object.values(d))e();throw o.log("Failed to claim "+u,e,c),e}a&&"failures"in h&&a.push(...Object.keys(h.failures));const m=h.one_time_keys||{},p=[];for(const[t,i]of Object.entries(s)){const s=m[t]||{};for(let a=0;a<i.length;a++){const r=i[a],c=r.deviceId,h=r.getIdentityKey();if(h===e.deviceCurve25519Key)continue;if(l[t][c].sessionId&&!n)continue;const u=s[c]||{};let m=null;for(const e in u)0===e.indexOf("signed_curve25519:")&&(m=u[e]);m?p.push(g(e,m,t,r).then(e=>{d[h]&&d[h](e),l[t][c].sessionId=e},e=>{throw d[h]&&d[h](),e})):(o.warn(`No one-time keys (alg=signed_curve25519) for device ${t}:${c}`),d[h]&&d[h]())}}return u=`Olm sessions for ${p.length} devices`,o.debug("Starting "+u),await Promise.all(p),o.debug("Started "+u),l}async function g(e,t,s,n){const i=n.deviceId;try{await v(e,t,s,i,n.getFingerprint())}catch(e){return r.a.error("Unable to verify signature on one-time key for device "+s+":"+i+":",e),null}let a;try{a=await e.createOutboundSession(n.getIdentityKey(),t.key)}catch(e){return r.a.error("Error starting olm session with device "+s+":"+i+": "+e),null}return r.a.log("Started new olm sessionid "+a+" for device "+s+":"+i),a}async function v(e,t,s,n,i){const a="ed25519:"+n,r=((t.signatures||{})[s]||{})[a];if(!r)throw Error("No signature");const c=Object.assign({},t);"unsigned"in c&&delete c.unsigned,delete c.signatures;const l=o.a.stringify(c);e.verifySignature(i,l,r)}function f(t,s,n,i){let a=!1;if(s instanceof Uint8Array){const t=new e.Olm.PkSigning;i=t.init_with_seed(s),s=t,a=!0}const r=t.signatures||{};delete t.signatures;const c=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=r[n]||{};return r[n]=e,e["ed25519:"+i]=s.sign(o.a.stringify(t))}finally{t.signatures=r,c&&(t.unsigned=c),a&&s.free()}}function b(t,s,n){const i="ed25519:"+s;if(!(t.signatures&&t.signatures[n]&&t.signatures[n][i]))throw new Error("No signature");const a=t.signatures[n][i],r=new e.Olm.Utility,c=t.signatures;delete t.signatures;const l=t.unsigned;t.unsigned&&delete t.unsigned;try{r.ed25519_verify(s,o.a.stringify(t),a)}finally{t.signatures=c,l&&(t.unsigned=l),r.free()}}function y(e){return n.from(e).toString("base64")}function E(e){return y(e).replace(/=+$/g,"")}function S(e){return n.from(e,"base64")}}.call(this,s(26),s(27).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return f}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(148),h=s.n(d),u=s(91),m=s.n(u),p=s(85),g=s(139);let v;!function(e){e[e.Natural=0]="Natural",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=3]="Top",e[e.Bottom=4]="Bottom"}(v||(v={}));let f=Object(p.a)("views.elements.Tooltip")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"tooltipContainer",void 0),r()(this,"tooltip",void 0),r()(this,"parent",void 0),r()(this,"renderTooltip",()=>{const e=this.updatePosition({});e.display=this.props.visible?"block":"none";const t=m()("mx_Tooltip",this.props.tooltipClassName,{mx_Tooltip_visible:this.props.visible,mx_Tooltip_invisible:!this.props.visible}),s=l.a.createElement("div",{className:t,style:e},l.a.createElement("div",{className:"mx_Tooltip_chevron"}),this.props.label);this.tooltip=h.a.render(s,this.tooltipContainer)})}componentDidMount(){this.tooltipContainer=document.createElement("div"),this.tooltipContainer.className="mx_Tooltip_wrapper",document.body.appendChild(this.tooltipContainer),window.addEventListener("scroll",this.renderTooltip,{passive:!0,capture:!0}),this.parent=h.a.findDOMNode(this).parentNode,this.renderTooltip()}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){h.a.unmountComponentAtNode(this.tooltipContainer),document.body.removeChild(this.tooltipContainer),window.removeEventListener("scroll",this.renderTooltip,{capture:!0})}updatePosition(e){const t=this.parent.getBoundingClientRect();let s=0;s=t.height>25?Math.floor((t.height-25)/2):Math.floor(t.height-25);const n=g.b.instance.windowWidth,i=t.top-2+this.props.yOffset+window.pageYOffset,a=i+s,o=n-t.right-window.pageXOffset-16,r=t.right+window.pageXOffset+6,c=t.right-window.pageXOffset-t.width/2;switch(this.props.alignment){case v.Natural:if(t.right>n/2){e.right=o,e.top=a;break}case v.Right:e.left=r,e.top=a;break;case v.Left:e.right=o,e.top=a;break;case v.Top:e.top=i-16,e.left=c;break;case v.Bottom:e.top=i+t.height,e.left=c}return e}render(){return l.a.createElement("div",{className:this.props.className})}},r()(i,"Alignment",v),r()(i,"defaultProps",{visible:!0,yOffset:0,alignment:v.Natural}),n=a))||n},function(e,t,s){"use strict";(function(e){s.d(t,"c",(function(){return B})),s.d(t,"b",(function(){return K})),s.d(t,"a",(function(){return W})),s.d(t,"d",(function(){return G}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(86),c=s(90),l=s(84),d=s(87),h=s(152),u=s(89),m=s(493),p=s(178),g=s(100),v=s(735),f=s(113),b=s(104),y=s(238),E=s(267),S=s(3),_=s(163),w=s(140),C=s(124),O=s(115),k=s(1),R=s(92),I=s(736),x=s(1284),T=s(197),j=s(5),N=s.n(j),P=s(93),D=s(141),M=s(196),A=s(250),U=s(154),L=s(737),F=s(146);const B="im.vector.is_virtual_room";var V;let K,W;!function(e){e.Ring="ringAudio",e.Ringback="ringbackAudio",e.CallEnd="callendAudio",e.Busy="busyAudio"}(V||(V={})),function(e){e.Voice="voice",e.Video="video"}(K||(K={})),function(e){e.CallsChanged="calls_changed",e.CallChangeRoom="call_change_room",e.SilencedCallsChanged="silenced_calls_changed"}(W||(W={}));class G extends N.a{constructor(...e){super(...e),i()(this,"calls",new Map),i()(this,"transferees",new Map),i()(this,"audioPromises",new Map),i()(this,"dispatcherRef",null),i()(this,"supportsPstnProtocol",null),i()(this,"pstnSupportPrefixed",null),i()(this,"supportsSipNativeVirtual",null),i()(this,"pstnSupportCheckTimer",void 0),i()(this,"invitedRoomsAreVirtual",new Map),i()(this,"invitedRoomCheckInProgress",!1),i()(this,"assertedIdentityNativeUsers",new Map),i()(this,"silencedCalls",new Set),i()(this,"onCallIncoming",e=>{d.a.dispatch({action:"incoming_call",call:e},!0)}),i()(this,"onCallStateChanged",(e,t,s)=>{if(!this.matchesCallForThisRoom(s))return;const n=this.roomIdForCall(s);switch(this.setCallState(s,e),t){case _.e.Ringing:this.pause(V.Ring);break;case _.e.InviteSent:this.pause(V.Ringback)}switch(e!==_.e.Ringing&&this.silencedCalls.delete(s.callId),e){case _.e.Ringing:{const e=new A.a(r.a.get()).getPushRuleById(M.d.IncomingCall),t=null==e?void 0:e.enabled,n=null==e?void 0:e.actions.some(e=>e.set_tweak===M.e.Sound&&"ring"===e.value);t&&n?this.play(V.Ring):this.silenceCall(s.callId);break}case _.e.InviteSent:this.play(V.Ringback);break;case _.e.Ended:{const e=s.hangupReason;if(w.a.trackEvent("voip","callEnded","hangupReason",e),this.removeCallForRoom(n),t===_.e.InviteSent&&s.hangupParty===_.d.Remote){if(this.play(V.Busy),!e||[_.b.UserHangup,"user hangup"].includes(e))break;let t,n;s.hangupReason===_.b.UserBusy?(t=Object(l.a)("User Busy"),n=Object(l.a)("The user you called is busy.")):(t=Object(l.a)("Call Failed"),n=Object(l.a)("The call could not be established")),c.a.createTrackedDialog("Call Handler","Call Failed",b.a,{title:t,description:n})}else e===_.b.AnsweredElsewhere&&t===_.e.Connecting?c.a.createTrackedDialog("Call Handler","Call Failed",b.a,{title:Object(l.a)("Answered Elsewhere"),description:Object(l.a)("The call was answered on another device.")}):t!==_.e.Fledgling&&t!==_.e.Ringing&&this.play(V.CallEnd);this.logCallStats(s,n);break}}}),i()(this,"onAction",e=>{switch(e.action){case"place_call":{if(Object(x.b)())return void Object(x.a)(e.room_id);if(!r.a.get().supportsVoip())return void c.a.createTrackedDialog("Call Handler","VoIP is unsupported",b.a,{title:Object(l.a)("VoIP is unsupported"),description:Object(l.a)("You cannot place VoIP calls in this browser.")});if(this.getAllActiveCalls().length>1)return void c.a.createTrackedDialog("Call Handler","Existing Call",b.a,{title:Object(l.a)("Too Many Calls"),description:Object(l.a)("You've reached the maximum number of simultaneous calls.")});const t=r.a.get().getRoom(e.room_id);if(!t)return void k.a.error(`Room ${e.room_id} does not exist.`);const s=t.getJoinedMembers();if(s.length<=1)return void c.a.createTrackedDialog("Call Handler","Cannot place call with self",b.a,{description:Object(l.a)("You cannot place a call with yourself.")});2===s.length?(k.a.info(`Place ${e.type} call in ${e.room_id}`),this.placeCall(e.room_id,e.type,e.transferee)):d.a.dispatch({action:"place_conference_call",room_id:e.room_id,type:e.type})}break;case"place_conference_call":k.a.info("Place conference call in "+e.room_id),w.a.trackEvent("voip","placeConferenceCall"),C.a.instance.trackStartCall(e.room_id,e.type===K.Video,!0),this.startCallApp(e.room_id,e.type);break;case"end_conference":k.a.info("Terminating conference call in "+e.room_id),this.terminateCallApp(e.room_id);break;case"hangup_conference":k.a.info("Leaving conference call in "+e.room_id),this.hangupCallApp(e.room_id);break;case"incoming_call":{if(!r.a.get().supportsVoip())return;const t=e.call,s=G.sharedInstance().roomIdForCall(t);if(this.getCallForRoom(s))return void k.a.log("Got incoming call for room "+s+" but there's already a call for this room: ignoring");w.a.trackEvent("voip","receiveCall","type",t.type),this.addCallForRoom(s,t),this.setCallListeners(t),this.onCallStateChanged(t.state,null,t);const n=r.a.get();n.prepareToEncrypt(n.getRoom(t.roomId))}break;case"hangup":case"reject":if(this.stopRingingIfPossible(this.calls.get(e.room_id).callId),!this.calls.get(e.room_id))return;"reject"===e.action?this.calls.get(e.room_id).reject():this.calls.get(e.room_id).hangup(_.b.UserHangup,!1);break;case"hangup_all":this.stopRingingIfPossible(this.calls.get(e.room_id).callId);for(const e of this.calls.values())e.hangup(_.b.UserHangup,!1);break;case"answer":{if(this.stopRingingIfPossible(this.calls.get(e.room_id).callId),!this.calls.has(e.room_id))return;if(this.getAllActiveCalls().length>1)return void c.a.createTrackedDialog("Call Handler","Existing Call",b.a,{title:Object(l.a)("Too Many Calls"),description:Object(l.a)("You've reached the maximum number of simultaneous calls.")});const t=this.calls.get(e.room_id);t.answer(),this.setActiveCallRoomId(e.room_id),C.a.instance.trackJoinCall(e.room_id,t.type===_.f.Video,!1),d.a.dispatch({action:R.a.ViewRoom,room_id:e.room_id});break}case R.a.DialNumber:this.dialNumber(e.number);break;case R.a.TransferCallToMatrixID:this.startTransferToMatrixID(e.call,e.destination,e.consultFirst);break;case R.a.TransferCallToPhoneNumber:this.startTransferToPhoneNumber(e.call,e.destination,e.consultFirst)}})}static sharedInstance(){return window.mxCallHandler||(window.mxCallHandler=new G),window.mxCallHandler}roomIdForCall(e){if(!e)return null;const t=P.a.get().voip;if(t&&t.obeyAssertedIdentity){const t=this.assertedIdentityNativeUsers[e.callId];if(t){const e=Object(D.e)(r.a.get(),t);if(e)return e.roomId}}return I.a.sharedInstance().nativeRoomForVirtualRoom(e.roomId)||e.roomId}start(){this.dispatcherRef=d.a.register(this.onAction),navigator.mediaSession&&(navigator.mediaSession.setActionHandler("play",(function(){})),navigator.mediaSession.setActionHandler("pause",(function(){})),navigator.mediaSession.setActionHandler("seekbackward",(function(){})),navigator.mediaSession.setActionHandler("seekforward",(function(){})),navigator.mediaSession.setActionHandler("previoustrack",(function(){})),navigator.mediaSession.setActionHandler("nexttrack",(function(){}))),u.b.getValue(O.b.Voip)&&r.a.get().on("Call.incoming",this.onCallIncoming),this.checkProtocols(3)}stop(){const e=r.a.get();e&&e.removeListener("Call.incoming",this.onCallIncoming),null!==this.dispatcherRef&&(d.a.unregister(this.dispatcherRef),this.dispatcherRef=null)}silenceCall(e){this.silencedCalls.add(e),this.emit(W.SilencedCallsChanged,this.silencedCalls),this.areAnyCallsUnsilenced()||this.pause(V.Ring)}unSilenceCall(e){this.silencedCalls.delete(e),this.emit(W.SilencedCallsChanged,this.silencedCalls),this.play(V.Ring)}isCallSilenced(e){return this.silencedCalls.has(e)}areAnyCallsUnsilenced(){for(const e of this.calls.values())if(e.state===_.e.Ringing&&!this.isCallSilenced(e.callId))return!0;return!1}async checkProtocols(e){try{const e=await r.a.get().getThirdpartyProtocols();void 0!==e["m.protocol.pstn"]?(this.supportsPstnProtocol=Boolean(e["m.protocol.pstn"]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!1)):void 0!==e["im.vector.protocol.pstn"]?(this.supportsPstnProtocol=Boolean(e["im.vector.protocol.pstn"]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!0)):this.supportsPstnProtocol=null,d.a.dispatch({action:R.a.PstnSupportUpdated}),void 0!==e["im.vector.protocol.sip_native"]&&void 0!==e["im.vector.protocol.sip_virtual"]&&(this.supportsSipNativeVirtual=Boolean(e["im.vector.protocol.sip_native"]&&e["im.vector.protocol.sip_virtual"])),d.a.dispatch({action:R.a.VirtualRoomSupportUpdated})}catch(t){1===e?k.a.log("Failed to check for protocol support and no retries remain: assuming no support",t):(k.a.log("Failed to check for protocol support: will retry",t),this.pstnSupportCheckTimer=setTimeout(()=>{this.checkProtocols(e-1)},1e4))}}getSupportsPstnProtocol(){return this.supportsPstnProtocol}getSupportsVirtualRooms(){return this.supportsSipNativeVirtual}pstnLookup(e){return r.a.get().getThirdpartyUser(this.pstnSupportPrefixed?"im.vector.protocol.pstn":"m.protocol.pstn",{"m.id.phone":e})}sipVirtualLookup(e){return r.a.get().getThirdpartyUser("im.vector.protocol.sip_virtual",{native_mxid:e})}sipNativeLookup(e){return r.a.get().getThirdpartyUser("im.vector.protocol.sip_native",{virtual_mxid:e})}getCallById(e){for(const t of this.calls.values())if(t.callId===e)return t;return null}getCallForRoom(e){return this.calls.get(e)||null}getAnyActiveCall(){for(const e of this.calls.values())if(e.state!==_.e.Ended)return e;return null}getAllActiveCalls(){const e=[];for(const t of this.calls.values())t.state!==_.e.Ended&&t.state!==_.e.Ringing&&e.push(t);return e}getAllActiveCallsNotInRoom(e){const t=[];for(const[s,n]of this.calls.entries())s!==e&&n.state!==_.e.Ended&&t.push(n);return t}getAllActiveCallsForPip(e){const t=r.a.get().getRoom(e);return U.d.instance.hasMaximisedWidget(t)?this.getAllActiveCalls():this.getAllActiveCallsNotInRoom(e)}getTransfereeForCallId(e){return this.transferees[e]}play(e){const t=document.getElementById(e);if(t){const s=async()=>{try{await t.play()}catch(e){k.a.log("Unable to play audio clip",e)}};this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>(t.load(),s()))):this.audioPromises.set(e,s())}}pause(e){const t=document.getElementById(e);t&&(this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>t.pause())):t.pause())}matchesCallForThisRoom(e){const t=this.roomIdForCall(e),s=this.getCallForRoom(t);return s&&e.callId===s.callId}setCallListeners(e){let t=this.roomIdForCall(e);e.on(_.c.Error,t=>{this.matchesCallForThisRoom(e)&&(w.a.trackEvent("voip","callError","error",t.toString()),k.a.error("Call error:",t),t.code!==_.b.NoUserMedia?0!==r.a.get().getTurnServers().length||null!==u.b.getValue("fallbackICEServerAllowed")?c.a.createTrackedDialog("Call Failed","",b.a,{title:Object(l.a)("Call Failed"),description:t.message}):this.showICEFallbackPrompt():this.showMediaCaptureError(e))}),e.on(_.c.Hangup,()=>{this.matchesCallForThisRoom(e)&&(w.a.trackEvent("voip","callHangup"),this.removeCallForRoom(t))}),e.on(_.c.State,(t,s)=>{this.onCallStateChanged(t,s,e)}),e.on(_.c.Replaced,s=>{this.matchesCallForThisRoom(e)&&(k.a.log(`Call ID ${e.callId} is being replaced by call ID ${s.callId}`),e.state===_.e.Ringing?this.pause(V.Ring):e.state===_.e.InviteSent&&this.pause(V.Ringback),this.removeCallForRoom(t),this.addCallForRoom(t,s),this.setCallListeners(s),this.setCallState(s,s.state))}),e.on(_.c.AssertedIdentityChanged,async()=>{if(!this.matchesCallForThisRoom(e))return;k.a.log(`Call ID ${e.callId} got new asserted identity:`,e.getRemoteAssertedIdentity());const s=e.getRemoteAssertedIdentity().id;let n=s;if(s){const e=await this.sipNativeLookup(s);e.length&&e[0].fields.lookup_success&&(n=e[0].userid)}if(k.a.log(`Asserted identity ${s} mapped to ${n}`),n){this.assertedIdentityNativeUsers[e.callId]=n,await Object(D.c)(r.a.get(),n);const s=this.roomIdForCall(e);k.a.log(`Old room ID: ${t}, new room ID: ${s}`),s!==t&&(this.removeCallForRoom(t),t=s,k.a.log("Moving call to room "+t),this.addCallForRoom(t,e,!0))}})}async logCallStats(e,t){const s=await e.getCurrentCallStats();if(k.a.debug(`Call completed. Call ID: ${e.callId}, virtual room ID: ${e.roomId}, user-facing room ID: ${t}, direction: ${e.direction}, our Party ID: ${e.ourPartyId}, hangup party: ${e.hangupParty}, hangup reason: `+e.hangupReason),s){k.a.debug("Local candidates:");for(const e of s.filter(e=>"local-candidate"===e.type)){const t=e.address||e.ip;k.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: ${e.protocol}, relay protocol: ${e.relayProtocol}, network type: ${e.networkType}`)}k.a.debug("Remote candidates:");for(const e of s.filter(e=>"remote-candidate"===e.type)){const t=e.address||e.ip;k.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: `+e.protocol)}k.a.debug("Candidate pairs:");for(const e of s.filter(e=>"candidate-pair"===e.type))k.a.debug(`${e.localCandidateId} / ${e.remoteCandidateId} - state: ${e.state}, nominated: ${e.nominated}, requests sent ${e.requestsSent}, requests received  ${e.requestsReceived},  responses received: ${e.responsesReceived}, responses sent: ${e.responsesSent}, bytes received: ${e.bytesReceived}, bytes sent: ${e.bytesSent}, `)}else k.a.debug("Call statistics are undefined. The call has probably failed before a peerConn was established")}setCallState(e,t){const s=G.sharedInstance().roomIdForCall(e);k.a.log(`Call state in ${s} changed to ${t}`);const n=Object(L.b)(e.callId);t===_.e.Ringing?F.a.sharedInstance().addOrReplaceToast({key:n,priority:100,component:L.a,bodyClassName:"mx_IncomingCallToast",props:{call:e}}):F.a.sharedInstance().dismissToast(n),d.a.dispatch({action:"call_state",room_id:s,state:t})}removeCallForRoom(e){k.a.log("Removing call for room ",e),this.calls.delete(e),this.emit(W.CallsChanged,this.calls)}showICEFallbackPrompt(){const e=r.a.get(),t=e=>o.a.createElement("code",null,e);c.a.createTrackedDialog("No TURN servers","",f.a,{title:Object(l.a)("Call failed due to misconfigured server"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(l.a)("Please ask the administrator of your homeserver (<code>%(homeserverDomain)s</code>) to configure a TURN server in order for calls to work reliably.",{homeserverDomain:e.getDomain()},{code:t})),o.a.createElement("p",null,Object(l.a)("Alternatively, you can try to use the public server at <code>turn.matrix.org</code>, but this will not be as reliable, and it will share your IP address with that server. You can also manage this in Settings.",null,{code:t}))),button:Object(l.a)("Try using turn.matrix.org"),cancelButton:Object(l.a)("OK"),onFinished:t=>{u.b.setValue("fallbackICEServerAllowed",null,g.a.DEVICE,t),e.setFallbackICEServerAllowed(t)}},null,!0)}showMediaCaptureError(e){let t,s;e.type===_.f.Voice?(t=Object(l.a)("Unable to access microphone"),s=o.a.createElement("div",null,Object(l.a)("Call failed because microphone could not be accessed. Check that a microphone is plugged in and set up correctly."))):e.type===_.f.Video&&(t=Object(l.a)("Unable to access webcam / microphone"),s=o.a.createElement("div",null,Object(l.a)("Call failed because webcam or microphone could not be accessed. Check that:"),o.a.createElement("ul",null,o.a.createElement("li",null,Object(l.a)("A microphone and webcam are plugged in and set up correctly")),o.a.createElement("li",null,Object(l.a)("Permission is granted to use the webcam")),o.a.createElement("li",null,Object(l.a)("No other application is using the webcam"))))),c.a.createTrackedDialog("Media capture failed","",b.a,{title:t,description:s},null,!0)}async placeCall(e,t,s){w.a.trackEvent("voip","placeCall","type",t),C.a.instance.trackStartCall(e,t===K.Video,!1);const n=await I.a.sharedInstance().getOrCreateVirtualRoomForRoom(e)||e;k.a.debug("Mapped real room "+e+" to room ID "+n);const i=r.a.get().getTurnServersExpiry()-Date.now();k.a.log("Current turn creds expire in "+i+" ms");const a=r.a.get().createCall(n);try{this.addCallForRoom(e,a)}catch(e){return void c.a.createTrackedDialog("Call Handler","Existing Call with user",b.a,{title:Object(l.a)("Already in call"),description:Object(l.a)("You're already in a call with this person.")})}s&&(this.transferees[a.callId]=s),this.setCallListeners(a),this.setActiveCallRoomId(e),t===K.Voice?a.placeVoiceCall():"video"===t?a.placeVideoCall():k.a.error("Unknown conf call type: "+t)}stopRingingIfPossible(e){this.silencedCalls.delete(e),this.areAnyCallsUnsilenced()||this.pause(V.Ring)}async dialNumber(e){const t=await this.pstnLookup(e);if(!t||0===t.length||!t[0].userid)return void c.a.createTrackedDialog("","",b.a,{title:Object(l.a)("Unable to look up phone number"),description:Object(l.a)("There was an error looking up the phone number")});const s=t[0].userid;let n;if(this.getSupportsVirtualRooms()){const t=await this.sipNativeLookup(s);n=t.length>0&&t[0].fields.lookup_success?t[0].userid:s,k.a.log("Looked up "+e+" to "+s+" and mapped to native user "+n)}else n=s;const i=await Object(D.c)(r.a.get(),n);d.a.dispatch({action:R.a.ViewRoom,room_id:i}),await this.placeCall(i,K.Voice,null)}async startTransferToPhoneNumber(e,t,s){const n=await this.pstnLookup(t);n&&0!==n.length&&n[0].userid?await this.startTransferToMatrixID(e,n[0].userid,s):c.a.createTrackedDialog("","",b.a,{title:Object(l.a)("Unable to transfer call"),description:Object(l.a)("There was an error looking up the phone number")})}async startTransferToMatrixID(e,t,s){if(s){const s=await Object(D.c)(r.a.get(),t);d.a.dispatch({action:"place_call",type:e.type,room_id:s,transferee:e}),d.a.dispatch({action:R.a.ViewRoom,room_id:s,should_peek:!1,joining:!1})}else try{await e.transfer(t)}catch(e){k.a.log("Failed to transfer call",e),c.a.createTrackedDialog("Failed to transfer call","",b.a,{title:Object(l.a)("Transfer Failed"),description:Object(l.a)("Failed to transfer call")})}}setActiveCallRoomId(e){k.a.info("Setting call in room "+e+" active");for(const[t,s]of this.calls.entries())s.state!==_.e.Ended&&(t===e?s.setRemoteOnHold(!1):(k.a.info("Holding call in room "+t+" because another call is being set active"),s.setRemoteOnHold(!0)))}hasAnyUnheldCall(){for(const e of this.calls.values())if(e.state!==_.e.Ended&&!e.isRemoteOnHold())return!0;return!1}async startCallApp(t,s){d.a.dispatch({action:"appsDrawer",show:!0});const n=r.a.get().getRoom(t),i=y.a.instance.getApps(t).find(e=>p.a.JITSI.matches(e.type));if(i)return void U.d.instance.moveToContainer(n,i,U.a.Top);const a=m.a.getInstance().preferredDomain,o=await m.a.getInstance().getJitsiAuth();let u;if("openidtoken-jwt"===o)u=v.base32.stringify(e.from(t),{pad:!1});else{u="Jitsi"+(Object(T.c)(1)+Object(T.a)(23))}let g=h.a.getLocalJitsiWrapperUrl({auth:o});const f=new URL(g);f.search="",f.searchParams.set("confId",u),g=f.toString();const E={conferenceId:u,isAudioOnly:"voice"===s,domain:a,auth:o,roomName:n.name},S="jitsi_"+r.a.get().credentials.userId+"_"+Date.now();h.a.setRoomWidget(t,S,p.a.JITSI,g,"Jitsi",E).then(()=>{k.a.log("Jitsi widget added")}).catch(e=>{"M_FORBIDDEN"===e.errcode&&c.a.createTrackedDialog("Call Failed","",b.a,{title:Object(l.a)("Permission Required"),description:Object(l.a)("You do not have permission to start a conference call in this room")}),k.a.error(e)})}terminateCallApp(e){c.a.createTrackedDialog("Confirm Jitsi Terminate","",f.a,{hasCancelButton:!0,title:Object(l.a)("End conference"),description:Object(l.a)("This will end the conference for everyone. Continue?"),button:Object(l.a)("End conference"),onFinished:t=>{if(!t)return;y.a.instance.getRoom(e).widgets.filter(e=>p.a.JITSI.matches(e.type)).forEach(t=>{h.a.setRoomWidget(e,t.id)})}})}hangupCallApp(e){const t=y.a.instance.getRoom(e);if(!t)return;t.widgets.filter(e=>p.a.JITSI.matches(e.type)).forEach(e=>{const t=E.a.instance.getMessagingForId(e.id);t&&t.transport.send(S.a.HangupCall,{})})}addCallForRoom(e,t,s=!1){if(this.calls.has(e))throw k.a.log(`Couldn't add call to room ${e}: already have a call for this room`),new Error("Already have a call for room "+e);k.a.log("setting call for room "+e),this.calls.set(e,t),s?this.emit(W.CallChangeRoom,t):this.emit(W.CallsChanged,this.calls)}}}).call(this,s(27).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(189),i=s(153),a=s(86),o=s(93),r=s(87),c=s(308),l=s(89),d=s(201),h=s(178),u=s(144),m=s(84),p=s(1);class g{static canUserModifyWidgets(e){if(!e)return p.a.warn("No room ID specified"),!1;const t=a.a.get();if(!t)return p.a.warn("User must be be logged in"),!1;const s=t.getRoom(e);if(!s)return p.a.warn(`Room ID ${e} is not recognised`),!1;const n=t.credentials.userId;return n?"join"!==s.getMyMembership()?(p.a.warn(`User ${n} is not in room ${e}`),!1):s.currentState.maySendStateEvent("im.vector.modular.widgets",n):(p.a.warn("Failed to get user ID"),!1)}static isScalarUrl(e){if(!e)return p.a.error("Scalar URL check failed. No URL specified"),!1;const t=n.parse(e);let s=o.a.get().integrations_widgets_urls;if(!s||0===s.length){const e=d.a.sharedInstance().getPrimaryManager();s=e?[e.apiUrl]:[]}for(let e=0;e<s.length;e++){const i=n.parse(s[e]);if(t&&i&&t.protocol===i.protocol&&t.host===i.host&&t.pathname.startsWith(i.pathname))return!0}return!1}static waitForUserWidget(e,t){return new Promise((s,n)=>{function i(s){return!(!s||!s.getContent())&&(t?void 0!==s.getContent()[e]:void 0===s.getContent()[e])}if(i(a.a.get().getAccountData("m.widgets")))return void s();function o(e){i(a.a.get().getAccountData("m.widgets"))&&(a.a.get().removeListener("accountData",o),clearTimeout(r),s())}const r=setTimeout(()=>{a.a.get().removeListener("accountData",o),n(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);a.a.get().on("accountData",o)})}static waitForRoomWidget(e,t,s){return new Promise((n,i)=>{function o(t){const n=t.some(t=>t.getContent()&&t.getContent().id===e);return s?n:!n}const r=a.a.get().getRoom(t);if(o(r.currentState.getStateEvents("im.vector.modular.widgets")))return void n();function c(e){if(e.getRoomId()!==t)return;o(r.currentState.getStateEvents("im.vector.modular.widgets"))&&(a.a.get().removeListener("RoomState.events",c),clearTimeout(l),n())}const l=setTimeout(()=>{a.a.get().removeListener("RoomState.events",c),i(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);a.a.get().on("RoomState.events",c)})}static setUserWidget(e,t,s,n,i){const o={type:t.preferred,url:s,name:n,data:i},c=a.a.get(),l=Object(u.a)(g.getUserWidgets());try{delete l[e]}catch(e){p.a.error("$widgetId is non-configurable")}const d=Boolean(s);return d&&(l[e]={content:o,sender:c.getUserId(),state_key:e,type:"m.widget",id:e}),c.setAccountData("m.widgets",l).then(()=>g.waitForUserWidget(e,d)).then(()=>{r.a.dispatch({action:"user_widget_updated"})})}static setRoomWidget(e,t,s,n,i,a){let o;return o=Boolean(n)?{type:s.legacy,url:n,name:i,data:a}:{},g.setRoomWidgetContent(e,t,o)}static setRoomWidgetContent(e,t,s){const n=!!s.url;c.a.setRoomWidgetEcho(e,t,s);return a.a.get().sendStateEvent(e,"im.vector.modular.widgets",s,t).then(()=>g.waitForRoomWidget(t,e,n)).finally(()=>{c.a.removeRoomWidgetEcho(e,t)})}static getRoomWidgets(e){const t=e.currentState.getStateEvents("im.vector.modular.widgets");return t?t.filter(e=>e.getContent().type&&e.getContent().url):[]}static getUserWidgets(){const e=a.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");return t&&t.getContent()?t.getContent():{}}static getUserWidgetsArray(){return Object.values(g.getUserWidgets())}static getStickerpickerWidgets(){return g.getUserWidgetsArray().filter(e=>e.content&&"m.stickerpicker"===e.content.type)}static getIntegrationManagerWidgets(){return g.getUserWidgetsArray().filter(e=>e.content&&"m.integration_manager"===e.content.type)}static getRoomWidgetsOfType(e,t){return(g.getRoomWidgets(e)||[]).filter(e=>{const s=e.getContent();return s.url&&t.matches(s.type)})}static async removeIntegrationManagerWidgets(){const e=a.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};Object.entries(s).forEach(([e,t])=>{t.content&&"m.integration_manager"===t.content.type&&delete s[e]}),await e.setAccountData("m.widgets",s)}static addIntegrationManagerWidget(e,t,s){return g.setUserWidget("integration_manager_"+(new Date).getTime(),h.a.INTEGRATION_MANAGER,t,"Integration manager: "+e,{api_url:s})}static async removeStickerpickerWidgets(){const e=a.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};Object.entries(s).forEach(([e,t])=>{t.content&&"m.stickerpicker"===t.content.type&&delete s[e]}),await e.setAccountData("m.widgets",s)}static makeAppConfig(e,t,s,n,i){if(!s)throw new Error("Widgets must be created by someone - provide a senderUserId");return t.creatorUserId=s,t.id=e,t.roomId=n,t.eventId=i,t.name=t.name||t.type,t}static getCapWhitelistForAppTypeInRoomId(e,t){const s=l.b.getValue("enableWidgetScreenshots",t)?[i.MatrixCapabilities.Screenshots]:[];return h.a.JITSI.matches(e)&&s.push(i.MatrixCapabilities.AlwaysOnScreen),s}static getLocalJitsiWrapperUrl(e={}){const t=["conferenceDomain=$domain","conferenceId=$conferenceId","isAudioOnly=$isAudioOnly","displayName=$matrix_display_name","avatarUrl=$matrix_avatar_url","userId=$matrix_user_id","roomId=$matrix_room_id","theme=$theme","roomName=$roomName"];e.auth&&t.push("auth="+e.auth);const s=t.join("&");let n=window.location.href;"https:"===window.location.protocol||e.forLocalRender||(n="https://app.element.io/");return new URL("jitsi.html#"+s,n).href}static getWidgetName(e){var t;return(null==e||null===(t=e.name)||void 0===t?void 0:t.trim())||Object(m.a)("Unknown App")}static getWidgetDataTitle(e){var t,s;return(null==e||null===(t=e.data)||void 0===t||null===(s=t.title)||void 0===s?void 0:s.trim())||""}static editWidget(e,t){l.b.getValue("feature_many_integration_managers")?d.a.sharedInstance().openAll(e,"type_"+t.type,t.id):d.a.sharedInstance().getPrimaryManager().open(e,"type_"+t.type,t.id)}static isManagedByManager(e){if(g.isScalarUrl(e.url)){const e=d.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();return g.isScalarUrl(t.apiUrl)}}return!1}}},,function(e,t,s){"use strict";s.d(t,"c",(function(){return f})),s.d(t,"a",(function(){return b})),s.d(t,"b",(function(){return y})),s.d(t,"d",(function(){return E}));var n=s(83),i=s.n(n),a=s(89),o=s(238),r=s(178),c=s(233),l=s(87),d=s(654),h=s(100),u=s(116),m=s(123),p=s(143);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const f="io.element.widgets.layout";let b;!function(e){e.Top="top",e.Right="right",e.Center="center"}(b||(b={}));const y=3;class E extends d.a{constructor(){super(l.a),i()(this,"byRoom",{}),i()(this,"pinnedRef",void 0),i()(this,"layoutRef",void 0),i()(this,"updateAllRooms",()=>{this.byRoom={};for(const e of this.matrixClient.getVisibleRooms())this.recalculateRoom(e)}),i()(this,"updateFromWidgetStore",e=>{if(e){const t=this.matrixClient.getRoom(e);t&&this.recalculateRoom(t)}else this.updateAllRooms()}),i()(this,"updateRoomFromState",e=>{if(e.getType()!==f)return;const t=this.matrixClient.getRoom(e.getRoomId());t&&this.recalculateRoom(t)}),i()(this,"updateFromSettings",(e,t)=>{if(t){const e=this.matrixClient.getRoom(t);e&&this.recalculateRoom(e)}else this.updateAllRooms()})}static get instance(){return E.internalInstance||(E.internalInstance=new E),E.internalInstance}static emissionForRoom(e){return"update_"+e.roomId}emitFor(e){this.emit(E.emissionForRoom(e))}async onReady(){this.updateAllRooms(),this.matrixClient.on("RoomState.events",this.updateRoomFromState),this.pinnedRef=a.b.watchSetting("Widgets.pinned",null,this.updateFromSettings),this.layoutRef=a.b.watchSetting("Widgets.layout",null,this.updateFromSettings),o.a.instance.on(m.b,this.updateFromWidgetStore)}async onNotReady(){this.byRoom={},a.b.unwatchSetting(this.pinnedRef),a.b.unwatchSetting(this.layoutRef),o.a.instance.off(m.b,this.updateFromWidgetStore)}recalculateRoom(e){const t=o.a.instance.getApps(e.roomId);if(null==t||!t.length)return this.byRoom[e.roomId]={},void this.emitFor(e);const s=JSON.stringify(this.byRoom[e.roomId]),n=e.currentState.getStateEvents(f,""),i=a.b.getValue("Widgets.pinned",e.roomId);let l=a.b.getValue("Widgets.layout",e.roomId);n&&l&&l.overrides!==n.getId()&&(l=null);const d=n?n.getContent():null,h=[],u=[],m=[];for(const e of t){var g,v,E,S,_;const t=null==d||null===(g=d.widgets)||void 0===g||null===(v=g[e.id])||void 0===v?void 0:v.container,s=null===(E=l)||void 0===E||null===(S=E.widgets)||void 0===S||null===(_=S[e.id])||void 0===_?void 0:_.container,n=!(null==i||!i[e.id]),a=r.a.JITSI.matches(e.type)?b.Top:b.Right;if(s?s===b.Center:t===b.Center){m.length?console.error("Tried to push a second widget into the center container"):m.push(e);continue}let o=a;s||t?o=s||t:n&&!t&&(o=b.Top),(o===b.Top?h:u).push(e)}const w=h.slice(y);u.push(...w),h.sort((e,t)=>{var s,n,i,a,o,h;const u=null==d||null===(s=d.widgets)||void 0===s?void 0:s[e.id],m=null==d||null===(n=d.widgets)||void 0===n?void 0:n[t.id],g=null===(i=l)||void 0===i||null===(a=i.widgets)||void 0===a?void 0:a[e.id],v=null===(o=l)||void 0===o||null===(h=o.widgets)||void 0===h?void 0:h[t.id],f=r.a.JITSI.matches(e.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,b=r.a.JITSI.matches(t.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,y=Object(c.b)(null==g?void 0:g.index,Object(c.b)(null==u?void 0:u.index,f)),E=Object(c.b)(null==v?void 0:v.index,Object(c.b)(null==m?void 0:m.index,b));return y===E?Object(p.a)(e.id,t.id):y-E});const C=[];let O=null,k=!0;for(let e=0;e<h.length;e++){var R,I,x;const t=h[e],s=null==d||null===(R=d.widgets)||void 0===R?void 0:R[t.id],n=null===(I=l)||void 0===I||null===(x=I.widgets)||void 0===x?void 0:x[t.id];if(Number.isFinite(null==n?void 0:n.width)||Number.isFinite(null==s?void 0:s.width)){const e=(null==n?void 0:n.width)||(null==s?void 0:s.width),t=Object(c.a)(e,10,100);C.push(t),k=!1}else C.push(100);if(null!=s&&s.height||null!=n&&n.height){const e=Object(c.b)(null==s?void 0:s.height,2),t=Object(c.b)(null==n?void 0:n.height,e);O=Math.max(O,Object(c.a)(t,2,100))}}if(k)for(let e=0;e<C.length;e++)C[e]=100/C.length;else{const e=Object(c.e)(...C)-100;if(e<0)for(let t=0;t<C.length;t++)C[t]+=Math.abs(e)/C.length;else if(e>0){for(let t=0;t<C.length;t++)C[t]=Object(c.a)(C[t]-e/C.length,10,100);const t=Object(c.e)(...C)-100;if(t>0){const e=C.map((e,t)=>[t,e]).filter(e=>e[1]>10).map(e=>e[0]);for(const s of e)C[s]-=t/e.length}}}this.byRoom[e.roomId]={},h.length&&(this.byRoom[e.roomId][b.Top]={ordered:h,distributions:C,height:O}),u.length&&(this.byRoom[e.roomId][b.Right]={ordered:u}),m.length&&(this.byRoom[e.roomId][b.Center]={ordered:m});JSON.stringify(this.byRoom[e.roomId])!==s&&this.emitFor(e)}getContainerWidgets(e,t){var s,n;return(null===(s=this.byRoom[null==e?void 0:e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.ordered)||[]}isInContainer(e,t,s){return this.getContainerWidgets(e,s).some(e=>e.id===t.id)}canAddToContainer(e,t){switch(t){case b.Top:case b.Right:return this.getContainerWidgets(e,t).length<y;case b.Center:return this.getContainerWidgets(e,t).length<1}}getResizerDistributions(e,t){var s,n;let i=null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.distributions;return!i||i.length<2?[]:(2===i.length&&(i=[i[0]]),3===i.length&&(i=[i[0],i[2]]),i.map(e=>e.toFixed(1)+"%"))}setResizerDistributions(e,t,s){if(t!==b.Top)return;const n=s.map(e=>Number(Number(e.substring(0,e.length-1)).toFixed(1))),i=this.getContainerWidgets(e,t),a=100-Object(c.e)(...n);2===n.length&&n.splice(1,0,a),1===n.length&&n.push(a);const o={};i.forEach((s,i)=>{var a,r;o[s.id]={container:t,width:n[i],index:i,height:(null===(a=this.byRoom[e.roomId])||void 0===a||null===(r=a[t])||void 0===r?void 0:r.height)||2}}),this.updateUserLayout(e,o)}getContainerHeight(e,t){var s,n;return null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.height}setContainerHeight(e,t,s){var n,i;const a=this.getContainerWidgets(e,t),o=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[t])||void 0===i?void 0:i.distributions,r={};a.forEach((e,n)=>{r[e.id]={container:t,width:o[n],index:n,height:s}}),this.updateUserLayout(e,r)}moveWithinContainer(e,t,s,n){var i,a,o,r;const l=Object(u.b)(this.getContainerWidgets(e,t)),d=l.findIndex(e=>e.id===s.id);if(d<0)return;l.splice(d,1);const h=Object(c.a)(d+n,0,l.length);l.splice(h,0,s);const m=null===(i=this.byRoom[e.roomId])||void 0===i||null===(a=i[t])||void 0===a?void 0:a.distributions,p=null===(o=this.byRoom[e.roomId])||void 0===o||null===(r=o[t])||void 0===r?void 0:r.height,g={};l.forEach((e,s)=>{g[e.id]={container:t,width:m[s],index:s,height:p}}),this.updateUserLayout(e,g)}moveToContainer(e,t,s){if(this.getAllWidgets(e).some(([e])=>e.id===t.id)){switch(s){case b.Right:break;case b.Center:for(const t of this.getContainerWidgets(e,b.Top))this.moveToContainer(e,t,b.Right);for(const t of this.getContainerWidgets(e,b.Center))this.moveToContainer(e,t,b.Right);break;case b.Top:this.hasMaximisedWidget(e)&&this.moveToContainer(e,this.getContainerWidgets(e,b.Center)[0],b.Right)}this.updateUserLayout(e,{[t.id]:{container:s}})}}hasMaximisedWidget(e){return this.getContainerWidgets(e,b.Center).length>0}hasPinnedWidgets(e){return this.getContainerWidgets(e,b.Top).length>0}canCopyLayoutToRoom(e){return!!this.matrixClient&&e.currentState.maySendStateEvent(f,this.matrixClient.getUserId())}copyLayoutToRoom(e){const t=this.getAllWidgets(e),s={widgets:{}};for(const[r,c]of t)if(s.widgets[r.id]={container:c},c===b.Top){var n,i,a,o;const t=this.getContainerWidgets(e,c).findIndex(e=>e.id===r.id),l=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[c])||void 0===i?void 0:i.distributions,d=null===(a=this.byRoom[e.roomId])||void 0===a||null===(o=a[c])||void 0===o?void 0:o.height;s.widgets[r.id]=v(v({},s.widgets[r.id]),{},{height:d?Math.round(d):null,width:l[t]?Math.round(l[t]):null,index:t})}this.matrixClient.sendStateEvent(e.roomId,f,s,"")}getAllWidgets(e){const t=this.byRoom[e.roomId];if(!t)return[];const s=[];for(const e of Object.keys(t)){const n=t[e].ordered;for(const t of n)s.push([t,e])}return s}updateUserLayout(e,t){const s=this.getAllWidgets(e);for(const[a,c]of s){var n,i;const s=this.getContainerWidgets(e,c).findIndex(e=>e.id===a.id),l=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[c])||void 0===i?void 0:i.distributions;var o,r;if(!t[a.id])t[a.id]={container:c,index:s,height:null===(o=this.byRoom[e.roomId])||void 0===o||null===(r=o[c])||void 0===r?void 0:r.height,width:null==l?void 0:l[s]}}const c=e.currentState.getStateEvents(f,"");a.b.setValue("Widgets.layout",e.roomId,h.a.ROOM_ACCOUNT,{overrides:null==c?void 0:c.getId(),widgets:t}).catch(()=>this.recalculateRoom(e)),this.recalculateRoom(e)}}i()(E,"internalInstance",void 0),window.mxWidgetLayoutStore=E.instance},function(e,t,s){"use strict";s.d(t,"e",(function(){return _})),s.d(t,"c",(function(){return w})),s.d(t,"f",(function(){return C})),s.d(t,"d",(function(){return c})),s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return v.a}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(108);const c=({children:e,inputRef:t})=>{const[s,n,i]=C(t);return e({onFocus:s,isActive:n,ref:i})};var l=s(95),d=s.n(l),h=s(102),u=s.n(h),m=s(88);const p=["inputRef"],g=e=>{let{inputRef:t}=e,s=u()(e,p);const[n,i,a]=C(t);return o.a.createElement(m.a,d()({},s,{onFocus:n,inputRef:a,tabIndex:i?0:-1}))};var v=s(512);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const y=Object(a.createContext)({state:{activeRef:null,refs:[]},dispatch:()=>{}});let E;y.displayName="RovingTabIndexContext",function(e){e.Register="REGISTER",e.Unregister="UNREGISTER",e.SetFocus="SET_FOCUS"}(E||(E={}));const S=(e,t)=>{switch(t.type){case E.Register:{let s=0,n=e.refs.length-1,i=e.refs.length;for(;s<=n;){i=Math.floor((s+n)/2);const a=e.refs[i];if(a===t.payload.ref)return e;2&t.payload.ref.current.compareDocumentPosition(a.current)?s=++i:n=i-1}return e.activeRef||(e.activeRef=t.payload.ref),i<e.refs.length?e.refs.splice(i,0,t.payload.ref):e.refs.push(t.payload.ref),b({},e)}case E.Unregister:{const i=e.refs.findIndex(e=>e===t.payload.ref);if(-1===i)return e;var s,n;if(e.refs.splice(i,1)[0]===e.activeRef)i>=e.refs.length?e.activeRef=_(e.refs,e.refs.length-1,!0):e.activeRef=_(e.refs,i)||_(e.refs,i,!0),null===(s=e.activeRef)||void 0===s||null===(n=s.current)||void 0===n||n.focus();return b({},e)}case E.SetFocus:return e.activeRef=t.payload.ref,b({},e);default:return e}},_=(e,t,s=!1)=>{if(s)for(let s=t;s<e.length&&s>=0;s--){var n;if(null!==(null===(n=e[s].current)||void 0===n?void 0:n.offsetParent))return e[s]}else for(let s=t;s<e.length&&s>=0;s++){var i;if(null!==(null===(i=e[s].current)||void 0===i?void 0:i.offsetParent))return e[s]}},w=({children:e,handleHomeEnd:t,handleUpDown:s,handleLeftRight:n,onKeyDown:i})=>{const[c,l]=Object(a.useReducer)(S,{activeRef:null,refs:[]}),d=Object(a.useMemo)(()=>({state:c,dispatch:l}),[c]),h=Object(a.useCallback)(e=>{if(i&&(i(e,d.state),e.defaultPrevented))return;let a=!1;if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName)switch(e.key){case r.a.HOME:var o,c;if(t)a=!0,null===(o=_(d.state.refs,0))||void 0===o||null===(c=o.current)||void 0===c||c.focus();break;case r.a.END:var l,h;if(t)a=!0,null===(l=_(d.state.refs,d.state.refs.length-1,!0))||void 0===l||null===(h=l.current)||void 0===h||h.focus();break;case r.a.ARROW_UP:case r.a.ARROW_RIGHT:if((e.key===r.a.ARROW_UP&&s||e.key===r.a.ARROW_RIGHT&&n)&&(a=!0,d.state.refs.length>0)){var u,m;const e=d.state.refs.indexOf(d.state.activeRef);null===(u=_(d.state.refs,e-1))||void 0===u||null===(m=u.current)||void 0===m||m.focus()}break;case r.a.ARROW_DOWN:case r.a.ARROW_LEFT:if((e.key===r.a.ARROW_DOWN&&s||e.key===r.a.ARROW_LEFT&&n)&&(a=!0,d.state.refs.length>0)){var p,g;const e=d.state.refs.indexOf(d.state.activeRef);null===(p=_(d.state.refs,e+1,!0))||void 0===p||null===(g=p.current)||void 0===g||g.focus()}}a&&(e.preventDefault(),e.stopPropagation())},[d.state,i,t,s,n]);return o.a.createElement(y.Provider,{value:d},e({onKeyDownHandler:h}))},C=e=>{const t=Object(a.useContext)(y);let s=Object(a.useRef)(null);e&&(s=e),Object(a.useLayoutEffect)(()=>(t.dispatch({type:E.Register,payload:{ref:s}}),()=>{t.dispatch({type:E.Unregister,payload:{ref:s}})}),[]);return[Object(a.useCallback)(()=>{t.dispatch({type:E.SetFocus,payload:{ref:s}})},[s,t]),t.state.activeRef===s,s]}},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"request",(function(){return T})),s.d(t,"getRequest",(function(){return j})),s.d(t,"wrapRequest",(function(){return N})),s.d(t,"setCryptoStoreFactory",(function(){return D})),s.d(t,"createClient",(function(){return M}));var n=s(285),i=s(286),a=s(421),o=s(204);s.d(t,"CRYPTO_ENABLED",(function(){return o.a})),s.d(t,"PendingEventOrdering",(function(){return o.c})),s.d(t,"RoomVersionStability",(function(){return o.d})),s.d(t,"MatrixClient",(function(){return o.b}));var r=s(288);s.d(t,"PREFIX_R0",(function(){return r.h})),s.d(t,"PREFIX_UNSTABLE",(function(){return r.i})),s.d(t,"PREFIX_IDENTITY_V1",(function(){return r.e})),s.d(t,"PREFIX_IDENTITY_V2",(function(){return r.f})),s.d(t,"PREFIX_MEDIA_R0",(function(){return r.g})),s.d(t,"MatrixHttpApi",(function(){return r.d})),s.d(t,"MatrixError",(function(){return r.c})),s.d(t,"ConnectionError",(function(){return r.b})),s.d(t,"AbortError",(function(){return r.a})),s.d(t,"retryNetworkOperation",(function(){return r.j}));var c=s(251);s.d(t,"AutoDiscoveryAction",(function(){return c.b})),s.d(t,"AutoDiscovery",(function(){return c.a}));var l=s(344);s.d(t,"Category",(function(){return l.a})),s.d(t,"SyncAccumulator",(function(){return l.b}));var d=s(224);s.d(t,"InvalidStoreError",(function(){return d.b})),s.d(t,"InvalidCryptoStoreError",(function(){return d.a})),s.d(t,"KeySignatureUploadError",(function(){return d.c}));var h=s(117);s.d(t,"EventStatus",(function(){return h.a})),s.d(t,"MatrixEvent",(function(){return h.b}));var u=s(194);s.d(t,"NotificationCountType",(function(){return u.a})),s.d(t,"Room",(function(){return u.b}));var m=s(249);s.d(t,"Group",(function(){return m.a}));var p=s(157);s.d(t,"Direction",(function(){return p.a})),s.d(t,"EventTimeline",(function(){return p.b}));var g=s(281);s.d(t,"DuplicateStrategy",(function(){return g.a})),s.d(t,"EventTimelineSet",(function(){return g.b}));var v=s(181);s.d(t,"RoomMember",(function(){return v.a}));var f=s(422);s.d(t,"RoomState",(function(){return f.a}));var b=s(223);s.d(t,"User",(function(){return b.a})),s.d(t,"MatrixScheduler",(function(){return a.a}));var y=s(339);s.d(t,"Filter",(function(){return y.a}));var E=s(426);s.d(t,"TimelineWindow",(function(){return E.b})),s.d(t,"TimelineIndex",(function(){return E.a}));var S=s(355);s.d(t,"AuthType",(function(){return S.a})),s.d(t,"InteractiveAuth",(function(){return S.b}));var _=s(205);s.d(t,"SERVICE_TYPES",(function(){return _.a})),s.d(t,"MemoryStore",(function(){return i.a}));var w=s(414);s.d(t,"IndexedDBStore",(function(){return w.a}));var C=s(427);s.d(t,"WebStorageSessionStore",(function(){return C.a})),s.d(t,"MemoryCryptoStore",(function(){return n.a}));var O=s(174);s.d(t,"IndexedDBCryptoStore",(function(){return O.a}));var k=s(287);s.d(t,"getHttpUriForMxc",(function(){return k.a}));var R=s(354);s.d(t,"ContentHelpers",(function(){return R}));var I=s(163);let x;function T(e){x=e}function j(){return x}function N(e){const t=x;x=function(s,n){return e(t,s,n)}}s.d(t,"createNewMatrixCall",(function(){return I.g}));let P=()=>new n.a;function D(e){P=e}function M(t){return"string"==typeof t&&(t={baseUrl:t}),t.request=t.request||x,t.store=t.store||new i.a({localStorage:e.localStorage}),t.scheduler=t.scheduler||new a.a,t.cryptoStore=t.cryptoStore||P(),new o.b(t)}}.call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(99),i=s.n(n),a=s(422),o=s(94);let r;!function(e){e.Backward="b",e.Forward="f"}(r||(r={}));class c{static setEventMetadata(e,t,s){var n,i,a,r;null!==(n=e.sender)&&void 0!==n&&null!==(i=n.events)&&void 0!==i&&i.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(a=e.target)&&void 0!==a&&null!==(r=a.events)&&void 0!==r&&r.member||e.getType()!==o.a.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&s&&(e.forwardLooking=!1)}constructor(e){var t,s;this.eventTimelineSet=e,i()(this,"roomId",void 0),i()(this,"name",void 0),i()(this,"events",[]),i()(this,"baseIndex",0),i()(this,"startState",void 0),i()(this,"endState",void 0),i()(this,"prevTimeline",void 0),i()(this,"nextTimeline",void 0),i()(this,"paginationRequests",{[r.Backward]:null,[r.Forward]:null}),this.roomId=null!==(t=null===(s=e.room)||void 0===s?void 0:s.roomId)&&void 0!==t?t:null,this.startState=new a.a(this.roomId),this.startState.paginationToken=null,this.endState=new a.a(this.roomId),this.endState.paginationToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e){if(this.events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this.startState.setStateEvents(e),this.endState.setStateEvents(e)}forkLive(e){const t=this.getState(e),s=new c(this.eventTimelineSet);return s.startState=t.clone(),s.endState=t,this.endState=t.clone(),s}fork(e){const t=this.getState(e),s=new c(this.eventTimelineSet);return s.startState=t.clone(),s.endState=t.clone(),s}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==c.BACKWARDS)return this.startState;if(e==c.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.getState(e).paginationToken}setPaginationToken(e,t){this.getState(t).paginationToken=e}getNeighbouringTimeline(e){if(e==c.BACKWARDS)return this.prevTimeline;if(e==c.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==c.BACKWARDS)this.prevTimeline=e;else{if(t!=c.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t,s){s||(s=t?this.startState:this.endState);const n=this.getTimelineSet();let i;n.room&&(c.setEventMetadata(e,s,t),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(s.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||c.setEventMetadata(e,s,t))),i=t?0:this.events.length,this.events.splice(i,0,e),t&&this.baseIndex++}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const s=this.events[t];if(s.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,s}return null}toString(){return this.name}}i()(c,"BACKWARDS",r.Backward),i()(c,"FORWARDS",r.Forward)},function(e,t,s){"use strict";s.d(t,"a",(function(){return k})),s.d(t,"b",(function(){return R}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(253),l=s(84),d=s(651),h=s(89),u=s(988),m=s(989),p=s(995),g=s(1005),v=s(1007),f=s(1008),b=s(1009),y=s(1011),E=s(93),S=s(1013),_=s(115),w=s(85),C=s(97),O=s(561);let k;!function(e){e.General="USER_GENERAL_TAB",e.Appearance="USER_APPEARANCE_TAB",e.Flair="USER_FLAIR_TAB",e.Notifications="USER_NOTIFICATIONS_TAB",e.Preferences="USER_PREFERENCES_TAB",e.Sidebar="USER_SIDEBAR_TAB",e.Voice="USER_VOICE_TAB",e.Security="USER_SECURITY_TAB",e.Labs="USER_LABS_TAB",e.Mjolnir="USER_MJOLNIR_TAB",e.Help="USER_HELP_TAB"}(k||(k={}));let R=Object(w.a)("views.dialogs.UserSettingsDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"mjolnirWatcher",void 0),a()(this,"mjolnirChanged",(e,t,s,n)=>{this.setState({mjolnirEnabled:n})}),this.state={mjolnirEnabled:h.b.getValue("feature_mjolnir")}}componentDidMount(){this.mjolnirWatcher=h.b.watchSetting("feature_mjolnir",null,this.mjolnirChanged)}componentWillUnmount(){h.b.unwatchSetting(this.mjolnirWatcher)}getTabs(){const e=[];return e.push(new c.a(k.General,Object(l.b)("General"),"mx_UserSettingsDialog_settingsIcon",r.a.createElement(d.a,{closeSettingsFn:this.props.onFinished}))),e.push(new c.a(k.Appearance,Object(l.b)("Appearance"),"mx_UserSettingsDialog_appearanceIcon",r.a.createElement(m.a,null))),h.b.getValue(_.b.Flair)&&e.push(new c.a(k.Flair,Object(l.b)("Flair"),"mx_UserSettingsDialog_flairIcon",r.a.createElement(y.a,null))),e.push(new c.a(k.Notifications,Object(l.b)("Notifications"),"mx_UserSettingsDialog_bellIcon",r.a.createElement(g.a,null))),e.push(new c.a(k.Preferences,Object(l.b)("Preferences"),"mx_UserSettingsDialog_preferencesIcon",r.a.createElement(v.a,{closeSettingsFn:this.props.onFinished}))),h.b.getValue("feature_spaces_metaspaces")&&e.push(new c.a(k.Sidebar,Object(l.b)("Sidebar"),"mx_UserSettingsDialog_sidebarIcon",r.a.createElement(O.a,null))),h.b.getValue(_.b.Voip)&&e.push(new c.a(k.Voice,Object(l.b)("Voice & Video"),"mx_UserSettingsDialog_voiceIcon",r.a.createElement(f.a,null))),e.push(new c.a(k.Security,Object(l.b)("Security & Privacy"),"mx_UserSettingsDialog_securityIcon",r.a.createElement(p.a,{closeSettingsFn:this.props.onFinished}))),(E.a.get().showLabsSettings||h.b.getFeatureSettingNames().some(e=>h.b.getBetaInfo(e)))&&e.push(new c.a(k.Labs,Object(l.b)("Labs"),"mx_UserSettingsDialog_labsIcon",r.a.createElement(u.a,null))),this.state.mjolnirEnabled&&e.push(new c.a(k.Mjolnir,Object(l.b)("Ignored users"),"mx_UserSettingsDialog_mjolnirIcon",r.a.createElement(S.a,null))),e.push(new c.a(k.Help,Object(l.b)("Help & About"),"mx_UserSettingsDialog_helpIcon",r.a.createElement(b.a,{closeSettingsFn:()=>this.props.onFinished(!0)}))),e}render(){return r.a.createElement(C.a,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Settings")},r.a.createElement("div",{className:"mx_SettingsDialog_content"},r.a.createElement(c.c,{tabs:this.getTabs(),initialTabId:this.props.initialTabId})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"h",(function(){return f})),s.d(t,"g",(function(){return b})),s.d(t,"f",(function(){return y})),s.d(t,"e",(function(){return E})),s.d(t,"c",(function(){return S})),s.d(t,"b",(function(){return _})),s.d(t,"d",(function(){return w}));var n=s(82),i=s.n(n),a=s(86),o=s(366),r=s(90),c=s(84),l=s(416),d=s(813),h=s(193),u=s(125),m=s(103),p=s(104),g=s(1);function v(e,t,s){const n=new o.a(e,s);return n.invite(t).then(e=>Promise.resolve({states:e,inviter:n}))}function f(e=""){r.a.createTrackedDialog("Start DM","",l.d,{kind:l.b,initialText:e},null,!1,!0)}function b(e,t=""){r.a.createTrackedDialog("Invite Users","",l.d,{kind:l.c,initialText:t,roomId:e},null,!1,!0)}function y(e,t){r.a.createTrackedDialog("Invite Users to Community","",d.a,{communityName:t,roomId:e},null,!1,!0)}function E(e){const t=h.a.instance.getGeneralChat(e);if(!t)throw new Error("Failed to locate appropriate room to start an invite in");{const s=h.a.instance.getCommunityName(e);y(t.roomId,s)}}function S(e){if(!e||"m.room.third_party_invite"!==e.getType())return!1;const t=["key_validity_url","public_key","display_name"];for(let s=0;s<t.length;++s)if(!e.getContent()[t[s]])return!1;return!0}function _(e,t,s){return v(e,t,s).then(t=>{const s=a.a.get().getRoom(e);w(t.states,s,t.inviter)}).catch(e=>{g.a.error(e.stack),r.a.createTrackedDialog("Failed to invite","",p.a,{title:Object(c.a)("Failed to invite"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}function w(e,t,s,n){const o=Object.keys(e).filter(t=>"error"===e[t]);if(1===o.length&&s.fatal)return r.a.createTrackedDialog("Failed to invite users to the room","",p.a,{title:Object(c.a)("Failed to invite users to the room:",{roomName:t.name}),description:s.getErrorText(o[0])}),!1;{const l=[];for(const t of o)if("error"===e[t]){const e=s.getErrorText(t);l.push(t+": "+e)}const d=a.a.get();if(l.length>0){const e=i.a.createElement("div",{className:"mx_InviteDialog_multiInviterError"},i.a.createElement("h4",null,Object(c.a)("We sent the others, but the below people couldn't be invited to <RoomName/>",{},{RoomName:()=>i.a.createElement("b",null,t.name)})),i.a.createElement("div",null,o.map(e=>{var t,a;const o=(null==n?void 0:n.get(e))||d.getUser(e),r=o.name||o.rawDisplayName,c=(null===(t=(a=o).getMxcAvatarUrl)||void 0===t?void 0:t.call(a))||o.avatarUrl;return i.a.createElement("div",{key:e,className:"mx_InviteDialog_multiInviterError_entry"},i.a.createElement("div",{className:"mx_InviteDialog_multiInviterError_entry_userProfile"},i.a.createElement(u.a,{url:c?Object(m.b)(c).getSquareThumbnailHttp(24):null,name:r,idName:o.userId,width:24,height:24}),i.a.createElement("span",{className:"mx_InviteDialog_multiInviterError_entry_name"},r),i.a.createElement("span",{className:"mx_InviteDialog_multiInviterError_entry_userId"},o.userId)),i.a.createElement("div",{className:"mx_InviteDialog_multiInviterError_entry_error"},s.getErrorText(e)))})));return r.a.createTrackedDialog("Some invites could not be sent","",p.a,{title:Object(c.a)("Some invites couldn't be sent"),description:e}),!1}}return!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),i=s.n(n),a=s(91),o=s.n(a);function r({description:e,hideDescriptionIfValid:t,deriveData:s,rules:n}){return async function({value:a,focused:r,allowEmpty:c=!0}){if(!a&&c)return{valid:null,feedback:null};const l={value:a,allowEmpty:c},d=s?await s(l):void 0,h=[];let u,m,p,g=!0;if(n&&n.length)for(const e of n){if(!e.key||!e.test)continue;if(!g&&e.final)continue;if(e.skip&&e.skip.call(this,l,d))continue;const t=await e.test.call(this,l,d);if(g=g&&t,t&&e.valid){const t=e.valid.call(this,d);if(!t)continue;h.push({key:e.key,valid:!0,text:t})}else if(!t&&e.invalid){const t=e.invalid.call(this,d);if(!t)continue;h.push({key:e.key,valid:!1,text:t})}}if(!r)return{valid:g,feedback:null};if(h&&h.length&&(u=i.a.createElement("ul",{className:"mx_Validation_details"},h.map(e=>{const t=o()({mx_Validation_detail:!0,mx_Validation_valid:e.valid,mx_Validation_invalid:!e.valid});return i.a.createElement("li",{key:e.key,className:t},e.text)}))),e&&(u||!t)){const t=e.call(this,d,h);m=t?i.a.createElement("div",{className:"mx_Validation_description"},t):void 0}return(m||u)&&(p=i.a.createElement("div",{className:"mx_Validation"},m,u)),{valid:g,feedback:p}}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return o})),s.d(t,"d",(function(){return r})),s.d(t,"a",(function(){return c})),s.d(t,"e",(function(){return l})),s.d(t,"f",(function(){return d})),s.d(t,"b",(function(){return h}));var n=s(84),i=s(371),a=s(677);function o(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"K":e<1e5?(e/1e3).toFixed(0)+"K":e<1e7?(e/1e6).toFixed(1)+"M":e<1e8?(e/1e6).toFixed(0)+"M":(e/1e9).toFixed(1)+"B"}function r(e){return(new Intl.NumberFormat).format(e)}function c(e,t=2){if(0===e)return"0 Bytes";const s=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(s))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function l(e){return e.match(/.{1,4}/g).join(" ")}function d(e,t,s){if(e===i.a.MXID){return"mx_Username_color"+(function(e){let t,s,n=0;if(0===e.length)return n;for(t=0;t<e.length;t++)s=e.charCodeAt(t),n=(n<<5)-n+s,n|=0;return Math.abs(n)}(t)%8+1)}if(e===i.a.PowerLevel){const e=null==s?void 0:s.getMember(t),n=null==e?void 0:e.powerLevel;return n>=100?"mx_Username_color_pl100":n>=95?"mx_Username_color_pl95":n>=51?"mx_Username_color_pl51":n>=50?"mx_Username_color_pl50":n>=1?"mx_Username_color_pl1":"mx_Username_color_pl0"}return"mx_Username_color_accent"}function h(e,t){const s=void 0===t?0:Math.max(e.length-t,0);if(0===e.length)return"";if(1===e.length)return e[0];{let i,o;return s>0?e=e.slice(0,t):i=e.pop(),o=e.every(e=>"string"==typeof e)?e.join(", "):Object(a.a)(e,", "),s>0?Object(n.a)("%(items)s and %(count)s others",{items:o,count:s}):Object(n.a)("%(items)s and %(lastItem)s",{items:o,lastItem:i})}}},,function(e,t,s){"use strict";s.d(t,"e",(function(){return u})),s.d(t,"f",(function(){return m})),s.d(t,"a",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"c",(function(){return v})),s.d(t,"b",(function(){return f})),s.d(t,"g",(function(){return _}));var n=s(99),i=s.n(n),a=s(1),o=s(5),r=s(4),c=s(94),l=s(197),d=s(423),h=s(424);let u,m,p,g,v,f;!function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(u||(u={})),function(e){e.Voice="voice",e.Video="video"}(m||(m={})),function(e){e.Inbound="inbound",e.Outbound="outbound"}(p||(p={})),function(e){e.Local="local",e.Remote="remote"}(g||(g={})),function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel"}(v||(v={})),function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transfered="transferred"}(f||(f={}));class b extends Error{constructor(e,t,s){super(t+": "+s),i()(this,"code",void 0),this.code=e}}function y(){return Date.now().toString()+Object(l.b)(16)}class E extends o.EventEmitter{constructor(e){super(),i()(this,"roomId",void 0),i()(this,"callId",void 0),i()(this,"state",u.Fledgling),i()(this,"hangupParty",void 0),i()(this,"hangupReason",void 0),i()(this,"direction",void 0),i()(this,"ourPartyId",void 0),i()(this,"client",void 0),i()(this,"forceTURN",void 0),i()(this,"turnServers",void 0),i()(this,"candidateSendQueue",[]),i()(this,"candidateSendTries",0),i()(this,"sentEndOfCandidates",!1),i()(this,"peerConn",void 0),i()(this,"feeds",[]),i()(this,"usermediaSenders",[]),i()(this,"screensharingSenders",[]),i()(this,"inviteOrAnswerSent",!1),i()(this,"waitForLocalAVStream",void 0),i()(this,"successor",void 0),i()(this,"opponentMember",void 0),i()(this,"opponentVersion",void 0),i()(this,"opponentPartyId",void 0),i()(this,"opponentCaps",void 0),i()(this,"inviteTimeout",void 0),i()(this,"remoteOnHold",!1),i()(this,"callStatsAtEnd",void 0),i()(this,"makingOffer",!1),i()(this,"ignoreOffer",void 0),i()(this,"remoteCandidateBuffer",new Map),i()(this,"remoteAssertedIdentity",void 0),i()(this,"remoteSDPStreamMetadata",void 0),i()(this,"callLengthInterval",void 0),i()(this,"callLength",0),i()(this,"gotLocalIceCandidate",e=>{if(e.candidate){if(a.a.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}}),i()(this,"onIceGatheringStateChange",e=>{if(a.a.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}}),i()(this,"gotLocalOffer",async e=>{if(a.a.debug("Created offer: ",e),this.callHasEnded())return void a.a.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{await this.peerConn.setLocalDescription(e)}catch(e){return a.a.debug("Error setting local description!",e),void this.terminate(g.Local,f.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise(e=>{setTimeout(e,200)}),this.callHasEnded())return;const t=this.state===u.CreateOffer?c.a.CallInvite:c.a.CallNegotiate,s={lifetime:6e4};this.state===u.CreateOffer?s.offer=this.peerConn.localDescription:s.description=this.peerConn.localDescription,s.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},s[d.a]=this.getLocalSDPStreamMetadata(),a.a.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(t,s)}catch(e){a.a.error("Failed to send invite",e),e.event&&this.client.cancelPendingEvent(e.event);let t=f.SignallingFailed,s="Signalling failed";return this.state===u.CreateOffer&&(t=f.SendInvite,s="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=f.UnknownDevices,s="Unknown devices present in the room"),this.emit(v.Error,new b(t,s,e)),void this.terminate(g.Local,t,!1)}this.sendCandidateQueue(),this.state===u.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(u.InviteSent),this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=null,this.state===u.InviteSent&&this.hangup(f.InviteTimeout,!1)},6e4))}),i()(this,"getLocalOfferFailed",e=>{a.a.error("Failed to get local offer",e),this.emit(v.Error,new b(f.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(g.Local,f.LocalOfferFailed,!1)}),i()(this,"getUserMediaFailed",e=>{this.successor?this.successor.getUserMediaFailed(e):(a.a.warn("Failed to get user media - ending call",e),this.emit(v.Error,new b(f.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(g.Local,f.NoUserMedia,!1))}),i()(this,"onIceConnectionStateChanged",()=>{this.callHasEnded()||(a.a.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?(this.setState(u.Connected),this.callLengthInterval||(this.callLengthInterval=setInterval(()=>{this.callLength++,this.emit(v.LengthChanged,this.callLength)},1e3))):"failed"==this.peerConn.iceConnectionState&&this.hangup(f.IceFailed,!1))}),i()(this,"onSignallingStateChanged",()=>{a.a.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)}),i()(this,"onTrack",e=>{if(0===e.streams.length)return void a.a.warn(`Streamless ${e.track.kind} found: ignoring.`);const t=e.streams[0];this.pushRemoteFeed(t),t.addEventListener("removetrack",()=>this.deleteFeedByStream(t))}),i()(this,"onDataChannel",e=>{this.emit(v.DataChannel,e.channel)}),i()(this,"onNegotiationNeeded",async()=>{if(a.a.info("Negotiation is needed!"),this.state===u.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{this.getRidOfRTXCodecs();const e=await this.peerConn.createOffer();await this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else a.a.info("Opponent does not support renegotiation: ignoring negotiationneeded event")}),i()(this,"onHangupReceived",e=>{a.a.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===u.Ringing?this.terminate(g.Remote,e.reason||f.UserHangup,!0):a.a.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)}),i()(this,"onRejectReceived",e=>{a.a.debug("Reject received for call ID "+this.callId);[u.InviteSent,u.Ringing].includes(this.state)||this.state===u.Fledgling&&this.direction===p.Inbound?this.terminate(g.Remote,e.reason||f.UserHangup,!0):a.a.debug(`Call is in state: ${this.state}: ignoring reject`)}),i()(this,"onAnsweredElsewhere",e=>{a.a.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(g.Remote,f.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.client=e.client,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)r.e(e,["urls"]);this.callId=y()}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const s=this.peerConn.createDataChannel(e,t);return this.emit(v.DataChannel,s),a.a.debug("created data channel"),s}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get type(){return this.hasLocalUserMediaVideoTrack||this.hasRemoteUserMediaVideoTrack?m.Video:m.Voice}get hasLocalUserMediaVideoTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getVideoTracks().length)>0}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>e.purpose===d.b.Usermedia&&e.stream.getVideoTracks().length>0)}get hasLocalUserMediaAudioTrack(){var e;return(null===(e=this.localUsermediaStream)||void 0===e?void 0:e.getAudioTracks().length)>0}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>e.purpose===d.b.Usermedia&&e.stream.getAudioTracks().length>0)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===d.b.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===d.b.Screenshare)}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===d.b.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===d.b.Screenshare)}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}getLocalSDPStreamMetadata(){const e={};for(const t of this.getLocalFeeds())e[t.stream.id]={purpose:t.purpose,audio_muted:t.isAudioMuted(),video_muted:t.isVideoMuted()};return a.a.debug("Got local SDPStreamMetadata",e),e}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,s=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;if(!s)return void a.a.warn(`Ignoring stream with id ${e.id} because we didn't get any metadata about it`);const o=this.getRemoteFeeds().find(e=>e.purpose===s);o?o.setNewStream(e):(this.feeds.push(new h.a({client:this.client,roomId:this.roomId,userId:t,stream:e,purpose:s,audioMuted:n,videoMuted:i})),this.emit(v.FeedsChanged,this.feeds)),a.a.info(`Pushed remote stream (id="${e.id}", active="${e.active}", purpose=${s})`)}pushRemoteFeedWithoutMetadata(e){var t;const s=this.getOpponentMember().userId,n=d.b.Usermedia,i=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(i&&e.id!==i.id)return void a.a.warn(`Ignoring new stream ID ${e.id}: we already have stream ID ${i.id}`);const o=this.getFeedByStreamId(e.id);o?o.setNewStream(e):(this.feeds.push(new h.a({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:s,stream:e,purpose:n})),this.emit(v.FeedsChanged,this.feeds)),a.a.info(`Pushed remote stream (id="${e.id}", active="${e.active}")`)}pushNewLocalFeed(e,t,s=!0){const n=this.client.getUserId();S(e.getAudioTracks(),!0);const i=this.getLocalFeeds().find(e=>e.purpose===t);i?i.setNewStream(e):(this.pushLocalFeed(new h.a({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,stream:e,purpose:t}),s),this.emit(v.FeedsChanged,this.feeds))}pushLocalFeed(e,t=!0){if(this.feeds.push(e),t){const t=e.purpose===d.b.Usermedia?this.usermediaSenders:this.screensharingSenders;t.splice(0,t.length);for(const s of e.stream.getTracks())a.a.info(`Adding track (id="${s.id}", kind="${s.kind}", streamId="${e.stream.id}", streamPurpose="${e.purpose}") to peer connection`),t.push(this.peerConn.addTrack(s,e.stream))}a.a.info(`Pushed local stream (id="${e.stream.id}", active="${e.stream.active}", purpose="${e.purpose}")`),this.emit(v.FeedsChanged,this.feeds)}removeLocalFeed(e){const t=e.purpose===d.b.Usermedia?this.usermediaSenders:this.screensharingSenders;for(const e of t)this.peerConn.removeTrack(e);t.splice(0,t.length),this.deleteFeedByStream(e.stream)}deleteAllFeeds(){for(const e of this.feeds)e.dispose();this.feeds=[],this.emit(v.FeedsChanged,this.feeds)}deleteFeedByStream(e){a.a.debug("Removing feed with stream id "+e.id);const t=this.getFeedByStreamId(e.id);t?(t.dispose(),this.feeds.splice(this.feeds.indexOf(t),1),this.emit(v.FeedsChanged,this.feeds)):a.a.warn(`Didn't find the feed with stream id ${e.id} to delete`)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];for(const s of e)t.push(s[1]);return t}async initWithInvite(e){var t;const s=e.getContent();this.direction=p.Inbound;await this.client.checkTurnServers()||a.a.warn("Failed to get TURN credentials! Proceeding with call anyway...");const n=s[d.a];n?this.updateRemoteSDPStreamMetadata(n):a.a.debug("Did not get any SDPStreamMetadata! Can not send/receive multiple streams"),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{await this.peerConn.setRemoteDescription(s.offer),await this.addBufferedIceCandidates()}catch(e){return a.a.debug("Failed to set remote description",e),void this.terminate(g.Local,f.SetRemoteDescription,!1)}const i=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(!i||0===i.getTracks().length)return a.a.error("No remote stream or no tracks after setting remote description!"),void this.terminate(g.Local,f.SetRemoteDescription,!1);this.setState(u.Ringing),e.getLocalAge()&&setTimeout(()=>{this.state==u.Ringing&&(a.a.debug("Call invite has expired. Hanging up."),this.hangupParty=g.Remote,this.setState(u.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(v.Hangup))},s.lifetime-e.getLocalAge())}initWithHangup(e){this.setState(u.Ended)}shouldAnswerWithMediaType(e,t,s){return e&&!t?(a.a.warn(`Unable to answer with ${s} because the other side isn't sending it either.`),!1):r.v(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(a.a.warn(`Unable to answer with ${s}=${e} because the other side doesn't support it. Answering with ${s}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(a.a.debug("Answering call "+this.callId),this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&this.setState(u.WaitLocalMedia);else{const s=this.state,n=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),i=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.setState(u.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const e=await this.client.getMediaHandler().getUserMediaStream(n,i);this.waitForLocalAVStream=!1;const t=[new h.a({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:e,purpose:d.b.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(!i)return void this.getUserMediaFailed(e);a.a.warn("Failed to getUserMedia(), trying to getUserMedia() without video"),this.setState(s),this.waitForLocalAVStream=!1,await this.answer(n,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||(a.a.debug("Answering call "+this.callId),this.gotCallFeedsForAnswer(e))}replacedBy(e){this.state===u.WaitLocalMedia?(a.a.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):[u.CreateOffer,u.InviteSent].includes(this.state)&&(a.a.debug("Handing local stream to new call"),e.gotCallFeedsForAnswer(this.getLocalFeeds())),this.successor=e,this.emit(v.Replaced,e),this.hangup(f.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(a.a.debug("Ending call "+this.callId),this.terminate(g.Local,e,!t),this.state===u.WaitLocalMedia)return;const s={};(this.opponentVersion&&this.opponentVersion>=1||e!==f.UserHangup)&&(s.reason=e),this.sendVoipEvent(c.a.CallHangup,s)}reject(){if(this.state!==u.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion<1)return a.a.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(f.UserHangup,!0);a.a.debug("Rejecting call: "+this.callId),this.terminate(g.Local,f.UserHangup,!0),this.sendVoipEvent(c.a.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{const s=e&&!this.hasLocalUserMediaAudioTrack,n=t&&!this.hasLocalUserMediaVideoTrack;a.a.debug(`Upgrading call: audio?=${s} video?=${n}`);const i=await this.client.getMediaHandler().getUserMediaStream(s,n);if(s&&n){if(this.hasLocalUserMediaAudioTrack)return;if(this.hasLocalUserMediaVideoTrack)return;this.pushNewLocalFeed(i,d.b.Usermedia)}else if(s){if(this.hasLocalUserMediaAudioTrack)return;const e=i.getAudioTracks()[0];this.localUsermediaStream.addTrack(e),this.peerConn.addTrack(e,this.localUsermediaStream)}else if(n){if(this.hasLocalUserMediaVideoTrack)return;const e=i.getVideoTracks()[0];this.localUsermediaStream.addTrack(e),this.peerConn.addTrack(e,this.localUsermediaStream)}}catch(e){a.a.error("Failed to upgrade the call",e),this.emit(v.Error,new b(f.NoUserMedia,"Failed to get camera access: ",e))}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return a.a.warn("There is already a screensharing stream - there is nothing to do!"),!0;if(!e&&!this.isScreensharing())return a.a.warn("There already isn't a screensharing stream - there is nothing to do!"),!1;if(!this.opponentSupportsSDPStreamMetadata())return await this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(a.a.debug("Set screensharing enabled? "+e),!e){for(const e of this.screensharingSenders)this.peerConn.removeTrack(e);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,d.b.Screenshare),!0)}catch(e){return a.a.error("Failed to get screen-sharing stream:",e),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(a.a.debug(`Set screensharing enabled? ${e} using replaceTrack()`),!e){const e=this.localUsermediaStream.getTracks().find(e=>"video"===e.kind);return this.usermediaSenders.find(e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)}).replaceTrack(e),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const s=e.getTracks().find(e=>"video"===e.kind);return this.usermediaSenders.find(e=>{var t;return"video"===(null===(t=e.track)||void 0===t?void 0:t.kind)}).replaceTrack(s),this.pushNewLocalFeed(e,d.b.Screenshare,!1),!0}catch(e){return a.a.error("Failed to get screen-sharing stream:",e),!1}}async setLocalVideoMuted(e){var t;return await this.client.getMediaHandler().hasVideoDevice()?this.hasLocalUserMediaVideoTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setVideoMuted(e),this.updateMuteStatus(),this.isLocalVideoMuted()):(await this.upgradeCall(!1,!0),this.isLocalVideoMuted()):this.isLocalVideoMuted()}isLocalVideoMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isVideoMuted()}async setMicrophoneMuted(e){var t;return await this.client.getMediaHandler().hasAudioDevice()?this.hasLocalUserMediaAudioTrack||e?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioMuted(e),this.updateMuteStatus(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isAudioMuted()}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.emit(v.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==u.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e,t;this.sendVoipEvent(c.a.CallSDPStreamMetadataChangedPrefix,{[d.a]:this.getLocalSDPStreamMetadata()});const s=(null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.isAudioMuted())||this.remoteOnHold,n=(null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())||this.remoteOnHold;S(this.localUsermediaStream.getAudioTracks(),!s),S(this.localUsermediaStream.getVideoTracks(),!n)}gotCallFeedsForInvite(e){if(this.successor)this.successor.gotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);this.setState(u.CreateOffer),a.a.debug("gotUserMediaForInvite")}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[d.a]:this.getLocalSDPStreamMetadata()};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},a.a.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(c.a.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.setState(u.Ringing),this.client.cancelPendingEvent(e.event);let t=f.SendAnswer,s="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=f.UnknownDevices,s="Unknown devices present in the room"),this.emit(v.Error,new b(t,s,e)),e}this.sendCandidateQueue()}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const t of e)this.pushLocalFeed(t);let t;this.setState(u.CreateAnswer);try{this.getRidOfRTXCodecs(),t=await this.peerConn.createAnswer()}catch(e){return a.a.debug("Failed to create answer: ",e),void this.terminate(g.Local,f.CreateAnswer,!0)}try{await this.peerConn.setLocalDescription(t),this.setState(u.Connecting),await new Promise(e=>{setTimeout(e,200)}),this.sendAnswer()}catch(e){return a.a.debug("Error setting local description!",e),void this.terminate(g.Local,f.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),s=t.candidates;if(!s)return void a.a.info("Ignoring candidates event with no candidates!");const n=0===t.version?null:t.party_id||null;if(void 0===this.opponentPartyId){a.a.info(`Buffering ${s.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(n)||[];return e.push(...s),void this.remoteCandidateBuffer.set(n,e)}this.partyIdMatches(t)?await this.addIceCandidates(s):a.a.info(`Ignoring candidates from party ID ${t.party_id}: we have chosen party ID `+this.opponentPartyId)}async onAnswerReceived(e){const t=e.getContent();if(a.a.debug(`Got answer for call ID ${this.callId} from party ID ${t.party_id}`),this.callHasEnded())return void a.a.debug(`Ignoring answer because call ID ${this.callId} has ended`);if(void 0!==this.opponentPartyId)return void a.a.info(`Ignoring answer from party ID ${t.party_id}: we already have an answer/reject from `+this.opponentPartyId);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.setState(u.Connecting);const s=t[d.a];s?this.updateRemoteSDPStreamMetadata(s):a.a.warn("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConn.setRemoteDescription(t.answer)}catch(e){return a.a.debug("Failed to set remote description",e),void this.terminate(g.Local,f.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(c.a.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){a.a.warn("Failed to send select_answer event",e)}}async onSelectAnswerReceived(e){if(this.direction!==p.Inbound)return void a.a.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(a.a.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),this.terminate(g.Remote,f.AnsweredElsewhere,!0)):a.a.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}async onNegotiateReceived(e){const t=e.getContent(),s=t.description;if(!s||!s.sdp||!s.type)return void a.a.info("Ignoring invalid m.call.negotiate event");const n=this.direction===p.Inbound,i="offer"===s.type&&(this.makingOffer||"stable"!==this.peerConn.signalingState);if(this.ignoreOffer=!n&&i,this.ignoreOffer)return void a.a.info("Ignoring colliding negotiate event because we're impolite");const o=this.isLocalOnHold(),r=t[d.a];r?this.updateRemoteSDPStreamMetadata(r):a.a.warn("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConn.setRemoteDescription(s),"offer"===s.type){this.getRidOfRTXCodecs();const e=await this.peerConn.createAnswer();await this.peerConn.setLocalDescription(e),this.sendVoipEvent(c.a.CallNegotiate,{description:this.peerConn.localDescription,[d.a]:this.getLocalSDPStreamMetadata()})}}catch(e){a.a.warn("Failed to complete negotiation",e)}const l=this.isLocalOnHold();o!==l&&(this.emit(v.LocalHoldUnhold,l),this.emit(v.HoldUnhold,l))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=r.D(this.remoteSDPStreamMetadata||{},e,!0);for(const e of this.getRemoteFeeds()){var t,s,n;const i=e.stream.id;e.setAudioMuted(null===(t=this.remoteSDPStreamMetadata[i])||void 0===t?void 0:t.audio_muted),e.setVideoMuted(null===(s=this.remoteSDPStreamMetadata[i])||void 0===s?void 0:s.video_muted),e.purpose=null===(n=this.remoteSDPStreamMetadata[i])||void 0===n?void 0:n.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent()[d.a];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(v.AssertedIdentityChanged))}callHasEnded(){return this.state===u.Ended}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=RTCRtpReceiver.getCapabilities("video").codecs,t=[...RTCRtpSender.getCapabilities("video").codecs,...e];for(const e of t)if("video/rtx"===e.mimeType){const s=t.indexOf(e);t.splice(s,1)}for(const e of this.peerConn.getTransceivers()){var s,n;!this.screensharingSenders.includes(e.sender)||"video"!==(null===(s=e.sender.track)||void 0===s?void 0:s.kind)&&"video"!==(null===(n=e.receiver.track)||void 0===n?void 0:n.kind)||e.setCodecPreferences(t)}}setState(e){const t=this.state;this.state=e,this.emit(v.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:1,call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===u.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===p.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},t)}async transfer(e){const t=await this.client.getProfileInfo(e),s=y(),n={replacement_id:y(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:s};await this.sendVoipEvent(c.a.CallReplaces,n),await this.terminate(g.Local,f.Transfered,!0)}async transferToCall(e){const t=await this.client.getProfileInfo(e.getOpponentMember().userId),s=await this.client.getProfileInfo(this.getOpponentMember().userId),n=y(),i={replacement_id:y(),target_user:{id:this.getOpponentMember().userId,display_name:s.displayname,avatar_url:s.avatar_url},await_call:n};await e.sendVoipEvent(c.a.CallReplaces,i);const a={replacement_id:y(),target_user:{id:e.getOpponentMember().userId,display_name:t.displayname,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(c.a.CallReplaces,a),await this.terminate(g.Local,f.Replaced,!0),await e.terminate(g.Local,f.Transfered,!0)}async terminate(e,t,s){this.callHasEnded()||(this.callStatsAtEnd=await this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=null),t!==f.Replaced&&this.stopAllMedia(),this.deleteAllFeeds(),this.hangupParty=e,this.hangupReason=t,this.setState(u.Ended),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),s&&this.emit(v.Hangup,this))}stopAllMedia(){a.a.debug(`stopAllMedia (stream=${this.localUsermediaStream})`);for(const e of this.feeds)if(e.isLocal()&&e.purpose===d.b.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===d.b.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else for(const t of e.stream.getTracks())t.stop()}checkForErrorListener(){if(0===this.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};a.a.debug("Attempting to send "+e.length+" candidates");try{await this.sendVoipEvent(c.a.CallCandidates,t),this.candidateSendTries=0}catch(t){if(t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){a.a.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",t);const e=f.SignallingFailed,s="Signalling failed";return this.emit(v.Error,new b(e,s,t)),void this.hangup(e,!1)}const s=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,a.a.debug("Failed to send candidates. Retrying in "+s+"ms",t),setTimeout(()=>{this.sendCandidateQueue()},s)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");this.setState(u.WaitLocalMedia);try{const s=await this.client.getMediaHandler().getUserMediaStream(e,t),n=new h.a({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),stream:s,purpose:d.b.Usermedia,audioMuted:!1,videoMuted:!1});await this.placeCallWithCallFeeds([n])}catch(e){return void this.getUserMediaFailed(e)}}async placeCallWithCallFeeds(e){this.checkForErrorListener(),this.direction=p.Outbound,this.client.callEventHandler.calls.set(this.callId,this);await this.client.checkTurnServers()||a.a.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.gotCallFeedsForInvite(e)}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e.addEventListener("datachannel",this.onDataChannel),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();a.a.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(a.a.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer=null}async addIceCandidates(e){for(const t of e)if(null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex){a.a.debug("Call "+this.callId+" got remote ICE "+t.sdpMid+" candidate: "+t.candidate);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer||a.a.info("Failed to add remote ICE candidate",e)}}else a.a.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}get hasPeerConnection(){return Boolean(this.peerConn)}}function S(e,t){for(let s=0;s<e.length;s++)e[s].enabled=t}function _(e,t,s){if("undefined"==typeof window||"undefined"==typeof document)return null;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return a.a.error("WebRTC is not supported in this browser / environment"),null}catch(e){return a.a.error("Exception thrown when trying to access WebRTC",e),null}const n=!!s&&s.forceTURN,i={client:e,roomId:t,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n},o=new E(i);return e.reEmitter.reEmit(o,Object.values(v)),o}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(123),o=s(654);class r extends a.a{constructor(e,t={}){super(e,t),i()(this,"readyStore",void 0);const s=this;this.readyStore=new class extends o.a{get mxClient(){return this.matrixClient}async onReady(){return s.onReady()}async onNotReady(){return s.onNotReady()}}(e)}get matrixClient(){return this.readyStore.mxClient}async onReady(){}async onNotReady(){}async onDispatch(e){await this.onAction(e)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return k})),s.d(t,"b",(function(){return I}));var n=s(83),i=s.n(n),a=s(89),o=s(147),r=s(257),c=s(87),l=s(663),d=s(298),h=s(1661),u=s(132),m=s(1657),p=s(191),g=s(4),v=s(1046),f=s(317),b=s(164),y=s(767),E=s(173),S=s(599),_=s(1519),w=s(106),C=s(92),O=s(1);const k="lists_update";class R extends b.a{constructor(){super(c.a),i()(this,"initialListsGenerated",!1),i()(this,"algorithm",new m.a),i()(this,"filterConditions",[]),i()(this,"prefilterConditions",[]),i()(this,"tagWatcher",void 0),i()(this,"spaceWatcher",void 0),i()(this,"updateFn",new f.a(()=>{for(const e of Object.keys(this.orderedLists))E.a.instance.getListState(e).setRooms(this.orderedLists[e]);this.emit(k)})),i()(this,"watchedSettings",["feature_custom_tags","unifiedRoomList"]),i()(this,"onAlgorithmListUpdated",()=>{this.updateFn.mark()}),i()(this,"onAlgorithmFilterUpdated",()=>{this.updateFn.trigger()}),i()(this,"onPrefilterUpdated",async()=>{await this.recalculatePrefiltering(),this.updateFn.trigger()}),this.setMaxListeners(20)}setupWatchers(){w.a.spacesEnabled?this.spaceWatcher=new _.a(this):this.tagWatcher=new h.a(this)}get unfilteredLists(){return this.algorithm?this.algorithm.getUnfilteredRooms():{}}get orderedLists(){return this.algorithm?this.algorithm.getOrderedRooms():{}}async resetStore(){await this.reset(),this.filterConditions=[],this.prefilterConditions=[],this.initialListsGenerated=!1,this.setupWatchers(),this.algorithm.off(m.b,this.onAlgorithmListUpdated),this.algorithm.off(d.a,this.onAlgorithmListUpdated),this.algorithm=new m.a,this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmListUpdated),await this.reset(null,!0)}async makeReady(e){e&&this.readyStore.useUnitTestClient(e);for(const e of this.watchedSettings)a.b.monitorSetting(e,null);u.a.addListener(()=>this.handleRVSUpdate({})),this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmFilterUpdated),this.setupWatchers(),O.a.log("Regenerating room lists: Startup"),await this.readAndCacheSettingsFromStore(),this.regenerateAllLists({trigger:!1}),this.handleRVSUpdate({trigger:!1}),this.updateFn.mark(),this.updateFn.trigger()}async readAndCacheSettingsFromStore(){const e=a.b.getValue("feature_custom_tags"),t=a.b.getValue("unifiedRoomList");await this.updateState({tagsEnabled:e,unifiedRoomList:t}),this.updateAlgorithmInstances()}handleRVSUpdate({trigger:e=!0}){if(!this.matrixClient)return;const t=u.a.getRoomId();if(!t&&this.algorithm.stickyRoom)this.algorithm.setStickyRoom(null);else if(t){const e=this.matrixClient.getRoom(t);e?e!==this.algorithm.stickyRoom&&this.algorithm.setStickyRoom(e):(O.a.warn(t+" is current in RVS but missing from client - clearing sticky room"),this.algorithm.setStickyRoom(null))}e&&this.updateFn.trigger()}async onReady(){await this.makeReady()}async onNotReady(){await this.resetStore()}async onAction(t){this.matrixClient&&this.initialListsGenerated&&(R.TEST_MODE?await this.onDispatchAsync(t):e(()=>this.onDispatchAsync(t)))}async onDispatchAsync(e){if(this.matrixClient&&this.initialListsGenerated){if(e.action===C.a.SettingUpdated){const t=e;this.watchedSettings.includes(t.settingName)&&(O.a.log("Regenerating room lists: Settings changed"),await this.readAndCacheSettingsFromStore(),this.regenerateAllLists({trigger:!1}),this.updateFn.trigger())}if(!this.algorithm)throw new Error("Room list store has no algorithm to process dispatcher update with");if("MatrixActions.Room.receipt"===e.action){if(Object(l.a)(e.event,this.matrixClient)){const t=e.room;return t?(await this.handleRoomUpdate(t,o.c.ReadReceipt),void this.updateFn.trigger()):void O.a.warn("Own read receipt was in unknown room "+t.roomId)}}else if("MatrixActions.Room.tags"===e.action){const t=e;await this.handleRoomUpdate(t.room,o.c.PossibleTagChange),this.updateFn.trigger()}else if("MatrixActions.Room.timeline"===e.action){const t=e;if(!t.isLiveEvent||!e.isLiveUnfilteredRoomTimelineEvent)return;const s=t.event.getRoomId(),n=this.matrixClient.getRoom(s),i=async e=>{if("m.room.tombstone"===t.event.getType()&&""===t.event.getStateKey()){if(this.matrixClient.getRoom(t.event.getContent().replacement_room))return}await this.handleRoomUpdate(e,o.c.Timeline),this.updateFn.trigger()};if(!n)return O.a.warn(`Live timeline event ${t.event.getId()} received without associated room`),O.a.warn("Queuing failed room update for retry as a result."),void setTimeout(async()=>{const e=this.matrixClient.getRoom(s);await i(e)},100);await i(n)}else if("MatrixActions.Event.decrypted"===e.action){const t=e,s=t.event.getRoomId();if(!s)return;const n=this.matrixClient.getRoom(s);if(!n)return void O.a.warn(`Event ${t.event.getId()} was decrypted in an unknown room ${s}`);await this.handleRoomUpdate(n,o.c.Timeline),this.updateFn.trigger()}else if("MatrixActions.accountData"===e.action&&"m.direct"===e.event_type){const t=e.event.getContent();for(const e of Object.keys(t)){const s=t[e];for(const e of s){const t=this.matrixClient.getRoom(e);t?await this.handleRoomUpdate(t,o.c.PossibleTagChange):O.a.warn(e+" was found in DMs but the room is not in the store")}}this.updateFn.trigger()}else if("MatrixActions.Room.myMembership"===e.action){const t=e,s=Object(p.b)(t.oldMembership),n=Object(p.b)(t.membership);if(s!==p.a.Join&&n===p.a.Join){const e=t.room.currentState.getStateEvents("m.room.create","");if(e&&e.getContent().predecessor){const t=this.matrixClient.getRoom(e.getContent().predecessor.room_id);if(t){this.algorithm.stickyRoom===t&&this.algorithm.setStickyRoom(null),this.algorithm.handleRoomUpdate(t,o.c.RoomRemoved)}}return await this.handleRoomUpdate(t.room,o.c.NewRoom),void this.updateFn.trigger()}if(s!==p.a.Invite&&n===p.a.Invite)return await this.handleRoomUpdate(t.room,o.c.NewRoom),void this.updateFn.trigger();if(s!==n)return await this.handleRoomUpdate(t.room,o.c.PossibleTagChange),void this.updateFn.trigger()}}}async handleRoomUpdate(e,t){if(t===o.c.NewRoom&&"invite"===e.getMyMembership()&&await S.a.instance.onNewInvitedRoom(e),!S.a.instance.isRoomVisible(e))return;if((t===o.c.NewRoom||t===o.c.PossibleTagChange)&&!this.prefilterConditions.every(t=>t.isVisible(e)))return;this.algorithm.handleRoomUpdate(e,t)&&this.updateFn.mark()}async recalculatePrefiltering(){if(!this.algorithm)return;if(!this.algorithm.hasTagSortingMap)return;this.algorithm.updatesInhibited=!0;const e=this.getPlausibleRooms(),t=this.algorithm.stickyRoom,s=t&&e.includes(t);this.algorithm.setStickyRoom(null),this.algorithm.setKnownRooms(e),s&&this.algorithm.setStickyRoom(t),this.updateFn.mark(),this.algorithm.updatesInhibited=!1}async setTagSorting(e,t){this.setAndPersistTagSorting(e,t),this.updateFn.trigger()}setAndPersistTagSorting(e,t){this.algorithm.setTagSorting(e,t),localStorage.setItem("mx_tagSort_"+e,t)}getTagSorting(e){return this.algorithm.getTagSorting(e)}getStoredTagSorting(e){return localStorage.getItem("mx_tagSort_"+e)}calculateTagSorting(e){const t=r.b.Recent,s=a.b.getValue("RoomList.orderAlphabetically",null,!1),n=this.getTagSorting(e),i=this.getStoredTagSorting(e);let o=t;return i?o=i:Object(g.v)(s)?n&&(o=n):o=s?r.b.Alphabetic:r.b.Recent,o}setListOrder(e,t){this.setAndPersistListOrder(e,t),this.updateFn.trigger()}setAndPersistListOrder(e,t){this.algorithm.setListOrdering(e,t),localStorage.setItem("mx_listOrder_"+e,t)}getListOrder(e){return this.algorithm.getListOrdering(e)}getStoredListOrder(e){return localStorage.getItem("mx_listOrder_"+e)}calculateListOrder(e){const t=r.a.Natural,s=a.b.getValue("RoomList.orderByImportance",null,!0),n=this.getListOrder(e),i=this.getStoredListOrder(e);let o=t;return i?o=i:Object(g.v)(s)?n&&(o=n):o=s?r.a.Importance:r.a.Natural,o}updateAlgorithmInstances(){this.updateFn.mark();for(const e of Object.keys(this.orderedLists)){const t=this.getTagSorting(e),s=this.getListOrder(e),n=this.calculateTagSorting(e),i=this.calculateListOrder(e);n!==t&&this.setAndPersistTagSorting(e,n),i!==s&&this.setAndPersistListOrder(e,i)}this.algorithm.setUnifiedRoomList(this.state.unifiedRoomList)}getPlausibleRooms(){if(!this.matrixClient)return[];let e=this.matrixClient.getVisibleRooms().filter(e=>S.a.instance.isRoomVisible(e));return!(this.prefilterConditions.length>0)||w.a.spacesEnabled&&this.filterConditions.length||(e=e.filter(e=>{for(const t of this.prefilterConditions)if(!t.isVisible(e))return!1;return!0})),e}regenerateAllLists({trigger:e=!0}){O.a.warn("Regenerating all room lists");const t=this.getPlausibleRooms(),s=new Set;if(this.state.tagsEnabled)for(const e of t){if(!e.tags)continue;Object.keys(e.tags).filter(e=>Object(o.d)(e)).forEach(e=>s.add(e))}const n={},i={},a=[...o.b,...Array.from(s)];for(const e of a)n[e]=this.calculateTagSorting(e),i[e]=this.calculateListOrder(e),v.a.instance.ensureLayoutExists(e);this.algorithm.populateTags(n,i),this.algorithm.setKnownRooms(t),this.initialListsGenerated=!0,e&&this.updateFn.trigger()}async addFilter(e){let t=Promise.resolve();e.kind===d.b.Prefilter?(e.on(d.a,this.onPrefilterUpdated),this.prefilterConditions.push(e),t=this.recalculatePrefiltering()):(this.filterConditions.push(e),w.a.spacesEnabled&&await this.recalculatePrefiltering(),this.algorithm&&this.algorithm.addFilterCondition(e)),t.then(()=>this.updateFn.trigger())}removeFilter(e){let t=Promise.resolve(),s=this.filterConditions.indexOf(e),n=!1;s>=0&&(this.filterConditions.splice(s,1),this.algorithm&&this.algorithm.removeFilterCondition(e),w.a.spacesEnabled&&(t=this.recalculatePrefiltering()),n=!0),s=this.prefilterConditions.indexOf(e),s>=0&&(e.off(d.a,this.onPrefilterUpdated),this.prefilterConditions.splice(s,1),t=this.recalculatePrefiltering(),n=!0),n&&t.then(()=>this.updateFn.trigger())}getFirstNameFilterCondition(){for(const e of this.filterConditions)if(e instanceof y.a)return e;return null}getTagsForRoom(e){const t=this.algorithm.getTagsForRoom(e);if(!t)return this.state.unifiedRoomList?[o.a.Unified]:[o.a.Untagged];const s=t.indexOf(o.a.DM);-1!==s&&(t[s]=o.a.Unified);const n=t.indexOf(o.a.Untagged);return-1!==n&&(t[n]=o.a.Unified),t}async manualRoomUpdate(e,t){await this.handleRoomUpdate(e,t),this.updateFn.trigger()}}i()(R,"TEST_MODE",!1);class I{static get instance(){return I.internalInstance||(I.internalInstance=new R),I.internalInstance}}i()(I,"internalInstance",void 0),window.mxRoomListStore=I.instance}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(84),d=s(107);class h extends o.a.Component{constructor(...e){super(...e),i()(this,"onFinished",()=>{this.props.onFinished()})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",hasCancel:this.props.hasCloseButton,onKeyDown:this.props.onKeyDown,fixedWidth:this.props.fixedWidth},o.a.createElement("div",{className:c()("mx_Dialog_content",this.props.className),id:"mx_Dialog_content"},this.props.description),!1!==this.props.button&&o.a.createElement(t,{primaryButton:this.props.button||Object(l.a)("OK"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}i()(h,"defaultProps",{title:"",description:"",hasCloseButton:!1})},function(e,t,s){"use strict";s.d(t,"e",(function(){return u})),s.d(t,"a",(function(){return m})),s.d(t,"c",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"f",(function(){return v})),s.d(t,"b",(function(){return f}));var n=s(117),i=s(86),a=s(302),o=s(134),r=s(89),c=s(94),l=s(282),d=s(1),h=s(263);function u(e){const{status:t}=e;if((!t||t===n.a.SENT)&&!e.isRedacted())if("m.room.message"===e.getType()){const t=e.getContent();if(t.msgtype&&"m.bad.encrypted"!==t.msgtype&&t.hasOwnProperty("body"))return!0}else if("m.sticker"===e.getType())return!0;return!1}function m(e){if(e.status===n.a.CANCELLED||"m.room.message"!==e.getType()||e.isRedacted())return!1;const t=e.getOriginalContent(),{msgtype:s}=t;return("m.text"===s||"m.emote"===s)&&t.body&&"string"==typeof t.body&&e.getSender()===i.a.get().getUserId()}function p({events:e,isForward:t,fromEventId:s}){const n=e.length-1,i=t?1:-1,o=t?0:n;let r=t?n:0;s||(r=Math.min(Math.max(0,o+100*i),n));let c=!s;for(let t=o;t!==r+i;t+=i){const o=e[t];if(c||o.getId()!==s){if(c&&!Object(a.a)(o)&&m(o))return o}else c=!0,r=Math.min(Math.max(0,t+100*i),n)}}function g(e){const t=e.getContent().msgtype,s=e.getType();let n=Object(o.c)(e),i=s.startsWith("m.key.verification")||s===c.a.RoomMessage&&t&&t.startsWith("m.key.verification")||s===c.a.RoomCreate||s===c.a.RoomEncryption||"messages.MJitsiWidgetEvent"===n;const a=!i&&s===c.a.CallInvite;let l=!i&&!a&&s!==c.a.RoomMessage&&s!==c.a.Sticker&&s!==c.a.RoomCreate&&s!==h.c.name;return r.b.getValue("showHiddenEventsInTimeline")&&!Object(o.d)(e)&&(n="messages.ViewSourceEvent",i=!1,l=!0),{tileHandler:n,isInfoMessage:l,isBubbleMessage:i,isLeftAlignedBubbleMessage:a}}function v(e){const t=e.getContent();return!!t["org.matrix.msc2516.voice"]||!!t["org.matrix.msc3245.voice"]}async function f(e,t,s){var i;let a;try{const i=await e.fetchRoomEvent(t,s);a=new n.b(i)}catch(e){d.a.warn("Could not find initial event: "+a.threadRootId),a=null}if(null!==(i=a)&&void 0!==i&&i.isThreadRelation)try{const s=await e.fetchRoomEvent(t,a.threadRootId),i=new n.b(s),o=e.getRoom(t),r=new l.a([i],o,e);r.addEvent(a),o.threads.set(r.id,r)}catch(e){d.a.warn("Could not find root event: "+a.threadRootId)}return a}},function(e,t,s){"use strict";s.d(t,"d",(function(){return v})),s.d(t,"a",(function(){return f})),s.d(t,"b",(function(){return b})),s.d(t,"c",(function(){return y}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(105);const u=["label","iconClassName","active","className"],m=["label","iconClassName","active","className"],p=["label","iconClassName","children"],g=["className","children","compact"],v=e=>{let{label:t,iconClassName:s,active:n,className:a}=e,r=o()(e,u);return c.a.createElement(h.g,i()({},r,{className:d()(a,{mx_IconizedContextMenu_active:n}),active:n,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},f=e=>{let{label:t,iconClassName:s,active:n,className:a}=e,r=o()(e,m);return c.a.createElement(h.f,i()({},r,{className:d()(a,{mx_IconizedContextMenu_active:n}),active:n,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",{mx_IconizedContextMenu_checked:n,mx_IconizedContextMenu_unchecked:!n})}))},b=e=>{let{label:t,iconClassName:s,children:n}=e,a=o()(e,p);return c.a.createElement(h.e,i()({},a,{label:t}),s&&c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n)},y=({first:e,red:t,className:s,children:n})=>{const i=d()("mx_IconizedContextMenu_optionList",s,{mx_IconizedContextMenu_optionList_notFirst:!e,mx_IconizedContextMenu_optionList_red:t});return c.a.createElement("div",{className:i},n)};t.e=e=>{let{className:t,children:s,compact:n}=e,a=o()(e,g);const r=d()("mx_IconizedContextMenu",t,{mx_IconizedContextMenu_compact:n});return c.a.createElement(h.n,i()({chevronFace:h.a.None},a),c.a.createElement("div",{className:r},s))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{getValueOverride(e,t,s,n){return null}onChange(e,t,s){}get settingDisabled(){return!1}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(89),l=s(84),d=s(322),h=s(137),u=s(85);let m=Object(u.a)("views.elements.SettingsFlag")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onChange",async e=>{await this.save(e),this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}),a()(this,"checkBoxOnChange",e=>{this.onChange(e.target.checked)}),a()(this,"save",async e=>{await c.b.setValue(this.props.name,this.props.roomId,this.props.level,void 0!==e?e:this.state.value)}),this.state={value:c.b.getValueAt(this.props.level,this.props.name,this.props.roomId,this.props.isExplicit)}}render(){const e=c.b.canSetValue(this.props.name,this.props.roomId,this.props.level),t=this.props.label?Object(l.a)(this.props.label):c.b.getDisplayName(this.props.name,this.props.level),s=c.b.getDescription(this.props.name);return this.props.useCheckbox?r.a.createElement(h.b,{checked:this.state.value,onChange:this.checkBoxOnChange,disabled:this.props.disabled||!e},t):r.a.createElement("div",{className:"mx_SettingsFlag"},r.a.createElement("span",{className:"mx_SettingsFlag_label"},t),r.a.createElement(d.a,{checked:this.state.value,onChange:this.onChange,disabled:this.props.disabled||!e,"aria-label":t}),s&&r.a.createElement("div",{className:"mx_SettingsFlag_microcopy"},s))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(147),c=s(184),l=s(116),d=s(213);class h extends d.b{constructor(e=!1,t,s){super(),this.byTileCount=e,this.tagId=t,this.getRoomFn=s,i()(this,"rooms",[]),i()(this,"states",{}),i()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return this._color===c.a.Unsent?"!":null}setRooms(e){if(this.byTileCount)return this.rooms=e,void this.calculateTotalState();const t=this.rooms,s=Object(l.a)(t,e);this.rooms=e;for(const e of s.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(d.a,this.onRoomNotificationStateUpdate))}for(const e of s.added){const t=this.getRoomFn(e);t.on(d.a,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getForRoom(e){const t=this.states[e.roomId];if(!t)throw new Error("Unknown room for notification state");return t}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(d.a,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();if(this.byTileCount)this._color=c.a.Red,this._count=this.rooms.length;else{this._count=0,this._color=c.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color)}this.emitIfUpdated(e)}}var u=s(86),m=s(191),p=s(663),g=s(194),v=s(258),f=s(676),b=s(483),y=s(180),E=s(89);class S extends d.b{constructor(e){super(),this.room=e,i()(this,"featureMarkedUnreadWatcherRef",null),i()(this,"handleLocalEchoUpdated",()=>{this.updateNotificationState()}),i()(this,"handleReadReceipt",(e,t)=>{Object(p.a)(e,u.a.get())&&t.roomId===this.room.roomId&&this.updateNotificationState()}),i()(this,"handleMembershipUpdate",()=>{this.updateNotificationState()}),i()(this,"handleRoomEventUpdate",e=>{e.getRoomId()===this.room.roomId&&this.updateNotificationState()}),i()(this,"handleAccountDataUpdate",e=>{"m.push_rules"===e.getType()&&this.updateNotificationState()}),i()(this,"handleRoomAccountDataUpdate",e=>{e.getType()===y.a.name&&this.updateNotificationState()}),this.room.on("Room.receipt",this.handleReadReceipt),this.room.on("Room.timeline",this.handleRoomEventUpdate),this.room.on("Room.redaction",this.handleRoomEventUpdate),this.room.on("Room.myMembership",this.handleMembershipUpdate),this.room.on("Room.localEchoUpdated",this.handleLocalEchoUpdated),this.room.on("Room.accountData",this.handleRoomAccountDataUpdate),u.a.get().on("Event.decrypted",this.handleRoomEventUpdate),u.a.get().on("accountData",this.handleAccountDataUpdate),this.featureMarkedUnreadWatcherRef=E.b.watchSetting("feature_mark_unread",null,()=>{this.updateNotificationState()}),this.updateNotificationState()}get roomIsInvite(){return Object(m.b)(this.room.getMyMembership())===m.a.Invite}destroy(){super.destroy(),this.room.removeListener("Room.receipt",this.handleReadReceipt),this.room.removeListener("Room.timeline",this.handleRoomEventUpdate),this.room.removeListener("Room.redaction",this.handleRoomEventUpdate),this.room.removeListener("Room.myMembership",this.handleMembershipUpdate),this.room.removeListener("Room.localEchoUpdated",this.handleLocalEchoUpdated),this.room.removeListener("Room.accountData",this.handleRoomAccountDataUpdate),u.a.get()&&(u.a.get().removeListener("Event.decrypted",this.handleRoomEventUpdate),u.a.get().removeListener("accountData",this.handleAccountDataUpdate)),E.b.unwatchSetting(this.featureMarkedUnreadWatcherRef)}updateNotificationState(){const e=this.snapshot(),t=E.b.getValue("feature_mark_unread")&&Object(y.e)(this.room);if(Object(b.b)(this.room).length>0)this._color=c.a.Unsent,this._symbol="!",this._count=1;else if(v.c(this.room.roomId)!==v.a.Mute||t)if(this.roomIsInvite)this._color=c.a.Red,this._symbol="!",this._count=1;else{const e=v.d(this.room,g.a.Highlight),s=v.d(this.room,g.a.Total),n=s||(e||0);if(e>0)this._color=c.a.Red,this._count=n,this._symbol=null;else if(s>0)this._color=c.a.Grey,this._count=n,this._symbol=null;else if(t)this._color=c.a.Grey,this._symbol="!",this._count=1;else{const e=f.a(this.room);this._color=e?c.a.Bold:c.a.None,this._count=0,this._symbol=null}}else this._color=c.a.None,this._symbol=null,this._count=0;this.emitIfUpdated(e)}}class _ extends d.b{constructor(){super(),i()(this,"totalStatesWithUnread",0),this._symbol=null,this._count=0,this._color=c.a.None}get numUnreadStates(){return this.totalStatesWithUnread}add(e,t=!1){e.symbol&&t&&(this._symbol=e.symbol),e.count&&(this._count+=e.count),e.color>this.color&&(this._color=e.color),e.hasUnreadCount&&this.totalStatesWithUnread++}}var w=s(599);class C extends a.a{constructor(){super(o.a,{}),i()(this,"roomMap",new Map),i()(this,"listMap",new Map)}get globalState(){if(!this.matrixClient)return new _;const e=new _;for(const t of this.matrixClient.getVisibleRooms())w.a.instance.isRoomVisible(t)&&e.add(this.getRoomState(t));return e}getListState(e){if(this.listMap.has(e))return this.listMap.get(e);const t=e===r.a.Invite,s=new h(t,e,e=>this.getRoomState(e));return this.listMap.set(e,s),s}getRoomState(e){return this.roomMap.has(e)||this.roomMap.set(e,new S(e)),this.roomMap.get(e)}static get instance(){return C.internalInstance}async onNotReady(){for(const e of this.roomMap.values())e.destroy()}async onAction(e){return Promise.resolve()}}i()(C,"internalInstance",new C)},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return h}));var n=s(99),i=s.n(n),a=s(1),o=s(603),r=s(285),c=s(1074),l=s(224),d=s(604);class h{static exists(e,t){return d.a(e,t)}constructor(e,t){this.indexedDB=e,this.dbName=t,i()(this,"backendPromise",null),i()(this,"backend",null)}startup(){return this.backendPromise||(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));a.a.log("connecting to indexeddb "+this.dbName);const s=this.indexedDB.open(this.dbName,c.b);s.onupgradeneeded=e=>{const t=s.result,n=e.oldVersion;c.c(t,n)},s.onblocked=()=>{a.a.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{a.a.log("Error connecting to indexeddb",e),t(s.error)},s.onsuccess=()=>{const t=s.result;a.a.log("connected to indexeddb "+this.dbName),e(new c.a(t))}}).then(e=>e.doTxn("readonly",[h.STORE_INBOUND_GROUP_SESSIONS,h.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(t=>{if("VersionError"===t.name)throw a.a.warn("Crypto DB is too new for us to use!",t),new l.a(l.a.TOO_NEW);a.a.warn("unable to connect to indexeddb "+this.dbName+": falling back to localStorage store: "+t);try{return new o.a(e.localStorage)}catch(t){return a.a.warn("unable to open localStorage: falling back to in-memory store: "+t),new r.a}}).then(e=>(this.backend=e,e))),this.backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));a.a.log("Removing indexeddb instance: "+this.dbName);const s=this.indexedDB.deleteDatabase(this.dbName);s.onblocked=()=>{a.a.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{a.a.log("Error deleting data from indexeddb",e),t(s.error)},s.onsuccess=()=>{a.a.log("Removed indexeddb instance: "+this.dbName),e()}}).catch(e=>{a.a.warn("unable to delete IndexedDBCryptoStore: "+e)})}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,s){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,s)}updateOutgoingRoomKeyRequest(e,t,s){return this.backend.updateOutgoingRoomKeyRequest(e,t,s)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,s){this.backend.getSecretStorePrivateKey(e,t,s)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,s){this.backend.storeSecretStorePrivateKey(e,t,s)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,s,n){this.backend.getEndToEndSession(e,t,s,n)}getEndToEndSessions(e,t,s){this.backend.getEndToEndSessions(e,t,s)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,s,n){this.backend.storeEndToEndSession(e,t,s,n)}storeEndToEndSessionProblem(e,t,s){return this.backend.storeEndToEndSessionProblem(e,t,s)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,s,n){this.backend.getEndToEndInboundGroupSession(e,t,s,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,s,n){this.backend.addEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSession(e,t,s,n){this.backend.storeEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,s,n)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,s){this.backend.storeEndToEndRoom(e,t,s)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,s,n){this.backend.addSharedHistoryInboundGroupSession(e,t,s,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}doTxn(e,t,s,n){return this.backend.doTxn(e,t,s,n)}}i()(h,"STORE_ACCOUNT","account"),i()(h,"STORE_SESSIONS","sessions"),i()(h,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),i()(h,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),i()(h,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),i()(h,"STORE_DEVICE_DATA","device_data"),i()(h,"STORE_ROOMS","rooms"),i()(h,"STORE_BACKUP","sessions_needing_backup")}).call(this,s(26))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(91),u=s.n(h),m=s(85);const p=["children","className","disabled","outlined","childrenInLabel"];var g,v,f;let b=Object(m.a)("views.elements.StyledRadioButton")((f=v=class extends d.a.PureComponent{render(){const e=this.props,{children:t,className:s,disabled:n,outlined:a,childrenInLabel:r}=e,c=o()(e,p),l=u()("mx_StyledRadioButton",s,{mx_StyledRadioButton_disabled:n,mx_StyledRadioButton_enabled:!n,mx_StyledRadioButton_checked:this.props.checked,mx_StyledRadioButton_outlined:a}),h=d.a.createElement(d.a.Fragment,null,d.a.createElement("input",i()({type:"radio",disabled:n},c)),d.a.createElement("div",null,d.a.createElement("div",null)));return r?d.a.createElement("label",{className:l},h,d.a.createElement("div",{className:"mx_StyledRadioButton_content"},t),d.a.createElement("div",{className:"mx_StyledRadioButton_spacer"})):d.a.createElement("div",{className:l},d.a.createElement("label",{className:"mx_StyledRadioButton_innerLabel"},h),d.a.createElement("div",{className:"mx_StyledRadioButton_content"},t),d.a.createElement("div",{className:"mx_StyledRadioButton_spacer"}))}},c()(v,"defaultProps",{className:"",childrenInLabel:!0}),g=f))||g},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(85),u=s(150);const m=["class","children","tooltip","tooltipClass","tooltipProps"];var p;let g=Object(h.a)("views.elements.TextWithTooltip")(p=class extends d.a.Component{constructor(e){super(e),c()(this,"onMouseOver",()=>{this.setState({hover:!0})}),c()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=this.props,{class:t,children:s,tooltip:n,tooltipClass:a,tooltipProps:r}=e,c=o()(e,m);return d.a.createElement("span",i()({},c,{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,onClick:this.props.onClick,className:t}),s,this.state.hover&&d.a.createElement(u.b,i()({},r,{label:n,tooltipClassName:a,className:"mx_TextWithTooltip_tooltip"})))}})||p},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(83),i=s.n(n);class a{constructor(e,t){this.preferred=e,this.legacy=t}matches(e){return e===this.preferred||e===this.legacy}static fromString(e){const t=Object.values(a).filter(e=>e instanceof a).find(t=>t.matches(e));return t||new a(e,e)}}i()(a,"JITSI",new a("m.jitsi","jitsi")),i()(a,"STICKERPICKER",new a("m.stickerpicker","m.stickerpicker")),i()(a,"INTEGRATION_MANAGER",new a("m.integration_manager","m.integration_manager")),i()(a,"CUSTOM",new a("m.custom","m.custom"))},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(88);t.a=({description:e,detail:t,acceptLabel:s,rejectLabel:n,onAccept:o,onReject:r})=>{const c=t?i.a.createElement("div",{className:"mx_Toast_detail"},t):null;return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Toast_description"},e,c),i.a.createElement("div",{className:"mx_Toast_buttons","aria-live":"off"},r&&n&&i.a.createElement(a.a,{kind:"danger_outline",onClick:r},n),i.a.createElement(a.a,{onClick:o,kind:"primary"},s)))}},function(e,t,s){"use strict";s.d(t,"c",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"g",(function(){return u})),s.d(t,"a",(function(){return m})),s.d(t,"e",(function(){return p})),s.d(t,"h",(function(){return g})),s.d(t,"f",(function(){return v}));var n=s(86);var i={},a=s(342),o=s(130),r=s(106),c=s(84);function l(e){return d(e.getCanonicalAlias(),e.getAltAliases())}function d(e,t){return i.getDisplayAliasForAliasSet?i.getDisplayAliasForAliasSet(e,t):e||(null==t?void 0:t[0])}function h(e,t){let s;if(t){s=function(e,t){let s,n;for(const i of e.getJoinedMembers())i.userId!=t&&(void 0===s||i.events.member&&i.events.member.getTs()<s)&&(n=i,s=i.events.member.getTs());if(n)return n.userId;for(const i of e.currentState.getMembers())i.userId!=t&&(void 0===s||i.events.member&&i.events.member.getTs()<s)&&(n=i,s=i.events.member.getTs());return void 0===n?t:n.userId}(e,n.a.get().getUserId())}else s=null;return u(e.roomId,s)}async function u(e,t){if(n.a.get().isGuest())return;const s=n.a.get().getAccountData("m.direct");let i={};void 0!==s&&(i=s.getContent());for(const s of Object.keys(i)){const n=i[s];if(s!=t){const t=n.indexOf(e);t>-1&&n.splice(t,1)}}if(t){const s=i[t]||[];-1==s.indexOf(e)&&s.push(e),i[t]=s}await n.a.get().setAccountData("m.direct",i)}const m=new a.a("m.marked_unread","com.famedly.marked_unread");function p(e){var t,s;return null==e||null===(t=e.getAccountData(m.name))||void 0===t||null===(s=t.getContent())||void 0===s?void 0:s.unread}async function g(e,t=!0){await n.a.get().setRoomAccountData(e.roomId,m.name,{unread:t})}function v(e){if(e.isSpaceRoom())return;const t=o.a.shared().getUserIdForRoomId(e.roomId);var s;if(t)return null===(s=e.getMember(t))||void 0===s?void 0:s.rawDisplayName;const[n,...i]=r.a.instance.getKnownParents(e.roomId);return n?Object(c.a)("%(spaceName)s and %(count)s others",{spaceName:e.client.getRoom(n).name,count:i.length}):e.getCanonicalAlias()}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(99),i=s.n(n),a=s(5),o=s(287),r=s(4);class c extends a.EventEmitter{constructor(e,t){super(),this.roomId=e,this.userId=t,i()(this,"_isOutOfBand",!1),i()(this,"_modified",void 0),i()(this,"_requestedProfileInfo",void 0),i()(this,"typing",!1),i()(this,"name",void 0),i()(this,"rawDisplayName",void 0),i()(this,"powerLevel",0),i()(this,"powerLevelNorm",0),i()(this,"user",null),i()(this,"membership",null),i()(this,"disambiguate",!1),i()(this,"events",{member:null}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){const s=e.getDirectionalContent().displayname;if("m.room.member"!==e.getType())return;this._isOutOfBand=!1,this.events.member=e;const n=this.membership;this.membership=e.getDirectionalContent().membership,this.disambiguate=function(e,t,s){if(!t||t===e)return!1;if(!r.G(t))return!1;if(!s)return!1;if(l.test(t))return!0;if(d.test(t))return!0;return!!s.getUserIdsWithDisplayName(t).some(t=>t!==e)}(this.userId,s,t);const i=this.name;this.name=function(e,t,s,n){return n?r.E(t)+" ("+e+")":t&&t!==e&&r.G(t)?r.E(t):e}(this.userId,s,0,this.disambiguate),this.rawDisplayName=r.E(e.getDirectionalContent().displayname),this.rawDisplayName&&r.G(this.rawDisplayName)||(this.rawDisplayName=this.userId),n!==this.membership&&(this.updateModifiedTime(),this.emit("RoomMember.membership",e,this,n)),i!==this.name&&(this.updateModifiedTime(),this.emit("RoomMember.name",e,this,i))}setPowerLevelEvent(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let s=t.users_default||0;const n=t.users||{};Object.values(n).forEach((function(e){s=Math.max(s,e)}));const i=this.powerLevel,a=this.powerLevelNorm;void 0!==n[this.userId]&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,s>0&&(this.powerLevelNorm=100*this.powerLevel/s),i===this.powerLevel&&a===this.powerLevelNorm||(this.updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const s=e.getContent().user_ids;Array.isArray(s)&&(-1!==s.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}updateModifiedTime(){this._modified=Date.now()}getLastModifiedTime(){return this._modified}isKicked(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),s=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),s=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return s}}getAvatarUrl(e,t,s,n,i=!0,a){const r=this.getMxcAvatarUrl();if(!r&&!i)return null;const c=Object(o.a)(e,r,t,s,n,a);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}}const l=/@.+:.+/,d=/[\u200E\u200F\u202A-\u202F]/},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(128),c=s(84),l=s(88),d=s(87),h=s(92);const u=({className:e,title:t,children:s})=>i.a.createElement("div",{className:o()("mx_BaseCard_Group",e)},i.a.createElement("h1",null,t),s);t.b=({closeLabel:e,onClose:t,className:s,header:n,footer:a,withoutScrollContainer:u,previousPhase:m,previousPhaseLabel:p,children:g,refireParams:v})=>{let f,b;if(m){const e=()=>{d.a.dispatch({action:h.a.SetRightPanelPhase,phase:m,refireParams:v})},t=null!=p?p:Object(c.a)("Back");f=i.a.createElement(l.a,{className:"mx_BaseCard_back",onClick:e,title:t})}return t&&(b=i.a.createElement(l.a,{className:"mx_BaseCard_close",onClick:t,title:e||Object(c.a)("Close")})),u||(g=i.a.createElement(r.a,null,g)),i.a.createElement("div",{className:o()("mx_BaseCard",s)},i.a.createElement("div",{className:"mx_BaseCard_header"},f,b,n),g,a&&i.a.createElement("div",{className:"mx_BaseCard_footer"},a))}},function(e,t,s){"use strict";(function(e){var n=s(5),i=s.n(n),a=s(1);let o=!0;class r extends i.a{constructor(e){super(),this._matrixClient=e,this._userGroups={},this._groupProfiles={},this._groupProfilesPromise={},this._usersPending={},this._usersInFlight={},this._debounceTimeoutID=null}groupSupport(){return o}invalidatePublicisedGroups(e){delete this._userGroups[e]}cachedPublicisedGroups(e){return this._userGroups[e]}getPublicisedGroupsCached(e,t){return this._userGroups[t]?Promise.resolve(this._userGroups[t]):this._usersPending[t]?this._usersPending[t].prom:this._usersInFlight[t]?this._usersInFlight[t].prom:(this._usersPending[t]={},this._usersPending[t].prom=new Promise((e,s)=>{this._usersPending[t].resolve=e,this._usersPending[t].reject=s}).then(e=>(this._userGroups[t]=e,setTimeout(()=>{delete this._userGroups[t]},18e5),this._userGroups[t])).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return a.a.warn("Cannot display flair, server does not support groups"),void(o=!1);throw a.a.error("Could not get groups for user",t,e),e}).finally(()=>{delete this._usersInFlight[t]}),this._debounceTimeoutID&&clearTimeout(this._debounceTimeoutID),this._debounceTimeoutID=setTimeout(()=>{this._batchedGetPublicGroups(e)},200),this._usersPending[t].prom)}async _batchedGetPublicGroups(e){this._usersInFlight=this._usersPending,this._usersPending={};let t={users:[]};try{t=await e.getPublicisedGroups(Object.keys(this._usersInFlight))}catch(e){return void Object.keys(this._usersInFlight).forEach(t=>{this._usersInFlight[t]&&this._usersInFlight[t].reject(e)})}const s=t.users;Object.keys(this._usersInFlight).forEach(e=>{this._usersInFlight[e]&&this._usersInFlight[e].resolve(s[e]||[])})}getGroupProfileCachedFast(e,t){return e&&t?this._groupProfiles[t]?this._groupProfiles[t]:(this.getGroupProfileCached(e,t),null):null}async getGroupProfileCached(e,t){if(this._groupProfiles[t])return this._groupProfiles[t];if(this._groupProfilesPromise[t]){try{await this._groupProfilesPromise[t]}catch(e){return null}return this._groupProfiles[t]}let s;a.a.log("FlairStore: Request group profile of "+t),this._groupProfilesPromise[t]=e.getGroupProfile(t);try{s=await this._groupProfilesPromise[t]}catch(e){return a.a.log("FlairStore: Failed to get group profile for "+t,e),delete this._groupProfilesPromise[t],null}return this._groupProfiles[t]={groupId:t,avatarUrl:s.avatar_url,name:s.name,shortDescription:s.short_description},delete this._groupProfilesPromise[t],a.a.log("FlairStore: Emit updateGroupProfile for "+t),this.emit("updateGroupProfile"),setTimeout(()=>{this.refreshGroupProfile(e,t)},18e5),this._groupProfiles[t]}refreshGroupProfile(e,t){return delete this._groupProfiles[t],this.getGroupProfileCached(e,t)}}void 0===e.singletonFlairStore&&(e.singletonFlairStore=new r),t.a=e.singletonFlairStore}).call(this,s(26))},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Grey=2]="Grey",e[e.Red=3]="Red",e[e.Unsent=4]="Unsent"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"f",(function(){return n})),s.d(t,"c",(function(){return i})),s.d(t,"d",(function(){return a})),s.d(t,"b",(function(){return o})),s.d(t,"e",(function(){return r})),s.d(t,"a",(function(){return c}));const n=Symbol("top-level-spaces"),i=Symbol("invited-spaces"),a=Symbol("selected-space"),o=Symbol("home-behaviour"),r=Symbol("suggested-rooms");let c;!function(e){e.Home="home-space",e.Favourites="favourites-space",e.People="people-space",e.Orphans="orphans-space"}(c||(c={}))},function(e,t,s){"use strict";s.d(t,"e",(function(){return O})),s.d(t,"d",(function(){return k})),s.d(t,"j",(function(){return R})),s.d(t,"f",(function(){return I})),s.d(t,"g",(function(){return x})),s.d(t,"i",(function(){return T})),s.d(t,"h",(function(){return N})),s.d(t,"a",(function(){return P})),s.d(t,"c",(function(){return D})),s.d(t,"b",(function(){return M}));var n=s(82),i=s.n(n),a=s(94),o=s(120),r=s(90),c=s(781),l=s(273),d=s(389),h=s(141),u=s(84),m=s(539),p=s(166),g=s(159),v=s(808),f=s(810),b=s(87),y=s(132),E=s(92),S=s(191),_=s(96),w=s(811),C=s(299);const O=e=>{const t=e.client.getUserId();return"join"===e.getMyMembership()&&(e.currentState.maySendStateEvent(a.a.RoomAvatar,t)||e.currentState.maySendStateEvent(a.a.RoomName,t)||e.currentState.maySendStateEvent(a.a.RoomTopic,t)||e.currentState.maySendStateEvent(a.a.RoomJoinRules,t))},k=(e,t=!1)=>({type:a.a.SpaceParent,content:{via:Object(o.b)(e),canonical:t},state_key:e.roomId}),R=e=>{r.a.createTrackedDialog("Space Settings","",c.a,{matrixClient:e.client,space:e},null,!1,!0)},I=e=>{r.a.createTrackedDialog("Space Landing","Add Existing",l.d,{onCreateRoomClick:()=>x(e),onAddSubspaceClick:()=>j(e),space:e,onFinished:t=>{t&&y.a.getRoomId()===e.roomId&&b.a.fire(E.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper")},x=async e=>{const t=r.a.createTrackedDialog("Space Landing","Create Room",d.a,{defaultPublic:"public"===e.getJoinRule(),parentSpace:e}),[s,n]=await t.finished;return s&&await Object(h.b)(n),s},T=(e,t="")=>{if("public"===e.getJoinRule()){const t=r.a.createTrackedDialog("Space Invite","User Menu",p.a,{title:Object(u.a)("Invite to %(spaceName)s",{spaceName:e.name}),description:i.a.createElement(i.a.Fragment,null,i.a.createElement("span",null,Object(u.a)("Share your public space")),i.a.createElement(m.a,{space:e,onFinished:()=>t.close()})),fixedWidth:!1,button:!1,className:"mx_SpacePanel_sharePublicSpace",hasCloseButton:!0})}else Object(g.g)(e.roomId,t)},j=e=>{r.a.createTrackedDialog("Space Landing","Create Subspace",f.a,{space:e,onCreateSubspaceClick:()=>N(e),onFinished:t=>{t&&y.a.getRoomId()===e.roomId&&b.a.fire(E.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper")},N=e=>{r.a.createTrackedDialog("Space Landing","Create Subspace",v.a,{space:e,onAddExistingSpaceClick:()=>j(e),onFinished:t=>{t&&y.a.getRoomId()===e.roomId&&b.a.fire(E.a.UpdateSpaceHierarchy)}},"mx_CreateSubspaceDialog_wrapper")},P=async(e,t,s)=>{const n=r.a.createDialog(_.a,null,"mx_Dialog_spinner");try{for(const e of t)await s(e);await s(e)}finally{n.close()}},D=e=>{r.a.createTrackedDialog("Leave Space","",w.a,{space:e,onFinished:async(t,s)=>{t&&(await P(e,s,e=>Object(S.d)(e.roomId)),b.a.dispatch({action:"after_leave_room",room_id:e.roomId}))}},"mx_LeaveSpaceDialog_wrapper")},M=(e,t)=>r.a.createTrackedDialog("Create Space","from community",C.b,{matrixClient:e,groupId:t},"mx_CreateSpaceFromCommunityDialog_wrapper").finished},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(82),a=s.n(i),o=s(322),r=s(85);let c=Object(r.a)("views.elements.LabelledToggleSwitch")(n=class extends a.a.PureComponent{render(){let e=a.a.createElement("span",{className:"mx_SettingsFlag_label"},this.props.label),t=a.a.createElement(o.a,{checked:this.props.value,disabled:this.props.disabled,onChange:this.props.onChange,"aria-label":this.props.label});if(this.props.toggleInFront){const s=e;e=t,t=s}const s="mx_SettingsFlag "+(this.props.className||"");return a.a.createElement("div",{className:s},e,t)}})||n},function(e,t,s){"use strict";s.d(t,"d",(function(){return w})),s.d(t,"a",(function(){return C})),s.d(t,"c",(function(){return I})),s.d(t,"e",(function(){return x})),s.d(t,"b",(function(){return T})),s.d(t,"f",(function(){return j}));var n=s(90),i=s(107),a=s(86),o=s(352),r=s(353),c=s(84),l=s(149),d=s(268),h=s(819),u=s(275),m=s(89),p=s(230),g=s(1),v=s(113);let f={},b={},y=!1,E=!1,S={};function _(){return y}function w(){return y}class C extends Error{constructor(){super("Secret storage access canceled")}}async function O(){const[e]=await n.a.createDialog(v.a,{title:Object(c.a)("Cancel entering passphrase?"),description:Object(c.a)("Are you sure you want to cancel entering passphrase?"),danger:!1,button:Object(c.a)("Go Back"),cancelButton:Object(c.a)("Cancel")}).finished;return!e}function k(e){return async({passphrase:t,recoveryKey:s})=>t?Object(o.a)(t,e.passphrase.salt,e.passphrase.iterations):Object(r.a)(s)}function R(e,t,s){_()&&(f[e]=s,b[e]=t)}const I={getSecretStorageKey:async function({keys:e},t){var s;const i=a.a.get();let o,r=await i.getDefaultSecretStorageKeyId();if(r&&(o=e[r],o||(r=void 0)),!r){const t=Object.entries(e);if(t.length>1)throw new Error("Multiple storage key requests not implemented");[r,o]=t[0]}if(_()&&f[r])return[r,f[r]];if(S.key&&await a.a.get().checkSecretStorageKey(S.key,o))return R(r,o,S.key),[r,S.key];const c=null===(s=p.a.getSecretStorageKey)||void 0===s?void 0:s.call(p.a);if(c)return g.a.log("Using key from security customisations (secret storage)"),R(r,o,c),[r,c];if(E)throw new Error("Could not unlock non-interactively");const l=k(o),{finished:d}=n.a.createTrackedDialog("Access Secret Storage dialog","",h.a,{keyInfo:o,checkPrivateKey:async e=>{const t=await l(e);return await a.a.get().checkSecretStorageKey(t,o)}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||O()}),[u]=await d;if(!u)throw new C;const m=await l(u);return R(r,o,m),[r,m]},cacheSecretStorageKey:R,onSecretRequested:async function(e,t,s,n,i){g.a.log("onSecretRequested",e,t,s,n,i);const o=a.a.get();if(e===o.getUserId())if(i&&i.isVerified()){if("m.cross_signing.master"===n||"m.cross_signing.self_signing"===n||"m.cross_signing.user_signing"===n){const e=o.getCrossSigningCacheCallbacks();if(!e.getCrossSigningKeyCache)return;const s=n.replace("m.cross_signing.",""),i=await e.getCrossSigningKeyCache(s);return i||g.a.log(`${s} requested by ${t}, but not found in cache`),i&&Object(l.encodeBase64)(i)}if("m.megolm_backup.v1"===n){const e=await o.crypto.getSessionBackupPrivateKey();return e||g.a.log(`session backup key requested by ${t}, but not found in cache`),e&&Object(l.encodeBase64)(e)}g.a.warn("onSecretRequested didn't recognise the secret named ",n)}else g.a.log("Ignoring secret request from untrusted device "+t)},getDehydrationKey:async function(e,t){var s;const i=null===(s=p.a.getSecretStorageKey)||void 0===s?void 0:s.call(p.a);if(i)return g.a.log("Using key from security customisations (dehydration)"),i;const a=k(e),{finished:o}=n.a.createTrackedDialog("Access Secret Storage dialog","",h.a,{keyInfo:e,checkPrivateKey:async e=>{const s=await a(e);try{return t(s),!0}catch(e){return!1}}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||O()}),[r]=await o;if(!r)throw new C;const c=await a(r);return S={key:new Uint8Array(c),keyInfo:e},c}};async function x(){let e;const{finished:t}=n.a.createTrackedDialog("Restore Backup","",u.a,{showSummary:!1,keyCallback:t=>e=t},null,!1,!0);if(!await t)throw new Error("Key backup prompt cancelled");return e}async function T(e=(async()=>{}),t=!1){const o=a.a.get();y=!0;try{if(!await o.hasSecretStorageKey()||t){const{finished:e}=n.a.createTrackedDialogAsync("Create Secret Storage dialog","",s.e(31).then(s.bind(null,1645)),{forceReset:t},null,!1,!0,{onBeforeClose:async e=>"backgroundClick"!==e||!Object(d.e)()}),[i]=await e;if(!i)throw new Error("Secret storage creation canceled")}else{const e=i.getComponent("dialogs.InteractiveAuthDialog");await o.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:s}=n.a.createTrackedDialog("Cross-signing keys dialog","",e,{title:Object(c.a)("Setting up keys"),matrixClient:o,makeRequest:t}),[i]=await s;if(!i)throw new Error("Cross-signing key upload auth canceled")}}),await o.bootstrapSecretStorage({getKeyBackupPassphrase:x});const t=Object.keys(f)[0];if(t&&m.b.getValue("feature_dehydration")){let e={};b[t]&&b[t].passphrase&&(e={passphrase:b[t].passphrase}),g.a.log("Setting dehydration key"),await o.setDehydrationKey(f[t],e,"Backup device")}else t?g.a.log("Not setting dehydration key: feature disabled"):g.a.warn("Not setting dehydration key: no SSSS key found")}return await e()}catch(e){var r;throw null===(r=p.a.catchAccessSecretStorageError)||void 0===r||r.call(p.a,e),g.a.error(e),e}finally{y=!1,_()||(f={},b={})}}async function j(e){const t=S.key;let s=!1;if(t&&await e.isSecretStorageReady()){g.a.log("Trying to set up cross-signing using dehydration key"),y=!0,E=!0;try{await e.checkOwnCrossSigningTrust();let n={};S.keyInfo&&S.keyInfo.passphrase&&(n={passphrase:S.keyInfo.passphrase}),await e.setDehydrationKey(t,n,"Backup device");const i=await e.getKeyBackupVersion();i&&(s=!0,e.restoreKeyBackupWithSecretStorage(i).finally(()=>{y=!1,E=!1,_()||(f={},b={})}))}finally{S={},s||(y=!1,E=!1,_()||(f={},b={}))}}}},,function(e,t,s){"use strict";(function(e){var n=s(367),i=s(94),a=s(87),o=s(92),r=s(131),c=s(140),l=s(258),d=s(86),h=s(89),u=s(299);const m={orderedTags:null,orderedTagsAccountData:null,hasSynced:!1,joinedGroupIds:null,selectedTags:[],anchorTag:null};class p extends n.Store{constructor(){super(a.a),this._state=Object.assign({},m),h.b.monitorSetting("TagPanel.enableTagPanel",null)}_setState(e){this._state=Object.assign(this._state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case o.a.ViewRoom:{const t=r.a.getGroupIdsForRoomId(e.room_id);this._updateBadges(t);break}case"MatrixActions.sync":{if("SYNCING"!==e.state&&"PREPARED"!==e.state||this._updateBadges(),"PREPARED"===e.prevState||"PREPARED"!==e.state)break;const t=e.matrixClient.getAccountData("im.vector.web.tag_ordering"),s=t?t.getContent():{};this._setState({orderedTagsAccountData:s.tags||null,removedTagsAccountData:s.removedTags||null,hasSynced:!0}),this._updateOrderedTags();break}case"MatrixActions.accountData":if("im.vector.web.tag_ordering"!==e.event_type)break;if(e.event_content._storeId===this.getStoreId())break;this._setState({orderedTagsAccountData:e.event_content?e.event_content.tags:null,removedTagsAccountData:e.event_content?e.event_content.removedTags:null}),this._updateOrderedTags();break;case"GroupActions.fetchJoinedGroups.success":this._setState({joinedGroupIds:e.result.groups.sort(),hasFetchedJoinedGroups:!0}),this._updateOrderedTags();break;case"TagOrderActions.moveTag.pending":this._setState({orderedTags:e.request.tags,removedTagsAccountData:e.request.removedTags});break;case"TagOrderActions.removeTag.pending":this._setState({removedTagsAccountData:e.request.removedTags}),this._updateOrderedTags();break;case"select_tag":{const t=!h.b.getValue("feature_communities_v2_prototypes");let s=[];if(e.shiftKey&&t){let t=this._state.orderedTags.indexOf(this._state.anchorTag),n=this._state.orderedTags.indexOf(e.tag);if(-1===t&&(t=n),t>n){const e=t;t=n,n=e}s=e.ctrlOrCmdKey?this._state.selectedTags:[],s=[...new Set(this._state.orderedTags.slice(t,n+1).concat(s))]}else s=e.ctrlOrCmdKey&&t?this._state.selectedTags.includes(e.tag)?this._state.selectedTags.filter(t=>t!==e.tag):[...this._state.selectedTags,e.tag]:1===this._state.selectedTags.length&&this._state.selectedTags.includes(e.tag)?[]:[e.tag],this._state.selectedTags.includes(e.tag)||this._setState({anchorTag:e.tag});this._setState({selectedTags:s}),c.a.trackEvent("FilterStore","select_tag")}break;case"deselect_tags":e.tag?this._setState({selectedTags:this._state.selectedTags.filter(t=>t!==e.tag)}):this._setState({selectedTags:[]}),c.a.trackEvent("FilterStore","deselect_tags");break;case"on_client_not_viable":case"on_logged_out":this._state=Object.assign({},m);break;case"setting_updated":"TagPanel.enableTagPanel"!==e.settingName||e.newValue||(this._setState({selectedTags:[]}),c.a.trackEvent("FilterStore","disable_tags"))}}_updateBadges(e=this._state.joinedGroupIds){if(e&&e.length){const t=d.a.get(),s={};e.forEach(e=>{const n=r.a.getGroupRooms(e).map(e=>t.getRoom(e.roomId)).filter(e=>null!=e),i=n&&l.b(n);s[e]=i&&0!==i.count?i:void 0});const n=Object.assign({},this._state.badges,s);this._setState({badges:n})}}_updateOrderedTags(){this._setState({orderedTags:this._state.hasSynced&&this._state.hasFetchedJoinedGroups?this._mergeGroupsAndTags():null})}_mergeGroupsAndTags(){const e=this._state.joinedGroupIds||[],t=this._state.orderedTagsAccountData||[],s=new Set(this._state.removedTagsAccountData||[]),n=t.filter(t=>("+"!==t[0]||e.includes(t))&&!s.has(t)),a=d.a.get(),o=new Set(a.getRooms().map(e=>{var t;return null===(t=e.currentState.getStateEvents(i.a.RoomCreate,""))||void 0===t?void 0:t.getContent()[u.a]}).filter(Boolean)),r=e.filter(e=>!t.includes(e)&&!s.has(e)&&!o.has(e));return n.concat(r)}getGroupBadge(e){const t=this._state.badges;return t&&t[e]}getOrderedTags(){return this._state.orderedTags}getRemovedTagsAccountData(){return this._state.removedTagsAccountData}getStoreId(){return this._id||(this._id=Math.random().toString(16).slice(2,10)),this._id}getSelectedTags(){return this._state.selectedTags}}void 0===e.singletonGroupFilterOrderStore&&(e.singletonGroupFilterOrderStore=new p),t.a=e.singletonGroupFilterOrderStore}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"e",(function(){return m})),s.d(t,"b",(function(){return p})),s.d(t,"c",(function(){return g})),s.d(t,"d",(function(){return v}));var n=s(4),i=s(86),a=s(84),o=s(90),r=s(104),c=s(82),l=s.n(c),d=s(87),h=s(132);let u;function m(e){const t={[u.Invite]:[],[u.Join]:[],[u.Leave]:[]};for(const s of e)t[p(s.getMyMembership())].push(s);return t}function p(e){return"invite"===e?u.Invite:"join"===e?u.Join:u.Leave}function g(e){const t=p(e);return t===u.Join||t===u.Invite}async function v(e,t=!0){const s=i.a.get();let c=!0;const u=s.getRoomUpgradeHistory(e);if(u&&u.length>0){u[u.length-1].roomId!==e&&(c=!1)}let m={};if(c)m=await s.leaveRoomChain(e,t);else try{await s.leave(e)}catch(t){var p;if(null!=t&&null!==(p=t.data)&&void 0!==p&&p.errcode){const s=t.data.error||Object(a.a)("Unexpected server error trying to leave the room");m[e]=Object.assign(new Error(s),{errcode:t.data.errcode,data:t.data})}else m[e]=t||new Error("Failed to leave room for unknown causes")}if(t){const t=Object.values(m).find(e=>"M_LIMIT_EXCEEDED"===(null==e?void 0:e.errcode));var g;if(t)return await Object(n.I)(null!==(g=t.data.retry_after_ms)&&void 0!==g?g:100),v(e,!1)}const f=Object.entries(m).filter(e=>!!e[1]);if(f.length>0){const t=[];for(const s of f){const n=s[1];let i=Object(a.a)("Unexpected server error trying to leave the room");if(n.errcode&&n.message){if("M_CANNOT_LEAVE_SERVER_NOTICE_ROOM"===n.errcode)return void o.a.createTrackedDialog("Error Leaving Room","",r.a,{title:Object(a.a)("Can't leave Server Notices room"),description:Object(a.a)("This room is used for important messages from the Homeserver, so you cannot leave it.")});i=m[e].message}t.push(i,l.a.createElement("BR"))}o.a.createTrackedDialog("Error Leaving Room","",r.a,{title:Object(a.a)("Error leaving room"),description:t})}else h.a.getRoomId()===e&&d.a.dispatch({action:"view_home_page"})}!function(e){e.Join="JOIN",e.Invite="INVITE",e.Leave="LEAVE"}(u||(u={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(91),u=s.n(h),m=s(161),p=s(89),g=s(88),v=s(213),f=s(85),b=s(150),y=s(84),E=s(184);const S=["notification","showUnsentTooltip","forceCount","roomId","onClick"];var _;let w=Object(f.a)("views.rooms.NotificationBadge")(_=class extends d.a.PureComponent{constructor(e){super(e),c()(this,"countWatcherRef",void 0),c()(this,"countPreferenceChanged",()=>{this.setState({showCounts:p.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)})}),c()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),c()(this,"onMouseOver",e=>{e.stopPropagation(),this.setState({showTooltip:!0})}),c()(this,"onMouseLeave",()=>{this.setState({showTooltip:!1})}),this.props.notification.on(v.a,this.onNotificationUpdate),this.state={showCounts:p.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId),showTooltip:!1},this.countWatcherRef=p.b.watchSetting("Notifications.alwaysShowBadgeCounts",this.roomId,this.countPreferenceChanged)}get roomId(){return this.props.roomId||null}componentWillUnmount(){p.b.unwatchSetting(this.countWatcherRef),this.props.notification.off(v.a,this.onNotificationUpdate)}componentDidUpdate(e){e.notification&&e.notification.off(v.a,this.onNotificationUpdate),this.props.notification.on(v.a,this.onNotificationUpdate)}render(){const e=this.props,{notification:t,showUnsentTooltip:s,forceCount:n,roomId:a,onClick:r}=e,c=o()(e,S);if(t.isIdle)return null;let l=!(t.symbol||t.count>0)||!t.hasUnreadCount;if(n&&(l=!1,!t.hasUnreadCount))return null;let h=t.symbol||Object(m.c)(t.count);l&&(h="");const p=u()({mx_NotificationBadge:!0,mx_NotificationBadge_visible:!!l||t.hasUnreadCount,mx_NotificationBadge_highlighted:t.hasMentions,mx_NotificationBadge_dot:l,mx_NotificationBadge_2char:h.length>0&&h.length<3,mx_NotificationBadge_3char:h.length>2});if(r){let e,n;return s&&this.state.showTooltip&&t.color===E.a.Unsent&&(e=Object(y.a)("Message didn't send. Click for info."),n=d.a.createElement(b.b,{className:"mx_RoleButton_tooltip",label:e})),d.a.createElement(g.a,i()({"aria-label":e},c,{className:p,onClick:r,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave}),d.a.createElement("span",{className:"mx_NotificationBadge_count"},h),n)}return d.a.createElement("div",{className:p},d.a.createElement("span",{className:"mx_NotificationBadge_count"},h))}})||_},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(92),c=s(191),l=s(89),d=s(4),h=s(123),u=s(183),m=s(190),p=s(131),g=s(1);class v extends a.a{constructor(){super(o.a,{})}static get instance(){return v.internalInstance}static getUpdateEventName(e){return`${h.b}:${e}`}getSelectedCommunityId(){return l.b.getValue("feature_communities_v2_prototypes")?m.a.getSelectedTags()[0]:null}getSelectedCommunityName(){return v.instance.getCommunityName(this.getSelectedCommunityId())}getSelectedCommunityGeneralChat(){const e=this.getSelectedCommunityId();if(e)return this.getGeneralChat(e)}getCommunityName(e){const t=u.a.getGroupProfileCachedFast(this.matrixClient,e);return(null==t?void 0:t.name)||e}getCommunityProfile(e){return u.a.getGroupProfileCachedFast(this.matrixClient,e)}getGeneralChat(e){const t=p.a.getGroupRooms(e).map(e=>this.matrixClient.getRoom(e.roomId)).filter(e=>!!e);let s=t.find(t=>{const s=t.currentState.getStateEvents("im.vector.general_chat","");return!(!s||s.getContent().groupId!==e)});return s||(s=t[0]),s}isAdminOf(e){const t=p.a.getGroupMembers(e).find(e=>e.userId===this.matrixClient.getUserId());return null==t?void 0:t.isPrivileged}canInviteTo(e){const t=this.getGeneralChat(e);if(!t)return this.isAdminOf(e);const s=t.getMember(this.matrixClient.getUserId());if(!s)return this.isAdminOf(e);const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return this.isAdminOf(e);const i=n.getContent();return(Object(d.v)(i.invite)?50:Number(i.invite))<=s.powerLevel}async onAction(e){if(this.matrixClient&&l.b.getValue("feature_communities_v2_prototypes"))if("MatrixActions.Room.myMembership"===e.action){const t=e.room,s=Object(c.b)(e.membership);if(s===Object(c.b)(e.oldMembership))return;if(s===c.a.Invite)try{const e=d.n("/rooms/$roomId/group_info",{$roomId:t.roomId}),s=await this.matrixClient.http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:"/_matrix/client/unstable/im.vector.custom"});await this.matrixClient.setAccountData("im.vector.group_info."+t.roomId,s)}catch(e){g.a.warn("Non-fatal error getting group information for invite:",e)}}else if("MatrixActions.accountData"===e.action){if(e.event_type.startsWith("im.vector.group_info.")){const t=e.event_type.substring("im.vector.group_info.".length);this.emit(v.getUpdateEventName(t),t)}}else if("select_tag"===e.action){const t=this.getGeneralChat(e.tag);t&&o.a.dispatch({action:r.a.ViewRoom,room_id:t.roomId})}}getInviteProfile(e){if(!this.matrixClient)return{displayName:null,avatarMxc:null};const t=this.matrixClient.getRoom(e);if(l.b.getValue("feature_communities_v2_prototypes")){const t=this.matrixClient.getAccountData("im.vector.group_info."+e);if(t&&t.getContent())return{displayName:t.getContent().name,avatarMxc:t.getContent().avatar_url}}return{displayName:t.name,avatarMxc:t.getMxcAvatarUrl()}}async onReady(){for(const e of this.matrixClient.getRooms()){const t=e.currentState.getMembers().find(e=>e.userId===this.matrixClient.getUserId());t&&(Object(c.b)(t.membership)===c.a.Invite&&this.emit(v.getUpdateEventName(e.roomId),e.roomId))}}}i()(v,"internalInstance",new v)},function(e,t,s){"use strict";s.d(t,"a",(function(){return _})),s.d(t,"b",(function(){return w}));var n=s(99),i=s.n(n),a=s(5),o=s(281),r=s(157),c=s(287),l=s(4),d=s(117),h=s(181);class u{constructor(e,t){this.roomId=e}}var m=s(1),p=s(343),g=s(94),v=s(204),f=s(282);function b(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function y(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?b(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):b(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const E=["1","2","3","4","5","6"];function S(e,t,s){const n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][s]={},n.content[t.getId()][s][e]={ts:t.getTs()},new d.b(n)}let _;!function(e){e.Highlight="highlight",e.Total="total"}(_||(_={}));class w extends a.EventEmitter{constructor(e,t,s,n={}){if(super(),this.roomId=e,this.client=t,this.myUserId=s,this.opts=n,i()(this,"reEmitter",void 0),i()(this,"txnToEvent",{}),i()(this,"receipts",{}),i()(this,"receiptCacheByEventId",{}),i()(this,"realReceipts",{}),i()(this,"notificationCounts",{}),i()(this,"timelineSets",void 0),i()(this,"filteredTimelineSets",{}),i()(this,"pendingEventList",void 0),i()(this,"blacklistUnverifiedDevices",null),i()(this,"selfMembership",null),i()(this,"summaryHeroes",null),i()(this,"getTypeWarning",!1),i()(this,"getVersionWarning",!1),i()(this,"membersPromise",void 0),i()(this,"name",void 0),i()(this,"normalizedName",void 0),i()(this,"tags",{}),i()(this,"accountData",{}),i()(this,"summary",null),i()(this,"storageToken",void 0),i()(this,"timeline",void 0),i()(this,"oldState",void 0),i()(this,"currentState",void 0),i()(this,"threads",new Map),this.setMaxListeners(100),this.reEmitter=new p.a(this),n.pendingEventOrdering=n.pendingEventOrdering||v.c.Chronological,this.name=e,this.timelineSets=[new o.b(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===v.c.Detached){this.pendingEventList=[];const e=t.sessionStore.store.getItem(C(this.roomId));e&&JSON.parse(e).forEach(async e=>{const t=new d.b(e);t.getType()===g.a.RoomMessageEncrypted&&await t.attemptDecryption(this.client.crypto),t.setStatus(d.a.NOT_SENT),this.addPendingEvent(t,t.getTxnId())})}this.opts.lazyLoadMembers?this.membersPromise=null:this.membersPromise=Promise.resolve(!1)}decryptCriticalEvents(){const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),s=t.findIndex(t=>t.event.event_id===e),n=t.slice(s).filter(e=>e.shouldAttemptDecryption()).reverse().map(e=>e.attemptDecryption(this.client.crypto,{isRetry:!0}));return Promise.allSettled(n)}decryptAllEvents(){const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().filter(e=>e.shouldAttemptDecryption()).reverse().map(e=>e.attemptDecryption(this.client.crypto,{isRetry:!0}));return Promise.allSettled(e)}getVersion(){const e=this.currentState.getStateEvents(g.a.RoomCreate,"");if(!e)return this.getVersionWarning||(m.a.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1";const t=e.getContent().room_version;return void 0===t?"1":t}shouldUpgradeToVersion(){return E.includes(this.getVersion())?null:"6"}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e){e={default:"6",available:{}};for(const t of E)e.available[t]=v.d.Stable}let t=this.checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){m.a.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this.client.getCapabilities(!0))["m.room_versions"],!e)return m.a.warn("No room version capability - assuming upgrade required."),t;t=this.checkVersionAgainstCapability(e)}return t}checkVersionAgainstCapability(e){const t=this.getVersion();m.a.log(`[${this.roomId}] Current version: ${t}`),m.a.log(`[${this.roomId}] Version capability: `,e);const s={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return s;return Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(s.version=e.default,s.needsUpgrade=!0,s.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),s.urgent?m.a.warn("URGENT upgrade required on "+this.roomId):m.a.warn("Non-urgent upgrade required on "+this.roomId)),s}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.a.RoomTombstone,e)}getPendingEvents(e){if(this.opts.pendingEventOrdering!==v.c.Detached)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList.filter(t=>!e||e.id===t.threadRootId)}removePendingEvent(e){if(this.opts.pendingEventOrdering!==v.c.Detached)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=l.F(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){return this.opts.pendingEventOrdering===v.c.Detached&&this.pendingEventList.some(t=>t.getId()===e)}getPendingEvent(e){return this.opts.pendingEventOrdering!==v.c.Detached?null:this.pendingEventList.find(t=>t.getId()===e)}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER}getMyMembership(){return this.selfMembership}getDMInviter(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this.selfMembership){if(2==this.getInvitedAndJoinedMemberCount()&&this.summaryHeroes.length)return this.summaryHeroes[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(e){const e=this.summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){const e=this.summaryHeroes.map(e=>this.client.getUser(e)).find(e=>!!e);if(e){const t=new h.a(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken(),t=l.m({not_membership:"leave",at:e}),s=l.n("/rooms/$roomId/members?"+t,{$roomId:this.roomId}),n=this.client.http;return(await n.authedRequest(void 0,"GET",s)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);(null===t||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(e=!0,t=await this.loadMembersFromServer(),m.a.log(`LL: got ${t.length} members from server for room `+this.roomId));return{memberEvents:t.map(this.client.getEventMapper()),fromServer:e}}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId)&&this.client.crypto.trackRoomDevices(this.roomId),e.fromServer)).catch(e=>{throw this.membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){const e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>e.events.member.event);m.a.log("LL: telling store to write "+e.length+" members for room "+this.roomId);return this.client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{m.a.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{m.a.error(e)}),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=null)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{m.a.error(`error after clearing loaded members from room ${this.roomId} after leaving`),m.a.log(e)})}resetLiveTimeline(e,t){for(let s=0;s<this.timelineSets.length;s++)this.timelineSets[s].resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(r.b.BACKWARDS),this.currentState=this.getLiveTimeline().getState(r.b.FORWARDS)}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if(this.client.getStoredDevicesForUser(t.userId).some(e=>e.isUnverified()))return!0}return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),s=this.findThreadForEvent(t);return s?s.timelineSet.getLiveTimeline():this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(t)return t;{const s=this.getThreads();for(let n=0;n<s.length;n++){if(t=s[n].findEventById(e),t)return t}}}getUnreadNotificationCount(e=_.Total){return this.notificationCounts[e]}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t}setSummary(e){const t=e["m.heroes"],s=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(s)&&this.currentState.setJoinedMemberCount(s),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter(e=>e!==this.myUserId))}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices}getAvatarUrl(e,t,s,n,i=!0){const a=this.currentState.getStateEvents(g.a.RoomAvatar,"");if(!a&&!i)return null;const o=a?a.getContent().url:null;return o?Object(c.a)(e,o,t,s,n):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(g.a.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getAliases(){const e=[],t=this.currentState.getStateEvents(g.a.RoomAliases);if(t)for(let s=0;s<t.length;++s){const n=t[s];if(Array.isArray(n.getContent().aliases)){const t=n.getContent().aliases.filter(e=>"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":"+n.getStateKey())));Array.prototype.push.apply(e,t)}}return e}getCanonicalAlias(){const e=this.currentState.getStateEvents(g.a.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(g.a.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,s,n){s.getTimelineSet().addEventsToTimeline(e,t,s,n)}getThread(e){return this.getThreads().find(t=>t.id===e)}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(g.a.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const s=this.getMember(e);return!!s&&s.membership===t}getOrCreateFilteredTimelineSet(e){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const t=Object.assign({filter:e},this.opts),s=new o.b(this,t);this.reEmitter.reEmit(s,["Room.timeline","Room.timelineReset"]),this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s);const n=this.getLiveTimeline();n.getEvents().forEach((function(e){s.addLiveEvent(e)}));let i=n;for(;i.getNeighbouringTimeline(r.b.BACKWARDS);)i=i.getNeighbouringTimeline(r.b.BACKWARDS);return s.getLiveTimeline().setPaginationToken(i.getPaginationToken(r.b.BACKWARDS),r.b.BACKWARDS),s}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const s=this.timelineSets.indexOf(t);s>-1&&this.timelineSets.splice(s,1)}findThreadForEvent(e){if(!e)return null;if(e.isThreadRelation)return this.threads.get(e.threadRootId);if(e.isThreadRoot)return this.threads.get(e.getId());{const t=this.findEventById(e.parentEventId);return this.findThreadForEvent(t)}}async addThreadedEvent(e){let t=this.findThreadForEvent(e);if(t)t.addEvent(e);else{const s=[e];let n=this.findEventById(e.threadRootId);if(!n){const t=await this.client.fetchRoomEvent(this.roomId,e.threadRootId);n=new d.b(t)}s.unshift(n),t=new f.a(s,this,this.client),this.threads.set(t.id,t),this.reEmitter.reEmit(t,[f.b.Update,f.b.Ready]),this.emit(f.b.New,t)}if(e.getUnsigned().transaction_id){const t=this.txnToEvent[e.getUnsigned().transaction_id];if(t)return void this.handleRemoteEcho(e,t)}this.emit(f.b.Update,t)}addLiveEvent(e,t,s=!1){if(e.isRedaction()){const t=e.event.redacts,s=this.findEventById(t);if(s){if(s.makeRedacted(e),s.getStateKey()){this.currentState.getStateEvents(s.getType(),s.getStateKey()).getId()===s.getId()&&this.currentState.setStateEvents([s])}this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){const t=this.txnToEvent[e.getUnsigned().transaction_id];if(t)return void this.handleRemoteEcho(e,t)}for(let n=0;n<this.timelineSets.length;n++)this.timelineSets[n].addLiveEvent(e,t,s);e.sender&&e.getType()!==g.a.RoomRedaction&&this.addReceipt(S(e.sender.userId,e,"m.read"),!0)}addPendingEvent(e,t){if(e.status!==d.a.SENDING&&e.status!==d.a.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);r.b.setEventMetadata(e,this.getLiveTimeline().getState(r.b.FORWARDS),!1),this.txnToEvent[t]=e;const s=this.threads.get(e.threadRootId);if(this.opts.pendingEventOrdering!==v.c.Detached||s)if(s)s.timelineSet.addEventToTimeline(e,s.timelineSet.getLiveTimeline(),!1);else for(let t=0;t<this.timelineSets.length;t++){const s=this.timelineSets[t];s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.addEventToTimeline(e,s.getLiveTimeline(),!1):s.addEventToTimeline(e,s.getLiveTimeline(),!1)}else if(this.pendingEventList.some(e=>e.status===d.a.NOT_SENT)&&(m.a.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(d.a.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let s=this.pendingEventList&&this.pendingEventList.find(e=>e.getId()===t);s||(s=this.findEventById(t)),s&&(s.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}this.emit("Room.localEchoUpdated",e,this,null,null)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map(e=>y(y({},e.event),{},{txn_id:e.getTxnId()})).filter(e=>{const t=e.type===g.a.RoomMessageEncrypted,s=this.client.isRoomEncrypted(this.roomId);return t||!s}),{store:t}=this.client.sessionStore;this.pendingEventList.length>0?t.setItem(C(this.roomId),JSON.stringify(e)):t.removeItem(C(this.roomId))}}aggregateNonLiveRelation(e){const t=this.findThreadForEvent(e);if(t)t.timelineSet.aggregateRelations(e);else for(let t=0;t<this.timelineSets.length;t++){const s=this.timelineSets[t];s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.aggregateRelations(e):s.aggregateRelations(e)}}handleRemoteEcho(e,t){const s=t.getId(),n=e.getId(),i=t.status;m.a.debug(`Got remote echo for event ${s} -> ${n} old status `+i),delete this.txnToEvent[e.getUnsigned().transaction_id],this.pendingEventList&&this.removePendingEvent(s),t.handleRemoteEcho(e.event);const a=this.threads.get(e.threadRootId);if(a)a.timelineSet.handleRemoteEcho(t,s,n);else for(let e=0;e<this.timelineSets.length;e++){this.timelineSets[e].handleRemoteEcho(t,s,n)}this.emit("Room.localEchoUpdated",t,this,s,i)}updatePendingEvent(e,t,s){if(m.a.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${s}`),t==d.a.SENT&&!s)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==d.a.SENT){if(this.getTimelineForEvent(s))return}const n=e.status,i=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const a=O[n];if(!a||a.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+n+"->"+t);if(e.setStatus(t),t==d.a.SENT){e.replaceLocalEventId(s);const t=this.findThreadForEvent(e);if(t)t.timelineSet.replaceEventId(i,s);else for(let e=0;e<this.timelineSets.length;e++)this.timelineSets[e].replaceEventId(i,s)}else if(t==d.a.CANCELLED){if(this.pendingEventList){const e=this.pendingEventList.findIndex(e=>e.getId()===i);if(-1!==e){const[t]=this.pendingEventList.splice(e,1);t.isRedaction()&&this.revertRedactionLocalEcho(t)}}this.removeEvent(i)}this.savePendingEvents(),this.emit("Room.localEchoUpdated",e,this,i,n)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const s=this.getUnfilteredTimelineSet().findEventById(t);s&&(s.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),s.isRelation()&&this.aggregateNonLiveRelation(s))}addLiveEvents(e,t,s=!1){let n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this.timelineSets.length;n++){const e=this.timelineSets[n].getLiveTimeline();if(e.getPaginationToken(r.b.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+e.getPaginationToken(r.b.FORWARDS)+")");if(e.getNeighbouringTimeline(r.b.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++){this.addLiveEvent(e[n],t,s);const i=this.threads.get(e[n].getId());i&&i.addEvent(e[n],!0)}}addEphemeralEvents(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)}removeEvents(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])}removeEvent(e){let t=!1;for(let s=0;s<this.timelineSets.length;s++){const n=this.timelineSets[s].removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(g.a.RoomMember,this.myUserId);if(e&&"invite"===e.getContent().membership){(e.getUnsigned().invite_room_state||[]).forEach(e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new d.b({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=Object(l.z)(this.name),this.summary=new u(this.roomId,{title:this.name}),t!==this.name&&this.emit("Room.name",this)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))}getEventReadUpTo(e,t=!1){let s=this.receipts;return t&&(s=this.realReceipts),void 0===s["m.read"]||void 0===s["m.read"][e]?null:s["m.read"][e].eventId}hasUserReadEvent(e,t){const s=this.getEventReadUpTo(e,!1);if(s===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const n=this.timeline[e];if(n.getId()===t)return!1;if(n.getId()===s)return!0}return!1}getReceiptsForEvent(e){return this.receiptCacheByEventId[e.getId()]||[]}addReceipt(e,t=!1){t||this.addReceiptsToStructure(e,this.realReceipts),this.addReceiptsToStructure(e,this.receipts),this.receiptCacheByEventId=this.buildReceiptCache(this.receipts),this.emit("Room.receipt",e,this)}addReceiptsToStructure(e,t){const s=e.getContent();Object.keys(s).forEach(e=>{Object.keys(s[e]).forEach(n=>{Object.keys(s[e][n]).forEach(i=>{const a=s[e][n][i];t[n]||(t[n]={});const o=t[n][i];if(o){const t=this.getUnfilteredTimelineSet().compareEventOrdering(o.eventId,e);if(null!==t&&t>=0)return}else t[n][i]={};t[n][i]={eventId:e,data:a}})})})}buildReceiptCache(e){const t={};return Object.keys(e).forEach((function(s){Object.keys(e[s]).forEach((function(n){const i=e[s][n];t[i.eventId]||(t[i.eventId]=[]),t[i.eventId].push({userId:n,type:s,data:i.data})}))})),t}addLocalEchoReceipt(e,t,s){this.addReceipt(S(e,t,s),!0)}addTags(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)}addAccountData(e){for(let t=0;t<e.length;t++){const s=e[t];"m.tag"===s.getType()&&this.addTags(s);const n=this.accountData[s.getType()];this.accountData[s.getType()]=s,this.emit("Room.accountData",s,this,n)}}getAccountData(e){return this.accountData[e]}maySendMessage(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent(g.a.RoomMessage,this.myUserId)}canInvite(e){let t="join"===this.getMyMembership();const s=this.currentState.getStateEvents(g.a.RoomPowerLevels,""),n=s&&s.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(g.a.RoomCreate,"");if(e)return e.getContent()[g.d];this.getTypeWarning||(m.a.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===g.e.Space}calculateRoomName(e,t=!1){if(!t){const e=this.currentState.getStateEvents(g.a.RoomName,"");if(e&&e.getContent()&&e.getContent().name)return e.getContent().name}let s=this.getCanonicalAlias();if(!s){const e=this.getAltAliases();e.length&&(s=e[0])}if(s)return s;let n=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,i=[];const a=this.currentState.getStateEvents(g.f.name,"");Array.isArray(null==a?void 0:a.getContent().service_members)&&(i=a.getContent().service_members);let o=null;if(this.summaryHeroes)o=[],this.summaryHeroes.forEach(e=>{if(i.includes(e))return void n--;const t=this.getMember(e);o.push(t?t.name:e)});else{let t=this.currentState.getMembers().filter(t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership));t=t.filter(({userId:e})=>!i.includes(e)||(n--,!1)),t.sort((e,t)=>l.g(e.userId,t.userId)),t=t.slice(0,5),o=t.map(e=>e.name)}if(n)return k(o,n);if("join"==this.getMyMembership()){const e=this.currentState.getStateEvents(g.a.RoomThirdPartyInvite);if(e&&e.length){return"Inviting "+k(e.map(e=>e.getContent().display_name))}}let r=o;return r.length||(r=this.currentState.getMembers().filter(t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership).map(e=>e.name)),r.length?`Empty room (was ${k(r)})`:"Empty room"}}function C(e){return"mx_pending_events_"+e}const O={};function k(e,t=e.length+1){const s=t-1;if(e.length){if(1===e.length&&s<=1)return e[0];if(2===e.length&&s<=2)return`${e[0]} and ${e[1]}`;return s>1?`${e[0]} and ${s} others`:e[0]+" and 1 other"}return"Empty room"}O[d.a.ENCRYPTING]=[d.a.SENDING,d.a.NOT_SENT],O[d.a.SENDING]=[d.a.ENCRYPTING,d.a.QUEUED,d.a.NOT_SENT,d.a.SENT],O[d.a.QUEUED]=[d.a.SENDING,d.a.CANCELLED],O[d.a.SENT]=[],O[d.a.NOT_SENT]=[d.a.SENDING,d.a.QUEUED,d.a.CANCELLED],O[d.a.CANCELLED]=[]},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l})),s.d(t,"e",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"c",(function(){return u})),s.d(t,"f",(function(){return g}));var n=s(83),i=s.n(n),a=s(108),o=s(89);const r={getMessageComposerBindings:()=>{const e=[{action:c.SelectPrevSendHistory,keyCombo:{key:a.a.ARROW_UP,altKey:!0,ctrlKey:!0}},{action:c.SelectNextSendHistory,keyCombo:{key:a.a.ARROW_DOWN,altKey:!0,ctrlKey:!0}},{action:c.EditPrevMessage,keyCombo:{key:a.a.ARROW_UP}},{action:c.EditNextMessage,keyCombo:{key:a.a.ARROW_DOWN}},{action:c.CancelEditing,keyCombo:{key:a.a.ESCAPE}},{action:c.FormatBold,keyCombo:{key:a.a.B,ctrlOrCmd:!0}},{action:c.FormatItalics,keyCombo:{key:a.a.I,ctrlOrCmd:!0}},{action:c.FormatQuote,keyCombo:{key:a.a.GREATER_THAN,ctrlOrCmd:!0,shiftKey:!0}},{action:c.EditUndo,keyCombo:{key:a.a.Z,ctrlOrCmd:!0}},{action:c.MoveCursorToStart,keyCombo:{key:a.a.HOME,ctrlOrCmd:!0}},{action:c.MoveCursorToEnd,keyCombo:{key:a.a.END,ctrlOrCmd:!0}}];return a.b?e.push({action:c.EditRedo,keyCombo:{key:a.a.Z,ctrlOrCmd:!0,shiftKey:!0}}):e.push({action:c.EditRedo,keyCombo:{key:a.a.Y,ctrlOrCmd:!0}}),o.b.getValue("MessageComposerInput.ctrlEnterToSend")?(e.push({action:c.Send,keyCombo:{key:a.a.ENTER,ctrlOrCmd:!0}}),e.push({action:c.NewLine,keyCombo:{key:a.a.ENTER}})):(e.push({action:c.Send,keyCombo:{key:a.a.ENTER}}),e.push({action:c.NewLine,keyCombo:{key:a.a.ENTER,shiftKey:!0}}),a.b&&e.push({action:c.NewLine,keyCombo:{key:a.a.ENTER,altKey:!0}})),e},getAutocompleteBindings:()=>[{action:l.ForceComplete,keyCombo:{key:a.a.TAB}},{action:l.ForceComplete,keyCombo:{key:a.a.TAB,ctrlKey:!0}},{action:l.Complete,keyCombo:{key:a.a.ENTER}},{action:l.Complete,keyCombo:{key:a.a.ENTER,ctrlKey:!0}},{action:l.Cancel,keyCombo:{key:a.a.ESCAPE}},{action:l.PrevSelection,keyCombo:{key:a.a.ARROW_UP}},{action:l.NextSelection,keyCombo:{key:a.a.ARROW_DOWN}}],getRoomListBindings:()=>[{action:d.ClearSearch,keyCombo:{key:a.a.ESCAPE}},{action:d.PrevRoom,keyCombo:{key:a.a.ARROW_UP}},{action:d.NextRoom,keyCombo:{key:a.a.ARROW_DOWN}},{action:d.SelectRoom,keyCombo:{key:a.a.ENTER}},{action:d.CollapseSection,keyCombo:{key:a.a.ARROW_LEFT}},{action:d.ExpandSection,keyCombo:{key:a.a.ARROW_RIGHT}}],getRoomBindings:()=>{const e=[{action:h.ScrollUp,keyCombo:{key:a.a.PAGE_UP}},{action:h.RoomScrollDown,keyCombo:{key:a.a.PAGE_DOWN}},{action:h.DismissReadMarker,keyCombo:{key:a.a.ESCAPE}},{action:h.JumpToOldestUnread,keyCombo:{key:a.a.PAGE_UP,shiftKey:!0}},{action:h.UploadFile,keyCombo:{key:a.a.U,ctrlOrCmd:!0,shiftKey:!0}},{action:h.JumpToFirstMessage,keyCombo:{key:a.a.HOME,ctrlKey:!0}},{action:h.JumpToLatestMessage,keyCombo:{key:a.a.END,ctrlKey:!0}}];return o.b.getValue("ctrlFForSearch")&&e.push({action:h.FocusSearch,keyCombo:{key:a.a.F,ctrlOrCmd:!0}}),e},getNavigationBindings:()=>[{action:u.FocusRoomSearch,keyCombo:{key:a.a.K,ctrlOrCmd:!0}},{action:u.ToggleRoomSidePanel,keyCombo:{key:a.a.PERIOD,ctrlOrCmd:!0}},{action:u.ToggleUserMenu,keyCombo:{key:a.a.BACKTICK,ctrlOrCmd:!0}},{action:u.ToggleShortCutDialog,keyCombo:{key:a.a.SLASH,ctrlOrCmd:!0}},{action:u.ToggleShortCutDialog,keyCombo:{key:a.a.SLASH,ctrlOrCmd:!0,shiftKey:!0}},{action:u.GoToHome,keyCombo:{key:a.a.H,ctrlKey:!0,altKey:!a.b,shiftKey:a.b}},{action:u.SelectPrevRoom,keyCombo:{key:a.a.ARROW_UP,altKey:!0}},{action:u.SelectNextRoom,keyCombo:{key:a.a.ARROW_DOWN,altKey:!0}},{action:u.SelectPrevUnreadRoom,keyCombo:{key:a.a.ARROW_UP,altKey:!0,shiftKey:!0}},{action:u.SelectNextUnreadRoom,keyCombo:{key:a.a.ARROW_DOWN,altKey:!0,shiftKey:!0}}]};let c,l,d,h,u;function m(e,t,s){var n,i,a,o,r,c,l,d;if(void 0!==t.key)if(e.shiftKey){if(e.key.toLowerCase()!==t.key.toLowerCase())return!1}else if(e.key!==t.key)return!1;const h=null!==(n=t.ctrlKey)&&void 0!==n&&n,u=null!==(i=t.altKey)&&void 0!==i&&i,m=null!==(a=t.shiftKey)&&void 0!==a&&a,p=null!==(o=t.metaKey)&&void 0!==o&&o,g=null!==(r=e.ctrlKey)&&void 0!==r&&r,v=null!==(c=e.altKey)&&void 0!==c&&c,f=null!==(l=e.shiftKey)&&void 0!==l&&l,b=null!==(d=e.metaKey)&&void 0!==d&&d;if(t.ctrlOrCmd){if(s){if(!b||g!==h||v!==u||f!==m)return!1}else if(!g||b!==p||v!==u||f!==m)return!1;return!0}return b===p&&g===h&&v===u&&f===m}!function(e){e.Send="Send",e.SelectPrevSendHistory="SelectPrevSendHistory",e.SelectNextSendHistory="SelectNextSendHistory",e.EditPrevMessage="EditPrevMessage",e.EditNextMessage="EditNextMessage",e.CancelEditing="CancelEditing",e.FormatBold="FormatBold",e.FormatItalics="FormatItalics",e.FormatQuote="FormatQuote",e.EditUndo="EditUndo",e.EditRedo="EditRedo",e.NewLine="NewLine",e.MoveCursorToStart="MoveCursorToStart",e.MoveCursorToEnd="MoveCursorToEnd"}(c||(c={})),function(e){e.Complete="Complete",e.ForceComplete="ForceComplete",e.PrevSelection="PrevSelection",e.NextSelection="NextSelection",e.Cancel="Cancel"}(l||(l={})),function(e){e.ClearSearch="ClearSearch",e.PrevRoom="PrevRoom",e.NextRoom="NextRoom",e.SelectRoom="SelectRoom",e.CollapseSection="CollapseSection",e.ExpandSection="ExpandSection"}(d||(d={})),function(e){e.ScrollUp="ScrollUp",e.RoomScrollDown="RoomScrollDown",e.DismissReadMarker="DismissReadMarker",e.JumpToOldestUnread="JumpToOldestUnread",e.UploadFile="UploadFile",e.FocusSearch="FocusSearch",e.JumpToFirstMessage="JumpToFirstMessage",e.JumpToLatestMessage="JumpToLatestMessage"}(h||(h={})),function(e){e.FocusRoomSearch="FocusRoomSearch",e.ToggleRoomSidePanel="ToggleRoomSidePanel",e.ToggleUserMenu="ToggleUserMenu",e.ToggleShortCutDialog="ToggleShortCutDialog",e.GoToHome="GoToHome",e.SelectPrevRoom="SelectPrevRoom",e.SelectNextRoom="SelectNextRoom",e.SelectPrevUnreadRoom="SelectPrevUnreadRoom",e.SelectNextUnreadRoom="SelectNextUnreadRoom"}(u||(u={}));const p=new class{constructor(){i()(this,"bindingsProviders",[r])}getAction(e,t){for(const s of e){const e=s().find(e=>m(t,e.keyCombo,a.b));if(e)return e.action}}getMessageComposerAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getMessageComposerBindings),e)}getAutocompleteAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getAutocompleteBindings),e)}getRoomListAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getRoomListBindings),e)}getRoomAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getRoomBindings),e)}getNavigationAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getNavigationBindings),e)}};function g(){return p}},function(e,t,s){"use strict";let n,i,a;s.d(t,"b",(function(){return n})),s.d(t,"e",(function(){return i})),s.d(t,"a",(function(){return o})),s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return c})),function(e){e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce"}(n||(n={})),function(e){e.Highlight="highlight",e.Sound="sound"}(i||(i={})),function(e){e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<="}(a||(a={}));let o,r,c;!function(e){e.EventMatch="event_match",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission"}(o||(o={})),function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(r||(r={})),function(e){e.Master=".m.rule.master",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone"}(c||(c={}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return a}));function n(e){return o(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}function i(e){return o(e,"abcdefghijklmnopqrstuvwxyz")}function a(e){return o(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZ")}function o(e,t){let s="";for(let n=0;n<e;++n)s+=t.charAt(Math.floor(Math.random()*t.length));return s}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return c})),s.d(t,"d",(function(){return d})),s.d(t,"e",(function(){return h})),s.d(t,"b",(function(){return u}));var n=s(112),i=s(130),a=s(103),o=s(106);function r(e,t,s,n){let i;return null!=e&&e.getMxcAvatarUrl()&&(i=Object(a.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,s,n)),i||(i=d(e?e.userId:"")),i}function c(e,t,s,n){return e.avatarUrl?Object(a.b)(e.avatarUrl).getThumbnailOfSourceHttp(t,s,n):null}const l=new Map;function d(e){if(!e)return"";const t=["#8BC34A","#368bd6","#ac3ba8"];let s=0;for(let t=0;t<e.length;++t)s+=e.charCodeAt(t);const n=s%t.length,i="--avatar-background-colors_"+n,a=document.body.style.getPropertyValue(i)||t[n];let o=l.get(a);return o||(!function(e){return"string"==typeof e&&(7===e.length||9===e.length)&&"#"===e.charAt(0)&&!e.substr(1).split("").some(e=>isNaN(parseInt(e,16)))}(a)?o="":(o=function(e){const t=document.createElement("canvas");t.width=40,t.height=40;const s=t.getContext("2d");return s?(s.fillStyle=e,s.fillRect(0,0,40,40),t.toDataURL()):""}(a),l.set(a,o))),o}function h(e){if(!e)return void console.trace("`name` argument to `getInitialLetter` not supplied");if(e.length<1)return;const t=e[0];return"@"!==t&&"#"!==t&&"+"!==t||!e[1]||(e=e.substring(1)),Object(n.split)(e,"",1)[0].toUpperCase()}function u(e,t,s,n){if(!e)return null;if(e.getMxcAvatarUrl())return Object(a.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,s,n);if(o.a.spacesEnabled&&e.isSpaceRoom())return null;if(!i.a.shared().getUserIdForRoomId(e.roomId))return null;const r=e.getAvatarFallbackMember();return null!=r&&r.getMxcAvatarUrl()?Object(a.b)(r.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,s,n):null}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(93),l=s(90),d=s(84),h=s(453),u=s(88),m=s(85),p=s(113),g=s(97),v=s(101),f=s(96),b=s(109),y=s(525);let E=Object(m.a)("views.dialogs.BugReportDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"unmounted",void 0),a()(this,"onCancel",()=>{this.props.onFinished(!1)}),a()(this,"onSubmit",()=>{if(!(this.state.text&&this.state.text.trim()||this.state.issueUrl&&this.state.issueUrl.trim()))return void this.setState({err:Object(d.a)("Please tell us what went wrong or, better, create a GitHub issue that describes the problem.")});const e=(this.state.text.length>0?this.state.text+"\n\n":"")+"Issue: "+(this.state.issueUrl.length>0?this.state.issueUrl:"No issue link given");this.setState({busy:!0,progress:null,err:null}),this.sendProgressCallback(Object(d.a)("Preparing to send logs")),Object(h.a)(c.a.get().bug_report_endpoint_url,{userText:e,sendLogs:!0,progressCallback:this.sendProgressCallback,label:this.props.label}).then(()=>{this.unmounted||(this.props.onFinished(!1),l.a.createTrackedDialog("Bug report sent","",p.a,{title:Object(d.a)("Logs sent"),description:Object(d.a)("Thank you!"),hasCancelButton:!1}))},e=>{this.unmounted||this.setState({busy:!1,progress:null,err:Object(d.a)("Failed to send logs: ")+""+e.message})}),Object(y.b)(this.state.text,this.state.issueUrl,this.props.error)}),a()(this,"onDownload",async()=>{this.setState({downloadBusy:!0}),this.downloadProgressCallback(Object(d.a)("Preparing to download logs"));try{await Object(h.b)({sendLogs:!0,progressCallback:this.downloadProgressCallback,label:this.props.label}),this.setState({downloadBusy:!1,downloadProgress:null})}catch(e){this.unmounted||this.setState({downloadBusy:!1,downloadProgress:Object(d.a)("Failed to send logs: ")+""+e.message})}}),a()(this,"onTextChange",e=>{this.setState({text:e.currentTarget.value})}),a()(this,"onIssueUrlChange",e=>{this.setState({issueUrl:e.currentTarget.value})}),a()(this,"sendProgressCallback",e=>{this.unmounted||this.setState({progress:e})}),a()(this,"downloadProgressCallback",e=>{this.unmounted||this.setState({downloadProgress:e})}),this.state={sendLogs:!0,busy:!1,err:null,issueUrl:"",text:e.initialText||"",progress:null,downloadBusy:!1,downloadProgress:null},this.unmounted=!1}componentWillUnmount(){this.unmounted=!0}render(){let e=null;this.state.err&&(e=r.a.createElement("div",{className:"error"},this.state.err));let t,s=null;return this.state.busy&&(s=r.a.createElement("div",{className:"progress"},r.a.createElement(f.a,null),this.state.progress," ...")),window.Modernizr&&Object.values(window.Modernizr).some(e=>!1===e)&&(t=r.a.createElement("p",null,r.a.createElement("b",null,Object(d.a)("Reminder: Your browser is unsupported, so your experience may be unpredictable.")))),r.a.createElement(g.a,{className:"mx_BugReportDialog",onFinished:this.onCancel,title:Object(d.a)("Submit debug logs"),contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},t,r.a.createElement("p",null,Object(d.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),r.a.createElement("p",null,r.a.createElement("b",null,Object(d.a)("Before submitting logs, you must <a>create a GitHub issue</a> to describe your problem.",{},{a:e=>r.a.createElement("a",{target:"_blank",href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose"},e)}))),r.a.createElement("div",{className:"mx_BugReportDialog_download"},r.a.createElement(u.a,{onClick:this.onDownload,kind:"link",disabled:this.state.downloadBusy},Object(d.a)("Download logs")),this.state.downloadProgress&&r.a.createElement("span",null,this.state.downloadProgress," ...")),r.a.createElement(v.a,{type:"text",className:"mx_BugReportDialog_field_input",label:Object(d.a)("GitHub issue"),onChange:this.onIssueUrlChange,value:this.state.issueUrl,placeholder:"https://github.com/vector-im/element-web/issues/..."}),r.a.createElement(v.a,{className:"mx_BugReportDialog_field_input",element:"textarea",label:Object(d.a)("Notes"),rows:5,onChange:this.onTextChange,value:this.state.text,placeholder:Object(d.a)("If there is additional context that would help in analysing the issue, such as what you were doing at the time, room IDs, user IDs, etc., please include those things here.")}),s,e),r.a.createElement(b.a,{primaryButton:Object(d.a)("Send logs"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n=s(83),i=s.n(n),a=s(93),o=s(90),r=s(189),c=s.n(r),l=s(297),d=s(86),h=s(340),u=s.n(h),m=s(205),p=s(265),g=s(1);class v{constructor(e,t){this.apiUrl=e,this.uiUrl=t,i()(this,"scalarToken",void 0),i()(this,"termsInteractionCallback",void 0),i()(this,"isDefaultManager",void 0),this.scalarToken=null,this.termsInteractionCallback=void 0;const s=a.a.get().integrations_rest_url,n=a.a.get().integrations_ui_url;this.isDefaultManager=e===s&&n===t}writeTokenToStore(){window.localStorage.setItem("mx_scalar_token_at_"+this.apiUrl,this.scalarToken),this.isDefaultManager&&window.localStorage.removeItem("mx_scalar_token")}readTokenFromStore(){let e=window.localStorage.getItem("mx_scalar_token_at_"+this.apiUrl);return!e&&this.isDefaultManager&&(e=window.localStorage.getItem("mx_scalar_token")),e}readToken(){return this.scalarToken?this.scalarToken:this.readTokenFromStore()}setTermsInteractionCallback(e){this.termsInteractionCallback=e}connect(){return this.getScalarToken().then(e=>{this.scalarToken=e})}hasCredentials(){return null!=this.scalarToken}getScalarToken(){const e=this.readToken();return e?this.checkToken(e).catch(e=>{if(e instanceof l.b)throw e;return this.registerForToken()}):this.registerForToken()}getAccountName(e){const t=this.apiUrl+"/account";return new Promise((function(s,n){u()({method:"GET",uri:t,qs:{scalar_token:e,v:"1.1"},json:!0},(e,t,i)=>{e?n(e):i&&"M_TERMS_NOT_SIGNED"===i.errcode?n(new l.b):t.statusCode/100!=2?n(i):i&&i.user_id?s(i.user_id):n(new Error("Missing user_id in response"))})}))}checkToken(e){return this.getAccountName(e).then(t=>{const s=d.a.get().getUserId();if(t!==s)throw new Error("Scalar token is owned by someone else: "+s);return e}).catch(t=>{if(t instanceof l.b){g.a.log("Integration manager requires new terms to be agreed to");const t=c.a.parse(this.apiUrl);return t.path="",t.pathname="",Object(l.d)([new l.a(m.a.IM,c.a.format(t),e)],this.termsInteractionCallback).then(()=>e)}throw t})}registerForToken(){return d.a.get().getOpenIdToken().then(e=>this.exchangeForScalarToken(e)).then(e=>this.checkToken(e)).then(e=>(this.scalarToken=e,this.writeTokenToStore(),e))}exchangeForScalarToken(e){const t=this.apiUrl;return new Promise((function(s,n){u()({method:"POST",uri:t+"/register",qs:{v:"1.1"},body:e,json:!0},(e,t,i)=>{e?n(e):t.statusCode/100!=2?n(new Error("Scalar request failed: "+t.statusCode)):i&&i.scalar_token?s(i.scalar_token):n(new Error("Missing scalar_token in response"))})}))}getScalarPageTitle(e){let t=this.apiUrl+"/widgets/title_lookup";return t=this.getStarterLink(t),t+="&curl="+encodeURIComponent(e),new Promise((function(e,s){u()({method:"GET",uri:t,json:!0},(t,n,i)=>{if(t)s(t);else if(n.statusCode/100!=2)s(new Error("Scalar request failed: "+n.statusCode));else if(i){let t="";i.page_title_cache_item&&i.page_title_cache_item.cached_title&&(t=i.page_title_cache_item.cached_title),e(t)}else s(new Error("Missing page title in response"))})}))}disableWidgetAssets(e,t){let s=this.apiUrl+"/widgets/set_assets_state";return s=this.getStarterLink(s),new Promise((n,i)=>{u()({method:"GET",uri:s,json:!0,qs:{widget_type:e.preferred,widget_id:t,state:"disable"}},(e,t,s)=>{e?i(e):t.statusCode/100!=2?i(new Error("Scalar request failed: "+t.statusCode)):s?n():i(new Error("Failed to set widget assets state"))})})}getScalarInterfaceUrlForRoom(e,t,s){const n=e.roomId,i=e.name;let a=this.uiUrl;return a+="?scalar_token="+encodeURIComponent(this.scalarToken),a+="&room_id="+encodeURIComponent(n),a+="&room_name="+encodeURIComponent(i),a+="&theme="+encodeURIComponent(p.a.getCurrentTheme()),s&&(a+="&integ_id="+encodeURIComponent(s)),t&&(a+="&screen="+encodeURIComponent(t)),a}getStarterLink(e){return e+"?scalar_token="+encodeURIComponent(this.scalarToken)}}var f=s(89),b=s(492);let y;!function(e){e.Account="account",e.Config="config",e.Homeserver="homeserver"}(y||(y={}));class E{constructor(e,t,s=t,n){i()(this,"apiUrl",void 0),i()(this,"uiUrl",void 0),i()(this,"kind",void 0),i()(this,"id",void 0),this.kind=e,this.apiUrl=t,this.uiUrl=s,this.id=n}get name(){return c.a.parse(this.uiUrl).host}get trimmedApiUrl(){const e=c.a.parse(this.apiUrl);return e.pathname="",e.path="",c.a.format(e)}getScalarClient(){return new v(this.apiUrl,this.uiUrl)}async open(e=null,t=null,s=null){if(!f.b.getValue("integrationProvisioning"))return R.sharedInstance().showDisabledDialog();const n=o.a.createTrackedDialog("Integration Manager","",b.a,{loading:!0},"mx_IntegrationManager"),i=this.getScalarClient();i.setTermsInteractionCallback((e,t)=>Object(l.c)(e,t,"mx_TermsDialog_forIntegrationManager"));const a={};try{await i.connect(),i.hasCredentials()?a.url=i.getScalarInterfaceUrlForRoom(e,t,s):a.connected=!1}catch(e){if(e instanceof l.b)return void n.close();g.a.error(e),a.connected=!1}n.close(),o.a.createTrackedDialog("Integration Manager","",b.a,a,"mx_IntegrationManager")}}var S=s(731),_=s(732),w=s(734),C=s(152),O=s(143);const k=[y.Account,y.Homeserver,y.Config];class R{static sharedInstance(){return R.instance||(R.instance=new R),R.instance}constructor(){i()(this,"managers",[]),i()(this,"client",void 0),i()(this,"primaryManager",void 0),i()(this,"setupHomeserverManagers",async e=>{if(g.a.log("Updating homeserver-configured integration managers..."),e&&e["m.integrations"]){let t=e["m.integrations"].managers;Array.isArray(t)||(t=[]),g.a.log(`Homeserver has ${t.length} integration managers`),this.managers=this.managers.filter(e=>e.kind!==y.Homeserver);for(const e of t)e.api_url&&this.managers.push(new E(y.Homeserver,e.api_url,e.ui_url));this.primaryManager=null}else g.a.log("Homeserver has no integration managers")}),i()(this,"onAccountData",e=>{"m.widgets"===e.getType()&&this.compileManagers()}),this.compileManagers()}startWatching(){this.stopWatching(),this.client=d.a.get(),this.client.on("accountData",this.onAccountData),this.client.on("WellKnown.client",this.setupHomeserverManagers),this.compileManagers()}stopWatching(){this.client&&(this.client.removeListener("accountData",this.onAccountData),this.client.removeListener("WellKnown.client",this.setupHomeserverManagers))}compileManagers(){this.managers=[],this.setupConfiguredManager(),this.setupAccountManagers()}setupConfiguredManager(){const e=a.a.get().integrations_rest_url,t=a.a.get().integrations_ui_url;e&&t&&(this.managers.push(new E(y.Config,e,t)),this.primaryManager=null)}setupAccountManagers(){if(!this.client||!this.client.getUserId())return;C.a.getIntegrationManagerWidgets().forEach(e=>{const t=e.content.data;if(!t)return;const s=e.content.url,n=t.api_url;if(!n||!s)return;const i=new E(y.Account,n,s,e.id||e.state_key||"");this.managers.push(i)}),this.primaryManager=null}hasManager(){return this.managers.length>0}getOrderedManagers(){const e=[];for(const t of k){const s=this.managers.filter(e=>e.kind===t);s&&s.length&&(t===y.Account&&s.sort((e,t)=>Object(O.a)(e.id,t.id)),e.push(...s))}return e}getPrimaryManager(){return this.hasManager()?(this.primaryManager||(this.primaryManager=this.getOrderedManagers()[0]),this.primaryManager):null}openNoManagerDialog(){o.a.createTrackedDialog("Integrations impossible","",S.a)}openAll(e=null,t=null,s=null){return f.b.getValue("integrationProvisioning")?0===this.managers.length?this.openNoManagerDialog():void o.a.createTrackedDialog("Tabbed Integration Manager","",_.a,{room:e,screen:t,integrationId:s},"mx_TabbedIntegrationManagerDialog"):this.showDisabledDialog()}showDisabledDialog(){o.a.createTrackedDialog("Integrations disabled","",w.a)}async overwriteManagerOnAccount(e){await C.a.removeIntegrationManagerWidgets(),await C.a.addIntegrationManagerWidget(e.name,e.uiUrl,e.apiUrl)}async tryDiscoverManager(e){let t;g.a.log("Looking up integration manager via .well-known"),(e.startsWith("http:")||e.startsWith("https:"))&&(e=c.a.parse(e).host);try{const s=await fetch(`https://${e}/.well-known/matrix/integrations`);t=await s.json()}catch(e){return g.a.error(e),g.a.warn("Failed to locate integration manager"),null}if(!t||!t["m.integrations_widget"])return g.a.warn("Missing integrations widget on .well-known response"),null;const s=t["m.integrations_widget"];if(!s.url||!s.data||!s.data.api_url)return g.a.warn("Malformed .well-known response for integrations widget"),null;const n=new E(y.Account,s.data.api_url,s.url);return g.a.log("Got an integration manager (untested)"),n}}i()(R,"instance",void 0),window.mxIntegrationManagers=R},function(e,t,s){"use strict";s.d(t,"a",(function(){return T})),s.d(t,"c",(function(){return A})),s.d(t,"b",(function(){return U}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(94),c=s(87),l=s(107),d=s(84),h=s(90),u=s(132),m=s(715),p=s.n(m),g=s(1251),v=s.n(g),f=s(96),b=s(92),y=s(124),E=s(4),S=s(1253),_=s.n(S);class w{static get instance(){return w.internalInstance}constructor(){i()(this,"worker",void 0),i()(this,"seq",0),i()(this,"pendingDeferredMap",new Map),i()(this,"onMessage",e=>{const{seq:t,blurhash:s}=e.data,n=this.pendingDeferredMap.get(t);n&&(this.pendingDeferredMap.delete(t),n.resolve(s))}),this.worker=new _.a,this.worker.onmessage=this.onMessage}getBlurhash(e){const t=this.seq++,s=Object(E.l)();return this.pendingDeferredMap.set(t,s),this.worker.postMessage({seq:t,imageData:e}),s.promise}}i()(w,"internalInstance",new w);var C=s(89),O=s(716),k=s(1);function R(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function I(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?R(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):R(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const x=[0,0,22,37,0,0,22,37,1],T="xyz.amorgan.blurhash";class j extends Error{}async function N(e,t,s,n){let i,a=t,o=s;o>600&&(a=Math.floor(a*(600/o)),o=600),a>800&&(o=Math.floor(o*(800/a)),a=800),window.OffscreenCanvas?i=new window.OffscreenCanvas(a,o):(i=document.createElement("canvas"),i.width=a,i.height=o);const r=i.getContext("2d");let c;r.drawImage(e,0,0,a,o),c=window.OffscreenCanvas?i.convertToBlob({type:n}):new Promise(e=>i.toBlob(e,n));const l=r.getImageData(0,0,a,o),d=await w.instance.getBlurhash(l),h=await c;return{info:{thumbnail_info:{w:a,h:o,mimetype:h.type,size:h.size},w:t,h:s,[T]:d},thumbnail:h}}async function P(e,t,s){let n="image/png";"image/jpeg"===s.type&&(n="image/jpeg");const i=await async function(e){const t=document.createElement("img"),s=URL.createObjectURL(e),n=new Promise((e,n)=>{t.onload=function(){URL.revokeObjectURL(s),e(t)},t.onerror=function(e){n(e)}});let i;if(t.src=s,"image/png"===e.type){i=M(e).then(e=>{const t=new Uint8Array(e),s=v()(t);for(const e of s)if("pHYs"===e.name){if(e.data.byteLength!==x.length)return;return e.data.every((e,t)=>e===x[t])}return!1})}const[a]=await Promise.all([i,n]);return{width:a?t.width>>1:t.width,height:a?t.height>>1:t.height,img:t}}(s),a=await N(i.img,i.width,i.height,n),o=a.info,r=s.size-o.thumbnail_info.size;if(s.size<=32768||r<=65536&&r<=.1*s.size)return delete o.thumbnail_info,o;const c=await A(e,t,a.thumbnail);return o.thumbnail_url=c.url,o.thumbnail_file=c.file,o}function D(e,t,s){let n;return function(e){return new Promise((t,s)=>{const n=document.createElement("video");n.preload="metadata",n.playsInline=!0,n.muted=!0;const i=new FileReader;i.onload=function(e){n.onloadeddata=async function(){t(n),n.pause()},n.onerror=function(e){s(e)},n.src=e.target.result,n.load(),n.play()},i.onerror=function(e){s(e)},i.readAsDataURL(e)})}(s).then(e=>N(e,e.videoWidth,e.videoHeight,"image/jpeg")).then(s=>(n=s.info,A(e,t,s.thumbnail))).then(e=>(n.thumbnail_url=e.url,n.thumbnail_file=e.file,n))}function M(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=function(e){s(e)},n.readAsArrayBuffer(e)})}function A(e,t,s,n){let i=!1;if(e.isRoomEncrypted(t)){let t;const a=M(s).then((function(e){if(i)throw new j;return p.a.encryptAttachment(e)})).then((function(s){if(i)throw new j;const a=new Blob([s.data]);return t=e.uploadContent(a,{progressHandler:n,includeFilename:!1}),t.then(e=>{if(i)throw new j;return{file:I(I({},s.info),{},{url:e})}})}));return a.abort=()=>{i=!0,t&&e.cancelUpload(t)},a}{const t=e.uploadContent(s,{progressHandler:n}),a=t.then((function(e){if(i)throw new j;return{url:e}}));return a.abort=()=>{i=!0,e.cancelUpload(t)},a}}class U{constructor(){i()(this,"inprogress",[]),i()(this,"mediaConfig",null)}sendStickerContentToRoom(e,t,s,n,i){const a=y.a.getTimestamp(),o=i.sendStickerMessage(t,e,s,n).catch(s=>{throw k.a.warn(`Failed to send content with URL ${e} to room ${t}`,s),s});return y.a.instance.trackSendMessage(a,o,t,!1,!1,{msgtype:"m.sticker"}),o}getUploadLimit(){return null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]?this.mediaConfig["m.upload.size"]:null}async sendContentListToRoom(e,t,s,n){if(n.isGuest())return void c.a.dispatch({action:"require_registration"});if(Boolean(u.a.getQuotingEvent())){const e=l.getComponent("dialogs.QuestionDialog"),{finished:t}=h.a.createTrackedDialog("Upload Reply Warning","",e,{title:Object(d.a)("Replying With Files"),description:o.a.createElement("div",null,Object(d.a)("At this time it is not possible to reply with a file. Would you like to upload this file without replying?")),hasCancelButton:!0,button:Object(d.a)("Continue")}),[s]=await t;if(!s)return}if(!this.mediaConfig){const e=h.a.createDialog(f.a,null,"mx_Dialog_spinner");await this.ensureMediaConfigFetched(n),e.close()}const i=[],a=[];for(let t=0;t<e.length;++t)this.isFileSizeAcceptable(e[t])?a.push(e[t]):i.push(e[t]);if(i.length>0){const t=l.getComponent("dialogs.UploadFailureDialog"),{finished:s}=h.a.createTrackedDialog("Upload Failure","",t,{badFiles:i,totalFiles:e.length,contentMessages:this}),[n]=await s;if(!n)return}let r=!1,m=Promise.resolve();for(let e=0;e<a.length;++e){const i=a[e];if(!r){const t=l.getComponent("dialogs.UploadConfirmDialog"),{finished:s}=h.a.createTrackedDialog("Upload Files confirmation","",t,{file:i,currentIndex:e,totalFiles:a.length}),[n,o]=await s;if(!n)break;o&&(r=!0)}m=this.sendContentToRoom(i,t,s,n,m)}}getCurrentUploads(e){return this.inprogress.filter(t=>{const s=!e&&!t.relation,n=e&&t.relation&&e.rel_type===t.relation.rel_type&&e.event_id===t.relation.event_id;return(s||n)&&!t.canceled})}cancelUpload(e,t){let s;for(let t=0;t<this.inprogress.length;++t)if(this.inprogress[t].promise===e){s=this.inprogress[t];break}s&&(s.canceled=!0,t.cancelUpload(s.promise),c.a.dispatch({action:b.a.UploadCanceled,upload:s}))}sendContentToRoom(e,t,s,n,i){const a=y.a.getTimestamp(),o={body:e.name||"Attachment",info:{size:e.size},msgtype:""};s&&(o["m.relates_to"]=s),C.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(O.a)(o),e.type&&(o.info.mimetype=e.type);const u=new Promise(s=>{0===e.type.indexOf("image/")?(o.msgtype=r.b.Image,P(n,t,e).then(e=>{Object.assign(o.info,e),s()},e=>{k.a.error(e),o.msgtype=r.b.File,s()})):0===e.type.indexOf("audio/")?(o.msgtype=r.b.Audio,s()):0===e.type.indexOf("video/")?(o.msgtype=r.b.Video,D(n,t,e).then(e=>{Object.assign(o.info,e),s()},e=>{o.msgtype=r.b.File,s()})):(o.msgtype=r.b.File,s())});u.abort=()=>{m.canceled=!0};const m={fileName:e.name||"Attachment",roomId:t,relation:s,total:e.size,loaded:0,promise:u};function p(e){m.total=e.total,m.loaded=e.loaded,c.a.dispatch({action:b.a.UploadProgress,upload:m})}let g;return this.inprogress.push(m),c.a.dispatch({action:b.a.UploadStarted,upload:m}),c.a.fire(b.a.FocusSendMessageComposer),u.then((function(){if(m.canceled)throw new j;return m.promise=A(n,t,e,p),m.promise.then((function(e){o.file=e.file,o.url=e.url}))})).then(()=>i).then((function(){if(m.canceled)throw new j;const e=(null==s?void 0:s.rel_type)===r.c.Thread?s.event_id:null,i=n.sendMessage(t,e,o);return C.b.getValue("Performance.addSendMessageTimingMetadata")&&i.then(e=>{Object(O.b)(n,t,e.event_id)}),y.a.instance.trackSendMessage(a,i,t,!1,!1,o),i}),(function(e){if(g=e,!m.canceled){let t=Object(d.a)("The file '%(fileName)s' failed to upload.",{fileName:m.fileName});413===e.http_status&&(t=Object(d.a)("The file '%(fileName)s' exceeds this homeserver's size limit for uploads",{fileName:m.fileName}));const s=l.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Upload failed","",s,{title:Object(d.a)("Upload Failed"),description:t})}})).finally(()=>{for(let e=0;e<this.inprogress.length;++e)if(this.inprogress[e].promise===m.promise){this.inprogress.splice(e,1);break}g?(g&&413===g.http_status&&(this.mediaConfig=null),c.a.dispatch({action:b.a.UploadFailed,upload:m,error:g})):(c.a.dispatch({action:b.a.UploadFinished,upload:m}),c.a.dispatch({action:"message_sent"}))})}isFileSizeAcceptable(e){return!(null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]&&e.size>this.mediaConfig["m.upload.size"])}ensureMediaConfigFetched(e){if(null===this.mediaConfig)return k.a.log("[Media Config] Fetching"),e.getMediaConfig().then(e=>(k.a.log("[Media Config] Fetched config:",e),e)).catch(()=>(k.a.log("[Media Config] Could not fetch config, so not limiting uploads."),{})).then(e=>{this.mediaConfig=e})}static sharedInstance(){return void 0===window.mxContentMessages&&(window.mxContentMessages=new U),window.mxContentMessages}}},function(e,t,s){"use strict";s.d(t,"d",(function(){return p})),s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return v})),s.d(t,"c",(function(){return f}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a),r=s(123),c=s(116),l=s(153);class d{constructor(e){this.context=e,i()(this,"clipStart",0),i()(this,"stopped",!0),i()(this,"lastCheck",0),i()(this,"observable",new l.SimpleObservable),i()(this,"timerId",void 0),i()(this,"clipDuration",0),i()(this,"placeholderDuration",0),i()(this,"checkTime",(e=!1)=>{const t=this.timeSeconds;(this.lastCheck!==t||e)&&(this.observable.update([t,this.durationSeconds]),this.lastCheck=t)})}get durationSeconds(){return this.clipDuration||this.placeholderDuration}set durationSeconds(e){this.clipDuration=e,this.observable.update([this.timeSeconds,this.clipDuration])}get timeSeconds(){return(this.context.currentTime-this.clipStart)%this.clipDuration}get liveData(){return this.observable}populatePlaceholdersFrom(e){var t;const s=Number(null===(t=e.getContent().info)||void 0===t?void 0:t.duration);Number.isFinite(s)&&(this.placeholderDuration=s/1e3)}flagLoadTime(){this.clipStart=this.context.currentTime}flagStart(){this.stopped&&(this.clipStart=this.context.currentTime,this.stopped=!1),this.timerId||(this.timerId=setInterval(this.checkTime,100))}flagStop(){this.stopped=!0,this.clipStart=this.context.currentTime}syncTo(e,t){this.clipStart=e-t,this.stopped=!1,this.checkTime(!0)}destroy(){this.observable.close(),this.timerId&&clearInterval(this.timerId)}}var h=s(750),u=s(233),m=s(1);let p;!function(e){e.Decoding="decoding",e.Stopped="stopped",e.Paused="paused",e.Playing="playing"}(p||(p={}));const g=39,v=Object(c.h)(0,g);class f extends o.a{constructor(e,t=v){super(),this.buf=e,i()(this,"thumbnailWaveform",void 0),i()(this,"context",void 0),i()(this,"source",void 0),i()(this,"state",p.Decoding),i()(this,"audioBuf",void 0),i()(this,"element",void 0),i()(this,"resampledWaveform",void 0),i()(this,"waveformObservable",new l.SimpleObservable),i()(this,"clock",void 0),i()(this,"fileSize",void 0),i()(this,"onPlaybackEnd",async()=>{await this.context.suspend(),this.emit(p.Stopped)}),this.fileSize=this.buf.byteLength,this.context=Object(h.a)(),this.resampledWaveform=Object(c.c)(null!=t?t:v,g),this.thumbnailWaveform=Object(c.c)(null!=t?t:v,100),this.waveformObservable.update(this.resampledWaveform),this.clock=new d(this.context)}get sizeBytes(){return this.fileSize}get waveform(){return this.resampledWaveform}get waveformData(){return this.waveformObservable}get clockInfo(){return this.clock}get currentState(){return this.state}get isPlaying(){return this.currentState===p.Playing}emit(e,...t){return this.state=e,super.emit(e,...t),super.emit(r.b,e,...t),!0}destroy(){this.stop(),this.removeAllListeners(),this.clock.destroy(),this.waveformObservable.close(),this.element&&(URL.revokeObjectURL(this.element.src),this.element.remove())}async prepare(){if(this.buf.byteLength>5242880){m.a.log("Audio file too large: processing through <audio /> element"),this.element=document.createElement("AUDIO");const e=new Promise((e,t)=>{this.element.onloadeddata=()=>e(null),this.element.onerror=e=>t(e)});this.element.src=URL.createObjectURL(new Blob([this.buf])),await e}else{this.audioBuf=await new Promise((e,t)=>{this.context.decodeAudioData(this.buf,t=>e(t),async s=>{try{m.a.error("Error decoding recording: ",s),m.a.warn("Trying to re-encode to WAV instead...");const n=await Object(h.b)(this.buf);this.context.decodeAudioData(n,t=>e(t),e=>{m.a.error("Still failed to decode recording: ",e),t(e)})}catch(s){m.a.error("Caught decoding error:",s),t(s)}})});const e=Array.from(this.audioBuf.getChannelData(0));this.resampledWaveform=function(e){const t=e.map(e=>Math.abs(e));return Object(c.g)(Object(c.i)(t,g),0,1)}(e)}this.waveformObservable.update(this.resampledWaveform),this.clock.flagLoadTime(),this.clock.durationSeconds=this.element?this.element.duration:this.audioBuf.duration,this.emit(p.Stopped)}async play(){this.state===p.Stopped&&(this.disconnectSource(),this.makeNewSourceBuffer(),this.element?await this.element.play():this.source.start()),await this.context.resume(),this.clock.flagStart(),this.emit(p.Playing)}disconnectSource(){var e,t;this.element||(null===(e=this.source)||void 0===e||e.disconnect(),null===(t=this.source)||void 0===t||t.removeEventListener("ended",this.onPlaybackEnd))}makeNewSourceBuffer(){this.element&&this.source||(this.element?this.source=this.context.createMediaElementSource(this.element):(this.source=this.context.createBufferSource(),this.source.buffer=this.audioBuf),this.source.addEventListener("ended",this.onPlaybackEnd),this.source.connect(this.context.destination))}async pause(){await this.context.suspend(),this.emit(p.Paused)}async stop(){await this.onPlaybackEnd(),this.clock.flagStop()}async toggle(){this.isPlaying?await this.pause():await this.play()}async skipTo(e){e=Object(u.a)(e,0,this.clock.durationSeconds);const t=this.isPlaying;t&&await this.context.suspend();const s=this.context.currentTime;this.disconnectSource(),this.makeNewSourceBuffer(),this.clock.syncTo(s,e),this.element?this.element.currentTime=e:this.source.start(s,e),t?await this.context.resume():await this.pause()}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return G})),s.d(t,"c",(function(){return H})),s.d(t,"d",(function(){return q})),s.d(t,"b",(function(){return z}));var n=s(99),i=s.n(n),a=s(5),o=s(1065),r=s(117),c=s(1066),l=s(163),d=s(339),h=s(1067),u=s(4),m=s(157),p=s(250),g=s(251),v=s(149),f=s(343),b=s(1073),y=s(1),E=s(205),S=s(288),_=s(347),w=s(353),C=s(352),O=s(223),k=s(287),R=s(1659),I=s(607),x=s(156),T=s(1088),j=s(602),N=s(354),P=s(94),D=s(127),M=s(1089),A=s(197),U=s(608),L=s(1660),F=s(609),B=s(196),V=s(1090);function K(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function W(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?K(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):K(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const G=Object(_.c)();let H,q;var $;!function(e){e.Chronological="chronological",e.Detached="detached"}(H||(H={})),function(e){e.Stable="stable",e.Unstable="unstable"}(q||(q={})),function(e){e.MasterKey="master_key",e.SelfSigningKey="self_signing_key",e.UserSigningKey="user_signing_key"}($||($={}));class z extends a.EventEmitter{constructor(e){super(),i()(this,"reEmitter",new f.a(this)),i()(this,"olmVersion",null),i()(this,"usingExternalCrypto",!1),i()(this,"store",void 0),i()(this,"deviceId",void 0),i()(this,"credentials",void 0),i()(this,"pickleKey",void 0),i()(this,"scheduler",void 0),i()(this,"clientRunning",!1),i()(this,"timelineSupport",!1),i()(this,"urlPreviewCache",{}),i()(this,"unstableClientRelationAggregation",!1),i()(this,"identityServer",void 0),i()(this,"sessionStore",void 0),i()(this,"http",void 0),i()(this,"crypto",void 0),i()(this,"cryptoCallbacks",void 0),i()(this,"callEventHandler",void 0),i()(this,"supportsCallTransfer",!1),i()(this,"forceTURN",!1),i()(this,"iceCandidatePoolSize",0),i()(this,"idBaseUrl",void 0),i()(this,"baseUrl",void 0),i()(this,"canSupportVoip",!1),i()(this,"peekSync",null),i()(this,"isGuestAccount",!1),i()(this,"ongoingScrollbacks",{}),i()(this,"notifTimelineSet",null),i()(this,"cryptoStore",void 0),i()(this,"verificationMethods",void 0),i()(this,"fallbackICEServerAllowed",!1),i()(this,"roomList",void 0),i()(this,"syncApi",void 0),i()(this,"pushRules",void 0),i()(this,"syncLeftRoomsPromise",void 0),i()(this,"syncedLeftRooms",!1),i()(this,"clientOpts",void 0),i()(this,"clientWellKnownIntervalID",void 0),i()(this,"canResetTimelineCallback",void 0),i()(this,"pushProcessor",new p.a(this)),i()(this,"serverVersionsPromise",void 0),i()(this,"cachedCapabilities",void 0),i()(this,"clientWellKnown",void 0),i()(this,"clientWellKnownPromise",void 0),i()(this,"turnServers",[]),i()(this,"turnServersExpiry",0),i()(this,"checkTurnServersIntervalID",void 0),i()(this,"exportedOlmDeviceToImport",void 0),i()(this,"txnCtr",0),i()(this,"mediaHandler",new V.a),i()(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.off("sync",this.startCallEventHandler))}),e.baseUrl=u.o(e.baseUrl),e.idBaseUrl=u.o(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.usingExternalCrypto=e.usingExternalCrypto,this.store=e.store||new c.a,this.deviceId=e.deviceId||null;const t=e.userId||null;this.credentials={userId:t},this.http=new S.d(this,{baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:S.h,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?y.a.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?y.a.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):y.a.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(async e=>{const t=this.getRoom(e.getRoomId());e.status!==r.a.SENDING&&this.updatePendingEventStatus(t,e,r.a.SENDING);const s=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,r.a.SENT,s.event_id),s});Object(l.g)(this,void 0,void 0)&&(this.callEventHandler=new h.a(this),this.canSupportVoip=!0,this.on("sync",this.startCallEventHandler)),this.timelineSupport=Boolean(e.timelineSupport),this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this.cryptoStore=e.cryptoStore,this.sessionStore=e.sessionStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.roomList=new b.a(this.cryptoStore),this.on("Event.decrypted",e=>{const t=e.getPushActions(),s=this.pushProcessor.actionsForEvent(e);e.setPushActions(s);const n=this.getRoom(e.getRoomId());if(!n)return;const i=n.getUnreadNotificationCount(x.NotificationCountType.Highlight),a=!(!t||!t.tweaks)&&!!t.tweaks.highlight,o=!(!s||!s.tweaks)&&!!s.tweaks.highlight;if((a!==o||i>0)&&!n.hasUserReadEvent(this.getUserId(),e.getId())){let e=i;o&&!a&&e++,!o&&a&&e--,n.setUnreadNotificationCount(x.NotificationCountType.Highlight,e);n.getUnreadNotificationCount(x.NotificationCountType.Total)<e&&n.setUnreadNotificationCount(x.NotificationCountType.Total,e)}}),this.on("Room.receipt",(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const s=e.getContent();if(!(Object.keys(s).filter(e=>Object.keys(s[e]["m.read"]).includes(this.getUserId())).length>0))return;const n=20,i=t.getLiveTimeline().getEvents();let a=0;for(let e=i.length-1;e>=0;e--){if(e===i.length-n)return;const s=i[e];if(t.hasUserReadEvent(this.getUserId(),s.getId()))break;const o=this.getPushActionsForEvent(s);a+=o.tweaks&&o.tweaks.highlight?1:0}t.setUnreadNotificationCount("highlight",a)}})}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new O.a(t)),this.crypto&&(this.crypto.uploadDeviceKeys(),this.crypto.start()),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},6e5),this.checkTurnServers()),this.syncApi&&(y.a.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop()),this.clientOpts=Object.assign({},e),this.clientOpts.crypto=this.crypto,this.clientOpts.canResetEntireTimeline=e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),this.syncApi=new o.a(this,this.clientOpts),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown())}stopClient(){var t,s,n,i;y.a.log("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=null,null===(s=this.crypto)||void 0===s||s.stop(),null===(n=this.peekSync)||void 0===n||n.stopPeeking(),null===(i=this.callEventHandler)||void 0===i||i.stop(),this.callEventHandler=null,e.clearInterval(this.checkTurnServersIntervalID),void 0!==this.clientWellKnownIntervalID&&e.clearInterval(this.clientWellKnownIntervalID)}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const t=await this.getDehydratedDevice();if(!t)return;if(!t.device_data||!t.device_id)return void y.a.info("no dehydrated device found");const s=new e.Olm.Account;try{const e=t.device_data;if(e.algorithm!==I.a)return void y.a.warn("Wrong algorithm for dehydrated device");y.a.log("unpickling dehydrated device");const n=await this.cryptoCallbacks.getDehydrationKey(e,t=>{s.unpickle(new Uint8Array(t),e.account)});s.unpickle(n,e.account),y.a.log("unpickled device");if(!0===(await this.http.authedRequest(void 0,"POST","/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=t.device_id,y.a.info("using dehydrated device");const e=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:s.pickle(e),sessions:[],pickleKey:e},s.free(),this.deviceId}return s.free(),void y.a.info("not using dehydrated device")}catch(e){s.free(),y.a.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(void 0,"GET","/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void y.a.info("could not get dehydrated device",e.toString())}}async setDehydrationKey(e,t,s){if(this.crypto)return await this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,s);y.a.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,s){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,s),await this.crypto.dehydrationManager.dehydrateDevice();y.a.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};y.a.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}createCall(e){return Object(l.g)(this,e)}getSyncState(){return this.syncApi?this.syncApi.getSyncState():null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===j.a.Prepared||e===j.a.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){return this.syncApi.retryImmediately()}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=(new Date).getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(y.a.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(void 0,"GET","/capabilities").catch(e=>(y.a.error(e),null)).then(e=>{e||(e={});const s=e.capabilities||{},n=Object.keys(s).length?216e5:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:s,expiration:t+n},y.a.log("Caching capabilities: ",s),s})}async initCrypto(){if(!Object(_.c)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.crypto)return void y.a.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");y.a.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),y.a.log("Crypto: initialising roomlist..."),await this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new _.a(this,this.sessionStore,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","crypto.willUpdateDevices","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),y.a.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=_.a.getOlmVersion(),t.registerEventHandlers(this),this.crypto=t}isCryptoEnabled(){return!!this.crypto}getDeviceEd25519Key(){return this.crypto?this.crypto.getDeviceEd25519Key():null}getDeviceCurve25519Key(){return this.crypto?this.crypto.getDeviceCurve25519Key():null}async uploadKeys(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.uploadDeviceKeys()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,s=!0){const n=this.setDeviceVerification(e,t,s,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t,s=!0){return this.setDeviceVerification(e,t,null,s,null)}setDeviceKnown(e,t,s=!0){return this.setDeviceVerification(e,t,null,null,s)}async setDeviceVerification(e,t,s,n,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,s,n,i)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,s)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalBlacklistUnverifiedDevices(e)}getGlobalBlacklistUnverifiedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalBlacklistUnverifiedDevices()}setGlobalErrorOnUnknownDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalErrorOnUnknownDevices(e)}getGlobalErrorOnUnknownDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalErrorOnUnknownDevices()}getCrossSigningId(e=T.a.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,s)}prepareToEncrypt(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.prepareToEncrypt(e)}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,s)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,s)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e,t)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}cancelAndResendEventRoomKeyRequest(e){return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents(P.a.RoomEncryption,"")||this.roomList.isRoomEncrypted(e)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.crypto?this.crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:S.i})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}try{U.a.checkBackupVersion(e)}catch(e){throw e}return e}isKeyBackupTrusted(e){return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:s,auth_data:n,recovery_key:i,privateKey:a}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.storeSecret("m.megolm_backup.v1",Object(v.encodeBase64)(a)),y.a.info("Key backup private key stored in secret storage")),{algorithm:s,auth_data:n,recovery_key:i}}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1",!1))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const s=await this.http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:S.i});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||y.a.error("Key backup not usable even though we just created it"),s}deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const t=u.n("/room_keys/version/$version",{$version:e});return this.http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:S.i})}makeKeyBackupPath(e,t,s){let n;n=void 0!==t?u.n("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?u.n("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:n,queryData:void 0===s?void 0:{version:s}}}sendKeyBackup(e,t,s,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,s);return this.http.authedRequest(void 0,"PUT",i.path,i.queryData,n,{prefix:S.i})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Object(w.a)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return Object(C.b)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Object(w.a)(e)}async restoreKeyBackupWithPassword(e,t,s,n,i){const a=await Object(C.b)(n.auth_data,e);return this.restoreKeyBackup(a,t,s,n,i)}async restoreKeyBackupWithSecretStorage(e,t,s,n){const i=await this.getSecret("m.megolm_backup.v1"),a=Object(_.b)(i);if(a){const[e]=await this.crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",a,[e])}const o=Object(v.decodeBase64)(a||i);return this.restoreKeyBackup(o,t,s,e,n)}restoreKeyBackupWithRecoveryKey(e,t,s,n,i){const a=Object(w.a)(e);return this.restoreKeyBackup(a,t,s,n,i)}async restoreKeyBackupWithCache(e,t,s,n){const i=await this.crypto.getSessionBackupPrivateKey();if(!i)throw new Error("Couldn't get key");return this.restoreKeyBackup(i,e,t,s,n)}async restoreKeyBackup(e,t,s,n,i){const a=null==i?void 0:i.cacheCompleteCallback,o=null==i?void 0:i.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let r=0,c=[];const l=this.makeKeyBackupPath(t,s,n.version),d=await U.a.makeAlgorithm(n,async()=>e),h=d.untrusted;try{if(!await d.keyMatches(e))return Promise.reject(new S.c({errcode:z.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch(e=>{y.a.warn("Error caching session backup key:",e)}).then(a),o&&o({stage:"fetch"});const n=await this.http.authedRequest(void 0,"GET",l.path,l.queryData,void 0,{prefix:S.i});if(n.rooms){const e=n.rooms;for(const[t,s]of Object.entries(e)){if(!s.sessions)continue;r+=Object.keys(s.sessions).length;const e=await d.decryptSessions(s.sessions);for(const s of e)s.room_id=t,c.push(s)}}else if(n.sessions){const e=n.sessions;r=Object.keys(e).length,c=await d.decryptSessions(e);for(const e of c)e.room_id=t}else{r=1;try{const[e]=await d.decryptSessions({[s]:n});e.room_id=t,e.session_id=s,c.push(e)}catch(e){y.a.log("Failed to decrypt megolm session from backup",e)}}}finally{d.free()}return await this.importRoomKeys(c,{progressCallback:o,untrusted:h,source:"backup"}),await this.checkKeyBackup(),{total:r,imported:c.length}}deleteKeysFromBackup(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.makeKeyBackupPath(e,t,s);return this.http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:S.i})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=this.roomList.getRoomEncryption(e);if(!s)return void y.a.error("Unknown room.  Not sharing decryption keys");const n=await this.crypto.downloadKeys(t),i={};for(const[e,t]of Object.entries(n))i[e]=Object.values(t);const a=this.crypto.getRoomDecryptor(e,s.algorithm);a.sendSharedHistoryInboundSessions?await a.sendSharedHistoryInboundSessions(i):y.a.warn("Algorithm does not support sharing previous keys",s.algorithm)}getGroup(e){return this.store.getGroup(e)}getGroups(){return this.store.getGroups()}getMediaConfig(e){return this.http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:S.g})}getRoom(e){return this.store.getRoom(e)}getRooms(){return this.store.getRooms()}getVisibleRooms(){const e=this.store.getRooms(),t=new Set;for(const s of e){const e=s.currentState.getStateEvents(P.a.RoomCreate,"");if(e){const s=e.getContent().predecessor;s&&s.room_id&&t.add(s.room_id)}}return e.filter(e=>!e.currentState.getStateEvents(P.a.RoomTombstone,"")||!t.has(e.roomId))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t,s){const n=u.n("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),i=Object(S.j)(5,()=>this.http.authedRequest(void 0,"PUT",n,void 0,t));return s&&i.then(e=>s(null,e),s),i}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=u.n("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(void 0,"GET",t,void 0)}catch(e){if(e.data&&"M_NOT_FOUND"===e.data.errcode)return null;throw e}}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e,t){const s={ignored_users:{}};return e.map(e=>s.ignored_users[e]={}),this.setAccountData("m.ignored_user_list",s,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t,s){if(u.u(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);let i=Promise.resolve();t.inviteSignUrl&&(i=this.http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));const a={};t.viaServers&&(a.server_name=t.viaServers);const r={qsStringifyOptions:{arrayFormat:"repeat"}};try{const n={},c=await i;c&&(n.third_party_signed=c);const l=u.n("/join/$roomid",{$roomid:e}),d=(await this.http.authedRequest(void 0,"POST",l,a,n,r)).room_id,h=new o.a(this,this.clientOpts).createRoom(d);return t.syncRoom,null==s||s(null,h),h}catch(e){throw null==s||s(e),e}}resendEvent(e,t){return this.updatePendingEventStatus(t,e,r.a.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if([r.a.QUEUED,r.a.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,r.a.CANCELLED)}setRoomName(e,t,s){return this.sendStateEvent(e,P.a.RoomName,{name:t},void 0,s)}setRoomTopic(e,t,s){return this.sendStateEvent(e,P.a.RoomTopic,{topic:t},void 0,s)}getRoomTags(e,t){const s=u.n("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(t,"GET",s,void 0)}setRoomTag(e,t,s,n){const i=u.n("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(n,"PUT",i,void 0,s)}deleteRoomTag(e,t,s){const n=u.n("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(s,"DELETE",n,void 0,void 0)}setRoomAccountData(e,t,s,n){const i=u.n("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(n,"PUT",i,void 0,s)}setPowerLevel(e,t,s,n,i){let a={users:{}};(null==n?void 0:n.getType())===P.a.RoomPowerLevels&&(a=u.j(n.getContent())),a.users[t]=s;const o=u.n("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(i,"PUT",o,void 0,a)}sendEvent(e,t,s,n,i,a){var o;return null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(a=i,i=n,n=s,s=t,t=null),this.sendCompleteEvent(e,t,{type:s,content:n},i,a)}sendCompleteEvent(e,t,s,n,i){u.u(n)&&(i=n,n=void 0),n||(n=this.makeTxnId());const a=new r.b(Object.assign(s,{event_id:"~"+e+":"+n,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),c=null==o?void 0:o.threads.get(t);c&&a.setThread(c);const l=a.getAssociatedId();if(l&&l.startsWith("~")){const e=o.getPendingEvents().find(e=>e.getId()===l);e.once("Event.localEventIdReplaced",()=>{a.updateAssociatedId(e.getId())})}const d=a.getType();return y.a.log(`sendEvent of type ${d} in ${e} with txnId ${n}`),a.setTxnId(n),a.setStatus(r.a.SENDING),o&&o.addPendingEvent(a,n),a.status===r.a.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,a,i)}encryptAndSendEvent(e,t,s){return Promise.resolve().then(()=>{const s=this.encryptEventIfNeeded(t,e);return s?(this.updatePendingEventStatus(e,t,r.a.ENCRYPTING),s.then(()=>this.updatePendingEventStatus(e,t,r.a.SENDING))):null}).then(()=>{let s;return this.scheduler&&(s=this.scheduler.queueEvent(t),s&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,r.a.QUEUED)),s||(s=this.sendEventHttpRequest(t),e&&(s=s.then(s=>(e.updatePendingEvent(t,r.a.SENT,s.event_id),s)))),s}).then(e=>(null==s||s(null,e),e)).catch(n=>{y.a.error("Error sending event",n.stack||n);try{t.error=n,this.updatePendingEventStatus(e,t,r.a.NOT_SENT),n.event=t,null==s||s(n)}catch(e){y.a.error("Exception in error handler!",e.stack||n)}throw n})}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.crypto&&this.usingExternalCrypto)return null;if(e.getType()===P.a.Reaction)return null;if(!this.crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.crypto.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===P.a.Reaction?t:this.isRoomEncrypted(e)?P.a.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,s){e?e.updatePendingEvent(t,s):t.setStatus(s)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const s={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let n;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),n=u.n(t,s)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";n=u.n(t,Object.assign({$redactsEventId:e.event.redacts},s))}else n=u.n("/rooms/$roomId/send/$eventType/$txnId",s);return this.http.authedRequest(void 0,"PUT",n,void 0,e.getWireContent()).then(t=>(y.a.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t))}redactEvent(e,t,s,n,i){s&&!s.startsWith("$")||(i=n,n=s,s=t,t=null);const a=("object"==typeof i?i:{}).reason,o="function"==typeof i?i:void 0;return this.sendCompleteEvent(e,t,{type:P.a.RoomRedaction,content:{reason:a},redacts:s},n,o)}sendMessage(e,t,s,n,i){return"string"!=typeof t&&null!==t&&(i=n,n=s,s=t,t=null),u.u(n)&&(i=n,n=void 0),this.sendEvent(e,t,P.a.RoomMessage,s,n,i)}sendTextMessage(e,t,s,n,i){var a;null!==(a=t)&&void 0!==a&&a.startsWith("$")||null===t||(i=n,n=s,s=t,t=null);const o=N.makeTextMessage(s);return this.sendMessage(e,t,o,n,i)}sendNotice(e,t,s,n,i){var a;null!==(a=t)&&void 0!==a&&a.startsWith("$")||null===t||(i=n,n=s,s=t,t=null);const o=N.makeNotice(s);return this.sendMessage(e,t,o,n,i)}sendEmoteMessage(e,t,s,n,i){var a;null!==(a=t)&&void 0!==a&&a.startsWith("$")||null===t||(i=n,n=s,s=t,t=null);const o=N.makeEmoteMessage(s);return this.sendMessage(e,t,o,n,i)}sendImageMessage(e,t,s,n,i="Image",a){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(a=i,i=n||"Image",n=s,s=t,t=null),u.u(i)&&(a=i,i=void 0);const r={msgtype:P.b.Image,url:s,info:n,body:i};return this.sendMessage(e,t,r,void 0,a)}sendStickerMessage(e,t,s,n,i="Sticker",a){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(a=i,i=n||"Sticker",n=s,s=t,t=null),u.u(i)&&(a=i,i=void 0);const r={url:s,info:n,body:i};return this.sendEvent(e,t,P.a.Sticker,r,void 0,a)}sendHtmlMessage(e,t,s,n,i){var a;null!==(a=t)&&void 0!==a&&a.startsWith("$")||null===t||(i=n,n=s,s=t,t=null);const o=N.makeHtmlMessage(s,n);return this.sendMessage(e,t,o,void 0,i)}sendHtmlNotice(e,t,s,n,i){var a;null!==(a=t)&&void 0!==a&&a.startsWith("$")||null===t||(i=n,n=s,s=t,t=null);const o=N.makeHtmlNotice(s,n);return this.sendMessage(e,t,o,void 0,i)}sendHtmlEmote(e,t,s,n,i){var a;null!==(a=t)&&void 0!==a&&a.startsWith("$")||null===t||(i=n,n=s,s=t,t=null);const o=N.makeHtmlEmote(s,n);return this.sendMessage(e,t,o,void 0,i)}sendReceipt(e,t,s,n){if("function"==typeof s&&(n=s,s={}),this.isGuest())return Promise.resolve({});const i=u.n("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),a=this.http.authedRequest(n,"POST",i,void 0,s||{}),o=this.getRoom(e.getRoomId());return o&&o.addLocalEchoReceipt(this.credentials.userId,e,t),a}async sendReadReceipt(e,t,s){"function"==typeof t&&(s=t,t={}),t||(t={});const n=e.getId(),i=this.getRoom(e.getRoomId());if(i&&i.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);const a={"org.matrix.msc2285.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",a,s)}async setRoomReadMarkers(e,t,s,n){const i=this.getRoom(e);if(i&&i.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let a;if(s){if(a=s.getId(),i&&i.hasPendingEvent(a))throw new Error(`Cannot set read receipt to a pending event (${a})`);i&&i.addLocalEchoReceipt(this.credentials.userId,s,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,a,n)}getUrlPreview(e,t,s){t=6e4*Math.floor(t/6e4);const n=new URL(e);n.hash="";const i=t+"_"+(e=n.toString()),a=this.urlPreviewCache[i];if(a)return s&&a.then(s).catch(s),a;const o=this.http.authedRequest(s,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:S.g});return this.urlPreviewCache[i]=o,o}sendTyping(e,t,s,n){if(this.isGuest())return Promise.resolve({});const i=u.n("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),a={typing:t};return t&&(a.timeout=s||2e4),this.http.authedRequest(n,"PUT",i,void 0,a)}getRoomUpgradeHistory(e,t=!1){let s=this.getRoom(e);if(!s)return[];const n=[s];let i=s.currentState.getStateEvents(P.a.RoomCreate,"");for(;i;){const e=i.getContent().predecessor;if(!e||!e.room_id)break;{const s=this.getRoom(e.room_id);if(!s)break;if(t){const e=s.currentState.getStateEvents(P.a.RoomTombstone,"");if(!e||e.getContent().replacement_room!==s.roomId)break}n.splice(0,0,s),i=s.currentState.getStateEvents(P.a.RoomCreate,"")}}let a=s.currentState.getStateEvents(P.a.RoomTombstone,"");for(;a;){const e=this.getRoom(a.getContent().replacement_room);if(!e)break;if(e.roomId===s.roomId)break;if(t){if(i=e.currentState.getStateEvents(P.a.RoomCreate,""),!i||!i.getContent().predecessor)break;if(i.getContent().predecessor.room_id!==s.roomId)break}n.push(e);if(new Set(n.map(e=>e.roomId)).size<n.length)return n.slice(0,n.length-1);s=e,a=s.currentState.getStateEvents(P.a.RoomTombstone,"")}return n}invite(e,t,s,n){return this.membershipChange(e,t,"invite",n,s)}inviteByEmail(e,t,s){return this.inviteByThreePid(e,"email",t,s)}async inviteByThreePid(e,t,s,n){const i=u.n("/rooms/$roomId/invite",{$roomId:e}),a=this.getIdentityServerUrl(!0);if(!a)return Promise.reject(new S.c({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const o={id_server:a,medium:t,address:s};if(this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(o.id_access_token=e)}return this.http.authedRequest(n,"POST",i,void 0,o)}leave(e,t){return this.membershipChange(e,void 0,"leave",void 0,t)}leaveRoomChain(e,t=!0){const s=this.getRoomUpgradeHistory(e);let n=s;if(!t){n=[];for(const t of s)if(n.push(t),t.roomId===e)break}const i={},a=[],o=e=>this.leave(e).then(()=>{i[e]=null}).catch(t=>(i[e]=t,null));for(const e of n)a.push(o(e.roomId));return Promise.all(a).then(()=>i)}ban(e,t,s,n){return this.membershipChange(e,t,"ban",s,n)}forget(e,t,s){void 0===t&&(t=!0);const n=this.membershipChange(e,void 0,"forget",void 0,s);return t?n.then(t=>(this.store.removeRoom(e),this.emit("deleteRoom",e),t)):n}unban(e,t,s){const n=u.n("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(s,"POST",n,void 0,i)}kick(e,t,s,n){const i=u.n("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:s};return this.http.authedRequest(n,"POST",i,void 0,a)}setMembershipState(e,t,s,n,i){u.u(n)&&(i=n,n=void 0);const a=u.n("/rooms/$roomId/state/m.room.member/$userId",{$roomId:e,$userId:t});return this.http.authedRequest(i,"PUT",a,void 0,{membership:s,reason:n})}membershipChange(e,t,s,n,i){u.u(n)&&(i=n,n=void 0);const a=u.n("/rooms/$room_id/$membership",{$room_id:e,$membership:s});return this.http.authedRequest(i,"POST",a,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){return e.getPushActions()||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t,s){const n=u.n("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(s,"PUT",n,void 0,t)}async setDisplayName(e,t){const s=await this.setProfileInfo("displayname",{displayname:e},t),n=this.getUser(this.getUserId());return n&&(n.displayName=e,n.emit("User.displayName",n.events.presence,n)),s}async setAvatarUrl(e,t){const s=await this.setProfileInfo("avatar_url",{avatar_url:e},t),n=this.getUser(this.getUserId());return n&&(n.avatarUrl=e,n.emit("User.avatarUrl",n.events.presence,n)),s}mxcUrlToHttp(e,t,s,n,i){return Object(k.a)(this.baseUrl,e,t,s,n,i)}_unstable_setStatusMessage(e){const t="im.vector.user_status";return Promise.all(this.getRooms().map(async s=>{const n="join"===s.getMyMembership(),i=2===s.getInvitedAndJoinedMemberCount();if(!n||!i)return;s.currentState.mayClientSendStateEvent(t,this)&&await this.sendStateEvent(s.roomId,t,{status:e},this.getUserId())})).then()}setPresence(e,t){const s=u.n("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this.http.authedRequest(t,"PUT",s,void 0,e)}getPresence(e,t){const s=u.n("/presence/$userId/status",{$userId:e});return this.http.authedRequest(t,"GET",s,void 0,void 0)}scrollback(e,t,s){u.u(t)&&(s=t,t=void 0),t=t||30;let n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;n=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const a=this.store.scrollback(e,t).length;if(a===t)return Promise.resolve(e);t-=a;const o=new Promise((i,a)=>{Object(u.I)(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,m.a.Backward)).then(t=>{var n;const a=t.chunk.map(this.getEventMapper());if(t.state){const s=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(s)}const[o,r]=this.partitionThreadedEvents(a);e.addEventsToTimeline(o,!0,e.getLiveTimeline()),this.processThreadEvents(e,r),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,a,t.end,!0),this.ongoingScrollbacks[e.roomId]=null,null===(n=s)||void 0===n||n(null,e),i(e)}).catch(t=>{var n;this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},null===(n=s)||void 0===n||n(t),a(t)})});return i={promise:o,errorTs:null},this.ongoingScrollbacks[e.roomId]=i,o}getEventMapper(e){return Object(M.a)(this,e||{})}getEventTimeline(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));const s=u.n("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let n=void 0;this.clientOpts.lazyLoadMembers&&(n={filter:JSON.stringify(d.a.LAZY_LOADING_MESSAGES_FILTER)});return this.http.authedRequest(void 0,"GET",s,n).then(s=>{if(!s.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);s.events_after.reverse();const n=s.events_after.concat([s.event]).concat(s.events_before).map(this.getEventMapper());let i=e.getTimelineForEvent(n[0].getId());if(i){const e=s.state.map(this.getEventMapper());i.getState(m.b.BACKWARDS).setUnknownStateEvents(e)}else i=e.addTimeline(),i.initialiseState(s.state.map(this.getEventMapper())),i.getState(m.b.FORWARDS).paginationToken=s.end;const[a,o]=this.partitionThreadedEvents(n);return e.addEventsToTimeline(a,!0,i,s.start),this.processThreadEvents(e.room,o),e.getTimelineForEvent(t)||i})}createMessagesRequest(e,t,s,n,i){const a=u.n("/rooms/$roomId/messages",{$roomId:e});void 0===s&&(s=30);const o={from:t,limit:s,dir:n};let r=null;var c;(this.clientOpts.lazyLoadMembers&&(r=Object.assign({},d.a.LAZY_LOADING_MESSAGES_FILTER)),i)&&(r=r||{},Object.assign(r,null===(c=i.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON()));return r&&(o.filter=JSON.stringify(r)),this.http.authedRequest(void 0,"GET",a,o)}paginateEventTimeline(e,t){const s=e.getTimelineSet()===this.notifTimelineSet,n=(t=t||{}).backwards||!1;if(s&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");const i=n?m.b.BACKWARDS:m.b.FORWARDS,a=e.getPaginationToken(i);if(!a)return Promise.resolve(!1);const o=e.paginationRequests[i];if(o)return o;let r,c,l;if(s)r="/notifications",c={limit:"limit"in t?t.limit:30,only:"highlight"},a&&"end"!==a&&(c.from=a),l=this.http.authedRequest(void 0,"GET","/notifications",c,void 0).then(t=>{const s=t.next_token,a=[];for(let e=0;e<t.notifications.length;e++){const s=t.notifications[e],n=this.getEventMapper()(s.event);n.setPushActions(p.a.actionListToActionsObject(s.actions)),n.event.room_id=s.room_id,a[e]=n}const[o,r]=this.partitionThreadedEvents(a),c=e.getTimelineSet();return c.addEventsToTimeline(o,n,e,s),this.processThreadEvents(c.room,r),n&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token}).finally(()=>{e.paginationRequests[i]=null}),e.paginationRequests[i]=l;else{const s=this.getRoom(e.getRoomId());if(!s)throw new Error("Unknown room "+e.getRoomId());l=this.createMessagesRequest(e.getRoomId(),a,t.limit,i,e.getFilter()),l.then(t=>{if(t.state){const s=e.getState(i),n=t.state.map(this.getEventMapper());s.setUnknownStateEvents(n)}const a=t.end,o=t.chunk.map(this.getEventMapper()),[r,c]=this.partitionThreadedEvents(o);return e.getTimelineSet().addEventsToTimeline(r,n,e,a),this.processThreadEvents(s,c),n&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start}).finally(()=>{e.paginationRequests[i]=null}),e.paginationRequests[i]=l}return l}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end",null)}peekInRoom(e){return this.peekSync&&this.peekSync.stopPeeking(),this.peekSync=new o.a(this,this.clientOpts),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const s=this.sendStateEvent(e,P.a.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},"");let n=Promise.resolve(void 0);return t.allowRead&&(n=this.sendStateEvent(e,P.a.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([n,s]).then()}requestRegisterEmailToken(e,t,s,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})}requestRegisterMsisdnToken(e,t,s,n,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})}requestAdd3pidEmailToken(e,t,s,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})}requestAdd3pidMsisdnToken(e,t,s,n,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})}requestPasswordEmailToken(e,t,s,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})}requestPasswordMsisdnToken(e,t,s,n,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})}async requestTokenFromEndpoint(e,t){const s=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){const e=new URL(this.idBaseUrl);if(s.id_server=e.host,this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(s.id_access_token=e)}}return this.http.request(void 0,"POST",e,void 0,s)}getRoomPushRule(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let s=0;s<this.pushRules[e].room.length;s++){const n=this.pushRules[e].room[s];if(n.rule_id===t)return n}}setRoomMutePushRule(e,t,s){let n,i;const a=this.getRoomPushRule(e,t);if(a&&0<=a.actions.indexOf("dont_notify")&&(i=!0),s?a?i||(n=u.l(),this.deletePushRule(e,B.c.RoomSpecific,a.rule_id).then(()=>{this.addPushRule(e,B.c.RoomSpecific,t,{actions:["dont_notify"]}).then(()=>{n.resolve()}).catch(e=>{n.reject(e)})}).catch(e=>{n.reject(e)}),n=n.promise):n=this.addPushRule(e,B.c.RoomSpecific,t,{actions:["dont_notify"]}):i&&(n=this.deletePushRule(e,B.c.RoomSpecific,a.rule_id)),n)return new Promise((e,t)=>{n.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(s=>{this.pushRules=s,t(e)}).catch(s=>{t(e)})})})}searchMessageText(e,t){const s={search_term:e.query};return"keys"in e&&(s.keys=e.keys),this.search({body:{search_categories:{room_events:s}}},t)}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:F.a.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},s={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(s,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},s=this.search(t).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=null});return e.pendingRequest=s,s}processRoomEventsSearch(e,t){const s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;const n={};s.highlights.forEach(e=>{n[e]=1}),e.highlights.forEach(e=>{n[e]=1}),e.highlights=Object.keys(n);const i=s.results?s.results.length:0;for(let t=0;t<i;t++){const n=R.a.fromJson(s.results[t],this.getEventMapper()),i=this.getRoom(n.context.getEvent().getRoomId());if(i)for(const e of n.context.getTimeline()){const t=i.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(n)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new o.a(this,this.clientOpts);return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(e=>{y.a.log("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=null}),this.syncLeftRoomsPromise}createFilter(e){const t=u.n("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,"POST",t,void 0,e).then(t=>{const s=d.a.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(s),s})}getFilter(e,t,s){if(s){const s=this.store.getFilter(e,t);if(s)return Promise.resolve(s)}const n=u.n("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(void 0,"GET",n,void 0,void 0).then(s=>{const n=d.a.fromJson(e,t,s);return this.store.storeFilter(n),n})}async getOrCreateFilter(e,t){const s=this.store.getFilterIdByName(e);let n=void 0;if(s){try{const e=await this.getFilter(this.credentials.userId,s,!0);if(e){const i=e.getDefinition(),a=t.getDefinition();u.i(i,a)&&(n=s)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const i=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,i.filterId),i.filterId}getOpenIdToken(){const e=u.n("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,"POST",e,void 0,{})}turnServer(e){return this.http.authedRequest(e,"GET","/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}async checkTurnServers(){if(!this.canSupportVoip)return;let t=!1;const s=this.turnServersExpiry-Date.now();if(s>6e5)y.a.debug("TURN creds are valid for another "+s+" ms: not fetching new ones."),t=!0;else{y.a.debug("Fetching new TURN credentials");try{const e=await this.turnServer();if(e.uris){y.a.log("Got TURN URIs: "+e.uris+" refresh in "+e.ttl+" secs");const s={urls:e.uris,username:e.username,credential:e.password};this.turnServers=[s],this.turnServersExpiry=Date.now()+1e3*e.ttl,t=!0}}catch(t){y.a.error("Failed to get TURN URIs",t),403===t.httpStatus&&(y.a.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&e.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null)}}return t}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=u.n("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){const t=u.n("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=u.n("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){this.clientWellKnownPromise=g.a.getRawClientConfig(this.getDomain()),this.clientWellKnown=await this.clientWellKnownPromise,this.emit("WellKnown.client",this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(([t,s])=>e.includes(typeof s)).reduce((e,[t,s])=>(e[t]=s,e),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){if(!await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"))throw Error("Server does not support shared_rooms API");const t=u.n("/uk.half-shot.msc2666/user/shared_rooms/$userId",{$userId:e});return(await this.http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:S.i})).joined}getVersions(){return this.serverVersionsPromise||(this.serverVersionsPromise=this.http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(e=>{throw this.serverVersionsPromise=null,e})),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.5.0")||s&&s["m.lazy_load_members"]}async doesServerRequireIdServerParam(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const s=e.unstable_features;return!s||(void 0===s["m.require_identity_server"]||s["m.require_identity_server"])}async doesServerAcceptIdentityAccessToken(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.6.0")||s&&s["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.6.0")||s&&s["m.separate_add_and_bind"]}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features;return s&&!!s[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features,n=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return s&&!!s["io.element.e2ee_forced."+n]}hasLazyLoadMembersEnabled(){return!!this.clientOpts.lazyLoadMembers}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,s,n,i){const a=this.getEncryptedIfNeededEventType(e,n),o=await this.fetchRelations(e,t,s,a,i),r=this.getEventMapper();let c;o.original_event&&(c=r(o.original_event));let l=o.chunk.map(r);if(a===P.a.RoomMessageEncrypted){const e=c?l.concat(c):l;await Promise.all(e.map(e=>{if(e.isEncrypted())return new Promise(t=>e.once("Event.decrypted",t))})),l=l.filter(e=>e.getType()===n)}return c&&s===P.c.Replace&&(l=l.filter(e=>e.getSender()===c.getSender())),{originalEvent:c,events:l,nextBatch:o.next_batch}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return Object(A.b)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&e.attemptDecryption(this.crypto,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case E.a.IS:return t+S.f+"/terms";case E.a.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=u.o(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(void 0,"GET","/register/available",{username:e}).then(e=>e.available)}register(e,t,s,n,i,a,o,r){!0===i?i={email:!0}:null!=i&&!1!==i||(i={}),"function"==typeof o&&(r=o,o=void 0),s&&(n.session=s);const c={auth:n};return null!=e&&(c.username=e),null!=t&&(c.password=t),i.email&&(c.bind_email=!0),i.msisdn&&(c.bind_msisdn=!0),null!=a&&(c.guest_access_token=a),null!=o&&(c.inhibit_login=o),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,r)}registerGuest(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)}registerRequest(e,t,s){const n={};return t&&(n.kind=t),this.http.request(s,"POST","/register",n,e)}loginFlows(e){return this.http.request(e,"GET","/login")}login(e,t,s){const n={type:e};return u.q(n,t),this.http.authedRequest((e,t)=>{t&&t.access_token&&t.user_id&&(this.http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),s&&s(e,t)},"POST","/login",void 0,n)}loginWithPassword(e,t,s){return this.login("m.login.password",{user:e,password:t},s)}loginWithSAML2(e,t){return this.login("m.login.saml2",{relay_state:e},t)}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",s){let n="/login/"+t+"/redirect";return s&&(n+="/"+s),this.http.getUrl(n,{redirectUrl:e},S.h)}loginWithToken(e,t){return this.login("m.login.token",{token:e},t)}logout(e){return this.http.authedRequest(e,"POST","/logout")}deactivateAccount(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const s={};return e&&(s.auth=e),void 0!==t&&(s.erase=t),this.http.authedRequest(void 0,"POST","/account/deactivate",void 0,s)}getFallbackAuthUrl(e,t){const s=u.n("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(s,{session:t},S.h)}async createRoom(e,t){const s=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(s.length>0&&this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of s)t.id_access_token=e}return this.http.authedRequest(t,"POST","/createRoom",void 0,e)}async fetchRelations(e,t,s,n,i){const a={};i.from&&(a.from=i.from);const o=u.m(a),r=u.n("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+o,{$roomId:e,$eventId:t,$relationType:s,$eventType:n});return await this.http.authedRequest(void 0,"GET",r,null,null,{prefix:S.i})}roomState(e,t){const s=u.n("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(t,"GET",s)}fetchRoomEvent(e,t,s){const n=u.n("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(s,"GET",n)}members(e,t,s,n,i){const a={};t&&(a.membership=t),s&&(a.not_membership=s),n&&(a.at=n);const o=u.m(a),r=u.n("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest(i,"GET",r)}upgradeRoom(e,t){const s=u.n("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(void 0,"POST",s,void 0,{new_version:t})}getStateEvent(e,t,s,n){const i={$roomId:e,$eventType:t,$stateKey:s};let a=u.n("/rooms/$roomId/state/$eventType",i);return void 0!==s&&(a=u.n(a+"/$stateKey",i)),this.http.authedRequest(n,"GET",a)}sendStateEvent(e,t,s,n="",i){const a={$roomId:e,$eventType:t,$stateKey:n};let o=u.n("/rooms/$roomId/state/$eventType",a);return void 0!==n&&(o=u.n(o+"/$stateKey",a)),this.http.authedRequest(i,"PUT",o,void 0,s)}roomInitialSync(e,t,s){u.u(t)&&(s=t,t=void 0);const n=u.n("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this.http.authedRequest(s,"GET",n,{limit:t})}setRoomReadMarkersHttpRequest(e,t,s,n){const i=u.n("/rooms/$roomId/read_markers",{$roomId:e}),a={"m.fully_read":t,"m.read":s,"org.matrix.msc2285.hidden":Boolean(!!n&&n.hidden)};return this.http.authedRequest(void 0,"POST",i,void 0,a)}getJoinedRooms(){const e=u.n("/joined_rooms",{});return this.http.authedRequest(void 0,"GET",e)}getJoinedRoomMembers(e){const t=u.n("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(void 0,"GET",t)}publicRooms(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const s={};return e.server&&(s.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(s).length?this.http.authedRequest(t,"GET","/publicRooms"):this.http.authedRequest(t,"POST","/publicRooms",s,e)}createAlias(e,t,s){const n=u.n("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(s,"PUT",n,void 0,i)}deleteAlias(e,t){const s=u.n("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,"DELETE",s,void 0,void 0)}unstableGetLocalAliases(e,t){const s=u.n("/rooms/$roomId/aliases",{$roomId:e}),n=S.i+"/org.matrix.msc2432";return this.http.authedRequest(t,"GET",s,null,null,{prefix:n})}getRoomIdForAlias(e,t){const s=u.n("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,"GET",s)}resolveRoomAlias(e,t){const s=u.n("/directory/room/$alias",{$alias:e});return this.http.request(t,"GET",s)}getRoomDirectoryVisibility(e,t){const s=u.n("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(t,"GET",s)}setRoomDirectoryVisibility(e,t,s){const n=u.n("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(s,"PUT",n,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,s,n){const i=u.n("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(n,"PUT",i,void 0,{visibility:s})}searchUserDirectory(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this.http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t,s){u.u(t)&&(s=t,t=void 0);const n=t?u.n("/profile/$userId/$info",{$userId:e,$info:t}):u.n("/profile/$userId",{$userId:e});return this.http.authedRequest(s,"GET",n)}getThreePids(e){return this.http.authedRequest(e,"GET","/account/3pid",void 0,void 0)}addThreePid(e,t,s){const n={threePidCreds:e,bind:t};return this.http.authedRequest(s,"POST","/account/3pid",null,n)}async addThreePidOnly(e){const t=await this.isVersionSupported("r0.6.0")?S.h:S.i;return this.http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})}async bindThreePid(e){const t=await this.isVersionSupported("r0.6.0")?S.h:S.i;return this.http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})}async unbindThreePid(e,t){const s={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},n=await this.isVersionSupported("r0.6.0")?S.h:S.i;return this.http.authedRequest(void 0,"POST","/account/3pid/unbind",null,s,{prefix:n})}deleteThreePid(e,t){return this.http.authedRequest(void 0,"POST","/account/3pid/delete",null,{medium:e,address:t})}setPassword(e,t,s){const n={auth:e,new_password:t};return this.http.authedRequest(s,"POST","/account/password",null,n)}getDevices(){return this.http.authedRequest(void 0,"GET","/devices",void 0,void 0)}getDevice(e){const t=u.n("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,"GET",t,void 0,void 0)}setDeviceDetails(e,t){const s=u.n("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,"PUT",s,void 0,t)}deleteDevice(e,t){const s=u.n("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(void 0,"DELETE",s,void 0,n)}deleteMultipleDevices(e,t){const s={devices:e};t&&(s.auth=t);return this.http.authedRequest(void 0,"POST","/delete_devices",void 0,s)}getPushers(e){return this.http.authedRequest(e,"GET","/pushers",void 0,void 0)}setPusher(e,t){return this.http.authedRequest(t,"POST","/pushers/set",null,e)}getPushRules(e){return this.http.authedRequest(e,"GET","/pushrules/").then(e=>p.a.rewriteDefaultRules(e))}addPushRule(e,t,s,n,i){const a=u.n("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this.http.authedRequest(i,"PUT",a,void 0,n)}deletePushRule(e,t,s,n){const i=u.n("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this.http.authedRequest(n,"DELETE",i)}setPushRuleEnabled(e,t,s,n,i){const a=u.n("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:s});return this.http.authedRequest(i,"PUT",a,void 0,{enabled:n})}setPushRuleActions(e,t,s,n,i){const a=u.n("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:s});return this.http.authedRequest(i,"PUT",a,void 0,{actions:n})}search(e,t){const s={};return e.next_batch&&(s.next_batch=e.next_batch),this.http.authedRequest(t,"POST","/search",s,e.body)}uploadKeysRequest(e,t,s){return this.http.authedRequest(s,"POST","/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:S.i})}downloadKeysForUsers(e,t){if(u.u(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const s={device_keys:{}};return"token"in(t=t||{})&&(s.token=t.token),e.forEach(e=>{s.device_keys[e]=[]}),this.http.authedRequest(void 0,"POST","/keys/query",void 0,s)}claimOneTimeKeys(e,t="signed_curve25519",s){const n={};void 0===t&&(t="signed_curve25519");for(let s=0;s<e.length;++s){const i=e[s][0],a=e[s][1],o=n[i]||{};n[i]=o,o[a]=t}const i={one_time_keys:n};s&&(i.timeout=s);return this.http.authedRequest(void 0,"POST","/keys/claim",void 0,i)}getKeyChanges(e,t){const s={from:e,to:t};return this.http.authedRequest(void 0,"GET","/keys/changes",s,void 0)}uploadDeviceSigningKeys(e,t){const s=Object.assign({},t);return e&&Object.assign(s,{auth:e}),this.http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,s,{prefix:S.i})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.idBaseUrl+S.f+"/account/register";return this.http.requestOtherUrl(void 0,"POST",t,null,e)}async requestEmailToken(e,t,s,n,i,a){const o={client_secret:t,email:e,send_attempt:s,next_link:n};return await this.http.idServerRequest(i,"POST","/validate/email/requestToken",o,S.f,a)}async requestMsisdnToken(e,t,s,n,i,a,o){const r={client_secret:s,country:e,phone_number:t,send_attempt:n,next_link:i};return await this.http.idServerRequest(a,"POST","/validate/msisdn/requestToken",r,S.f,o)}async submitMsisdnToken(e,t,s,n){const i={sid:e,client_secret:t,token:s};return await this.http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,S.f,n)}submitMsisdnTokenOtherUrl(e,t,s,n){const i={sid:t,client_secret:s,token:n};return this.http.requestOtherUrl(void 0,"POST",e,void 0,i)}getIdentityHashDetails(e){return this.http.idServerRequest(void 0,"GET","/hash_details",null,S.f,e)}async identityHashedLookup(t,s){const n={},i=await this.getIdentityHashDetails(s);if(!i||!i.lookup_pepper||!i.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=i.lookup_pepper;const a={};if(i.algorithms.includes("sha256")){const s=new e.Olm.Utility;n.addresses=t.map(e=>{const t=e[0].toLowerCase(),i=e[1].toLowerCase(),o=s.sha256(`${t} ${i} ${n.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return a[o]=e[0],o}),n.algorithm="sha256"}else{if(!i.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n.addresses=t.map(e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return a[t]=e[0],t}),n.algorithm="none"}const o=await this.http.idServerRequest(void 0,"POST","/lookup",n,S.f,s);if(!o||!o.mappings)return[];const r=[];for(const e of Object.keys(o.mappings)){const t=o.mappings[e],s=a[e];if(!s)throw new Error("Identity server returned more results than expected");r.push({address:s,mxid:t})}return r}async lookupThreePid(e,t,s,n){const i=(await this.identityHashedLookup([[t,e]],n)).find(e=>e.address===t);if(!i)return s&&s(null,{}),{};const a={address:t,medium:e,mxid:i.mxid};return s&&s(null,a),a}async bulkLookupThreePids(e,t){const s=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),n=[];for(const t of s){const s=e.find(e=>e[1]===t.address);if(!s)throw new Error("Identity sever returned unexpected results");n.push([s[0],t.address,t.mxid])}return{threepids:n}}getIdentityAccount(e){return this.http.idServerRequest(void 0,"GET","/account",void 0,S.f,e)}sendToDevice(e,t,s){const n=u.n("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:s||this.makeTxnId()}),i={messages:t},a=Object.keys(t).reduce((e,s)=>(e[s]=Object.keys(t[s]),e),{});return y.a.log("PUT "+n,a),this.http.authedRequest(void 0,"PUT",n,void 0,i)}getThirdpartyProtocols(){return this.http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then(e=>{if(!e||"object"!=typeof e)throw new Error("/thirdparty/protocols did not return an object: "+e);return e})}getThirdpartyLocation(e,t){const s=u.n("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(void 0,"GET",s,t,void 0)}getThirdpartyUser(e,t){const s=u.n("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(void 0,"GET",s,t,void 0)}getTerms(e,t){const s=this.termsUrlForService(e,t);return this.http.requestOtherUrl(void 0,"GET",s)}agreeToTerms(e,t,s,n){const i=this.termsUrlForService(e,t),a={Authorization:"Bearer "+s};return this.http.requestOtherUrl(void 0,"POST",i,null,{user_accepts:n},{headers:a})}reportEvent(e,t,s,n){const i=u.n("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(void 0,"POST",i,null,{score:s,reason:n})}getSpaceSummary(e,t,s,n,i,a){const o=u.n("/rooms/$roomId/spaces",{$roomId:e});return this.http.authedRequest(void 0,"POST",o,null,{max_rooms_per_space:t,suggested_only:s,auto_join_only:n,limit:i,batch:a},{prefix:"/_matrix/client/unstable/org.matrix.msc2946"})}getRoomHierarchy(e,t,s,n=!1,i){const a=u.n("/rooms/$roomId/hierarchy",{$roomId:e});return this.http.authedRequest(void 0,"GET",a,{suggested_only:n,max_depth:s,from:i,limit:t},void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"}).catch(s=>{if("M_UNRECOGNIZED"===s.errcode)return this.getSpaceSummary(e,void 0,n,void 0,t).then(({rooms:e,events:t})=>{const s=new Map(e.map(e=>[e.room_id,W(W({},e),{},{children_state:[]})]));return t.forEach(e=>{var t;null===(t=s.get(e.room_id))||void 0===t||t.children_state.push(e)}),{rooms:Array.from(s.values())}});throw s})}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:D.d.PrivateChat,power_level_content_override:W(W({},L.a),{},{users:{[this.getUserId()]:100}}),creation_content:{[P.d]:P.e.Space},initial_state:[{type:P.h.name,state_key:P.k.name,content:{[P.g.name]:!0}},{type:P.a.RoomEncryption,state_key:"",content:{algorithm:v.MEGOLM_ALGORITHM}}]});return new L.b(this,t)}unstableGetFileTreeSpace(e){var t,s;const n=this.getRoom(e);if("join"!==(null==n?void 0:n.getMyMembership()))return null;const i=n.currentState.getStateEvents(P.a.RoomCreate,""),a=n.currentState.getStateEvents(P.h.name,P.k.name);if(!i)throw new Error("Expected single room create event");return null!=a&&null!==(t=a.getContent())&&void 0!==t&&t[P.g.name]?(null===(s=i.getContent())||void 0===s?void 0:s[P.d])!==P.e.Space?null:new L.b(this,e):null}getGroupSummary(e){const t=u.n("/groups/$groupId/summary",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupProfile(e){const t=u.n("/groups/$groupId/profile",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}setGroupProfile(e,t){const s=u.n("/groups/$groupId/profile",{$groupId:e});return this.http.authedRequest(void 0,"POST",s,void 0,t)}setGroupJoinPolicy(e,t){const s=u.n("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this.http.authedRequest(void 0,"PUT",s,void 0,{"m.join_policy":t})}getGroupUsers(e){const t=u.n("/groups/$groupId/users",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupInvitedUsers(e){const t=u.n("/groups/$groupId/invited_users",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupRooms(e){const t=u.n("/groups/$groupId/rooms",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}inviteUserToGroup(e,t){const s=u.n("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"PUT",s,void 0,{})}removeUserFromGroup(e,t){const s=u.n("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"PUT",s,void 0,{})}addUserToGroupSummary(e,t,s){const n=u.n(s?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:s,$userId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{})}removeUserFromGroupSummary(e,t){const s=u.n("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"DELETE",s,void 0,{})}addRoomToGroupSummary(e,t,s){const n=u.n(s?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:s,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{})}removeRoomFromGroupSummary(e,t){const s=u.n("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"DELETE",s,void 0,{})}addRoomToGroup(e,t,s){void 0===s&&(s=!0);const n=u.n("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:s?"public":"private"}})}updateGroupRoomVisibility(e,t,s){const n=u.n("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{type:s?"public":"private"})}removeRoomFromGroup(e,t){const s=u.n("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"DELETE",s,void 0,{})}acceptGroupInvite(e,t=null){const s=u.n("/groups/$groupId/self/accept_invite",{$groupId:e});return this.http.authedRequest(void 0,"PUT",s,void 0,t||{})}joinGroup(e){const t=u.n("/groups/$groupId/self/join",{$groupId:e});return this.http.authedRequest(void 0,"PUT",t,void 0,{})}leaveGroup(e){const t=u.n("/groups/$groupId/self/leave",{$groupId:e});return this.http.authedRequest(void 0,"PUT",t,void 0,{})}getJoinedGroups(){const e=u.n("/joined_groups",{});return this.http.authedRequest(void 0,"GET",e)}createGroup(e){const t=u.n("/create_group",{});return this.http.authedRequest(void 0,"POST",t,void 0,e)}getPublicisedGroups(e){const t=u.n("/publicised_groups",{});return this.http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})}setGroupPublicity(e,t){const s=u.n("/groups/$groupId/self/update_publicity",{$groupId:e});return this.http.authedRequest(void 0,"PUT",s,void 0,{publicise:t})}supportsExperimentalThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}async getRoomSummary(e,t){const s=u.n("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(void 0,"GET",s,{via:t},null,{qsStringifyOptions:{arrayFormat:"repeat"},prefix:"/_matrix/client/unstable/im.nheko.summary"})}partitionThreadedEvents(e){const t=new Set;return this.supportsExperimentalThreads()?e.reduce((s,n)=>{const i=this.getRoom(n.getRoomId());let a=n.isThreadRelation;if(a)t.add(n.relationEventId);else{const o=n.parentEventId,r=(null==i?void 0:i.findEventById(o))||e.find(e=>e.getId()===o);a=null==r?void 0:r.isThreadRelation;((null==r?void 0:r.isThreadRoot)||t.has(n.relationEventId))&&!n.isThreadRelation&&n.relationEventId&&s[1].push(n)}return s[a?1:0].push(n),s},[[],[]]):[e,[]]}processThreadEvents(e,t){t.sort((e,t)=>e.getTs()-t.getTs()).forEach(t=>{e.addThreadedEvent(t)})}}i()(z,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}).call(this,s(26))},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM"}(n||(n={}))},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(205),c=s(156),l=s(86),d=s(90),h=s(84),u=s(297),m=s(296),p=s(1),g=s(113),v=s(256);class f extends Error{}class b{constructor(e){i()(this,"accessToken",void 0),i()(this,"tempClient",void 0),i()(this,"authEnabled",!0),e&&(this.tempClient=Object(c.createClient)({baseUrl:"",idBaseUrl:e}))}get matrixClient(){return this.tempClient?this.tempClient:l.a.get()}writeToken(){this.tempClient||window.localStorage.setItem("mx_is_access_token",this.accessToken)}readToken(){return this.tempClient?null:window.localStorage.getItem("mx_is_access_token")}hasCredentials(){return Boolean(this.accessToken)}async getAccessToken({check:e=!0}={}){if(!this.authEnabled)return null;let t=this.accessToken;if(t||(t=this.readToken()),!t)return t=await this.registerForToken(e),t&&(this.accessToken=t,this.writeToken()),t;if(e)try{await this.checkToken(t)}catch(e){if(e instanceof u.b||e instanceof f)throw e;t=await this.registerForToken(),t&&(this.accessToken=t,this.writeToken())}return t}async checkToken(e){const t=this.matrixClient.getIdentityServerUrl();try{await this.matrixClient.getIdentityAccount(e)}catch(s){if("M_TERMS_NOT_SIGNED"===s.errcode)return p.a.log("Identity server requires new terms to be agreed to"),void await Object(u.d)([new u.a(r.a.IS,t,e)]);throw s}if(!this.tempClient&&!Object(m.a)()&&!await Object(m.b)(t)){const{finished:e}=d.a.createTrackedDialog("Default identity server terms warning","",g.a,{title:Object(h.a)("Identity server has no terms of service"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("This action requires accessing the default identity server <server /> to validate an email address or phone number, but the server does not have any terms of service.",{},{server:()=>o.a.createElement("b",null,Object(v.a)(t))})),o.a.createElement("p",null,Object(h.a)("Only continue if you trust the owner of the server."))),button:Object(h.a)("Trust")}),[s]=await e;if(!s)throw new f("User aborted identity server action without terms");Object(m.d)()}}async registerForToken(e=!0){const t=await l.a.get().getOpenIdToken(),{access_token:s,token:n}=await this.matrixClient.registerWithIdentityServer(t),i=n||s;return e&&await this.checkToken(i),i}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(83),i=s.n(n),a=s(5),o=s(184);const r="update";class c extends a.EventEmitter{constructor(...e){super(...e),i()(this,"_symbol",void 0),i()(this,"_count",void 0),i()(this,"_color",void 0)}get symbol(){return this._symbol}get count(){return this._count}get color(){return this._color}get isIdle(){return this.color<=o.a.None}get isUnread(){return this.color>=o.a.Bold}get hasUnreadCount(){return this.color>=o.a.Grey&&(!!this.count||!!this.symbol)}get hasMentions(){return this.color>=o.a.Red}emitIfUpdated(e){e.isDifferentFrom(this)&&this.emit(r)}snapshot(){return new l(this)}destroy(){this.removeAllListeners(r)}}class l{constructor(e){i()(this,"symbol",void 0),i()(this,"count",void 0),i()(this,"color",void 0),this.symbol=e.symbol,this.count=e.count,this.color=e.color}isDifferentFrom(e){const t={count:this.count,symbol:this.symbol,color:this.color},s={count:e.count,symbol:e.symbol,color:e.color};return JSON.stringify(t)!==JSON.stringify(s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(112),o=s(4);function r(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?r(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class l{constructor(e,t={keys:[]}){i()(this,"_options",void 0),i()(this,"_items",void 0),this._options=t,this.setObjects(e),void 0===this._options.shouldMatchWordsOnly&&(this._options.shouldMatchWordsOnly=!0)}setObjects(e){this._items=new Map;for(const t of e){const e=Object(a.at)(t,this._options.keys);if(this._options.funcs)for(const s of this._options.funcs){const n=s(t);Array.isArray(n)?e.push(...n):e.push(n)}for(const[s,n]of Object.entries(e)){if(!n)continue;const e=this.processQuery(n);this._items.has(e)||this._items.set(e,[]),this._items.get(e).push({keyWeight:Number(s),object:t})}}}match(e,t=-1){if(e=this.processQuery(e),this._options.shouldMatchWordsOnly&&(e=e.replace(/[^\w]/g,"")),0===e.length)return[];const s=[];for(const[t,n]of this._items.entries()){let i=t;this._options.shouldMatchWordsOnly&&(i=i.replace(/[^\w]/g,""));const a=i.indexOf(e);-1!==a&&s.push(...n.map(e=>c({index:a},e)))}s.sort((e,t)=>{if(e.index<t.index)return-1;if(e.index===t.index){if(e.keyWeight<t.keyWeight)return-1;if(e.keyWeight===t.keyWeight)return 0}return 1});const n=Object(a.uniq)(s.map(e=>e.object)),i=-1===t?n.length:t;return n.slice(0,i)}processQuery(e){return!1!==this._options.fuzzy?Object(o.G)(e.toLowerCase()).toLowerCase():e.toLowerCase()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(84),c=s(88),l=s(150);let d;!function(e){e.Verified="verified",e.Warning="warning",e.Unknown="unknown",e.Normal="normal",e.Unauthenticated="unauthenticated"}(d||(d={}));const h={[d.Warning]:Object(r.b)("This user has not verified all of their sessions."),[d.Normal]:Object(r.b)("You have not verified this user."),[d.Verified]:Object(r.b)("You have verified this user. This user has verified all of their sessions.")},u={[d.Warning]:Object(r.b)("Someone is using an unknown session"),[d.Normal]:Object(r.b)("This room is end-to-end encrypted"),[d.Verified]:Object(r.b)("Everyone in this room is verified")};t.b=({isUser:e,status:t,className:s,size:a,onClick:m,hideTooltip:p,bordered:g})=>{const[v,f]=Object(n.useState)(!1),b=o()({mx_E2EIcon:!0,mx_E2EIcon_bordered:g,mx_E2EIcon_warning:t===d.Warning,mx_E2EIcon_normal:t===d.Normal,mx_E2EIcon_verified:t===d.Verified},s);let y,E;y=e?h[t]:u[t],a&&(E={width:a+"px",height:a+"px"});const S=()=>f(!0),_=()=>f(!1);let w;return v&&!p&&(w=i.a.createElement(l.b,{label:y?Object(r.a)(y):""})),m?i.a.createElement(c.a,{onClick:m,onMouseOver:S,onMouseLeave:_,className:b,style:E},w):i.a.createElement("div",{onMouseOver:S,onMouseLeave:_,className:b,style:E},w)}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(176);t.a=function({name:e,definitions:t,value:s,className:n,outlined:a,disabled:c,onChange:l}){const d=e=>{l(e.target.value)};return i.a.createElement(i.a.Fragment,null,t.map(t=>{var l;return i.a.createElement(i.a.Fragment,{key:t.value},i.a.createElement(r.a,{className:o()(n,t.className),onChange:d,checked:void 0!==t.checked?t.checked:t.value===s,name:e,value:t.value,disabled:null!==(l=t.disabled)&&void 0!==l?l:c,outlined:a},t.label),t.description?i.a.createElement("span",null,t.description):null)}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return L})),s.d(t,"b",(function(){return F})),s.d(t,"c",(function(){return G})),s.d(t,"d",(function(){return q}));var n,i,a,o,r,c,l,d,h,u,m,p,g,v,f,b,y,E,S,_=s(83),w=s.n(_),C=s(82),O=s.n(C),k=s(91),R=s.n(k),I=s(355),x=s(84),T=s(89),j=s(88),N=s(96),P=s(124),D=s(85),M=s(101),A=s(820),U=s(1);const L=0;let F=Object(D.a)("views.auth.PasswordAuthEntry")((a=i=class extends O.a.Component{constructor(e){super(e),w()(this,"onSubmit",e=>{e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:I.a.Password,user:this.props.matrixClient.credentials.userId,identifier:{type:"m.id.user",user:this.props.matrixClient.credentials.userId},password:this.state.password})}),w()(this,"onPasswordFieldChange",e=>{this.setState({password:e.target.value})}),this.state={password:""}}componentDidMount(){this.props.onPhaseChange(L)}render(){const e=R()({error:this.props.errorText});let t,s;return t=this.props.busy?O.a.createElement(N.a,null):O.a.createElement("input",{type:"submit",className:"mx_Dialog_primary",disabled:!this.state.password,value:Object(x.a)("Continue")}),this.props.errorText&&(s=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),O.a.createElement("div",null,O.a.createElement("p",null,Object(x.a)("Confirm your identity by entering your account password below.")),O.a.createElement("form",{onSubmit:this.onSubmit,className:"mx_InteractiveAuthEntryComponents_passwordSection"},O.a.createElement(M.a,{className:e,type:"password",name:"passwordField",label:Object(x.a)("Password"),autoFocus:!0,value:this.state.password,onChange:this.onPasswordFieldChange}),s,O.a.createElement("div",{className:"mx_button_row"},t)))}},w()(i,"LOGIN_TYPE",I.a.Password),n=a))||n,B=Object(D.a)("views.auth.RecaptchaAuthEntry")((c=r=class extends O.a.Component{constructor(...e){super(...e),w()(this,"onCaptchaResponse",e=>{P.a.instance.track("onboarding_grecaptcha_submit"),this.props.submitAuthDict({type:I.a.Recaptcha,response:e})})}componentDidMount(){this.props.onPhaseChange(L)}render(){if(this.props.busy)return O.a.createElement(N.a,null);let e,t,s=this.props.errorText;return this.props.stageParams&&this.props.stageParams.public_key?e=this.props.stageParams.public_key:s=Object(x.a)("Missing captcha public key in homeserver configuration. Please report this to your homeserver administrator."),s&&(t=O.a.createElement("div",{className:"error",role:"alert"},s)),O.a.createElement("div",null,O.a.createElement(A.a,{sitePublicKey:e,onCaptchaResponse:this.onCaptchaResponse}),t)}},w()(r,"LOGIN_TYPE",I.a.Recaptcha),o=c))||o,V=Object(D.a)("views.auth.TermsAuthEntry")((h=d=class extends O.a.Component{constructor(e){super(e),w()(this,"tryContinue",()=>{this.trySubmit()}),w()(this,"trySubmit",()=>{let e=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];e=e&&s}e?(this.props.submitAuthDict({type:I.a.Terms}),P.a.instance.track("onboarding_terms_complete")):this.setState({errorText:Object(x.a)("Please review and accept all of the homeserver's policies")})});const t=this.props.stageParams.policies||{},s=T.b.getValue("language"),n={},i=[];for(const e of Object.keys(t)){const a=t[e];let o=a[s];if(o||(o=a.en),!o){o=a[Object.keys(a).find(e=>"version"!==e)]}if(!o)throw new Error("Failed to find a policy to show the user");n[e]=!1,i.push({id:e,name:o.name,url:o.url})}this.state={toggledPolicies:n,policies:i},P.a.instance.track("onboarding_terms_begin")}componentDidMount(){this.props.onPhaseChange(L)}togglePolicy(e){const t={};for(const s of this.state.policies){let n=this.state.toggledPolicies[s.id];s.id===e&&(n=!n),t[s.id]=n}this.setState({toggledPolicies:t})}render(){if(this.props.busy)return O.a.createElement(N.a,null);const e=[];let t,s,n=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];n=n&&s,e.push(O.a.createElement("label",{key:"policy_checkbox_"+t.id,className:"mx_InteractiveAuthEntryComponents_termsPolicy"},O.a.createElement("input",{type:"checkbox",onChange:()=>this.togglePolicy(t.id),checked:s}),O.a.createElement("a",{href:t.url,target:"_blank",rel:"noreferrer noopener"},t.name)))}return(this.props.errorText||this.state.errorText)&&(t=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText||this.state.errorText)),!1!==this.props.showContinue&&(s=O.a.createElement("button",{className:"mx_InteractiveAuthEntryComponents_termsSubmit mx_GeneralButton",onClick:this.trySubmit,disabled:!n},Object(x.a)("Accept"))),O.a.createElement("div",null,O.a.createElement("p",null,Object(x.a)("Please review and accept the policies of this homeserver:")),e,t,s)}},w()(d,"LOGIN_TYPE",I.a.Terms),l=h))||l,K=Object(D.a)("views.auth.EmailIdentityAuthEntry")((p=m=class extends O.a.Component{componentDidMount(){this.props.onPhaseChange(L)}render(){var e;let t;return this.props.errorText&&"M_UNAUTHORIZED"!==this.props.errorCode&&(t=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),void 0===this.props.inputs.emailAddress||null!==(e=this.props.stageState)&&void 0!==e&&e.emailSid?t||O.a.createElement(N.a,null):O.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_emailWrapper"},O.a.createElement("p",null,Object(x.a)("A confirmation email has been sent to %(emailAddress)s",{emailAddress:O.a.createElement("b",null,this.props.inputs.emailAddress)})),O.a.createElement("p",null,Object(x.a)("Open the link in the email to continue registration.")),t)}},w()(m,"LOGIN_TYPE",I.a.Email),u=p))||u,W=Object(D.a)("views.auth.MsisdnAuthEntry")((f=v=class extends O.a.Component{constructor(e){super(e),w()(this,"submitUrl",void 0),w()(this,"sid",void 0),w()(this,"msisdn",void 0),w()(this,"onTokenChange",e=>{this.setState({token:e.target.value})}),w()(this,"onFormSubmit",async e=>{if(e.preventDefault(),""!=this.state.token){this.setState({errorText:null});try{let e;if(!this.submitUrl)throw new Error("The registration with MSISDN flow is misconfigured");if(e=await this.props.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sid,this.props.clientSecret,this.state.token),e.success){const e={sid:this.sid,client_secret:this.props.clientSecret};this.props.submitAuthDict({type:I.a.Msisdn,threepid_creds:e,threepidCreds:e})}else this.setState({errorText:Object(x.a)("Token incorrect")})}catch(e){this.props.fail(e),U.a.log("Failed to submit msisdn token")}}}),this.state={token:"",requestingToken:!1,errorText:""}}componentDidMount(){this.props.onPhaseChange(L),this.setState({requestingToken:!0}),this.requestMsisdnToken().catch(e=>{this.props.fail(e)}).finally(()=>{this.setState({requestingToken:!1})})}requestMsisdnToken(){return this.props.matrixClient.requestRegisterMsisdnToken(this.props.inputs.phoneCountry,this.props.inputs.phoneNumber,this.props.clientSecret,1).then(e=>{this.submitUrl=e.submit_url,this.sid=e.sid,this.msisdn=e.msisdn})}render(){if(this.state.requestingToken)return O.a.createElement(N.a,null);{const e=Boolean(this.state.token),t=R()({mx_InteractiveAuthEntryComponents_msisdnSubmit:!0,mx_GeneralButton:!0});let s;return this.state.errorText&&(s=O.a.createElement("div",{className:"error",role:"alert"},this.state.errorText)),O.a.createElement("div",null,O.a.createElement("p",null,Object(x.a)("A text message has been sent to %(msisdn)s",{msisdn:O.a.createElement("i",null,this.msisdn)})),O.a.createElement("p",null,Object(x.a)("Please enter the code it contains:")),O.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_msisdnWrapper"},O.a.createElement("form",{onSubmit:this.onFormSubmit},O.a.createElement("input",{type:"text",className:"mx_InteractiveAuthEntryComponents_msisdnEntry",value:this.state.token,onChange:this.onTokenChange,"aria-label":Object(x.a)("Code")}),O.a.createElement("br",null),O.a.createElement("input",{type:"submit",value:Object(x.a)("Submit"),className:t,disabled:!e})),s))}}},w()(v,"LOGIN_TYPE",I.a.Msisdn),g=f))||g,G=Object(D.a)("views.auth.SSOAuthEntry")((E=y=class e extends O.a.Component{constructor(t){super(t),w()(this,"ssoUrl",void 0),w()(this,"popupWindow",void 0),w()(this,"attemptFailed",()=>{this.setState({attemptFailed:!0})}),w()(this,"onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}),w()(this,"onStartAuthClick",()=>{this.popupWindow=window.open(this.ssoUrl,"_blank"),this.setState({phase:e.PHASE_POSTAUTH}),this.props.onPhaseChange(e.PHASE_POSTAUTH)}),w()(this,"onConfirmClick",()=>{this.props.submitAuthDict({})}),this.ssoUrl=t.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage),this.state={phase:e.PHASE_PREAUTH,attemptFailed:!1}}componentDidMount(){this.props.onPhaseChange(e.PHASE_PREAUTH)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}render(){let t=null;const s=O.a.createElement(j.a,{onClick:this.props.onCancel,kind:this.props.continueKind?this.props.continueKind+"_outline":"primary_outline"},Object(x.a)("Cancel"));let n;return t=this.state.phase===e.PHASE_PREAUTH?O.a.createElement(j.a,{onClick:this.onStartAuthClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(x.a)("Single Sign On")):O.a.createElement(j.a,{onClick:this.onConfirmClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(x.a)("Confirm")),this.props.errorText?n=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText):this.state.attemptFailed&&(n=O.a.createElement("div",{className:"error",role:"alert"},Object(x.a)("Something went wrong in confirming your identity. Cancel and try again."))),O.a.createElement(O.a.Fragment,null,n,O.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_sso_buttons"},s,t))}},w()(y,"LOGIN_TYPE",I.a.Sso),w()(y,"UNSTABLE_LOGIN_TYPE",I.a.SsoUnstable),w()(y,"PHASE_PREAUTH",1),w()(y,"PHASE_POSTAUTH",2),b=E))||b,H=Object(D.a)("views.auth.FallbackAuthEntry")(S=class extends O.a.Component{constructor(e){super(e),w()(this,"popupWindow",void 0),w()(this,"fallbackButton",Object(C.createRef)()),w()(this,"focus",()=>{this.fallbackButton.current&&this.fallbackButton.current.focus()}),w()(this,"onShowFallbackClick",e=>{e.preventDefault(),e.stopPropagation();const t=this.props.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId);this.popupWindow=window.open(t,"_blank")}),w()(this,"onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.props.submitAuthDict({})}),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage)}componentDidMount(){this.props.onPhaseChange(L)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&this.popupWindow.close()}render(){let e;return this.props.errorText&&(e=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),O.a.createElement("div",null,O.a.createElement("a",{href:"",ref:this.fallbackButton,onClick:this.onShowFallbackClick},Object(x.a)("Start authentication")),e)}})||S;function q(e){switch(e){case I.a.Password:return F;case I.a.Recaptcha:return B;case I.a.Email:return K;case I.a.Msisdn:return W;case I.a.Terms:return V;case I.a.Sso:case I.a.SsoUnstable:return G;default:return H}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(82),a=s.n(i),o=s(85),r=s(836);let c=Object(o.a)("views.auth.AuthPage")(n=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_AuthPage"},a.a.createElement("div",{className:"mx_AuthPage_modal"},this.props.children),a.a.createElement(r.a,null))}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(135);t.a=({room:e,children:t})=>{const[s,o]=Object(n.useState)(null==e?void 0:e.name);return Object(a.a)(e,"Room.name",()=>{o(null==e?void 0:e.name)}),Object(n.useEffect)(()=>{o(null==e?void 0:e.name)},[e]),t?t(s):i.a.createElement(i.a.Fragment,null,s||"")}},function(e,t,s){"use strict";s.r(t),s.d(t,"CHAT_EFFECTS",(function(){return i}));var n=s(84);const i=[{emojis:["🎊","🎉"],msgType:"nic.custom.confetti",command:"confetti",description:()=>Object(n.b)("Sends the given message with confetti"),fallbackMessage:()=>Object(n.a)("sends confetti")+" 🎉",options:{maxCount:150,speed:3,frameInterval:15,alpha:1,gradient:!1}},{emojis:["🎆"],msgType:"nic.custom.fireworks",command:"fireworks",description:()=>Object(n.b)("Sends the given message with fireworks"),fallbackMessage:()=>Object(n.a)("sends fireworks")+" 🎆",options:{maxCount:500,gravity:.05}},{emojis:["🌧️","⛈️","🌦️"],msgType:"io.element.effect.rainfall",command:"rainfall",description:()=>Object(n.b)("Sends the given message with rainfall"),fallbackMessage:()=>Object(n.a)("sends rainfall")+" 🌧️",options:{maxCount:600,speed:10}},{emojis:["❄","🌨"],msgType:"io.element.effect.snowfall",command:"snowfall",description:()=>Object(n.b)("Sends the given message with snowfall"),fallbackMessage:()=>Object(n.a)("sends snowfall")+" ❄",options:{maxCount:200,gravity:.05,maxDrift:5}},{emojis:["👾","🌌"],msgType:"io.element.effects.space_invaders",command:"spaceinvaders",description:()=>Object(n.b)("Sends the given message with a space themed effect"),fallbackMessage:()=>Object(n.a)("sends space invaders")+" 👾",options:{maxCount:50,gravity:.01}}]},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const n={};function i(e){var t,s;return null===(t=null===(s=n.shouldShowComponent)||void 0===s?void 0:s.call(n,e))||void 0===t||t}},function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return y})),s.d(t,"a",(function(){return E}));var n=s(83),i=s.n(n);class a{constructor(e,t,s,n){this.updateCallback=e,this.getAutocompleterComponent=t,this.updateQuery=s,this.partCreator=n,i()(this,"partIndex",void 0)}onEscape(e){this.getAutocompleterComponent().onEscape(e)}close(){this.updateCallback({close:!0})}hasSelection(){return this.getAutocompleterComponent().hasSelection()}hasCompletions(){const e=this.getAutocompleterComponent();return e&&e.countCompletions()>0}async confirmCompletion(){await this.getAutocompleterComponent().onConfirmCompletion(),this.updateCallback({close:!0})}async startSelection(){const e=this.getAutocompleterComponent();0===e.countCompletions()&&await e.forceComplete()}selectPreviousSelection(){this.getAutocompleterComponent().moveSelection(-1)}selectNextSelection(){this.getAutocompleterComponent().moveSelection(1)}onPartUpdate(e,t){return this.partIndex=t.index,this.updateQuery(e.text)}onComponentConfirm(e){this.updateCallback({replaceParts:this.partForCompletion(e),close:!0})}partForCompletion(e){const{completionId:t}=e,s=e.completion;switch(e.type){case"room":return[this.partCreator.roomPill(s,t),this.partCreator.plain(e.suffix)];case"at-room":return[this.partCreator.atRoomPill(t),this.partCreator.plain(e.suffix)];case"user":return this.partCreator.createMentionParts(0===this.partIndex,s,t);case"command":return[this.partCreator.command(s)];default:return[this.partCreator.plain(s)]}}}var o=s(199),r=s(87),c=s(92);let l;!function(e){e.Plain="plain",e.Newline="newline",e.Command="command",e.UserPill="user-pill",e.RoomPill="room-pill",e.AtRoomPill="at-room-pill",e.PillCandidate="pill-candidate"}(l||(l={}));class d{constructor(e=""){i()(this,"_text",void 0),this._text=e}acceptsInsertion(e,t,s){return!0}acceptsRemoval(e,t){return!0}merge(e){return!1}split(e){const t=this.text.substr(e);return this._text=this.text.substr(0,e),new u(t)}remove(e,t){const s=this.text.substr(0,e)+this.text.substr(e+t);for(let n=e;n<t+e;++n){const e=this.text.charAt(n);if(!this.acceptsRemoval(n,e))return s}this._text=s}appendUntilRejected(e,t){const s=this.text.length;for(let n=0;n<e.length;++n){const i=e.charAt(n);if(!this.acceptsInsertion(i,s+n,t))return this._text=this._text+e.substr(0,n),e.substr(n)}this._text=this._text+e}validateAndInsert(e,t,s){for(let n=0;n<t.length;++n){const i=t.charAt(n);if(!this.acceptsInsertion(i,e+n,s))return!1}const n=this._text.substr(0,e),i=this._text.substr(e);return this._text=n+t+i,!0}createAutoComplete(e){}trim(e){const t=this._text.substr(e);return this._text=this._text.substr(0,e),t}get text(){return this._text}get canEdit(){return!0}toString(){return`${this.type}(${this.text})`}serialize(){return{type:this.type,text:this.text}}}class h extends d{acceptsInsertion(e,t,s){return"\n"!==e&&("insertFromPaste"===s||"insertFromDrop"===s||("@"!==e&&"#"!==e&&":"!==e&&"+"!==e||0!==t&&(" "!==this._text[t-1]&&("+"!==this._text[t-1]||":"!==e))))}toDOMNode(){return document.createTextNode(this.text)}merge(e){return e.type===this.type&&(this._text=this.text+e.text,!0)}updateDOMNode(e){e.textContent!==this.text&&(e.textContent=this.text)}canUpdateDOMNode(e){return e.nodeType===Node.TEXT_NODE}}class u extends h{get type(){return l.Plain}}class m extends d{constructor(e,t){super(t),this.resourceId=e,i()(this,"onClick",void 0)}acceptsInsertion(e){return" "!==e}acceptsRemoval(e,t){return 0!==e}toDOMNode(){const e=document.createElement("span");return e.setAttribute("spellcheck","false"),e.setAttribute("contentEditable","false"),e.onclick=this.onClick,e.className=this.className,e.appendChild(document.createTextNode(this.text)),this.setAvatar(e),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(t.textContent=this.text),e.className!==this.className&&(e.className=this.className),e.onclick!==this.onClick&&(e.onclick=this.onClick),this.setAvatar(e)}canUpdateDOMNode(e){return e.nodeType===Node.ELEMENT_NODE&&"SPAN"===e.nodeName&&1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE}setAvatarVars(e,t,s){const n=`url('${t}')`,i=`'${s}'`;e.style.getPropertyValue("--avatar-background")!==n&&e.style.setProperty("--avatar-background",n),e.style.getPropertyValue("--avatar-letter")!==i&&e.style.setProperty("--avatar-letter",i)}serialize(){return{type:this.type,text:this.text,resourceId:this.resourceId}}get canEdit(){return!1}}class p extends d{acceptsInsertion(e,t){return 0===t&&"\n"===e}acceptsRemoval(e,t){return!0}toDOMNode(){return document.createElement("br")}merge(){return!1}updateDOMNode(){}canUpdateDOMNode(e){return"BR"===e.tagName}get type(){return l.Newline}get canEdit(){return!1}}class g extends m{constructor(e,t,s){super(e,t),this.room=s}setAvatar(e){let t="",s=o.b(this.room,16,16,"crop");s||(t=o.e(this.room?this.room.name:this.resourceId),s=o.d(this.room?this.room.roomId:this.resourceId)),this.setAvatarVars(e,s,t)}get type(){return l.RoomPill}get className(){return"mx_RoomPill mx_Pill"}}class v extends g{constructor(e,t){super(e,e,t)}get type(){return l.AtRoomPill}serialize(){return{type:this.type,text:this.text}}}class f extends m{constructor(e,t,s){super(e,t),this.member=s,i()(this,"onClick",()=>{r.a.dispatch({action:c.a.ViewUser,member:this.member})})}get type(){return l.UserPill}get className(){return"mx_UserPill mx_Pill"}setAvatar(e){if(!this.member)return;const t=this.member.name||this.member.userId,s=o.d(this.member.userId),n=o.a(this.member,16,16,"crop");let i="";n===s&&(i=o.e(t)),this.setAvatarVars(e,n,i)}}class b extends h{constructor(e,t){super(e),this.autoCompleteCreator=t}createAutoComplete(e){return this.autoCompleteCreator.create(e)}acceptsInsertion(e,t,s){return 0===t||super.acceptsInsertion(e,t,s)}merge(){return!1}acceptsRemoval(e,t){return!0}get type(){return l.PillCandidate}}function y(e,t){return s=>n=>new a(n,e,t,s)}class E extends class{constructor(e,t,s=null){this.room=e,this.client=t,i()(this,"autoCompleteCreator",void 0),this.autoCompleteCreator={create:null==s?void 0:s(this)}}setAutoCompleteCreator(e){this.autoCompleteCreator.create=e(this)}createPartForInput(e,t,s){switch(e[0]){case"#":case"@":case":":case"+":return this.pillCandidate("");case"\n":return new p;default:return new u}}createDefaultPart(e){return this.plain(e)}deserializePart(e){switch(e.type){case l.Plain:return this.plain(e.text);case l.Newline:return this.newline();case l.AtRoomPill:return this.atRoomPill(e.text);case l.PillCandidate:return this.pillCandidate(e.text);case l.RoomPill:return this.roomPill(e.resourceId);case l.UserPill:return this.userPill(e.text,e.resourceId)}}plain(e){return new u(e)}newline(){return new p("\n")}pillCandidate(e){return new b(e,this.autoCompleteCreator)}roomPill(e,t){let s;return s=t||"#"!==e[0]?this.client.getRoom(t||e):this.client.getRooms().find(t=>t.getCanonicalAlias()===e||t.getAltAliases().includes(e)),new g(e,s?s.name:e,s)}atRoomPill(e){return new v(e,this.room)}userPill(e,t){const s=this.room.getMember(t);return new f(t,e,s)}createMentionParts(e,t,s){return[this.userPill(t,s),this.plain(e?": ":" ")]}}{createPartForInput(e,t){return 0===t&&"/"===e[0]?this.command(""):super.createPartForInput(e,t)}command(e){return new S(e,this.autoCompleteCreator)}deserializePart(e){return e.type===l.Command?this.command(e.text):super.deserializePart(e)}}class S extends b{get type(){return l.Command}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(99),i=s.n(n),a=s(5);class o extends a.EventEmitter{constructor(e){super(),this.userId=e,i()(this,"modified",void 0),i()(this,"displayName",void 0),i()(this,"rawDisplayName",void 0),i()(this,"avatarUrl",void 0),i()(this,"presenceStatusMsg",null),i()(this,"presence","offline"),i()(this,"lastActiveAgo",0),i()(this,"lastPresenceTs",0),i()(this,"currentlyActive",!1),i()(this,"events",{presence:null,profile:null}),i()(this,"unstable_statusMessage",""),this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.updateModifiedTime()}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const s=[];(e.getContent().presence!==this.presence||t)&&s.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&s.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&s.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&s.push("User.currentlyActive"),this.presence=e.getContent().presence,s.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(let t=0;t<s.length;t++)this.emit(s[t],e,this)}setDisplayName(e){const t=this.displayName;this.displayName="string"==typeof e?e:void 0,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName="string"==typeof e?e:void 0}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}unstable_updateStatusMessage(e){e.getContent()?this.unstable_statusMessage=e.getContent().status:this.unstable_statusMessage="",this.updateModifiedTime(),this.emit("User.unstable_statusMessage",this)}}},function(e,t,s){"use strict";function n(e,t){const s=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[s]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.value=t,n}function i(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,s=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(s,Reflect.getPrototypeOf(this)),s.reason=e,s.name="InvalidCryptoStoreError",s}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return a})),n.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",n.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(n,Error),i.TOO_NEW="TOO_NEW",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error);class a extends Error{constructor(e,t){super(e),this.value=t}}},function(e,t,s){"use strict";s.d(t,"j",(function(){return d})),s.d(t,"k",(function(){return h})),s.d(t,"a",(function(){return u})),s.d(t,"i",(function(){return m})),s.d(t,"h",(function(){return p})),s.d(t,"g",(function(){return g})),s.d(t,"e",(function(){return v})),s.d(t,"d",(function(){return f})),s.d(t,"f",(function(){return b})),s.d(t,"b",(function(){return y})),s.d(t,"c",(function(){return E})),s.d(t,"l",(function(){return S}));var n=s(99),i=s.n(n),a=s(1),o=s(5),r=s(289),c=s(351);const l="m.key.verification.",d=l+"request",h=l+"start",u=l+"cancel",m=l+"ready";let p;!function(e){e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done"}(p||(p={}));const g=p.Unsent,v=p.Requested,f=p.Ready,b=p.Started,y=p.Cancelled,E=p.Done;class S extends o.EventEmitter{constructor(e,t,s){super(),this.channel=e,this.verificationMethods=t,this.client=s,i()(this,"eventsByUs",new Map),i()(this,"eventsByThem",new Map),i()(this,"_observeOnly",!1),i()(this,"timeoutTimer",null),i()(this,"_accepting",!1),i()(this,"_declining",!1),i()(this,"verifierHasFinished",!1),i()(this,"_cancelled",!1),i()(this,"_chosenMethod",null),i()(this,"_qrCodeData",null),i()(this,"requestReceivedAt",null),i()(this,"commonMethods",[]),i()(this,"_phase",void 0),i()(this,"_cancellingUserId",void 0),i()(this,"_verifier",void 0),i()(this,"cancelOnTimeout",()=>{try{this.initiatedByMe?this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){a.a.error("Error while cancelling verification request",e)}}),this.channel.request=this,this.setPhase(g,!1)}static validateEvent(e,t,s){const n=t.getContent();return!(!e||!e.startsWith(l))&&(n?e!==d&&e!==m||Array.isArray(n.methods)?e!==d&&e!==m&&e!==h||"string"==typeof n.from_device&&0!==n.from_device.length||(a.a.log("VerificationRequest: validateEvent: fail because from_device"),!1):(a.a.log("VerificationRequest: validateEvent: fail because methods"),!1):(a.a.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===g}get requested(){return this.phase===v}get cancelled(){return this.phase===y}get ready(){return this.phase===f}get started(){return this.phase===b}get done(){return this.phase===E}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=v){const e=this.requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(d);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(d)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<f&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==E&&this._phase!==y}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const s=this.eventsByThem.get(d)||this.eventsByThem.get(m);if(!s){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get(h),s=t&&t.getContent();return e==(s&&s.method)}return!1}const n=s.getContent();if(!n)return!1;const{methods:i}=n;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===g&&e)return!0;const t=this.eventsByUs.has(d),s=this.eventsByThem.has(d);if(t&&!s)return!0;if(!t&&s)return!1;const n=this.eventsByUs.has(h),i=this.eventsByThem.has(h);return!(!n||i)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(u),t=this.eventsByThem.get(u);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither(u);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this.eventsByThem.get(d)||this.eventsByThem.get(m)||this.eventsByThem.get(h)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(this.phase===v||this.phase===f||this.phase===g&&this.channel.canCreateRequest(h)){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw Object(r.g)();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw Object(r.g)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===g){const e=[...this.verificationMethods.keys()];await this.channel.send(d,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==y){if(this._declining=!0,this.emit("change"),this._verifier)return this._verifier.cancel(Object(r.a)(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(u,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===v&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit("change"),await this.channel.send(m,{methods:e})}}waitFor(e){return new Promise((t,s)=>{const n=()=>{let i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(s(new Error("cancelled")),i=!0),i&&this.off("change",n),i};n()||this.on("change",n)})}setPhase(e,t=!0){this._phase=e,t&&this.emit("change")}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e,t=!1){return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:g}],t=()=>e[e.length-1].phase,s=this.eventsByThem.has(d),n=this.getEventBy(d,s);n&&e.push({phase:v,event:n});const i=n&&this.getEventBy(m,!s);let a;if(i&&t()===v&&e.push({phase:f,event:i}),i||!n){const e=this.eventsByThem.get(h),t=this.eventsByUs.get(h);a=e&&t?e.getSender()<t.getSender()?e:t:e||t}else a=this.getEventBy(h,!s);if(a){const s=t()===v&&n.getSender()!==a.getSender(),i=t()===g&&this.channel.canCreateRequest(h);(s||t()===f||i)&&e.push({phase:b,event:a})}const o=this.eventsByUs.get("m.key.verification.done");(this.verifierHasFinished||o&&t()===b)&&e.push({phase:E});const r=this.getEventByEither(u);return(this._cancelled||r)&&t()!==E?(e.push({phase:y,event:r}),e):e}transitionToPhase(e){const{phase:t,event:s}=e;if((t===v||t===f)&&!this.wasSentByOwnDevice(s)){const e=s.getContent();this.commonMethods=e.methods.filter(e=>this.verificationMethods.has(e))}if(this.observeOnly||t!==v&&t!==b&&t!==f||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(s)&&!this.wasSentByOwnDevice(s)&&(this._observeOnly=!0),t===b){const{method:e}=s.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,s),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:"Unknown method: "+e}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex(e=>e.phase===this.phase),s=e.slice(t+1);for(const e of s)this.transitionToPhase(e);return s}isWinningStartRace(e){if(e.getType()!==h)return!1;const t=this._verifier.startEvent;let s,n;if(this.isSelfVerification)if(t){const e=t.getContent();s=e&&e.from_device}else s=this.client.getDeviceId();else s=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();n=t&&t.from_device}else n=e.getSender();return n<s}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,s,n,i){if(this.done||this.cancelled)return;const o=this._observeOnly;if(this.adjustObserveOnly(t,s),!this.observeOnly&&!n&&await this.cancelOnError(e,t))return;if(i?this.eventsByUs.has(e):this.eventsByThem.has(e))return;const r=this.phase;this.addEvent(e,t,i);const l=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const s=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&s)this._verifier.switchStartEvent(t);else if(!n){var d;(e===u||null!==(d=this._verifier.events)&&void 0!==d&&d.includes(e))&&this._verifier.handleEvent(t)}}if(l.length){if(s&&l.some(e=>e.phase===f)){this.otherPartySupportsMethod(c.c,!0)&&(this._qrCodeData=await c.a.create(this,this.client))}const e=l[l.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==o&&this.emit("change")}finally{a.a.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${i}, isLiveEvent:${s}, isRemoteEcho:${n}, phase:${r}=>${this.phase}, observeOnly:${o}=>${this._observeOnly}`)}}setupTimeout(e){if(!this.timeoutTimer&&!this.observeOnly&&e===v&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){(e===b||e===f||e===E||e===y)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(e,t){if(e===h){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel(Object(r.b)(Object(r.g)())),!0}const s=e===d&&this.phase!==g,n=e===m&&this.phase!==v;if(this.phase!==g&&(s||n)){a.a.warn(`Cancelling, unexpected ${e} verification event from `+t.getSender());const s=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(Object(r.b)(Object(r.f)({reason:s}))),!0}return!1}adjustObserveOnly(e,t=!1){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}addEvent(e,t,s=!1){if(s?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===d){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e,t=null,s=null){s||(s=this.targetDevice);const{userId:n,deviceId:i}=s,o=this.verificationMethods.get(e);if(o)return new o(this.channel,this.client,n,i,t,this);a.a.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return e.getSender()===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(112),c=s(86),l=s(84),d=s(103);class h extends a.a{constructor(){super(o.a,{displayName:window.localStorage.getItem("mx_profile_displayname"),avatarUrl:window.localStorage.getItem("mx_profile_avatar_url")}),i()(this,"monitoredUser",void 0),i()(this,"onProfileUpdate",async()=>{const e=await this.matrixClient.getProfileInfo(this.matrixClient.getUserId());e.displayname?window.localStorage.setItem("mx_profile_displayname",e.displayname):window.localStorage.removeItem("mx_profile_displayname"),e.avatar_url?window.localStorage.setItem("mx_profile_avatar_url",e.avatar_url):window.localStorage.removeItem("mx_profile_avatar_url"),await this.updateState({displayName:e.displayname,avatarUrl:e.avatar_url})}),i()(this,"onStateEvents",Object(r.throttle)(async e=>{const t=c.a.get().getUserId();"m.room.member"===e.getType()&&e.getSender()===t&&e.getStateKey()===t&&await this.onProfileUpdate()},200,{trailing:!0,leading:!0}))}static get instance(){return h.internalInstance}get displayName(){return this.matrixClient?this.matrixClient.isGuest()?Object(l.a)("Guest"):this.state.displayName?this.state.displayName:this.matrixClient.getUserId():this.state.displayName||null}get avatarMxc(){return this.state.avatarUrl||null}getHttpAvatarUrl(e=0){if(!this.avatarMxc)return null;const t=Object(d.b)(this.avatarMxc);return!e||e<=0?t.srcHttp:t.getSquareThumbnailHttp(e)}async onNotReady(){this.monitoredUser&&(this.monitoredUser.removeListener("User.displayName",this.onProfileUpdate),this.monitoredUser.removeListener("User.avatarUrl",this.onProfileUpdate)),this.matrixClient&&this.matrixClient.removeListener("RoomState.events",this.onStateEvents),await this.reset({})}async onReady(){const e=this.matrixClient.getUserId();this.monitoredUser=this.matrixClient.getUser(e),this.monitoredUser&&(this.monitoredUser.on("User.displayName",this.onProfileUpdate),this.monitoredUser.on("User.avatarUrl",this.onProfileUpdate)),this.matrixClient.on("RoomState.events",this.onStateEvents),await this.onProfileUpdate()}async onAction(e){}}i()(h,"internalInstance",new h)},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(88),h=s(84),u=s(108),m=s(85);class p extends r.a.Component{constructor(...e){super(...e),a()(this,"onMouseEnter",()=>{this.props.onMouseEnter(this.props.dropdownKey)}),a()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onClick(this.props.dropdownKey)})}render(){const e=l()({mx_Dropdown_option:!0,mx_Dropdown_option_highlight:this.props.highlighted});return r.a.createElement("div",{id:this.props.id,className:e,onClick:this.onClick,onMouseEnter:this.onMouseEnter,role:"option","aria-selected":this.props.highlighted,ref:this.props.inputRef},this.props.children)}}a()(p,"defaultProps",{disabled:!1});let g=Object(m.a)("views.elements.Dropdown")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"buttonRef",Object(o.createRef)()),a()(this,"dropdownRootElement",null),a()(this,"ignoreEvent",null),a()(this,"childrenByKey",{}),a()(this,"onDocumentClick",e=>{e!==this.ignoreEvent&&this.setState({expanded:!1})}),a()(this,"onRootClick",e=>{this.ignoreEvent=e}),a()(this,"onAccessibleButtonClick",e=>{this.props.disabled||(this.state.expanded?e.key===u.a.ENTER?(this.props.onOptionChange(this.state.highlightedOption),this.close()):e.key||(this.setState({expanded:!1}),e.preventDefault()):(this.setState({expanded:!0}),e.preventDefault()))}),a()(this,"onMenuOptionClick",e=>{this.close(),this.props.onOptionChange(e)}),a()(this,"onKeyDown",e=>{let t=!0;switch(e.key){case u.a.ENTER:this.props.onOptionChange(this.state.highlightedOption);case u.a.ESCAPE:this.close();break;case u.a.ARROW_DOWN:this.setState({highlightedOption:this.nextOption(this.state.highlightedOption)});break;case u.a.ARROW_UP:this.setState({highlightedOption:this.prevOption(this.state.highlightedOption)});break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())}),a()(this,"onInputChange",e=>{this.setState({searchQuery:e.currentTarget.value}),this.props.onSearchChange&&this.props.onSearchChange(e.currentTarget.value)}),a()(this,"collectRoot",e=>{this.dropdownRootElement&&this.dropdownRootElement.removeEventListener("click",this.onRootClick,!1),e&&e.addEventListener("click",this.onRootClick,!1),this.dropdownRootElement=e}),a()(this,"setHighlightedOption",e=>{this.setState({highlightedOption:e})}),this.reindexChildren(this.props.children);const t=r.a.Children.toArray(e.children)[0];this.state={expanded:!1,highlightedOption:t?t.key:null,searchQuery:""},document.addEventListener("click",this.onDocumentClick,!1)}componentWillUnmount(){document.removeEventListener("click",this.onDocumentClick,!1)}UNSAFE_componentWillReceiveProps(e){if(!e.children||0===e.children.length)return;this.reindexChildren(e.children);const t=e.children[0];this.setState({highlightedOption:t?t.key:null})}reindexChildren(e){this.childrenByKey={},r.a.Children.forEach(e,e=>{this.childrenByKey[e.key]=e})}close(){this.setState({expanded:!1}),this.buttonRef.current&&this.buttonRef.current.focus()}nextOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s+1)%t.length]}prevOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[s<=0?t.length-1:(s-1)%t.length]}scrollIntoView(e){e&&e.scrollIntoView({block:"nearest",behavior:"auto"})}getMenuOptions(){const e=r.a.Children.map(this.props.children,e=>{const t=this.state.highlightedOption===e.key;return r.a.createElement(p,{id:`${this.props.id}__${e.key}`,key:e.key,dropdownKey:e.key,highlighted:t,onMouseEnter:this.setHighlightedOption,onClick:this.onMenuOptionClick,inputRef:t?this.scrollIntoView:void 0},e)});return 0===e.length?[r.a.createElement("div",{key:"0",className:"mx_Dropdown_option",role:"option"},Object(h.a)("No results"))]:e}render(){let e;const t={};let s;if(this.props.menuWidth&&(t.width=this.props.menuWidth),this.state.expanded&&(this.props.searchEnabled&&(e=r.a.createElement("input",{type:"text",autoFocus:!0,className:"mx_Dropdown_option",onChange:this.onInputChange,value:this.state.searchQuery,role:"combobox","aria-autocomplete":"list","aria-activedescendant":`${this.props.id}__${this.state.highlightedOption}`,"aria-owns":this.props.id+"_listbox","aria-disabled":this.props.disabled,"aria-label":this.props.label,onKeyDown:this.onKeyDown})),s=r.a.createElement("div",{className:"mx_Dropdown_menu",style:t,role:"listbox",id:this.props.id+"_listbox"},this.getMenuOptions())),!e){const t=this.props.getShortOption?this.props.getShortOption(this.props.value):this.childrenByKey[this.props.value];e=r.a.createElement("div",{className:"mx_Dropdown_option",id:this.props.id+"_value"},t)}const n={mx_Dropdown:!0,mx_Dropdown_disabled:this.props.disabled};return this.props.className&&(n[this.props.className]=!0),r.a.createElement("div",{className:l()(n),ref:this.collectRoot},r.a.createElement(d.a,{className:"mx_Dropdown_input mx_no_textinput",onClick:this.onAccessibleButtonClick,"aria-haspopup":"listbox","aria-expanded":this.state.expanded,disabled:this.props.disabled,inputRef:this.buttonRef,"aria-label":this.props.label,"aria-describedby":this.props.id+"_value",onKeyDown:this.onKeyDown},e,r.a.createElement("span",{className:"mx_Dropdown_arrow"}),s))}})||n},function(e,t,s){"use strict";t.a={SHOW_ENCRYPTION_SETUP_UI:!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const n=new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i");function i(e){return n.test(e)}},,function(e,t,s){"use strict";function n(e,t){return Number.isFinite(e)?Number(e):t}function i(e,t,s){return Math.min(Math.max(e,t),s)}function a(...e){return[...e].reduce((e,t)=>t+e,0)}function o(e,t,s){return e*(s-t)+t}function r(e,t,s){return(e-t)/(s-t)}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"e",(function(){return a})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return r}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(84),m=s(87),p=s(120),g=s(89),v=s(1191),f=s.n(v),b=s(98),y=s(161),E=s(92),S=s(362),_=s.n(S),w=s(138),C=s(85),O=s(96),k=s(476),R=s(385),I=s(94);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function T(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let j=Object(C.a)("views.elements.ReplyChain")((a=i=class e extends l.a.Component{constructor(e,t){super(e,t),r()(this,"unmounted",!1),r()(this,"room",void 0),r()(this,"blockquoteRef",l.a.createRef()),r()(this,"canCollapse",()=>this.state.events.length>1),r()(this,"collapse",()=>{this.initialize()}),r()(this,"onQuoteClick",async e=>{const t=[this.state.loadedEv,...this.state.events];let s=null;t.length>0&&(s=await this.getNextEvent(t[0])),this.setState({loadedEv:s,events:t}),m.a.fire(E.a.FocusSendMessageComposer)}),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.context.getRoom(this.props.parentEv.getRoomId())}static getParentEventId(e){if(!e||e.isRedacted())return;const t=e.getContent()["m.relates_to"]||e.getWireContent()["m.relates_to"];if(t&&t["m.in_reply_to"]){const e=t["m.in_reply_to"];if(e&&e.event_id)return e.event_id}else if(!g.b.getValue("feature_thread")&&e.isThreadRelation)return e.threadRootId}static stripPlainReply(e){const t=e.split("\n");for(;t.length&&t[0].startsWith("> ");)t.shift();return""===t[0]&&t.shift(),t.join("\n")}static stripHTMLReply(e){return _()(e,{allowedTags:!1,allowedAttributes:!1,allowedSchemes:[...w.a,"mxc"],exclusiveFilter:e=>"mx-reply"===e.tag})}static getNestedReplyText(e,t){if(!e)return null;let{body:s,formatted_body:n}=e.getContent();this.getParentEventId(e)&&s&&(s=this.stripPlainReply(s)),s||(s=""),n=n?this.stripHTMLReply(n):f()(s).replace(/\n/g,"<br/>");const i=t.forEvent(e.getId()),a=Object(p.h)(e.getSender()),o=e.getSender();switch(e.getContent().msgtype){case"m.text":case"m.notice":{n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${a}">${o}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`<${o}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}case"m.image":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${a}">${o}</a><br>sent an image.</blockquote></mx-reply>`,s=`> <${o}> sent an image.\n\n`;break;case"m.video":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${a}">${o}</a><br>sent a video.</blockquote></mx-reply>`,s=`> <${o}> sent a video.\n\n`;break;case"m.audio":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${a}">${o}</a><br>sent an audio file.</blockquote></mx-reply>`,s=`> <${o}> sent an audio file.\n\n`;break;case"m.file":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${a}">${o}</a><br>sent a file.</blockquote></mx-reply>`,s=`> <${o}> sent a file.\n\n`;break;case"m.emote":{n=`<mx-reply><blockquote><a href="${i}">In reply to</a> * <a href="${a}">${o}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`* <${o}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}default:return null}return{body:s,html:n}}static makeReplyMixIn(e){if(!e)return{};const t={"m.relates_to":{"m.in_reply_to":{event_id:e.getId()}}};return e.isThreadRelation&&(t["m.relates_to"]=T(T({},t["m.relates_to"]),{},{rel_type:I.c.Thread,event_id:e.threadRootId})),t}static hasReply(t){return Boolean(e.getParentEventId(t))}componentDidMount(){this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){this.props.onHeightChanged(),this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),s=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||s)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:t}=this.props,s=await this.getEvent(e.getParentEventId(t));if(!this.unmounted)if(s){const e=await this.getNextEvent(s);this.setState({events:[s],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(t){try{const s=e.getParentEventId(t);return await this.getEvent(s)}catch(e){return null}}async getEvent(e){if(!e)return null;const t=this.room.findEventById(e);if(t)return t;try{await this.context.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return this.room.findEventById(e)}getReplyChainColorClass(e){return Object(y.f)(this.props.userNameColorMode,e.getSender(),this.context.getRoom(e.getRoomId())).replace("Username","ReplyChain")}render(){let t=null;if(this.state.err)t=l.a.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},Object(u.a)("Unable to load event that was replied to, it either does not exist or you do not have permission to view it."));else if(this.state.loadedEv){const e=this.state.loadedEv,s=this.context.getRoom(e.getRoomId());t=l.a.createElement("blockquote",{className:"mx_ReplyChain "+this.getReplyChainColorClass(e)},Object(u.a)("<a>In reply to</a> <pill>",{},{a:e=>l.a.createElement("a",{onClick:this.onQuoteClick,className:"mx_ReplyChain_show"},e),pill:l.a.createElement(R.a,{type:R.a.TYPE_USER_MENTION,room:s,url:Object(p.h)(e.getSender()),shouldShowPillAvatar:g.b.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const s=e.getParentEventId(this.props.parentEv);t=l.a.createElement("p",{className:"mx_ReplyChain_Export"},Object(u.a)("In reply to <a>this message</a>",{},{a:e=>l.a.createElement("a",{className:"mx_reply_anchor",href:"#"+s,"scroll-to":s}," ",e," ")}))}else this.state.loading&&(t=l.a.createElement(O.a,{w:16,h:16}));const{isQuoteExpanded:s}=this.props,n=this.state.events.map(e=>{const t=h()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===s,"mx_ReplyChain--collapsed":!1===s});return l.a.createElement("blockquote",{ref:this.blockquoteRef,className:t,key:e.getId()},l.a.createElement(k.a,{mxEvent:e,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,userNameColorMode:this.props.userNameColorMode,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded)}))});return l.a.createElement("div",{className:"mx_ReplyChain_wrapper"},l.a.createElement("div",null,t),l.a.createElement("div",null,n))}},r()(i,"contextType",b.a),n=a))||n},,function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return o}));var n=s(82),i=s(89);const a=(e,t=null,s=!1)=>{const[a,o]=Object(n.useState)(i.b.getValue(e,t,s));return Object(n.useEffect)(()=>{const n=i.b.watchSetting(e,t,()=>{o(i.b.getValue(e,t,s))});return()=>{i.b.unwatchSetting(n)}},[e,t,s]),a},o=(e,t=null)=>{const[s,a]=Object(n.useState)(i.b.getValue(e,t));return Object(n.useEffect)(()=>{const s=i.b.watchSetting(e,t,()=>{a(i.b.getValue(e,t))});return()=>{i.b.unwatchSetting(s)}},[e,t]),s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(108),h=s(87),u=s(112),m=s(88),p=s(91),g=s.n(p),v=s(85),f=s(92);let b=Object(v.a)("structures.SearchBox")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"dispatcherRef",void 0),r()(this,"search",Object(c.createRef)()),r()(this,"onAction",e=>{if(this.props.enableRoomSearchFocus)switch(e.action){case f.a.ViewRoom:this.search.current&&e.clear_search&&this.clearSearch();break;case"focus_room_filter":this.search.current&&this.search.current.focus()}}),r()(this,"onChange",()=>{this.search.current&&(this.setState({searchTerm:this.search.current.value}),this.onSearch())}),r()(this,"onSearch",Object(u.throttle)(()=>{this.props.onSearch(this.search.current.value)},200,{trailing:!0,leading:!0})),r()(this,"onKeyDown",e=>{switch(e.key){case d.a.ESCAPE:this.clearSearch("keyboard")}this.props.onKeyDown&&this.props.onKeyDown(e)}),r()(this,"onFocus",e=>{this.setState({blurred:!1}),e.target.select(),this.props.onFocus&&this.props.onFocus(e)}),r()(this,"onBlur",e=>{this.setState({blurred:!0}),this.props.onBlur&&this.props.onBlur(e)}),this.state={searchTerm:e.initialValue||"",blurred:!0}}componentDidMount(){this.dispatcherRef=h.a.register(this.onAction)}componentWillUnmount(){h.a.unregister(this.dispatcherRef)}clearSearch(e){this.search.current.value="",this.onChange(),this.props.onCleared&&this.props.onCleared(e)}render(){if(this.props.collapsed)return null;const e=!this.state.blurred||this.state.searchTerm?l.a.createElement(m.a,{key:"button",tabIndex:-1,className:"mx_SearchBox_closeButton",onClick:()=>{this.clearSearch("button")}}):void 0,t=this.state.blurred&&this.props.blurredPlaceholder||this.props.placeholder,s=this.props.className||"";return l.a.createElement("div",{className:g()("mx_SearchBox","mx_textinput",{mx_SearchBox_blurred:this.state.blurred})},l.a.createElement("input",{key:"searchfield",type:"text",ref:this.search,className:"mx_textinput_icon mx_textinput_search "+s,value:this.state.searchTerm,onFocus:this.onFocus,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this.onBlur,placeholder:t,autoComplete:"off",autoFocus:this.props.autoFocus}),e)}},r()(i,"defaultProps",{enableRoomSearchFocus:!1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(308),c=s(310),l=s(152),d=s(178),h=s(123),u=s(86),m=s(1);function p(e){var t;return`${null!==(t=e.roomId)&&void 0!==t?t:u.a.get().getUserId()}::${e.id}`}class g extends a.a{constructor(){super(o.a,{}),i()(this,"widgetMap",new Map),i()(this,"roomMap",new Map),i()(this,"onWidgetEchoStoreUpdate",(e,t)=>{this.initRoom(e),this.loadRoomWidgets(this.matrixClient.getRoom(e)),this.emit(h.b,e)}),i()(this,"onRoom",e=>{this.initRoom(e.roomId),this.loadRoomWidgets(e),this.emit(h.b,e.roomId)}),i()(this,"onRoomStateEvents",e=>{if("im.vector.modular.widgets"!==e.getType())return;const t=e.getRoomId();this.initRoom(t),this.loadRoomWidgets(this.matrixClient.getRoom(t)),this.emit(h.b,t)}),i()(this,"getRoom",(e,t=!1)=>(t&&this.initRoom(e),this.roomMap.get(e))),r.a.on("update",this.onWidgetEchoStoreUpdate)}static get instance(){return g.internalInstance}initRoom(e){this.roomMap.has(e)||this.roomMap.set(e,{widgets:[]})}async onReady(){this.matrixClient.on("Room",this.onRoom),this.matrixClient.on("RoomState.events",this.onRoomStateEvents),this.matrixClient.getRooms().forEach(e=>{this.loadRoomWidgets(e)}),this.emit(h.b,null)}async onNotReady(){this.matrixClient.off("Room",this.onRoom),this.matrixClient.off("RoomState.events",this.onRoomStateEvents),this.widgetMap=new Map,this.roomMap=new Map,await this.reset({})}async onAction(e){}generateApps(e){return r.a.getEchoedRoomWidgets(e.roomId,l.a.getRoomWidgets(e)).map(e=>l.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),e.getRoomId(),e.getId()))}loadRoomWidgets(e){if(!e)return;const t=this.roomMap.get(e.roomId)||{};t.widgets=[],Array.from(this.widgetMap.values()).forEach(t=>{t.roomId===e.roomId&&this.widgetMap.delete(p(t))});let s=!1;this.generateApps(e).forEach(e=>{const n=this.widgetMap.get(p(e));n&&m.a.warn(`Possible widget ID conflict for ${e.id} - wants to store in room ${e.roomId} but is currently stored as ${n.roomId} - letting the want win`),this.widgetMap.set(p(e),e),t.widgets.push(e),s=!0}),s&&!this.roomMap.has(e.roomId)&&this.roomMap.set(e.roomId,t);const n=c.b.instance.getPersistentWidgetId();n&&(c.b.instance.getRoomId(n)!==e.roomId||t.widgets.some(e=>e.id===n)||(m.a.log(`Persistent widget ${n} removed from room ${e.roomId}: destroying.`),c.b.instance.destroyPersistentWidget(n))),this.emit(e.roomId)}getApps(e){const t=this.getRoom(e);return(null==t?void 0:t.widgets)||[]}doesRoomHaveConference(e){const t=this.getRoom(e.roomId);if(!t)return!1;const s=t.widgets.filter(e=>d.a.JITSI.matches(e.type)),n=r.a.roomHasPendingWidgetsOfType(e.roomId,[],d.a.JITSI);return s.length>0||n}isJoinedToConferenceIn(e){const t=this.getRoom(e.roomId);if(!t)return!1;return t.widgets.filter(e=>d.a.JITSI.matches(e.type)).some(e=>c.b.instance.getWidgetPersistence(e.id))}}i()(g,"internalInstance",new g),window.mxWidgetStore=g.instance},,,function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(91),o=s.n(a);const r=Object(n.forwardRef)(({className:e,title:t,subtitle:s,children:n},a)=>i.a.createElement("div",{className:o()("mx_EventTileBubble",e),ref:a},i.a.createElement("div",{className:"mx_EventTileBubble_title"},t),s&&i.a.createElement("div",{className:"mx_EventTileBubble_subtitle"},s),n));t.a=r},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(88),d=s(395),h=s(217),u=s(85),m=s(97);let p=Object(u.a)("views.dialogs.InteractiveAuthDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onAuthFinished",(e,t)=>{e?this.props.onFinished(!0,t):t===d.a?this.props.onFinished(!1,null):this.setState({authError:t})}),a()(this,"onUpdateStagePhase",(e,t)=>{this.setState({uiaStage:e,uiaStagePhase:t})}),a()(this,"onDismissClick",()=>{this.props.onFinished(!1)}),this.state={authError:null,uiaStage:null,uiaStagePhase:null}}getDefaultDialogAesthetics(){const e={[h.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[h.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm to continue"),body:Object(c.a)("Click the button below to confirm your identity."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}};return{[h.c.LOGIN_TYPE]:e,[h.c.UNSTABLE_LOGIN_TYPE]:e}}render(){let e=this.state.authError?"Error":this.props.title||Object(c.a)("Authentication"),t=this.state.authError?null:this.props.body,s=null,n=null;const i=this.props.aestheticsForStagePhases||this.getDefaultDialogAesthetics();if(!this.state.authError&&i&&i[this.state.uiaStage]){const a=i[this.state.uiaStage][this.state.uiaStagePhase];a&&a.title&&(e=a.title),a&&a.body&&(t=a.body),a&&a.continueText&&(s=a.continueText),a&&a.continueKind&&(n=a.continueKind)}let a;return a=this.state.authError?r.a.createElement("div",{id:"mx_Dialog_content"},r.a.createElement("div",{role:"alert"},this.state.authError.message||this.state.authError.toString()),r.a.createElement("br",null),r.a.createElement(l.a,{onClick:this.onDismissClick,className:"mx_GeneralButton",autoFocus:!0},Object(c.a)("Dismiss"))):r.a.createElement("div",{id:"mx_Dialog_content"},t,r.a.createElement(d.b,{matrixClient:this.props.matrixClient,authData:this.props.authData,makeRequest:this.props.makeRequest,onAuthFinished:this.onAuthFinished,onStagePhaseChange:this.onUpdateStagePhase,continueText:s,continueKind:n})),r.a.createElement(m.a,{className:"mx_InteractiveAuthDialog",onFinished:this.props.onFinished,title:e,contentId:"mx_Dialog_content"},a)}})||n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(83),i=s.n(n),a=s(87),o=s(883),r=s(367),c=s(89),l=s(122),d=s(92),h=s(100),u=s(1);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const p={showRoomPanel:c.b.getValue("showRightPanelInRoom"),showGroupPanel:c.b.getValue("showRightPanelInGroup"),lastRoomPhase:c.b.getValue("lastRightPanelPhaseForRoom"),lastGroupPhase:c.b.getValue("lastRightPanelPhaseForGroup"),lastRoomPhaseParams:{}},g=[l.c.GroupMemberList,l.c.GroupRoomList,l.c.GroupRoomInfo,l.c.GroupMemberInfo],v=[l.c.RoomMemberInfo,l.c.Room3pidMemberInfo,l.c.EncryptionPanel];class f extends r.Store{constructor(){super(a.a),i()(this,"state",void 0),i()(this,"lastRoomId",void 0),this.state=p}get isOpenForRoom(){return this.state.showRoomPanel}get isOpenForGroup(){return this.state.showGroupPanel}get roomPanelPhase(){return this.state.lastRoomPhase}get groupPanelPhase(){return this.state.lastGroupPhase}get previousPhase(){return l.a.includes(this.state.previousPhase)?this.state.previousPhase:null}get visibleRoomPanelPhase(){return this.isOpenForRoom?this.roomPanelPhase:null}get visibleGroupPanelPhase(){return this.isOpenForGroup?this.groupPanelPhase:null}get roomPanelPhaseParams(){return this.state.lastRoomPhaseParams||{}}setState(e){this.state=Object.assign(this.state,e),c.b.setValue("showRightPanelInRoom",null,h.a.DEVICE,this.state.showRoomPanel),c.b.setValue("showRightPanelInGroup",null,h.a.DEVICE,this.state.showGroupPanel),l.a.includes(this.state.lastRoomPhase)&&c.b.setValue("lastRightPanelPhaseForRoom",null,h.a.DEVICE,this.state.lastRoomPhase),l.a.includes(this.state.lastGroupPhase)&&c.b.setValue("lastRightPanelPhaseForGroup",null,h.a.DEVICE,this.state.lastGroupPhase),this.__emitChange()}__onDispatch(e){switch(e.action){case d.a.ViewRoom:if(e.room_id===this.lastRoomId)break;case"view_group":this.lastRoomId=e.room_id,v.includes(this.state.lastRoomPhase)&&this.setState({lastRoomPhase:l.c.RoomMemberList,lastRoomPhaseParams:{}}),this.state.lastGroupPhase===l.c.GroupMemberInfo&&this.setState({lastGroupPhase:l.c.GroupMemberList});break;case d.a.SetRightPanelPhase:{var t;let s=e.phase,n=e.refireParams;const r=null===(t=e.allowClose)||void 0===t||t;if(s===l.c.RoomMemberInfo&&e.refireParams){const{member:t}=e.refireParams,i=Object(o.b)(t);i&&(s=l.c.EncryptionPanel,n={verificationRequest:i,member:t})}if(!l.c[s])return void u.a.warn("Tried to switch right panel to unknown phase: "+s);g.includes(s)?s===this.state.lastGroupPhase?this.setState({showGroupPanel:!this.state.showGroupPanel,previousPhase:null}):this.setState({lastGroupPhase:s,showGroupPanel:!0,previousPhase:this.state.lastGroupPhase}):s===this.state.lastRoomPhase&&!n&&r?this.setState({showRoomPanel:!this.state.showRoomPanel,previousPhase:null}):this.setState({lastRoomPhase:s,showRoomPanel:!0,lastRoomPhaseParams:n||{},previousPhase:this.state.lastRoomPhase}),a.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:d.a.AfterRightPanelPhaseChange,phase:s},n||{}));break}case d.a.ToggleRightPanel:"room"===e.type?this.setState({showRoomPanel:!this.state.showRoomPanel}):this.setState({showGroupPanel:!this.state.showGroupPanel})}}static getSharedInstance(){return f.instance||(f.instance=new f),f.instance}}i()(f,"instance",void 0),window.mxRightPanelStore=f.getSharedInstance()},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(148),h=s.n(d),u=s(194),m=s(157),p=s(426),g=s(94),v=s(89),f=s(84),b=s(86),y=s(118),E=s(543),S=s(90),_=s(87),w=s(92),C=s(108),O=s(274),k=s(302),R=s(134),I=s(115),x=s(85),T=s(116),j=s(568),N=s(96),P=s(104),D=s(112),M=s(1),A=s(180);let U=function(...e){};let L=Object(x.a)("structures.TimelinePanel")((a=i=class e extends l.a.Component{constructor(t,s){super(t,s),r()(this,"lastRRSentEventId",void 0),r()(this,"lastRMSentEventId",void 0),r()(this,"messagePanel",Object(c.createRef)()),r()(this,"dispatcherRef",void 0),r()(this,"timelineWindow",void 0),r()(this,"unmounted",!1),r()(this,"readReceiptActivityTimer",void 0),r()(this,"readMarkerActivityTimer",void 0),r()(this,"onMessageListUnfillRequest",(e,t)=>{const s=e?m.b.BACKWARDS:m.b.FORWARDS;U("TimelinePanel: unpaginating events in direction",s);const n=t,i=this.state.events.findIndex(e=>e.getId()===n),a=e?i+1:this.state.events.length-i;if(a>0){U("TimelinePanel: Unpaginating",a,"in direction",s),this.timelineWindow.unpaginate(a,e);const{events:t,liveEvents:n,firstVisibleEventIndex:i}=this.getEvents(),o={events:t,liveEvents:n,firstVisibleEventIndex:i};e?o.canBackPaginate=!0:o.canForwardPaginate=!0,this.setState(o)}}),r()(this,"onPaginationRequest",(e,t,s)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,s):e.paginate(t,s)),r()(this,"onMessageListFillRequest",e=>{if(!this.shouldPaginate())return Promise.resolve(!1);const t=e?m.b.BACKWARDS:m.b.FORWARDS,s=e?"canBackPaginate":"canForwardPaginate",n=e?"backPaginating":"forwardPaginating";return this.state[s]?this.timelineWindow.canPaginate(t)?e&&0!==this.state.firstVisibleEventIndex?(U("TimelinePanel: won't",t,"paginate past first visible event"),Promise.resolve(!1)):(U("TimelinePanel: Initiating paginate; backwards:"+e),this.setState({[n]:!0}),this.onPaginationRequest(this.timelineWindow,t,20).then(t=>{if(this.unmounted)return;U("TimelinePanel: paginate complete backwards:"+e+"; success:"+t);const{events:i,liveEvents:a,firstVisibleEventIndex:o}=this.getEvents(),r={[n]:!1,[s]:t,events:i,liveEvents:a,firstVisibleEventIndex:o},c=e?m.b.FORWARDS:m.b.BACKWARDS,l=e?"canForwardPaginate":"canBackPaginate";return!this.state[l]&&this.timelineWindow.canPaginate(c)&&(U("TimelinePanel: can now",c,"paginate again"),r[l]=!0),new Promise(s=>{this.setState(r,()=>{s(t&&(!e||0===o))})})})):(U("TimelinePanel: can't",t,"paginate any further"),this.setState({[s]:!1}),Promise.resolve(!1)):(U("TimelinePanel: have given up",t,"paginating this timeline"),Promise.resolve(!1))}),r()(this,"onMessageListScroll",e=>{var t,s;null===(t=(s=this.props).onScroll)||void 0===t||t.call(s,e),this.props.manageReadMarkers&&this.doManageReadMarkers()}),r()(this,"doManageReadMarkers",Object(D.debounce)(()=>{var e;const t=this.getReadMarkerPosition();t<0&&this.setState({readMarkerVisible:!0});const s=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(s)},100,{leading:!1,trailing:!0})),r()(this,"onAction",e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate()}}),r()(this,"onRoomTimeline",(e,t,s,n,i)=>{i.timeline.getTimelineSet()===this.props.timelineSet&&!s&&i&&i.liveEvent&&this.messagePanel.current&&(this.messagePanel.current.getScrollState().stuckAtBottom?this.timelineWindow.paginate(m.b.FORWARDS,1,!1).then(()=>{if(this.unmounted)return;const{events:t,liveEvents:s,firstVisibleEventIndex:n}=this.getEvents(),i=s[s.length-1],a={events:t,liveEvents:s,firstVisibleEventIndex:n};let o;if(this.props.manageReadMarkers){const t=b.a.get().credentials.userId;o=!1,e.getSender()===t||E.a.sharedInstance().userActiveRecently()?i&&0===this.getReadMarkerPosition()&&(this.setReadMarker(i.getId(),i.getTs(),!0),a.readMarkerVisible=!1,a.readMarkerEventId=i.getId(),o=!0):a.readMarkerVisible=!0}this.setState(a,()=>{var e,t;(this.messagePanel.current.updateTimelineMinHeight(),o)&&(null===(e=(t=this.props).onReadMarkerUpdated)||void 0===e||e.call(t))})}):this.setState({canForwardPaginate:!0}))}),r()(this,"onRoomTimelineReset",(e,t)=>{t===this.props.timelineSet&&this.messagePanel.current&&this.messagePanel.current.isAtBottom()&&this.loadTimeline()}),r()(this,"canResetTimeline",()=>{var e;return null===(e=this.messagePanel)||void 0===e?void 0:e.current.isAtBottom()}),r()(this,"onRoomRedaction",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),r()(this,"onEventReplaced",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),r()(this,"onRoomReceipt",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),r()(this,"onLocalEchoUpdated",(e,t,s)=>{this.unmounted||t===this.props.timelineSet.room&&this.reloadEvents()}),r()(this,"onAccountData",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===g.a.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)}),r()(this,"onEventDecrypted",e=>{this.props.timelineSet.room&&e.getRoomId()===this.props.timelineSet.room.roomId&&this.forceUpdate()}),r()(this,"onSync",(e,t,s)=>{this.setState({clientSyncState:e})}),r()(this,"sendReadReceipt",()=>{if(v.b.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const e=b.a.get();if(!e||e.isGuest())return;let t=!0;const s=this.getCurrentReadReceipt(!0),n=this.indexForEventId(s);s&&null===n&&this.timelineWindow.canPaginate(m.b.FORWARDS)&&(t=!1);const i=this.getLastDisplayedEventIndex({ignoreOwn:!0});null===i&&(t=!1);let a=this.state.events[i];t=t&&i>n&&this.lastRRSentEventId!=a.getId();const o=this.lastRMSentEventId!=this.state.readMarkerEventId;if(t||o){t?this.lastRRSentEventId=a.getId():a=null,this.lastRMSentEventId=this.state.readMarkerEventId;const e=this.props.timelineSet.room.roomId,s=v.b.getValue("feature_hidden_read_receipts",e);U("TimelinePanel: Sending Read Markers for ",this.props.timelineSet.room.roomId,"rm",this.state.readMarkerEventId,a?"rr "+a.getId():""," hidden:"+s),b.a.get().setRoomReadMarkers(e,this.state.readMarkerEventId,a,{hidden:s}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode&&a)return b.a.get().sendReadReceipt(a,{}).catch(e=>{M.a.error(e),this.lastRRSentEventId=void 0});M.a.error(e),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0}),this.isAtEndOfLiveTimeline()&&(this.props.timelineSet.room.setUnreadNotificationCount(u.a.Total,0),this.props.timelineSet.room.setUnreadNotificationCount(u.a.Highlight,0),_.a.dispatch({action:"on_room_read",roomId:this.props.timelineSet.room.roomId}))}}),r()(this,"updateReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),this.sendReadReceipt()}),r()(this,"removeUnreadMarker",()=>{const e=b.a.get();if(!e||e.isGuest())return;v.b.getValue("feature_mark_unread")&&Object(A.e)(this.props.timelineSet.room)&&Object(A.h)(this.props.timelineSet.room,!1)}),r()(this,"jumpToLiveTimeline",()=>{var e;this.timelineWindow.canPaginate(m.b.FORWARDS)?this.loadTimeline():null===(e=this.messagePanel.current)||void 0===e||e.scrollToBottom()}),r()(this,"scrollToEventIfNeeded",e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)}),r()(this,"jumpToReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)}),r()(this,"forgetReadMarker",()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(e);let s;if(t){const n=t.getEvents().find(t=>t.getId()==e);n&&(s=n.getTs())}this.setReadMarker(e,s)}),r()(this,"isAtEndOfLiveTimeline",()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(m.b.FORWARDS)}),r()(this,"getScrollState",()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null),r()(this,"getReadMarkerPosition",()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;const t=this.messagePanel.current.getReadMarkerPosition();if(null!==t)return t;const s=e.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return s&&this.state.events.length>0?s<this.state.events[0].getTs()?-1:1:null}),r()(this,"canJumpToReadMarker",()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(e<0||null===e)}),r()(this,"handleScrollKey",e=>{this.messagePanel.current&&(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==C.a.END?this.messagePanel.current.handleScrollKey(e):this.jumpToLiveTimeline())}),r()(this,"getRelationsForEvent",(e,t,s)=>this.props.timelineSet.getRelationsForEvent(e,t,s)),U("TimelinePanel: mounting");let n=null;if(this.props.manageReadMarkers){const e=this.props.timelineSet.room.getAccountData("m.fully_read");n=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:n,backPaginating:!1,forwardPaginating:!1,clientSyncState:b.a.get().getSyncState(),isTwelveHour:v.b.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:v.b.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:v.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:v.b.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=_.a.register(this.onAction);const i=b.a.get();i.on("Room.timeline",this.onRoomTimeline),i.on("Room.timelineReset",this.onRoomTimelineReset),i.on("Room.redaction",this.onRoomRedaction),i.on("Room.redactionCancelled",this.onRoomRedaction),i.on("Room.receipt",this.onRoomReceipt),i.on("Room.localEchoUpdated",this.onLocalEchoUpdated),i.on("Room.accountData",this.onAccountData),i.on("Event.decrypted",this.onEventDecrypted),i.on("Event.replaced",this.onEventReplaced),i.on("sync",this.onSync)}UNSAFE_componentWillMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}UNSAFE_componentWillReceiveProps(e){e.timelineSet!==this.props.timelineSet&&M.a.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue");const t=e.eventId!=this.props.eventId,s=e.highlightedEventId!=this.props.highlightedEventId;if(t||s)return M.a.log("TimelinePanel switching to eventId "+e.eventId+" (was "+this.props.eventId+")"),this.initTimeline(e)}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),_.a.unregister(this.dispatcherRef);const e=b.a.get();e&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Room.timelineReset",this.onRoomTimelineReset),e.removeListener("Room.redaction",this.onRoomRedaction),e.removeListener("Room.redactionCancelled",this.onRoomRedaction),e.removeListener("Room.receipt",this.onRoomReceipt),e.removeListener("Room.localEchoUpdated",this.onLocalEchoUpdated),e.removeListener("Room.accountData",this.onAccountData),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Event.replaced",this.onEventReplaced),e.removeListener("sync",this.onSync))}readMarkerTimeout(e){var t,s,n,i;return 0===e?null!==(t=null===(s=this.context)||void 0===s?void 0:s.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(n=null===(i=this.context)||void 0===i?void 0:i.readMarkerOutOfViewThresholdMs)&&void 0!==n?n:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new O.a(e);this.readMarkerActivityTimer;){E.a.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch(e){continue}this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new O.a(500);this.readReceiptActivityTimer;){E.a.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch(e){continue}this.sendReadReceipt()}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const s=b.a.get().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==s)break}t--;const n=e[t];this.setReadMarker(n.getId(),n.getTs())}initTimeline(e){const t=e.eventId,s=e.eventPixelOffset;let n=1;return null==s&&(n=.5),this.loadTimeline(t,s,n)}loadTimeline(e,t,s){this.timelineWindow=new p.b(b.a.get(),this.props.timelineSet,{windowLimit:this.props.timelineCap});const n=()=>{this.unmounted||(this.messagePanel.current&&this.messagePanel.current.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:this.timelineWindow.canPaginate(m.b.BACKWARDS),canForwardPaginate:this.timelineWindow.canPaginate(m.b.FORWARDS),timelineLoading:!1},()=>{this.messagePanel.current?(e?this.messagePanel.current.scrollToEvent(e,t,s):this.messagePanel.current.scrollToBottom(),this.props.sendReadReceiptOnLoad&&this.sendReadReceipt(),this.removeUnreadMarker()):M.a.log("can't initialise scroll state because messagePanel didn't load")}))},i=t=>{if(this.unmounted)return;let s,n;this.setState({timelineLoading:!1}),M.a.error(`Error loading timeline panel at ${e}: ${t}`),e&&(s=()=>{_.a.dispatch({action:w.a.ViewRoom,room_id:this.props.timelineSet.room.roomId})}),n="M_FORBIDDEN"==t.errcode?Object(f.a)("Tried to load a specific point in this room's timeline, but you do not have permission to view the message in question."):Object(f.a)("Tried to load a specific point in this room's timeline, but was unable to find it."),S.a.createTrackedDialog("Failed to load timeline position","",P.a,{title:Object(f.a)("Failed to load timeline position"),description:n,onFinished:s})};if(this.props.timelineSet.getTimelineForEvent(e))this.timelineWindow.load(e,20),n();else{const t=this.timelineWindow.load(e,20);this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),t.then(n,i)}}reloadEvents(){this.unmounted||this.setState(this.getEvents())}refreshTimeline(){this.loadTimeline(),this.reloadEvents()}getEvents(){const e=this.timelineWindow.getEvents();Object(T.b)(e).reverse().forEach(e=>{b.a.get().decryptEventIfNeeded(e)});const t=this.checkForPreJoinUISI(e),s=[...e];return this.timelineWindow.canPaginate(m.b.FORWARDS)||e.push(...this.props.timelineSet.getPendingEvents()),{events:e,liveEvents:s,firstVisibleEventIndex:t}}checkForPreJoinUISI(e){const t=this.props.timelineSet.room;if(0===e.length||!t||!b.a.get().isRoomEncrypted(t.roomId))return 0;const s=b.a.get().credentials.userId;let n,i="leave";for(n=e.length-1;n>=0;n--){const a=t.getTimelineForEvent(e[n].getId());if(!a){M.a.warn(`Event ${e[n].getId()} in room ${t.roomId} is live, but it does not have a timeline`);continue}const o=a.getState(m.b.FORWARDS).getMember(s);i=o?o.membership:"leave";const r=a.getEvents();for(let t=r.length-1;t>=0;t--){const a=r[t];if(a.getId()===e[n].getId())break;if(a.getStateKey()===s&&"m.room.member"===a.getType()){i=a.getPrevContent().membership||"leave"}}break}for(;n>=0;n--){const t=e[n];if(t.getStateKey()===s&&"m.room.member"===t.getType()){i=t.getPrevContent().membership||"leave"}else if("leave"===i&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return n+1}return 0}indexForEventId(e){for(let t=0;t<this.state.events.length;++t)if(e==this.state.events[t].getId())return t;return null}getLastDisplayedEventIndex(e={}){const t=e.ignoreOwn||!1,s=e.allowPartial||!1,n=this.messagePanel.current;if(!n)return null;const i=h.a.findDOMNode(n);if(!i)return null;const a=i.getBoundingClientRect(),o=b.a.get().credentials.userId,r=e=>{if(e){const t=e.getBoundingClientRect();if(s&&t.top<a.bottom||!s&&t.bottom<a.bottom)return!0}return!1};let c=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var l;const s=this.state.liveEvents[e],i=n.getNodeForEventId(s.getId()),a=r(i);if(a&&0!==c)return e+c;i&&!a&&(c=0);const d=!!s.status||t&&s.getSender()===o;if(!(!Object(R.d)(s,null===(l=this.context)||void 0===l?void 0:l.showHiddenEventsInTimeline)||Object(k.a)(s,this.context))&&i){if(!d&&a)return e}else(!d||d&&0!==c)&&++c}return null}getCurrentReadReceipt(e=!1){const t=b.a.get();if(null==t)return null;const s=t.credentials.userId;return this.props.timelineSet.room.getEventReadUpTo(s,e)}setReadMarker(t,s,n=!1){const i=this.props.timelineSet.room.roomId;t!==this.state.readMarkerEventId&&(e.roomReadMarkerTsMap[i]=s,n||this.setState({readMarkerEventId:t},this.props.onReadMarkerUpdated))}shouldPaginate(){return!this.state.events.some(e=>e.isBeingDecrypted())}render(){var e,t,s,n,i;if(this.state.timelineLoading)return l.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},l.a.createElement(N.a,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return l.a.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},l.a.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const a=!this.timelineWindow.canPaginate(m.b.FORWARDS),o=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),r=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return l.a.createElement(j.a,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:o,events:r,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,suppressFirstDateSeparator:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:b.a.get().credentials.userId,stickyBottom:a,onScroll:this.onMessageListScroll,onUserScroll:this.props.onUserScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(e=null===(t=this.context)||void 0===t?void 0:t.showTwelveHourTimestamps)&&void 0!==e?e:this.state.isTwelveHour,alwaysShowTimestamps:null!==(s=null!==(n=this.props.alwaysShowTimestamps)&&void 0!==n?n:null===(i=this.context)||void 0===i?void 0:i.alwaysShowTimestamps)&&void 0!==s?s:this.state.alwaysShowTimestamps,className:this.props.className,tileShape:this.props.tileShape,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,userNameColorMode:this.props.userNameColorMode,enableFlair:v.b.getValue(I.b.Flair),hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping})}},r()(i,"contextType",y.b),r()(i,"roomReadMarkerTsMap",{}),r()(i,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1}),n=a))||n;t.a=L},,function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(121),o=s(5),r=s(181),c=s(157),l=s(4),d=s(86),h=s(89),u=s(100),m=s(1);class p extends o.EventEmitter{constructor(...e){super(...e),i()(this,"crawlerCheckpoints",[]),i()(this,"crawler",null),i()(this,"currentCheckpoint",null),i()(this,"onSync",async(e,t,s)=>{const n=a.a.get().getEventIndexingManager();if("PREPARED"===t&&"SYNCING"===e){return await n.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"!==t||"SYNCING"!==e||await n.commitLiveEvents()}),i()(this,"onRoomTimeline",async(e,t,s,n,i)=>{const a=d.a.get();a.isRoomEncrypted(t.roomId)&&!s&&i&&i.liveEvent&&!e.isRedacted()&&(await a.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))}),i()(this,"onRoomStateEvent",async(e,t)=>{d.a.get().isRoomEncrypted(t.roomId)&&("m.room.encryption"!==e.getType()||await this.isRoomIndexed(t.roomId)||(m.a.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))}),i()(this,"onRedaction",async(e,t)=>{if(!d.a.get().isRoomEncrypted(t.roomId))return;const s=a.a.get().getEventIndexingManager();try{await s.deleteEvent(e.getAssociatedId())}catch(e){m.a.log("EventIndex: Error deleting event from index",e)}}),i()(this,"onTimelineReset",async(e,t,s)=>{null!==e&&d.a.get().isRoomEncrypted(e.roomId)&&(m.a.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))})}async init(){const e=a.a.get().getEventIndexingManager();this.crawlerCheckpoints=await e.loadCheckpoints(),m.a.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners()}registerListeners(){const e=d.a.get();e.on("sync",this.onSync),e.on("Room.timeline",this.onRoomTimeline),e.on("Room.timelineReset",this.onTimelineReset),e.on("Room.redaction",this.onRedaction),e.on("RoomState.events",this.onRoomStateEvent)}removeListeners(){const e=d.a.get();null!==e&&(e.removeListener("sync",this.onSync),e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Room.timelineReset",this.onTimelineReset),e.removeListener("Room.redaction",this.onRedaction),e.removeListener("RoomState.events",this.onRoomStateEvent))}async addInitialCheckpoints(){const e=a.a.get().getEventIndexingManager(),t=d.a.get(),s=t.getRooms().filter(e=>t.isRoomEncrypted(e.roomId));m.a.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(s.map(async t=>{const s=t.getLiveTimeline().getPaginationToken(c.a.Backward),n={roomId:t.roomId,token:s,direction:c.a.Backward,fullCrawl:!0},i={roomId:t.roomId,token:s,direction:c.a.Forward};try{n.token&&(await e.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),i.token&&(await e.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i))}catch(e){m.a.log("EventIndex: Error adding initial checkpoints for room",t.roomId,n,i,e)}}))}isValidEvent(e){const t=["m.room.message","m.room.name","m.room.topic"].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let s=!0,n=!0;if("m.room.message"!==e.getType()||e.isRedacted())"m.room.topic"!==e.getType()||e.isRedacted()?"m.room.name"!==e.getType()||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;s=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&s&&n}eventToJson(e){const t=e.toJSON(),s=e.isEncrypted()?t.decrypted:t;return e.isEncrypted()?(s.curve25519Key=e.getSenderKey(),s.ed25519Key=e.getClaimedEd25519Key(),s.algorithm=e.getWireContent().algorithm,s.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete s.curve25519Key,delete s.ed25519Key,delete s.algorithm,delete s.forwardingCurve25519KeyChain),s}async addLiveEventToIndex(e){const t=a.a.get().getEventIndexingManager();if(!this.isValidEvent(e))return;const s=this.eventToJson(e),n={displayname:e.sender.rawDisplayName,avatar_url:e.sender.getMxcAvatarUrl()};await t.addEventToIndex(s,n)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const s=t[e];await this.addLiveEventToIndex(s)}}async addRoomCheckpoint(e,t=!1){const s=a.a.get().getEventIndexingManager(),n=d.a.get().getRoom(e);if(!n)return;const i=n.getLiveTimeline(),o=i.getPaginationToken(c.a.Backward);if(!o)return void await this.addEventsFromLiveTimeline(i);const r={roomId:n.roomId,token:o,fullCrawl:t,direction:c.a.Backward};m.a.log("EventIndex: Adding checkpoint",r);try{await s.addCrawlerCheckpoint(r)}catch(e){m.a.log("EventIndex: Error adding new checkpoint for room",n.roomId,r,e)}this.crawlerCheckpoints.push(r)}async crawlerFunc(){let e=!1;const t=d.a.get(),s=a.a.get().getEventIndexingManager();this.crawler={cancel:()=>{e=!0}};let n=!1;for(;!e;){let i=h.b.getValueAt(u.a.DEVICE,"crawlerSleepTime");if(i=Math.max(i,100),n&&(i=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await Object(l.I)(i),e)break;const a=this.crawlerCheckpoints.shift();if(void 0===a){n=!0;continue}this.currentCheckpoint=a,this.emitNewCheckpoint(),n=!1;const o=t.getEventMapper({preventReEmit:!0});let r;try{r=await t.createMessagesRequest(a.roomId,a.token,100,a.direction)}catch(e){if(403===e.httpStatus){m.a.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",a);try{await s.removeCrawlerCheckpoint(a)}catch(e){m.a.log("EventIndex: Error removing checkpoint",a,e)}continue}m.a.log("EventIndex: Error crawling using checkpoint:",a,",",e),this.crawlerCheckpoints.push(a);continue}if(e){this.crawlerCheckpoints.push(a);break}if(0===r.chunk.length){m.a.log("EventIndex: Done with the checkpoint",a);try{await s.removeCrawlerCheckpoint(a)}catch(e){m.a.log("EventIndex: Error removing checkpoint",a,e)}continue}const c=r.chunk.map(o);let d=[];void 0!==r.state&&(d=r.state.map(o));const p={};d.forEach(e=>{e.event.content&&"join"===e.event.content.membership&&(p[e.event.sender]={displayname:e.event.content.displayname,avatar_url:e.event.content.avatar_url})});const g=c.filter(e=>e.isEncrypted()).map(e=>t.decryptEventIfNeeded(e,{isRetry:!0,emit:!1}));await Promise.all(g);const v=c.filter(this.isValidEvent),f=c.filter(e=>"m.room.redaction"===e.getType()),b=v.map(e=>{const t=this.eventToJson(e);let s={};t.sender in p&&(s=p[t.sender]);return{event:t,profile:s}});let y;r.end&&(y={roomId:a.roomId,token:r.end,fullCrawl:a.fullCrawl,direction:a.direction});try{for(let e=0;e<f.length;e++){const t=f[e],n=t.getAssociatedId();n?await s.deleteEvent(n):m.a.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await s.addHistoricEvents(b,y,a);if(!y){m.a.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",a);continue}!0===e&&!0!==y.fullCrawl?(m.a.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",a),await s.removeCrawlerCheckpoint(y)):(!0===e&&m.a.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",a),this.crawlerCheckpoints.push(y))}catch(e){m.a.log("EventIndex: Error durring a crawl",e),this.crawlerCheckpoints.push(a)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){const e=a.a.get().getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await e.closeEventIndex()}async search(e){return a.a.get().getEventIndexingManager().searchEventIndex(e)}async loadFileEvents(e,t=10,s=null,n=c.b.BACKWARDS){const i=d.a.get(),o=a.a.get().getEventIndexingManager(),l={roomId:e.roomId,limit:t};let h;s&&(l.fromEvent=s,l.direction=n);try{h=await o.loadFileEvents(l)}catch(e){return m.a.log("EventIndex: Error getting file events",e),[]}const u=i.getEventMapper();return h.map(t=>{const s=u(t.event),n=new r.a(e.roomId,s.getSender());n.name=t.profile.displayname+" ("+s.getSender()+")";const i=u({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:"m.room.member",event_id:s.getId()+":eventIndex",room_id:s.getRoomId(),sender:s.getSender(),origin_server_ts:s.getTs(),state_key:s.getSender()});return n.events.member=i,s.sender=n,s})}async populateFileTimeline(e,t,s,n=10,i=null,a=c.b.BACKWARDS){const o=await this.loadFileEvents(s,n,i,a);null===i&&(o.reverse(),a=a==c.b.BACKWARDS?c.b.FORWARDS:c.b.BACKWARDS),o.forEach(s=>{e.eventIdToTimeline(s.getId())||e.addEventToTimeline(s,t,a==c.b.BACKWARDS)});let r=!1,l="";return o.length>0&&(l=o[o.length-1].getId(),r=!0),m.a.log("EventIndex: Populating file panel with",o.length,"events and setting the pagination token to",l),t.setPaginationToken(l,c.b.BACKWARDS),r}paginateTimelineWindow(e,t,s,n){const i=t.getTimelineIndex(s);if(!i)return Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(t.extend(s,n))return Promise.resolve(!0);const a=(async(e,t,s,n,i)=>{const a=t.timeline,o=a.getTimelineSet(),r=a.getPaginationToken(n),c=await this.populateFileTimeline(o,a,s,i,r,n);return t.pendingPaginate=null,e.extend(n,i),c})(t,i,e,s,n);return i.pendingPaginate=a,a}async getStats(){return a.a.get().getEventIndexingManager().getStats()}async isRoomIndexed(e){return a.a.get().getEventIndexingManager().isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=d.a.get();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach((e,s)=>{t.add(e.roomId)}),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const s=d.a.get();return s.getRooms().filter(e=>s.isRoomEncrypted(e.roomId)).forEach((t,s)=>{e.add(t.roomId)}),{crawlingRooms:t,totalRooms:e}}}class g{constructor(){i()(this,"index",null),i()(this,"error",null),i()(this,"_supportIsInstalled",!1)}async init(){const e=a.a.get().getEventIndexingManager();return e?(this._supportIsInstalled=await e.supportsEventIndexing(),this.supportIsInstalled()?h.b.getValueAt(u.a.DEVICE,"enableEventIndexing")?this.initEventIndex():(m.a.log("EventIndex: Event indexing is disabled, not initializing"),!1):(m.a.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(m.a.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){const e=new p,t=a.a.get().getEventIndexingManager(),s=d.a.get(),n=s.getUserId(),i=s.getDeviceId();try{await t.initEventIndex(n,i);const s=await t.getUserVersion(),a=await t.isEventIndexEmpty();a?await t.setUserVersion(1):0!==s||a||(await t.closeEventIndex(),await this.deleteEventIndex(),await t.initEventIndex(n,i),await t.setUserVersion(1)),m.a.log("EventIndex: Successfully initialized the event index"),await e.init()}catch(e){return m.a.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=e,!0}platformHasSupport(){return null!==a.a.get().getEventIndexingManager()}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){const e=a.a.get().getEventIndexingManager();null!==e&&(await this.unset(),m.a.log("EventIndex: Deleting event index."),await e.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new g);t.a=window.mxEventIndexPeg},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(4),i=s(5);function a(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}n.t(a,i.EventEmitter),a.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},a.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},a.prototype.setInviter=function(e){this.inviter=e}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(99),i=s.n(n),a=s(4),o=s(1),r=s(196);function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function l(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const d=[r.c.Override,r.c.ContentSpecific,r.c.RoomSpecific,r.c.SenderSpecific,r.c.Underride],h=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:r.a.EventMatch,key:"type",pattern:"m.room.tombstone"},{kind:r.a.EventMatch,key:"state_key",pattern:""}],actions:[r.b.Notify,{set_tweak:r.e.Highlight,value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:r.a.EventMatch,key:"type",pattern:"m.reaction"}],actions:[r.b.DontNotify]}];class u{constructor(e){this.client=e}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(let s=0;s<e.length;++s){const n=e[s];n===r.b.Notify?t.notify=!0:"object"==typeof n&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value)}return t}static rewriteDefaultRules(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const s=t.global.override;for(const e of h){const t=s.find(t=>t.rule_id===e.rule_id);if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;o.a.warn("Adding default global override for "+t),s.push(e)}}return t}matchingRuleFromKindSet(e,t){for(let s=0;s<d.length;++s){const n=d[s],i=t[n];if(i)for(let t=0;t<i.length;++t){const s=i[t];if(!s.enabled)continue;const a=this.templateRuleToRaw(n,s);if(a&&this.ruleMatchesEvent(a,e))return l(l({},s),{},{kind:n})}}return null}templateRuleToRaw(e,t){const s={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case r.c.Underride:case r.c.Override:s.conditions=t.conditions;break;case r.c.RoomSpecific:if(!t.rule_id)return null;s.conditions.push({kind:r.a.EventMatch,key:"room_id",value:t.rule_id});break;case r.c.SenderSpecific:if(!t.rule_id)return null;s.conditions.push({kind:r.a.EventMatch,key:"user_id",value:t.rule_id});break;case r.c.ContentSpecific:if(!t.pattern)return null;s.conditions.push({kind:r.a.EventMatch,key:"content.body",pattern:t.pattern})}return s}eventFulfillsCondition(e,t){switch(e.kind){case r.a.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case r.a.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case r.a.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case r.a.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const s=e.key;if(!s)return!1;const n=this.client.getRoom(t.getRoomId());return!(null==n||!n.currentState)&&n.currentState.mayTriggerNotifOfType(s,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const s=this.client.getRoom(t.getRoomId());if(!s||!s.currentState||!s.currentState.members)return!1;const n=s.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)([0-9]*)$/);if(!i)return!1;const a=i[1],o=parseInt(i[2]);if(isNaN(o))return!1;switch(a){case"":case"==":return n==o;case"<":return n<o;case">":return n>o;case"<=":return n<=o;case">=":return n>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){let s=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(s=t.getClearContent()),!s||!s.body||"string"!=typeof s.body)return!1;const n=this.client.getRoom(t.getRoomId());if(!(n&&n.currentState&&n.currentState.members&&n.currentState.getMember(this.client.credentials.userId)))return!1;const i=n.currentState.getMember(this.client.credentials.userId).name,o=new RegExp("(^|\\W)"+Object(a.p)(i)+"(\\W|$)","i");return s.body.search(o)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const s=this.valueForDottedKey(e.key,t);if("string"!=typeof s)return!1;if(e.value)return e.value===s;if("string"!=typeof e.pattern)return!1;let n;return n="content.body"==e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$"),!!s.match(n)}createCachedRegex(e,t,s){return u.cachedGlobToRegex[t]||(u.cachedGlobToRegex[t]=new RegExp(e+Object(a.s)(t)+s,"i")),u.cachedGlobToRegex[t]}valueForDottedKey(e,t){const s=e.split(".");let n;const i=s[0];for("content"===i?(n=t.getContent(),s.shift()):"type"===i?(n=t.getType(),s.shift()):n=t.event;s.length>0;){const e=s.shift();if(Object(a.v)(n[e]))return null;n=n[e]}return n}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.credentials.userId?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const s=this.matchingRuleForEventWithRulesets(e,t);if(!s)return{};const n=u.actionListToActionsObject(s.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight=s.kind==r.c.ContentSpecific),n}ruleMatchesEvent(e,t){let s=!0;for(let n=0;n<e.conditions.length;++n){const i=e.conditions[n];s&=this.eventFulfillsCondition(i,t)}return s}actionsForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){for(const t of["global"])if(void 0!==this.client.pushRules[t])for(const s of d)if(void 0!==this.client.pushRules[t][s])for(const n of this.client.pushRules[t][s])if(n.rule_id===e)return n;return null}}i()(u,"cachedGlobToRegex",{})},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var n=s(99),i=s.n(n),a=s(1),o=s(189);let r;!function(e){e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR"}(r||(r={}));class c{static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:c.FAIL_ERROR,error:c.ERROR_INVALID,base_url:null},"m.identity_server":{state:c.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return a.a.error("No m.homeserver key in config"),t["m.homeserver"].state=c.FAIL_PROMPT,t["m.homeserver"].error=c.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return a.a.error("No m.homeserver base_url in config"),t["m.homeserver"].state=c.FAIL_PROMPT,t["m.homeserver"].error=c.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const s=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!s)return a.a.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=c.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=await this.fetchWellKnownObject(s+"/_matrix/client/versions");if(!n||!n.raw.versions)return a.a.error("Invalid /versions response"),t["m.homeserver"].error=c.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=s,Promise.resolve(t);t["m.homeserver"]={state:c.SUCCESS,error:null,base_url:s};let i="";if(e["m.identity_server"]){const s={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:c.FAIL_PROMPT,error:c.ERROR_INVALID_IS,base_url:null}};if(i=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!i)return a.a.error("Invalid base_url for m.identity_server"),s["m.identity_server"].error=c.ERROR_INVALID_IS_BASE_URL,Promise.resolve(s);const n=await this.fetchWellKnownObject(i+"/_matrix/identity/api/v1");if(!n||!n.raw||n.action!==r.SUCCESS)return a.a.error("Invalid /api/v1 response"),s["m.identity_server"].error=c.ERROR_INVALID_IDENTITY_SERVER,s["m.identity_server"].base_url=i,Promise.resolve(s)}return i&&i.toString().length>0&&(t["m.identity_server"]={state:c.SUCCESS,error:null,base_url:i}),Object.keys(e).map(s=>{if("m.homeserver"===s||"m.identity_server"===s){const n=["error","state","base_url"];for(const i of Object.keys(e[s]))n.includes(i)||(t[s][i]=e[s][i])}else t[s]=e[s]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:c.FAIL_ERROR,error:c.ERROR_INVALID,base_url:null},"m.identity_server":{state:c.PROMPT,error:null,base_url:null}},s=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return s&&s.action===r.SUCCESS?c.fromDiscoveryConfig(s.raw):(a.a.error("No response or error when parsing .well-known"),s.reason&&a.a.error(s.reason),s.action===r.IGNORE?t["m.homeserver"]={state:c.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=c.FAIL_PROMPT,t["m.homeserver"].error=c.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=o.URL?new o.URL(e):new URL(e)}catch(s){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const s=t.port?":"+t.port:"",n=t.pathname?t.pathname:"";let i=`${t.protocol}//${t.hostname}${s}${n}`;return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}catch(e){return a.a.error(e),!1}}static async fetchWellKnownObject(e){return new Promise((function(t,n){const i=s(156).getRequest();if(!i)throw new Error("No request library available");i({method:"GET",uri:e,timeout:5e3},(e,s,n)=>{if(e||s&&(s.statusCode<200||s.statusCode>=300)){let n=r.FAIL_PROMPT,i=(e?e.message:null)||"General failure";return s&&404===s.statusCode&&(n=r.IGNORE,i=c.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:n,reason:i,error:e})}try{t({raw:JSON.parse(n),action:r.SUCCESS})}catch(e){let s=c.ERROR_INVALID;"SyntaxError"===e.name&&(s=c.ERROR_INVALID_JSON),t({raw:{},action:r.FAIL_PROMPT,reason:s,error:e})}})}))}}i()(c,"ERROR_INVALID","Invalid homeserver discovery response"),i()(c,"ERROR_GENERIC_FAILURE","Failed to get autodiscovery configuration from server"),i()(c,"ERROR_INVALID_HS_BASE_URL","Invalid base_url for m.homeserver"),i()(c,"ERROR_INVALID_HOMESERVER","Homeserver URL does not appear to be a valid Matrix homeserver"),i()(c,"ERROR_INVALID_IS_BASE_URL","Invalid base_url for m.identity_server"),i()(c,"ERROR_INVALID_IDENTITY_SERVER","Identity server URL does not appear to be a valid identity server"),i()(c,"ERROR_INVALID_IS","Invalid identity server discovery response"),i()(c,"ERROR_MISSING_WELLKNOWN","No .well-known JSON file found"),i()(c,"ERROR_INVALID_JSON","Invalid JSON"),i()(c,"ALL_ERRORS",[c.ERROR_INVALID,c.ERROR_GENERIC_FAILURE,c.ERROR_INVALID_HS_BASE_URL,c.ERROR_INVALID_HOMESERVER,c.ERROR_INVALID_IS_BASE_URL,c.ERROR_INVALID_IDENTITY_SERVER,c.ERROR_INVALID_IS,c.ERROR_MISSING_WELLKNOWN,c.ERROR_INVALID_JSON]),i()(c,"FAIL_ERROR",r.FAIL_ERROR),i()(c,"FAIL_PROMPT",r.FAIL_PROMPT),i()(c,"PROMPT",r.PROMPT),i()(c,"SUCCESS",r.SUCCESS)},function(e,t,s){"use strict";(function(e){s.d(t,"c",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return h}));var n=s(4),i=s(149);const a="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,o=new Uint8Array(8);function r(t,s){const i=Object(n.r)(),a=i.createHmac("sha256",o).update(t).digest(),r=e.alloc(1,1),c=i.createHmac("sha256",a).update(s,"utf8").update(r).digest();r[0]=2;return[c,i.createHmac("sha256",a).update(c).update(s,"utf8").update(r).digest()]}async function c(e,t){const s=await a.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await a.deriveBits({name:"HKDF",salt:o,info:(new TextEncoder).encode(t),hash:"SHA-256"},s,512),i=n.slice(0,32),r=n.slice(32),c=a.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=a.importKey("raw",r,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return await Promise.all([c,l])}function l(t,s,o,l){return a?async function(e,t,s,n){let o;n?o=Object(i.decodeBase64)(n):(o=new Uint8Array(16),window.crypto.getRandomValues(o),o[8]&=127);const[r,l]=await c(t,s),d=(new TextEncoder).encode(e),h=await a.encrypt({name:"AES-CTR",counter:o,length:64},r,d),u=await a.sign({name:"HMAC"},l,h);return{iv:Object(i.encodeBase64)(o),ciphertext:Object(i.encodeBase64)(h),mac:Object(i.encodeBase64)(u)}}(t,s,o,l):async function(t,s,a,o){const c=Object(n.r)();if(!c)throw new Error("No usable crypto implementation");let l;o?l=Object(i.decodeBase64)(o):(l=c.randomBytes(16),l[8]&=127);const[d,h]=r(s,a),u=c.createCipheriv("aes-256-ctr",d,l),m=e.concat([u.update(t,"utf8"),u.final()]),p=c.createHmac("sha256",h).update(m).digest("base64");return{iv:Object(i.encodeBase64)(l),ciphertext:m.toString("base64"),mac:p}}(t,s,o,l)}function d(t,s,o){return a?async function(e,t,s){const[n,o]=await c(t,s),r=Object(i.decodeBase64)(e.ciphertext);if(!await a.verify({name:"HMAC"},o,Object(i.decodeBase64)(e.mac),r))throw new Error(`Error decrypting secret ${s}: bad MAC`);const l=await a.decrypt({name:"AES-CTR",counter:Object(i.decodeBase64)(e.iv),length:64},n,r);return(new TextDecoder).decode(new Uint8Array(l))}(t,s,o):async function(t,s,a){const o=Object(n.r)();if(!o)throw new Error("No usable crypto implementation");const[c,l]=r(s,a);if(o.createHmac("sha256",l).update(e.from(t.ciphertext,"base64")).digest("base64").replace(/=+$/g,"")!==t.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${a}: bad MAC`);const d=o.createDecipheriv("aes-256-ctr",c,Object(i.decodeBase64)(t.iv));return d.update(t.ciphertext,"base64","utf8")+d.final("utf8")}(t,s,o)}function h(e,t){return l("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}}).call(this,s(27).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return f})),s.d(t,"c",(function(){return b}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s(84),d=s(128),h=s(85),u=s(91),m=s.n(u),p=s(88),g=s(1);class v{constructor(e,t,s,n){this.id=e,this.label=t,this.icon=s,this.body=n}}let f;!function(e){e.LEFT="left",e.TOP="top"}(f||(f={}));let b=Object(h.a)("structures.TabbedView")((a=i=class extends c.Component{constructor(e){super(e);let t=0;if(e.initialTabId){const s=e.tabs.findIndex(t=>t.id===e.initialTabId);s>=0&&(t=s)}this.state={activeTabIndex:t}}getActiveTabIndex(){return this.state&&this.state.activeTabIndex?this.state.activeTabIndex:0}setActiveTab(e){const t=this.props.tabs.indexOf(e);-1!==t?(this.props.onChange&&this.props.onChange(e.id),this.setState({activeTabIndex:t})):g.a.error("Could not find tab "+e.label+" in tabs")}renderTabLabel(e){let t="mx_TabbedView_tabLabel ";this.props.tabs.indexOf(e)===this.getActiveTabIndex()&&(t+="mx_TabbedView_tabLabel_active");let s=null;e.icon&&(s=c.createElement("span",{className:"mx_TabbedView_maskedIcon "+e.icon}));const n=Object(l.a)(e.label);return c.createElement(p.a,{className:t,key:"tab_label_"+e.label,onClick:()=>this.setActiveTab(e)},s,c.createElement("span",{className:"mx_TabbedView_tabLabel_text"},n))}renderTabPanel(e){return c.createElement("div",{className:"mx_TabbedView_tabPanel",key:"mx_tabpanel_"+e.label},c.createElement(d.a,{className:"mx_TabbedView_tabPanelContent"},e.body))}render(){const e=this.props.tabs.map(e=>this.renderTabLabel(e)),t=this.renderTabPanel(this.props.tabs[this.getActiveTabIndex()]),s=m()({mx_TabbedView:!0,mx_TabbedView_tabsOnLeft:this.props.tabLocation==f.LEFT,mx_TabbedView_tabsOnTop:this.props.tabLocation==f.TOP});return c.createElement("div",{className:s},c.createElement("div",{className:"mx_TabbedView_tabLabels"},e),t)}},r()(i,"defaultProps",{tabLocation:f.LEFT}),n=a))||n},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"Notifier",(function(){return w}));var n=s(86),i=s(93),a=s(121),o=s(255),r=s(140),c=s(199),l=s(87),d=s(84),h=s(90),u=s(89),m=s(542),p=s(100),g=s(741),v=s(132),f=s(543),b=s(103),y=s(104),E=s(1),S=s(94);const _={[S.b.KeyVerificationRequest]:e=>{const t=(e.sender||{}).name;return Object(d.a)("%(name)s is requesting verification",{name:t})}},w={notifsByRoom:{},pendingEncryptedEventIds:[],notificationMessageForEvent:function(e){return _.hasOwnProperty(e.getContent().msgtype)?_[e.getContent().msgtype](e):o.b(e)},_displayPopupNotification:function(t,s){const n=a.a.get();if(!n)return;if(!n.supportsNotifications()||!n.maySendNotifications())return;if(e.document.hasFocus())return;let i,o=this.notificationMessageForEvent(t);if(!o)return;t.sender&&s.name!==t.sender.name?"m.room.member"===t.getType()?i=s.name:t.sender&&(i=t.sender.name+" ("+s.name+")",t.getContent().body&&!_.hasOwnProperty(t.getContent().msgtype)&&(o=t.getContent().body)):(i=s.name,t.getContent().body&&!_.hasOwnProperty(t.getContent().msgtype)&&(o=t.getContent().body)),this.isBodyEnabled()||(o="");let r=null;t.sender&&!u.b.getValue("lowBandwidth")&&(r=c.a(t.sender,40,40,"crop"));const l=n.displayNotification(i,o,r,s);l&&(void 0===this.notifsByRoom[t.getRoomId()]&&(this.notifsByRoom[t.getRoomId()]=[]),this.notifsByRoom[t.getRoomId()].push(l))},getSoundForRoom:function(e){const t=u.b.getValue("notificationSound",e);return t?t.url?t.url.startsWith("mxc://")?{url:Object(b.b)(t.url).srcHttp,name:t.name,type:t.type,size:t.size}:(E.a.warn(e+" has custom notification sound event, but url is not a mxc url"),null):(E.a.warn(e+" has custom notification sound event, but no url key"),null):null},_playAudioNotification:async function(e,t){const s=this.getSoundForRoom(t.roomId);E.a.log(`Got sound ${s&&s.name||"default"} for ${t.roomId}`);try{const e=document.querySelector(s?`audio[src='${s.url}']`:"#messageAudio");let t=e;if(!e){if(!s)return void E.a.error("No audio element or sound to play for notification");t=new Audio(s.url),s.type&&(t.type=s.type),document.body.appendChild(t)}await t.play()}catch(e){E.a.warn("Caught error when trying to fetch room notification sound:",e)}},start:function(){this.boundOnEvent=this.boundOnEvent||this.onEvent.bind(this),this.boundOnSyncStateChange=this.boundOnSyncStateChange||this.onSyncStateChange.bind(this),this.boundOnRoomReceipt=this.boundOnRoomReceipt||this.onRoomReceipt.bind(this),this.boundOnEventDecrypted=this.boundOnEventDecrypted||this.onEventDecrypted.bind(this),n.a.get().on("event",this.boundOnEvent),n.a.get().on("Room.receipt",this.boundOnRoomReceipt),n.a.get().on("Event.decrypted",this.boundOnEventDecrypted),n.a.get().on("sync",this.boundOnSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1},stop:function(){n.a.get()&&(n.a.get().removeListener("Event",this.boundOnEvent),n.a.get().removeListener("Room.receipt",this.boundOnRoomReceipt),n.a.get().removeListener("Event.decrypted",this.boundOnEventDecrypted),n.a.get().removeListener("sync",this.boundOnSyncStateChange)),this.isSyncing=!1},supportsDesktopNotifications:function(){const e=a.a.get();return e&&e.supportsNotifications()},setEnabled:function(e,t){const s=a.a.get();s&&(r.a.trackEvent("Notifier","Set Enabled",String(e)),u.b.isLevelSupported(p.a.DEVICE)&&u.b.setValue("audioNotificationsEnabled",null,p.a.DEVICE,this.isEnabled()),e?s.requestNotificationPermission().then(e=>{if("granted"===e)t&&t(),l.a.dispatch({action:"notifier_enabled",value:!0});else{const t=i.a.get().brand,s="denied"===e?Object(d.a)("%(brand)s does not have permission to send you notifications - please check your browser settings",{brand:t}):Object(d.a)("%(brand)s was not given permission to send notifications - please try again",{brand:t});h.a.createTrackedDialog("Unable to enable Notifications",e,y.a,{title:Object(d.a)("Unable to enable Notifications"),description:s})}}):l.a.dispatch({action:"notifier_enabled",value:!1}),this.setPromptHidden(!0))},isEnabled:function(){return this.isPossible()&&u.b.getValue("notificationsEnabled")},isPossible:function(){const e=a.a.get();return!!e&&(!!e.supportsNotifications()&&!!e.maySendNotifications())},isBodyEnabled:function(){return this.isEnabled()&&u.b.getValue("notificationBodyEnabled")},isAudioEnabled:function(){return u.b.getValue("audioNotificationsEnabled")},setPromptHidden:function(t,s=!0){this.toolbarHidden=t,r.a.trackEvent("Notifier","Set Toolbar Hidden",String(t)),Object(m.a)(),s&&e.localStorage&&e.localStorage.setItem("notifications_hidden",String(t))},shouldShowPrompt:function(){const e=n.a.get();if(!e)return!1;return!e.isGuest()&&this.supportsDesktopNotifications()&&!Object(g.c)()&&!this.isEnabled()&&!this._isPromptHidden()},_isPromptHidden:function(){return e.localStorage?"true"===e.localStorage.getItem("notifications_hidden"):this.toolbarHidden},onSyncStateChange:function(e){"SYNCING"===e?this.isSyncing=!0:"STOPPED"!==e&&"ERROR"!==e||(this.isSyncing=!1)},onEvent:function(e){if(this.isSyncing&&e.getSender()!==n.a.get().credentials.userId)if(n.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this._evaluateEvent(e)},onEventDecrypted:function(e){if(e.isDecryptionFailure())return;const t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this._evaluateEvent(e))},onRoomReceipt:function(e,t){if(0===t.getUnreadNotificationCount()){const e=a.a.get();if(!e)return;if(void 0===this.notifsByRoom[t.roomId])return;for(const s of this.notifsByRoom[t.roomId])e.clearNotification(s);delete this.notifsByRoom[t.roomId]}},_evaluateEvent:function(e){const t=n.a.get().getRoom(e.getRoomId()),s=n.a.get().getPushActionsForEvent(e);if(s&&s.notify){if(v.a.getRoomId()===t.roomId&&f.a.sharedInstance().userActiveRecently())return;if(u.b.getValue("doNotDisturb"))return;this.isEnabled()&&this._displayPopupNotification(e,t),s.tweaks.sound&&this.isAudioEnabled()&&(a.a.get().loudNotification(e,t),this._playAudioNotification(e,t))}}};window.mxNotifier||(window.mxNotifier=w),t.default=window.mxNotifier}.call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return I}));var n=s(82),i=s.n(n),a=s(84),o=s(448),r=s(159),c=s(89),l=s(415),d=s(154),h=s(122),u=s(92),m=s(87),p=s(127),g=s(94),v=s(86),f=s(325),b=s(1),y=s(4);const E=()=>{m.a.dispatch({action:"open_room_settings",initial_tab_id:f.b})};function S(e){return()=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let s=e.getContent().body;if(e.isRedacted()){var n;s=Object(a.a)("Message deleted");const t=e.getUnsigned(),i=null==t||null===(n=t.redacted_because)||void 0===n?void 0:n.sender;if(i&&i!==e.getSender()){const t=v.a.get().getRoom(e.getRoomId()),n=null==t?void 0:t.getMember(i);s=Object(a.a)("Message deleted by %(name)s",{name:(null==n?void 0:n.name)||i})}}return s=e.getContent().msgtype===g.b.Emote?"* "+t+" "+s:e.getContent().msgtype===g.b.Image?Object(a.a)("%(senderDisplayName)s sent an image.",{senderDisplayName:t}):e.getType()==g.a.Sticker?Object(a.a)("%(senderDisplayName)s sent a sticker.",{senderDisplayName:t}):t+": "+s,s}}const _=(e,t)=>{m.a.dispatch({action:u.a.ViewRoom,event_id:e,highlighted:!0,room_id:t})},w=()=>{m.a.dispatch({action:u.a.SetRightPanelPhase,phase:h.c.PinnedMessages,allowClose:!1})};function C(e){const t=e.getSender(),{entity:s}=e.getPrevContent(),{entity:n,recommendation:i,reason:o}=e.getContent();return n?i&&o?n===s?l.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s updated the rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s updated the rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s updated the rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):()=>Object(a.a)("%(senderName)s updated a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):s?l.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s changed a rule that was banning users matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):l.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s changed a rule that was banning rooms matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):l.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s changed a rule that was banning servers matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):()=>Object(a.a)("%(senderName)s updated a ban rule that was matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):l.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s created a rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s created a rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s created a rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):()=>Object(a.a)("%(senderName)s created a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):()=>Object(a.a)("%(senderName)s updated an invalid ban rule",{senderName:t}):l.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s removed the rule banning users matching %(glob)s",{senderName:t,glob:s}):l.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s removed the rule banning rooms matching %(glob)s",{senderName:t,glob:s}):l.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s removed the rule banning servers matching %(glob)s",{senderName:t,glob:s}):()=>Object(a.a)("%(senderName)s removed a ban rule matching %(glob)s",{senderName:t,glob:s})}const O={[g.a.RoomMessage]:S,[g.a.Sticker]:S,[g.a.CallInvite]:function(e){const t=()=>e.sender?e.sender.name:Object(a.a)("Someone");let s=!0;e.getContent().offer&&e.getContent().offer.sdp&&-1!==e.getContent().offer.sdp.indexOf("m=video")&&(s=!1);const n=v.a.get().supportsVoip();return s&&n?()=>Object(a.a)("%(senderName)s placed a voice call.",{senderName:t()}):s&&!n?()=>Object(a.a)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:t()}):!s&&n?()=>Object(a.a)("%(senderName)s placed a video call.",{senderName:t()}):s||n?void 0:()=>Object(a.a)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:t()})}},k={[g.a.RoomCanonicalAlias]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getPrevContent().alias,n=e.getPrevContent().alt_aliases||[],i=e.getContent().alias,o=e.getContent().alt_aliases||[],r=n.filter(e=>!o.includes(e)),c=o.filter(e=>!n.includes(e));if(r.length||c.length){if(i!==s)return()=>Object(a.a)("%(senderName)s changed the main and alternative addresses for this room.",{senderName:t});if(c.length&&!r.length)return()=>Object(a.a)("%(senderName)s added the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:c.join(", "),count:c.length});if(r.length&&!c.length)return()=>Object(a.a)("%(senderName)s removed the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:r.join(", "),count:r.length});if(r.length&&c.length)return()=>Object(a.a)("%(senderName)s changed the alternative addresses for this room.",{senderName:t})}else{if(i)return()=>Object(a.a)("%(senderName)s set the main address for this room to %(address)s.",{senderName:t,address:e.getContent().alias});if(s)return()=>Object(a.a)("%(senderName)s removed the main address for this room.",{senderName:t})}return()=>Object(a.a)("%(senderName)s changed the addresses for this room.",{senderName:t})},[g.a.RoomName]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?e.getPrevContent().name?()=>Object(a.a)("%(senderDisplayName)s changed the room name from %(oldRoomName)s to %(newRoomName)s.",{senderDisplayName:t,oldRoomName:e.getPrevContent().name,newRoomName:e.getContent().name}):()=>Object(a.a)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):()=>Object(a.a)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},[g.a.RoomTopic]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(a.a)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},[g.a.RoomMember]:function(e,t,s){const n=e.sender?e.sender.name:e.getSender(),i=e.target?e.target.name:e.getStateKey(),o=e.getPrevContent(),r=e.getContent(),l=r.reason;switch(r.membership){case"invite":{const e=r.third_party_invite;return e?e.display_name?()=>Object(a.a)("%(targetName)s accepted the invitation for %(displayName)s",{targetName:i,displayName:e.display_name}):()=>Object(a.a)("%(targetName)s accepted an invitation",{targetName:i}):()=>Object(a.a)("%(senderName)s invited %(targetName)s",{senderName:n,targetName:i})}case"ban":return()=>l?Object(a.a)("%(senderName)s banned %(targetName)s: %(reason)s",{senderName:n,targetName:i,reason:l}):Object(a.a)("%(senderName)s banned %(targetName)s",{senderName:n,targetName:i});case"join":return o&&"join"===o.membership?o.displayname&&r.displayname&&o.displayname!==r.displayname?()=>Object(a.a)("%(oldDisplayName)s changed their display name to %(displayName)s",{oldDisplayName:Object(y.E)(o.displayname),displayName:Object(y.E)(r.displayname)}):!o.displayname&&r.displayname?()=>Object(a.a)("%(senderName)s set their display name to %(displayName)s",{senderName:e.getSender(),displayName:Object(y.E)(r.displayname)}):o.displayname&&!r.displayname?()=>Object(a.a)("%(senderName)s removed their display name (%(oldDisplayName)s)",{senderName:n,oldDisplayName:Object(y.E)(o.displayname)}):o.avatar_url&&!r.avatar_url?()=>Object(a.a)("%(senderName)s removed their profile picture",{senderName:n}):o.avatar_url&&r.avatar_url&&o.avatar_url!==r.avatar_url?()=>Object(a.a)("%(senderName)s changed their profile picture",{senderName:n}):!o.avatar_url&&r.avatar_url?()=>Object(a.a)("%(senderName)s set a profile picture",{senderName:n}):(null!=s?s:c.b.getValue("showHiddenEventsInTimeline"))?()=>Object(a.a)("%(senderName)s made no change",{senderName:n}):null:(e.target||b.a.warn("Join message has no target! -- "+e.getContent().state_key),()=>Object(a.a)("%(targetName)s joined the room",{targetName:i}));case"leave":return e.getSender()===e.getStateKey()?"invite"===o.membership?()=>Object(a.a)("%(targetName)s rejected the invitation",{targetName:i}):()=>l?Object(a.a)("%(targetName)s left the room: %(reason)s",{targetName:i,reason:l}):Object(a.a)("%(targetName)s left the room",{targetName:i}):"ban"===o.membership?()=>Object(a.a)("%(senderName)s unbanned %(targetName)s",{senderName:n,targetName:i}):"invite"===o.membership?()=>l?Object(a.a)("%(senderName)s withdrew %(targetName)s's invitation: %(reason)s",{senderName:n,targetName:i,reason:l}):Object(a.a)("%(senderName)s withdrew %(targetName)s's invitation",{senderName:n,targetName:i}):"join"===o.membership?()=>l?Object(a.a)("%(senderName)s kicked %(targetName)s: %(reason)s",{senderName:n,targetName:i,reason:l}):Object(a.a)("%(senderName)s kicked %(targetName)s",{senderName:n,targetName:i}):null}},[g.a.RoomAvatar]:function(e){var t;const s=(null==e||null===(t=e.sender)||void 0===t?void 0:t.name)||e.getSender();return()=>Object(a.a)("%(senderDisplayName)s changed the room avatar.",{senderDisplayName:s})},[g.a.RoomThirdPartyInvite]:function(e){const t=e.sender?e.sender.name:e.getSender();return Object(r.c)(e)?()=>Object(a.a)("%(senderName)s sent an invitation to %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getContent().display_name}):()=>Object(a.a)("%(senderName)s revoked the invitation for %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getPrevContent().display_name||Object(a.a)("Someone")})},[g.a.RoomHistoryVisibility]:function(e){const t=e.sender?e.sender.name:e.getSender();switch(e.getContent().history_visibility){case p.b.Invited:return()=>Object(a.a)("%(senderName)s made future room history visible to all room members, from the point they are invited.",{senderName:t});case p.b.Joined:return()=>Object(a.a)("%(senderName)s made future room history visible to all room members, from the point they joined.",{senderName:t});case p.b.Shared:return()=>Object(a.a)("%(senderName)s made future room history visible to all room members.",{senderName:t});case p.b.WorldReadable:return()=>Object(a.a)("%(senderName)s made future room history visible to anyone.",{senderName:t});default:return()=>Object(a.a)("%(senderName)s made future room history visible to unknown (%(visibility)s).",{senderName:t,visibility:e.getContent().history_visibility})}},[g.a.RoomPowerLevels]:function(e){const t=e.sender?e.sender.name:e.getSender();if(!(e.getPrevContent()&&e.getPrevContent().users&&e.getContent()&&e.getContent().users))return null;const s=e.getPrevContent().users_default||0,n=e.getContent().users_default||0,i=[];Object.keys(e.getContent().users).forEach(e=>{-1===i.indexOf(e)&&i.push(e)}),Object.keys(e.getPrevContent().users).forEach(e=>{-1===i.indexOf(e)&&i.push(e)});const r=[];return i.forEach(t=>{let i=e.getPrevContent().users[t];Number.isInteger(i)||(i=s);let a=e.getContent().users[t];Number.isInteger(a)||(a=n),i===s&&a===n||a!==i&&r.push({userId:t,from:i,to:a})}),r.length?()=>Object(a.a)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:t,powerLevelDiffText:r.map(e=>Object(a.a)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:e.userId,fromPowerLevel:o.b(e.from,s),toPowerLevel:o.b(e.to,n)})).join(", ")}):null},[g.a.RoomPinnedEvents]:function(e,t){var s,n;if(!c.b.getValue("feature_pinning"))return null;const o=e.sender?e.sender.name:e.getSender(),r=e.getRoomId(),l=null!==(s=e.getContent().pinned)&&void 0!==s?s:[],d=null!==(n=e.getPrevContent().pinned)&&void 0!==n?n:[],h=l.filter(e=>d.indexOf(e)<0),u=d.filter(e=>l.indexOf(e)<0);if(1===h.length&&0===u.length){if(t){const e=h.pop();return()=>i.a.createElement("span",null,Object(a.a)("%(senderName)s pinned <a>a message</a> to this room. See all <b>pinned messages</b>.",{senderName:o},{a:t=>i.a.createElement("a",{onClick:t=>_(e,r)},t),b:e=>i.a.createElement("a",{onClick:w},e)}))}return()=>Object(a.a)("%(senderName)s pinned a message to this room. See all pinned messages.",{senderName:o})}if(1===u.length&&0===h.length){if(t){const e=u.pop();return()=>i.a.createElement("span",null,Object(a.a)("%(senderName)s unpinned <a>a message</a> from this room. See all <b>pinned messages</b>.",{senderName:o},{a:t=>i.a.createElement("a",{onClick:t=>_(e,r)},t),b:e=>i.a.createElement("a",{onClick:w},e)}))}return()=>Object(a.a)("%(senderName)s unpinned a message from this room. See all pinned messages.",{senderName:o})}return t?()=>i.a.createElement("span",null,Object(a.a)("%(senderName)s changed the <a>pinned messages</a> for the room.",{senderName:o},{a:e=>i.a.createElement("a",{onClick:w}," ",e," ")})):()=>Object(a.a)("%(senderName)s changed the pinned messages for the room.",{senderName:o})},[g.a.RoomServerAcl]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getPrevContent(),n=e.getContent(),i=Array.isArray(s.deny)?s.deny:[],o=Array.isArray(s.allow)?s.allow:[];s.allow_ip_literals;let r=null;return r=0===i.length&&0===o.length?()=>Object(a.a)("%(senderDisplayName)s set the server ACLs for this room.",{senderDisplayName:t}):()=>Object(a.a)("%(senderDisplayName)s changed the server ACLs for this room.",{senderDisplayName:t}),Array.isArray(n.allow)||(n.allow=[]),0===n.allow.length?()=>r()+" "+Object(a.a)("🎉 All servers are banned from participating! This room can no longer be used."):r},[g.a.RoomTombstone]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(a.a)("%(senderDisplayName)s upgraded this room.",{senderDisplayName:t})},[g.a.RoomJoinRules]:function(e,t){const s=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case p.c.Public:return()=>Object(a.a)("%(senderDisplayName)s made the room public to whoever knows the link.",{senderDisplayName:s});case p.c.Invite:return()=>Object(a.a)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:s});case p.c.Restricted:return t?()=>i.a.createElement("span",null,Object(a.a)("%(senderDisplayName)s changed who can join this room. <a>View settings</a>.",{senderDisplayName:s},{a:e=>i.a.createElement("a",{onClick:E},e)})):()=>Object(a.a)("%(senderDisplayName)s changed who can join this room.",{senderDisplayName:s});default:return()=>Object(a.a)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:s,rule:e.getContent().join_rule})}},[g.a.RoomGuestAccess]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().guest_access){case p.a.CanJoin:return()=>Object(a.a)("%(senderDisplayName)s has allowed guests to join the room.",{senderDisplayName:t});case p.a.Forbidden:return()=>Object(a.a)("%(senderDisplayName)s has prevented guests from joining the room.",{senderDisplayName:t});default:return()=>Object(a.a)("%(senderDisplayName)s changed guest access to %(rule)s",{senderDisplayName:t,rule:e.getContent().guest_access})}},"m.room.related_groups":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getContent().groups||[],n=e.getPrevContent().groups||[],i=s.filter(e=>!n.includes(e)),o=n.filter(e=>!s.includes(e));return i.length&&!o.length?()=>Object(a.a)("%(senderDisplayName)s enabled flair for %(groups)s in this room.",{senderDisplayName:t,groups:i.join(", ")}):!i.length&&o.length?()=>Object(a.a)("%(senderDisplayName)s disabled flair for %(groups)s in this room.",{senderDisplayName:t,groups:o.join(", ")}):i.length&&o.length?()=>Object(a.a)("%(senderDisplayName)s enabled flair for %(newGroups)s and disabled flair for %(oldGroups)s in this room.",{senderDisplayName:t,newGroups:i.join(", "),oldGroups:o.join(", ")}):null},"im.vector.modular.widgets":function(e){const t=e.getSender(),{name:s,type:n,url:i}=e.getPrevContent(),{name:o,type:r,url:c}=e.getContent()||{};let l=o||s||r||n||"";return l&&l.length>0&&(l=l[0].toUpperCase()+l.slice(1)),c?i?()=>Object(a.a)("%(widgetName)s widget modified by %(senderName)s",{widgetName:l,senderName:t}):()=>Object(a.a)("%(widgetName)s widget added by %(senderName)s",{widgetName:l,senderName:t}):()=>Object(a.a)("%(widgetName)s widget removed by %(senderName)s",{widgetName:l,senderName:t})},[d.c]:function(e){var t;const s=(null===(t=e.sender)||void 0===t?void 0:t.name)||e.getSender();return()=>Object(a.a)("%(senderName)s has updated the room layout",{senderName:s})}};for(const e of l.a)k[e]=C;function R(e,t){const s=(e.isState()?k:O)[e.getType()];return Boolean(null==s?void 0:s(e,!1,t))}function I(e,t=!1,s){var n;const i=(e.isState()?k:O)[e.getType()];return(null==i||null===(n=i(e,t,s))||void 0===n?void 0:n())||""}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return o}));var n=s(189),i=s.n(n);function a(e){if(!e)return"";const t=i.a.parse(e);return t&&"/"===t.path?t.host:e}function o(e){if(!e)return"";let t=e;e.startsWith("https://")||(t="https://"+e);return null===i.a.parse(t).hostname?e:t}},function(e,t,s){"use strict";let n,i;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),function(e){e.Manual="MANUAL",e.Alphabetic="ALPHABETIC",e.Recent="RECENT"}(n||(n={})),function(e){e.Importance="IMPORTANCE",e.Natural="NATURAL"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return u})),s.d(t,"c",(function(){return m})),s.d(t,"e",(function(){return p})),s.d(t,"d",(function(){return g}));var n=s(86),i=s(250),a=s(194),o=s(196);let r;!function(e){e.AllMessagesLoud="all_messages_loud",e.AllMessages="all_messages",e.MentionsOnly="mentions_only",e.Mute="mute"}(r||(r={}));const c=[r.AllMessages,r.AllMessagesLoud],l=[...c,r.MentionsOnly];function d(e){return c.includes(e)}function h(e){return l.includes(e)}function u(e){return e.reduce((e,t)=>{const s=m(t.roomId),n=t.getUnreadNotificationCount(a.a.Highlight)>0,i=g(t),o=i>0&&d(s),r=n&&h(s);return(o||r)&&(e.count+=i,n&&(e.highlight=!0)),e},{count:0,highlight:!1})}function m(e){if(n.a.get().isGuest())return r.AllMessages;if(v(e))return r.Mute;let t=null;try{t=n.a.get().getRoomPushRule("global",e)}catch(e){return null}if(!t||!t.enabled)return r.AllMessages;if(b(t))return r.MentionsOnly;return i.a.actionListToActionsObject(t.actions).tweaks.sound?r.AllMessagesLoud:null}function p(e,t){return t===r.Mute?function(e){const t=n.a.get(),s=[],i=t.getRoomPushRule("global",e);i&&s.push(t.deletePushRule("global",o.c.RoomSpecific,i.rule_id));return s.push(t.addPushRule("global",o.c.Override,e,{conditions:[{kind:"event_match",key:"room_id",pattern:e}],actions:["dont_notify"]})),Promise.all(s)}(e):function(e,t){const s=n.a.get(),i=[],a=v(e);a&&i.push(s.deletePushRule("global",o.c.Override,a.rule_id));if(t===r.AllMessages){const t=s.getRoomPushRule("global",e);t&&i.push(s.deletePushRule("global",o.c.RoomSpecific,t.rule_id))}else t===r.MentionsOnly?(i.push(s.addPushRule("global",o.c.RoomSpecific,e,{actions:["dont_notify"]})),i.push(s.setPushRuleEnabled("global",o.c.RoomSpecific,e,!0))):t===r.AllMessagesLoud&&(i.push(s.addPushRule("global",o.c.RoomSpecific,e,{actions:["notify",{set_tweak:"sound",value:"default"}]})),i.push(s.setPushRuleEnabled("global",o.c.RoomSpecific,e,!0)));return Promise.all(i)}(e,t)}function g(e,t=null){let s=e.getUnreadNotificationCount(t);const i=e.currentState.getStateEvents("m.room.create","");if(i&&i.getContent().predecessor){const e=i.getContent().predecessor.room_id,t=n.a.get().getRoom(e);t&&(s+=t.getUnreadNotificationCount(a.a.Highlight))}return s}function v(e){var t,s;const i=n.a.get();if(null==i||null===(t=i.pushRules)||void 0===t||null===(s=t.global)||void 0===s||!s.override)return null;for(const t of i.pushRules.global.override)if(f(e,t)&&b(t)&&t.enabled)return t;return null}function f(e,t){if(1!==t.conditions.length)return!1;const s=t.conditions[0];return s.kind===o.a.EventMatch&&"room_id"===s.key&&s.pattern===e}function b(e){return 1===e.actions.length&&e.actions[0]===o.b.DontNotify}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82);const i=(e,t,s)=>{const[i,a]=Object(n.useState)(s);return Object(n.useEffect)(()=>{let t=!1;return e().then(e=>{t||a(e)}),()=>{t=!0}},t),i}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(306),h=s.n(d),u=s(84),m=s(90),p=s(88),g=s(85),v=s(103),f=s(104),b=s(134),y=s(713),E=s(714),S=s(177),_=s(1);let w;function C(e){if(!e)return"";const t=window.getComputedStyle(e,null);let s=t.cssText;if(""==s)for(let e=0;e<t.length;e++)s+=t[e]+":",s+=t.getPropertyValue(t[e])+";";return s}!async function(){if(w)return;const e=await fetch(s(1250)).then(e=>e.text());w="data:image/svg+xml;base64,"+window.btoa(e)}();let O=Object(g.a)("views.messages.MFileBody")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"iframe",Object(c.createRef)()),r()(this,"dummyLink",Object(c.createRef)()),r()(this,"userDidClick",!1),r()(this,"fileDownloader",new E.a(()=>this.iframe.current)),r()(this,"decryptFile",async()=>{if(!this.state.decryptedBlob)try{this.userDidClick=!0,this.setState({decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value})}catch(e){_.a.warn("Unable to decrypt attachment: ",e),m.a.createTrackedDialog("Error decrypting attachment","",f.a,{title:Object(u.a)("Error"),description:Object(u.a)("Error decrypting attachment")})}}),r()(this,"onPlaceholderClick",async()=>{const e=this.props.mediaEventHelper;null!=e&&e.media.isEncrypted?(await this.decryptFile(),this.downloadFile(this.fileName,this.linkText)):this.fileDownloader.download({blob:await e.sourceBlob.value,name:this.fileName})}),this.state={}}getContentUrl(){if(this.props.forExport)return null;return Object(v.a)(this.props.mxEvent.getContent()).srcHttp}get content(){return this.props.mxEvent.getContent()}get fileName(){return this.content.body&&this.content.body.length>0?this.content.body:Object(u.a)("Attachment")}get linkText(){return Object(y.a)(this.content)}downloadFile(e,t){this.fileDownloader.download({blob:this.state.decryptedBlob,name:e,autoDownload:this.userDidClick,opts:{imgSrc:w,imgStyle:null,style:C(this.dummyLink.current),textContent:Object(u.a)("Download %(text)s",{text:t})}})}componentDidUpdate(e,t){this.props.onHeightChanged&&!t.decryptedBlob&&this.state.decryptedBlob&&this.props.onHeightChanged()}render(){var e;const t=null===(e=this.props.mediaEventHelper)||void 0===e?void 0:e.media.isEncrypted,s=this.getContentUrl(),n=this.content.info?this.content.info.size:null,i=this.content.info?this.content.info.mimetype:"application/octet-stream";let a=null;if(this.props.showGenericPlaceholder&&(a=l.a.createElement(p.a,{className:"mx_MediaBody mx_MFileBody_info",onClick:this.onPlaceholderClick},l.a.createElement("span",{className:"mx_MFileBody_info_icon"}),l.a.createElement(S.a,{tooltip:Object(y.a)(this.content,Object(u.a)("Attachment"),!0)},l.a.createElement("span",{className:"mx_MFileBody_info_filename"},Object(y.a)(this.content,Object(u.a)("Attachment"),!0,!0))))),this.props.forExport){var o;const e=this.props.mxEvent.getContent();return l.a.createElement("span",{className:"mx_MFileBody"},l.a.createElement("a",{href:(null===(o=e.file)||void 0===o?void 0:o.url)||e.url},a))}const r=this.props.tileShape||!this.props.showGenericPlaceholder;if(t){if(!this.state.decryptedBlob)return l.a.createElement("span",{className:"mx_MFileBody"},a,r&&l.a.createElement("div",{className:"mx_MFileBody_download"},l.a.createElement(p.a,{onClick:this.decryptFile},Object(u.a)("Decrypt %(text)s",{text:this.linkText}))),this.props.scBubbleGroupTimestamp);const e="usercontent/";return l.a.createElement("span",{className:"mx_MFileBody"},a,r&&l.a.createElement("div",{className:"mx_MFileBody_download"},l.a.createElement("div",{style:{display:"none"}},l.a.createElement("a",{ref:this.dummyLink})),l.a.createElement("iframe",{src:e,onLoad:()=>this.downloadFile(this.fileName,this.linkText),ref:this.iframe,sandbox:"allow-scripts allow-downloads allow-downloads-without-user-activation"})),this.props.scBubbleGroupTimestamp)}if(s){const e={target:"_blank",rel:"noreferrer noopener",href:s},t="number"!=typeof n||n>524288e3;return["application/pdf"].includes(i)&&!t?e.onClick=e=>{_.a.log(`Downloading ${i} as blob (unencrypted)`),e.preventDefault(),e.stopPropagation(),this.props.mediaEventHelper.sourceBlob.value.then(e=>{const t=URL.createObjectURL(e),s=document.createElement("a");s.download=this.fileName,s.href=t,document.body.appendChild(s),s.click(),s.remove()})}:e.download=this.fileName,l.a.createElement("span",{className:"mx_MFileBody"},a,r&&l.a.createElement("div",{className:"mx_MFileBody_download"},l.a.createElement("a",e,l.a.createElement("span",{className:"mx_MFileBody_download_icon"}),Object(u.a)("Download %(text)s",{text:this.linkText})),this.props.tileShape===b.a.FileGrid&&l.a.createElement("div",{className:"mx_MImageBody_size"},this.content.info&&this.content.info.size?h()(this.content.info.size):"")),this.props.scBubbleGroupTimestamp)}{const e=this.linkText?": "+this.linkText:"";return l.a.createElement("span",{className:"mx_MFileBody"},a,Object(u.a)("Invalid file%(extra)s",{extra:e}),this.props.scBubbleGroupTimestamp)}}},r()(i,"defaultProps",{showGenericPlaceholder:!0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return o})),s.d(t,"d",(function(){return r}));var n=s(342);const i=new n.a("m.poll.start","org.matrix.msc3381.poll.start"),a=new n.a("m.poll.response","org.matrix.msc3381.poll.response"),o=new n.a("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");new n.a("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");function r(e,t,s){return{"org.matrix.msc1767.text":`${e=e.trim()}\n${(t=t.map(e=>e.trim()).filter(e=>!!e)).map((e,t)=>`${t+1}. ${e}`).join("\n")}`,[i.name]:{kind:s,question:{"org.matrix.msc1767.text":e},answers:t.map((e,t)=>({id:`${t}-${e}`,"org.matrix.msc1767.text":e}))}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(184),o=s(213);class r extends o.b{constructor(e,t,s){super(),this._symbol=e,this._count=t,this._color=s}static forCount(e,t){return new r(null,e,t)}static forSymbol(e,t){return new r(e,0,t)}}i()(r,"RED_EXCLAMATION",r.forSymbol("!",a.a.Red))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(89),o=s(87),r=s(92),c=s(491),l=s(309),d=s(266);class h{constructor(){i()(this,"lightThemeWatchRef",void 0),i()(this,"darkThemeWatchRef",void 0),i()(this,"themeInUseWatchRef",void 0),i()(this,"dispatcherRef",void 0),i()(this,"preferDark",void 0),i()(this,"preferLight",void 0),i()(this,"preferHighContrast",void 0),i()(this,"onChange",()=>{this.recheck()}),i()(this,"onAction",e=>{e.action===r.a.RecheckTheme&&this.recheck(e.forceTheme)}),this.lightThemeWatchRef=null,this.darkThemeWatchRef=null,this.themeInUseWatchRef=null,this.dispatcherRef=null,this.preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this.preferLight=e.matchMedia("(prefers-color-scheme: light)"),this.preferHighContrast=e.matchMedia("(prefers-contrast: more)"),h.currentTheme=this.getEffectiveTheme()}start(){this.lightThemeWatchRef=a.b.watchSetting("light_theme",null,this.onChange),this.darkThemeWatchRef=a.b.watchSetting("dark_theme",null,this.onChange),this.themeInUseWatchRef=a.b.watchSetting("theme_in_use",null,this.onChange),this.preferDark.addEventListener&&(this.preferDark.addEventListener("change",this.onChange),this.preferLight.addEventListener("change",this.onChange),this.preferHighContrast.addEventListener("change",this.onChange)),this.dispatcherRef=o.a.register(this.onAction)}stop(){this.preferDark.addEventListener&&(this.preferDark.removeEventListener("change",this.onChange),this.preferLight.removeEventListener("change",this.onChange),this.preferHighContrast.removeEventListener("change",this.onChange)),a.b.unwatchSetting(this.themeInUseWatchRef),a.b.unwatchSetting(this.darkThemeWatchRef),a.b.unwatchSetting(this.lightThemeWatchRef),o.a.unregister(this.dispatcherRef)}recheck(e){const t=h.currentTheme;h.currentTheme=void 0===e?this.getEffectiveTheme():e,t!==h.currentTheme&&Object(l.f)(h.currentTheme)}getEffectiveTheme(){let e=d.a.Light;return c.a.isLogin||(e=a.b.getValue("theme_in_use"),e===d.a.System&&(this.preferDark.matches&&(e=d.a.Dark),this.preferLight.matches&&(e=d.a.Light))),e===d.a.Dark?a.b.getValue("dark_theme"):a.b.getValue("light_theme")}themeBasedOnSystem(){let e;if(this.preferDark.matches?e="dark":this.preferLight.matches&&(e="light"),this.preferHighContrast.matches){const t=Object(l.b)(e);t&&(e=t)}return e}isSystemThemeSupported(){return this.preferDark.matches||this.preferLight.matches}static getCurrentTheme(){return h.currentTheme}static getCurrentThemeSimplified(){let e=h.currentTheme;if(e.startsWith("custom-")){const t=Object(l.d)(e.substr(7));e=t.is_dark?"dark":"light"}return e=e.includes("light")?"light":"dark",e}}i()(h,"currentTheme",void 0)}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(110),i=s.n(n);let a;!function(e){e.Light="light",e.Dark="dark",e.System="system"}(a||(a={}));i.a.oneOf(Object.values(a))},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(378);class c extends a.a{constructor(){super(o.a),i()(this,"widgetMap",new r.a)}static get instance(){return c.internalInstance}async onAction(e){}async onReady(){this.widgetMap.clear()}storeMessaging(e,t){this.stopMessaging(e),this.widgetMap.set(e.id,t)}stopMessaging(e){var t;null===(t=this.widgetMap.remove(e.id))||void 0===t||t.stop()}getMessaging(e){return this.widgetMap.get(e.id)}stopMessagingById(e){var t;null===(t=this.widgetMap.remove(e))||void 0===t||t.stop()}getMessagingForId(e){return this.widgetMap.get(e)}}i()(c,"internalInstance",new c)},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"c",(function(){return a})),s.d(t,"e",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"d",(function(){return c}));var n=s(86);function i(){const e=n.a.get().getClientWellKnown();return null==e?void 0:e["io.element.call_behaviour"]}function a(){const e=n.a.get().getClientWellKnown();return e&&e["io.element.e2ee"]?e["io.element.e2ee"]:e&&e["im.vector.riot.e2ee"]?e["im.vector.riot.e2ee"]:null}function o(){const e=a();return e&&!0===e.secure_backup_required}let r;function c(){const e=a();return e&&e.secure_backup_setup_methods&&e.secure_backup_setup_methods.length&&(e.secure_backup_setup_methods.includes(r.Key)||e.secure_backup_setup_methods.includes(r.Passphrase))?e.secure_backup_setup_methods:[r.Key,r.Passphrase]}!function(e){e.Key="key",e.Passphrase="passphrase"}(r||(r={}))},,function(e,t){e.exports="img/warning.05cc423.svg"},,,function(e,t,s){"use strict";s.d(t,"b",(function(){return T})),s.d(t,"a",(function(){return j})),s.d(t,"f",(function(){return N})),s.d(t,"g",(function(){return P})),s.d(t,"e",(function(){return D})),s.d(t,"c",(function(){return M}));var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(4),c=s(94),l=s(84),d=s(97),h=s(229),u=s(237),m=s(106),p=s(126),g=s(180),v=s(88),f=s(128),b=s(130),y=s(120),E=s(137),S=s(98),_=s(460),w=s(301),C=s(284),O=s(214),k=s(311),R=s(312),I=s(125),x=s(1);const T=({room:e,checked:t,onChange:s})=>i.a.createElement("label",{className:"mx_AddExistingToSpace_entry"},null!=e&&e.isSpaceRoom()?i.a.createElement(p.a,{room:e,height:32,width:32}):i.a.createElement(C.a,{room:e,avatarSize:32}),i.a.createElement("span",{className:"mx_AddExistingToSpace_entry_name"},e.name),i.a.createElement(E.b,{onChange:s?e=>s(e.target.checked):null,checked:t,disabled:!s})),j=({space:e,footerPrompt:t,emptySelectionButton:a,filterPlaceholder:o,roomsRenderer:c,dmsRenderer:d,spacesRenderer:h,onFinished:p})=>{const g=Object(n.useContext)(S.a),E=Object(n.useMemo)(()=>g.getVisibleRooms().filter(e=>"join"===e.getMyMembership()),[g]),[C,k]=Object(n.useState)(new Set),[T,j]=Object(n.useState)(null),[N,P]=Object(n.useState)(null),[D,M]=Object(n.useState)(""),A=D.toLowerCase().trim(),U=Object(n.useMemo)(()=>new Set(m.a.instance.getChildSpaces(e.roomId)),[e]),L=Object(n.useMemo)(()=>new Set(m.a.instance.getChildRooms(e.roomId)),[e]),[F,B,V]=Object(n.useMemo)(()=>{let t=E;if(A){t=new O.a(E,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(A)}const s=e.getJoinRule();return Object(_.b)(t).reduce((t,n)=>(n.isSpaceRoom()?n===e||U.has(n)||t[0].push(n):L.has(n)||(b.a.shared().getUserIdForRoomId(n.roomId)?"public"!==s&&t[2].push(n):t[1].push(n)),t),[[],[],[]])},[E,e,A,L,U]),K=async()=>{let t;P(null),j(0);for(const s of C){const n=Object(y.b)(s);try{await m.a.instance.addRoomToSpace(e,s.roomId,n).catch(async t=>{if("M_LIMIT_EXCEEDED"===t.errcode)return await Object(r.I)(t.data.retry_after_ms),m.a.instance.addRoomToSpace(e,s.roomId,n);throw t}),j(e=>e+1)}catch(e){x.a.error("Failed to add rooms to space",e),P(t=e);break}}t||p(!0)},W=null!==T;let G;if(N)G=i.a.createElement(i.a.Fragment,null,i.a.createElement("img",{src:s(458),height:"24",width:"24",alt:""}),i.a.createElement("span",{className:"mx_AddExistingToSpaceDialog_error"},i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorHeading"},Object(l.a)("Not all selected were added")),i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorCaption"},Object(l.a)("Try again"))),i.a.createElement(v.a,{className:"mx_AddExistingToSpaceDialog_retryButton",onClick:K},Object(l.a)("Retry")));else if(W)G=i.a.createElement("span",null,i.a.createElement(w.a,{value:T,max:C.size}),i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_progressText"},Object(l.a)("Adding rooms... (%(progress)s out of %(count)s)",{count:C.size,progress:T})));else{let e=a;(!e||C.size>0)&&(e=i.a.createElement(v.a,{kind:"primary",disabled:C.size<1,onClick:K},Object(l.a)("Add"))),G=i.a.createElement(i.a.Fragment,null,i.a.createElement("span",null,t),e)}const H=W||N?null:(e,t)=>{e?C.add(t):C.delete(t),k(new Set(C))},[q,$]=Object(n.useState)(20);let z=!0;return(c&&B.length>0||d&&V.length>0||!c&&!d&&h&&F.length>0)&&(z=!1),i.a.createElement("div",{className:"mx_AddExistingToSpace"},i.a.createElement(u.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:o,onSearch:M,autoFocus:!0}),i.a.createElement(f.a,{className:"mx_AddExistingToSpace_content"},B.length>0&&c?c(B,C,H,q,(function(e,t){const n=Object(l.a)("and %(count)s others...",{count:e});return i.a.createElement(R.b,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(I.a,{url:s(313),name:"...",width:36,height:36}),name:n,presenceState:"online",suppressOnHover:!0,onClick:()=>$(t)})})):void 0,F.length>0&&h?h(F,C,H):null,V.length>0&&d?d(V,C,H):null,z?i.a.createElement("span",{className:"mx_AddExistingToSpace_noResults"},Object(l.a)("No results")):void 0),i.a.createElement("div",{className:"mx_AddExistingToSpace_footer"},G))},N=(e,t,s,n,a)=>i.a.createElement("div",{className:"mx_AddExistingToSpace_section"},i.a.createElement("h3",null,Object(l.a)("Rooms")),i.a.createElement(k.a,{truncateAt:n,createOverflowElement:a,getChildren:(n,a)=>e.slice(n,a).map(e=>i.a.createElement(T,{key:e.roomId,room:e,checked:t.has(e),onChange:s?t=>{s(t,e)}:null})),getChildCount:()=>e.length})),P=(e,t,s)=>i.a.createElement("div",{className:"mx_AddExistingToSpace_section"},e.map(e=>i.a.createElement(T,{key:e.roomId,room:e,checked:t.has(e),onChange:s?t=>{s(t,e)}:null}))),D=(e,t,s)=>i.a.createElement("div",{className:"mx_AddExistingToSpace_section"},i.a.createElement("h3",null,Object(l.a)("Direct Messages")),e.map(e=>i.a.createElement(T,{key:e.roomId,room:e,checked:t.has(e),onChange:s?t=>{s(t,e)}:null}))),M=({title:e,space:t,value:s,onChange:a})=>{const r=Object(n.useMemo)(()=>[t,...m.a.instance.getChildSpaces(t.roomId).filter(e=>e.currentState.maySendStateEvent(c.a.SpaceChild,e.client.credentials.userId))],[t]);let d;return d=r.length>1?i.a.createElement(h.a,{id:"mx_SpaceSelectDropdown",className:"mx_SpaceSelectDropdown",onOptionChange:e=>{a(r.find(t=>t.roomId===e)||t)},value:s.roomId,label:Object(l.a)("Space selection")},r.map(e=>{const t=o()({mx_SubspaceSelector_dropdownOptionActive:e===s});return i.a.createElement("div",{key:e.roomId,className:t},i.a.createElement(p.a,{room:e,width:24,height:24}),e.name||Object(g.c)(e)||e.roomId)})):i.a.createElement("div",{className:"mx_SubspaceSelector_onlySpace"},t.name||Object(g.c)(t)||t.roomId),i.a.createElement("div",{className:"mx_SubspaceSelector"},i.a.createElement(p.a,{room:s,height:40,width:40}),i.a.createElement("div",null,i.a.createElement("h1",null,e),d))};t.d=({space:e,onCreateRoomClick:t,onAddSubspaceClick:s,onFinished:a})=>{const[o,r]=Object(n.useState)(e);return i.a.createElement(d.a,{title:i.a.createElement(M,{title:Object(l.a)("Add existing rooms"),space:e,value:o,onChange:r}),className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:a,fixedWidth:!1},i.a.createElement(S.a.Provider,{value:e.client},i.a.createElement(j,{space:e,onFinished:a,footerPrompt:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",null,Object(l.a)("Want to add a new room instead?")),i.a.createElement(v.a,{kind:"link",onClick:()=>{t(),a()}},Object(l.a)("Create a new room"))),filterPlaceholder:Object(l.a)("Search for rooms"),roomsRenderer:N,spacesRenderer:()=>i.a.createElement("div",{className:"mx_AddExistingToSpace_section"},i.a.createElement("h3",null,Object(l.a)("Spaces")),i.a.createElement(v.a,{kind:"link",onClick:()=>{s(),a()}},Object(l.a)("Adding spaces has moved."))),dmsRenderer:D})))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(83),i=s.n(n);class a{constructor(e){this.timeout=e,i()(this,"timerHandle",void 0),i()(this,"startTs",void 0),i()(this,"promise",void 0),i()(this,"resolve",void 0),i()(this,"reject",void 0),i()(this,"onTimeout",()=>{const e=Date.now()-this.startTs;if(e>=this.timeout)this.resolve(),this.setNotStarted();else{const t=this.timeout-e;this.timerHandle=setTimeout(this.onTimeout,t)}}),this.setNotStarted()}setNotStarted(){this.timerHandle=null,this.startTs=null,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}).finally(()=>{this.timerHandle=null})}changeTimeout(e){if(e===this.timeout)return;const t=e<this.timeout;this.timeout=e,this.isRunning()&&t&&(clearTimeout(this.timerHandle),this.onTimeout())}start(){return this.isRunning()||(this.startTs=Date.now(),this.timerHandle=setTimeout(this.onTimeout,this.timeout)),this}restart(){return this.isRunning()?(this.startTs=Date.now(),this):this.start()}abort(){return this.isRunning()&&(clearTimeout(this.timerHandle),this.reject(new Error("Timer was aborted.")),this.setNotStarted()),this}finished(){return this.promise}isRunning(){return null!==this.timerHandle}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(86),d=s(204),h=s(84),u=s(188),m=s(107),p=s(1);!function(e){e.Passphrase="passphrase",e.RecoveryKey="recovery_key",e.SecretStorage="secret_storage"}(n||(n={})),function(e){e.PreFetch="prefetch",e.Fetch="fetch",e.LoadKeys="load_keys"}(i||(i={}));class g extends c.a.PureComponent{constructor(e){super(e),o()(this,"onCancel",()=>{this.props.onFinished(!1)}),o()(this,"onDone",()=>{this.props.onFinished(!0)}),o()(this,"onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),o()(this,"progressCallback",e=>{this.setState({progress:e})}),o()(this,"onResetRecoveryClick",()=>{this.props.onFinished(!1),Object(u.b)(async()=>{},!0)}),o()(this,"onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:l.a.get().isValidRecoveryKey(e.target.value)})}),o()(this,"onPassPhraseNext",async()=>{this.setState({loading:!0,restoreError:null,restoreType:n.Passphrase});try{const e=await l.a.get().restoreKeyBackupWithPassword(this.state.passPhrase,void 0,void 0,this.state.backupInfo,{progressCallback:this.progressCallback});if(this.props.keyCallback){const e=await l.a.get().keyBackupKeyFromPassword(this.state.passPhrase,this.state.backupInfo);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){p.a.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}),o()(this,"onRecoveryKeyNext",async()=>{if(this.state.recoveryKeyValid){this.setState({loading:!0,restoreError:null,restoreType:n.RecoveryKey});try{const e=await l.a.get().restoreKeyBackupWithRecoveryKey(this.state.recoveryKey,void 0,void 0,this.state.backupInfo,{progressCallback:this.progressCallback});if(this.props.keyCallback){const e=l.a.get().keyBackupKeyFromRecoveryKey(this.state.recoveryKey);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){p.a.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}}),o()(this,"onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value})}),this.state={backupInfo:null,backupKeyStored:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:i.PreFetch}}}componentDidMount(){this.loadBackupStatus()}async restoreWithSecretStorage(){this.setState({loading:!0,restoreError:null,restoreType:n.SecretStorage});try{await Object(u.b)(async()=>{await l.a.get().restoreKeyBackupWithSecretStorage(this.state.backupInfo,void 0,void 0,{progressCallback:this.progressCallback})}),this.setState({loading:!1})}catch(e){p.a.log("Error restoring backup",e),this.setState({restoreError:e,loading:!1})}}async restoreWithCachedKey(e){if(!e)return!1;try{const t=await l.a.get().restoreKeyBackupWithCache(void 0,void 0,e,{progressCallback:this.progressCallback});return this.setState({recoverInfo:t}),!0}catch(e){return p.a.log("restoreWithCachedKey failed:",e),!1}}async loadBackupStatus(){this.setState({loading:!0,loadError:null});try{const e=l.a.get(),t=await e.getKeyBackupVersion(),s=await e.hasSecretStorageKey()&&await e.isKeyBackupKeyStored();this.setState({backupInfo:t,backupKeyStored:s});if(await this.restoreWithCachedKey(t))return p.a.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(s)return this.restoreWithSecretStorage();this.setState({loadError:null,loading:!1})}catch(e){p.a.log("Error loading backup status",e),this.setState({loadError:e,loading:!1})}}render(){const e=m.getComponent("views.elements.DialogButtons"),t=m.getComponent("elements.AccessibleButton"),s=m.getComponent("views.dialogs.BaseDialog"),a=m.getComponent("elements.Spinner"),o=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let r,l;if(this.state.loading){let e;if(l=Object(h.a)("Restoring keys from backup"),this.state.progress.stage===i.Fetch)e=Object(h.a)("Fetching keys from server...");else if(this.state.progress.stage===i.LoadKeys){const{total:t,successes:s,failures:n}=this.state.progress;e=Object(h.a)("%(completed)s of %(total)s keys restored",{total:t,completed:s+n})}else this.state.progress.stage===i.PreFetch&&(e=Object(h.a)("Fetching keys from server..."));r=c.a.createElement("div",null,c.a.createElement("div",null,e),c.a.createElement(a,null))}else if(this.state.loadError)l=Object(h.a)("Error"),r=Object(h.a)("Unable to load backup status");else if(this.state.restoreError)this.state.restoreError.errcode===d.b.RESTORE_BACKUP_ERROR_BAD_KEY?this.state.restoreType===n.RecoveryKey?(l=Object(h.a)("Security Key mismatch"),r=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Key: please verify that you entered the correct Security Key.")))):(l=Object(h.a)("Incorrect Security Phrase"),r=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Phrase: please verify that you entered the correct Security Phrase.")))):(l=Object(h.a)("Error"),r=Object(h.a)("Unable to restore backup"));else if(null===this.state.backupInfo)l=Object(h.a)("Error"),r=Object(h.a)("No backup found!");else if(this.state.recoverInfo){let t;l=Object(h.a)("Keys restored"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(t=c.a.createElement("p",null,Object(h.a)("Failed to decrypt %(failedCount)s sessions!",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),r=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Successfully restored %(sessionCount)s keys",{sessionCount:this.state.recoverInfo.imported})),t,c.a.createElement(e,{primaryButton:Object(h.a)("OK"),onPrimaryButtonClick:this.onDone,hasCancel:!1,focus:!0}))}else if(o&&!this.state.forceRecoveryKey)l=Object(h.a)("Enter Security Phrase"),r=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>c.a.createElement("b",null,e)})),c.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Phrase.")),c.a.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},c.a.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this.onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),c.a.createElement(e,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this.onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this.onCancel,focus:!1})),Object(h.a)("If you've forgotten your Security Phrase you can <button1>use your Security Key</button1> or <button2>set up new recovery options</button2>",{},{button1:e=>c.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this.onUseRecoveryKeyClick},e),button2:e=>c.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this.onResetRecoveryClick},e)}));else{let s;l=Object(h.a)("Enter Security Key"),s=0===this.state.recoveryKey.length?c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",Object(h.a)("This looks like a valid Security Key!")):c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",Object(h.a)("Not a valid Security Key")),r=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>c.a.createElement("b",null,e)})),c.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Key.")),c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},c.a.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this.onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),s,c.a.createElement(e,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),Object(h.a)("If you've forgotten your Security Key you can <button>set up new recovery options</button>",{},{button:e=>c.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this.onResetRecoveryClick},e)}))}return c.a.createElement(s,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:l},c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},r))}}o()(g,"defaultProps",{showSummary:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return A}));var n,i,a,o=s(95),r=s.n(o),c=s(83),l=s.n(c),d=s(189),h=s.n(d),u=s(82),m=s.n(u),p=s(86),g=s(88),v=s(84),f=s(850),b=s(851),y=s(96),E=s(87),S=s(310),_=s(91),w=s.n(_),C=s(89),O=s(105),k=s(399),R=s(178),I=s(1031),x=s(3),T=s(153),j=s(419),N=s(558),P=s(85),D=s(154),M=s(1);let A=Object(P.a)("views.elements.AppTile")((a=i=class extends m.a.Component{constructor(e){super(e),l()(this,"contextMenuButton",Object(u.createRef)()),l()(this,"iframe",void 0),l()(this,"allowedWidgetsWatchRef",void 0),l()(this,"persistKey",void 0),l()(this,"sgWidget",void 0),l()(this,"dispatcherRef",void 0),l()(this,"hasPermissionToLoad",e=>{if(this.usingLocalWidget())return!0;if(!e.room)return!0;const t=C.b.getValue("allowedWidgets",e.room.roomId);return void 0===t[e.app.eventId]?e.userId===e.creatorUserId:!!t[e.app.eventId]}),l()(this,"onAllowedWidgetsChange",()=>{const e=this.hasPermissionToLoad(this.props);this.state.hasPermissionToLoad&&!e&&(S.b.instance.destroyPersistentWidget(this.props.app.id),k.a.destroyElement(this.persistKey),this.sgWidget&&this.sgWidget.stop()),this.setState({hasPermissionToLoad:e})}),l()(this,"iframeRefChange",e=>{if(this.iframe=e,e)try{this.sgWidget&&this.sgWidget.start(e)}catch(e){M.a.error("Failed to start widget",e)}else this.resetWidget(this.props)}),l()(this,"onWidgetPreparing",()=>{this.setState({loading:!1})}),l()(this,"onWidgetReady",()=>{R.a.JITSI.matches(this.props.app.type)&&this.sgWidget.widgetApi.transport.send(x.a.ClientReady,{})}),l()(this,"onWidgetCapabilitiesNotified",()=>{this.setState({requiresClient:this.sgWidget.widgetApi.hasCapability(T.MatrixCapabilities.RequiresClient)})}),l()(this,"onAction",e=>{if(e.widgetId===this.props.app.id)switch(e.action){case"m.sticker":this.sgWidget.widgetApi.hasCapability(T.MatrixCapabilities.StickerSending)?(E.a.dispatch({action:"post_sticker_message",data:e.data}),E.a.dispatch({action:"stickerpicker_close"})):M.a.warn("Ignoring sticker message. Invalid capability")}}),l()(this,"grantWidgetPermission",()=>{const e=this.props.room.roomId;M.a.info("Granting permission for widget to load: "+this.props.app.eventId);const t=C.b.getValue("allowedWidgets",e);t[this.props.app.eventId]=!0;const s=C.b.firstSupportedLevel("allowedWidgets");C.b.setValue("allowedWidgets",e,s,t).then(()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()}).catch(e=>{M.a.error(e)})}),l()(this,"onPopoutWidgetClick",()=>{R.a.JITSI.matches(this.props.app.type)&&this.endWidgetActions().then(()=>{this.iframe&&(this.iframe.src=this.sgWidget.embedUrl)}),Object.assign(document.createElement("a"),{target:"_blank",href:this.sgWidget.popoutUrl,rel:"noreferrer noopener"}).click()}),l()(this,"onMaxMinWidgetClick",()=>{const e=D.d.instance.isInContainer(this.props.room,this.props.app,D.a.Center)?D.a.Right:D.a.Center;D.d.instance.moveToContainer(this.props.room,this.props.app,e)}),l()(this,"onContextMenuClick",()=>{this.setState({menuDisplayed:!0})}),l()(this,"closeContextMenu",()=>{this.setState({menuDisplayed:!1})}),this.persistKey=Object(k.b)(this.props.app.id);try{this.sgWidget=new I.b(this.props),this.sgWidget.on("preparing",this.onWidgetPreparing),this.sgWidget.on("ready",this.onWidgetReady),this.sgWidget.on("capabilitiesNotified",this.onWidgetCapabilitiesNotified)}catch(e){M.a.log("Failed to construct widget",e),this.sgWidget=null}this.state=this.getNewState(e),this.allowedWidgetsWatchRef=C.b.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange)}getNewState(e){return{initialising:!0,loading:this.props.waitForIframeLoad&&!k.a.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),error:null,menuDisplayed:!1,widgetPageTitle:this.props.widgetPageTitle,requiresClient:!0}}isMixedContent(){const e=window.location.protocol,t=h.a.parse(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(M.a.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.dispatcherRef=E.a.register(this.onAction)}componentWillUnmount(){this.dispatcherRef&&E.a.unregister(this.dispatcherRef),S.b.instance.getWidgetPersistence(this.props.app.id)||(S.b.instance.destroyPersistentWidget(this.props.app.id),k.a.destroyElement(this.persistKey)),this.sgWidget&&this.sgWidget.stop(),C.b.unwatchSetting(this.allowedWidgetsWatchRef)}resetWidget(e){this.sgWidget&&this.sgWidget.stop();try{this.sgWidget=new I.b(e),this.sgWidget.on("preparing",this.onWidgetPreparing),this.sgWidget.on("ready",this.onWidgetReady),this.startWidget()}catch(e){M.a.error("Failed to construct widget",e),this.sgWidget=null}}startWidget(){this.sgWidget.prepare().then(()=>{this.setState({initialising:!1})})}UNSAFE_componentWillReceiveProps(e){e.app.url!==this.props.app.url&&(this.getNewState(e),this.state.hasPermissionToLoad&&this.resetWidget(e)),e.widgetPageTitle!==this.props.widgetPageTitle&&this.setState({widgetPageTitle:e.widgetPageTitle})}async endWidgetActions(){this.iframe&&(this.iframe.src="about:blank"),R.a.JITSI.matches(this.props.app.type)&&E.a.dispatch({action:"hangup_conference"}),k.a.destroyElement(this.persistKey),S.b.instance.destroyPersistentWidget(this.props.app.id),this.sgWidget&&this.sgWidget.stop({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return R.a.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=m.a.createElement("span",null," - ");let s="";return this.state.widgetPageTitle&&this.state.widgetPageTitle!==this.formatAppTileName()&&(s=this.state.widgetPageTitle),m.a.createElement("span",null,m.a.createElement(N.a,{app:this.props.app}),m.a.createElement("b",null,e),m.a.createElement("span",null,s?t:"",s))}render(){let e;const t="mx_AppTileBody"+(this.props.miniMode?"_mini  ":" "),s={};this.props.pointerEvents&&(s["pointer-events"]=this.props.pointerEvents);const n=m.a.createElement("div",{className:"mx_AppLoading_spinner_fadeIn"},m.a.createElement(y.a,{message:Object(v.a)("Loading...")}));if(null===this.sgWidget)e=m.a.createElement("div",{className:t,style:s},m.a.createElement(b.a,{errorMsg:Object(v.a)("Error loading Widget")}));else if(this.state.hasPermissionToLoad)this.state.initialising?e=m.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:s},n):this.isMixedContent()?e=m.a.createElement("div",{className:t,style:s},m.a.createElement(b.a,{errorMsg:Object(v.a)("Error - Mixed content")})):(e=m.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:s},this.state.loading&&n,m.a.createElement("iframe",{allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write;",ref:this.iframeRefChange,src:this.sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation"})),this.props.userWidget||(e=m.a.createElement("div",{className:"mx_AppTile_persistedWrapper"},m.a.createElement(k.a,{persistKey:this.persistKey},e))));else{const n=p.a.get().isRoomEncrypted(this.props.room.roomId);e=m.a.createElement("div",{className:t,style:s},m.a.createElement(f.a,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:n,onPermissionGranted:this.grantWidgetPermission}))}let i,a,o;if(i=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},i=w()(i),this.state.menuDisplayed&&(a=m.a.createElement(j.a,r()({},Object(O.j)(this.contextMenuButton.current.getBoundingClientRect(),null),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick}))),C.b.getValue("feature_maximised_widgets")){const e=D.d.instance.isInContainer(this.props.room,this.props.app,D.a.Center);o=m.a.createElement(g.a,{className:"mx_AppTileMenuBar_iconButton"+(e?" mx_AppTileMenuBar_iconButton_minWidget":" mx_AppTileMenuBar_iconButton_maxWidget"),title:e?Object(v.a)("Close"):Object(v.a)("Maximise widget"),onClick:this.onMaxMinWidgetClick})}return m.a.createElement(m.a.Fragment,null,m.a.createElement("div",{className:i,id:this.props.app.id},this.props.showMenubar&&m.a.createElement("div",{className:"mx_AppTileMenuBar"},m.a.createElement("span",{className:"mx_AppTileMenuBarTitle",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),m.a.createElement("span",{className:"mx_AppTileMenuBarWidgets"},o,this.props.showPopout&&!this.state.requiresClient&&m.a.createElement(g.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_popout",title:Object(v.a)("Popout widget"),onClick:this.onPopoutWidgetClick}),m.a.createElement(O.b,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_menu",label:Object(v.a)("Options"),isExpanded:this.state.menuDisplayed,inputRef:this.contextMenuButton,onClick:this.onContextMenuClick}))),e),a)}},l()(i,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(121),h=s(90),u=s(93),m=s(85),p=s(200),g=s(88),v=s(1);let f=Object(m.a)("views.elements.ErrorBoundary")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onClearCacheAndReload",()=>{d.a.get()&&(l.a.get().stopClient(),l.a.get().store.deleteAllData().then(()=>{d.a.get().reload()}))}),a()(this,"onBugReport",()=>{h.a.createTrackedDialog("Bug Report Dialog","",p.a,{label:"react-soft-crash",error:this.state.error})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,{componentStack:t}){v.a.error(e),v.a.error("The above error occured while React was rendering the following components:",t)}render(){if(this.state.error){const e="https://github.com/SchildiChat/schildichat-desktop/issues/new/choose";let t;return u.a.get().bug_report_endpoint_url&&(t=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(c.a)("Please <newIssueLink>create a new issue</newIssueLink> on GitHub so that we can investigate this bug.",{},{newIssueLink:t=>r.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:e},t)})),r.a.createElement("p",null,Object(c.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),r.a.createElement(g.a,{onClick:this.onBugReport,kind:"primary"},Object(c.a)("Submit debug logs")))),r.a.createElement("div",{className:"mx_ErrorBoundary"},r.a.createElement("div",{className:"mx_ErrorBoundary_body"},r.a.createElement("h1",null,Object(c.a)("Something went wrong!")),t,r.a.createElement(g.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(c.a)("Clear cache and reload"))))}return this.props.children}})||n},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(93),m=s(160),p=s(84),g=s(101),v=s(85);let f=Object(v.a)("views.auth.PassphraseField")((a=i=class extends c.PureComponent{constructor(...e){super(...e),r()(this,"validate",Object(m.a)({description:function(e){const t=e?e.score:0;return l.a.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([s.e(27),s.e(34)]).then(s.bind(null,1647));return t(e)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(p.a)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e},t){if(!e)return!1;const s=t.score>=this.props.minScore;return u.a.get().dangerously_allow_unsafe_and_insecure_passwords||s},valid:function(e){return e.score>=this.props.minScore?Object(p.a)(this.props.labelStrongPassword):Object(p.a)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||Object(p.a)("Keep going...")}}]})),r()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t})}render(){return l.a.createElement(g.a,{id:this.props.id,autoFocus:this.props.autoFocus,className:h()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:Object(p.a)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}},r()(i,"defaultProps",{label:Object(p.b)("Password"),labelEnterPassword:Object(p.b)("Enter password"),labelStrongPassword:Object(p.b)("Nice, strong password!"),labelAllowedButUnsafe:Object(p.b)("Password is allowed, but unsafe")}),n=a))||n;t.a=f},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"c",(function(){return m})),s.d(t,"b",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"e",(function(){return v}));var n=s(83),i=s.n(n),a=s(149),o=s(87),r=s(92),c=s(582),l=s(86),d=s(391),h=s(1);const u="mx_sso_hs_url",m="mx_sso_is_url",p="mx_sso_idp_id";let g;!function(e){e.Checking="CHECKING",e.Error="ERROR",e.NotAvailable="NOTAVAILABLE",e.Downloading="DOWNLOADING",e.Ready="READY"}(g||(g={}));class v{constructor(){i()(this,"notificationCount",0),i()(this,"errorDidOccur",!1),i()(this,"onAction",e=>{switch(e.action){case"on_client_not_viable":case"on_logged_out":this.setNotificationCount(0)}}),o.a.register(this.onAction),this.startUpdateCheck=this.startUpdateCheck.bind(this)}setNotificationCount(e){this.notificationCount=e}setErrorStatus(e){this.errorDidOccur=e}async canSelfUpdate(){return!1}startUpdateCheck(){Object(c.a)(),localStorage.removeItem("mx_defer_update"),o.a.dispatch({action:r.a.CheckUpdates,status:g.Checking})}installUpdate(){}shouldShowUpdate(e){if(l.a.userRegisteredWithinLastHours(24))return!1;try{const[t,s]=JSON.parse(localStorage.getItem("mx_defer_update"));return e!==t||Date.now()>s}catch(e){return!0}}deferUpdate(e){const t=new Date(Date.now()+864e5);t.setHours(8,0,0,0),localStorage.setItem("mx_defer_update",JSON.stringify([e,t.getTime()])),Object(c.a)()}supportsMultiLanguageSpellCheck(){return!1}supportsNotifications(){return!1}maySendNotifications(){return!1}loudNotification(e,t){}clearNotification(e){e.close&&e.close()}screenCaptureErrorString(){return"Not implemented"}supportsAutoLaunch(){return!1}async getAutoLaunchEnabled(){return!1}async setAutoLaunchEnabled(e){throw new Error("Unimplemented")}supportsWarnBeforeExit(){return!1}async shouldWarnBeforeExit(){return!1}async setWarnBeforeExit(e){throw new Error("Unimplemented")}supportsAutoHideMenuBar(){return!1}async getAutoHideMenuBarEnabled(){return!1}async setAutoHideMenuBarEnabled(e){throw new Error("Unimplemented")}supportsMinimizeToTray(){return!1}async getMinimizeToTrayEnabled(){return!1}async setMinimizeToTrayEnabled(e){throw new Error("Unimplemented")}getEventIndexingManager(){return null}async setLanguage(e){}setSpellCheckLanguages(e){}getSpellCheckLanguages(){return null}getAvailableSpellCheckLanguages(){return null}getSSOCallbackUrl(e){const t=new URL(window.location.href);return t.hash=e||"",t}startSingleSignOn(e,t,s,n){localStorage.setItem(u,e.getHomeserverUrl()),e.getIdentityServerUrl()&&localStorage.setItem(m,e.getIdentityServerUrl()),n&&localStorage.setItem(p,n);const i=this.getSSOCallbackUrl(s);window.location.href=e.getSsoLoginUrl(i.toString(),t,n)}onKeyDown(e){return!1}async getPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;let s;try{s=await Object(d.c)("pickleKey",[e,t])}catch(e){h.a.error("idbLoad for pickleKey failed",e)}if(!s)return null;if(!s.encrypted||!s.iv||!s.cryptoKey)return h.a.error("Badly formatted pickle key"),null;const n=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);n[e.length]=124;for(let s=0;s<t.length;s++)n[e.length+1+s]=t.charCodeAt(s);try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:s.iv,additionalData:n},s.cryptoKey,s.encrypted);return Object(a.encodeUnpaddedBase64)(e)}catch(e){return h.a.error("Error decrypting pickle key"),null}}async createPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;const s=window.crypto,n=new Uint8Array(32);s.getRandomValues(n);const i=await s.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),o=new Uint8Array(32);s.getRandomValues(o);const r=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);r[e.length]=124;for(let s=0;s<t.length;s++)r[e.length+1+s]=t.charCodeAt(s);const c=await s.subtle.encrypt({name:"AES-GCM",iv:o,additionalData:r},i,n);try{await Object(d.d)("pickleKey",[e,t],{encrypted:c,iv:o,cryptoKey:i})}catch(e){return null}return Object(a.encodeUnpaddedBase64)(n)}async destroyPickleKey(e,t){try{await Object(d.b)("pickleKey",[e,t])}catch(e){h.a.error("idbDelete failed in destroyPickleKey",e)}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(251),c=s(84);var l=s(93),d=s(1);const h=[r.a.ERROR_INVALID_HOMESERVER,r.a.ERROR_INVALID_IDENTITY_SERVER];class u{constructor(){i()(this,"hsUrl",void 0),i()(this,"hsName",void 0),i()(this,"hsNameIsDifferent",void 0),i()(this,"isUrl",void 0),i()(this,"isDefault",void 0),i()(this,"isNameResolvable",void 0),i()(this,"warning",void 0)}}class m{static isLivelinessError(e){return!!e&&!!h.find(t=>"string"==typeof e?t===e:t===e.message)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let s=Object(c.a)("Cannot reach homeserver"),n=Object(c.a)("Ensure you have a stable internet connection, or get in touch with the server admin");if(!m.isLivelinessError(e)){const e=l.a.get().brand;s=Object(c.a)("Your %(brand)s is misconfigured",{brand:e}),n=Object(c.a)("Ask your %(brand)s admin to check <a>your config</a> for incorrect or duplicate entries.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let i=!0;return("string"==typeof e?e:e.message)===r.a.ERROR_INVALID_IDENTITY_SERVER&&(i=!1,s=Object(c.a)("Cannot reach identity server"),n="register"===t?Object(c.a)("You can register, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):"reset_password"===t?Object(c.a)("You can reset your password, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):Object(c.a)("You can log in, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin.")),{serverIsAlive:!1,serverErrorIsFatal:i,serverDeadError:o.a.createElement("div",null,o.a.createElement("strong",null,s),o.a.createElement("div",null,n))}}static async validateServerConfigWithStaticUrls(e,t,s=!1){if(!e)throw Object(c.h)(Object(c.b)("No homeserver URL provided"));const n={"m.homeserver":{base_url:e}};t&&(n["m.identity_server"]={base_url:t});const i=await r.a.fromDiscoveryConfig(n),a=new URL(e).hostname;return m.buildValidatedConfigFromDiscovery(a,i,s,!0)}static async validateServerName(e){const t=await r.a.findClientConfig(e);return m.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t,s=!1,n=!1){if(!t||!t["m.homeserver"])throw d.a.error("Ended up in a state of not knowing which homeserver to connect to."),Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"));const i=t["m.homeserver"],a=t["m.identity_server"],o=l.a.get().validated_server_config;let h=o&&o.isUrl;if(a&&a.state===r.a.SUCCESS)h=a.base_url;else if(a&&a.state!==r.a.PROMPT){if(d.a.error("Error determining preferred identity server URL:",a),a.state===r.a.FAIL_ERROR){if(-1!==r.a.ALL_ERRORS.indexOf(a.error))throw Object(c.h)(a.error);throw Object(c.h)(Object(c.b)("Unexpected error resolving identity server configuration"))}i.error=r.a.ERROR_INVALID_IDENTITY_SERVER,a.base_url&&(h=a.base_url)}if(i.state!==r.a.SUCCESS&&(d.a.error("Error processing homeserver config:",i),!s||!m.isLivelinessError(i.error))){if(-1!==r.a.ALL_ERRORS.indexOf(i.error))throw Object(c.h)(i.error);throw Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"))}const p=i.base_url;let g=e||i.server_name;const v=new URL(p);if(g||(g=v.hostname),!g)throw d.a.error("Failed to parse homeserver name from homeserver URL"),Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"));return function(e,t){const s=new e;return Object.assign(s,t),s}(u,{hsUrl:p,hsName:g,hsNameIsDifferent:v.hostname!==g,isUrl:h,isDefault:!1,warning:i.error,isNameResolvable:!n})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return m}));var n=s(99),i=s.n(n),a=s(5),o=s(157),r=s(117),c=s(1),l=s(94);class d extends a.EventEmitter{constructor(e,t,s){super(),this.relationType=e,this.eventType=t,this.room=s,i()(this,"relationEventIds",new Set),i()(this,"relations",new Set),i()(this,"annotationsByKey",{}),i()(this,"annotationsBySender",{}),i()(this,"sortedAnnotationsByKey",[]),i()(this,"targetEvent",null),i()(this,"creationEmitted",!1),i()(this,"onEventStatus",(e,t)=>{e.isSending()?t===r.a.CANCELLED&&(e.removeListener("Event.status",this.onEventStatus),this.removeEvent(e)):e.removeListener("Event.status",this.onEventStatus)}),i()(this,"onBeforeRedaction",async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===l.c.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===l.c.Replace&&this.targetEvent){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener("Event.beforeRedaction",this.onBeforeRedaction),this.emit("Relations.redaction",e)}})}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void c.a.error("Event must have relation info");const s=t.rel_type,n=e.getType();if(this.relationType===s&&this.eventType===n){if(e.isSending()&&e.on("Event.status",this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===l.c.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===l.c.Replace&&this.targetEvent){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on("Event.beforeRedaction",this.onBeforeRedaction),this.emit("Relations.add",e),this.maybeEmitCreated()}else c.a.error("Event relation info doesn't match this container")}async removeEvent(e){if(!this.relations.has(e))return;const t=e.getRelation();if(!t)return void c.a.error("Event must have relation info");const s=t.rel_type,n=e.getType();if(this.relationType===s&&this.eventType===n){if(this.relations.delete(e),this.relationType===l.c.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===l.c.Replace&&this.targetEvent){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit("Relations.remove",e)}else c.a.error("Event relation info doesn't match this container")}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let s=this.annotationsByKey[t];s||(s=this.annotationsByKey[t]=new Set,this.sortedAnnotationsByKey.push([t,s])),s.add(e),this.sortedAnnotationsByKey.sort((e,t)=>{const s=e[1];return t[1].size-s.size});const n=e.getSender();let i=this.annotationsBySender[n];i||(i=this.annotationsBySender[n]=new Set),i.add(e)}removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const s=this.annotationsByKey[t];s&&(s.delete(e),this.sortedAnnotationsByKey.sort((e,t)=>{const s=e[1];return t[1].size-s.size}));const n=e.getSender(),i=this.annotationsBySender[n];i&&i.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==l.c.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==l.c.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==l.c.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(l.c.Replace),t=e&&e.origin_server_ts,s=this.getRelations().reduce((e,s)=>s.getSender()!==this.targetEvent.getSender()||t&&t>s.getTs()||e&&e.getTs()>s.getTs()?e:s,null);return null!=s&&s.shouldAttemptDecryption()?await s.attemptDecryption(this.room.client.crypto):null!=s&&s.isBeingDecrypted()&&await s.getDecryptionPromise(),s}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===l.c.Replace){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit("Event.relationsCreated",this.relationType,this.eventType))}}let h,u;h=c.a.log.bind(c.a),function(e){e.Ignore="ignore",e.Replace="replace"}(u||(u={}));class m extends a.EventEmitter{constructor(e,t){super(),this.room=e,i()(this,"timelineSupport",void 0),i()(this,"unstableClientRelationAggregation",void 0),i()(this,"displayPendingEvents",void 0),i()(this,"liveTimeline",void 0),i()(this,"timelines",void 0),i()(this,"_eventIdToTimeline",void 0),i()(this,"filter",void 0),i()(this,"relations",void 0),this.timelineSupport=Boolean(t.timelineSupport),this.liveTimeline=new o.b(this),this.unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline={},this.filter=t.filter,this.unstableClientRelationAggregation&&(this.relations={})}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(e){if(!this.room||!this.displayPendingEvents)return[];const t=this.room.getPendingEvents(e);return this.filter?this.filter.filterRoomTimeline(t):t}getLiveTimeline(){return this.liveTimeline}eventIdToTimeline(e){return this._eventIdToTimeline[e]}replaceEventId(e,t){const s=this._eventIdToTimeline[e];s&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=s)}resetLiveTimeline(e,t){const s=!this.timelineSupport||!t,n=this.liveTimeline,i=s?n.forkLive(o.b.FORWARDS):n.fork(o.b.FORWARDS);s?(this.timelines=[i],this._eventIdToTimeline={}):this.timelines.push(i),t&&n.setPaginationToken(t,o.b.FORWARDS),i.setPaginationToken(e,o.b.BACKWARDS),this.liveTimeline=i,this.emit("Room.timelineReset",this.room,this,s)}getTimelineForEvent(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new o.b(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,s,n){if(!s)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&s==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;const i=t?o.b.BACKWARDS:o.b.FORWARDS,a=t?o.b.FORWARDS:o.b.BACKWARDS;let r=!1,l=!1;for(let n=0;n<e.length;n++){const d=e[n],u=d.getId(),m=this._eventIdToTimeline[u];if(!m){this.addEventToTimeline(d,s,t),l=!0,r=!0;continue}if(l=!1,m==s){h("Event "+u+" already in timeline "+s);continue}const p=s.getNeighbouringTimeline(i);if(p){h(m==p?"Event "+u+" in neighbouring timeline - switching to "+m:"Event "+u+" already in a different timeline "+m),s=m;continue}c.a.info("Already have timeline for "+u+" - joining timeline "+s+" to "+m);const g=m===this.liveTimeline,v=s===this.liveTimeline,f=i===o.b.BACKWARDS&&g,b=i===o.b.FORWARDS&&v;f||b?(f&&c.a.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+m+")"),b&&c.a.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+s+")")):(s.setNeighbouringTimeline(m,i),m.setNeighbouringTimeline(s,a),s=m,r=!0)}if(l||!r){if(i===o.b.FORWARDS&&s===this.liveTimeline)return c.a.warn({lastEventWasNew:l,didUpdate:r}),void c.a.warn(`Refusing to set forwards pagination token of live timeline ${s} to ${n}`);s.setPaginationToken(n,i)}}addLiveEvent(e,t=u.Ignore,s=!1,n){if(this.filter){if(!this.filter.filterRoomTimeline([e]).length)return}const i=this._eventIdToTimeline[e.getId()];if(i)if(t===u.Replace){h("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=i.getEvents();for(let s=0;s<t.length;s++)if(t[s].getId()===e.getId()){n||(n=i.getState(o.b.FORWARDS)),o.b.setEventMetadata(e,n,!1),t[s]=e;break}}else h("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,!1,s,n)}addEventToTimeline(e,t,s,n=!1,i){const a=e.getId();t.addEvent(e,s,i),this._eventIdToTimeline[a]=t,this.setRelationsTarget(e),this.aggregateRelations(e);const o={timeline:t,liveEvent:!s&&t==this.liveTimeline&&!n};this.emit("Room.timeline",e,this.room,Boolean(s),!1,o)}handleRemoteEcho(e,t,s){const n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[s]=n):this.filter?this.filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this.liveTimeline,!1):this.addEventToTimeline(e,this.liveTimeline,!1)}removeEvent(e){const t=this._eventIdToTimeline[e];if(!t)return null;const s=t.removeEvent(e);if(s){delete this._eventIdToTimeline[e];const n={timeline:t};this.emit("Room.timeline",s,this.room,void 0,!0,n)}return s}compareEventOrdering(e,t){if(e==t)return 0;const s=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===s)return null;if(void 0===n)return null;if(s===n){let n,i;const a=s.getEvents();for(let s=0;s<a.length&&(void 0===n||void 0===i);s++){const o=a[s].getId();o==e&&(n=s),o==t&&(i=s)}return n-i}let i=s;for(;i;){if(i===n)return-1;i=i.getNeighbouringTimeline(o.b.FORWARDS)}for(i=s;i;){if(i===n)return 1;i=i.getNeighbouringTimeline(o.b.BACKWARDS)}return null}getRelationsForEvent(e,t,s){if(!this.unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!s)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this.relations[e]||{})[t]||{})[s]}setRelationsTarget(e){if(!this.unstableClientRelationAggregation)return;const t=this.relations[e.getId()];if(t)for(const s of Object.values(t))for(const t of Object.values(s))t.setTargetEvent(e)}aggregateRelations(e){if(!this.unstableClientRelationAggregation)return;if(e.isRedacted()||e.status===r.a.CANCELLED)return;if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once("Event.decrypted",()=>{this.aggregateRelations(e)});const t=e.getRelation();if(!t)return;const s=t.event_id,n=t.rel_type,i=e.getType();let a=this.relations[s];a||(a=this.relations[s]={});let o=a[n];o||(o=a[n]={});let c,l=o[i];l||(l=o[i]=new d(n,i,this.room),c=this.findEventById(s)||this.room.getPendingEvent(s),c&&l.setTargetEvent(c)),l.addEvent(e)}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return h})),s.d(t,"a",(function(){return u}));var n,i=s(99),a=s.n(i),o=s(117),r=s(157),c=s(281),l=s(5);!function(e){e.NewListener="newListener",e.RemoveListener="removeListener"}(n||(n={}));class d extends l.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}eventNames(){return super.eventNames()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}let h;!function(e){e.New="Thread.new",e.Ready="Thread.ready",e.Update="Thread.update"}(h||(h={}));class u extends d{constructor(e=[],t,s){if(super(),this.room=t,this.client=s,a()(this,"root",void 0),a()(this,"timelineSet",void 0),a()(this,"_currentUserParticipated",!1),a()(this,"onEcho",e=>{this.timelineSet.eventIdToTimeline(e.getId())&&this.emit(h.Update,this)}),0===e.length)throw new Error("Can't create an empty thread");this.timelineSet=new c.b(this.room,{unstableClientRelationAggregation:!0,timelineSupport:!0,pendingEvents:!0}),e.forEach(e=>this.addEvent(e)),t.on("Room.localEchoUpdated",this.onEcho),t.on("Room.timeline",this.onEcho)}async addEvent(e,t=!1){if(this.timelineSet.findEventById(e.getId())||null!==e.status)return;this.root||(e.isThreadRelation?this.root=e.threadRootId:this.root=e.getId());const s=this.room.getLiveTimeline().getState(r.b.FORWARDS);e.setThread(this),this.timelineSet.addEventToTimeline(e,this.timelineSet.getLiveTimeline(),t,!1,s),this._currentUserParticipated||e.getSender()!==this.client.getUserId()||(this._currentUserParticipated=!0),await this.client.decryptEventIfNeeded(e,{}),this.emit(h.Update,this)}findEventById(e){return this.timelineSet.findEventById(e)}get lastReply(){const e=this.events.filter(e=>e.isThreadRelation);return e[e.length-1]}get id(){return this.root}get rootEvent(){return this.findEventById(this.root)}get roomId(){return this.rootEvent.getRoomId()}get length(){return this.events.filter(e=>e.isThreadRelation).length}get replyToEvent(){const e=this.events;return e[e.length-1]}get events(){return this.timelineSet.getLiveTimeline().getEvents()}merge(e){e.events.forEach(e=>{this.addEvent(e)}),this.events.forEach(e=>e.setThread(this))}has(e){return this.timelineSet.findEventById(e)instanceof o.b}get hasCurrentUserParticipated(){return this._currentUserParticipated}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return x}));var n=s(95),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(84),d=s(111),h=s(108),u=s(357),m=s.n(u),p=s(142),g=s(291),v=s(377),f=s(105),b=s(501),y=s(89),E=s(136),S=s(87),_=s(92),w=s(85);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function O(e){let t,s,n;return 1===e.deltaMode?(t=18*e.deltaX,s=18*e.deltaY,n=18*e.deltaZ):(t=e.deltaX,s=e.deltaY,n=e.deltaZ),new WheelEvent("syntheticWheel",function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({deltaMode:0,deltaY:s,deltaX:t,deltaZ:n},e))}var k,R=s(139);const I=()=>{const e=getComputedStyle(document.documentElement).getPropertyValue("--image-view-panel-height");return parseInt(e.slice(0,e.length-2))};let x=Object(w.a)("views.elements.ImageView")(k=class extends c.a.Component{constructor(e){var t,s;super(e),o()(this,"contextMenuButton",Object(r.createRef)()),o()(this,"focusLock",Object(r.createRef)()),o()(this,"imageWrapper",Object(r.createRef)()),o()(this,"image",Object(r.createRef)()),o()(this,"initX",0),o()(this,"initY",0),o()(this,"previousX",0),o()(this,"previousY",0),o()(this,"animatingLoading",!1),o()(this,"imageIsLoaded",!1),o()(this,"imageLoaded",()=>{const{thumbnailInfo:e}=this.props;null!=e&&e.width&&this.setState({zoom:e.width/this.image.current.naturalWidth}),this.imageIsLoaded=!0,this.animatingLoading=!0,this.setZoomAndRotation(),this.setState({translationX:0,translationY:0}),this.animatingLoading=!1}),o()(this,"recalculateZoom",()=>{this.setZoomAndRotation()}),o()(this,"setZoomAndRotation",e=>{const t=this.image.current,s=this.imageWrapper.current,n=null!=e?e:this.state.rotation,i=n%180==0,a=i?t.naturalWidth:t.naturalHeight,o=i?t.naturalHeight:t.naturalWidth,r=s.clientWidth/a,c=s.clientHeight/o;if(r>=1&&c>=1)return void this.setState({zoom:1,minZoom:1,maxZoom:1,rotation:n});const l=.95*Math.min(r,c),d=this.state.zoom<=this.state.minZoom?l:this.state.zoom;this.setState({minZoom:l,maxZoom:1,rotation:n,zoom:d})}),o()(this,"onWheel",e=>{if(e.target===this.image.current){e.stopPropagation(),e.preventDefault();const{deltaY:t}=O(e);this.zoomDelta(.0025*-t,e.offsetX,e.offsetY)}}),o()(this,"onZoomInClick",()=>{this.zoomDelta(.1)}),o()(this,"onZoomOutClick",()=>{this.zoomDelta(-.1)}),o()(this,"onKeyDown",e=>{e.key===h.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),o()(this,"onRotateCounterClockwiseClick",()=>{const e=this.state.rotation;this.setZoomAndRotation(e-90)}),o()(this,"onRotateClockwiseClick",()=>{const e=this.state.rotation;this.setZoomAndRotation(e+90)}),o()(this,"onDownloadClick",()=>{const e=document.createElement("a");e.href=this.props.src,e.download=this.props.name,e.target="_blank",e.rel="noreferrer noopener",e.click()}),o()(this,"onOpenContextMenu",()=>{this.setState({contextMenuDisplayed:!0})}),o()(this,"onCloseContextMenu",()=>{this.setState({contextMenuDisplayed:!1})}),o()(this,"onPermalinkClicked",e=>{e.preventDefault(),S.a.dispatch({action:_.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()}),this.props.onFinished()}),o()(this,"onStartMoving",e=>{e.stopPropagation(),e.preventDefault(),0===e.button&&(this.state.zoom!==this.state.minZoom?(this.setState({moving:!0}),this.previousX=this.state.translationX,this.previousY=this.state.translationY,this.initX=e.pageX-this.state.translationX,this.initY=e.pageY-this.state.translationY):this.zoom(this.state.maxZoom,e.nativeEvent.offsetX,e.nativeEvent.offsetY))}),o()(this,"onMoving",e=>{e.stopPropagation(),e.preventDefault(),this.state.moving&&this.setState({translationX:e.pageX-this.initX,translationY:e.pageY-this.initY})}),o()(this,"onEndMoving",()=>{!0===this.state.moving&&Math.abs(this.state.translationX-this.previousX)<10&&Math.abs(this.state.translationY-this.previousY)<10&&(this.zoom(this.state.minZoom),this.initX=0,this.initY=0),this.setState({moving:!1})});const{thumbnailInfo:n}=this.props;this.state={zoom:0,minZoom:.95,maxZoom:.95,rotation:0,translationX:null!==(t=(null==n?void 0:n.positionX)+(null==n?void 0:n.width)/2-R.b.instance.windowWidth/2)&&void 0!==t?t:0,translationY:null!==(s=(null==n?void 0:n.positionY)+(null==n?void 0:n.height)/2-R.b.instance.windowHeight/2-I()/2)&&void 0!==s?s:0,moving:!1,contextMenuDisplayed:!1}}componentDidMount(){this.focusLock.current.addEventListener("wheel",this.onWheel,{passive:!1}),window.addEventListener("resize",this.recalculateZoom),this.image.current.addEventListener("load",this.imageLoaded)}componentWillUnmount(){this.focusLock.current.removeEventListener("wheel",this.onWheel),window.removeEventListener("resize",this.recalculateZoom),this.image.current.removeEventListener("load",this.imageLoaded)}zoomDelta(e,t,s){this.zoom(this.state.zoom+e,t,s)}zoom(e,t,s){const n=this.state.zoom,i=Math.min(e,this.state.maxZoom);if(i<=this.state.minZoom)this.setState({zoom:this.state.minZoom,translationX:0,translationY:0});else if("number"!=typeof t&&"number"!=typeof s)this.setState({zoom:i,translationX:this.state.translationX*i/n,translationY:this.state.translationY*i/n});else{let e,a;switch((this.state.rotation%360+360)%360){case 0:e=this.image.current.clientWidth/2-t,a=this.image.current.clientHeight/2-s;break;case 90:e=s-this.image.current.clientHeight/2,a=this.image.current.clientWidth/2-t;break;case 180:e=t-this.image.current.clientWidth/2,a=s-this.image.current.clientHeight/2;break;case 270:e=this.image.current.clientHeight/2-s,a=t-this.image.current.clientWidth/2}this.setState({zoom:i,translationX:this.state.translationX+(i-n)*e,translationY:this.state.translationY+(i-n)*a})}}renderContextMenu(){let e=null;return this.state.contextMenuDisplayed&&(e=c.a.createElement(v.b,i()({},Object(f.j)(this.contextMenuButton.current.getBoundingClientRect()),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,onFinished:this.onCloseContextMenu,onCloseDialog:this.props.onFinished}))),c.a.createElement(c.a.Fragment,null,e)}render(){const e=!!this.props.mxEvent,t=this.state.maxZoom===this.state.minZoom;let s,n;s=this.animatingLoading?"mx_ImageView_image_animatingLoading":this.state.moving||!this.imageIsLoaded?"":"mx_ImageView_image_animating",n=this.state.moving?"grabbing":t?"default":this.state.zoom===this.state.minZoom?"zoom-in":"zoom-out";const i=this.state.rotation+"deg",a=this.state.zoom,o={cursor:n,transform:`translateX(${this.state.translationX+"px"})\n                        translateY(${this.state.translationY+"px"})\n                        scale(${a})\n                        rotate(${i})`};let r,h,u,v;if(e){const e=this.props.mxEvent,t=y.b.getValue("showTwelveHourTimestamps");let s="#";this.props.permalinkCreator&&(s=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const n=e.sender?e.sender.name:e.getSender(),i=c.a.createElement("div",{className:"mx_ImageView_info_sender"},n),a=c.a.createElement("a",{href:s,onClick:this.onPermalinkClicked,"aria-label":Object(E.c)(new Date(this.props.mxEvent.getTs()),t,!1)},c.a.createElement(b.a,{showFullDate:!0,showTwelveHour:t,ts:e.getTs(),showSeconds:!1})),o=c.a.createElement(p.a,{member:e.sender,fallbackUserId:e.getSender(),width:32,height:32,viewUserOnClick:!0});r=c.a.createElement("div",{className:"mx_ImageView_info_wrapper"},o,c.a.createElement("div",{className:"mx_ImageView_info"},i,a))}else r=c.a.createElement("div",null);return this.props.mxEvent&&(h=c.a.createElement(g.a,{className:"mx_ImageView_button mx_ImageView_button_more",title:Object(l.a)("Options"),onClick:this.onOpenContextMenu,inputRef:this.contextMenuButton,isExpanded:this.state.contextMenuDisplayed})),t||(u=c.a.createElement(d.a,{className:"mx_ImageView_button mx_ImageView_button_zoomOut",title:Object(l.a)("Zoom out"),onClick:this.onZoomOutClick}),v=c.a.createElement(d.a,{className:"mx_ImageView_button mx_ImageView_button_zoomIn",title:Object(l.a)("Zoom in"),onClick:this.onZoomInClick})),c.a.createElement(m.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog"},className:"mx_ImageView",ref:this.focusLock},c.a.createElement("div",{className:"mx_ImageView_panel"},r,c.a.createElement("div",{className:"mx_ImageView_toolbar"},u,v,c.a.createElement(d.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCCW",title:Object(l.a)("Rotate Left"),onClick:this.onRotateCounterClockwiseClick}),c.a.createElement(d.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCW",title:Object(l.a)("Rotate Right"),onClick:this.onRotateClockwiseClick}),c.a.createElement(d.a,{className:"mx_ImageView_button mx_ImageView_button_download",title:Object(l.a)("Download"),onClick:this.onDownloadClick}),h,c.a.createElement(d.a,{className:"mx_ImageView_button mx_ImageView_button_close",title:Object(l.a)("Close"),onClick:this.props.onFinished}),this.renderContextMenu())),c.a.createElement("div",{className:"mx_ImageView_image_wrapper",ref:this.imageWrapper,onMouseDown:this.props.onFinished,onMouseMove:this.onMoving,onMouseUp:this.onEndMoving,onMouseLeave:this.onEndMoving},c.a.createElement("img",{src:this.props.src,style:o,alt:this.props.name,ref:this.image,className:"mx_ImageView_image "+s,draggable:!0,onMouseDown:this.onStartMoving})))}})||k},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(126),d=s(192),h=s(173),u=s(86),m=s(93);var p,g,v=s(84),f=s(177),b=s(130),y=s(85);function E(e){switch(e){case g.Globe:return Object(v.a)("This room is public");case g.PresenceOnline:return Object(v.a)("Online");case g.PresenceAway:return Object(v.a)("Away");case g.PresenceOffline:return Object(v.a)("Offline")}}!function(e){e.None="NONE",e.Globe="GLOBE",e.PresenceOnline="ONLINE",e.PresenceAway="AWAY",e.PresenceOffline="OFFLINE"}(g||(g={}));let S=Object(y.a)("views.avatars.DecoratedRoomAvatar")(p=class extends o.a.PureComponent{constructor(e){super(e),i()(this,"_dmUser",void 0),i()(this,"isUnmounted",!1),i()(this,"isWatchingTimeline",!1),i()(this,"onRoomTimeline",(e,t)=>{if(!this.isUnmounted&&t&&this.props.room.roomId===t.roomId&&("m.room.join_rules"===e.getType()||"m.room.member"===e.getType())){const e=this.calculateIcon();e!==this.state.icon&&this.setState({icon:e})}}),i()(this,"onPresenceUpdate",()=>{if(this.isUnmounted)return;const e=this.getPresenceIcon();e!==this.state.icon&&this.setState({icon:e})}),this.state={notificationState:h.a.instance.getRoomState(this.props.room),icon:this.calculateIcon()}}componentWillUnmount(){this.isUnmounted=!0,this.isWatchingTimeline&&this.props.room.off("Room.timeline",this.onRoomTimeline),this.dmUser=null}get isPublicRoom(){const e=this.props.room.currentState.getStateEvents("m.room.join_rules","");return"public"===(e&&e.getContent().join_rule)}get dmUser(){return this._dmUser}set dmUser(e){const t=this._dmUser;this._dmUser=e,t&&t!==this._dmUser&&(t.off("User.currentlyActive",this.onPresenceUpdate),t.off("User.presence",this.onPresenceUpdate)),this._dmUser&&t!==this._dmUser&&(this._dmUser.on("User.currentlyActive",this.onPresenceUpdate),this._dmUser.on("User.presence",this.onPresenceUpdate))}getPresenceIcon(){if(!this.dmUser)return g.None;let e=g.None;return this.dmUser.currentlyActive||"online"===this.dmUser.presence?e=g.PresenceOnline:"offline"===this.dmUser.presence?e=g.PresenceOffline:"unavailable"===this.dmUser.presence&&(e=g.PresenceAway),e}calculateIcon(){let e=g.None;const t=b.a.shared().getUserIdForRoomId(this.props.room.roomId);return t&&2===this.props.room.getJoinedMemberCount()?function(){const e=u.a.get().baseUrl,t=m.a.get().enable_presence_by_hs_url;return!t||!(!t[e]&&void 0!==t[e])}()&&t&&(this.dmUser=u.a.get().getUser(t),e=this.getPresenceIcon()):(e=this.isPublicRoom?g.Globe:g.None,this.isWatchingTimeline||(this.props.room.on("Room.timeline",this.onRoomTimeline),this.isWatchingTimeline=!0)),e}render(){let e,t;this.props.displayBadge&&(e=o.a.createElement(d.a,{notification:this.state.notificationState,forceCount:this.props.forceCount,roomId:this.props.room.roomId})),this.state.icon!==g.None&&(t=o.a.createElement(f.a,{tooltip:E(this.state.icon),class:"mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_"+this.state.icon.toLowerCase()}));const s=c()("mx_DecoratedRoomAvatar",{mx_DecoratedRoomAvatar_cutout:t});return o.a.createElement("div",{className:s},o.a.createElement(l.a,{room:this.props.room,width:this.props.avatarSize,height:this.props.avatarSize,oobData:this.props.oobData,viewAvatarOnClick:this.props.viewAvatarOnClick}),t,e)}})||p},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(99),i=s.n(n),a=s(1),o=s(4);function r(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?r(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class l{constructor(){i()(this,"outgoingRoomKeyRequests",[]),i()(this,"account",null),i()(this,"crossSigningKeys",null),i()(this,"privateKeys",{}),i()(this,"sessions",{}),i()(this,"sessionProblems",{}),i()(this,"notifiedErrorDevices",{}),i()(this,"inboundGroupSessions",{}),i()(this,"inboundGroupSessionsWithheld",{}),i()(this,"deviceData",null),i()(this,"rooms",{}),i()(this,"sessionsNeedingBackup",{}),i()(this,"sharedHistoryInboundGroupSessions",{})}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return o.C(()=>{const s=this._getOutgoingRoomKeyRequest(t);return s?(a.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),s):(a.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if(o.i(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const s of e)if(t.state===s)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,s){const n=[];for(const i of this.outgoingRoomKeyRequests)for(const a of s)i.state===a&&i.recipients.includes({userId:e,deviceId:t})&&n.push(i);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,s){for(const n of this.outgoingRoomKeyRequests)if(n.requestId===e)return n.state!==t?(a.a.warn(`Cannot update room key request from ${t} as it was already updated to `+n.state),Promise.resolve(null)):(Object.assign(n,s),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let s=0;s<this.outgoingRoomKeyRequests.length;s++){const n=this.outgoingRoomKeyRequests[s];if(n.requestId===e)return n.state!=t?(a.a.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(s,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,s){t(this.privateKeys[s]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,s){this.privateKeys[t]=s}countEndToEndSessions(e,t){t(Object.keys(this.sessions).length)}getEndToEndSession(e,t,s,n){n((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,s){s(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach(([e,s])=>{Object.entries(s).forEach(([s,n])=>{t(c(c({},n),{},{deviceKey:e,sessionId:s}))})})}storeEndToEndSession(e,t,s,n){let i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),i[t]=s}async storeEndToEndSessionProblem(e,t,s){const n=this.sessionProblems[e]=this.sessionProblems[e]||[];n.push({type:t,fixed:s,time:Date.now()}),n.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){const s=this.sessionProblems[e]||[];if(!s.length)return null;const n=s[s.length-1];for(const e of s)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,s=[];for(const n of e){const{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(s.push(n),t[e][i.deviceId]=!0):(s.push(n),t[e]={[i.deviceId]:!0})}return s}getEndToEndInboundGroupSession(e,t,s,n){const i=e+"/"+t;n(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this.inboundGroupSessions))t({senderKey:e.substr(0,43),sessionId:e.substr(44),sessionData:this.inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,s,n){const i=e+"/"+t;void 0===this.inboundGroupSessions[i]&&(this.inboundGroupSessions[i]=s)}storeEndToEndInboundGroupSession(e,t,s,n){this.inboundGroupSessions[e+"/"+t]=s}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){const i=e+"/"+t;this.inboundGroupSessionsWithheld[i]=s}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,s){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const s in this.sessionsNeedingBackup)if(this.inboundGroupSessions[s]&&(t.push({senderKey:s.substr(0,43),sessionId:s.substr(44),sessionData:this.inboundGroupSessions[s]}),e&&s.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,s){const n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,s]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}doTxn(e,t,s){return Promise.resolve(s(null))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(99),i=s.n(n),a=s(223);function o(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class r{constructor(e={}){i()(this,"rooms",{}),i()(this,"groups",{}),i()(this,"users",{}),i()(this,"syncToken",null),i()(this,"filters",{}),i()(this,"accountData",{}),i()(this,"localStorage",void 0),i()(this,"oobMembers",{}),i()(this,"clientOptions",{}),i()(this,"onRoomMember",(e,t,s)=>{if("invite"===s.membership)return;const n=this.users[s.userId]||new a.a(s.userId);s.name&&(n.setDisplayName(s.name),s.events.member&&n.setRawDisplayName(s.events.member.getDirectionalContent().displayname)),s.events.member&&s.events.member.getContent().avatar_url&&n.setAvatarUrl(s.events.member.getContent().avatar_url),this.users[n.userId]=n}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeGroup(e){this.groups[e.groupId]=e}getGroup(e){return this.groups[e]||null}getGroups(){return Object.values(this.groups)}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,s,n){}storeFilter(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)}getFilter(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(o(e))return e}catch(e){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const s="mxjssdk_memory_filter_"+e;try{o(t)?this.localStorage.setItem(s,t):this.localStorage.removeItem(s)}catch(e){}}storeAccountDataEvents(e){e.forEach(e=>{this.accountData[e.getType()]=e})}getAccountData(e){return this.accountData[e]}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers[e]||null)}setOutOfBandMembers(e,t){return this.oobMembers[e]=t,Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers={},Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(4);function i(e,t,s,i,a,o=!1){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return o?t:"";let r=t.slice(6),c="/_matrix/media/r0/download/";const l={};s&&(l.width=Math.round(s)),i&&(l.height=Math.round(i)),a&&(l.method=a),Object.keys(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const d=r.indexOf("#");let h="";d>=0&&(h=r.substr(d),r=r.substr(0,d));return e+c+r+(0===Object.keys(l).length?"":"?"+n.m(l))+h}},function(e,t,s){"use strict";(function(e){s.d(t,"h",(function(){return h})),s.d(t,"i",(function(){return u})),s.d(t,"e",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"g",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"c",(function(){return b})),s.d(t,"b",(function(){return y})),s.d(t,"a",(function(){return E})),s.d(t,"j",(function(){return S}));var n=s(99),i=s.n(n),a=s(1075),o=s(4),r=s(1),c=s(1076);function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function d(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const h="/_matrix/client/r0",u="/_matrix/client/unstable",m="/_matrix/identity/api/v1",p="/_matrix/identity/v2",g="/_matrix/media/r0";function v(e,t){o.e(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}v.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){const e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(t,s){o.u(s)?s={callback:s}:void 0===s&&(s={});const n=!1!==s.includeFilename,i=s.type||t.type||"application/octet-stream",a=s.name||t.name;let l=t;l.stream&&"function"!=typeof l.stream&&(r.a.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=l.stream);let d=s.rawResponse;void 0===d&&(e.XMLHttpRequest?d=!1:(r.a.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let h=s.onlyContentUri;d||void 0!==h||(e.XMLHttpRequest?(r.a.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),h=!0):h=!1);const u={loaded:0,total:0};let m,p=null;if(d||(p=function(e){let t=JSON.parse(e);if(h&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=o.l(),r=new e.XMLHttpRequest;u.xhr=r;const d=f(t,s.callback,this.opts.onlyData),h=function(){r.abort(),d(new Error("Timeout"))};r.timeout_timer=c.b(h,3e4),r.onreadystatechange=function(){let t;switch(r.readyState){case e.XMLHttpRequest.DONE:c.a(r.timeout_timer);try{if(0===r.status)throw new E;if(!r.responseText)throw new Error("No response body.");t=r.responseText,p&&(t=p(t))}catch(e){return e.http_status=r.status,void d(e)}d(void 0,r,t)}},r.upload.addEventListener("progress",(function(e){c.a(r.timeout_timer),u.loaded=e.loaded,u.total=e.total,r.timeout_timer=c.b(h,3e4),s.progressHandler&&s.progressHandler({loaded:e.loaded,total:e.total})}));let g=this.opts.baseUrl+"/_matrix/media/r0/upload";const v=[];n&&a&&v.push("filename="+encodeURIComponent(a)),this.useAuthorizationHeader||v.push("access_token="+encodeURIComponent(this.opts.accessToken)),v.length>0&&(g+="?"+v.join("&")),r.open("POST",g),this.useAuthorizationHeader&&r.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),r.setRequestHeader("Content-Type",i),r.send(l),m=t.promise,m.abort=r.abort.bind(r)}else{const e={};n&&a&&(e.filename=a),m=this.authedRequest(s.callback,"POST","/upload",e,l,{prefix:"/_matrix/media/r0",headers:{"Content-Type":i},json:!1,bodyParser:p})}const g=this,v=m.finally((function(){for(let e=0;e<g.uploads.length;++e)if(g.uploads[e]===u)return void g.uploads.splice(e,1)}));return v.abort=m.abort,u.promise=v,this.uploads.push(u),v},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,s,n,i,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");const r=this.opts.idBaseUrl+i+s;if(void 0!==e&&!o.u(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:r,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=n:"object"==typeof n&&(c.json=n),a&&(c.headers.Authorization="Bearer "+a);const l=o.l();return this.opts.request(c,f(l,e,this.opts.onlyData)),l.promise},authedRequest:function(e,t,s,n,i,a){n||(n={}),this.useAuthorizationHeader?(isFinite(a)&&(a={localTimeoutMs:a}),a||(a={}),a.headers||(a.headers={}),a.headers.Authorization||(a.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);const o=this.request(e,t,s,n,i,a),r=this;return o.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?r.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&r.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),o},request:function(e,t,s,n,i,a){const o=void 0!==(a=a||{}).prefix?a.prefix:this.opts.prefix,r=this.opts.baseUrl+o+s;return this.requestOtherUrl(e,t,r,n,i,a)},requestOtherUrl:function(e,t,s,n,i,a){return null==a?a={}:isFinite(a)&&(a={localTimeoutMs:a}),this._request(e,t,s,n,i,a)},getUrl:function(e,t,s){let n="";return t&&(n="?"+o.m(t)),this.opts.baseUrl+s+e+n},_request:function(e,t,s,n,i,a){if(void 0!==e&&!o.u(e))throw Error("Expected callback to be a function but got "+typeof e);a=a||{};const r=this;this.opts.extraParams&&(n=d(d({},n),this.opts.extraParams));const l=o.q({},a.headers||{}),h=void 0===a.json||a.json;let u=a.bodyParser;h&&(i&&(i=JSON.stringify(i),l["content-type"]="application/json"),l.accept||(l.accept="application/json"),void 0===u&&(u=function(e){return JSON.parse(e)}));const m=o.l();let p,g,v=!1;const y=a.localTimeoutMs||this.opts.localTimeoutMs,E=()=>{y&&(p&&c.a(p),p=c.b((function(){v=!0,g&&g.abort&&g.abort(),m.reject(new b({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:y}))}),y))};E();const S=m.promise;try{g=this.opts.request({uri:s,method:t,withCredentials:!1,qs:n,qsStringifyOptions:a.qsStringifyOptions,useQuerystring:!0,body:i,json:!1,timeout:y,headers:l||{},_matrix_opts:this.opts},(function(t,s,n){if(y&&(c.a(p),v))return;f(m,e,r.opts.onlyData,u)(t,s,n)})),g&&("onprogress"in g&&(g.onprogress=e=>{E()}),g.abort&&(S.abort=g.abort.bind(g)))}catch(t){m.reject(t),e&&e(t)}return S}};const f=function(e,t,s,n){return t=t||function(){},function(i,o,r){if(i){"AbortError"===i.name||"aborted"===i||i instanceof b||(i=new y("request failed",i))}if(!i)try{(o.status||o.statusCode)>=400?i=function(e,t){const s=e.status||e.statusCode,n=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return Object(a.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let i;if(n)if("application/json"===n.type){const e="object"==typeof t?t:JSON.parse(t);i=new b(e)}else"text/plain"===n.type&&(i=new Error(`Server returned ${s} error: ${t}`));i||(i=new Error(`Server returned ${s} error`));return i.httpStatus=s,i}(o,r):n&&(r=n(r))}catch(e){i=new Error("Error parsing server response: "+e)}if(i)e.reject(i),t(i);else{const n={code:o.status||o.statusCode,headers:o.headers,data:r};e.resolve(s?r:n),t(null,s?r:n)}}};class b extends Error{constructor(e){super("MatrixError: "+(e=e||{}).errcode),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}class y extends Error{constructor(e,t){super(e+(t?": "+t.message:"")),this._cause=t}get name(){return"ConnectionError"}get cause(){return this._cause}}class E extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}async function S(e,t){let s=0,n=null;for(;s<e;)try{if(s>0){const e=1e3*Math.pow(2,s);r.a.log(`network operation failed ${s} times, retrying in ${e}ms...`),await new Promise(t=>setTimeout(t,e))}return await t()}catch(e){if(!(e instanceof y))throw e;s+=1,n=e}throw n}}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"h",(function(){return a})),s.d(t,"e",(function(){return o})),s.d(t,"g",(function(){return r})),s.d(t,"f",(function(){return c})),s.d(t,"d",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"b",(function(){return h}));var n=s(117);function i(e,t){return function(s){return function(e,t,s){const i=Object.assign({},{code:e,reason:t},s);return new n.b({type:"m.key.verification.cancel",content:i})}(e,t,s)}}const a=i("m.user","Cancelled by user"),o=i("m.timeout","Timed out"),r=(i("m.unknown_transaction","Unknown transaction"),i("m.unknown_method","Unknown method")),c=i("m.unexpected_message","Unexpected message"),l=i("m.key_mismatch","Key mismatch"),d=(i("m.user_error","User mismatch"),i("m.invalid_message","Invalid message"));function h(e){const t=e.getContent();if(t){const{code:e,reason:s}=t;return{code:e,reason:s}}return{code:"Unknown error",reason:"m.unknown"}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(111);const d=["isExpanded","children","onClick","onContextMenu"],h=e=>{let{isExpanded:t,children:s,onClick:n,onContextMenu:a}=e,r=o()(e,d);return c.a.createElement(l.a,i()({},r,{onClick:n,onContextMenu:a||n,"aria-haspopup":!0,"aria-expanded":t,forceHide:t}),s)}},,,function(e,t,s){"use strict";(function(e){s.d(t,"h",(function(){return K})),s.d(t,"b",(function(){return W})),s.d(t,"a",(function(){return G})),s.d(t,"d",(function(){return H})),s.d(t,"c",(function(){return q})),s.d(t,"k",(function(){return J})),s.d(t,"l",(function(){return Y})),s.d(t,"e",(function(){return Q})),s.d(t,"i",(function(){return se})),s.d(t,"m",(function(){return ne})),s.d(t,"g",(function(){return ie})),s.d(t,"f",(function(){return ae})),s.d(t,"j",(function(){return re})),s.d(t,"n",(function(){return le}));var n=s(156),i=s(224),a=s(252),o=s(86),r=s(230),c=s(247),l=s(659),d=s(140),h=s(254),u=s(543),m=s(1563),p=s(87),g=s(130),v=s(90),f=s(310),b=s(121),y=s(327),E=s(391),S=s(89),_=s(814),w=s(146),C=s(201),O=s(480),k=s(1658),R=s(493),I=s(279),x=s(825),T=s(124),j=s(380),N=s(151),P=s(1621),D=s(104),M=s(84),A=s(974),U=s(975),L=s(976),F=s(977),B=s(1),V=s(525);async function K(e={}){try{let t=e.enableGuest||!1;const s=e.guestHsUrl,i=e.guestIsUrl,a=e.fragmentQueryParams||{},o=e.defaultDeviceDisplayName;if(t&&!s&&(B.a.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&a.guest_user_id&&a.guest_access_token)return B.a.log("Using guest access credentials"),X({userId:a.guest_user_id,accessToken:a.guest_access_token,homeserverUrl:s,identityServerUrl:i,guest:!0},!0).then(()=>!0);return!!await J({ignoreGuest:Boolean(e.ignoreGuest)})||!!t&&function(e,t,s){B.a.log("Doing guest login on "+e);return Object(n.createClient)({baseUrl:e}).registerGuest({body:{initial_device_display_name:s}}).then(s=>(B.a.log("Registered as guest: "+s.user_id),X({userId:s.user_id,deviceId:s.device_id,accessToken:s.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then(()=>!0)),e=>(B.a.error("Failed to register as guest",e),!1))}(s,i,o)}catch(e){return!(e instanceof Z)&&async function(e){B.a.error("Unable to load session",e);const t=v.a.createTrackedDialog("Session Restore Error","",L.a,{error:e}),[s]=await t.finished;if(s)return await ce(),!1;return K()}(e)}}async function W(){const{hsUrl:e,userId:t,hasAccessToken:s,isGuest:n}=await q();return e&&t&&s?[t,n]:[null,null]}function G(e,t,s){if(!e.loginToken)return Promise.resolve(!1);const i=localStorage.getItem(I.a),a=localStorage.getItem(I.c);return i?Object(y.c)(i,a,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((function(e){return B.a.log("Logged in with token"),ce().then(async()=>(await ee(e),sessionStorage.setItem("mx_fresh_login",String(!0)),!0))})).catch(e=>(v.a.createTrackedDialog("SSO","Token Rejected",D.a,{title:Object(M.a)("We couldn't log you in"),description:"ConnectionError"===e.name?Object(M.a)("Your homeserver was unreachable and was not able to log you in. Please try again. If this continues, please contact your homeserver administrator."):Object(M.a)("Your homeserver rejected your log in attempt. This could be due to things just taking too long. Please try again. If this continues, please contact your homeserver administrator."),button:Object(M.a)("Try again"),onFinished:e=>{if(e){const e=Object(n.createClient)({baseUrl:i,idBaseUrl:a}),t=localStorage.getItem(I.b)||void 0;b.a.get().startSingleSignOn(e,"sso",s,t)}}}),B.a.error("Failed to log in with login token:"),B.a.error(e),!1)):(B.a.warn("Cannot log in with token: can't determine HS URL to use"),v.a.createTrackedDialog("SSO","Unknown HS",D.a,{title:Object(M.a)("We couldn't log you in"),description:Object(M.a)("We asked the browser to remember which homeserver you use to let you sign in, but unfortunately your browser has forgotten it. Go to the sign in page and try again."),button:Object(M.a)("Try again")}),Promise.resolve(!1))}function H(e){if(e.reason===i.b.TOGGLED_LAZY_LOADING)return Promise.resolve().then(()=>{const t=e.value;return new Promise(t?e=>{v.a.createDialog(A.a,{onFinished:e})}:e=>{v.a.createDialog(U.a,{onFinished:e,host:window.location.host})})}).then(()=>o.a.get().store.deleteAllData()).then(()=>{b.a.get().reload()})}async function q(){const e=localStorage.getItem("mx_hs_url"),t=localStorage.getItem("mx_is_url");let s;try{s=await E.c("account","mx_access_token")}catch(e){B.a.error("StorageManager.idbLoad failed for account:mx_access_token",e)}if(!s&&(s=localStorage.getItem("mx_access_token"),s))try{await E.d("account","mx_access_token",s),localStorage.removeItem("mx_access_token")}catch(e){B.a.error("migration of access token to IndexedDB failed",e)}const n="true"===localStorage.getItem("mx_has_access_token")||!!s,i=localStorage.getItem("mx_user_id"),a=localStorage.getItem("mx_device_id");let o;return o=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:e,isUrl:t,hasAccessToken:n,accessToken:s,userId:i,deviceId:a,isGuest:o}}async function $(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);const s=await window.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await window.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},s,256))}async function z(){if(await new Promise(e=>{v.a.createTrackedDialog("Storage evicted","",F.a,{onFinished:e})}))throw await ce(),new Z("Aborting login in progress because of storage inconsistency")}async function J(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:s,isUrl:n,hasAccessToken:i,accessToken:o,userId:r,deviceId:c,isGuest:l}=await q();if(i&&!o&&z(),o&&r&&s){if(t&&l)return B.a.log("Ignoring stored guest account: "+r),!1;let e=o;const i=await b.a.get().getPickleKey(r,c);if(i){if(B.a.log("Got pickle key"),"string"!=typeof o){const t=await $(i);e=await Object(a.b)(o,t,"access_token"),t.fill(0)}}else B.a.log("No pickle key available");const d="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),B.a.log("Restoring session for "+r),await X({userId:r,deviceId:c,accessToken:e,homeserverUrl:s,identityServerUrl:n,guest:l,pickleKey:i,freshLogin:d},!1),!0}return B.a.log("No previous session found."),!1}async function Y(e){e.freshLogin=!0,le();const t=e.userId&&e.deviceId?await b.a.get().createPickleKey(e.userId,e.deviceId):null;return t?B.a.log("Created pickle key"):B.a.log("Pickle key not created"),X(Object.assign({},e,{pickleKey:t}),!0)}function Q(e){const t=o.a.get().getUserId(),s=o.a.get().getDeviceId();le(),localStorage.removeItem("mx_soft_logout"),te=!1;const n=e.userId!==t||e.deviceId!==s;return n&&B.a.warn("Clearing all data: Old session belongs to a different user/session"),X(e,n)}async function X(e,t){e.guest=Boolean(e.guest);const s=ie();B.a.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+s," freshLogin: "+e.freshLogin),p.a.dispatch({action:"on_logging_in"},!0),t&&await ce();const n=await E.a();n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore&&await z(),d.a.setLoggedIn(e.guest,e.homeserverUrl),o.a.replaceUsingCreds(e),j.a.instance.updateAnonymityFromSettings(e.userId),Object(V.c)(e.userId);const i=o.a.get();if(e.freshLogin&&S.b.getValue("feature_dehydration")){const t=await i.rehydrateDevice();t&&(e.deviceId=t),delete e.freshLogin}if(localStorage)try{await ee(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){B.a.warn("Error using local storage: can't persist session!",e)}else B.a.warn("No local storage available: can't persist session!");return p.a.dispatch({action:"on_logged_in"}),await oe(!s),i}class Z extends Error{}async function ee(e){var t;if(localStorage.setItem("mx_hs_url",e.homeserverUrl),e.identityServerUrl&&localStorage.setItem("mx_is_url",e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),e.accessToken?localStorage.setItem("mx_has_access_token","true"):localStorage.deleteItem("mx_has_access_token"),e.pickleKey){let t;try{const s=await $(e.pickleKey);t=await Object(a.c)(e.accessToken,s,"access_token"),s.fill(0)}catch(e){B.a.warn("Could not encrypt access token",e)}try{await E.d("account","mx_access_token",t||e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.setItem("mx_has_pickle_key",String(!0))}else{try{await E.d("account","mx_access_token",e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.getItem("mx_has_pickle_key")&&B.a.error("Expected a pickle key, but none provided.  Encryption may not work.")}e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=r.a.persistCredentials)||void 0===t||t.call(r.a,e),B.a.log("Session persisted for "+e.userId)}let te=!1;function se(){if(!o.a.get())return;if(T.a.instance.disabled||T.a.instance.enable(!0),j.a.instance.logout(),o.a.get().isGuest())return void e(()=>re());te=!0;const t=o.a.get();b.a.get().destroyPickleKey(t.getUserId(),t.getDeviceId()),t.logout().then(re,e=>{B.a.log("Failed to call logout API: token will not be invalidated"),re()})}function ne(){o.a.get()&&(localStorage.setItem("mx_soft_logout","true"),B.a.log("Soft logout initiated"),te=!0,p.a.dispatch({action:"on_client_not_viable"}),le(!1))}function ie(){return"true"===localStorage.getItem("mx_soft_logout")}function ae(){return te}async function oe(e=!0){B.a.log("Lifecycle: Starting MatrixClient"),p.a.dispatch({action:"will_start_client"},!0),_.a.sharedInstance().reset(),w.a.sharedInstance().reset(),h.default.start(),u.a.sharedInstance().start(),g.a.makeShared().start(),C.a.sharedInstance().startWatching(),f.b.instance.start(),N.d.sharedInstance().start(),O.a.sharedInstance().start(),e?(await c.a.init(),await o.a.start()):(B.a.warn("Caller requested only auxiliary services be started"),await o.a.assign()),k.a.sharedInstance().start(),S.b.getValue("lowBandwidth")||m.a.start(),await R.a.getInstance().start(),p.a.dispatch({action:"client_started"}),ie()&&ne()}async function re(){var e;te=!1,p.a.dispatch({action:"on_logged_out"},!0),le(),await ce({deleteEverything:!0}),null===(e=P.a.onLoggedOutAndStorageCleared)||void 0===e||e.call(P.a)}async function ce(e){if(d.a.disable(),window.localStorage){const t=x.a.instance.getWireInvites();window.localStorage.clear();try{await E.b("account","mx_access_token")}catch(e){B.a.error("idbDelete failed for account:mx_access_token",e)}null!=e&&e.deleteEverything||t.forEach(e=>{const t=e.roomId;delete e.roomId,x.a.instance.storeInvite(t,e)})}window.sessionStorage&&window.sessionStorage.clear();const t=Object(l.a)({baseUrl:""});await c.a.deleteEventIndex(),await t.clearStores()}function le(e=!0){h.default.stop(),N.d.sharedInstance().stop(),u.a.sharedInstance().stop(),_.a.sharedInstance().reset(),m.a.stop(),f.b.instance.stop(),C.a.sharedInstance().stopWatching(),O.a.sharedInstance().stop(),k.a.sharedInstance().stop(),g.a.shared()&&g.a.shared().stop(),c.a.stop();const t=o.a.get();t&&(t.stopClient(),t.removeAllListeners(),e&&(o.a.unset(),c.a.unset()))}}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return c}));const n=/^\S+@\S+\.\S+$/,i=/^@\S+:\S+$/,a=/^!\S+:\S+$/;let o;!function(e){e.Email="email",e.MatrixUserId="mx-user-id",e.MatrixRoomId="mx-room-id"}(o||(o={}));const r=[o.Email,o.MatrixRoomId,o.MatrixUserId];function c(e){return n.test(e)?o.Email:i.test(e)?o.MatrixUserId:a.test(e)?o.MatrixRoomId:null}},function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(205),i=s(93),a=s(86),o=s(1);function r(){return i.a.get().validated_server_config.isUrl}function c(){const e=r();a.a.get().setAccountData("m.identity_server",{base_url:e})}async function l(e){let t;try{t=await a.a.get().getTerms(n.a.IS,e)}catch(e){if(o.a.error(e),"rejected"!==e.cors&&404!==e.httpStatus)throw e;t=null}return t&&t.policies&&Object.keys(t.policies).length>0}function d(){const e=a.a.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url}},function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"c",(function(){return u}));var n=s(91),i=s.n(n),a=s(86),o=s(107),r=s(90),c=s(1);class l extends Error{}class d{constructor(e,t,s){this.serviceType=e,this.baseUrl=t,this.accessToken=s}}async function h(e,t=u){const s=e.map(e=>a.a.get().getTerms(e.serviceType,e.baseUrl)),n=(await Promise.all(s)).map((t,s)=>({service:e[s],policies:t.policies})),i=await a.a.get().getAccountData("m.accepted_terms");let o;o=i&&i.getContent()&&i.getContent().accepted?new Set(i.getContent().accepted):new Set;const r=[];for(const{service:e,policies:t}of n){const s={};for(const[e,n]of Object.entries(t)){let t=!1;for(const e of Object.keys(n))if("version"!==e&&o.has(n[e].url)){t=!0;break}t||(s[e]=n)}Object.keys(s).length>0&&r.push({service:e,policies:s})}const l=o.size;if(r.length>0){const e=await t(r,[...o]);c.a.log("User has agreed to URLs",e),e.forEach(e=>o.add(e))}else c.a.log("User has already agreed to all required policies");if(o.size!==l){const e={accepted:Array.from(o)};await a.a.get().setAccountData("m.accepted_terms",e)}const d=n.map(e=>{const t=Array.from(o).filter(t=>{for(const s of Object.values(e.policies))for(const e of Object.keys(s))if("version"!==e&&s[e].url===t)return!0;return!1});return 0===t.length?Promise.resolve():a.a.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)});return Promise.all(d)}async function u(e,t,s){c.a.log("Terms that need agreement",e);const n=o.getComponent("views.dialogs.TermsDialog"),{finished:a}=r.a.createTrackedDialog("Terms of Service","",n,{policiesAndServicePairs:e,agreedUrls:t},i()("mx_TermsDialog",s)),[d,h]=await a;if(!d)throw new l;return h}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}));const n="filter_changed";let i;!function(e){e[e.Prefilter=0]="Prefilter",e[e.Runtime=1]="Runtime"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(127),c=s(94),l=s(84),d=s(97),h=s(88),u=s(300),m=s(369),p=s(131),g=s(120),v=s(259),f=s(96),b=s(103),y=s(106),E=s(90),S=s(166),_=s(87),w=s(92),C=s(158),O=s(456),k=s(159),R=s(301),I=s(1);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function T(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const j="io.element.migrated_from_community";var N;!function(e){e[e.NotStarted=0]="NotStarted",e[e.ValidatingInputs=1]="ValidatingInputs",e[e.FetchingData=2]="FetchingData",e[e.CreatingSpace=3]="CreatingSpace",e[e.InvitingUsers=4]="InvitingUsers"}(N||(N={}));t.b=({matrixClient:e,groupId:t,onFinished:n})=>{const[i,x]=Object(a.useState)(!0),[P,D]=Object(a.useState)(null),[M,A]=Object(a.useState)(N.NotStarted),[U,L]=Object(a.useState)(0),F=M>0,[B,V]=Object(a.useState)(null),[K,W]=Object(a.useState)(""),G=Object(a.useRef)(),[H,q]=Object(a.useState)("#"+t.substring(1,t.indexOf(":"))+":"+e.getDomain()),$=Object(a.useRef)(),[z,J]=Object(a.useState)(""),[Y,Q]=Object(a.useState)(r.c.Public),X=Object(v.a)(()=>e.getGroupSummary(t),[t]);if(Object(a.useEffect)(()=>{X&&(W(X.profile.name||""),J(X.profile.short_description||""),Q(X.profile.is_openly_joinable?r.c.Public:r.c.Invite),x(!1))},[X]),i)return o.a.createElement(f.a,null);const Z=async s=>{if(s.preventDefault(),!F){if(D(null),A(N.ValidatingInputs),!await G.current.validate({allowEmpty:!1}))return A(0),G.current.focus(),void G.current.validate({allowEmpty:!1,focused:!0});if(Y===r.c.Public&&!await $.current.validate({allowEmpty:!0}))return A(0),$.current.focus(),void $.current.validate({allowEmpty:!0,focused:!0});try{A(N.FetchingData);const[a,d,m]=await Promise.all([e.getGroupRooms(t).then(p.c),e.getGroupUsers(t).then(p.b),e.getGroupInvitedUsers(t).then(p.b)]);L(d.length+m.length);const v=new Map;for(const{roomId:t,canonicalAlias:n}of a){var i;const a=e.getRoom(t);if(a)v.set(t,Object(g.b)(a));else if(n)try{const{servers:s}=await e.getRoomIdForAlias(n);v.set(t,s)}catch(s){I.a.warn("Failed to resolve alias during community migration",s)}if(null===(i=v.get(t))||void 0===i||!i.length){const e=n||t;v.set(t,[e.substring(1,e.indexOf(":"))])}}A(N.CreatingSpace);const f=void 0!==B?B:X.profile.avatar_url,b=await Object(u.c)(K,Y===r.c.Public,H,z,f,{creation_content:{[j]:t},initial_state:a.map(({roomId:e})=>({type:c.a.SpaceChild,state_key:e,content:{via:v.get(e)||[]}}))},{andView:!1});A(N.InvitingUsers);const R=[...d,...m].map(e=>e.userId).filter(t=>t!==e.getUserId());await Object(k.b)(b,R,()=>A(e=>e+1)),_.a.dispatch(O.a.removeTag(e,t)),e.setGroupProfile(t,T(T({},X.profile),{},{long_description:`<a href="${Object(g.g)(b)}"><h1>`+Object(l.a)("This community has been upgraded into a Space")+"</h1></a><br />"+X.profile.long_description})).catch(e=>{I.a.warn("Failed to update community profile during migration",e)}),n(b);const x=()=>{_.a.dispatch({action:"view_room",room_id:b})},P=()=>{_.a.dispatch({action:w.a.ViewUserSettings,initialTabId:C.a.Preferences})};let D;y.a.spacesEnabled||(D=Object(l.a)("To view Spaces, hide communities in <a>Preferences</a>",{},{a:e=>o.a.createElement(h.a,{onClick:P,kind:"link"},e)})),E.a.createDialog(S.a,{title:Object(l.a)("Space created"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_SuccessInfoDialog_checkmark"}),o.a.createElement("p",null,Object(l.a)("<SpaceName/> has been made and everyone who was a part of the community has been invited to it.",{},{SpaceName:()=>o.a.createElement(h.a,{onClick:x,kind:"link"},K)})," ",D),o.a.createElement("p",null,Object(l.a)("To create a Space from another community, just pick the community in Preferences."))),button:Object(l.a)("Preferences"),onFinished:e=>{e&&P()}},"mx_CreateSpaceFromCommunityDialog_SuccessInfoDialog")}catch(s){I.a.error(s),D(s)}A(N.NotStarted)}};let ee;if(P)ee=o.a.createElement(o.a.Fragment,null,o.a.createElement("img",{src:s(458),height:"24",width:"24",alt:""}),o.a.createElement("span",{className:"mx_CreateSpaceFromCommunityDialog_error"},o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_errorHeading"},Object(l.a)("Failed to migrate community")),o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_errorCaption"},Object(l.a)("Try again"))),o.a.createElement(h.a,{className:"mx_CreateSpaceFromCommunityDialog_retryButton",onClick:Z},Object(l.a)("Retry")));else if(F){let e;switch(M){case N.ValidatingInputs:case N.FetchingData:e=Object(l.a)("Fetching data...");break;case N.CreatingSpace:e=Object(l.a)("Creating Space...");break;case N.InvitingUsers:default:e=Object(l.a)("Adding rooms... (%(progress)s out of %(count)s)",{count:U,progress:M})}ee=o.a.createElement("span",null,o.a.createElement(R.a,{value:M>N.FetchingData?M:0,max:U+N.InvitingUsers}),o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_progressText"},e))}else ee=o.a.createElement(o.a.Fragment,null,o.a.createElement(h.a,{kind:"primary_outline",onClick:()=>n()},Object(l.a)("Cancel")),o.a.createElement(h.a,{kind:"primary",onClick:Z},Object(l.a)("Create Space")));return o.a.createElement(d.a,{title:Object(l.a)("Create Space from community"),className:"mx_CreateSpaceFromCommunityDialog",onFinished:n,fixedWidth:!1},o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_content"},o.a.createElement("p",null,Object(l.a)("A link to the Space will be put in your community description.")," ",Object(l.a)("All rooms will be added and all community members will be invited.")),o.a.createElement("p",{className:"mx_CreateSpaceFromCommunityDialog_flairNotice"},Object(l.a)("Flair won't be available in Spaces for the foreseeable future.")),o.a.createElement(u.a,{busy:F,onSubmit:Z,avatarUrl:X.profile.avatar_url?Object(b.b)(X.profile.avatar_url).getThumbnailOfSourceHttp(80,80,"crop"):void 0,setAvatar:V,name:K,setName:W,nameFieldRef:G,topic:z,setTopic:J,alias:H,setAlias:q,showAliasField:Y===r.c.Public,aliasFieldRef:$},o.a.createElement("p",null,Object(l.a)("This description will be shown to people when they view your space")),o.a.createElement(m.a,{label:Object(l.a)("Space visibility"),labelInvite:Object(l.a)("Private space (invite only)"),labelPublic:Object(l.a)("Public space"),value:Y,onChange:Q}),o.a.createElement("p",null,Y===r.c.Public?Object(l.a)("Open space for anyone, best for communities"):Object(l.a)("Invite only, best for yourself or teams")),Y!==r.c.Public&&o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_nonPublicSpacer"}))),o.a.createElement("div",{className:"mx_CreateSpaceFromCommunityDialog_footer"},ee))}},function(e,t,s){"use strict";s.d(t,"c",(function(){return N})),s.d(t,"b",(function(){return U})),s.d(t,"a",(function(){return L}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(94),d=s(127),h=s(84),u=s(111),m=s(105),p=s(141),g=s(98),v=s(451),f=s(88),b=s(101),y=s(160),E=s(368),S=s(93),_=s(90),w=s(452),C=s(89),O=s(87),k=s(92),R=s(158),I=s(108),x=s(1);function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function j(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const N=async(e,t,s,n,i,a={},o={})=>Object(p.b)(j({createOpts:j({name:e,preset:t?d.d.PublicChat:d.d.PrivateChat,power_level_content_override:{events_default:100,invite:t?0:50},room_alias_name:t&&s?s.substr(1,s.indexOf(":")-1):void 0,topic:n},a),avatar:i,roomType:l.e.Space,historyVisibility:t?d.b.WorldReadable:d.b.Invited,spinner:!1,encryption:!1,andView:!0,inlineErrors:!0},o)),P=({title:e,description:t,className:s,onClick:n})=>o.a.createElement(f.a,{className:c()("mx_SpaceCreateMenuType",s),onClick:n},o.a.createElement("h3",null,e),o.a.createElement("span",null,t));var D;!function(e){e[e.Public=0]="Public",e[e.Private=1]="Private"}(D||(D={}));const M=Object(y.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(h.a)("Please enter a name for the space")}]}),A=e=>e.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9_-]+/gi,""),U=({onClick:e})=>S.a.get().bug_report_endpoint_url?o.a.createElement("div",{className:"mx_SpaceFeedbackPrompt"},o.a.createElement("span",{className:"mx_SpaceFeedbackPrompt_text"},Object(h.a)("Spaces are a new feature.")),o.a.createElement(f.a,{kind:"link",onClick:()=>{e&&e(),_.a.createTrackedDialog("Spaces Feedback","",w.a,{title:Object(h.a)("Spaces feedback"),subheading:Object(h.a)("Thank you for trying Spaces. Your feedback will help inform the next versions."),rageshakeLabel:"spaces-feedback",rageshakeData:Object.fromEntries(["Spaces.allRoomsInHome","Spaces.enabledMetaSpaces"].map(e=>[e,C.b.getValue(e)]))})}},Object(h.a)("Give feedback."))):null,L=({busy:e,onSubmit:t,avatarUrl:s,setAvatar:n,name:i,setName:r,nameFieldRef:c,alias:l,aliasFieldRef:d,setAlias:u,showAliasField:m,topic:p,setTopic:f,children:y})=>{const S=Object(a.useContext)(g.a).getDomain(),_=e=>{e.key===I.a.ENTER&&t(e)};return o.a.createElement("form",{className:"mx_SpaceBasicSettings",onSubmit:t},o.a.createElement(v.a,{avatarUrl:s,setAvatar:n,avatarDisabled:e}),o.a.createElement(b.a,{name:"spaceName",label:Object(h.a)("Name"),autoFocus:!0,value:i,onChange:e=>{const t=e.target.value;var s;l&&l!==`#${A(i)}:${S}`||(u(`#${A(t)}:${S}`),null===(s=d.current)||void 0===s||s.validate({allowEmpty:!0}));r(t)},onKeyDown:_,ref:c,onValidate:M,disabled:e,autoComplete:"off"}),m?o.a.createElement(E.a,{ref:d,onChange:u,domain:S,value:l,placeholder:i?A(i):Object(h.a)("e.g. my-space"),label:Object(h.a)("Address"),disabled:e,onKeyDown:_}):null,o.a.createElement(b.a,{name:"spaceTopic",element:"textarea",label:Object(h.a)("Description"),value:p,onChange:e=>f(e.target.value),rows:3,disabled:e}),y)};t.d=({onFinished:e})=>{const[t,s]=Object(a.useState)(null),[n,i]=Object(a.useState)(!1),[r,c]=Object(a.useState)(""),l=Object(a.useRef)(),[d,p]=Object(a.useState)(""),g=Object(a.useRef)(),[v,b]=Object(a.useState)(null),[y,E]=Object(a.useState)(""),S=async s=>{if(s.preventDefault(),!n){if(i(!0),!await l.current.validate({allowEmpty:!1}))return l.current.focus(),l.current.validate({allowEmpty:!1,focused:!0}),void i(!1);if(t===D.Public&&!await g.current.validate({allowEmpty:!1}))return g.current.focus(),g.current.validate({allowEmpty:!1,focused:!0}),void i(!1);try{await N(r,t===D.Public,d,y,v),e()}catch(s){x.a.error(s)}}};let _;if(null===t){const t=()=>{O.a.dispatch({action:k.a.ViewUserSettings,initialTabId:R.a.Preferences}),e()};_=o.a.createElement(o.a.Fragment,null,o.a.createElement("h2",null,Object(h.a)("Create a space")),o.a.createElement("p",null,Object(h.a)("Spaces are a new way to group rooms and people.")," ",Object(h.a)("What kind of Space do you want to create?")," ",Object(h.a)("You can change this later.")),o.a.createElement(P,{title:Object(h.a)("Public"),description:Object(h.a)("Open space for anyone, best for communities"),className:"mx_SpaceCreateMenuType_public",onClick:()=>s(D.Public)}),o.a.createElement(P,{title:Object(h.a)("Private"),description:Object(h.a)("Invite only, best for yourself or teams"),className:"mx_SpaceCreateMenuType_private",onClick:()=>s(D.Private)}),o.a.createElement("p",null,Object(h.a)("You can also make Spaces from <a>communities</a>.",{},{a:e=>o.a.createElement(f.a,{kind:"link",onClick:t},e)}),o.a.createElement("br",null),Object(h.a)("To join a space you'll need an invite.")),o.a.createElement(U,{onClick:e}))}else _=o.a.createElement(o.a.Fragment,null,o.a.createElement(u.a,{className:"mx_SpaceCreateMenu_back",onClick:()=>s(null),title:Object(h.a)("Go back")}),o.a.createElement("h2",null,t===D.Public?Object(h.a)("Your public space"):Object(h.a)("Your private space")),o.a.createElement("p",null,Object(h.a)("Add some details to help people recognise it.")," ",Object(h.a)("You can change these anytime.")),o.a.createElement(L,{busy:n,onSubmit:S,setAvatar:b,name:r,setName:c,nameFieldRef:l,topic:y,setTopic:E,alias:d,setAlias:p,showAliasField:t===D.Public,aliasFieldRef:g}),o.a.createElement(f.a,{kind:"primary",onClick:S,disabled:n},n?Object(h.a)("Creating..."):Object(h.a)("Create")));return o.a.createElement(m.n,{left:72,top:62,chevronOffset:0,chevronFace:m.a.None,onFinished:e,wrapperClassName:"mx_SpaceCreateMenu_wrapper",managed:!1},_)}},function(e,t,s){"use strict";var n=s(82),i=s.n(n);t.a=({value:e,max:t})=>i.a.createElement("progress",{className:"mx_ProgressBar",max:t,value:e})},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(89);function i(e,t){const s=t?e=>t[e]:t=>n.b.getValue(t,e.getRoomId());if(e.isRedacted()&&!s("showRedactions"))return!0;if(e.isRelation("m.replace"))return!0;const i=function(e){const t={isMemberEvent:"m.room.member"===e.getType()};if(!t.isMemberEvent)return t;const s=e.getContent(),n=e.getPrevContent(),i=s.membership!==n.membership;t.isJoin=i&&"join"===s.membership,t.isPart=i&&"leave"===s.membership&&e.getStateKey()===e.getSender();const a=!i&&"join"===s.membership;return t.isDisplaynameChange=a&&s.displayname!==n.displayname,t.isAvatarChange=a&&s.avatar_url!==n.avatar_url,t}(e);if(i.isMemberEvent){if((i.isJoin||i.isPart)&&!s("showJoinLeaves"))return!0;if(i.isAvatarChange&&!s("showAvatarChanges"))return!0;if(i.isDisplaynameChange&&!s("showDisplaynameChanges"))return!0}return!1}},,,function(e,t,s){"use strict";s.d(t,"c",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return p}));var n=s(83),i=s.n(n),a=s(1244),o=s(1245);function r(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?r(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const l=new Map,d=new Map,h=e=>l.get(g(e)),u=["people","people","control","nature","foods","places","activity","objects","symbols","flags"],m={people:[],nature:[],foods:[],places:[],activity:[],objects:[],symbols:[],flags:[]},p=a.map(e=>{var t,s;const n=null!==(t=o[e.hexcode])&&void 0!==t?t:[e.annotation.toLowerCase().replace(/\W+/g,"_")],i=c(c({},e),{},{shortcodes:"string"==typeof n?[n]:n}),a=null!==(s=u[i.group])&&void 0!==s?s:(r=i.unicode,1===Array.from(r).length&&r>="🇦"&&r<="🇿"?"symbols":null);var r;return m.hasOwnProperty(a)&&m[a].push(i),l.set(g(i.unicode),i),i.emoticon&&d.set(i.emoticon,i),i});function g(e){return e.replace(/[\uFE00-\uFE0F]$/,"")}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r}));var n=s(82),i=s.n(n),a=s(84);function o(e,t,s,n){let o=s[e];void 0===o&&(o=s[""]);const r=e=>t?i.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e):e;return o.includes("<a>")?Object(a.a)(o,{},Object.assign({a:r},n)):Object(a.a)(o,{},n)}function r(e){if("M_RESOURCE_LIMIT_EXCEEDED"===e.errcode){const t=o(e.data.limit_type,e.data.admin_contact,{monthly_active_user:Object(a.b)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(a.b)("This homeserver has been blocked by its administrator."),"":Object(a.b)("This homeserver has exceeded one of its resource limits.")}),s=o(e.data.limit_type,e.data.admin_contact,{"":Object(a.b)("Please <a>contact your service administrator</a> to continue using the service.")});return i.a.createElement("div",null,i.a.createElement("div",null,t),i.a.createElement("div",null,s))}return i.a.createElement("div",null,Object(a.a)("Unable to connect to Homeserver. Retrying..."))}},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(5),o=s.n(a);class r extends o.a{constructor(){super(),i()(this,"roomWidgetEcho",void 0),this.roomWidgetEcho={}}getEchoedRoomWidgets(e,t){const s=[],n=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){const t=e.getStateKey();n[t]&&0===Object.keys(n[t]).length||s.push(e),delete n[t]}return s}roomHasPendingWidgetsOfType(e,t,s){const n=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){delete n[e.getStateKey()]}return void 0===s?Object.keys(n).length>0:Object.values(n).some(e=>s.matches(e.type))}roomHasPendingWidgets(e,t){return this.roomHasPendingWidgetsOfType(e,t)}setRoomWidgetEcho(e,t,s){void 0===this.roomWidgetEcho[e]&&(this.roomWidgetEcho[e]={}),this.roomWidgetEcho[e][t]=s,this.emit("update",e,t)}removeRoomWidgetEcho(e,t){delete this.roomWidgetEcho[e][t],0===Object.keys(this.roomWidgetEcho[e]).length&&delete this.roomWidgetEcho[e],this.emit("update",e,t)}}let c=null;c||(c=new r),t.a=c},function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return l})),s.d(t,"a",(function(){return d})),s.d(t,"e",(function(){return h})),s.d(t,"d",(function(){return p})),s.d(t,"f",(function(){return g}));var n=s(84),i=s(89),a=s(265),o=s(143);const r={light:"light-high-contrast"};function c(e){return r[e]}function l(e){for(const t in r)if(r[t]===e)return t}function d(){const e={light:"SC "+Object(n.a)("Light"),"light-high-contrast":Object(n.a)("Light high contrast"),dark:"SC "+Object(n.a)("Dark")},t=i.b.getValue("custom_themes"),s={};for(const{name:e}of t)s["custom-"+e]=e;return Object.assign({},s,e)}function h(){const e=Object.entries(d()).map(e=>({id:e[0],name:e[1]})).filter(e=>{return t=e.id,!Object.values(r).includes(t);var t}),t=e.filter(e=>!e.id.startsWith("custom-")),s=e.filter(e=>!t.includes(e)).sort((e,t)=>Object(o.a)(e.name,t.name));return[...t,...s]}const u=["font-display","font-family","font-stretch","font-style","font-weight","font-variant","font-feature-settings","font-variation-settings","src","unicode-range"];function m(e){const{style:t}=document.body;function s(e,s,n=!0){t.setProperty("--"+e,s),n&&(t.setProperty(`--${e}-0pct`,s+"00"),t.setProperty(`--${e}-15pct`,s+"26"),t.setProperty(`--${e}-50pct`,s+"7F"))}if(e.colors)for(const[t,n]of Object.entries(e.colors))if(Array.isArray(n))for(let e=0;e<n.length;e+=1)s(`${t}_${e}`,n[e],!1);else s(t,n);if(e.fonts){const{fonts:s}=e;if(s.faces){const e=s.faces.map(e=>{const t=e.src&&e.src.map(e=>{let t;return e.format&&(t=`format("${e.format}")`),e.url?`url("${e.url}") ${t}`:e.local?`local("${e.local}") ${t}`:""}).join(", ");return`@font-face {${Object.keys(e).filter(e=>u.includes(e)).map(s=>{let n;return n="src"===s?t:"font-family"===s?`"${e[s]}"`:e[s],`${s}: ${n}`}).join(";")}}`}).join("\n"),t=document.createElement("style");t.setAttribute("title","custom-theme-font-faces"),t.setAttribute("type","text/css"),t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}s.general&&t.setProperty("--font-family",s.general),s.monospace&&t.setProperty("--font-family-monospace",s.monospace)}}function p(e){const t=i.b.getValue("custom_themes");if(!t)throw new Error(`No custom themes set, can't set custom theme "${e}"`);const s=t.find(t=>t.name===e);if(!s){const s=t.map(e=>e.name).join(", ");throw new Error(`Can't find custom theme "${e}", only know ${s}`)}return s}async function g(t){if(!t){t=(new a.a).getEffectiveTheme()}!function(){const e=Object.values(document.body.style);for(const t of e)t.startsWith("--")&&document.body.style.removeProperty(t);const t=document.querySelector("head > style[title='custom-theme-font-faces']");t&&t.remove()}();let s=t;if(t.startsWith("custom-")){const e=p(t.substr(7));s=e.is_dark?"dark-custom":"light-custom",m(e)}const n=Object.create(null);if(Array.from(document.querySelectorAll("[data-mx-theme]")).forEach(e=>{n[e.attributes["data-mx-theme"].value.toLowerCase()]=e}),!(s in n))throw new Error("Unknown theme "+s);return n[s].disabled=!1,new Promise(t=>{const i=function(){n[s].disabled=!1,Object.values(n).forEach(e=>{e!=n[s]&&(e.disabled=!0)});const i=e.getComputedStyle(document.body);if(i.backgroundColor){document.querySelector('meta[name="theme-color"]').content=i.backgroundColor}t()};let a=!1;n[s].onload=()=>{i()};for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];if(t&&t.href===n[s].href){a=!0;break}}a&&(n[s].onload=void 0,i())})}}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a),r=s(86),c=s(267);let l;!function(e){e.Update="update"}(l||(l={}));class d extends o.a{constructor(...e){super(...e),i()(this,"persistentWidgetId",void 0),i()(this,"roomIdByWidgetId",new Map),i()(this,"onRoomStateEvents",e=>{"im.vector.modular.widgets"===e.getType()&&e.getStateKey()===this.persistentWidgetId&&this.destroyPersistentWidget(this.persistentWidgetId)})}static get instance(){return d.internalInstance||(d.internalInstance=new d),d.internalInstance}start(){r.a.get().on("RoomState.events",this.onRoomStateEvents)}stop(){r.a.get()&&r.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this.roomIdByWidgetId.clear()}destroyPersistentWidget(e){if(e!==this.persistentWidgetId)return;const t=this.persistentWidgetId;c.a.instance.stopMessagingById(e),this.setWidgetPersistence(t,!1),this.delRoomId(t)}setWidgetPersistence(e,t){this.persistentWidgetId!==e||t?this.persistentWidgetId!==e&&t&&(this.persistentWidgetId=e):this.persistentWidgetId=null,this.emit(l.Update)}getWidgetPersistence(e){return this.persistentWidgetId===e}getPersistentWidgetId(){return this.persistentWidgetId}getRoomId(e){return this.roomIdByWidgetId.get(e)}setRoomId(e,t){this.roomIdByWidgetId.set(e,t),this.emit(l.Update)}delRoomId(e){this.roomIdByWidgetId.delete(e),this.emit(l.Update)}}i()(d,"internalInstance",void 0),window.mxActiveWidgetStore=d.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(85);let u=Object(h.a)("views.elements.TruncatedList")((a=i=class extends l.a.Component{getChildren(e,t){return this.props.getChildren&&this.props.getChildCount?this.props.getChildren(e,t):l.a.Children.toArray(this.props.children).filter(e=>null!=e).slice(e,t)}getChildCount(){return this.props.getChildren&&this.props.getChildCount?this.props.getChildCount():l.a.Children.toArray(this.props.children).filter(e=>null!=e).length}render(){let e=null;const t=this.getChildCount();let s=t;if(this.props.truncateAt>=0){const n=t-this.props.truncateAt;n>1&&(e=this.props.createOverflowElement(n,t),s=this.props.truncateAt)}const n=this.getChildren(0,s);return l.a.createElement("div",{className:this.props.className},n,e)}},r()(i,"defaultProps",{truncateAt:2,createOverflowElement:(e,t)=>l.a.createElement("div",null,Object(d.a)("And %(count)s more...",{count:e}))}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b})),s.d(t,"b",(function(){return S}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(88),h=s(84),u=s(91),m=s.n(u),p=s(215),g=s(85),v=s(125),f=s(494);let b;!function(e){e.Admin="admin",e.Moderator="moderator"}(b||(b={}));const y={[b.Admin]:Object(h.b)("Admin"),[b.Moderator]:Object(h.b)("Mod")},E={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable"};let S=Object(g.a)("views.rooms.EntityTile")((a=i=class extends l.a.PureComponent{constructor(e){super(e),this.state={hover:!1}}render(){const e={mx_EntityTile:!0,mx_EntityTile_noHover:this.props.suppressOnHover};this.props.className&&(e[this.props.className]=!0);var t,n;let i;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?E.offline+"_beenactive":E.offline+"_neveractive":t?E[t]:E.offline+"_neveractive")]=!0;const{name:a}=this.props;if(this.props.suppressOnHover)i=this.props.subtextLabel?l.a.createElement("div",{className:"mx_EntityTile_details"},l.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},a),l.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)):l.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},a);else{const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;let t=null;this.props.showPresence&&(t=l.a.createElement(f.a,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})),this.props.subtextLabel&&(t=l.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)),i=l.a.createElement("div",{className:"mx_EntityTile_details"},l.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},a),t)}let o,r;this.props.showInviteButton&&(o=l.a.createElement("div",{className:"mx_EntityTile_invite"},l.a.createElement("img",{src:s(1285),width:"16",height:"16"})));const c=this.props.powerStatus;if(c){const e=y[c];r=l.a.createElement("div",{className:"mx_EntityTile_power"},e)}let h;const{e2eStatus:u}=this.props;u&&(h=l.a.createElement(p.b,{status:u,isUser:!0,bordered:!0}));const g=this.props.avatarJsx||l.a.createElement(v.a,{name:this.props.name,width:36,height:36,"aria-hidden":"true"});return l.a.createElement("div",null,l.a.createElement(d.a,{className:m()(e),title:this.props.title,onClick:this.props.onClick},l.a.createElement("div",{className:"mx_EntityTile_avatar"},g,h),i,r,o))}},r()(i,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,suppressOnHover:!1,showPresence:!0}),n=a))||n},function(e,t){e.exports="img/ellipsis.d1e5a57.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n,i=s(82),a=s.n(i),o=s(85);let r=Object(o.a)("views.context_menus.GenericTextContextMenu")(n=class extends a.a.Component{render(){return a.a.createElement("div",null,this.props.message)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return h})),s.d(t,"a",(function(){return u})),s.d(t,"c",(function(){return m}));var n=s(83),i=s.n(n),a=s(89),o=s(100),r=s(5),c=s.n(r),l=s(86),d=s(1);let h,u;!function(e){e.AudioOutput="audiooutput",e.AudioInput="audioinput",e.VideoInput="videoinput"}(h||(h={})),function(e){e.AudioOutputChanged="audio_output_changed"}(u||(u={}));class m extends c.a{static get instance(){return m.internalInstance||(m.internalInstance=new m),m.internalInstance}static async hasAnyLabeledDevices(){return(await navigator.mediaDevices.enumerateDevices()).some(e=>Boolean(e.label))}static async getDevices(){try{const e=await navigator.mediaDevices.enumerateDevices(),t={[h.AudioOutput]:[],[h.AudioInput]:[],[h.VideoInput]:[]};return e.forEach(e=>t[e.kind].push(e)),t}catch(e){d.a.warn("Unable to refresh WebRTC Devices: ",e)}}static loadDevices(){const e=a.b.getValue("webrtc_audioinput"),t=a.b.getValue("webrtc_videoinput");l.a.get().getMediaHandler().setAudioInput(e),l.a.get().getMediaHandler().setVideoInput(t)}setAudioOutput(e){a.b.setValue("webrtc_audiooutput",null,o.a.DEVICE,e),this.emit(u.AudioOutputChanged,e)}setAudioInput(e){a.b.setValue("webrtc_audioinput",null,o.a.DEVICE,e),l.a.get().getMediaHandler().setAudioInput(e)}setVideoInput(e){a.b.setValue("webrtc_videoinput",null,o.a.DEVICE,e),l.a.get().getMediaHandler().setVideoInput(e)}setDevice(e,t){switch(t){case h.AudioOutput:this.setAudioOutput(e);break;case h.AudioInput:this.setAudioInput(e);break;case h.VideoInput:this.setVideoInput(e)}}static getAudioOutput(){return a.b.getValueAt(o.a.DEVICE,"webrtc_audiooutput")}static getAudioInput(){return a.b.getValueAt(o.a.DEVICE,"webrtc_audioinput")}static getVideoInput(){return a.b.getValueAt(o.a.DEVICE,"webrtc_videoinput")}}i()(m,"internalInstance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(82),a=s.n(i),o=s(136),r=s(85);let c=Object(r.a)("views.audio_messages.Clock")(n=class extends a.a.Component{constructor(e){super(e)}shouldComponentUpdate(e){return Math.floor(this.props.seconds)!==Math.floor(e.seconds)}render(){return a.a.createElement("span",{className:"mx_Clock"},Object(o.i)(this.props.seconds))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(83),i=s.n(n);class a{constructor(e,t){this.fn=e,this.onMarkCallback=t,i()(this,"marked",!1)}reset(){this.marked=!1}mark(){var e;this.marked||null===(e=this.onMarkCallback)||void 0===e||e.call(this),this.marked=!0}trigger(){this.marked&&(this.reset(),this.fn())}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r}));var n=s(122),i=s(92),a=s(87);const o=(e,t,s)=>{a.a.dispatch({action:i.a.SetRightPanelPhase,phase:n.c.ThreadView,refireParams:{event:e,initialEvent:t,highlighted:s}})},r=()=>{a.a.dispatch({action:i.a.SetRightPanelPhase,phase:n.c.ThreadPanel})}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(125),u=s(85),m=s(103);const p=["groupId","groupAvatarUrl","groupName"];var g,v,f;let b=Object(u.a)("views.avatars.GroupAvatar")((f=v=class extends d.a.Component{getGroupAvatarUrl(){return this.props.groupAvatarUrl?Object(m.b)(this.props.groupAvatarUrl).getThumbnailOfSourceHttp(this.props.width,this.props.height,this.props.resizeMethod):null}render(){const e=this.props,{groupId:t,groupAvatarUrl:s,groupName:n}=e,a=o()(e,p);return d.a.createElement(h.a,i()({name:n||this.props.groupId[1],idName:this.props.groupId,url:this.getGroupAvatarUrl()},a))}},c()(v,"defaultProps",{width:36,height:36,resizeMethod:"crop"}),g=f))||g},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82);const i=(e,t)=>{const s=Object(n.useRef)(e=>{});Object(n.useEffect)(()=>{s.current=t},[t]),Object(n.useEffect)(()=>{const t=e.register(e=>s.current(e));return()=>{e.unregister(t)}},[e])}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(88);const u=["checked","disabled","onChange"];t.a=e=>{let{checked:t,disabled:s=!1,onChange:n}=e,a=o()(e,u);const r=d()({mx_ToggleSwitch:!0,mx_ToggleSwitch_on:t,mx_ToggleSwitch_enabled:!s});return c.a.createElement(h.a,i()({},a,{className:r,onClick:()=>{s||n(!t)},role:"switch","aria-checked":t,"aria-disabled":s}),c.a.createElement("div",{className:"mx_ToggleSwitch_ball"}))}},,,function(e,t,s){"use strict";s.d(t,"b",(function(){return _})),s.d(t,"a",(function(){return w})),s.d(t,"c",(function(){return C}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(253),l=s(84),d=s(535),h=s(537),u=s(800),m=s(804),p=s(805),g=s(806),v=s(86),f=s(87),b=s(89),y=s(115),E=s(85),S=s(97);const _="ROOM_SECURITY_TAB",w="ROOM_NOTIFICATIONS_TAB";let C=Object(E.a)("views.dialogs.RoomSettingsDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"onAction",e=>{"view_home_page"===e.action&&this.props.onFinished(!0)}),a()(this,"onRoomName",()=>{this.setState({roomName:v.a.get().getRoom(this.props.roomId).name})}),this.state={roomName:""}}componentDidMount(){this.dispatcherRef=f.a.register(this.onAction),v.a.get().on("Room.name",this.onRoomName),this.onRoomName()}componentWillUnmount(){this.dispatcherRef&&f.a.unregister(this.dispatcherRef),v.a.get().removeListener("Room.name",this.onRoomName)}getTabs(){const e=[];return e.push(new c.a("ROOM_GENERAL_TAB",Object(l.b)("General"),"mx_RoomSettingsDialog_settingsIcon",r.a.createElement(u.a,{roomId:this.props.roomId}))),e.push(new c.a(_,Object(l.b)("Security & Privacy"),"mx_RoomSettingsDialog_securityIcon",r.a.createElement(m.a,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}))),e.push(new c.a("ROOM_ROLES_TAB",Object(l.b)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",r.a.createElement(h.a,{roomId:this.props.roomId}))),e.push(new c.a(w,Object(l.b)("Notifications"),"mx_RoomSettingsDialog_notificationsIcon",r.a.createElement(p.a,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}))),b.b.getValue("feature_bridge_state")&&e.push(new c.a("ROOM_BRIDGES_TAB",Object(l.b)("Bridges"),"mx_RoomSettingsDialog_bridgesIcon",r.a.createElement(g.a,{roomId:this.props.roomId}))),b.b.getValue(y.b.AdvancedSettings)&&e.push(new c.a("ROOM_ADVANCED_TAB",Object(l.b)("Advanced"),"mx_RoomSettingsDialog_warningIcon",r.a.createElement(d.a,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}))),e}render(){const e=this.state.roomName;return r.a.createElement(S.a,{className:"mx_RoomSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Room Settings - %(roomName)s",{roomName:e})},r.a.createElement("div",{className:"mx_SettingsDialog_content"},r.a.createElement(c.c,{tabs:this.getTabs(),initialTabId:this.props.initialTabId})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(84),c=s(88),l=s(89),d=s(100),h=s(177),u=s(90),m=s(809),p=s(93),g=s(172);const v=({onClick:e})=>e?i.a.createElement(h.a,{class:o()("mx_BetaCard_betaPill",{mx_BetaCard_betaPill_clickable:!!e}),tooltip:i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Tooltip_title"},Object(r.a)("Spaces is a beta feature")),i.a.createElement("div",{className:"mx_Tooltip_sub"},Object(r.a)("Tap for more info"))),onClick:e,tooltipProps:{yOffset:-10}},Object(r.a)("Beta")):i.a.createElement("span",{className:o()("mx_BetaCard_betaPill",{mx_BetaCard_betaPill_clickable:!!e}),onClick:e},Object(r.a)("Beta"));t.b=({title:e,featureId:t})=>{const s=l.b.getBetaInfo(t);if(!s)return null;const{title:n,caption:a,disclaimer:o,image:h,feedbackLabel:f,feedbackSubheading:b,extraSettings:y}=s,E=l.b.getValue(t);let S;return E&&f&&b&&p.a.get().bug_report_endpoint_url&&(S=i.a.createElement(c.a,{onClick:()=>{u.a.createTrackedDialog("Beta Feedback",t,m.a,{featureId:t})},kind:"primary"},Object(r.a)("Feedback"))),i.a.createElement("div",{className:"mx_BetaCard"},i.a.createElement("div",{className:"mx_BetaCard_columns"},i.a.createElement("div",null,i.a.createElement("h3",{className:"mx_BetaCard_title"},e||Object(r.a)(n),i.a.createElement(v,null)),i.a.createElement("span",{className:"mx_BetaCard_caption"},Object(r.a)(a)),i.a.createElement("div",{className:"mx_BetaCard_buttons"},S,i.a.createElement(c.a,{onClick:()=>l.b.setValue(t,null,d.a.DEVICE,!E),kind:S?"primary_outline":"primary"},E?Object(r.a)("Leave the beta"):Object(r.a)("Join the beta"))),o&&i.a.createElement("div",{className:"mx_BetaCard_disclaimer"},o(E))),i.a.createElement("img",{src:h,alt:""})),y&&E&&i.a.createElement("div",{className:"mx_BetaCard_relatedSettings"},y.map(e=>i.a.createElement(g.a,{key:e,name:e,level:d.a.DEVICE}))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return d}));var n=s(83),i=s.n(n),a=s(156),o=s(230),r=s(1);let c;!function(e){e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter"}(c||(c={}));class l{constructor(e,t,s,n){i()(this,"hsUrl",void 0),i()(this,"isUrl",void 0),i()(this,"fallbackHsUrl",void 0),i()(this,"flows",void 0),i()(this,"defaultDeviceDisplayName",void 0),i()(this,"tempClient",void 0),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=s,this.flows=[],this.defaultDeviceDisplayName=n.defaultDeviceDisplayName,this.tempClient=null}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}createTemporaryClient(){return this.tempClient?this.tempClient:this.tempClient=Object(a.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})}async getFlows(){const e=this.createTemporaryClient(),{flows:t}=await e.loginFlows();return this.flows=t,this.flows}loginViaPassword(e,t,s,n){const i=e.indexOf("@")>0;let a;a=t&&s?{type:"m.id.phone",country:t,phone:s,number:s}:i?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const o={password:n,identifier:a,initial_device_display_name:this.defaultDeviceDisplayName},c=e=>d(this.fallbackHsUrl,this.isUrl,"m.login.password",o).catch(t=>{throw r.a.log("fallback HS login failed",t),e});let l=null;return d(this.hsUrl,this.isUrl,"m.login.password",o).catch(e=>{if(l=e,403===e.httpStatus&&this.fallbackHsUrl)return c(l);throw l}).catch(e=>{throw r.a.log("Login failed",e),e})}}async function d(e,t,s,n){var i;const c=Object(a.createClient)({baseUrl:e,idBaseUrl:t}),l=await c.login(s,n),d=l.well_known;d&&(d["m.homeserver"]&&d["m.homeserver"].base_url&&(e=d["m.homeserver"].base_url,r.a.log(`Overrode homeserver setting with ${e} from login response`)),d["m.identity_server"]&&d["m.identity_server"].base_url&&(t=d["m.identity_server"].base_url,r.a.log(`Overrode IS setting with ${t} from login response`)));const h={homeserverUrl:e,identityServerUrl:t,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token};return null===(i=o.a.examineLoginResponse)||void 0===i||i.call(o.a,l,h),h}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(274),h=s(128),u=s(85),m=s(195),p=s(1);let g;g=function(){};let v=Object(u.a)("structures.ScrollPanel")((a=i=class extends l.a.Component{constructor(e,t){super(e,t),r()(this,"pendingFillRequests",{b:null,f:null}),r()(this,"itemlist",Object(c.createRef)()),r()(this,"unmounted",!1),r()(this,"scrollTimeout",void 0),r()(this,"isFilling",void 0),r()(this,"isFillingDueToPropsUpdate",!1),r()(this,"fillRequestWhileRunning",void 0),r()(this,"pendingFillDueToPropsUpdate",void 0),r()(this,"scrollState",void 0),r()(this,"preventShrinkingState",void 0),r()(this,"unfillDebouncer",void 0),r()(this,"bottomGrowth",void 0),r()(this,"pages",void 0),r()(this,"heightUpdateInProgress",void 0),r()(this,"divScroll",void 0),r()(this,"onScroll",e=>{this.props.resizeNotifier&&this.props.resizeNotifier.isResizing||(g("onScroll",this.getScrollNode().scrollTop),this.scrollTimeout.restart(),this.saveScrollState(),this.updatePreventShrinking(),this.props.onScroll(e),this.checkFillState())}),r()(this,"onResize",()=>{g("onResize"),this.checkScroll(),this.preventShrinkingState&&this.preventShrinking()}),r()(this,"checkScroll",(e=!1)=>{this.unmounted||(this.restoreSavedScrollState(),this.checkFillState(0,e))}),r()(this,"isAtBottom",()=>{const e=this.getScrollNode();return e.scrollHeight-(e.scrollTop+e.clientHeight)<=1}),r()(this,"checkFillState",async(e=0,t=!1)=>{if(this.unmounted)return;const s=0===e,n=this.getScrollNode();if(s){if(this.isFilling&&!this.isFillingDueToPropsUpdate)return g("isFilling: not entering while request is ongoing, marking for a subsequent request"),this.fillRequestWhileRunning=!0,void(this.pendingFillDueToPropsUpdate=t);g("isFilling: setting"),this.isFilling=!0,this.isFillingDueToPropsUpdate=t}const i=this.itemlist.current,a=i&&i.firstElementChild,o=a&&a.offsetTop,r=[];if((!a||n.scrollTop-o<n.clientHeight)&&r.push(this.maybeFill(e,!0)),n.scrollHeight-n.scrollTop<2*n.clientHeight&&r.push(this.maybeFill(e,!1)),r.length)try{await Promise.all(r)}catch(e){p.a.error(e)}if(s&&(g("isFilling: clearing"),this.isFilling=!1,this.isFillingDueToPropsUpdate=!1),this.fillRequestWhileRunning){const e=this.pendingFillDueToPropsUpdate;this.fillRequestWhileRunning=!1,this.pendingFillDueToPropsUpdate=!1,this.checkFillState(0,e)}}),r()(this,"getScrollState",()=>this.scrollState),r()(this,"resetScrollState",()=>{this.scrollState={stuckAtBottom:this.props.startAtBottom},this.bottomGrowth=0,this.pages=0,this.scrollTimeout=new d.a(100),this.heightUpdateInProgress=!1}),r()(this,"scrollToTop",()=>{this.getScrollNode().scrollTop=0,this.saveScrollState()}),r()(this,"scrollToBottom",()=>{const e=this.getScrollNode();e.scrollTop=e.scrollHeight,this.saveScrollState()}),r()(this,"scrollRelative",e=>{const t=this.getScrollNode(),s=e*t.clientHeight*.9;t.scrollBy(0,s),this.saveScrollState()}),r()(this,"handleScrollKey",e=>{let t=!1;switch(Object(m.f)().getRoomAction(e)){case m.d.ScrollUp:this.scrollRelative(-1),t=!0;break;case m.d.RoomScrollDown:this.scrollRelative(1),t=!0;break;case m.d.JumpToFirstMessage:this.scrollToTop(),t=!0;break;case m.d.JumpToLatestMessage:this.scrollToBottom(),t=!0}t&&this.props.onUserScroll&&this.props.onUserScroll(e)}),r()(this,"scrollToToken",(e,t,s)=>{t=t||0,s=s||0,this.scrollState={stuckAtBottom:!1,trackedScrollToken:e};const n=this.getTrackedNode(),i=this.getScrollNode();n&&(g("scrollToken: setting scrollTop",{offsetBase:s,pixelOffset:t,offsetTop:n.offsetTop}),i.scrollTop=n.offsetTop-i.clientHeight*s+t,this.saveScrollState())}),r()(this,"collectScroll",e=>{this.divScroll=e}),r()(this,"preventShrinking",()=>{const e=this.itemlist.current,t=e&&e.children;if(!e)return;let s;for(let e=t.length-1;e>=0;e--){const n=t[e];if(n.dataset.scrollTokens){s=n;break}}if(!s)return;this.clearPreventShrinking();const n=e.clientHeight-(s.offsetTop+s.clientHeight);this.preventShrinkingState={offsetFromBottom:n,offsetNode:s},g("prevent shrinking, last tile ",n,"px from bottom")}),r()(this,"clearPreventShrinking",()=>{const e=this.itemlist.current,t=e&&e.parentElement;t&&(t.style.paddingBottom=null),this.preventShrinkingState=null,g("prevent shrinking cleared")}),r()(this,"updatePreventShrinking",()=>{if(this.preventShrinkingState){const e=this.getScrollNode(),t=this.scrollState,s=this.itemlist.current,{offsetNode:n,offsetFromBottom:i}=this.preventShrinkingState,a=s.parentElement;let o=!n.parentElement;if(!o&&!t.stuckAtBottom){o=e.scrollHeight-(e.scrollTop+e.clientHeight)>=200}if(!o){const e=i-(s.clientHeight-(n.offsetTop+n.clientHeight));e>0?(a.style.paddingBottom=e+"px",g("update prevent shrinking ",e,"px from bottom")):e<0&&(o=!0)}o&&this.clearPreventShrinking()}}),this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResizedNoisy",this.onResize),this.resetScrollState()}componentDidMount(){this.checkScroll()}componentDidUpdate(){this.checkScroll(!0),this.updatePreventShrinking()}componentWillUnmount(){this.unmounted=!0,this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResizedNoisy",this.onResize)}getExcessHeight(e){const t=this.getScrollNode(),s=this.getMessagesHeight(),n=s-this.getListHeight(),i=t.scrollTop+n;return e?i-t.clientHeight-6e3:s-(i+2*t.clientHeight)-6e3}checkUnfillState(e){let t=this.getExcessHeight(e);if(t<=0)return;const s=t,n=this.itemlist.current.children;let i,a=null;for(let s=0;s<n.length&&(i=n[e?s:n.length-1-s],t-=i.clientHeight,!(i.clientHeight>t));s++)i.dataset.scrollTokens&&(a=i.dataset.scrollTokens.split(",")[0]);a&&(this.unfillDebouncer&&clearTimeout(this.unfillDebouncer),this.unfillDebouncer=setTimeout(()=>{this.unfillDebouncer=null,g("unfilling now",e,s),this.props.onUnfillRequest(e,a)},200))}maybeFill(e,t){const s=t?"b":"f";if(!this.pendingFillRequests[s])return g("starting "+s+" fill"),this.pendingFillRequests[s]=!0,new Promise(e=>setTimeout(e,1)).then(()=>this.props.onFillRequest(t)).finally(()=>{this.pendingFillRequests[s]=!1}).then(n=>{if(!this.unmounted)return this.checkUnfillState(!t),g(s+" fill complete; hasMoreResults:"+n),n?this.checkFillState(e+1):void 0});g("Already a "+s+" fill in progress - not starting another")}saveScrollState(){if(this.props.stickyBottom&&this.isAtBottom())return this.scrollState={stuckAtBottom:!0},void g("saved stuckAtBottom state");const e=this.getScrollNode(),t=e.scrollHeight-(e.scrollTop+e.clientHeight),s=this.itemlist.current.children;let n=null;for(let e=s.length-1;e>=0&&!(s[e].dataset.scrollTokens&&(n=s[e],this.topFromBottom(n)>t));--e);if(!n)return void g("unable to save scroll state: found no children in the viewport");const i=n.dataset.scrollTokens.split(",")[0];g("saving anchored scroll state to message",n&&n.innerText,i);const a=this.topFromBottom(n);this.scrollState={stuckAtBottom:!1,trackedNode:n,trackedScrollToken:i,bottomOffset:a,pixelOffset:a-t}}async restoreSavedScrollState(){const e=this.scrollState;if(e.stuckAtBottom){const e=this.getScrollNode();e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight)}else if(e.trackedScrollToken){const t=this.itemlist.current,s=this.getTrackedNode();if(s){const n=this.topFromBottom(s),i=n-e.bottomOffset;this.bottomGrowth+=i,e.bottomOffset=n;const a=this.getListHeight()+"px";t.style.height!==a&&(t.style.height=a),g("balancing height because messages below viewport grew by",i)}}if(this.heightUpdateInProgress)g("not updating height because request already in progress");else{this.heightUpdateInProgress=!0;try{await this.updateHeight()}finally{this.heightUpdateInProgress=!1}}}async updateHeight(){if(this.scrollTimeout.isRunning()?(g("updateHeight waiting for scrolling to end ... "),await this.scrollTimeout.finished()):g("updateHeight getting straight to business, no scrolling going on."),this.unmounted)return;const e=this.getScrollNode(),t=this.itemlist.current,s=this.getMessagesHeight(),n=e.clientHeight,i=Math.max(n,s);this.pages=Math.ceil(i/400);const a=s>n;e.dataset.scrollbar=a.toString(),this.bottomGrowth=0;const o=this.getListHeight()+"px",r=this.scrollState;if(r.stuckAtBottom)t.style.height!==o&&(t.style.height=o),e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight),g("updateHeight to",o);else if(r.trackedScrollToken){const s=this.getTrackedNode();if(s){const n=s.offsetTop;t.style.height!==o&&(t.style.height=o);const i=s.offsetTop-n;e.scrollBy(0,i),g("updateHeight to",{newHeight:o,topDiff:i})}}}getTrackedNode(){const e=this.scrollState,t=e.trackedNode;if(!t||!t.parentElement){let t;const s=this.itemlist.current.children,n=e.trackedScrollToken;for(let e=s.length-1;e>=0;--e){const i=s[e];if(i.dataset.scrollTokens&&-1!==i.dataset.scrollTokens.split(",").indexOf(n)){t=i;break}}t&&g("had to find tracked node again for "+e.trackedScrollToken),e.trackedNode=t}if(e.trackedNode)return e.trackedNode;g("No node with ; '"+e.trackedScrollToken+"'")}getListHeight(){return this.bottomGrowth+400*this.pages}getMessagesHeight(){const e=this.itemlist.current,t=e.lastElementChild;return(t?t.offsetTop+t.clientHeight:0)-(e.firstElementChild?e.firstElementChild.offsetTop:0)+36}topFromBottom(e){return this.itemlist.current.clientHeight-e.offsetTop}getScrollNode(){if(this.unmounted)throw new Error("ScrollPanel.getScrollNode called when unmounted");if(!this.divScroll)throw new Error("ScrollPanel.getScrollNode called before AutoHideScrollbar ref collected");return this.divScroll}render(){return l.a.createElement(h.a,{wrappedRef:this.collectScroll,onScroll:this.onScroll,onWheel:this.props.onUserScroll,className:"mx_ScrollPanel "+this.props.className,style:this.props.style},this.props.fixedChildren,l.a.createElement("div",{className:"mx_RoomView_messageListWrapper"},l.a.createElement("ol",{ref:this.itemlist,className:"mx_RoomView_MessageList","aria-live":"polite",role:"list"},this.props.children)))}},r()(i,"defaultProps",{stickyBottom:!0,startAtBottom:!0,onFillRequest:function(e){return Promise.resolve(!1)},onUnfillRequest:function(e,t){},onScroll:function(){}}),n=a))||n},function(e,t,s){"use strict";s.r(t),s.d(t,"containsEmoji",(function(){return n}));const n=(e,t)=>t.some(t=>e.body&&e.body.includes(t))},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(319),l=s(85);let d=Object(l.a)("structures.MainSplit")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),a()(this,"onResize",()=>{this.props.resizeNotifier.notifyRightHandleResized()}),a()(this,"onResizeStop",(e,t,s,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem("mx_rhs_size",(this.loadSidePanelSize().width+n.width).toString())})}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem("mx_rhs_size"),10);return isNaN(e)&&(e=350),{height:"100%",width:e}}render(){const e=r.a.Children.only(this.props.children),t=this.props.panel;let s;return!this.props.collapsedRhs&&t&&(s=r.a.createElement(c.Resizable,{defaultSize:this.loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle_horizontal"}},t)),r.a.createElement("div",{className:"mx_MainSplit"},e,s)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return U}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(87),h=s(131),u=s(122),m=s(244),p=s(98),g=s(92),v=s(400),f=s(895),b=s(85),y=s(89),E=s(896),S=s(898),_=s(899),w=s(900),C=s(901),O=s(903),k=s(650),R=s(904),I=s(928),x=s(929),T=s(417),j=s(112),N=s(106),P=s(318),D=s(930);function M(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function A(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?M(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):M(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let U=Object(b.a)("structures.RightPanel")((a=i=class extends l.a.Component{constructor(e,t){super(e,t),r()(this,"dispatcherRef",void 0),r()(this,"delayedUpdate",Object(j.throttle)(()=>{this.forceUpdate()},500,{leading:!0,trailing:!0})),r()(this,"onGroupStoreUpdated",()=>{this.setState({isUserPrivilegedInGroup:h.a.isUserPrivileged(this.props.groupId)})}),r()(this,"onRoomStateMember",(e,t,s)=>{this.props.room&&s.roomId===this.props.room.roomId&&(this.state.phase===u.c.RoomMemberList&&s.roomId===this.props.room.roomId||this.state.phase===u.c.RoomMemberInfo&&s.roomId===this.props.room.roomId&&s.userId===this.state.member.userId)&&this.delayedUpdate()}),r()(this,"onAction",e=>{const t=e.action===g.a.ViewRoom&&e.room_id!==this.props.room.roomId,s=this.state.phase===u.c.ThreadView;t&&s&&Object(P.b)(),e.action===g.a.AfterRightPanelPhaseChange&&this.setState({phase:e.phase,groupRoomId:e.groupRoomId,groupId:e.groupId,member:e.member,event:e.event,initialEvent:e.initialEvent,initialEventHighlighted:e.highlighted,verificationRequest:e.verificationRequest,verificationRequestPromise:e.verificationRequestPromise,widgetId:e.widgetId,space:e.space})}),r()(this,"onClose",()=>{this.props.member?d.a.dispatch({action:"view_home_page"}):this.state.phase===u.c.EncryptionPanel&&this.state.verificationRequest&&this.state.verificationRequest.pending?this.state.verificationRequest.cancel():d.a.dispatch({action:g.a.ToggleRightPanel,type:this.props.groupId?"group":"room"})}),r()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e})}),this.state=A(A({},m.a.getSharedInstance().roomPanelPhaseParams),{},{phase:this.getPhaseFromProps(),isUserPrivilegedInGroup:null,member:this.getUserForPanel(),searchQuery:""})}getUserForPanel(){if(this.state&&this.state.member)return this.state.member;const e=m.a.getSharedInstance().roomPanelPhaseParams;return this.props.member||e.member}getPhaseFromProps(){var e;const t=m.a.getSharedInstance(),s=this.getUserForPanel();return this.props.groupId?u.a.includes(t.groupPanelPhase)?t.groupPanelPhase:(d.a.dispatch({action:g.a.SetRightPanelPhase,phase:u.c.GroupMemberList}),u.c.GroupMemberList):N.a.spacesEnabled&&null!==(e=this.props.room)&&void 0!==e&&e.isSpaceRoom()&&!u.b.includes(t.roomPanelPhase)?u.c.SpaceMemberList:s?t.roomPanelPhaseParams.member&&s.userId===t.roomPanelPhaseParams.member.userId&&t.roomPanelPhaseParams.verificationRequest?t.roomPanelPhase:u.c.RoomMemberInfo:t.roomPanelPhase}componentDidMount(){this.dispatcherRef=d.a.register(this.onAction);this.context.on("RoomState.members",this.onRoomStateMember),this.initGroupStore(this.props.groupId)}componentWillUnmount(){d.a.unregister(this.dispatcherRef),this.context&&this.context.removeListener("RoomState.members",this.onRoomStateMember),this.unregisterGroupStore()}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this.unregisterGroupStore(),this.initGroupStore(e.groupId))}initGroupStore(e){e&&h.a.registerListener(e,this.onGroupStoreUpdated)}unregisterGroupStore(){h.a.unregisterListener(this.onGroupStoreUpdated)}render(){var e;let t=l.a.createElement("div",null);const s=this.props.room?this.props.room.roomId:void 0;switch(this.state.phase){case u.c.RoomMemberList:s&&(t=l.a.createElement(E.a,{roomId:s,key:s,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged}));break;case u.c.SpaceMemberList:t=l.a.createElement(E.a,{roomId:this.state.space?this.state.space.roomId:s,key:this.state.space?this.state.space.roomId:s,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged});break;case u.c.GroupMemberList:this.props.groupId&&(t=l.a.createElement(S.a,{groupId:this.props.groupId,key:this.props.groupId}));break;case u.c.GroupRoomList:t=l.a.createElement(_.a,{groupId:this.props.groupId,key:this.props.groupId});break;case u.c.RoomMemberInfo:case u.c.SpaceMemberInfo:case u.c.EncryptionPanel:t=l.a.createElement(C.a,{user:this.state.member,room:null!==(e=this.context.getRoom(this.state.member.roomId))&&void 0!==e?e:this.props.room,key:s||this.state.member.userId,onClose:this.onClose,phase:this.state.phase,verificationRequest:this.state.verificationRequest,verificationRequestPromise:this.state.verificationRequestPromise});break;case u.c.Room3pidMemberInfo:case u.c.Space3pidMemberInfo:t=l.a.createElement(O.a,{event:this.state.event,key:s});break;case u.c.GroupMemberInfo:t=l.a.createElement(C.a,{user:this.state.member,groupId:this.props.groupId,key:this.state.member.userId,phase:this.state.phase,onClose:this.onClose});break;case u.c.GroupRoomInfo:t=l.a.createElement(w.a,{groupRoomId:this.state.groupRoomId,groupId:this.props.groupId,key:this.state.groupRoomId});break;case u.c.NotificationPanel:t=l.a.createElement(x.a,{onClose:this.onClose});break;case u.c.PinnedMessages:y.b.getValue("feature_pinning")&&(t=l.a.createElement(T.b,{room:this.props.room,onClose:this.onClose,userNameColorMode:this.props.userNameColorMode}));break;case u.c.Timeline:if(!y.b.getValue("feature_maximised_widgets"))break;t=l.a.createElement(D.a,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose});break;case u.c.FilePanel:t=l.a.createElement(k.a,{roomId:s,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,userNameColorMode:this.props.userNameColorMode});break;case u.c.ThreadView:t=l.a.createElement(R.a,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:this.state.event,initialEvent:this.state.initialEvent,initialEventHighlighted:this.state.initialEventHighlighted,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus});break;case u.c.ThreadPanel:t=l.a.createElement(I.a,{roomId:s,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator});break;case u.c.RoomSummary:t=l.a.createElement(v.a,{room:this.props.room,onClose:this.onClose});break;case u.c.Widget:t=l.a.createElement(f.a,{room:this.props.room,widgetId:this.state.widgetId,onClose:this.onClose})}return l.a.createElement("aside",{className:"mx_RightPanel dark-panel",id:"mx_RightPanel"},t)}},r()(i,"contextType",p.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(84),r=s(136),c=s(85);let l=Object(c.a)("views.messages.DateSeparator")(n=class extends a.a.Component{getLabel(){const e=new Date(this.props.ts);if(this.props.forExport)return Object(r.f)(e);const t=new Date,s=new Date,n=[Object(o.a)("Sunday"),Object(o.a)("Monday"),Object(o.a)("Tuesday"),Object(o.a)("Wednesday"),Object(o.a)("Thursday"),Object(o.a)("Friday"),Object(o.a)("Saturday")];return s.setDate(t.getDate()-1),e.toDateString()===t.toDateString()?Object(o.a)("Today"):e.toDateString()===s.toDateString()?Object(o.a)("Yesterday"):t.getTime()-e.getTime()<5184e5?n[e.getDay()]:Object(r.f)(e)}render(){return a.a.createElement("h2",{className:"mx_DateSeparator",role:"separator",tabIndex:-1,"aria-label":this.getLabel()},a.a.createElement("hr",{role:"none"}),a.a.createElement("div",{"aria-hidden":"true"},this.getLabel()),a.a.createElement("hr",{role:"none"}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return $})),s.d(t,"c",(function(){return X})),s.d(t,"b",(function(){return Z})),s.d(t,"e",(function(){return ee})),s.d(t,"d",(function(){return te}));var n=s(83),i=s.n(n),a=s(82),o=s(94),r=s(354),c=s(86),l=s(87),d=s(84),h=s(90),u=s(366),m=s(138),p=s(113),g=s(152),v=s(916),f=s(295),b=s(256),y=s(296),E=s(120),S=s(178),_=s(493),w=s(698),C=s(200),O=s(141),k=s(92),R=s(191),I=s(93),x=s(89),T=s(115),j=s(220),N=s(151),P=s(180),D=s(388),M=s(917),A=s(379),U=s(524),L=s(166),F=s(918),B=s(1),V=s(221),K=s(118),W=s(132);function G(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function H(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?G(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):G(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const q=async()=>new Promise(e=>{const t=document.createElement("input");t.setAttribute("type","file"),t.onchange=t=>{const s=t.target.files[0];h.a.createTrackedDialog("Upload Files confirmation","",M.a,{file:s,onFinished:t=>{e(t?c.a.get().uploadContent(s):null)}})},t.click()}),$={messages:Object(d.b)("Messages"),actions:Object(d.b)("Actions"),admin:Object(d.b)("Admin"),advanced:Object(d.b)("Advanced"),effects:Object(d.b)("Effects"),other:Object(d.b)("Other")};class z{constructor(e){i()(this,"command",void 0),i()(this,"aliases",void 0),i()(this,"args",void 0),i()(this,"description",void 0),i()(this,"runFn",void 0),i()(this,"category",void 0),i()(this,"hideCompletionAfterSpace",void 0),i()(this,"_isEnabled",void 0),i()(this,"renderingTypes",void 0),this.command=e.command,this.aliases=e.aliases||[],this.args=e.args||"",this.description=e.description,this.runFn=e.runFn,this.category=e.category||$.other,this.hideCompletionAfterSpace=e.hideCompletionAfterSpace||!1,this._isEnabled=e.isEnabled,this.renderingTypes=e.renderingTypes}getCommand(){return"/"+this.command}getCommandWithArgs(){return this.getCommand()+" "+this.args}run(e,t,s){var n;if(!this.runFn)return J(Object(d.a)("Command error"));const i=t?K.a.Thread:K.a.Room;return!this.renderingTypes||null!==(n=this.renderingTypes)&&void 0!==n&&n.includes(i)?this.runFn.bind(this)(e,s):J(Object(d.a)("Command error"))}getUsage(){return Object(d.a)("Usage")+": "+this.getCommandWithArgs()}isEnabled(){return!this._isEnabled||this._isEnabled()}}function J(e){return{error:e}}function Y(e){return{promise:e}}function Q(e){return Y(Promise.resolve(e))}const X=[new z({command:"spoiler",args:"<message>",description:Object(d.b)("Sends the given message as a spoiler"),runFn:function(e,t){return Q(r.makeHtmlMessage(t,`<span data-mx-spoiler>${t}</span>`))},category:$.messages}),new z({command:"shrug",args:"<message>",description:Object(d.b)("Prepends ¯\\_(ツ)_/¯ to a plain-text message"),runFn:function(e,t){let s="¯\\_(ツ)_/¯";return t&&(s=s+" "+t),Q(r.makeTextMessage(s))},category:$.messages}),new z({command:"tableflip",args:"<message>",description:Object(d.b)("Prepends (╯°□°）╯︵ ┻━┻ to a plain-text message"),runFn:function(e,t){let s="(╯°□°）╯︵ ┻━┻";return t&&(s=s+" "+t),Q(r.makeTextMessage(s))},category:$.messages}),new z({command:"unflip",args:"<message>",description:Object(d.b)("Prepends ┬──┬ ノ( ゜-゜ノ) to a plain-text message"),runFn:function(e,t){let s="┬──┬ ノ( ゜-゜ノ)";return t&&(s=s+" "+t),Q(r.makeTextMessage(s))},category:$.messages}),new z({command:"lenny",args:"<message>",description:Object(d.b)("Prepends ( ͡° ͜ʖ ͡°) to a plain-text message"),runFn:function(e,t){let s="( ͡° ͜ʖ ͡°)";return t&&(s=s+" "+t),Q(r.makeTextMessage(s))},category:$.messages}),new z({command:"plain",args:"<message>",description:Object(d.b)("Sends a message as plain text, without interpreting it as markdown"),runFn:function(e,t){return Q(r.makeTextMessage(t))},category:$.messages}),new z({command:"html",args:"<message>",description:Object(d.b)("Sends a message as html, without interpreting it as markdown"),runFn:function(e,t){return Q(r.makeHtmlMessage(t,t))},category:$.messages}),new z({command:"upgraderoom",args:"<new_version>",description:Object(d.b)("Upgrades a room to a new version"),runFn:function(e,t){if(t){const s=c.a.get(),n=s.getRoom(e);if(!n.currentState.mayClientSendStateEvent("m.room.tombstone",s))return J(Object(d.a)("You do not have the required permissions to use this command."));const{finished:i}=h.a.createTrackedDialog("Slash Commands","upgrade room confirmation",U.a,{roomId:e,targetVersion:t},null,!1,!0);return Y(i.then(async([e])=>{null!=e&&e.continue&&await Object(D.b)(n,t,e.invite)}))}return J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"nick",args:"<display_name>",description:Object(d.b)("Changes your display nickname"),runFn:function(e,t){return t?Y(c.a.get().setDisplayName(t)):J(this.getUsage())},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"myroomnick",aliases:["roomnick"],args:"<display_name>",description:Object(d.b)("Changes your display nickname in the current room only"),runFn:function(e,t){if(t){const s=c.a.get(),n=s.getRoom(e).currentState.getStateEvents("m.room.member",s.getUserId()),i=H(H({},n?n.getContent():{membership:"join"}),{},{displayname:t});return Y(s.sendStateEvent(e,"m.room.member",i,s.getUserId()))}return J(this.getUsage())},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"roomavatar",args:"[<mxc_url>]",description:Object(d.b)("Changes the avatar of the current room"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=q()),Y(s.then(t=>{if(t)return c.a.get().sendStateEvent(e,"m.room.avatar",{url:t},"")}))},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"myroomavatar",args:"[<mxc_url>]",description:Object(d.b)("Changes your avatar in this current room only"),runFn:function(e,t){const s=c.a.get(),n=s.getRoom(e),i=s.getUserId();let a=Promise.resolve(t);return t||(a=q()),Y(a.then(t=>{if(!t)return;const a=n.currentState.getStateEvents("m.room.member",i),o=H(H({},a?a.getContent():{membership:"join"}),{},{avatar_url:t});return s.sendStateEvent(e,"m.room.member",o,i)}))},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"myavatar",args:"[<mxc_url>]",description:Object(d.b)("Changes your avatar in all rooms"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=q()),Y(s.then(e=>{if(e)return c.a.get().setAvatarUrl(e)}))},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"topic",args:"[<topic>]",description:Object(d.b)("Gets or sets the room topic"),runFn:function(e,t){const s=c.a.get();if(t)return Y(s.setRoomTopic(e,t));const n=s.getRoom(e);if(!n)return J(Object(d.a)("Failed to set topic"));const i=n.currentState.getStateEvents("m.room.topic",""),o=i&&i.getContent().topic,r=o?Object(m.f)(o):Object(d.a)("This room has no topic.");return h.a.createTrackedDialog("Slash Commands","Topic",L.a,{title:n.name,description:a.createElement("div",{dangerouslySetInnerHTML:{__html:r}}),hasCloseButton:!0}),Y()},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"roomname",args:"<name>",description:Object(d.b)("Sets the room name"),runFn:function(e,t){return t?Y(c.a.get().setRoomName(e,t)):J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"invite",args:"<user-id> [<reason>]",description:Object(d.b)("Invites user with given id to current room"),isEnabled:()=>Object(V.a)(T.a.InviteUsers),runFn:function(e,t){if(t){const[s,n]=t.split(/\s+(.+)/);if(s){let t=Promise.resolve();if("email"===Object(f.c)(s)&&!c.a.get().getIdentityServerUrl()){const e=Object(y.c)();if(!e)return J(Object(d.a)("Use an identity server to invite by email. Manage in Settings."));{const{finished:s}=h.a.createTrackedDialog("Slash Commands","Identity server",p.a,{title:Object(d.a)("Use an identity server"),description:a.createElement("p",null,Object(d.a)("Use an identity server to invite by email. Click continue to use the default identity server (%(defaultIdentityServerName)s) or manage in Settings.",{defaultIdentityServerName:Object(b.a)(e)})),button:Object(d.a)("Continue")});t=s.then(([e])=>{if(!e)throw new Error(Object(d.a)("Use an identity server to invite by email. Manage in Settings."));Object(y.d)()})}}const i=new u.a(e);return Y(t.then(()=>i.invite([s],n)).then(()=>{if("invited"!==i.getCompletionState(s))throw new Error(i.getErrorText(s))}))}}return J(this.getUsage())},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"join",aliases:["j","goto"],args:"<room-address>",description:Object(d.b)("Joins room with given address"),runFn:function(e,t){if(t){const e=t.split(" ");if(e.length<1)return J(this.getUsage());let s=!1;if(e[0].startsWith("http:")||e[0].startsWith("https:")){const t=new URL(e[0]),n=t.host||t.hostname;Object(E.d)(n)&&(s=!0)}if("#"===e[0][0]){let t=e[0];return t.includes(":")||(t+=":"+c.a.get().getDomain()),l.a.dispatch({action:k.a.ViewRoom,room_alias:t,auto_join:!0,_type:"slash_command"}),Y()}if("!"===e[0][0]){const[t,...s]=e;return l.a.dispatch({action:k.a.ViewRoom,room_id:t,opts:{viaServers:s},via_servers:s,auto_join:!0,_type:"slash_command"}),Y()}if(s){const t=Object(E.j)(e[0]);if(!t)return J(this.getUsage());if(!t.roomIdOrAlias)return J(this.getUsage());const s=t.roomIdOrAlias,n=t.viaServers,i=t.eventId,a={action:k.a.ViewRoom,auto_join:!0,_type:"slash_command"};return"!"===s[0]?a.room_id=s:a.room_alias=s,i&&(a.event_id=i,a.highlighted=!0),n&&(a.opts={viaServers:n},a.via_servers=n),l.a.dispatch(a),Y()}}return J(this.getUsage())},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"part",args:"[<room-address>]",description:Object(d.b)("Leave room"),runFn:function(e,t){const s=c.a.get();let n;if(t){const e=t.match(/^(\S+)$/);if(e){let t=e[1];if("#"!==t[0])return J(this.getUsage());t.includes(":")||(t+=":"+s.getDomain());const i=s.getRooms();for(let e=0;e<i.length;e++){const s=i[e].currentState.getStateEvents("m.room.aliases");for(let a=0;a<s.length;a++){const o=s[a].getContent().aliases||[];for(let s=0;s<o.length;s++)if(o[s]===t){n=i[e].roomId;break}if(n)break}if(n)break}if(!n)return J(Object(d.a)("Unrecognised room address:")+" "+t)}}return n||(n=e),Y(Object(R.d)(n))},category:$.actions,renderingTypes:[K.a.Room]}),new z({command:"kick",args:"<user-id> [reason]",description:Object(d.b)("Kicks user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return Y(c.a.get().kick(e,s[1],s[3]))}return J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"ban",args:"<user-id> [reason]",description:Object(d.b)("Bans user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return Y(c.a.get().ban(e,s[1],s[3]))}return J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"unban",args:"<user-id>",description:Object(d.b)("Unbans user with given ID"),runFn:function(e,t){if(t){const s=t.match(/^(\S+)$/);if(s)return Y(c.a.get().unban(e,s[1]))}return J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"ignore",args:"<user-id>",description:Object(d.b)("Ignores a user, hiding their messages from you"),runFn:function(e,t){if(t){const e=c.a.get(),s=t.match(/^(@[^:]+:\S+)$/);if(s){const t=s[1],n=e.getIgnoredUsers();return n.push(t),Y(e.setIgnoredUsers(n).then(()=>{h.a.createTrackedDialog("Slash Commands","User ignored",L.a,{title:Object(d.a)("Ignored user"),description:a.createElement("div",null,a.createElement("p",null,Object(d.a)("You are now ignoring %(userId)s",{userId:t})))})}))}}return J(this.getUsage())},category:$.actions}),new z({command:"unignore",args:"<user-id>",description:Object(d.b)("Stops ignoring a user, showing their messages going forward"),runFn:function(e,t){if(t){const e=c.a.get(),s=t.match(/(^@[^:]+:\S+$)/);if(s){const t=s[1],n=e.getIgnoredUsers(),i=n.indexOf(t);return-1!==i&&n.splice(i,1),Y(e.setIgnoredUsers(n).then(()=>{h.a.createTrackedDialog("Slash Commands","User unignored",L.a,{title:Object(d.a)("Unignored user"),description:a.createElement("div",null,a.createElement("p",null,Object(d.a)("You are no longer ignoring %(userId)s",{userId:t})))})}))}}return J(this.getUsage())},category:$.actions}),new z({command:"op",args:"<user-id> [<power-level>]",description:Object(d.b)("Define the power level of a user"),isEnabled(){const e=c.a.get(),t=e.getRoom(W.a.getRoomId());return null==t?void 0:t.currentState.maySendStateEvent(o.a.RoomPowerLevels,e.getUserId())},runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(-?\d+))?$/);let n=50;if(s){const t=s[1];if(4===s.length&&void 0!==s[3]&&(n=parseInt(s[3],10)),!isNaN(n)){const s=c.a.get(),i=s.getRoom(e);if(!i)return J(Object(d.a)("Command failed"));const a=i.getMember(t);if(!a||Object(R.b)(a.membership)===R.a.Leave)return J(Object(d.a)("Could not find user in room"));const o=i.currentState.getStateEvents("m.room.power_levels","");return Y(s.setPowerLevel(e,t,n,o))}}}return J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"deop",args:"<user-id>",description:Object(d.b)("Deops user with given id"),isEnabled(){const e=c.a.get(),t=e.getRoom(W.a.getRoomId());return null==t?void 0:t.currentState.maySendStateEvent(o.a.RoomPowerLevels,e.getUserId())},runFn:function(e,t){if(t){if(t.match(/^(\S+)$/)){const s=c.a.get(),n=s.getRoom(e);if(!n)return J(Object(d.a)("Command failed"));const i=n.currentState.getStateEvents("m.room.power_levels","");return i.getContent().users[t]?Y(s.setPowerLevel(e,t,void 0,i)):J(Object(d.a)("Could not find user in room"))}}return J(this.getUsage())},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"devtools",description:Object(d.b)("Opens the Developer Tools dialog"),runFn:function(e){return h.a.createDialog(A.b,{roomId:e}),Y()},category:$.advanced}),new z({command:"addwidget",args:"<url | embed code | Jitsi url>",description:Object(d.b)("Adds a custom widget by URL to the room"),isEnabled:()=>x.b.getValue(T.b.Widgets),runFn:function(e,t){if(!t)return J(Object(d.a)("Please supply a widget URL or embed code"));if(t.toLowerCase().startsWith("<iframe ")){const e=Object(w.parseFragment)(t);if(e&&e.childNodes&&1===e.childNodes.length){const s=e.childNodes[0];if("iframe"===s.tagName.toLowerCase()&&s.attrs){const e=s.attrs.find(e=>"src"===e.name);B.a.log("Pulling URL out of iframe (embed code)"),t=e.value}}}if(!t.startsWith("https://")&&!t.startsWith("http://"))return J(Object(d.a)("Please supply a https:// or http:// widget URL"));if(g.a.canUserModifyWidgets(e)){const s=c.a.get().getUserId(),n=(new Date).getTime(),i=encodeURIComponent(`${e}_${s}_${n}`);let a=S.a.CUSTOM,o="Custom Widget",r={};const l=_.a.getInstance().parsePreferredConferenceUrl(t);return l&&(B.a.log("Making /addwidget widget a Jitsi conference"),a=S.a.JITSI,o="Jitsi Conference",r=l,t=g.a.getLocalJitsiWrapperUrl()),Y(g.a.setRoomWidget(e,i,a,t,o,r))}return J(Object(d.a)("You cannot modify widgets in this room."))},category:$.admin,renderingTypes:[K.a.Room]}),new z({command:"verify",args:"<user-id> <device-id> <device-signing-key>",description:Object(d.b)("Verifies a user, session, and pubkey tuple"),runFn:function(e,t){if(t){const e=t.match(/^(\S+) +(\S+) +(\S+)$/);if(e){const t=c.a.get(),s=e[1],n=e[2],i=e[3];return Y((async()=>{const e=t.getStoredDevice(s,n);if(!e)throw new Error(Object(d.a)("Unknown (user, session) pair:")+` (${s}, ${n})`);if((await t.checkDeviceTrust(s,n)).isVerified())throw e.getFingerprint()===i?new Error(Object(d.a)("Session already verified!")):new Error(Object(d.a)("WARNING: Session already verified, but keys do NOT MATCH!"));if(e.getFingerprint()!==i){const t=e.getFingerprint();throw new Error(Object(d.a)('WARNING: KEY VERIFICATION FAILED! The signing key for %(userId)s and session %(deviceId)s is "%(fprint)s" which does not match the provided key "%(fingerprint)s". This could mean your communications are being intercepted!',{fprint:t,userId:s,deviceId:n,fingerprint:i}))}await t.setDeviceVerified(s,n,!0),h.a.createTrackedDialog("Slash Commands","Verified key",L.a,{title:Object(d.a)("Verified key"),description:a.createElement("div",null,a.createElement("p",null,Object(d.a)("The signing key you provided matches the signing key you received from %(userId)s's session %(deviceId)s. Session marked as verified.",{userId:s,deviceId:n})))})})())}}return J(this.getUsage())},category:$.advanced,renderingTypes:[K.a.Room]}),new z({command:"discardsession",description:Object(d.b)("Forces the current outbound group session in an encrypted room to be discarded"),runFn:function(e){try{c.a.get().forceDiscardSession(e)}catch(e){return J(e.message)}return Y()},category:$.advanced,renderingTypes:[K.a.Room]}),new z({command:"rainbow",description:Object(d.b)("Sends the given message coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?Q(r.makeHtmlMessage(t,Object(v.a)(t))):J(this.getUserId())},category:$.messages}),new z({command:"rainbowme",description:Object(d.b)("Sends the given emote coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?Q(r.makeHtmlEmote(t,Object(v.a)(t))):J(this.getUserId())},category:$.messages}),new z({command:"help",description:Object(d.b)("Displays list of commands with usages and descriptions"),runFn:function(){return h.a.createTrackedDialog("Slash Commands","Help",F.a),Y()},category:$.advanced}),new z({command:"whois",description:Object(d.b)("Displays information about a user"),args:"<user-id>",runFn:function(e,t){if(!t||!t.startsWith("@")||!t.includes(":"))return J(this.getUsage());const s=c.a.get().getRoom(e).getMember(t);return l.a.dispatch({action:k.a.ViewUser,member:s||{userId:t}}),Y()},category:$.advanced}),new z({command:"rageshake",aliases:["bugreport"],description:Object(d.b)("Send a bug report with logs"),isEnabled:()=>!!I.a.get().bug_report_endpoint_url,args:"<description>",runFn:function(e,t){return Y(h.a.createTrackedDialog("Slash Commands","Bug Report Dialog",C.a,{initialText:t}).finished)},category:$.advanced}),new z({command:"query",description:Object(d.b)("Opens chat with the given user"),args:"<user-id>",runFn:function(e,t){const s=t&&/^\+?[0123456789]+$/.test(t);return t&&(t.startsWith("@")&&t.includes(":")||s)?Y((async()=>{if(s){const e=await N.d.sharedInstance().pstnLookup(this.state.value);if(!e||0===e.length||!e[0].userid)throw new Error("Unable to find Matrix ID for phone number");t=e[0].userid}const e=await Object(O.c)(c.a.get(),t);l.a.dispatch({action:k.a.ViewRoom,room_id:e})})()):J(this.getUsage())},category:$.actions}),new z({command:"msg",description:Object(d.b)("Sends a message to the given user"),args:"<user-id> [<message>]",runFn:function(e,t){if(t){const e=t.match(/^(\S+?)(?: +(.*))?$/s);if(e){const[t,s]=e.slice(1);if(t&&t.startsWith("@")&&t.includes(":"))return Y((async()=>{const e=c.a.get(),n=await Object(O.c)(e,t);l.a.dispatch({action:k.a.ViewRoom,room_id:n}),s&&e.sendTextMessage(n,s)})())}}return J(this.getUsage())},category:$.actions}),new z({command:"holdcall",description:Object(d.b)("Places the call in the current room on hold"),category:$.other,runFn:function(e,t){const s=N.d.sharedInstance().getCallForRoom(e);return s?(s.setRemoteOnHold(!0),Y()):J("No active call in this room")},renderingTypes:[K.a.Room]}),new z({command:"unholdcall",description:Object(d.b)("Takes the call in the current room off hold"),category:$.other,runFn:function(e,t){const s=N.d.sharedInstance().getCallForRoom(e);return s?(s.setRemoteOnHold(!1),Y()):J("No active call in this room")},renderingTypes:[K.a.Room]}),new z({command:"converttodm",description:Object(d.b)("Converts the room to a DM"),category:$.other,runFn:function(e,t){const s=c.a.get().getRoom(e);return Y(Object(P.d)(s,!0))},renderingTypes:[K.a.Room]}),new z({command:"converttoroom",description:Object(d.b)("Converts the DM to a room"),category:$.other,runFn:function(e,t){const s=c.a.get().getRoom(e);return Y(Object(P.d)(s,!1))},renderingTypes:[K.a.Room]}),new z({command:"me",args:"<message>",description:Object(d.b)("Displays action"),category:$.messages,hideCompletionAfterSpace:!0}),...j.CHAT_EFFECTS.map(e=>new z({command:e.command,description:e.description(),args:"<message>",runFn:function(t,s){return Y((async()=>{if(s){const n={msgtype:e.msgType,body:s};c.a.get().sendMessage(t,n)}else s=e.fallbackMessage(),c.a.get().sendEmoteMessage(t,s);l.a.dispatch({action:"effects."+e.command})})())},category:$.effects,renderingTypes:[K.a.Room]}))],Z=new Map;function ee(e){if("/"!==(e=e.replace(/\s+$/,""))[0])return{};const t=e.match(/^(\S+?)(?:[ \n]+((.|\n)*))?$/);let s,n;return t?(s=t[1].substring(1).toLowerCase(),n=t[2]):s=e,{cmd:s,args:n}}function te(e){const{cmd:t,args:s}=ee(e);return Z.has(t)&&Z.get(t).isEnabled()?{cmd:Z.get(t),args:s}:{}}X.forEach(e=>{Z.set(e.command,e),e.aliases.forEach(t=>{Z.set(t,e)})})},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(85),h=s(101),u=s(84),m=s(160),p=s(231);let g=Object(d.a)("views.auth.EmailField")((a=i=class extends c.PureComponent{constructor(...e){super(...e),r()(this,"validate",Object(m.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(u.a)(this.props.labelRequired)},{key:"email",test:({value:e})=>!e||p.a(e),invalid:()=>Object(u.a)(this.props.labelInvalid)}]})),r()(this,"onValidate",async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const s=await t(e);return this.props.onValidate&&this.props.onValidate(s),s})}render(){return l.a.createElement(h.a,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:Object(u.a)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate})}},r()(i,"defaultProps",{label:Object(u.b)("Email"),labelRequired:Object(u.b)("Enter email address"),labelInvalid:Object(u.b)("Doesn't look like a valid email address")}),n=a))||n;t.a=g},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(85),r=s(964),c=s(580);let l=Object(o.a)("views.auth.AuthHeader")(n=class extends a.a.Component{render(){return a.a.createElement("div",{className:"mx_AuthHeader"},a.a.createElement(r.a,null),a.a.createElement(c.a,{disabled:this.props.disableLanguageSelector}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n,i=s(82),a=s.n(i),o=s(85);let r=Object(o.a)("views.auth.AuthBody")(n=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_AuthBody"},this.props.children)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(83),i=s.n(n),a=s(86),o=s(90),r=s(84),c=s(210),l=s(217),d=s(242);function h(){return a.a.get().idBaseUrl.split("://")[1]}class u{constructor(){i()(this,"sessionId",void 0),i()(this,"submitUrl",void 0),i()(this,"clientSecret",void 0),i()(this,"bind",void 0),i()(this,"makeAddThreepidOnlyRequest",e=>a.a.get().addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:e})),this.clientSecret=a.a.get().generateClientSecret()}addEmailAddress(e){return a.a.get().requestAdd3pidEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(r.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindEmailAddress(e){if(this.bind=!0,await a.a.get().doesServerSupportSeparateAddAndBind()){const t=new c.a,s=await t.getAccessToken();return a.a.get().requestEmailToken(e,this.clientSecret,1,void 0,void 0,s).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(r.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addEmailAddress(e)}addMsisdn(e,t){return a.a.get().requestAdd3pidMsisdnToken(e,t,this.clientSecret,1).then(e=>(this.sessionId=e.sid,this.submitUrl=e.submit_url,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(r.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindMsisdn(e,t){if(this.bind=!0,await a.a.get().doesServerSupportSeparateAddAndBind()){const s=new c.a,n=await s.getAccessToken();return a.a.get().requestMsisdnToken(e,t,this.clientSecret,1,void 0,void 0,n).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(r.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addMsisdn(e,t)}async checkEmailLinkClicked(){try{if(await a.a.get().doesServerSupportSeparateAddAndBind())if(this.bind){const e=new c.a,t=await e.getAccessToken();await a.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:h(),id_access_token:t})}else try{return void await this.makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t={[l.c.PHASE_PREAUTH]:{title:Object(r.a)("Use Single Sign On to continue"),body:Object(r.a)("Confirm adding this email address by using Single Sign On to prove your identity."),continueText:Object(r.a)("Single Sign On"),continueKind:"primary"},[l.c.PHASE_POSTAUTH]:{title:Object(r.a)("Confirm adding email"),body:Object(r.a)("Click the button below to confirm adding this email address."),continueText:Object(r.a)("Confirm"),continueKind:"primary"}},{finished:s}=o.a.createTrackedDialog("Add Email","",d.a,{title:Object(r.a)("Add Email Address"),matrixClient:a.a.get(),authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[l.c.LOGIN_TYPE]:t,[l.c.UNSTABLE_LOGIN_TYPE]:t}});return s}else await a.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:h()},this.bind)}catch(e){throw 401===e.httpStatus?e.message=Object(r.a)("Failed to verify email address: make sure you clicked the link in the email"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}async haveMsisdnToken(e){const t=new c.a,s=await a.a.get().doesServerSupportSeparateAddAndBind();let n;if(this.submitUrl)n=await a.a.get().submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind&&s)throw new Error("The add / bind with MSISDN flow is misconfigured");n=await a.a.get().submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(n.errcode)throw n;if(s)if(this.bind)await a.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:h(),id_access_token:await t.getAccessToken()});else try{return void await this.makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t={[l.c.PHASE_PREAUTH]:{title:Object(r.a)("Use Single Sign On to continue"),body:Object(r.a)("Confirm adding this phone number by using Single Sign On to prove your identity."),continueText:Object(r.a)("Single Sign On"),continueKind:"primary"},[l.c.PHASE_POSTAUTH]:{title:Object(r.a)("Confirm adding phone number"),body:Object(r.a)("Click the button below to confirm adding this phone number."),continueText:Object(r.a)("Confirm"),continueKind:"primary"}},{finished:s}=o.a.createTrackedDialog("Add MSISDN","",d.a,{title:Object(r.a)("Add Phone Number"),matrixClient:a.a.get(),authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[l.c.LOGIN_TYPE]:t,[l.c.UNSTABLE_LOGIN_TYPE]:t}});return s}else await a.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:h()},this.bind)}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return k})),s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return I})),s.d(t,"d",(function(){return x}));var n=s(83),i=s.n(n),a=s(1513),o=s(1514),r=s(315),c=s(153),l=s(5),d=s.n(l),h=s(378);const u=new h.a;class m{constructor(){}static for(e,t){if(!e||!t)throw new Error("An instance and key must be supplied");return new p(e,t)}static forgetAllFor(e){u.delete(e)}static forgetAll(){for(const e of u.keys())u.remove(e)}}i()(m,"Void",Symbol("void"));class p{constructor(e,t){this.instance=e,this.key=t}forget(){const e=u.get(this.instance);e&&(e.remove(this.key),e.size||u.remove(this.instance))}do(e){const t=u.getOrCreate(this.instance,new h.a);let s=t.get(this.key);return void 0===s&&(s=e(),t.set(this.key,s)),s}}let g;!function(e){e.Timekeep="timekeep",e.AmplitudeMark="amplitude_mark"}(g||(g={}));var v=s(123),f=s(203),b=s(750),y=s(202),E=s(116);class S{constructor(e,t){this.width=e,i()(this,"samples",[]),this.samples=Object(E.h)(t,this.width)}get value(){return this.samples}pushValue(e){let t=Object(E.b)(this.samples);t.splice(0,0,e),t.length>this.width&&(t=t.slice(0,this.width)),this.samples=t}}var _=s(233),w=s(1515),C=s.n(w),O=s(1);const k=48e3,R=44;let I;!function(e){e.Started="started",e.EndingSoon="ending_soon",e.Ended="ended",e.Uploading="uploading",e.Uploaded="uploaded"}(I||(I={}));class x extends d.a{constructor(e){super(),this.client=e,i()(this,"recorder",void 0),i()(this,"recorderContext",void 0),i()(this,"recorderSource",void 0),i()(this,"recorderStream",void 0),i()(this,"recorderWorklet",void 0),i()(this,"recorderProcessor",void 0),i()(this,"buffer",new Uint8Array(0)),i()(this,"lastUpload",void 0),i()(this,"recording",!1),i()(this,"observable",void 0),i()(this,"amplitudes",[]),i()(this,"playback",void 0),i()(this,"liveWaveform",new S(R,0)),i()(this,"onAudioProcess",e=>{this.processAudioUpdate(e.playbackTime)}),i()(this,"processAudioUpdate",e=>{if(!this.recording)return;this.observable.update({waveform:this.liveWaveform.value.map(e=>Object(_.a)(e,0,1)),timeSeconds:e});const t=120-this.recorder.encodedSamplePosition/48e3;t<0?this.stop():t<=10&&m.for(this,"ending_soon").do(()=>(this.emit(I.EndingSoon,{secondsLeft:t}),m.Void))})}get contentType(){return"audio/ogg"}get contentLength(){return this.buffer.length}get durationSeconds(){if(!this.recorder)throw new Error("Duration not available without a recording");return this.recorderContext.currentTime}get isRecording(){return this.recording}emit(e,...t){return super.emit(e,...t),super.emit(v.b,e,...t),!0}async makeRecorder(){try{this.recorderStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:!0,deviceId:r.c.getAudioInput()}}),this.recorderContext=Object(b.a)({}),this.recorderSource=this.recorderContext.createMediaStreamSource(this.recorderStream),this.recorderContext.audioWorklet?(await this.recorderContext.audioWorklet.addModule(C.a),this.recorderWorklet=new AudioWorkletNode(this.recorderContext,"mx-voice-worklet"),this.recorderSource.connect(this.recorderWorklet),this.recorderWorklet.connect(this.recorderContext.destination),this.recorderWorklet.port.onmessage=e=>{switch(e.data.ev){case g.Timekeep:this.processAudioUpdate(e.data.timeSeconds);break;case g.AmplitudeMark:e.data.forIndex===this.amplitudes.length&&(this.amplitudes.push(e.data.amplitude),this.liveWaveform.pushValue(e.data.amplitude))}}):(this.recorderProcessor=this.recorderContext.createScriptProcessor(1024,1,1),this.recorderSource.connect(this.recorderProcessor),this.recorderProcessor.connect(this.recorderContext.destination),this.recorderProcessor.addEventListener("audioprocess",this.onAudioProcess)),this.recorder=new a({encoderPath:o.a,encoderSampleRate:k,encoderApplication:2048,streamPages:!0,encoderFrameSize:20,numberOfChannels:1,sourceNode:this.recorderSource,encoderBitRate:24e3,encoderComplexity:3,resampleQuality:3}),this.recorder.ondataavailable=e=>{const t=new Uint8Array(e),s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer,0),s.set(t,this.buffer.length),this.buffer=s}}catch(e){throw O.a.error("Error starting recording: ",e),e instanceof DOMException&&O.a.error(`${e.name} (${e.code}): ${e.message}`),this.recorderStream&&this.recorderStream.getTracks().forEach(e=>e.stop()),this.recorderSource&&this.recorderSource.disconnect(),this.recorder&&this.recorder.close(),this.recorderContext&&this.recorderContext.close(),e}}get audioBuffer(){return this.buffer.slice(0)}get liveData(){if(!this.recording)throw new Error("No observable when not recording");return this.observable}get isSupported(){return!!a.isRecordingSupported()}get hasRecording(){return this.buffer.length>0}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");if(this.recording)throw new Error("Recording already in progress");this.observable&&this.observable.close(),this.observable=new c.SimpleObservable,await this.makeRecorder(),await this.recorder.start(),this.recording=!0,this.emit(I.Started)}async stop(){return m.for(this,"stop").do(async()=>{if(!this.recording)throw new Error("No recording to stop");return await this.recorder.stop(),this.recorderSource.disconnect(),this.recorderWorklet&&this.recorderWorklet.disconnect(),this.recorderProcessor&&(this.recorderProcessor.disconnect(),this.recorderProcessor.removeEventListener("audioprocess",this.onAudioProcess)),await this.recorderContext.close(),this.recorderStream.getTracks().forEach(e=>e.stop()),this.recording=!1,await this.recorder.close(),this.emit(I.Ended),this.audioBuffer})}getPlayback(){return this.playback=m.for(this,"playback").do(()=>new f.c(this.audioBuffer.buffer,this.amplitudes)),this.playback}destroy(){var e;this.stop(),this.removeAllListeners(),m.forgetAllFor(this),null===(e=this.playback)||void 0===e||e.destroy(),this.observable.close()}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(I.Uploading);const{url:t,file:s}=await Object(y.c)(this.client,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:s},this.emit(I.Uploaded)}catch(e){throw this.emit(I.Ended),e}return this.lastUpload}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(99),i=s.n(n);class a{constructor(e){this.filterJson=e}check(e){return this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null}}checkFields(e,t,s,n){const i={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const s=t.slice(0,-1);return e.substr(0,s.length)===s}return e===t}(s,e)}};for(let e=0;e<Object.keys(i).length;e++){const t=Object.keys(i)[e],s=i[t],n="not_"+t,a=this.filterJson[n];if(null!=a&&a.some(s))return!1;const o=this.filterJson[t];if(o&&!o.some(s))return!1}const a=this.filterJson.contains_url;return void 0===a||a===n}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function o(e,t,s){const n=t.split(".");let i=e;for(let e=0;e<n.length-1;e++)i[n[e]]||(i[n[e]]={}),i=i[n[e]];i[n[n.length-1]]=s}class r{static fromJson(e,t,s){const n=new r(e,t);return n.setDefinition(s),n}constructor(e,t){this.userId=e,this.filterId=t,i()(this,"definition",{}),i()(this,"roomFilter",void 0),i()(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,s={};t&&(t.rooms&&(s.rooms=t.rooms),t.rooms&&(s.not_rooms=t.not_rooms)),this.roomFilter=new a(s),this.roomTimelineFilter=new a((null==t?void 0:t.timeline)||{})}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomTimelineFilter.filter(this.roomFilter.filter(e))}setTimelineLimit(e){o(this.definition,"room.timeline.limit",e)}setLazyLoadMembers(e){o(this.definition,"room.state.lazy_load_members",!!e)}setIncludeLeaveRooms(e){o(this.definition,"room.include_leave",e)}}i()(r,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n extends class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(99),i=s.n(n);class a{constructor(e){i()(this,"target",void 0),this.target=e}reEmit(e,t){for(const s of t){const t=(...t)=>{"error"===s&&0===this.target.listenerCount("error")||this.target.emit(s,...t,e)};e.on(s,t)}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(99),i=s.n(n),a=s(1),o=s(4);let r;!function(e){e.Invite="invite",e.Leave="leave",e.Join="join"}(r||(r={}));class c{constructor(e={}){this.opts=e,i()(this,"accountData",{}),i()(this,"inviteRooms",{}),i()(this,"joinRooms",{}),i()(this,"nextBatch",null),i()(this,"groups",{invite:{},join:{},leave:{}}),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e,t=!1){this.accumulateRooms(e,t),this.accumulateGroups(e),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}accumulateRooms(e,t=!1){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(s=>{this.accumulateRoom(s,r.Invite,e.rooms.invite[s],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(s=>{this.accumulateRoom(s,r.Join,e.rooms.join[s],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(s=>{this.accumulateRoom(s,r.Leave,e.rooms.leave[s],t)}))}accumulateRoom(e,t,s,n=!1){switch(t){case r.Invite:this.accumulateInviteState(e,s);break;case r.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,s,n);break;case r.Leave:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:a.a.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const s=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let n=0;n<s.invite_state.events.length;n++){const i=s.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(s.invite_state.events[n]=e,t=!0)}t||s.invite_state.events.push(e)})}accumulateJoinState(e,t,s=!1){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const n=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{n._accountData[e.type]=e}),t.unread_notifications&&(n._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",s="m.invited_member_count",i="m.joined_member_count",a=n._summary,o=t.summary;a[e]=o[e]||a[e],a[i]=o[i]||a[i],a[s]=o[s]||a[s]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(t=>{e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach(s=>{n._readReceipts[s]={data:e.content[t]["m.read"][s],eventId:t}})})}),t.timeline&&t.timeline.limited&&(n._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(e=>{l(n._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach((e,i)=>{let a;if(l(n._currentState,e),s)a=e;else{a=Object.assign({},e),void 0!==a.unsigned&&(a.unsigned=Object.assign({},a.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(a._localTs=Date.now()-t)}n._timeline.push({event:a,token:0===i?t.timeline.prev_batch:null})}),n._timeline.length>this.opts.maxTimelineEntries){for(let e=n._timeline.length-this.opts.maxTimelineEntries;e<n._timeline.length;e++)if(n._timeline[e].token){n._timeline=n._timeline.slice(e,n._timeline.length);break}}}accumulateGroups(e){e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach(t=>{this.accumulateGroup(t,r.Invite,e.groups.invite[t])}),e.groups.join&&Object.keys(e.groups.join).forEach(t=>{this.accumulateGroup(t,r.Join,e.groups.join[t])}),e.groups.leave&&Object.keys(e.groups.leave).forEach(t=>{this.accumulateGroup(t,r.Leave,e.groups.leave[t])}))}accumulateGroup(e,t,s){for(const t of[r.Invite,r.Leave,r.Join])delete this.groups[t][e];this.groups[t][e]=s}getJSON(e=!1){const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(e=>{t.invite[e]=this.inviteRooms[e]}),Object.keys(this.joinRooms).forEach(s=>{const n=this.joinRooms[s],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach(e=>{i.account_data.events.push(n._accountData[e])});const a={type:"m.receipt",room_id:s,content:{}};Object.keys(n._readReceipts).forEach(e=>{const t=n._readReceipts[e];a.content[t.eventId]||(a.content[t.eventId]={"m.read":{}}),a.content[t.eventId]["m.read"][e]=t.data}),Object.keys(a.content).length>0&&i.ephemeral.events.push(a),n._timeline.forEach(t=>{if(!i.timeline.prev_batch){if(!t.token)return;i.timeline.prev_batch=t.token}let s;!e&&t.event._localTs?(s=Object.assign({},t.event),void 0!==s.unsigned&&(s.unsigned=Object.assign({},s.unsigned)),delete s._localTs,s.unsigned=s.unsigned||{},s.unsigned.age=Date.now()-t.event._localTs):s=t.event,i.timeline.events.push(s)});const r=Object.create(null);for(let e=i.timeline.events.length-1;e>=0;e--){const t=i.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const s=Object(o.j)(t);s.unsigned&&(s.unsigned.prev_content&&(s.content=s.unsigned.prev_content),s.unsigned.prev_sender&&(s.sender=s.unsigned.prev_sender)),l(r,s)}Object.keys(n._currentState).forEach(e=>{Object.keys(n._currentState[e]).forEach(t=>{let s=n._currentState[e][t];r[e]&&r[e][t]&&(s=r[e][t]),i.state.events.push(s)})}),t.join[s]=i});const s=[];return Object.keys(this.accountData).forEach(e=>{s.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:t,groupsData:this.groups,accountData:s}}getNextBatchToken(){return this.nextBatch}}function l(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}},,,function(e,t,s){"use strict";(function(e,n){s.d(t,"d",(function(){return A})),s.d(t,"c",(function(){return U})),s.d(t,"a",(function(){return L})),s.d(t,"b",(function(){return F}));var i=s(99),a=s.n(i),o=s(346),r=s.n(o),c=s(5),l=s(343),d=s(1),h=s(605),u=s(149),m=s(1077),p=s(348),g=s(1045),v=s(350),f=s(1078),b=s(1079),y=s(1080),E=s(174),S=s(351),_=s(1081),w=s(352),C=s(353),O=s(225),k=s(1085),R=s(1086),I=s(1087),x=s(224),T=s(252),j=s(607),N=s(608),P=s(117);const D=p.a.DeviceVerification,M={[S.b.NAME]:S.b,[_.a.NAME]:_.a,[S.d]:I.a,[S.c]:I.a},A={RECIPROCATE_QR_CODE:S.b.NAME,SAS:_.a.NAME};function U(){return Boolean(e.Olm)}class L extends c.EventEmitter{static getOlmVersion(){return h.a.getOlmVersion()}constructor(e,t,s,n,i,o,r,c){if(super(),this.baseApis=e,this.sessionStore=t,this.userId=s,this.deviceId=n,this.clientStore=i,this.cryptoStore=o,this.roomList=r,a()(this,"backupManager",void 0),a()(this,"crossSigningInfo",void 0),a()(this,"olmDevice",void 0),a()(this,"deviceList",void 0),a()(this,"dehydrationManager",void 0),a()(this,"secretStorage",void 0),a()(this,"reEmitter",void 0),a()(this,"verificationMethods",void 0),a()(this,"supportedAlgorithms",void 0),a()(this,"outgoingRoomKeyRequestManager",void 0),a()(this,"toDeviceVerificationRequests",void 0),a()(this,"inRoomVerificationRequests",void 0),a()(this,"trustCrossSignedDevices",!0),a()(this,"lastOneTimeKeyCheck",null),a()(this,"oneTimeKeyCheckInProgress",!1),a()(this,"roomEncryptors",{}),a()(this,"roomDecryptors",{}),a()(this,"deviceKeys",{}),a()(this,"globalBlacklistUnverifiedDevices",!1),a()(this,"globalErrorOnUnknownDevices",!0),a()(this,"receivedRoomKeyRequests",[]),a()(this,"receivedRoomKeyRequestCancellations",[]),a()(this,"processingRoomKeyRequests",!1),a()(this,"lazyLoadMembers",!1),a()(this,"roomDeviceTrackingState",{}),a()(this,"lastNewSessionForced",{}),a()(this,"sendKeyRequestsImmediately",!1),a()(this,"oneTimeKeyCount",void 0),a()(this,"needsNewFallback",void 0),a()(this,"onDeviceListUserCrossSigningUpdated",async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),s=t?t.getId():null,n=this.crossSigningInfo.getId(),i=n!==s;n&&s&&!i?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e))}}),a()(this,"onToDeviceEvent",e=>{try{d.a.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once("Event.decrypted",e=>{this.onToDeviceEvent(e)}))}catch(e){d.a.error("Error handling toDeviceEvent:",e)}}),a()(this,"onTimelineEvent",(e,t,s,n,{liveEvent:i=!0}={})=>{if(!k.a.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.inRoomVerificationRequests,e=>{const t=new k.a(this.baseApis,e.getRoomId());return new O.l(t,this.verificationMethods,this.baseApis)},i)}),this.reEmitter=new l.a(this),c){this.verificationMethods=new Map;for(const e of c)"string"==typeof e?M[e]&&this.verificationMethods.set(e,M[e]):e.NAME?this.verificationMethods.set(e.NAME,e):d.a.warn("Excluding unknown verification method "+e)}else this.verificationMethods=M;this.backupManager=new N.a(e,async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.getSecret("m.megolm_backup.v1");if(t){const e=F(t);if(e){const[t]=await this.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",e,[t])}return u.decodeBase64(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return await this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")}),this.olmDevice=new h.a(o),this.deviceList=new m.a(e,o,this.olmDevice),this.deviceList.on("userCrossSigningUpdated",this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this.supportedAlgorithms=Object.keys(g.a),this.outgoingRoomKeyRequestManager=new y.a(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new R.b,this.inRoomVerificationRequests=new k.b;const p=this.baseApis.cryptoCallbacks||{},f=Object(v.d)(o,this.olmDevice);this.crossSigningInfo=new v.a(s,p,f),this.secretStorage=new b.b(e,p,e),this.dehydrationManager=new j.b(this),!p.getCrossSigningKey&&p.getSecretStorageKey&&(p.getCrossSigningKey=async e=>v.a.getFromSecretStorage(e,this.secretStorage))}async init({exportedOlmDevice:t,pickleKey:s}={}){d.a.log("Crypto: initialising Olm..."),await e.Olm.init(),d.a.log(t?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:t,pickleKey:s}),d.a.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,d.a.log("Crypto: fetching own devices...");let n=this.deviceList.getRawStoredDevicesForUser(this.userId);if(n||(n={}),!n[this.deviceId]){d.a.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:D.VERIFIED,known:!0};n[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,n),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[E.a.STORE_ACCOUNT],e=>{this.cryptoStore.getCrossSigningKeys(e,e=>{e&&0!==Object.keys(e).length&&(d.a.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))})}),this.deviceList.startTrackingDeviceList(this.userId),d.a.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const s of Object.keys(t)){const t=this.checkDeviceTrust(e,s);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,s);this.emit("deviceVerificationChanged",e,s,t)}}}}async createRecoveryKeyFromPassphrase(t){const s=new e.Olm.PkDecryption;try{const e={};if(t){const n=await Object(w.c)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:n.iterations,salt:n.salt},e.pubkey=s.init_with_private_key(n.key)}else e.pubkey=s.generate_key();const n=s.get_private_key();return{keyInfo:e,encodedPrivateKey:Object(C.b)(n),privateKey:n}}finally{s&&s.free()}}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),s=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&s)}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){d.a.log("Bootstrapping cross-signing");const s=this.baseApis.cryptoCallbacks,n=new f.a(this.baseApis.store.accountData,s),i=new v.a(this.userId,n.crossSigningCallbacks,n.crossSigningCallbacks),a=async()=>{i.resetKeys(),await this.signObject(i.keys.master),n.addCrossSigningKeys(e,i.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),s=await i.signDevice(this.userId,t);n.addKeySignature(this.userId,this.deviceId,s),this.backupManager.backupInfo&&(await i.signObject(this.backupManager.backupInfo.auth_data,"master"),n.addSessionBackup(this.backupManager.backupInfo))},o=this.crossSigningInfo.getId(),r=await this.crossSigningInfo.isStoredInKeyCache(),c=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),l=r||c;d.a.log({setupNewCrossSigning:t,publicKeysOnDevice:o,privateKeysInCache:r,privateKeysInStorage:c,privateKeysExistSomewhere:l}),!l||t?(d.a.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await a()):o&&r?d.a.log("Cross-signing public keys trusted and private keys found locally"):c&&(d.a.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const h=n.crossSigningCallbacks.privateKeys;if(h.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new b.b(n.accountDataClientAdapter,n.ssssCryptoCallbacks);await e.hasKey()&&(d.a.log("Storing new cross-signing private keys in secret storage"),await v.a.storeInSecretStorage(h,e))}const u=n.buildOperation();await u.apply(this),await n.persist(this),d.a.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:n,getKeyBackupPassphrase:i}={}){d.a.log("Bootstrapping Secure Secret Storage");const a=this.baseApis.cryptoCallbacks,o=new f.a(this.baseApis.store.accountData,a),r=new b.b(o.accountDataClientAdapter,o.ssssCryptoCallbacks);let c=null;const l=async(e,t)=>{t&&(e.key=t);const{keyId:s,keyInfo:n}=await r.addKey(b.a,e);return t&&o.ssssCryptoCallbacks.addPrivateKey(s,n,t),await r.setDefaultKeyId(s),s},h=async(e,t)=>{if(!t.mac){const s=await this.baseApis.cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(s){const n=s[1];o.ssssCryptoCallbacks.addPrivateKey(e,t,n);const{iv:i,mac:a}=await Object(T.a)(n);t.iv=i,t.mac=a,await o.setAccountData("m.secret_storage.key."+e,t)}}},m=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{d.a.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){d.a.error("Signing key backup with cross-signing keys failed",e)}else d.a.warn("Cross-signing keys not available, skipping signature on key backup")},p=await this.getSecretStorageKey(),[g,y]=p||[null,null],E=!n&&y&&y.algorithm===b.a;if(d.a.log({keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:n,storageExists:E,oldKeyInfo:y}),E||t)if(!E&&t){d.a.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await i(),s={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(s.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),c=await l(s,e),await r.store("m.megolm_backup.v1",u.encodeBase64(e),[c]),await m(t.auth_data),o.addSessionBackup(t)}else d.a.log("Secret storage exists"),y&&y.algorithm===b.a&&await h(g,y);else{d.a.log("Secret storage does not exist, creating new storage key");const{keyInfo:t,privateKey:s}=await e();c=await l(t,s)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(c||!await this.crossSigningInfo.isStoredInSecretStorage(r))){d.a.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await v.a.storeInSecretStorage(e,r)}if(s&&!t){d.a.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=Object(C.a)(e.recovery_key);await r.store("m.megolm_backup.v1",u.encodeBase64(t));const s={algorithm:e.algorithm,auth_data:e.auth_data};await m(s.auth_data),await this.signObject(s.auth_data),o.addSessionBackup(s)}const S=await r.get("m.megolm_backup.v1");if(S){d.a.info("Got session backup key from secret storage: caching");const e=F(S);e&&await r.store("m.megolm_backup.v1",e,[c||g]);const t=new Uint8Array(u.decodeBase64(e||S));await o.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await i();if(!e)return void d.a.error("Key backup is enabled but couldn't get key backup key!");d.a.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await r.store("m.megolm_backup.v1",u.encodeBase64(e))}const _=o.buildOperation();await _.apply(this),await o.persist(this),d.a.log("Secure Secret Storage ready")}addSecretStorageKey(e,t,s){return this.secretStorage.addKey(e,t,s)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,s){return this.secretStorage.store(e,t,s)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e,t){return this.secretStorage.isStored(e,t)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(t,s){let n=null;try{n=new e.Olm.PkDecryption;return n.init_with_private_key(t)===s}finally{n&&n.free()}}async getSessionBackupPrivateKey(){let e=await new Promise(e=>{this.cryptoStore.doTxn("readonly",[E.a.STORE_ACCOUNT],t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")})});if(e&&"string"==typeof e&&(e=new Uint8Array(u.decodeBase64(F(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=n.from(this.olmDevice.pickleKey),s=await Object(T.b)(e,t,"m.megolm_backup.v1");e=u.decodeBase64(s)}return e}async storeSessionBackupPrivateKey(e){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got "+e);const t=n.from(this.olmDevice.pickleKey),s=await Object(T.c)(u.encodeBase64(e),t,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[E.a.STORE_ACCOUNT],e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",s)})}checkCrossSigningPrivateKey(t,s){let n=null;try{n=new e.Olm.PkSigning;return n.init_with_seed(t)===s}finally{n&&n.free()}}async afterCrossSigningLocalKeyChange(){d.a.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);d.a.info("Starting background key sig upload for "+this.deviceId);const s=({shouldEmit:e})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then(t=>{const{failures:n}=t||{};if(Object.keys(n||[]).length>0)throw e&&this.baseApis.emit("crypto.keySignatureUploadFailure",n,"afterCrossSigningLocalKeyChange",s),new x.c("Key upload failed",{failures:n});d.a.info("Finished background key sig upload for "+this.deviceId)}).catch(e=>{d.a.error("Error during background key sig upload for "+this.deviceId,e)});s({shouldEmit:!0});const n=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n){d.a.info("Starting device verification upgrade");const e={};for(const[t,s]of Object.entries(this.deviceList.crossSigningInfo)){const n=await this.checkForDeviceVerificationUpgrade(t,v.a.fromStorage(s,t));n&&(e[t]=n)}if(Object.keys(e).length>0){d.a.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await n({users:e});if(t)for(const s of t)s in e&&await this.baseApis.setDeviceVerified(s,e[s].crossSigningInfo.getId())}catch(e){d.a.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}d.a.info("Finished device verification upgrade")}d.a.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const s=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!s.isVerified()){const s=this.deviceList.getRawStoredDevicesForUser(e),n=await this.checkForValidDeviceSignature(e,t.keys.master,s);if(n.length)return{devices:n.map(e=>p.a.fromStorage(s[e],e)),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,s){const n=[];if(s&&t.signatures&&t.signatures[e])for(const i of Object.keys(t.signatures[e])){const[,a]=i.split(":",2);if(a in s&&s[a].verified===D.VERIFIED)try{await u.verifySignature(this.olmDevice,t,e,a,s[a].keys[i]),n.push(a)}catch(e){}}return n}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new v.c(!1,!1,!1)}checkDeviceTrust(e,t){const s=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,s)}checkDeviceInfoTrust(e,t){const s=!(!t||!t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){const i=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,s,i)}return new v.b(!1,!1,s,!1)}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const s=await this.crossSigningInfo.getCrossSigningKeysFromCache(),n=this.deviceList.getStoredCrossSigningForUser(t);if(!n)return void d.a.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const i=n.getId(),a=this.crossSigningInfo.getId()!==i,o=n.getId()&&!s.has("master");if(a&&d.a.info("Got new master public key",i),e&&(a||o)){d.a.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",i))[1],d.a.info("Got cross-signing master private key")}finally{e&&e.free()}}const r=this.crossSigningInfo.getId("self_signing"),c=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(n.keys);const l=r!==n.getId("self_signing"),h=c!==n.getId("user_signing"),u=n.getId("self_signing")&&!s.has("self_signing"),m=n.getId("user_signing")&&!s.has("user_signing"),p={};if(l&&d.a.info("Got new self-signing key",n.getId("self_signing")),e&&(l||u)){d.a.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",n.getId("self_signing")))[1],d.a.info("Got cross-signing self-signing private key")}finally{e&&e.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),s=await this.crossSigningInfo.signDevice(this.userId,t);p[this.deviceId]=s}if(h&&d.a.info("Got new user-signing key",n.getId("user_signing")),e&&(h||m)){d.a.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",n.getId("user_signing")))[1],d.a.info("Got cross-signing user-signing private key")}finally{e&&e.free()}}if(a){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];p[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const g=Object.keys(p);if(g.length){const e=({shouldEmit:t})=>(d.a.info("Starting background key sig upload for "+g),this.baseApis.uploadKeySignatures({[this.userId]:p}).then(s=>{const{failures:n}=s||{};if(d.a.info("Finished background key sig upload for "+g),Object.keys(n||[]).length>0)throw t&&this.baseApis.emit("crypto.keySignatureUploadFailure",n,"checkOwnCrossSigningTrust",e),new x.c("Key upload failed",{failures:n})}).catch(e=>{d.a.error("Error during background key sig upload for "+g,e)}));e({shouldEmit:!0})}this.emit("userTrustStatusChanged",t,this.checkUserTrust(t)),a&&(this.baseApis.emit("crossSigning.keysChanged",{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[E.a.STORE_ACCOUNT],e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)})}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(d.a.info("Starting device verification upgrade for "+e),this.crossSigningInfo.keys.user_signing){const s=this.deviceList.getStoredCrossSigningForUser(e);if(s){const n=await this.checkForDeviceVerificationUpgrade(e,s);if(n){(await t({users:{[e]:n}})).includes(e)&&await this.baseApis.setDeviceVerified(e,s.getId())}}}d.a.info("Finished device verification upgrade for "+e)}}async setTrustedBackupPubKey(e){this.sessionStore.setLocalTrustedBackupPubKey(e),await this.backupManager.checkKeyBackup()}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on("RoomMember.membership",(e,t,s)=>{try{this.onRoomMembership(e,t,s)}catch(e){d.a.error("Error handling membership change:",e)}}),e.on("toDeviceEvent",this.onToDeviceEvent),e.on("Room.timeline",this.onTimelineEvent),e.on("Event.decrypted",this.onTimelineEvent)}start(){this.outgoingRoomKeyRequestManager.start()}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){this.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){return this.globalErrorOnUnknownDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then(()=>this.baseApis.uploadKeysRequest({device_keys:e}))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}setNeedsNewFallback(e){this.needsNewFallback=!!e}getNeedsNewFallback(){return this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),s=Math.floor(t/2),n=async e=>{for(;s>e||this.getNeedsNewFallback();){if(s>e){d.a.info("generating oneTimeKeys");const t=Math.min(s-e,5);await this.olmDevice.generateOneTimeKeys(t)}this.getNeedsNewFallback()&&(d.a.info("generating fallback key"),await this.olmDevice.generateFallbackKey()),d.a.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(e=>e.one_time_key_counts.signed_curve25519||0)).then(e=>n(e)).catch(e=>{d.a.error("Error uploading one-time keys",e.stack||e)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}async uploadOneTimeKeys(){const e=[],t={};if(this.getNeedsNewFallback()){const s=await this.olmDevice.getFallbackKey();for(const[n,i]of Object.entries(s.curve25519)){const s={key:i,fallback:!0};t["signed_curve25519:"+n]=s,e.push(this.signObject(s))}this.setNeedsNewFallback(!1)}const s=await this.olmDevice.getOneTimeKeys(),n={};for(const t in s.curve25519)if(s.curve25519.hasOwnProperty(t)){const i={key:s.curve25519[t]};n["signed_curve25519:"+t]=i,e.push(this.signObject(i))}await Promise.all(e);const i=await this.baseApis.uploadKeysRequest({one_time_keys:n,"org.matrix.msc2732.fallback_keys":t});return await this.olmDevice.markKeysAsPublished(),i}downloadKeys(e,t){return this.deviceList.downloadKeys(e,t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerification(e,t,s,n,i){void 0===s&&(s=null),void 0===n&&(n=null),void 0===i&&(i=null);const a=this.deviceList.getStoredCrossSigningForUser(e);if(a&&a.getId()===t){if(null!==n||null!==i)throw new Error("Cannot set blocked or known for a cross-signing key");if(!s)throw new Error("Cannot set a cross-signing key as unverified");if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(a.keys),this.emit("userTrustStatusChanged",this.userId,this.checkUserTrust(e))),e!==this.userId){d.a.info("Master key "+a.getId()+" for "+e+" marked verified. Signing...");const s=await this.crossSigningInfo.signUser(a);if(s){const n=async({shouldEmit:i})=>{d.a.info("Uploading signature for "+e+"...");const a=await this.baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:o}=a||{};if(Object.keys(o||[]).length>0)throw i&&this.baseApis.emit("crypto.keySignatureUploadFailure",o,"setDeviceVerification",n),new x.c("Key upload failed",{failures:o})};await n({shouldEmit:!0})}return s}return a}const o=this.deviceList.getRawStoredDevicesForUser(e);if(!o||!o[t])throw new Error("Unknown device "+e+":"+t);const r=o[t];let c=r.verified;s?c=D.VERIFIED:null!==s&&c==D.VERIFIED&&(c=D.UNVERIFIED),n?c=D.BLOCKED:null!==n&&c==D.BLOCKED&&(c=D.UNVERIFIED);let l=r.known;if(null!==i&&(l=i),r.verified===c&&r.known===l||(r.verified=c,r.known=l,this.deviceList.storeDevicesForUser(e,o),this.deviceList.saveIfDirty()),s&&e===this.userId){let s;d.a.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?d.a.log(`Own device ${t} already cross-signing verified`):s=await this.crossSigningInfo.signDevice(e,p.a.fromStorage(r,t)),s){const n=async({shouldEmit:i})=>{d.a.info("Uploading signature for "+t);const a=await this.baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:o}=a||{};if(Object.keys(o||[]).length>0)throw i&&this.baseApis.emit("crypto.keySignatureUploadFailure",o,"setDeviceVerification",n),new x.c("Key upload failed",{failures:o})};await n({shouldEmit:!0})}}const h=p.a.fromStorage(r,t);return this.emit("deviceVerificationChanged",e,t,h),h}findVerificationRequestDMInProgress(e){return this.inRoomVerificationRequests.findRequestInProgress(e)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const s=this.inRoomVerificationRequests.findRequestInProgress(t);if(s)return Promise.resolve(s);const n=new k.a(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const s=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(s)return Promise.resolve(s);const n=new R.a(this.baseApis,e,t,R.a.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(e,t,s){let n=new O.l(t,this.verificationMethods,this.baseApis);t.transactionId&&s.setRequestByChannel(t,n),await n.sendRequest();const i=s.getRequestByChannel(t);return i?n=i:(d.a.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),s.setRequestByChannel(t,n)),n}beginKeyVerification(e,t,s,n=null){let i;if(n){if(i=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!i)throw new Error(`No request found for user ${t} with transactionId `+n)}else{n=R.a.makeTransactionId();const e=new R.a(this.baseApis,t,[s],n,s);i=new O.l(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,i)}return i.beginKeyVerification(e,{userId:t,deviceId:s})}async legacyDeviceVerification(e,t,s){const n=R.a.makeTransactionId(),i=new R.a(this.baseApis,e,[t],n,t),a=new O.l(i,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,a);const o=a.beginKeyVerification(s,{userId:e,deviceId:t});return await Promise.race([o.verify(),a.waitFor(e=>e.started)]),a}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],s={};for(let e=0;e<t.length;++e){const n=t[e],i=n.getIdentityKey(),a=await this.olmDevice.getSessionInfoForDevice(i);s[n.deviceId]={deviceIdKey:i,sessions:a}}return s}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),s=e.getWireContent().algorithm;if(!t||!s)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;const n=this.deviceList.getDeviceByIdentityKey(s,t);if(null===n)return null;const i=e.getClaimedEd25519Key();return i?i!==n.getFingerprint()?(d.a.warn("Event "+e.getId()+" claims ed25519 key "+i+" but sender device has key "+n.getFingerprint()),null):n:(d.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this.deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const s=e.getClaimedEd25519Key();return s||(d.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&s!==t.sender.getFingerprint()&&(d.a.warn("Event "+e.getId()+" claims ed25519 key "+s+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t}forceDiscardSession(e){const t=this.roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()}async setRoomEncryption(e,t,s){if(!t.algorithm)return void d.a.log("Ignoring setRoomEncryption with no algorithm");const n=this.roomList.getRoomEncryption(e);if(n&&JSON.stringify(n)!=JSON.stringify(t))return void d.a.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this.roomEncryptors[e])return;let i=null;n||(i=this.roomList.setRoomEncryption(e,t));const a=g.c[t.algorithm];if(!a)throw new Error("Unable to encrypt with "+t.algorithm);const o=new a({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e,config:t});this.roomEncryptors[e]=o,i&&await i,this.lazyLoadMembers?d.a.log("Enabling encryption in "+e):(d.a.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),s||this.deviceList.refreshOutdatedDeviceLists())}trackRoomDevices(e){const t=async()=>{if(!this.roomEncryptors[e])return;const t=this.clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room "+e);d.a.log(`Starting to track devices for room ${e} ...`);(await t.getEncryptionTargetMembers()).forEach(e=>{this.deviceList.startTrackingDeviceList(e.userId)})};let s=this.roomDeviceTrackingState[e];return s||(s=t(),this.roomDeviceTrackingState[e]=s.catch(t=>{throw this.roomDeviceTrackingState[e]=null,t})),s}ensureOlmSessionsForUsers(e,t){const s={};for(let t=0;t<e.length;++t){const n=e[t];s[n]=[];const i=this.getStoredDevicesForUser(n)||[];for(let e=0;e<i.length;++e){const t=i[e];t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(t.verified!=D.BLOCKED&&s[n].push(t))}}return u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,s,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[E.a.STORE_INBOUND_GROUP_SESSIONS],t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,t=>{if(null===t)return;const s=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete s.first_known_index,s.algorithm=u.MEGOLM_ALGORITHM,e.push(s)})}),e}importRoomKeys(e,t={}){let s=0,n=0;const i=e.length;function a(){t.progressCallback({stage:"load_keys",successes:s,failures:n,total:i})}return Promise.all(e.map(e=>{if(!e.room_id||!e.algorithm)return d.a.warn("ignoring room key entry with missing fields",e),n++,t.progressCallback&&a(),null;return this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally(()=>{s++,t.progressCallback&&a()})})).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors[e.roomId];t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const s=e.getRoomId(),n=this.roomEncryptors[s];if(!n)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this.roomDeviceTrackingState[s]||this.trackRoomDevices(s),await this.roomDeviceTrackingState[s];let i=e.getContent();const a=i["m.relates_to"];a&&(i=Object.assign({},i),delete i["m.relates_to"]);const o=i["io.element.performance_metrics"];o&&(i=Object.assign({},i),delete i["io.element.performance_metrics"]);const r=await n.encryptMessage(t,e.getType(),i);a&&(r["m.relates_to"]=a),o&&(r["io.element.performance_metrics"]=o),e.makeEncrypted("m.room.encrypted",r,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new P.b(e.getUnsigned().redacted_because),s=await this.decryptEvent(t);return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:s.clearEvent}}}}{const t=e.getWireContent(),s=this.getRoomDecryptor(e.getRoomId(),t.algorithm);return await s.decryptEvent(e)}}async handleDeviceListChanges(e,t){e.oldSyncToken&&await this.evalDeviceListChanges(t)}requestRoomKey(e,t,s=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,s).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(e=>{d.a.error("Error requesting key for event",e)})}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(e=>{d.a.warn("Error clearing pending room key requests",e)})}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e){const t=e.getRoomId(),s=e.getContent();try{await this.setRoomEncryption(t,s,!0)}catch(e){d.a.error("Error configuring encryption in room "+t+":",e)}}async onSyncWillProcess(e){e.oldSyncToken||(d.a.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){this.deviceList.setSyncToken(e.nextSyncToken),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach(e=>{this.deviceList.invalidateUserDeviceList(e)}),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach(e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)})}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const s=await t.getEncryptionTargetMembers();for(const t of s)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(e=>{if(!this.roomEncryptors[e.roomId])return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t})}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void d.a.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void d.a.error("key withheld event is missing fields");d.a.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const s=this.getRoomDecryptor(t.room_id,t.algorithm);if(s.onRoomKeyWithheldEvent&&s.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const s of e)s.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!R.a.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.toDeviceVerificationRequests,e=>{if(!R.a.canCreateRequest(R.a.getEventType(e)))return;const t=e.getContent(),s=t&&t.from_device;if(!s)return;const n=e.getSender(),i=new R.a(this.baseApis,n,[s]);return new O.l(i,this.verificationMethods,this.baseApis)})}async handleVerificationEvent(e,t,s,n=!0){if(e.isSending()&&e.status!=P.a.SENT){let t,s;try{await new Promise((n,i)=>{t=n,s=()=>{e.status==P.a.CANCELLED&&i(new Error("Event status set to CANCELLED."))},e.once("Event.localEventIdReplaced",t),e.on("Event.status",s)})}catch(e){return void d.a.error("error while waiting for the verification event to be sent: "+e.message)}finally{e.removeListener("Event.localEventIdReplaced",t),e.removeListener("Event.status",s)}}let i=t.getRequest(e),a=!1;if(!i){if(i=s(e),!i)return void d.a.log("Crypto: could not find VerificationRequest for "+e.getType()+", and could not create one, so ignoring.");a=!0,t.setRequest(e,i)}e.setVerificationRequest(i);try{await i.channel.handleEvent(e,i,n)}catch(e){d.a.error("error while handling verification event: "+e.message)}a&&!i.initiatedByMe&&!i.invalid&&!i.observeOnly&&this.baseApis.emit("crypto.verification.request",i)}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),s=e.getSender(),n=t.algorithm,i=t.sender_key,a=()=>{const e=this.getRoomDecryptors(u.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(i)};if(void 0===s||void 0===i||void 0===i)return;this.lastNewSessionForced[s]=this.lastNewSessionForced[s]||{};const o=this.lastNewSessionForced[s][i]||0;if(o+36e5>Date.now())return d.a.debug("New session already forced with device "+s+":"+i+" at "+o+": not forcing another"),await this.olmDevice.recordSessionProblem(i,"wedged",!0),void a();let r=this.deviceList.getDeviceByIdentityKey(n,i);if(!r&&(await this.downloadKeys([s],!1),r=this.deviceList.getDeviceByIdentityKey(n,i),!r))return d.a.info("Couldn't find device for identity key "+i+": not re-establishing session"),await this.olmDevice.recordSessionProblem(i,"wedged",!1),void a();const c={};c[s]=[r],await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,c,!0),this.lastNewSessionForced[s][i]=Date.now();const l={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await u.encryptMessageForDevice(l.ciphertext,this.userId,this.deviceId,this.olmDevice,s,r,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(i,"wedged",!0),a(),await this.baseApis.sendToDevice("m.room.encrypted",{[s]:{[r.deviceId]:l}});const h=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(s,r.deviceId);for(const e of h)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,s){const n=t.roomId,i=this.roomEncryptors[n];i&&(this.roomDeviceTrackingState[n]&&("join"==t.membership?(d.a.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this.clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(d.a.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,s))}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new B(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new V(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(e=>this.processReceivedRoomKeyRequest(e))),await Promise.all(t.map(e=>this.processReceivedRoomKeyRequestCancellation(e)))}catch(e){d.a.error("Error processing room key requsts: "+e)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,s=e.deviceId,n=e.requestBody,i=n.room_id,a=n.algorithm;if(d.a.log(`m.room_key_request from ${t}:${s} for ${i} / ${n.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors[i])return void d.a.debug("room key request for unencrypted room "+i);const e=this.roomEncryptors[i],a=this.deviceList.getStoredDevice(t,s);if(!a)return void d.a.debug(`Ignoring keyshare for unknown device ${t}:${s}`);try{await e.reshareKeyWithDevice(n.sender_key,n.session_id,t,a)}catch(e){d.a.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+a.deviceId,e)}return}if(s===this.deviceId)return void d.a.log("Ignoring room key request from ourselves");if(!this.roomDecryptors[i])return void d.a.log("room key request for unencrypted room "+i);const o=this.roomDecryptors[i][a];if(o)if(await o.hasKeysForKeyRequest(e)){if(e.share=()=>{o.shareKeysWithDevice(e)},this.checkDeviceTrust(t,s).isVerified())return d.a.log("device is already verified: sharing keys"),void e.share();this.emit("crypto.roomKeyRequest",e)}else d.a.log(`room key request for unknown session ${i} / `+n.session_id);else d.a.log(`room key request for unknown alg ${a} in room ${i}`)}async processReceivedRoomKeyRequestCancellation(e){d.a.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)}getRoomDecryptor(e,t){let s,n;if((e=e||null)&&(s=this.roomDecryptors[e],s||(this.roomDecryptors[e]=s={}),n=s[t],n))return n;const i=g.a[t];if(!i)throw new g.b("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new i({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e}),s&&(s[t]=n),n}getRoomDecryptors(e){const t=[];for(const s of Object.values(this.roomDecryptors))e in s&&t.push(s[e]);return t}async signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this.userId]=t[this.userId]||{},t[this.userId]["ed25519:"+this.deviceId]=await this.olmDevice.sign(r.a.stringify(e)),e.signatures=t,void 0!==s&&(e.unsigned=s)}}function F(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),e=>parseInt(e));return u.encodeBase64(t)}class B{constructor(e){a()(this,"userId",void 0),a()(this,"deviceId",void 0),a()(this,"requestId",void 0),a()(this,"requestBody",void 0),a()(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class V{constructor(e){a()(this,"userId",void 0),a()(this,"deviceId",void 0),a()(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,s(26),s(27).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n,i=s(99),a=s.n(i);!function(e){e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified"}(n||(n={}));class o{static fromStorage(e,t){const s=new o(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}constructor(e){this.deviceId=e,a()(this,"algorithms",void 0),a()(this,"keys",{}),a()(this,"verified",n.Unverified),a()(this,"known",!1),a()(this,"unsigned",{}),a()(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==n.Blocked}isVerified(){return this.verified==n.Verified}isUnverified(){return this.verified==n.Unverified}isKnown(){return!0===this.known}}a()(o,"DeviceVerification",{VERIFIED:n.Verified,UNVERIFIED:n.Unverified,BLOCKED:n.Blocked})},function(e,t,s){"use strict";s.d(t,"d",(function(){return a})),s.d(t,"a",(function(){return o})),s.d(t,"e",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return l})),s.d(t,"f",(function(){return d})),s.d(t,"g",(function(){return h}));var n=s(99),i=s.n(n);const a={},o={};class r{constructor(e){i()(this,"userId",void 0),i()(this,"deviceId",void 0),i()(this,"crypto",void 0),i()(this,"olmDevice",void 0),i()(this,"baseApis",void 0),i()(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,s){}}class c{constructor(e){i()(this,"userId",void 0),i()(this,"crypto",void 0),i()(this,"olmDevice",void 0),i()(this,"baseApis",void 0),i()(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}class l extends Error{constructor(e,t,s){super(t),this.code=e,i()(this,"detailedString",void 0),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let s=e.name+"[msg: "+e.message;t&&(s+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return s+="]",s}(this,s)}}class d extends Error{constructor(e,t){super(e),this.devices=t,this.name="UnknownDeviceError",this.devices=t}}function h(e,t,s){a[e]=t,o[e]=s}},function(e,t,s){"use strict";(function(e,n){s.d(t,"a",(function(){return u})),s.d(t,"c",(function(){return p})),s.d(t,"b",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"e",(function(){return f}));var i=s(99),a=s.n(i),o=s(5),r=s(149),c=s(1),l=s(174),d=s(252);function h(e){return Object.values(e.keys)[0]}class u extends o.EventEmitter{constructor(e,t={},s={}){super(),this.userId=e,this.callbacks=t,this.cacheCallbacks=s,a()(this,"keys",{}),a()(this,"firstUse",!0),a()(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const s=new u(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(t,s){const n=["master","self_signing","user_signing"].indexOf(t)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function i(t){if(!t)return;const n=new e.Olm.PkSigning,i=n.init_with_seed(t);if(i===s)return[i,n];n.free()}let a;void 0===s&&(s=this.getId(t)),this.cacheCallbacks.getCrossSigningKeyCache&&n&&(a=await this.cacheCallbacks.getCrossSigningKeyCache(t,s));const o=i(a);if(o)return o;a=await this.callbacks.getCrossSigningKey(t,s);const r=i(a);if(r)return this.cacheCallbacks.storeCrossSigningKeyCache&&n&&await this.cacheCallbacks.storeCrossSigningKeyCache(t,a),r;if(!a)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master",!1)||{};function s(e){for(const s of Object.keys(t))e[s]||delete t[s]}for(const t of["self_signing","user_signing"])s(await e.isStored("m.cross_signing."+t,!1)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[s,n]of e){const e=Object(r.encodeBase64)(n);await t.store("m.cross_signing."+s,e)}}static async getFromSecretStorage(e,t){const s=await t.get("m.cross_signing."+e);return s?Object(r.decodeBase64)(s):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const s=e?[e]:["master","self_signing","user_signing"];for(const e of s)if(!await t.getCrossSigningKeyCache(e))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const s of["master","self_signing","user_signing"]){const n=await t.getCrossSigningKeyCache(s);n&&e.set(s,n)}return e}getId(e="master"){if(!this.keys[e])return null;return h(this.keys[e])}async resetKeys(t){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&m.MASTER||!this.keys.master)t=m.MASTER|m.USER_SIGNING|m.SELF_SIGNING;else if(0===t)return;const s={},n={};let i,a;try{if(t&m.MASTER?(i=new e.Olm.PkSigning,s.master=i.generate_seed(),a=i.init_with_seed(s.master),n.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+a]:a}}):[a,i]=await this.getCrossSigningKey("master"),t&m.SELF_SIGNING){const t=new e.Olm.PkSigning;try{s.self_signing=t.generate_seed();const e=t.init_with_seed(s.self_signing);n.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(n.self_signing,i,this.userId,a)}finally{t.free()}}if(t&m.USER_SIGNING){const t=new e.Olm.PkSigning;try{s.user_signing=t.generate_seed();const e=t.init_with_seed(s.user_signing);n.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(n.user_signing,i,this.userId,a)}finally{t.free()}}Object.assign(this.keys,n),this.callbacks.saveCrossSigningKeys(s)}finally{i&&i.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw c.a.error(t),new Error(t)}this.keys.master?h(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const s=h(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw c.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.user_signing,s,this.userId)}catch(e){throw c.a.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw c.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.self_signing,s,this.userId)}catch(e){throw c.a.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[s,n]=await this.getCrossSigningKey(t);try{return Object(r.pkSign)(e,n,this.userId,s),e}finally{n.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");c.a.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");c.a.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new p(!0,!0,this.firstUse);if(!this.keys.user_signing)return new p(!1,!1,e.firstUse);let t;const s=e.keys.master,n=this.getId("user_signing");try{Object(r.pkVerify)(s,n,this.userId),t=!0}catch(e){t=!1}return new p(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,s,n){const i=this.checkUserTrust(e),a=e.keys.self_signing;if(!a)return new g(!1,!1,s,n);const o=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return Object(r.pkVerify)(a,e.getId(),e.userId),Object(r.pkVerify)(o,h(a),e.userId),g.fromUserTrustLevel(i,s,n)}catch(e){return new g(!1,!1,s,n)}}getCacheCallbacks(){return this.cacheCallbacks}}let m;!function(e){e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING"}(m||(m={}));class p{constructor(e,t,s){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=s}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class g{constructor(e,t,s,n){this.crossSigningVerified=e,this.tofu=t,this.localVerified=s,this.trustCrossSignedDevices=n}static fromUserTrustLevel(e,t,s){return new g(e.isCrossSigningVerified(),e.isTofu(),t,s)}isVerified(){return Boolean(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function v(e,t){return{getCrossSigningKeyCache:async function(s,i){const a=await new Promise(t=>e.doTxn("readonly",[l.a.STORE_ACCOUNT],n=>{e.getSecretStorePrivateKey(n,t,s)}));if(a&&a.ciphertext){const e=n.from(t.pickleKey),i=await Object(d.b)(a,e,s);return Object(r.decodeBase64)(i)}return a},storeCrossSigningKeyCache:async function(s,i){if(!(i instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got "+i);const a=n.from(t.pickleKey),o=await Object(d.c)(Object(r.encodeBase64)(i),a,s);return e.doTxn("readwrite",[l.a.STORE_ACCOUNT],t=>{e.storeSecretStorePrivateKey(t,s,o)})}}}function f(e,t,s){if(e.getUserId()===t)return c.a.log("Cross-signing: Self-verification done; requesting keys"),new Promise((t,n)=>{const i=e,a=i.crypto.crossSigningInfo,o=new u(a.userId,{getCrossSigningKey:async e=>{c.a.debug("Cross-signing: requesting secret",e,s);const{promise:t}=i.requestSecret("m.cross_signing."+e,[s]),n=await t,a=Object(r.decodeBase64)(n);return Uint8Array.from(a)}},a.getCacheCallbacks());o.keys=a.keys;const l=new Promise(e=>{setTimeout(e,6e4,new Error("Timeout"))}),d=(async()=>{if(!await i.crypto.getSessionBackupPrivateKey()){c.a.info("No cached backup key found. Requesting...");const e=i.requestSecret("m.megolm_backup.v1",[s]),t=await e.promise;c.a.info("Got key backup key, decoding...");const n=Object(r.decodeBase64)(t);c.a.info("Decoded backup key, storing..."),await i.crypto.storeSessionBackupPrivateKey(Uint8Array.from(n)),c.a.info("Backup key stored. Starting backup restore...");const a=await i.getKeyBackupVersion();i.restoreKeyBackupWithCache(void 0,void 0,a).then(()=>{c.a.info("Backup restored.")})}})();return Promise.race([Promise.all([o.getCrossSigningKey("master"),o.getCrossSigningKey("self_signing"),o.getCrossSigningKey("user_signing"),d]),l]).then(t,n)}).catch(e=>{c.a.warn("Cross-signing: failure while requesting keys:",e)})}}).call(this,s(26),s(27).Buffer)},function(e,t,s){"use strict";(function(e,n){s.d(t,"d",(function(){return d})),s.d(t,"c",(function(){return h})),s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return p}));var i=s(99),a=s.n(i),o=s(425),r=s(289),c=s(149),l=s(1);const d="m.qr_code.show.v1",h="m.qr_code.scan.v1";class u extends o.b{constructor(...e){super(...e),a()(this,"reciprocateQREvent",void 0),a()(this,"doVerification",async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw Object(r.d)();await new Promise((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(Object(r.h)())},this.emit("show_reciprocate_qr",this.reciprocateQREvent)});const t={};switch(e.mode){case m.VerifyOtherUser:{const s=e.otherUserMasterKey;t["ed25519:"+s]=s;break}case m.VerifySelfTrusted:{const s=this.request.targetDevice.deviceId;t["ed25519:"+s]=e.otherDeviceKey;break}case m.VerifySelfUntrusted:{const s=e.myMasterKey;t["ed25519:"+s]=s;break}}await this.verifyKeys(this.userId,t,(e,s,n)=>{const i=t[e];if(!i)throw Object(r.d)();if(n!==i)throw l.a.error("key ID from key info does not match"),Object(r.d)();for(const e in s.keys){if(!e.startsWith("ed25519"))continue;const n=t[e];if(!n)throw Object(r.d)();if(s.keys[e]!==n)throw l.a.error("master key does not match"),Object(r.d)()}})})}static factory(e,t,s,n,i,a){return new u(e,t,s,n,i,a)}static get NAME(){return"m.reciprocate.v1"}}var m;!function(e){e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted"}(m||(m={}));class p{constructor(e,t,s,n,i,a){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=s,this.otherDeviceKey=n,this.myMasterKey=i,this.buffer=a}static async create(e,t){const s=p.generateSharedSecret(),n=p.determineMode(e,t);let i=null,a=null,o=null;if(n===m.VerifyOtherUser){i=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(n===m.VerifySelfTrusted)a=await p.getOtherDeviceKey(e,t);else if(n===m.VerifySelfUntrusted){const e=t.getUserId();o=t.getStoredCrossSigningForUser(e).getId("master")}const r=p.generateQrData(e,t,n,s,i,a,o),c=p.generateBuffer(r);return new p(n,s,i,a,o,c)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),Object(c.encodeUnpaddedBase64)(t)}static async getOtherDeviceKey(e,t){const s=t.getUserId(),n=e.targetDevice,i=n?n.deviceId:null,a=t.getStoredDevice(s,i);if(!a)throw new Error("could not find device "+i);return a.getFingerprint()}static determineMode(e,t){const s=t.getUserId(),n=e.otherUserId;let i=m.VerifyOtherUser;if(s===n){i=t.checkUserTrust(s).isCrossSigningVerified()?m.VerifySelfTrusted:m.VerifySelfUntrusted}return i}static generateQrData(e,t,s,n,i,a,o){const r=t.getUserId(),c={prefix:"MATRIX",version:2,mode:s,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},l=t.getStoredCrossSigningForUser(r);return s===m.VerifyOtherUser?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=i):s===m.VerifySelfTrusted?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=a):s===m.VerifySelfUntrusted&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=o),c}static generateBuffer(e){let t=n.alloc(0);const s=e=>{const s=n.from([e]);t=n.concat([t,s])},i=(e,s,i=!0)=>{const a=n.from(e,s);i&&(e=>{const s=n.alloc(2);s.writeInt16BE(e,0),t=n.concat([t,s])})(a.byteLength),t=n.concat([t,a])},a=e=>{const s=Object(c.decodeBase64)(e),i=n.from(s);t=n.concat([t,i])};return i(e.prefix,"ascii",!1),s(e.version),s(e.mode),i(e.transactionId,"utf-8"),a(e.firstKeyB64),a(e.secondKeyB64),a(e.secretB64),t}}}).call(this,s(26),s(27).Buffer)},function(e,t,s){"use strict";(function(e,n){s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return c})),s.d(t,"a",(function(){return l}));var i=s(197),a=s(4);const o="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null;async function r(t,s){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return await l(s,t.private_key_salt,t.private_key_iterations,t.private_key_bits||256)}async function c(t){if(!e.Olm)throw new Error("Olm is not available");const s=Object(i.b)(32);return{key:await l(t,s,5e5,256),salt:s,iterations:5e5}}async function l(t,s,i,r=256){return o?async function(t,s,n,i){const a=e.crypto.subtle,o=e.TextEncoder;if(!a||!o)throw new Error("Password-based backup is not avaiable on this platform");const r=await a.importKey("raw",(new o).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),c=await a.deriveBits({name:"PBKDF2",salt:(new o).encode(s),iterations:n,hash:"SHA-512"},r,i);return new Uint8Array(c)}(t,s,i,r):async function(e,t,s,i){const o=Object(a.r)();if(!o)throw new Error("No usable crypto implementation");return o.pbkdf2Sync(e,n.from(t,"binary"),s,i,"sha512")}(t,s,i,r)}}).call(this,s(26),s(27).Buffer)},function(e,t,s){"use strict";(function(e,n){s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var i=s(1082),a=s.n(i);const o=[139,1];function r(t){const s=new e(o.length+t.length+1);s.set(o,0),s.set(t,o.length);let n=0;for(let e=0;e<s.length-1;++e)n^=s[e];s[s.length-1]=n;return a.a.encode(s).match(/.{1,4}/g).join(" ")}function c(e){const t=a.a.decode(e.replace(/ /g,""));let s=0;for(const e of t)s^=e;if(0!==s)throw new Error("Incorrect parity");for(let e=0;e<o.length;++e)if(t[e]!==o[e])throw new Error("Incorrect prefix");if(t.length!==o.length+n.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(o.length,o.length+n.Olm.PRIVATE_KEY_LENGTH))}}).call(this,s(27).Buffer,s(26))},function(e,t,s){"use strict";s.r(t),s.d(t,"makeHtmlMessage",(function(){return i})),s.d(t,"makeHtmlNotice",(function(){return a})),s.d(t,"makeHtmlEmote",(function(){return o})),s.d(t,"makeTextMessage",(function(){return r})),s.d(t,"makeNotice",(function(){return c})),s.d(t,"makeEmoteMessage",(function(){return l}));var n=s(94);function i(e,t){return{msgtype:n.b.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function a(e,t){return{msgtype:n.b.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function o(e,t){return{msgtype:n.b.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function r(e){return{msgtype:n.b.Text,body:e}}function c(e){return{msgtype:n.b.Notice,body:e}}function l(e){return{msgtype:n.b.Emote,body:e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return l}));var n=s(99),i=s.n(n),a=s(4),o=s(1);let r;!function(e){e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="org.matrix.msc3231.login.registration_token"}(r||(r={}));class c extends Error{constructor(e,t,s){super(e),this.required_stages=t,this.flows=s,i()(this,"name","NoAuthFlowFoundError")}}class l{constructor(e){var t;i()(this,"matrixClient",void 0),i()(this,"inputs",void 0),i()(this,"clientSecret",void 0),i()(this,"requestCallback",void 0),i()(this,"busyChangedCallback",void 0),i()(this,"stateUpdatedCallback",void 0),i()(this,"requestEmailTokenCallback",void 0),i()(this,"data",void 0),i()(this,"emailSid",void 0),i()(this,"requestingEmailToken",!1),i()(this,"attemptAuthDeferred",null),i()(this,"chosenFlow",null),i()(this,"currentStage",null),i()(this,"submitPromise",null),this.matrixClient=e.matrixClient,this.data=e.authData||{},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=null!==(t=e.emailSid)&&void 0!==t?t:null}attemptAuth(){var e;this.attemptAuthDeferred=Object(a.l)();const t=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&e.flows)this.startNextAuthStage();else{var s;null===(s=this.busyChangedCallback)||void 0===s||s.call(this,!0);let e=null;this.data.session&&(e={session:this.data.session}),this.doRequest(e).finally(()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)})}return t}async poll(){if(!this.data.session)return;if(!this.attemptAuthDeferred)return;if(this.submitPromise)return;let e={};if("m.login.email.identity"==this.currentStage&&this.emailSid){const t={sid:this.emailSid,client_secret:this.clientSecret};if(await this.matrixClient.doesServerRequireIdServerParam()){const e=new URL(this.matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:"m.login.email.identity",threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)}getSessionId(){return this.data?this.data.session:void 0}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e,t=!1){if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");var s;t||(null===(s=this.busyChangedCallback)||void 0===s||s.call(this,!0));for(;this.submitPromise;)try{await this.submitPromise}catch(e){}let n;this.data.session?(n={session:this.data.session},a.q(n,e)):n=e;try{this.submitPromise=this.doRequest(n,t),await this.submitPromise}finally{var i;if(this.submitPromise=null,!t)null===(i=this.busyChangedCallback)||void 0===i||i.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e,t=!1){try{const s=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(s),this.attemptAuthDeferred=null}catch(e){var s,n;const a=null!==(s=null===(n=e.data)||void 0===n?void 0:n.flows)&&void 0!==s?s:null,c=this.data.flows||Boolean(a);var i;if(401!==e.httpStatus||!e.data||!c)if(t)o.a.log("Background poll request failed doing UI auth: ignoring",e);else null===(i=this.attemptAuthDeferred)||void 0===i||i.reject(e);e.data.flows||e.data.completed||e.data.session||(e.data.flows=this.data.flows,e.data.completed=this.data.completed,e.data.session=this.data.session),this.data=e.data;try{this.startNextAuthStage()}catch(e){return this.attemptAuthDeferred.reject(e),void(this.attemptAuthDeferred=null)}if(!this.emailSid&&!this.requestingEmailToken&&this.chosenFlow.stages.includes(r.Email)){this.requestingEmailToken=!0;try{const e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,1,this.data.session);this.emailSid=e.sid}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null}finally{this.requestingEmailToken=!1}}}}startNextAuthStage(){const e=this.chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this.currentStage=e,e===r.Dummy)return void this.submitAuthDict({type:"m.login.dummy"});if(this.data&&this.data.errcode||this.data.error)return void this.stateUpdatedCallback(e,{errcode:this.data.errcode||"",error:this.data.error||""});const t={};"m.login.email.identity"==e&&(t.emailSid=this.emailSid),this.stateUpdatedCallback(e,t)}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),o.a.log("Active flow => %s",JSON.stringify(this.chosenFlow));const e=this.firstUncompletedStage(this.chosenFlow);return o.a.log("Next stage: %s",e),e}chooseFlow(){const e=this.data.flows||[],t=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),s=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(const n of e){let e=!1,i=!1;for(const t of n.stages)"m.login.email.identity"===t?e=!0:"m.login.msisdn"==t&&(i=!0);if(e==t&&i==s)return n}const n=[];throw t&&n.push("m.login.email.identity"),s&&n.push("m.login.msisdn"),new c("No appropriate authentication flow found",n,e)}firstUncompletedStage(e){const t=this.data.completed||[];for(let s=0;s<e.stages.length;++s){const n=e.stages[s];if(-1===t.indexOf(n))return n}}}},,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(83),i=s.n(n),a=s(288),o=s(4),r=s(86),c=s(295),l=s(131),d=s(84),h=s(90),u=s(89),m=s(660),p=s(1);let g;!function(e){e.Invited="invited",e.Error="error"}(g||(g={}));const v=["M_NOT_FOUND","M_USER_NOT_FOUND","M_PROFILE_UNDISCLOSED","M_PROFILE_NOT_FOUND"];class f{constructor(e,t){this.progressCallback=t,i()(this,"roomId",void 0),i()(this,"groupId",void 0),i()(this,"canceled",!1),i()(this,"addresses",[]),i()(this,"busy",!1),i()(this,"_fatal",!1),i()(this,"completionStates",{}),i()(this,"errors",{}),i()(this,"deferred",null),i()(this,"reason",null),"+"===e[0]?(this.roomId=null,this.groupId=e):(this.roomId=e,this.groupId=null)}get fatal(){return this._fatal}invite(e,t){if(this.addresses.length>0)throw new Error("Already inviting/invited");this.addresses.push(...e),this.reason=t;for(const e of this.addresses)null===Object(c.c)(e)&&(this.completionStates[e]=g.Error,this.errors[e]={errcode:"M_INVALID",errorText:Object(d.a)("Unrecognised address")});return this.deferred=Object(o.l)(),this.inviteMore(0),this.deferred.promise}cancel(){this.busy&&(this.canceled=!0,this.deferred.reject(new Error("canceled")))}getCompletionState(e){return this.completionStates[e]}getErrorText(e){return this.errors[e]?this.errors[e].errorText:null}async inviteToRoom(e,t,s=!1){const n=Object(c.c)(t);if(n===c.a.Email)return r.a.get().inviteByEmail(e,t);if(n===c.a.MatrixUserId){const n=r.a.get().getRoom(e);if(!n)throw new Error("Room not found");const i=n.getMember(t);if("join"===(null==i?void 0:i.membership))throw new a.c({errcode:"IO.ELEMENT.ALREADY_JOINED",error:"Member already joined"});if("invite"===(null==i?void 0:i.membership))throw new a.c({errcode:"IO.ELEMENT.ALREADY_INVITED",error:"Member already invited"});if(!s&&u.b.getValue("promptBeforeInviteUnknownUsers",this.roomId)){if(!await r.a.get().getProfileInfo(t))throw new Error("User has no profile")}return r.a.get().invite(e,t,void 0,this.reason)}throw new Error("Unsupported address")}doInvite(e,t=!1){return new Promise((s,n)=>{let i;p.a.log("Inviting "+e),i=null!==this.groupId?l.a.inviteUserToGroup(this.groupId,e):this.inviteToRoom(this.roomId,e,t),i.then(()=>{var t;this.canceled||(this.completionStates[e]=g.Invited,delete this.errors[e],s(),null===(t=this.progressCallback)||void 0===t||t.call(this))}).catch(i=>{if(this.canceled)return;let a;p.a.error(i);let o=!1;switch(i.errcode){case"M_FORBIDDEN":a=Object(d.a)("You do not have permission to invite people to this room."),o=!0;break;case"IO.ELEMENT.ALREADY_INVITED":a=Object(d.a)("User %(userId)s is already invited to the room",{userId:e});break;case"IO.ELEMENT.ALREADY_JOINED":a=Object(d.a)("User %(userId)s is already in the room",{userId:e});break;case"M_LIMIT_EXCEEDED":return void setTimeout(()=>{this.doInvite(e,t).then(s,n)},5e3);case"M_NOT_FOUND":case"M_USER_NOT_FOUND":a=Object(d.a)("User %(user_id)s does not exist",{user_id:e});break;case"M_PROFILE_UNDISCLOSED":a=Object(d.a)("User %(user_id)s may or may not exist",{user_id:e});break;case"M_PROFILE_NOT_FOUND":if(!t)return p.a.warn(`User ${e} does not have a profile - inviting anyways automatically`),void this.doInvite(e,!0).then(s,n);break;case"M_BAD_STATE":a=Object(d.a)("The user must be unbanned before they can be invited.");break;case"M_UNSUPPORTED_ROOM_VERSION":a=Object(d.a)("The user's homeserver does not support the version of the room.")}a||(a=Object(d.a)("Unknown server error")),this.completionStates[e]=g.Error,this.errors[e]={errorText:a,errcode:i.errcode},this.busy=!o,this._fatal=o,o?n(i):s()})})}inviteMore(e,t=!1){if(this.canceled)return;if(e===this.addresses.length){if(this.busy=!1,Object.keys(this.errors).length>0&&!this.groupId){const e=Object.keys(this.errors).filter(e=>v.includes(this.errors[e].errcode));if(e.length>0){const t=()=>{const t=e.map(e=>this.doInvite(e,!0));Promise.all(t).then(()=>this.deferred.resolve(this.completionStates))};return u.b.getValue("promptBeforeInviteUnknownUsers",this.roomId)?(p.a.log("Showing failed to invite dialog..."),void h.a.createTrackedDialog("Failed to invite","",m.a,{unknownProfileUsers:e.map(e=>({userId:e,errorText:this.errors[e].errorText})),onInviteAnyways:()=>t(),onGiveUp:()=>{for(const t of e)this.completionStates[t]=g.Invited;this.deferred.resolve(this.completionStates)}})):void t()}}return void this.deferred.resolve(this.completionStates)}const s=this.addresses[e];null!==Object(c.c)(s)&&this.completionStates[s]!==g.Invited?this.doInvite(s,t).then(()=>{this.inviteMore(e+1,t)}).catch(()=>this.deferred.resolve(this.completionStates)):this.inviteMore(e+1)}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(160),d=s(86),h=s(85),u=s(101);let m=Object(h.a)("views.elements.RoomAliasField")(n=class extends r.a.PureComponent{constructor(e,t){super(e,t),a()(this,"fieldRef",Object(o.createRef)()),a()(this,"onChange",e=>{this.props.onChange&&this.props.onChange(this.asFullAlias(e.target.value))}),a()(this,"onValidate",async e=>{const t=await this.validationRules(e);return this.setState({isValid:t.valid}),t}),a()(this,"validationRules",Object(l.a)({rules:[{key:"safeLocalpart",test:async({value:e})=>{if(!e)return!0;const t=this.asFullAlias(e);return!e.includes("#")&&!e.includes(":")&&!e.includes(",")&&encodeURI(t)===t},invalid:()=>Object(c.a)("Some characters not allowed")},{key:"required",test:async({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Please provide an address")},{key:"taken",final:!0,test:async({value:e})=>{if(!e)return!0;const t=d.a.get();try{return await t.getRoomIdForAlias(this.asFullAlias(e)),!1}catch(e){return!!e.errcode}},valid:()=>Object(c.a)("This address is available to use"),invalid:()=>Object(c.a)("This address is already in use")}]})),this.state={isValid:!0}}asFullAlias(e){return`#${e}:${this.props.domain}`}render(){const e=r.a.createElement("span",null,"#"),t=":"+this.props.domain,s=r.a.createElement("span",{title:t},t),n=255-this.props.domain.length-2;return r.a.createElement(u.a,{label:this.props.label||Object(c.a)("Room address"),className:"mx_RoomAliasField",prefixComponent:e,postfixComponent:s,ref:this.fieldRef,onValidate:this.onValidate,placeholder:this.props.placeholder||Object(c.a)("e.g. my-room"),onChange:this.onChange,value:this.props.value.substring(1,this.props.value.length-this.props.domain.length-1),maxLength:n,disabled:this.props.disabled,autoComplete:"off",onKeyDown:this.props.onKeyDown})}get isValid(){return this.state.isValid}validate(e){var t;return null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate(e)}focus(){var e;null===(e=this.fieldRef.current)||void 0===e||e.focus()}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(127),o=s(229);t.a=({label:e,labelInvite:t,labelPublic:s,labelRestricted:n,value:r,width:c=448,onChange:l})=>{const d=[i.a.createElement("div",{key:a.c.Invite,className:"mx_JoinRuleDropdown_invite"},t),i.a.createElement("div",{key:a.c.Public,className:"mx_JoinRuleDropdown_public"},s)];return n&&d.unshift(i.a.createElement("div",{key:a.c.Restricted,className:"mx_JoinRuleDropdown_restricted"},n)),i.a.createElement(o.a,{id:"mx_JoinRuleDropdown",className:"mx_JoinRuleDropdown",onOptionChange:l,menuWidth:c,value:r,label:e},d)}},function(e,t,s){"use strict";async function n(e,t,s){const n=new Promise(n=>{const i=setTimeout(n,s,t);e.then(()=>{clearTimeout(i)})});return Promise.race([e,n])}async function i(e,t,s){let n;for(let i=0;i<t;i++)try{return await e()}catch(e){if(s&&!s(e))throw e;n=e}throw n}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(110),i=s.n(n);let a;!function(e){e.Uniform="uniform",e.PowerLevel="powerlevel",e.MXID="mxid"}(a||(a={}));i.a.oneOf(Object.values(a))},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(94),h=s(707),u=s(183),m=s(161),p=s(98),g=s(85);let v=Object(g.a)("views.messages.SenderProfile")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"unmounted",!1),r()(this,"onRoomStateEvents",e=>{"m.room.related_groups"===e.getType()&&e.getRoomId()===this.props.mxEvent.getRoomId()&&this.updateRelatedGroups()});const t=this.props.mxEvent.getSender();this.state={userGroups:u.a.cachedPublicisedGroups(t)||[],relatedGroups:[]}}componentDidMount(){this.updateRelatedGroups(),0===this.state.userGroups.length&&this.getPublicisedGroups(),this.context.on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("RoomState.events",this.onRoomStateEvents)}async getPublicisedGroups(){const e=await u.a.getPublicisedGroupsCached(this.context,this.props.mxEvent.getSender());this.unmounted||this.setState({userGroups:e})}updateRelatedGroups(){const e=this.context.getRoom(this.props.mxEvent.getRoomId());if(!e)return;const t=e.currentState.getStateEvents("m.room.related_groups","");this.setState({relatedGroups:(null==t?void 0:t.getContent().groups)||[]})}getDisplayedGroups(e,t){let s=e||[];return s=t&&t.length>0?t.filter(e=>s.includes(e)):[],s}render(){var e,t,s;const{mxEvent:n}=this.props,i=Object(m.f)(this.props.userNameColorMode,n.getSender(),this.context.getRoom(this.props.mxEvent.getRoomId())),{msgtype:a}=n.getContent(),o=null===(e=n.sender)||void 0===e?void 0:e.disambiguate,r=(null===(t=n.sender)||void 0===t?void 0:t.rawDisplayName)||n.getSender()||"",c=(null===(s=n.sender)||void 0===s?void 0:s.userId)||n.getSender()||"";if(a===d.b.Emote)return null;let u,p;if(o&&(u=l.a.createElement("span",{className:"mx_SenderProfile_mxid"},c)),this.props.enableFlair){const e=this.getDisplayedGroups(this.state.userGroups,this.state.relatedGroups);p=l.a.createElement(h.a,{key:"flair",userId:n.getSender(),groups:e})}return l.a.createElement("div",{className:"mx_SenderProfile",dir:"auto",onClick:this.props.onClick},l.a.createElement("span",{className:"mx_SenderProfile_displayName "+i},r),u,p)}},r()(i,"contextType",p.a),n=a))||n},function(e,t,s){"use strict";function n(e){return e/10+"rem"}function i(e){return e+"px"}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return P})),s.d(t,"b",(function(){return D}));var n,i,a,o=s(95),r=s.n(o),c=s(83),l=s.n(c),d=s(82),h=s.n(d),u=s(117),m=s(94),p=s(86),g=s(87),v=s(84),f=s(90),b=s(479),y=s(89),E=s(138),S=s(167),_=s(168),w=s(85),C=s(417),O=s(722),k=s(92),R=s(738),I=s(495),x=s(383),T=s(384),j=s(118),N=s(154);function P(e){return e===u.a.QUEUED||e===u.a.NOT_SENT}let D=Object(w.a)("views.context_menus.MessageContextMenu")((a=i=class extends h.a.Component{constructor(...e){super(...e),l()(this,"context",void 0),l()(this,"state",{canRedact:!1,canPin:!1}),l()(this,"checkPermissions",()=>{const e=p.a.get(),t=e.getRoom(this.props.mxEvent.getRoomId()),s=t.currentState.maySendRedactionForEvent(this.props.mxEvent,e.credentials.userId)&&this.props.mxEvent.getType()!==m.a.RoomServerAcl&&this.props.mxEvent.getType()!==m.a.RoomEncryption;let n=t.currentState.mayClientSendStateEvent(m.a.RoomPinnedEvents,e);y.b.getValue("feature_pinning")||(n=!1),this.setState({canRedact:s,canPin:n})}),l()(this,"onResendReactionsClick",()=>{for(const e of this.getUnsentReactions())b.a.resend(e);this.closeMenu()}),l()(this,"onReportEventClick",()=>{f.a.createTrackedDialog("Report Event","",R.a,{mxEvent:this.props.mxEvent},"mx_Dialog_reportEvent"),this.closeMenu()}),l()(this,"onViewSourceClick",()=>{f.a.createTrackedDialog("View Event Source","",I.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource"),this.closeMenu()}),l()(this,"onRedactClick",()=>{const{mxEvent:e,onCloseDialog:t}=this.props;Object(x.a)({mxEvent:e,onCloseDialog:t}),this.closeMenu()}),l()(this,"onForwardClick",()=>{f.a.createTrackedDialog("Forward Message","",O.a,{matrixClient:p.a.get(),event:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),l()(this,"onPinClick",()=>{var e,t;const s=p.a.get(),n=s.getRoom(this.props.mxEvent.getRoomId()),i=this.props.mxEvent.getId(),a=(null==n||null===(e=n.currentState)||void 0===e||null===(t=e.getStateEvents(m.a.RoomPinnedEvents,""))||void 0===t?void 0:t.getContent().pinned)||[];var o,r;a.includes(i)?a.splice(a.indexOf(i),1):(a.push(i),s.setRoomAccountData(n.roomId,C.a,{event_ids:[...(null===(o=n.getAccountData(C.a))||void 0===o||null===(r=o.getContent())||void 0===r?void 0:r.event_ids)||[],i]}));s.sendStateEvent(this.props.mxEvent.getRoomId(),m.a.RoomPinnedEvents,{pinned:a},""),this.closeMenu()}),l()(this,"closeMenu",()=>{this.props.onFinished()}),l()(this,"onUnhidePreviewClick",()=>{var e;null===(e=this.props.eventTileOps)||void 0===e||e.unhideWidget(),this.closeMenu()}),l()(this,"onQuoteClick",()=>{g.a.dispatch({action:k.a.ComposerInsert,event:this.props.mxEvent,timelineRenderingType:this.context.timelineRenderingType}),this.closeMenu()}),l()(this,"onPermalinkClick",e=>{e.preventDefault(),f.a.createTrackedDialog("share room message dialog","",T.a,{target:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),l()(this,"onCollapseReplyChainClick",()=>{this.props.collapseReplyChain(),this.closeMenu()}),l()(this,"viewInRoom",()=>{g.a.dispatch({action:k.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()}),this.closeMenu()})}componentDidMount(){p.a.get().on("RoomMember.powerLevel",this.checkPermissions),this.checkPermissions()}componentWillUnmount(){const e=p.a.get();e&&e.removeListener("RoomMember.powerLevel",this.checkPermissions)}isPinned(){const e=p.a.get().getRoom(this.props.mxEvent.getRoomId()).currentState.getStateEvents(m.a.RoomPinnedEvents,"");if(!e)return!1;const t=e.getContent();return t.pinned&&Array.isArray(t.pinned)&&t.pinned.includes(this.props.mxEvent.getId())}getReactions(e){const t=p.a.get().getRoom(this.props.mxEvent.getRoomId()),s=this.props.mxEvent.getId();return t.getPendingEvents().filter(t=>{const n=t.getRelation();return(null==n?void 0:n.rel_type)===m.c.Annotation&&n.event_id===s&&e(t)})}getPendingReactions(){return this.getReactions(e=>P(e.status))}getUnsentReactions(){return this.getReactions(e=>e.status===u.a.NOT_SENT)}render(){var e,t;const s=p.a.get().getUserId(),n=this.props.mxEvent,i=n.status,a=this.getUnsentReactions().length;let o,c,l,d,m,g,f,b,y;const w=!i||i===u.a.SENT;n.isRedacted()||0!==a&&(o=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconResend",label:Object(v.a)("Resend %(unsentCount)s reaction(s)",{unsentCount:a}),onClick:this.onResendReactionsClick})),w&&this.state.canRedact&&(c=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconRedact",label:Object(v.a)("Remove"),onClick:this.onRedactClick})),Object(S.e)(n)&&(l=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconForward",label:Object(v.a)("Forward"),onClick:this.onForwardClick}),this.state.canPin&&(d=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconPin",label:this.isPinned()?Object(v.a)("Unpin"):Object(v.a)("Pin"),onClick:this.onPinClick})));const C=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconSource",label:Object(v.a)("View source"),onClick:this.onViewSourceClick});let O;this.props.eventTileOps&&this.props.eventTileOps.isWidgetHidden()&&(m=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconUnhidePreview",label:Object(v.a)("Show preview"),onClick:this.onUnhidePreviewClick})),this.props.permalinkCreator&&(O=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const k=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconPermalink",onClick:this.onPermalinkClick,label:Object(v.a)("Share"),element:"a",href:O,target:"_blank",rel:"noreferrer noopener"});let R;this.props.eventTileOps&&(f=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconQuote",label:Object(v.a)("Quote"),onClick:this.onQuoteClick})),"string"==typeof n.getContent().external_url&&Object(E.e)(n.getContent().external_url)&&(g=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconLink",onClick:this.closeMenu,label:Object(v.a)("Source URL"),element:"a",target:"_blank",rel:"noreferrer noopener",href:n.getContent().external_url})),this.props.collapseReplyChain&&(b=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconCollapse",label:Object(v.a)("Collapse reply thread"),onClick:this.onCollapseReplyChainClick})),n.getSender()!==s&&(R=h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconReport",label:Object(v.a)("Report"),onClick:this.onReportEventClick}));const{timelineRenderingType:I}=this.context,x=(I===j.a.Thread||I===j.a.ThreadsList)&&(null===(e=this.props.mxEvent)||void 0===e||null===(t=e.getThread())||void 0===t?void 0:t.rootEvent)===this.props.mxEvent,T=!N.d.instance.hasMaximisedWidget(p.a.get().getRoom(n.getRoomId())),P=h.a.createElement(_.c,null,x&&T&&h.a.createElement(_.b,{iconClassName:"mx_MessageContextMenu_iconViewInRoom",label:Object(v.a)("View in room"),onClick:this.viewInRoom}),f,l,d,k,R,g,m,C,o,b);return c&&(y=h.a.createElement(_.c,{red:!0},c)),h.a.createElement(_.e,r()({},this.props,{className:"mx_MessageContextMenu",compact:!0}),P,y)}},l()(i,"contextType",j.b),n=a))||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return a}));var n=s(116);function i(e,t){const s=[...e.keys()],i=[...t.keys()],a=Object(n.a)(s,i);return{changed:Object(n.k)(s,i).filter(s=>e.get(s)!==t.get(s)),added:a.added,removed:a.removed}}class a extends Map{constructor(e){super(e)}getOrCreate(e,t){return this.has(e)?this.get(e):(this.set(e,t),t)}remove(e){const t=this.get(e);return this.delete(e),t}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return O})),s.d(t,"b",(function(){return U}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(496),l=s(84),d=s(101),h=s(98),u=s(135),m=s(225),p=s(238),g=s(123),v=s(593),f=s(89),b=s(90),y=s(104),E=s(85),S=s(97),_=s(311),w=s(1);class C extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"onBack",()=>{this.state.message?this.setState({message:null}):this.props.onBack()}),a()(this,"onChange",e=>{this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})})}buttons(){return r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&r.a.createElement("button",{onClick:this.send},Object(l.a)("Send")))}textInput(e,t){return r.a.createElement(d.a,{id:e,label:t,size:42,autoFocus:!0,type:"text",autoComplete:"on",value:this.state[e],onChange:this.onChange})}}class O extends C{static getLabel(){return Object(l.a)("Send Custom Event")}constructor(e){super(e),a()(this,"send",async()=>{if(""===this.state.eventType)return void this.setState({message:Object(l.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.doSend(t),e=Object(l.a)("Event sent!")}catch(t){e=Object(l.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})});const{eventType:t,stateKey:s,evContent:n}=Object.assign({eventType:"",stateKey:"",evContent:"{\n\n}"},this.props.inputs);this.state={isStateEvent:Boolean(this.props.forceStateEvent),eventType:t,stateKey:s,evContent:n}}doSend(e){const t=this.context;return this.state.isStateEvent?t.sendStateEvent(this.props.room.roomId,this.state.eventType,e,this.state.stateKey):t.sendEvent(this.props.room.roomId,this.state.eventType,e)}render(){if(this.state.message)return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this.buttons());const e=!this.state.message&&!this.props.forceStateEvent&&!this.props.forceGeneralEvent;return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_DevTools_content"},r.a.createElement("div",{className:"mx_DevTools_eventTypeStateKeyGroup"},this.textInput("eventType",Object(l.a)("Event Type")),this.state.isStateEvent&&this.textInput("stateKey",Object(l.a)("State Key"))),r.a.createElement("br",null),r.a.createElement(d.a,{id:"evContent",label:Object(l.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this.onChange,element:"textarea"})),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&r.a.createElement("button",{onClick:this.send},Object(l.a)("Send")),e&&r.a.createElement("div",{style:{float:"right"}},r.a.createElement("input",{id:"isStateEvent",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",checked:this.state.isStateEvent,onChange:this.onChange}),r.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Event","data-tg-on":"State Event",htmlFor:"isStateEvent"}))))}}a()(O,"contextType",h.a);class k extends C{static getLabel(){return Object(l.a)("Send Account Data")}constructor(e){super(e),a()(this,"send",async()=>{if(""===this.state.eventType)return void this.setState({message:Object(l.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.doSend(t),e=Object(l.a)("Event sent!")}catch(t){e=Object(l.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})});const{eventType:t,evContent:s}=Object.assign({eventType:"",evContent:"{\n\n}"},this.props.inputs);this.state={isRoomAccountData:Boolean(this.props.isRoomAccountData),eventType:t,evContent:s}}doSend(e){const t=this.context;return this.state.isRoomAccountData?t.setRoomAccountData(this.props.room.roomId,this.state.eventType,e):t.setAccountData(this.state.eventType,e)}render(){return this.state.message?r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this.buttons()):r.a.createElement("div",null,r.a.createElement("div",{className:"mx_DevTools_content"},this.textInput("eventType",Object(l.a)("Event Type")),r.a.createElement("br",null),r.a.createElement(d.a,{id:"evContent",label:Object(l.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this.onChange,element:"textarea"})),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&r.a.createElement("button",{onClick:this.send},Object(l.a)("Send")),!this.state.message&&r.a.createElement("div",{style:{float:"right"}},r.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",checked:this.state.isRoomAccountData,disabled:this.props.forceMode,onChange:this.onChange}),r.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}a()(k,"contextType",h.a);class R extends r.a.PureComponent{static filterChildren(e,t){if(!t)return e;const s=t.toLowerCase();return e.filter(e=>e.key.toString().toLowerCase().includes(s))}constructor(e){super(e),a()(this,"showAll",()=>{this.setState({truncateAt:this.state.truncateAt+50})}),a()(this,"createOverflowElement",(e,t)=>r.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",onClick:this.showAll},Object(l.a)("and %(count)s others...",{count:e}))),a()(this,"onQuery",e=>{this.props.onChange&&this.props.onChange(e.target.value)}),a()(this,"getChildren",(e,t)=>this.state.filteredChildren.slice(e,t)),a()(this,"getChildCount",()=>this.state.filteredChildren.length),this.state={filteredChildren:R.filterChildren(this.props.children,this.props.query),truncateAt:20}}UNSAFE_componentWillReceiveProps(e){this.props.children===e.children&&this.props.query===e.query||this.setState({filteredChildren:R.filterChildren(e.children,e.query),truncateAt:20})}render(){return r.a.createElement("div",null,r.a.createElement(d.a,{label:Object(l.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:this.props.query,onChange:this.onQuery,className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query",key:this.props.children[0]?this.props.children[0].key:""}),r.a.createElement(_.a,{getChildren:this.getChildren,getChildCount:this.getChildCount,truncateAt:this.state.truncateAt,createOverflowElement:this.createOverflowElement}))}}class I extends r.a.PureComponent{static getLabel(){return Object(l.a)("Explore Room State")}constructor(e){super(e),a()(this,"roomStateEvents",void 0),a()(this,"onBack",()=>{this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.state.eventType?this.setState({eventType:null}):this.props.onBack()}),a()(this,"editEv",()=>{this.setState({editing:!0})}),a()(this,"onQueryEventType",e=>{this.setState({queryEventType:e})}),a()(this,"onQueryStateKey",e=>{this.setState({queryStateKey:e})}),this.roomStateEvents=this.props.room.currentState.events,this.state={eventType:null,event:null,editing:!1,queryEventType:"",queryStateKey:""}}browseEventType(e){return()=>{this.setState({eventType:e})}}onViewSourceClick(e){return()=>{this.setState({event:e})}}render(){if(this.state.event)return this.state.editing?r.a.createElement(O,{room:this.props.room,forceStateEvent:!0,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t"),stateKey:this.state.event.getStateKey()}}):r.a.createElement("div",{className:"mx_ViewSource"},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(c.a,{className:"json"},JSON.stringify(this.state.event.event,null,2))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),r.a.createElement("button",{onClick:this.editEv},Object(l.a)("Edit"))));let e=null;const t="mx_DevTools_RoomStateExplorer_button";if(null===this.state.eventType)e=r.a.createElement(R,{query:this.state.queryEventType,onChange:this.onQueryEventType},Array.from(this.roomStateEvents.entries()).map(([e,s])=>{let n;return n=1===s.size&&s.has("")?this.onViewSourceClick(s.get("")):this.browseEventType(e),r.a.createElement("button",{className:t,key:e,onClick:n},e)}));else{const s=this.roomStateEvents.get(this.state.eventType);e=r.a.createElement(R,{query:this.state.queryStateKey,onChange:this.onQueryStateKey},Array.from(s.entries()).map(([e,s])=>r.a.createElement("button",{className:t,key:e,onClick:this.onViewSourceClick(s)},e)))}return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},e),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}}a()(I,"contextType",h.a);class x extends r.a.PureComponent{static getLabel(){return Object(l.a)("Explore Account Data")}constructor(e){super(e),a()(this,"onBack",()=>{this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.props.onBack()}),a()(this,"onChange",e=>{this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})}),a()(this,"editEv",()=>{this.setState({editing:!0})}),a()(this,"onQueryEventType",e=>{this.setState({queryEventType:e})}),this.state={isRoomAccountData:!1,event:null,editing:!1,queryEventType:""}}getData(){return this.state.isRoomAccountData?this.props.room.accountData:this.context.store.accountData}onViewSourceClick(e){return()=>{this.setState({event:e})}}render(){if(this.state.event)return this.state.editing?r.a.createElement(k,{room:this.props.room,isRoomAccountData:this.state.isRoomAccountData,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t")},forceMode:!0}):r.a.createElement("div",{className:"mx_ViewSource"},r.a.createElement("div",{className:"mx_DevTools_content"},r.a.createElement(c.a,{className:"json"},JSON.stringify(this.state.event.event,null,2))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),r.a.createElement("button",{onClick:this.editEv},Object(l.a)("Edit"))));const e=[],t=this.getData();return Object.keys(t).forEach(s=>{const n=t[s];e.push(r.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:s,onClick:this.onViewSourceClick(n)},s))}),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(R,{query:this.state.queryEventType,onChange:this.onQueryEventType},e)),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),r.a.createElement("div",{style:{float:"right"}},r.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",checked:this.state.isRoomAccountData,onChange:this.onChange}),r.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}a()(x,"contextType",h.a);class T extends r.a.PureComponent{static getLabel(){return Object(l.a)("View Servers in Room")}constructor(e){super(e),a()(this,"servers",void 0),a()(this,"onQuery",e=>{this.setState({query:e})});const t=this.props.room,s=new Set;t.currentState.getStateEvents("m.room.member").forEach(e=>s.add(e.getSender().split(":")[1])),this.servers=Array.from(s).map(e=>r.a.createElement("button",{key:e,className:"mx_DevTools_ServersInRoomList_button"},e)),this.state={query:""}}render(){return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(R,{query:this.state.query,onChange:this.onQuery},this.servers)),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.props.onBack},Object(l.a)("Back"))))}}a()(T,"contextType",h.a);const j={[m.g]:"unsent",[m.e]:"requested",[m.d]:"ready",[m.c]:"done",[m.f]:"started",[m.b]:"cancelled"},N=({txnId:e,request:t})=>{const[,s]=Object(o.useState)(),[n,i]=Object(o.useState)(t.timeout);return Object(u.a)(t,"change",s),Object(o.useEffect)(()=>{if(0==t.timeout)return;const e=setInterval(()=>{i(t.timeout)},500);return()=>{clearInterval(e)}},[t]),r.a.createElement("div",{className:"mx_DevTools_VerificationRequest"},r.a.createElement("dl",null,r.a.createElement("dt",null,"Transaction"),r.a.createElement("dd",null,e),r.a.createElement("dt",null,"Phase"),r.a.createElement("dd",null,j[t.phase]||t.phase),r.a.createElement("dt",null,"Timeout"),r.a.createElement("dd",null,Math.floor(n/1e3)),r.a.createElement("dt",null,"Methods"),r.a.createElement("dd",null,t.methods&&t.methods.join(", ")),r.a.createElement("dt",null,"requestingUserId"),r.a.createElement("dd",null,t.requestingUserId),r.a.createElement("dt",null,"observeOnly"),r.a.createElement("dd",null,JSON.stringify(t.observeOnly))))};class P extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"onNewRequest",()=>{this.forceUpdate()})}static getLabel(){return Object(l.a)("Verification Requests")}componentDidMount(){this.context.on("crypto.verification.request",this.onNewRequest)}componentWillUnmount(){this.context.off("crypto.verification.request",this.onNewRequest)}render(){const e=this.context,t=this.props.room,s=(e.crypto.inRoomVerificationRequests._requestsByRoomId||new Map).get(t.roomId)||new Map;return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},Array.from(s.entries()).reverse().map(([e,t])=>r.a.createElement(N,{txnId:e,request:t,key:e}))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.props.onBack},Object(l.a)("Back"))))}}a()(P,"contextType",h.a);class D extends r.a.Component{static getLabel(){return Object(l.a)("Active Widgets")}constructor(e){super(e),a()(this,"onWidgetStoreUpdate",()=>{this.forceUpdate()}),a()(this,"onQueryChange",e=>{this.setState({query:e})}),a()(this,"onEditWidget",e=>{this.setState({editWidget:e})}),a()(this,"onBack",()=>{const e=p.a.instance.getApps(this.props.room.roomId);this.state.editWidget&&e.includes(this.state.editWidget)?this.setState({editWidget:null}):this.props.onBack()}),this.state={query:"",editWidget:null}}componentDidMount(){p.a.instance.on(g.b,this.onWidgetStoreUpdate)}componentWillUnmount(){p.a.instance.off(g.b,this.onWidgetStoreUpdate)}render(){const e=this.props.room,t=this.state.editWidget,s=p.a.instance.getApps(e.roomId);if(t&&s.includes(t)){const s=Array.from(Array.from(e.currentState.events.values()).map(e=>e.values())).reduce((e,t)=>(e.push(...t),e),[]).find(e=>e.getId()===t.eventId);return s?r.a.createElement(O,{onBack:this.onBack,room:e,forceStateEvent:!0,inputs:{eventType:s.getType(),evContent:JSON.stringify(s.getContent(),null,"\t"),stateKey:s.getStateKey()}}):r.a.createElement("div",null,Object(l.a)("There was an error finding this widget."),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(R,{query:this.state.query,onChange:this.onQueryChange},s.map(e=>r.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:e.url+e.eventId,onClick:()=>this.onEditWidget(e)},e.url)))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}}class M extends r.a.PureComponent{static getLabel(){return Object(l.a)("Settings Explorer")}constructor(e){super(e),a()(this,"onQueryChange",e=>{this.setState({query:e.target.value})}),a()(this,"onExplValuesEdit",e=>{this.setState({explicitValues:e.target.value})}),a()(this,"onExplRoomValuesEdit",e=>{this.setState({explicitRoomValues:e.target.value})}),a()(this,"onBack",()=>{this.state.editSetting?this.setState({editSetting:null}):this.state.viewSetting?this.setState({viewSetting:null}):this.props.onBack()}),a()(this,"onViewClick",(e,t)=>{e.preventDefault(),this.setState({viewSetting:t})}),a()(this,"onEditClick",(e,t)=>{e.preventDefault(),this.setState({editSetting:t,explicitValues:this.renderExplicitSettingValues(t,null),explicitRoomValues:this.renderExplicitSettingValues(t,this.props.room.roomId)})}),a()(this,"onSaveClick",async()=>{try{const e=this.state.editSetting,t=JSON.parse(this.state.explicitValues),s=JSON.parse(this.state.explicitRoomValues);for(const s of Object.keys(t)){w.a.log(`[Devtools] Setting value of ${e} at ${s} from user input`);try{const n=t[s];await f.b.setValue(e,null,s,n)}catch(e){w.a.warn(e)}}const n=this.props.room.roomId;for(const i of Object.keys(t)){w.a.log(`[Devtools] Setting value of ${e} at ${i} in ${n} from user input`);try{const t=s[i];await f.b.setValue(e,n,i,t)}catch(e){w.a.warn(e)}}this.setState({viewSetting:e,editSetting:null})}catch(e){b.a.createTrackedDialog("Devtools - Failed to save settings","",y.a,{title:Object(l.a)("Failed to save settings"),description:e.message})}}),this.state={query:"",editSetting:null,viewSetting:null,explicitValues:null,explicitRoomValues:null}}renderSettingValue(e){return["boolean","number"].includes(typeof e)?e.toString():JSON.stringify(e)}renderExplicitSettingValues(e,t){const s={};for(const n of f.a)try{s[n]=f.b.getValueAt(n,e,t,!0,!0),void 0===s[n]&&(s[n]=null)}catch(e){w.a.warn(e)}return JSON.stringify(s,null,4)}renderCanEditLevel(e,t){const s=f.b.canSetValue(this.state.editSetting,e,t),n=s?"mx_DevTools_SettingsExplorer_mutable":"mx_DevTools_SettingsExplorer_immutable";return r.a.createElement("td",{className:n},r.a.createElement("code",null,s.toString()))}render(){const e=this.props.room;if(!this.state.viewSetting&&!this.state.editSetting){const t=Object.keys(v.b).filter(e=>!this.state.query||e.toLowerCase().includes(this.state.query.toLowerCase()));return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content mx_DevTools_SettingsExplorer"},r.a.createElement(d.a,{label:Object(l.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:this.state.query,onChange:this.onQueryChange,className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query"}),r.a.createElement("table",null,r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,Object(l.a)("Setting ID")),r.a.createElement("th",null,Object(l.a)("Value")),r.a.createElement("th",null,Object(l.a)("Value in this room")))),r.a.createElement("tbody",null,t.map(t=>r.a.createElement("tr",{key:t},r.a.createElement("td",null,r.a.createElement("a",{href:"",onClick:e=>this.onViewClick(e,t)},r.a.createElement("code",null,t)),r.a.createElement("a",{href:"",onClick:e=>this.onEditClick(e,t),className:"mx_DevTools_SettingsExplorer_edit"},"✏")),r.a.createElement("td",null,r.a.createElement("code",null,this.renderSettingValue(f.b.getValue(t)))),r.a.createElement("td",null,r.a.createElement("code",null,this.renderSettingValue(f.b.getValue(t,e.roomId))))))))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}return this.state.editSetting?r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content mx_DevTools_SettingsExplorer"},r.a.createElement("h3",null,Object(l.a)("Setting:")," ",r.a.createElement("code",null,this.state.editSetting)),r.a.createElement("div",{className:"mx_DevTools_SettingsExplorer_warning"},r.a.createElement("b",null,Object(l.a)("Caution:"))," ",Object(l.a)("This UI does NOT check the types of the values. Use at your own risk.")),r.a.createElement("div",null,Object(l.a)("Setting definition:"),r.a.createElement("pre",null,r.a.createElement("code",null,JSON.stringify(v.b[this.state.editSetting],null,4)))),r.a.createElement("div",null,r.a.createElement("table",null,r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,Object(l.a)("Level")),r.a.createElement("th",null,Object(l.a)("Settable at global")),r.a.createElement("th",null,Object(l.a)("Settable at room")))),r.a.createElement("tbody",null,f.a.map(t=>r.a.createElement("tr",{key:t},r.a.createElement("td",null,r.a.createElement("code",null,t)),this.renderCanEditLevel(null,t),this.renderCanEditLevel(e.roomId,t)))))),r.a.createElement("div",null,r.a.createElement(d.a,{id:"valExpl",label:Object(l.a)("Values at explicit levels"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:this.state.explicitValues,onChange:this.onExplValuesEdit})),r.a.createElement("div",null,r.a.createElement(d.a,{id:"valExpl",label:Object(l.a)("Values at explicit levels in this room"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:this.state.explicitRoomValues,onChange:this.onExplRoomValuesEdit}))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onSaveClick},Object(l.a)("Save setting values")),r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")))):this.state.viewSetting?r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content mx_DevTools_SettingsExplorer"},r.a.createElement("h3",null,Object(l.a)("Setting:")," ",r.a.createElement("code",null,this.state.viewSetting)),r.a.createElement("div",null,Object(l.a)("Setting definition:"),r.a.createElement("pre",null,r.a.createElement("code",null,JSON.stringify(v.b[this.state.viewSetting],null,4)))),r.a.createElement("div",null,Object(l.a)("Value:")," ",r.a.createElement("code",null,this.renderSettingValue(f.b.getValue(this.state.viewSetting)))),r.a.createElement("div",null,Object(l.a)("Value in this room:")," ",r.a.createElement("code",null,this.renderSettingValue(f.b.getValue(this.state.viewSetting,e.roomId)))),r.a.createElement("div",null,Object(l.a)("Values at explicit levels:"),r.a.createElement("pre",null,r.a.createElement("code",null,this.renderExplicitSettingValues(this.state.viewSetting,null)))),r.a.createElement("div",null,Object(l.a)("Values at explicit levels in this room:"),r.a.createElement("pre",null,r.a.createElement("code",null,this.renderExplicitSettingValues(this.state.viewSetting,e.roomId))))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:e=>this.onEditClick(e,this.state.viewSetting)},Object(l.a)("Edit Values")),r.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")))):void 0}}const A=[O,I,k,x,T,P,D,M];let U=Object(E.a)("views.dialogs.DevtoolsDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onBack",()=>{this.setState({mode:null})}),a()(this,"onCancel",()=>{this.props.onFinished(!1)}),this.state={mode:null}}setMode(e){return()=>{this.setState({mode:e})}}render(){let e;if(this.state.mode)e=r.a.createElement(h.a.Consumer,null,e=>r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_DevTools_label_left"},this.state.mode.getLabel()),r.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),r.a.createElement("div",{className:"mx_DevTools_label_bottom"}),r.a.createElement(this.state.mode,{onBack:this.onBack,room:e.getRoom(this.props.roomId)})));else{const t="mx_DevTools_RoomStateExplorer_button";e=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",null,r.a.createElement("div",{className:"mx_DevTools_label_left"},Object(l.a)("Toolbox")),r.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),r.a.createElement("div",{className:"mx_DevTools_label_bottom"}),r.a.createElement("div",{className:"mx_Dialog_content"},A.map(e=>{const s=e.getLabel(),n=this.setMode(e);return r.a.createElement("button",{className:t,key:s,onClick:n},s)}))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onCancel},Object(l.a)("Cancel"))))}return r.a.createElement(S.a,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:Object(l.a)("Developer Tools")},e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(83),i=s.n(n),a=s(1479),o=s.n(a),r=s(121),c=s(93),l=s(89),d=s(86),h=s(1);let u;!function(e){e[e.Disabled=0]="Disabled",e[e.Anonymous=1]="Anonymous",e[e.Pseudonymous=2]="Pseudonymous"}(u||(u={}));const m=new Set(["register","login","forgot_password","soft_logout","new","settings","welcome","home","start","directory","start_sso","start_cas","groups","complete_security","post_registration","room","user","group"]);class p{static get instance(){return this._instance||(this._instance=new p(o.a)),this._instance}constructor(e){this.posthog=e,i()(this,"anonymity",u.Disabled),i()(this,"enabled",!1),i()(this,"platformSuperProperties",{}),i()(this,"sanitizeProperties",e=>(e.$redacted_current_url||h.a.log("$redacted_current_url not set in sanitizeProperties, will drop $current_url entirely"),e.$current_url=e.$redacted_current_url,delete e.$redacted_current_url,this.anonymity==u.Anonymous&&(e.$referrer=null,e.$referring_domain=null,e.$initial_referrer=null,e.$initial_referring_domain=null,e.$device_id=null),e));const t=c.a.get().posthog;t?(this.posthog.init(t.projectApiKey,{api_host:t.apiHost,autocapture:!1,mask_all_text:!0,mask_all_element_attributes:!0,capture_pageview:!1,sanitize_properties:this.sanitizeProperties,respect_dnt:!0,advanced_disable_decide:!0}),this.enabled=!0):this.enabled=!1}static getAnonymityFromSettings(){const e=l.b.getValue("analyticsOptIn",null,!0);let t;return t=l.b.getValue("feature_pseudonymous_analytics_opt_in",null,!0)?u.Pseudonymous:e?u.Anonymous:u.Disabled,t}registerSuperProperties(e){this.enabled&&this.posthog.register(e)}static async getPlatformProperties(){const e=r.a.get();let t;try{t=await e.getAppVersion()}catch(e){t="unknown"}return{appVersion:t,appPlatform:e.getHumanReadableName()}}async capture(e,t){if(!this.enabled)return;const{origin:s,hash:n,pathname:i}=window.location;t.$redacted_current_url=await async function(e,t,s,n){let i;if(e.startsWith("file://")&&(s="/<redacted_file_scheme_url>/"),""==t)i="";else{let[e,s]=t.split("/");m.has(s)||(s="<redacted_screen_name>"),i=`${e}/${s}/<redacted>`}return e+s+i}(s,n,i,this.anonymity),this.posthog.capture(e,t)}isEnabled(){return this.enabled}setAnonymity(e){!this.enabled||e!=u.Disabled&&e!=u.Anonymous||(this.posthog.reset(),this.registerSuperProperties(this.platformSuperProperties)),this.anonymity=e}static getRandomAnalyticsId(){return[...crypto.getRandomValues(new Uint8Array(16))].map(e=>e.toString(16)).join("")}async identifyUser(e,t){if(this.anonymity==u.Pseudonymous)try{const s=await e.getAccountDataFromServer(p.ANALYTICS_ID_EVENT_TYPE);let n=null==s?void 0:s.id;n||(n=t(),await e.setAccountData("im.vector.web.analytics_id",{id:n})),this.posthog.identify(n)}catch(e){h.a.log("Unable to identify user for tracking"+e.toString())}}getAnonymity(){return this.anonymity}logout(){this.enabled&&this.posthog.reset(),this.setAnonymity(u.Anonymous)}async trackPseudonymousEvent(e,t={}){this.anonymity!=u.Anonymous&&this.anonymity!=u.Disabled&&await this.capture(e,t)}async trackAnonymousEvent(e,t={}){this.anonymity!=u.Disabled&&await this.capture(e,t)}async trackPageView(e){let t=null;const s=window.location.hash.split("/");s.length>=2&&(t=s[1]),await this.trackAnonymousEvent("$pageview",{durationMs:e,screen:t})}async updatePlatformSuperProperties(){this.platformSuperProperties=await p.getPlatformProperties(),this.registerSuperProperties(this.platformSuperProperties)}async updateAnonymityFromSettings(e){this.setAnonymity(p.getAnonymityFromSettings()),e&&this.getAnonymity()==u.Pseudonymous&&await this.identifyUser(d.a.get(),p.getRandomAnalyticsId)}}i()(p,"_instance",null),i()(p,"ANALYTICS_ID_EVENT_TYPE","im.vector.web.analytics_id")},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(110),i=s.n(n);let a;!function(e){e.Compact="compact",e.Intermediate="intermediate",e.Roomy="roomy"}(a||(a={}));i.a.oneOf(Object.values(a))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r}));const n={w:800,h:600},i={w:324,h:324},a={w:182.25,h:324};let o;function r(e,t=!1){switch(e){case o.Large:return n;case o.Normal:default:return t?a:i}}!function(e){e.Normal="normal",e.Large="large"}(o||(o={}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return m}));var n,i=s(82),a=s.n(i),o=s(84),r=s(86),c=s(90),l=s(85),d=s(104),h=s(497);let u=Object(l.a)("views.dialogs.ConfirmRedactDialog")(n=class extends a.a.Component{render(){return a.a.createElement(h.a,{onFinished:this.props.onFinished,title:Object(o.a)("Confirm Removal"),description:Object(o.a)("Are you sure you wish to remove (delete) this event? Note that if you delete a room name or topic change, it could undo the change."),placeholder:Object(o.a)("Reason (optional)"),focus:!0,button:Object(o.a)("Remove")})}})||n;function m({mxEvent:e,onCloseDialog:t=(()=>{})}){c.a.createTrackedDialog("Confirm Redact Dialog","",u,{onFinished:async(s,n)=>{if(!s)return;const i=r.a.get();try{null==t||t(),await i.redactEvent(e.getRoomId(),e.getId(),void 0,n?{reason:n}:{})}catch(e){const t=e.errcode||e.statusCode;void 0!==t&&c.a.createTrackedDialog("You cannot delete this message","",d.a,{title:Object(o.a)("Error"),description:Object(o.a)("You cannot delete this message. (%(code)s)",{code:t})})}}},"mx_Dialog_confirmredact")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s(110),d=s(194),h=s(223),u=s(249),m=s(181),p=s(117),g=s(84),v=s(498),f=s(120),b=s(105),y=s(143),E=s(137),S=s(111),_=s(89),w=s(115),C=s(85),O=s(97),k=s(314);function R(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function I(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?R(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):R(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const x=[{name:"Facebook",img:s(1501),url:e=>"https://www.facebook.com/sharer/sharer.php?u="+e},{name:"Twitter",img:s(1502),url:e=>"https://twitter.com/home?status="+e},{name:"LinkedIn",img:s(1503),url:e=>"https://www.linkedin.com/shareArticle?mini=true&url="+e},{name:"Reddit",img:s(1504),url:e=>"http://www.reddit.com/submit?url="+e},{name:"email",img:s(1505),url:e=>"mailto:?body="+e}];let T=Object(C.a)("views.dialogs.ShareDialog")((a=i=class e extends c.PureComponent{constructor(e){super(e),r()(this,"closeCopiedTooltip",void 0),this.onCopyClick=this.onCopyClick.bind(this),this.onLinkSpecificEventCheckboxClick=this.onLinkSpecificEventCheckboxClick.bind(this);let t=null;e.target instanceof d.b&&(t=new f.a(e.target),t.load()),this.state={linkSpecificEvent:this.props.target instanceof p.b,permalinkCreator:t}}static onLinkClick(e){e.preventDefault(),Object(y.d)(e.target)}async onCopyClick(e){e.preventDefault();const t=e.target,s=await Object(y.c)(this.getUrl()),n=t.getBoundingClientRect(),{close:i}=b.m(k.a,I(I({},Object(b.o)(n,2)),{},{message:s?Object(g.a)("Copied!"):Object(g.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=i}onLinkSpecificEventCheckboxClick(){this.setState({linkSpecificEvent:!this.state.linkSpecificEvent})}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}getUrl(){let e;if(this.props.target instanceof d.b)if(this.state.linkSpecificEvent){const t=this.props.target.getLiveTimeline().getEvents();e=this.state.permalinkCreator.forEvent(t[t.length-1].getId())}else e=this.state.permalinkCreator.forShareableRoom();else this.props.target instanceof h.a||this.props.target instanceof m.a?e=Object(f.h)(this.props.target.userId):this.props.target instanceof u.a?e=Object(f.f)(this.props.target.groupId):this.props.target instanceof p.b&&(e=this.state.linkSpecificEvent?this.props.permalinkCreator.forEvent(this.props.target.getId()):this.props.permalinkCreator.forShareableRoom());return e}render(){let t,s;if(this.props.target instanceof d.b){t=Object(g.a)("Share Room");this.props.target.getLiveTimeline().getEvents().length>0&&(s=c.createElement("div",null,c.createElement(E.b,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(g.a)("Link to most recent message"))))}else this.props.target instanceof h.a||this.props.target instanceof m.a?t=Object(g.a)("Share User"):this.props.target instanceof u.a?t=Object(g.a)("Share Community"):this.props.target instanceof p.b&&(t=Object(g.a)("Share Room Message"),s=c.createElement("div",null,c.createElement(E.b,{checked:this.state.linkSpecificEvent,onClick:this.onLinkSpecificEventCheckboxClick},Object(g.a)("Link to selected message"))));const n=this.getUrl(),i=encodeURIComponent(n),a=_.b.getValue(w.b.ShareQRCode),o=_.b.getValue(w.b.ShareSocial);let r;return(a||o)&&(r=c.createElement(c.Fragment,null,c.createElement("hr",null),c.createElement("div",{className:"mx_ShareDialog_split"},a&&c.createElement("div",{className:"mx_ShareDialog_qrcode_container"},c.createElement(v.a,{data:n,width:256})),o&&c.createElement("div",{className:"mx_ShareDialog_social_container"},x.map(e=>c.createElement("a",{rel:"noreferrer noopener",target:"_blank",key:e.name,title:e.name,href:e.url(i),className:"mx_ShareDialog_social_icon"},c.createElement("img",{src:e.img,alt:e.name,height:64,width:64}))))))),c.createElement(O.a,{title:t,className:"mx_ShareDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},c.createElement("div",{className:"mx_ShareDialog_content"},c.createElement("div",{className:"mx_ShareDialog_matrixto"},c.createElement("a",{href:n,onClick:e.onLinkClick,className:"mx_ShareDialog_matrixto_link"},n),c.createElement(S.a,{title:Object(g.a)("Copy"),onClick:this.onCopyClick,className:"mx_ShareDialog_matrixto_copy"})),s,r))}},r()(i,"propTypes",{onFinished:l.func.isRequired,target:l.oneOfType([l.instanceOf(d.b),l.instanceOf(h.a),l.instanceOf(u.a),l.instanceOf(m.a),l.instanceOf(p.b)]).isRequired}),n=a))||n},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(107),h=s(87),u=s(91),m=s.n(u),p=s(194),g=s(181),v=s(110),f=s.n(v),b=s(86),y=s(183),E=s(120),S=s(98),_=s(92),w=s(103),C=s(150),O=s(85),k=s(1);let R=Object(O.a)("views.elements.Pill")((a=i=class e extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{resourceId:null,pillType:null,member:null,group:null,room:null,hover:!1}),r()(this,"onMouseOver",()=>{this.setState({hover:!0})}),r()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),r()(this,"onUserPillClicked",e=>{e.preventDefault(),h.a.dispatch({action:_.a.ViewUser,member:this.state.member})})}static roomNotifPos(e){return e.indexOf("@room")}static roomNotifLen(){return"@room".length}async UNSAFE_componentWillReceiveProps(t){let s,n;if(t.url)if(t.inMessage){const e=Object(E.i)(t.url);s=e.primaryEntityId,n=e.sigil}else s=Object(E.c)(t.url),n=s?s[0]:void 0;const i=this.props.type||{"@":e.TYPE_USER_MENTION,"#":e.TYPE_ROOM_MENTION,"!":e.TYPE_ROOM_MENTION,"+":e.TYPE_GROUP_MENTION}[n];let a,o,r;switch(i){case e.TYPE_AT_ROOM_MENTION:r=t.room;break;case e.TYPE_USER_MENTION:{const e=t.room?t.room.getMember(s):void 0;a=e,e||(a=new g.a(null,s),this.doProfileLookup(s,a))}break;case e.TYPE_ROOM_MENTION:{const e="#"===s[0]?b.a.get().getRooms().find(e=>e.getCanonicalAlias()===s||e.getAltAliases().includes(s)):b.a.get().getRoom(s);r=e}break;case e.TYPE_GROUP_MENTION:{const e=b.a.get();try{o=await y.a.getGroupProfileCached(e,s)}catch(e){o={groupId:s,avatarUrl:null,name:null}}}}this.setState({resourceId:s,pillType:i,member:a,group:o,room:r})}componentDidMount(){this._unmounted=!1,this._matrixClient=b.a.get(),this.UNSAFE_componentWillReceiveProps(this.props)}componentWillUnmount(){this._unmounted=!0}doProfileLookup(e,t){b.a.get().getProfileInfo(e).then(e=>{this._unmounted||(t.name=e.displayname,t.rawDisplayName=e.displayname,t.events.member={getContent:()=>({avatar_url:e.avatar_url}),getDirectionalContent:function(){return this.getContent()}},this.setState({member:t}))}).catch(t=>{k.a.error("Could not retrieve profile data for "+e+":",t)})}render(){const t=d.getComponent("views.avatars.BaseAvatar"),s=d.getComponent("avatars.MemberAvatar"),n=d.getComponent("avatars.RoomAvatar"),i=this.state.resourceId;let a,o,r,c=null,h=i,u=this.props.url;switch(this.state.pillType){case e.TYPE_AT_ROOM_MENTION:{const e=this.props.room;e&&(h="@room",this.props.shouldShowPillAvatar&&(c=l.a.createElement(n,{room:e,width:16,height:16,"aria-hidden":"true"})),a="mx_AtRoomPill")}break;case e.TYPE_USER_MENTION:{const e=this.state.member;e&&(o=e.userId,e.rawDisplayName=e.rawDisplayName||"",h=e.rawDisplayName,this.props.shouldShowPillAvatar&&(c=l.a.createElement(s,{member:e,width:16,height:16,"aria-hidden":"true"})),a="mx_UserPill",u=null,r=this.onUserPillClicked)}break;case e.TYPE_ROOM_MENTION:{const e=this.state.room;e&&(h=e.name||i,this.props.shouldShowPillAvatar&&(c=l.a.createElement(n,{room:e,width:16,height:16,"aria-hidden":"true"}))),a="mx_RoomPill"}break;case e.TYPE_GROUP_MENTION:if(this.state.group){const{avatarUrl:e,groupId:s,name:n}=this.state.group;h=s,this.props.shouldShowPillAvatar&&(c=l.a.createElement(t,{name:n||s,width:16,height:16,"aria-hidden":"true",url:e?Object(w.b)(e).getSquareThumbnailHttp(16):null})),a="mx_GroupPill"}}const p=m()("mx_Pill",a,{mx_UserPill_me:o===b.a.get().getUserId(),mx_UserPill_selected:this.props.isSelected});if(this.state.pillType){const{yOffset:e}=this.props;let t;return this.state.hover&&i&&(t=l.a.createElement(C.b,{label:i,yOffset:e})),l.a.createElement(S.a.Provider,{value:this._matrixClient},this.props.inMessage?l.a.createElement("a",{className:p,href:u,onClick:r,"data-offset-key":this.props.offsetKey,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},c,h,t):l.a.createElement("span",{className:p,"data-offset-key":this.props.offsetKey,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},c,h,t))}return null}},r()(i,"TYPE_USER_MENTION","TYPE_USER_MENTION"),r()(i,"TYPE_ROOM_MENTION","TYPE_ROOM_MENTION"),r()(i,"TYPE_GROUP_MENTION","TYPE_GROUP_MENTION"),r()(i,"TYPE_AT_ROOM_MENTION","TYPE_AT_ROOM_MENTION"),r()(i,"propTypes",{type:f.a.string,url:f.a.string,inMessage:f.a.bool,room:f.a.instanceOf(p.b),shouldShowPillAvatar:f.a.bool,isSelected:f.a.bool}),n=a))||n;t.a=R},function(e,t,s){"use strict";s.d(t,"b",(function(){return c}));var n=s(82),i=s.n(n),a=s(94),o=s(135),r=s(138);const c=e=>{var t,s,n;return null==e||null===(t=e.currentState)||void 0===t||null===(s=t.getStateEvents(a.a.RoomTopic,""))||void 0===s||null===(n=s.getContent())||void 0===n?void 0:n.topic};t.a=({room:e,children:t})=>{const[s,a]=Object(n.useState)(c(e));Object(o.a)(e.currentState,"RoomState.events",()=>{a(c(e))}),Object(n.useEffect)(()=>{a(c(e))},[e]);const l=e=>e&&Object(r.g)(e);return t?t(s,l):i.a.createElement("span",{ref:l},s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82);const i=(e=!1)=>{const[t,s]=Object(n.useState)(e);return[t,()=>{s(!t)},s]}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return v}));var n=s(83),i=s.n(n),a=s(94),o=s(159),r=s(90),c=s(84),l=s(104),d=s(106),h=s(96),u=s(1);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}async function g(e,t){const s=e.getRoom(t);return s||new Promise(s=>{const n=i=>{i.roomId===t&&(s(i),e.off("Room",n))};e.on("Room",n)})}async function v(e,t,s=!1,n=!0,i=!0,m=!1,v){var f;const b=e.client;let y;v||(y=r.a.createDialog(h.a,null,"mx_Dialog_spinner"));let E=[];s&&(E=[...e.getMembersWithMembership("join"),...e.getMembersWithMembership("invite")].map(e=>e.userId).filter(e=>e!==b.getUserId()));let S=[];i&&(S=Array.from(d.a.instance.getKnownParents(e.roomId)).map(e=>b.getRoom(e)).filter(e=>null==e?void 0:e.currentState.maySendStateEvent(a.a.SpaceChild,b.getUserId())));const _={roomUpgraded:!1,roomSynced:!m&&!s&&void 0,inviteUsersProgress:s?0:void 0,inviteUsersTotal:E.length,updateSpacesProgress:i?0:void 0,updateSpacesTotal:S.length};let w;null==v||v(_);try{({replacement_room:w}=await b.upgradeRoom(e.roomId,t))}catch(e){if(!n)throw e;throw u.a.error(e),r.a.createTrackedDialog("Room Upgrade Error","",l.a,{title:Object(c.a)("Error upgrading room"),description:Object(c.a)("Double check that your server supports the room version chosen and try again.")}),e}if(_.roomUpgraded=!0,null==v||v(_),(m||s)&&(await g(e.client,w),_.roomSynced=!0,null==v||v(_)),E.length>0&&await Object(o.b)(w,E,()=>{_.inviteUsersProgress++,null==v||v(_)}),S.length>0)try{for(const t of S){const s=t.currentState.getStateEvents(a.a.SpaceChild,e.roomId);await b.sendStateEvent(t.roomId,a.a.SpaceChild,p(p({},(null==s?void 0:s.getContent())||{}),{},{via:[b.getDomain()]}),w),await b.sendStateEvent(t.roomId,a.a.SpaceChild,{},e.roomId),_.updateSpacesProgress++,null==v||v(_)}}catch(e){u.a.warn("Failed to update parent spaces during room upgrade",e)}return null===(f=y)||void 0===f||f.close(),w}},function(e,t,s){"use strict";s.d(t,"a",(function(){return k}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(127),h=s(93),u=s(160),m=s(84),p=s(86),g=s(108),v=s(141),f=s(193),b=s(85),y=s(101),E=s(368),S=s(187),_=s(109),w=s(97),C=s(106),O=s(369);let k=Object(b.a)("views.dialogs.CreateRoomDialog")((a=i=class e extends l.a.Component{constructor(t){var s,n;super(t),r()(this,"supportsRestricted",void 0),r()(this,"nameField",Object(c.createRef)()),r()(this,"aliasField",Object(c.createRef)()),r()(this,"onKeyDown",e=>{e.key===g.a.ENTER&&(this.onOk(),e.preventDefault(),e.stopPropagation())}),r()(this,"onOk",async()=>{const e=document.activeElement;if(e&&e.blur(),await this.nameField.current.validate({allowEmpty:!1}),this.aliasField.current&&await this.aliasField.current.validate({allowEmpty:!1}),await new Promise(e=>this.setState({},e)),!this.state.nameIsValid||this.aliasField.current&&!this.aliasField.current.isValid){let e;this.state.nameIsValid?this.aliasField.current&&!this.aliasField.current.isValid&&(e=this.aliasField.current):e=this.nameField.current,e&&(e.focus(),e.validate({allowEmpty:!1,focused:!0}))}else this.props.onFinished(!0,this.roomCreateOptions())}),r()(this,"onCancel",()=>{this.props.onFinished(!1)}),r()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),r()(this,"onTopicChange",e=>{this.setState({topic:e.target.value})}),r()(this,"onJoinRuleChange",e=>{this.setState({joinRule:e})}),r()(this,"onEncryptedChange",e=>{this.setState({isEncrypted:e})}),r()(this,"onAliasChange",e=>{this.setState({alias:e})}),r()(this,"onDetailsToggled",e=>{this.setState({detailsOpen:e.target.open})}),r()(this,"onNoFederateChange",e=>{this.setState({noFederate:e})}),r()(this,"onNameValidate",async t=>{const s=await e.validateRoomName(t);return this.setState({nameIsValid:s.valid}),s}),this.supportsRestricted=this.props.parentSpace&&!(null===(s=C.a.instance.restrictedJoinRuleSupport)||void 0===s||!s.preferred);let i=d.c.Invite;this.props.defaultPublic?i=d.c.Public:this.supportsRestricted&&(i=d.c.Restricted);const a=h.a.get();this.state={isPublic:this.props.defaultPublic||!1,isEncrypted:null!==(n=this.props.defaultEncrypted)&&void 0!==n?n:Object(v.f)(),joinRule:i,name:this.props.defaultName||"",topic:"",alias:"",detailsOpen:!1,noFederate:!1===a.default_federate,nameIsValid:!1,canChangeEncryption:!0},p.a.get().doesServerForceEncryptionForPreset(d.d.PrivateChat).then(e=>this.setState({canChangeEncryption:!e}))}roomCreateOptions(){const e={},t=e.createOpts={};if(t.name=this.state.name,this.state.joinRule===d.c.Public){t.visibility=d.f.Public,t.preset=d.d.PublicChat,e.guestAccess=!1;const{alias:s}=this.state;t.room_alias_name=s.substr(1,s.indexOf(":")-1)}else e.encryption=!this.state.canChangeEncryption||this.state.isEncrypted;return this.state.topic&&(t.topic=this.state.topic),this.state.noFederate&&(t.creation_content={"m.federate":!1}),f.a.instance.getSelectedCommunityId()&&(e.associatedWithCommunity=f.a.instance.getSelectedCommunityId()),e.parentSpace=this.props.parentSpace,this.props.parentSpace&&this.state.joinRule===d.c.Restricted&&(e.joinRule=d.c.Restricted),e}componentDidMount(){this.nameField.current.focus()}componentWillUnmount(){}render(){let e,t,s;if(this.state.joinRule===d.c.Public){const t=p.a.get().getDomain();e=l.a.createElement("div",{className:"mx_CreateRoomDialog_aliasContainer"},l.a.createElement(E.a,{ref:this.aliasField,onChange:this.onAliasChange,domain:t,value:this.state.alias}))}if(f.a.instance.getSelectedCommunityId()?t=l.a.createElement("p",null,Object(m.a)("Private rooms can be found and joined by invitation only. Public rooms can be found and joined by anyone in this community.")):this.state.joinRule===d.c.Restricted?t=l.a.createElement("p",null,Object(m.a)("Everyone in <SpaceName/> will be able to find and join this room.",{},{SpaceName:()=>l.a.createElement("b",null,this.props.parentSpace.name)})," ",Object(m.a)("You can change this at any time from room settings.")):this.state.joinRule===d.c.Public&&this.props.parentSpace?t=l.a.createElement("p",null,Object(m.a)("Anyone will be able to find and join this room, not just members of <SpaceName/>.",{},{SpaceName:()=>l.a.createElement("b",null,this.props.parentSpace.name)})," ",Object(m.a)("You can change this at any time from room settings.")):this.state.joinRule===d.c.Public?t=l.a.createElement("p",null,Object(m.a)("Anyone will be able to find and join this room.")," ",Object(m.a)("You can change this at any time from room settings.")):this.state.joinRule===d.c.Invite&&(t=l.a.createElement("p",null,Object(m.a)("Only people invited will be able to find and join this room.")," ",Object(m.a)("You can change this at any time from room settings."))),this.state.joinRule!==d.c.Public){let e;e=Object(v.f)()?this.state.canChangeEncryption?Object(m.a)("You can't disable this later. Bridges & most bots won't work yet."):Object(m.a)("Your server requires encryption to be enabled in private rooms."):Object(m.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."),s=l.a.createElement(l.a.Fragment,null,l.a.createElement(S.a,{label:Object(m.a)("Enable end-to-end encryption"),onChange:this.onEncryptedChange,value:this.state.isEncrypted,className:"mx_CreateRoomDialog_e2eSwitch",disabled:!this.state.canChangeEncryption}),l.a.createElement("p",null,e))}let n=Object(m.a)("You might enable this if the room will only be used for collaborating with internal teams on your homeserver. This cannot be changed later.");!1===h.a.get().default_federate&&(n=Object(m.a)("You might disable this if the room will be used for collaborating with external teams who have their own homeserver. This cannot be changed later."));let i=Object(m.a)("Create a room");if(f.a.instance.getSelectedCommunityId()){const e=f.a.instance.getSelectedCommunityName();i=Object(m.a)("Create a room in %(communityName)s",{communityName:e})}else this.props.parentSpace||(i=this.state.joinRule===d.c.Public?Object(m.a)("Create a public room"):Object(m.a)("Create a private room"));return l.a.createElement(w.a,{className:"mx_CreateRoomDialog",onFinished:this.props.onFinished,title:i},l.a.createElement("form",{onSubmit:this.onOk,onKeyDown:this.onKeyDown},l.a.createElement("div",{className:"mx_Dialog_content"},l.a.createElement(y.a,{ref:this.nameField,label:Object(m.a)("Name"),onChange:this.onNameChange,onValidate:this.onNameValidate,value:this.state.name,className:"mx_CreateRoomDialog_name"}),l.a.createElement(y.a,{label:Object(m.a)("Topic (optional)"),onChange:this.onTopicChange,value:this.state.topic,className:"mx_CreateRoomDialog_topic"}),l.a.createElement(O.a,{label:Object(m.a)("Room visibility"),labelInvite:Object(m.a)("Private room (invite only)"),labelPublic:Object(m.a)("Public room"),labelRestricted:this.supportsRestricted?Object(m.a)("Visible to space members"):void 0,value:this.state.joinRule,onChange:this.onJoinRuleChange}),t,s,e,l.a.createElement("details",{onToggle:this.onDetailsToggled,className:"mx_CreateRoomDialog_details"},l.a.createElement("summary",{className:"mx_CreateRoomDialog_details_summary"},this.state.detailsOpen?Object(m.a)("Hide advanced"):Object(m.a)("Show advanced")),l.a.createElement(S.a,{label:Object(m.a)("Block anyone not part of %(serverName)s from ever joining this room.",{serverName:p.a.getHomeserverName()}),onChange:this.onNoFederateChange,value:this.state.noFederate}),l.a.createElement("p",null,n)))),l.a.createElement(_.a,{primaryButton:Object(m.a)("Create Room"),onPrimaryButtonClick:this.onOk,onCancel:this.onCancel}))}},r()(i,"validateRoomName",Object(u.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(m.a)("Please enter a name for the room")}]})),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s(88),c=s(85);const l=["1","2","3","4","5","6","7","8","9","*","0","#"],d=["","ABC","DEF","GHI","JKL","MNO","PQRS","TUV","WXYZ","","+",""];var h;!function(e){e[e.Digit=0]="Digit",e[e.Dial=1]="Dial"}(h||(h={}));class u extends o.PureComponent{constructor(...e){super(...e),a()(this,"onClick",e=>{this.props.onButtonPress(this.props.digit,e)})}render(){switch(this.props.kind){case h.Digit:return o.createElement(r.a,{className:"mx_DialPad_button",onClick:this.onClick},this.props.digit,o.createElement("div",{className:"mx_DialPad_buttonSubText"},this.props.digitSubtext));case h.Dial:return o.createElement(r.a,{className:"mx_DialPad_button mx_DialPad_dialButton",onClick:this.onClick})}}}let m=Object(c.a)("views.voip.DialPad")(n=class extends o.PureComponent{render(){const e=[];for(let t=0;t<l.length;t++){const s=l[t],n=d[t];e.push(o.createElement(u,{key:s,kind:h.Digit,digit:s,digitSubtext:n,onButtonPress:this.props.onDigitPress}))}return this.props.hasDial&&e.push(o.createElement(u,{key:"dial",kind:h.Dial,onButtonPress:this.props.onDialPress})),o.createElement("div",{className:"mx_DialPad"},e)}})||n},function(e,t,s){"use strict";s.d(t,"g",(function(){return m})),s.d(t,"a",(function(){return p})),s.d(t,"f",(function(){return g})),s.d(t,"e",(function(){return v})),s.d(t,"c",(function(){return y})),s.d(t,"d",(function(){return E})),s.d(t,"b",(function(){return S}));var n=s(603),i=s(140),a=s(414),o=s(174),r=s(1);const c=window.localStorage;let l;try{l=window.indexedDB}catch(e){}function d(e){r.a.log("StorageManager: "+e)}function h(e,...t){r.a.error("StorageManager: "+e,...t)}function u(e){i.a.trackEvent("StorageManager",e)}function m(){navigator.storage&&navigator.storage.persist?navigator.storage.persist().then(e=>{r.a.log("StorageManager: Persistent?",e)}):document.requestStorageAccess?document.requestStorageAccess().then(()=>r.a.log("StorageManager: Persistent?",!0),()=>r.a.log("StorageManager: Persistent?",!1)):r.a.log("StorageManager: Persistence unsupported")}async function p(){d("Checking storage consistency"),d("Local storage supported? "+!!c),d("IndexedDB supported? "+!!l);let e=!1,t=!1,s=!1,i=!0;if(c?(e=c.length>0,d("Local storage contains data? "+e),s=!!c.getItem("mx_crypto_initialised"),d("Crypto initialised? "+s)):(i=!1,h("Local storage cannot be used on this browser"),u("Local storage disabled")),l&&c){(await async function(){let e=!1;try{return e=await a.a.exists(l,"riot-web-sync"),d("Sync store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){h("Sync store using IndexedDB inaccessible",e),u("Sync store using IndexedDB inaccessible")}return d("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(i=!1)}else i=!1,h("Sync store cannot be used on this browser"),u("Sync store disabled");if(l){const e=await async function(){let e=!1;try{return e=await o.a.exists(l,"matrix-js-sdk:crypto"),d("Crypto store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){h("Crypto store using IndexedDB inaccessible",e),u("Crypto store using IndexedDB inaccessible")}try{return e=await n.a.exists(c),d("Crypto store using local storage contains data? "+e),{exists:e,healthy:!0}}catch(e){h("Crypto store using local storage inaccessible",e),u("Crypto store using local storage inaccessible")}return d("Crypto store using memory only"),{exists:e,healthy:!1}}();t=e.exists,e.healthy||(i=!1)}else i=!1,h("Crypto store cannot be used on this browser"),u("Crypto store disabled");return e&&s&&!t&&(i=!1,h("Data exists in local storage and crypto is marked as initialised  but no data found in crypto store. IndexedDB storage has likely been evicted by the browser!"),u("Crypto store evicted")),i?(d("Storage consistency checks passed"),u("Consistency checks passed")):(h("Storage consistency checks failed"),u("Consistency checks failed")),{dataInLocalStorage:e,dataInCryptoStore:t,cryptoInited:s,healthy:i}}function g(e){e.store&&e.store.on&&e.store.on("degraded",()=>{u("Sync store using IndexedDB degraded to memory")})}function v(e){c.setItem("mx_crypto_initialised",e)}let f=null;async function b(){if(!l)throw new Error("IndexedDB not available");f=await new Promise((e,t)=>{const s=l.open("matrix-react-sdk",1);s.onerror=t,s.onsuccess=t=>{e(s.result)},s.onupgradeneeded=e=>{const t=s.result;t.createObjectStore("pickleKey"),t.createObjectStore("account")}})}async function y(e,t){return f||await b(),new Promise((s,n)=>{const i=f.transaction([e],"readonly");i.onerror=n;const a=i.objectStore(e).get(t);a.onerror=n,a.onsuccess=e=>{s(a.result)}})}async function E(e,t,s){return f||await b(),new Promise((n,i)=>{const a=f.transaction([e],"readwrite");a.onerror=i;const o=a.objectStore(e).put(s,t);o.onerror=i,o.onsuccess=e=>{n()}})}async function S(e,t){return f||await b(),new Promise((s,n)=>{const i=f.transaction([e],"readwrite");i.onerror=n;const a=i.objectStore(e).delete(t);a.onerror=n,a.onsuccess=e=>{s()}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(544),l=s(97),d=s(84),h=s(547),u=s(85);function m(e){return e===h.a.Done?s(1566):s(818)}let p=Object(u.a)("views.dialogs.security.SetupEncryptionDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"store",void 0),a()(this,"onStoreUpdate",()=>{this.setState({icon:m(this.store.phase)})}),this.store=h.b.sharedInstance(),this.state={icon:m(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return r.a.createElement(l.a,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:Object(d.a)("Verify this session")},r.a.createElement(c.a,{onFinished:this.props.onFinished}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(82),a=s.n(i),o=s(86),r=s(84),c=s(85),l=s(97),d=s(394);let h=Object(c.a)("views.dialogs.VerificationRequestDialog")(n=class extends a.a.Component{constructor(e){super(e),this.state={verificationRequest:this.props.verificationRequest},this.props.verificationRequestPromise&&this.props.verificationRequestPromise.then(e=>{this.setState({verificationRequest:e})})}render(){const e=this.state.verificationRequest,t=e&&e.otherUserId,s=this.props.member||t&&o.a.get().getUser(t),n=e&&e.isSelfVerification?Object(r.a)("Verify other login"):Object(r.a)("Verification Request");return a.a.createElement(l.a,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:n,hasCancel:!0},a.a.createElement(d.a,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:s,isRoomEncrypted:!1}))}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(225),o=s(545),r=s(815),c=s(86),l=s(141),d=s(135),h=s(90),u=s(107),m=s(84),p=s(87),g=s(92),v=s(122);const f=["m.key_mismatch","m.user_error","m.mismatched_sas"];t.a=e=>{const{verificationRequest:t,verificationRequestPromise:b,member:y,onClose:E,layout:S,isRoomEncrypted:_}=e,[w,C]=Object(n.useState)(t),[O,k]=Object(n.useState)(!1),[R,I]=Object(n.useState)(null==w?void 0:w.phase);Object(n.useEffect)(()=>{C(t),t&&(k(!1),I(t.phase))},[t]),Object(n.useEffect)(()=>{b&&async function(){k(!0);const e=await b;k(!1),C(e),I(e.phase)}()},[b]);const x=Object(n.useCallback)(()=>{if(w&&w.cancelled&&f.includes(w.cancellationCode)){const e=u.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(818),title:Object(m.a)("Your messages are not secure"),description:i.a.createElement("div",null,Object(m.a)("One of the following may be compromised:"),i.a.createElement("ul",null,i.a.createElement("li",null,Object(m.a)("Your homeserver")),i.a.createElement("li",null,Object(m.a)("The homeserver the user you're verifying is connected to")),i.a.createElement("li",null,Object(m.a)("Yours, or the other users' internet connection")),i.a.createElement("li",null,Object(m.a)("Yours, or the other users' session")))),onFinished:E})}else w&&I(w.phase)},[E,w]);Object(d.a)(w,"change",x);const T=Object(n.useCallback)(async()=>{k(!0);const e=c.a.get(),t=await Object(l.c)(e,y.userId),s=await e.requestVerificationDM(y.userId,t);C(s),I(s.phase),p.a.dispatch({action:g.a.SetRightPanelPhase,phase:v.c.EncryptionPanel,refireParams:{member:y,verificationRequest:s}})},[y]),j=!w&&O||w&&(R===a.e||R===a.g||void 0===R),N=w?w.isSelfVerification:y.userId===c.a.get().getUserId();if(!w||j){const e=!w&&O||w&&w.initiatedByMe;return i.a.createElement(o.b,{isRoomEncrypted:_,onStartVerification:T,member:y,isSelfVerification:N,waitingForOtherParty:j&&e,waitingForNetwork:j&&!e,inDialog:"dialog"===S})}return i.a.createElement(r.a,{isRoomEncrypted:_,layout:S,onClose:E,member:y,request:w,key:w.channel.transactionId,inDialog:"dialog"===S,phase:R})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(355),r=s(82),c=s.n(r),l=s(217),d=s(96),h=s(85),u=s(1);const m=new Error("User cancelled auth session");let p=Object(h.a)("structures.InteractiveAuthComponent")(n=class extends c.a.Component{constructor(e){super(e),a()(this,"authLogic",void 0),a()(this,"intervalId",null),a()(this,"stageComponent",Object(r.createRef)()),a()(this,"unmounted",!1),a()(this,"requestEmailToken",async(e,t,s,n)=>{this.setState({busy:!0});try{return await this.props.requestEmailToken(e,t,s,n)}finally{this.setState({busy:!1})}}),a()(this,"tryContinue",()=>{var e,t;null===(e=this.stageComponent.current)||void 0===e||null===(t=e.tryContinue)||void 0===t||t.call(e)}),a()(this,"authStateUpdated",(e,t)=>{const s=this.state.authStage;this.setState({busy:!1,authStage:e,stageState:t,errorText:t.error,errorCode:t.errcode},()=>{if(s!==e)this.setFocus();else if(!t.error){var n,i;null===(n=this.stageComponent.current)||void 0===n||null===(i=n.attemptFailed)||void 0===i||i.call(n)}})}),a()(this,"requestCallback",(e,t)=>this.props.makeRequest(e)),a()(this,"onBusyChanged",e=>{e&&this.setState({busy:!0,errorText:null,errorCode:null})}),a()(this,"submitAuthDict",e=>{this.authLogic.submitAuthDict(e)}),a()(this,"onPhaseChange",e=>{var t,s;null===(t=(s=this.props).onStagePhaseChange)||void 0===t||t.call(s,this.state.authStage,e||0)}),a()(this,"onStageCancel",()=>{this.props.onAuthFinished(!1,m)}),a()(this,"onAuthStageFailed",e=>{this.props.onAuthFinished(!1,e)}),a()(this,"setEmailSid",e=>{this.authLogic.setEmailSid(e)}),this.state={authStage:null,busy:!1,errorText:null,errorCode:null,submitButtonEnabled:!1},this.authLogic=new o.b({authData:this.props.authData,doRequest:this.requestCallback,busyChanged:this.onBusyChanged,inputs:this.props.inputs,stateUpdated:this.authStateUpdated,matrixClient:this.props.matrixClient,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.emailSid,requestEmailToken:this.requestEmailToken}),this.props.poll&&(this.intervalId=setInterval(()=>{this.authLogic.poll()},2e3))}UNSAFE_componentWillMount(){this.authLogic.attemptAuth().then(e=>{const t={emailSid:this.authLogic.getEmailSid(),clientSecret:this.authLogic.getClientSecret()};this.props.onAuthFinished(!0,e,t)}).catch(e=>{if(this.props.onAuthFinished(!1,e),u.a.error("Error during user-interactive auth:",e),this.unmounted)return;const t=e.message||e.toString();this.setState({errorText:t,errorCode:e.errcode})})}componentWillUnmount(){this.unmounted=!0,null!==this.intervalId&&clearInterval(this.intervalId)}setFocus(){var e,t;null===(e=this.stageComponent.current)||void 0===e||null===(t=e.focus)||void 0===t||t.call(e)}render(){const e=this.state.authStage;if(!e)return this.state.busy?c.a.createElement(d.a,null):null;const t=Object(l.d)(e);return c.a.createElement(t,{ref:this.stageComponent,loginType:e,matrixClient:this.props.matrixClient,authSessionId:this.authLogic.getSessionId(),clientSecret:this.authLogic.getClientSecret(),stageParams:this.authLogic.getStageParams(e),submitAuthDict:this.submitAuthDict,errorText:this.state.errorText,errorCode:this.state.errorCode,busy:this.state.busy,inputs:this.props.inputs,stageState:this.state.stageState,fail:this.onAuthStageFailed,setEmailSid:this.setEmailSid,showContinue:!this.props.continueIsManaged,onPhaseChange:this.onPhaseChange,continueText:this.props.continueText,continueKind:this.props.continueKind,onCancel:this.onStageCancel})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(150),h=s(84),u=s(85);let m;!function(e){e.Info="info",e.Warning="warning"}(m||(m={}));let p=Object(u.a)("views.elements.InfoTooltip")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onMouseOver",()=>{this.setState({hover:!0})}),a()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const{tooltip:e,children:t,tooltipClassName:s,className:n,kind:i}=this.props,a=Object(h.a)("Information"),o=i!==m.Warning?"mx_InfoTooltip_icon_info":"mx_InfoTooltip_icon_warning",c=this.state.hover?r.a.createElement(d.b,{className:"mx_InfoTooltip_container",tooltipClassName:l()("mx_InfoTooltip_tooltip",s),label:e||a,alignment:d.a.Right}):r.a.createElement("div",null);return r.a.createElement("div",{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:l()("mx_InfoTooltip",n)},r.a.createElement("span",{className:l()("mx_InfoTooltip_icon",o),"aria-label":a}),t,c)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(837),o=s(838);class r{static createItem(e,t,s){return new a.a(e,t,s)}static createSizer(e,t,s){return new o.a(e,t,s)}constructor(e){this.item=e,i()(this,"beforeOffset",void 0),this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"a",(function(){return u})),s.d(t,"c",(function(){return m})),s.d(t,"f",(function(){return S})),s.d(t,"e",(function(){return _}));var n=s(82),i=s(91),a=s.n(i),o=s(90),r=s(84),c=s(108),l=s(166);let d,h;Object(r.b)("Navigation"),Object(r.b)("Calls"),Object(r.b)("Composer"),Object(r.b)("Room List"),Object(r.b)("Autocomplete"),function(e){e.NAVIGATION="Navigation",e.CALLS="Calls",e.COMPOSER="Composer",e.ROOM_LIST="Room List",e.ROOM="Room",e.AUTOCOMPLETE="Autocomplete"}(d||(d={})),Object(r.b)("Alt"),Object(r.b)("Alt Gr"),Object(r.b)("Shift"),Object(r.b)("Super"),Object(r.b)("Ctrl"),function(e){e.ALT="Alt",e.ALT_GR="Alt Gr",e.SHIFT="Shift",e.SUPER="Super",e.COMMAND="Command",e.CONTROL="Ctrl"}(h||(h={}));const u=c.b?h.COMMAND:h.CONTROL,m="digits",p={[d.COMPOSER]:[{keybinds:[{modifiers:[u],key:c.a.B}],description:Object(r.b)("Toggle Bold")},{keybinds:[{modifiers:[u],key:c.a.I}],description:Object(r.b)("Toggle Italics")},{keybinds:[{modifiers:[u],key:c.a.GREATER_THAN}],description:Object(r.b)("Toggle Quote")},{keybinds:[{modifiers:[h.SHIFT],key:c.a.ENTER}],description:Object(r.b)("New line")},{keybinds:[{key:c.a.ARROW_UP},{key:c.a.ARROW_DOWN}],description:Object(r.b)("Navigate recent messages to edit")},{keybinds:[{modifiers:[u],key:c.a.HOME},{modifiers:[u],key:c.a.END}],description:Object(r.b)("Jump to start/end of the composer")},{keybinds:[{modifiers:[h.CONTROL,h.ALT],key:c.a.ARROW_UP},{modifiers:[h.CONTROL,h.ALT],key:c.a.ARROW_DOWN}],description:Object(r.b)("Navigate composer history")},{keybinds:[{key:c.a.ESCAPE}],description:Object(r.b)("Cancel replying to a message")}],[d.CALLS]:[{keybinds:[{modifiers:[u],key:c.a.D}],description:Object(r.b)("Toggle microphone mute")},{keybinds:[{modifiers:[u],key:c.a.E}],description:Object(r.b)("Toggle video on/off")}],[d.ROOM]:[{keybinds:[{key:c.a.PAGE_UP},{key:c.a.PAGE_DOWN}],description:Object(r.b)("Scroll up/down in the timeline")},{keybinds:[{key:c.a.ESCAPE}],description:Object(r.b)("Dismiss read marker and jump to bottom")},{keybinds:[{modifiers:[h.SHIFT],key:c.a.PAGE_UP}],description:Object(r.b)("Jump to oldest unread message")},{keybinds:[{modifiers:[u,h.SHIFT],key:c.a.U}],description:Object(r.b)("Upload a file")},{keybinds:[{modifiers:[u],key:c.a.F}],description:Object(r.b)("Search (must be enabled)")}],[d.ROOM_LIST]:[{keybinds:[{modifiers:[u],key:c.a.K}],description:Object(r.b)("Jump to room search")},{keybinds:[{key:c.a.ARROW_UP},{key:c.a.ARROW_DOWN}],description:Object(r.b)("Navigate up/down in the room list")},{keybinds:[{key:c.a.ENTER}],description:Object(r.b)("Select room from the room list")},{keybinds:[{key:c.a.ARROW_LEFT}],description:Object(r.b)("Collapse room list section")},{keybinds:[{key:c.a.ARROW_RIGHT}],description:Object(r.b)("Expand room list section")},{keybinds:[{key:c.a.ESCAPE}],description:Object(r.b)("Clear room list filter field")}],[d.NAVIGATION]:[{keybinds:[{modifiers:[h.ALT,h.SHIFT],key:c.a.ARROW_UP},{modifiers:[h.ALT,h.SHIFT],key:c.a.ARROW_DOWN}],description:Object(r.b)("Previous/next unread room or DM")},{keybinds:[{modifiers:[h.ALT],key:c.a.ARROW_UP},{modifiers:[h.ALT],key:c.a.ARROW_DOWN}],description:Object(r.b)("Previous/next room or DM")},{keybinds:[{modifiers:[u],key:c.a.BACKTICK}],description:Object(r.b)("Toggle the top left menu")},{keybinds:[{key:c.a.ESCAPE}],description:Object(r.b)("Close dialog or context menu")},{keybinds:[{key:c.a.ENTER},{key:c.a.SPACE}],description:Object(r.b)("Activate selected button")},{keybinds:[{modifiers:[u],key:c.a.PERIOD}],description:Object(r.b)("Toggle right panel")},{keybinds:[{modifiers:[u],key:c.a.SLASH}],description:Object(r.b)("Toggle this dialog")},{keybinds:[{modifiers:[h.CONTROL,c.b?h.SHIFT:h.ALT],key:c.a.H}],description:Object(r.b)("Go to Home View")}],[d.AUTOCOMPLETE]:[{keybinds:[{key:c.a.ARROW_UP},{key:c.a.ARROW_DOWN}],description:Object(r.b)("Move autocomplete selection up/down")},{keybinds:[{key:c.a.ESCAPE}],description:Object(r.b)("Cancel autocomplete")}]},g=[d.COMPOSER,d.AUTOCOMPLETE,d.ROOM,d.ROOM_LIST,d.NAVIGATION,d.CALLS],v={[h.COMMAND]:"⌘"};c.b&&(v[h.ALT]="⌥");const f={[c.a.PAGE_UP]:Object(r.b)("Page Up"),[c.a.PAGE_DOWN]:Object(r.b)("Page Down"),[c.a.ESCAPE]:Object(r.b)("Esc"),[c.a.ENTER]:Object(r.b)("Enter"),[c.a.SPACE]:Object(r.b)("Space"),[c.a.HOME]:Object(r.b)("Home"),[c.a.END]:Object(r.b)("End"),[m]:Object(r.b)("[number]")},b={[c.a.ARROW_UP]:"↑",[c.a.ARROW_DOWN]:"↓",[c.a.ARROW_LEFT]:"←",[c.a.ARROW_RIGHT]:"→"},y=({shortcut:e})=>{const t=a()({mx_KeyboardShortcutsDialog_inline:e.keybinds.every(e=>!e.modifiers||0===e.modifiers.length)});return n.createElement("div",{className:t},n.createElement("h5",null,Object(r.a)(e.description)),e.keybinds.map(e=>{let t=e.key;return f[e.key]?t=Object(r.a)(f[e.key]):b[e.key]&&(t=b[e.key]),n.createElement("div",{key:e.key},e.modifiers&&e.modifiers.map(e=>n.createElement(n.Fragment,{key:e},n.createElement("kbd",null,v[e]||Object(r.a)(e)),"+")),n.createElement("kbd",null,t))}))};let E=null;const S=()=>{if(E)return E.close(),void(E=null);const e=g.map(e=>{const t=p[e];return n.createElement("div",{className:"mx_KeyboardShortcutsDialog_category",key:e},n.createElement("h3",null,Object(r.a)(e)),n.createElement("div",null,t.map(e=>n.createElement(y,{key:e.description,shortcut:e}))))});E=o.a.createTrackedDialog("Keyboard Shortcuts","",l.a,{className:"mx_KeyboardShortcutsDialog",title:Object(r.a)("Keyboard Shortcuts"),description:e,hasCloseButton:!0,onKeyDown:e=>{!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==c.a.SLASH||(e.stopPropagation(),E.close())},onFinished:()=>{E=null}})},_=(e,t)=>{p[e].push(t)}},function(e,t,s){"use strict";s.d(t,"b",(function(){return v})),s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(148),l=s.n(c),d=s(112),h=s(87),u=s(98),m=s(86),p=s(4),g=s(85);const v=e=>"widget_"+e;function f(e){return document.getElementById(e)}let b=Object(g.a)("views.elements.PersistedElement")(n=class e extends r.a.Component{constructor(t){super(t),a()(this,"resizeObserver",void 0),a()(this,"dispatcherRef",void 0),a()(this,"childContainer",void 0),a()(this,"child",void 0),a()(this,"collectChildContainer",e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)}),a()(this,"collectChild",e=>{this.child=e,this.updateChild()}),a()(this,"onAction",t=>{"timeline_resize"===t.action?this.repositionChild():"logout"===t.action&&e.destroyElement(this.props.persistKey)}),a()(this,"repositionChild",()=>{this.updateChildPosition(this.child,this.childContainer)}),a()(this,"updateChildPosition",Object(d.throttle)((e,t)=>{if(!e||!t)return;const s=t.getBoundingClientRect();Object.assign(e.style,{zIndex:Object(p.v)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:s.top+"px",left:s.left+"px",width:s.width+"px",height:s.height+"px"})},100,{trailing:!0,leading:!0})),this.resizeObserver=new ResizeObserver(this.repositionChild),window.addEventListener("resize",this.repositionChild),this.dispatcherRef=h.a.register(this.onAction)}static destroyElement(e){const t=f("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(f("mx_persistedElement_"+e))}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),h.a.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=r.a.createElement(u.a.Provider,{value:m.a.get()},r.a.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children));l.a.render(e,function(e){let t=f(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t){e&&(e.style.display=t?"block":"none")}render(){return r.a.createElement("div",{ref:this.collectChildContainer})}})||n},function(e,t,s){"use strict";s.d(t,"d",(function(){return U})),s.d(t,"c",(function(){return B})),s.d(t,"b",(function(){return V}));var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(98),c=s(886),l=s(182),d=s(84),h=s(126),u=s(88),m=s(87),p=s(92),g=s(122),v=s(90),f=s(384),b=s(135),y=s(152),E=s(201),S=s(89),_=s(177),w=s(558),C=s(111),O=s(238),k=s(565),R=s(118),I=s(115),x=s(105),T=s(419),j=s(566),N=s(154),P=s(219),D=s(139),M=s(595);const A=({children:e,className:t,onClick:s})=>i.a.createElement(u.a,{className:o()("mx_BaseCard_Button mx_RoomSummaryCard_Button",t),onClick:s},e),U=e=>{const[t,s]=Object(n.useState)(O.a.instance.getApps(e.roomId)),i=Object(n.useCallback)(()=>{s([...O.a.instance.getApps(e.roomId)])},[e]);return Object(n.useEffect)(i,[e,i]),Object(b.a)(O.a.instance,e.roomId,i),Object(b.a)(N.d.instance,N.d.emissionForRoom(e),i),t},L=({app:e,room:t})=>{const s=y.a.getWidgetName(e),n=y.a.getWidgetDataTitle(e),a=n&&" - "+n,r=N.d.instance.isInContainer(t,e,N.a.Top),c=r?()=>{N.d.instance.moveToContainer(t,e,N.a.Right)}:()=>{N.d.instance.moveToContainer(t,e,N.a.Top)},[l,h,u,v]=Object(x.p)();let f;if(l){const t=h.current.getBoundingClientRect();f=i.a.createElement(T.a,{chevronFace:x.a.None,right:D.b.instance.windowWidth-t.right,bottom:D.b.instance.windowHeight-t.top,onFinished:v,app:e})}const b=!r&&!N.d.instance.canAddToContainer(t,N.a.Top);let E;E=b?Object(d.a)("You can only pin up to %(count)s widgets",{count:N.b}):r?Object(d.a)("Unpin"):Object(d.a)("Pin");const _=o()("mx_BaseCard_Button mx_RoomSummaryCard_Button",{mx_RoomSummaryCard_Button_pinned:r}),O=N.d.instance.isInContainer(t,e,N.a.Center),k=O?()=>{N.d.instance.moveToContainer(t,e,N.a.Right)}:()=>{N.d.instance.moveToContainer(t,e,N.a.Center)},R=O?Object(d.a)("Close"):Object(d.a)("Maximise widget");let I="";return r?I=Object(d.a)("Unpin this widget to view it in this panel"):O&&(I=Object(d.a)("Close this widget to view it in this panel")),i.a.createElement("div",{className:_,ref:h},i.a.createElement(C.a,{className:"mx_RoomSummaryCard_icon_app",onClick:()=>{m.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.c.Widget,refireParams:{widgetId:e.id}})},title:I,forceHide:!(r||O),disabled:r||O,yOffset:-48},i.a.createElement(w.a,{app:e}),i.a.createElement("span",null,s),a),i.a.createElement(x.c,{className:o()({mx_RoomSummaryCard_app_options:!0,mx_RoomSummaryCard_maximised_widget:S.b.getValue("feature_maximised_widgets")}),isExpanded:l,onClick:u,title:Object(d.a)("Options"),yOffset:-24}),i.a.createElement(C.a,{className:"mx_RoomSummaryCard_app_pinToggle",onClick:c,title:E,disabled:b,yOffset:-24}),S.b.getValue("feature_maximised_widgets")&&i.a.createElement(C.a,{className:O?"mx_RoomSummaryCard_app_minimise":"mx_RoomSummaryCard_app_maximise",onClick:k,title:R,yOffset:-24}),f)},F=({room:e})=>{const t=U(e);let s=null;return t.length>0&&N.d.instance.canCopyLayoutToRoom(e)&&(s=i.a.createElement(u.a,{kind:"link",onClick:()=>N.d.instance.copyLayoutToRoom(e)},Object(d.a)("Set my room layout for everyone"))),i.a.createElement(l.a,{className:"mx_RoomSummaryCard_appsGroup",title:Object(d.a)("Widgets")},t.map(t=>i.a.createElement(L,{key:t.id,app:t,room:e})),s,i.a.createElement(u.a,{kind:"link",onClick:()=>{const t=E.a.sharedInstance();t.hasManager()?S.b.getValue("feature_many_integration_managers")?t.openAll(e):t.getPrimaryManager().open(e):t.openNoManagerDialog()}},t.length>0?Object(d.a)("Edit widgets, bridges & bots"):Object(d.a)("Add widgets, bridges & bots")))},B=(e=!0)=>{m.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.c.RoomMemberList,allowClose:e})},V=(e=!0)=>{m.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.c.FilePanel,allowClose:e})},K=()=>{m.a.dispatch({action:"open_room_settings"})};t.a=({room:e,onClose:t})=>{const s=Object(n.useContext)(r.a),a=Object(c.a)(s,e),u=Object(n.useContext)(R.b).e2eStatus,m=e.getCanonicalAlias()||e.getAltAliases()[0]||"",p=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_RoomSummaryCard_avatar",role:"presentation"},i.a.createElement(h.a,{room:e,height:54,width:54,viewAvatarOnClick:!0}),i.a.createElement(_.a,{tooltip:a?Object(d.a)("Encrypted"):Object(d.a)("Not encrypted"),class:o()("mx_RoomSummaryCard_e2ee",{mx_RoomSummaryCard_e2ee_normal:a,mx_RoomSummaryCard_e2ee_warning:a&&u===k.a.Warning,mx_RoomSummaryCard_e2ee_verified:a&&u===k.a.Verified})})),i.a.createElement(P.a,{room:e},e=>i.a.createElement("h2",{title:e},e)),i.a.createElement("div",{className:"mx_RoomSummaryCard_alias",title:m},m)),g=Object(j.a)(e);return i.a.createElement(l.b,{header:p,className:"mx_RoomSummaryCard",onClose:t},i.a.createElement(l.a,{title:Object(d.a)("About"),className:"mx_RoomSummaryCard_aboutGroup"},i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_people",onClick:B},Object(d.a)("People"),i.a.createElement("span",{className:"mx_BaseCard_Button_sublabel"},g)),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_files",onClick:V},Object(d.a)("Files")),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_export",onClick:async()=>{v.a.createTrackedDialog("export room dialog","",M.a,{room:e})}},Object(d.a)("Export chat")),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_share",onClick:()=>{v.a.createTrackedDialog("share room dialog","",f.a,{target:e})}},Object(d.a)("Share room")),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_settings",onClick:K},Object(d.a)("Room settings"))),S.b.getValue(I.b.Widgets)&&i.a.createElement(F,{room:e}))}},,function(e,t){e.exports="img/cancel.3428691.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return Y}));var n,i,a,o=s(83),r=s.n(o),c=s(95),l=s.n(c),d=s(82),h=s.n(d),u=s(91),m=s.n(u),p=s(84),g=s(86),v=s(87),f=s(905),b=s(120),y=s(202),E=s(215),S=s(89),_=s(105),w=s(111),C=s(907),O=s(115),k=s(123),R=s(133),I=s(85),x=s(908),T=s(911),j=s(338),N=s(150),P=s(912),D=s(92),M=s(418),A=s(923),U=s(139),L=s(90),F=s(94),B=s(118),V=s(263),K=s(104),W=s(925);let G=0;function H(e){return h.a.createElement("div",{className:"mx_MessageComposer_avatar"},h.a.createElement(A.a,{member:e.me,width:24,height:24}))}function q(e){var t;const s=m()("mx_MessageComposer_sendMessage",{mx_MessageComposer_sendMessage_enabled:e.enabled});return h.a.createElement(w.a,{className:s,onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:Object(p.a)("Send message")})}const $=({addEmoji:e,menuPosition:t,narrowMode:s})=>{const[n,i,a,o]=Object(_.p)();let r;if(n){const s=null!=t?t:Object(_.j)(i.current.getBoundingClientRect());r=h.a.createElement(_.n,l()({},s,{onFinished:o,managed:!1}),h.a.createElement(M.d,{onChoose:e,showQuickReactions:!0}))}const c=m()("mx_MessageComposer_button","mx_MessageComposer_emoji",{mx_MessageComposer_button_highlight:n});return h.a.createElement(h.a.Fragment,null,h.a.createElement(w.a,{className:c,onClick:a,title:!s&&Object(p.a)("Emoji picker"),label:s?Object(p.a)("Add emoji"):null}),r)};class z extends h.a.Component{constructor(e){super(e),r()(this,"uploadInput",h.a.createRef()),r()(this,"dispatcherRef",void 0),r()(this,"onAction",e=>{"upload_file"===e.action&&this.onUploadClick()}),r()(this,"onUploadClick",()=>{g.a.get().isGuest()?v.a.dispatch({action:"require_registration"}):this.uploadInput.current.click()}),r()(this,"onUploadFileInputChange",e=>{if(0===e.target.files.length)return;const t=[];for(let s=0;s<e.target.files.length;++s)t.push(e.target.files[s]);y.b.sharedInstance().sendContentListToRoom(t,this.props.roomId,this.props.relation,g.a.get()),e.target.value=""}),this.dispatcherRef=v.a.register(this.onAction)}componentWillUnmount(){v.a.unregister(this.dispatcherRef)}render(){return h.a.createElement(w.a,{className:"mx_MessageComposer_button mx_MessageComposer_upload",onClick:this.onUploadClick,title:Object(p.a)("Upload file")},h.a.createElement("input",{ref:this.uploadInput,type:"file",style:{display:"none"},multiple:!0,onChange:this.onUploadFileInputChange}))}}class J extends h.a.PureComponent{constructor(...e){super(...e),r()(this,"onCreateClick",()=>{this.props.room.currentState.maySendEvent(V.c.name,g.a.get().getUserId())?L.a.createTrackedDialog("Polls","create",W.a,{room:this.props.room},"mx_CompoundDialog",!1,!0):L.a.createTrackedDialog("Polls","permissions error: cannot start",K.a,{title:Object(p.a)("Permission Required"),description:Object(p.a)("You do not have permission to start polls in this room.")})})}render(){return h.a.createElement(w.a,{className:"mx_MessageComposer_button mx_MessageComposer_poll",onClick:this.onCreateClick,title:Object(p.a)("Create poll")})}}let Y=Object(I.a)("views.rooms.MessageComposer")((a=i=class extends h.a.Component{constructor(e){super(e),r()(this,"dispatcherRef",void 0),r()(this,"messageComposerInput",Object(d.createRef)()),r()(this,"voiceRecordingButton",Object(d.createRef)()),r()(this,"ref",Object(d.createRef)()),r()(this,"instanceId",void 0),r()(this,"context",void 0),r()(this,"onResize",(e,t)=>{if(e===U.a.Resize){const e=t.contentRect.width<=500;this.setState({narrowMode:e,isMenuOpen:!!e&&this.state.isMenuOpen,showStickers:!1})}}),r()(this,"onAction",e=>{"reply_to_event"===e.action&&e.context===this.context.timelineRenderingType&&setTimeout(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()},100)}),r()(this,"onRoomStateEvents",(e,t)=>{e.getRoomId()===this.props.room.roomId&&("m.room.tombstone"===e.getType()&&this.setState({tombstone:this.getRoomTombstone()}),"m.room.power_levels"===e.getType()&&this.setState({canSendMessages:this.props.room.maySendMessage()}))}),r()(this,"onTombstoneClick",e=>{e.preventDefault();const t=this.state.tombstone.getContent().replacement_room,s=g.a.get().getRoom(t);let n=null;if(s){const e=s.currentState.getStateEvents("m.room.create","");e&&e.getId()&&(n=e.getId())}const i=[this.state.tombstone.getSender().split(":").slice(1).join(":")];v.a.dispatch({action:D.a.ViewRoom,highlighted:!0,event_id:n,room_id:t,auto_join:!0,_type:"tombstone",via_servers:i,opts:{viaServers:i}})}),r()(this,"renderPlaceholderText",()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===F.c.Thread;return t&&this.props.e2eStatus?Object(p.a)("Reply to encrypted thread…"):t?Object(p.a)("Reply to thread…"):this.props.e2eStatus?Object(p.a)("Send an encrypted reply…"):Object(p.a)("Send a reply…")}return this.props.e2eStatus?Object(p.a)("Send an encrypted message…"):Object(p.a)("Send a message…")}),r()(this,"addEmoji",e=>(v.a.dispatch({action:D.a.ComposerInsert,text:e,timelineRenderingType:this.context.timelineRenderingType}),!0)),r()(this,"sendMessage",async()=>{var e,t;this.state.haveRecording&&this.voiceRecordingButton.current?await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send()):null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage()}),r()(this,"onChange",e=>{this.setState({isComposerEmpty:e.isEmpty})}),r()(this,"onVoiceStoreUpdate",()=>{const e=T.a.instance.activeRecording;e?(e.on(j.b.Started,()=>{this.setState({haveRecording:!!T.a.instance.activeRecording})}),e.on(j.b.EndingSoon,({secondsLeft:e})=>{this.setState({recordingTimeLeftSeconds:e}),setTimeout(()=>this.setState({recordingTimeLeftSeconds:null}),3e3)})):this.setState({haveRecording:!1})}),r()(this,"shouldShowStickerPicker",()=>S.b.getValue(O.b.Widgets)&&S.b.getValue("MessageComposerInput.showStickersButton")&&!this.state.haveRecording),r()(this,"showStickers",e=>{this.setState({showStickers:e})}),r()(this,"toggleButtonMenu",()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})}),T.a.instance.on(k.b,this.onVoiceStoreUpdate),this.state={tombstone:this.getRoomTombstone(),canSendMessages:this.props.room.maySendMessage(),isComposerEmpty:!0,haveRecording:!1,recordingTimeLeftSeconds:null,isMenuOpen:!1,showStickers:!1},this.instanceId=G++}componentDidMount(){this.dispatcherRef=v.a.register(this.onAction),g.a.get().on("RoomState.events",this.onRoomStateEvents),this.waitForOwnMember(),U.b.instance.trackElementDimensions("MessageComposer"+this.instanceId,this.ref.current),U.b.instance.on("MessageComposer"+this.instanceId,this.onResize)}waitForOwnMember(){const e=this.props.room.getMember(g.a.get().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then(()=>{const e=this.props.room.getMember(g.a.get().getUserId());this.setState({me:e})})}componentWillUnmount(){g.a.get()&&g.a.get().removeListener("RoomState.events",this.onRoomStateEvents),T.a.instance.off(k.b,this.onVoiceStoreUpdate),v.a.unregister(this.dispatcherRef),U.b.instance.stopTrackingElementDimensions("MessageComposer"+this.instanceId),U.b.instance.removeListener("MessageComposer"+this.instanceId,this.onResize)}getRoomTombstone(){return this.props.room.currentState.getStateEvents("m.room.tombstone","")}renderButtons(e){let t=0;const s=[];if(this.state.haveRecording||(S.b.getValue("feature_polls")&&s.push(h.a.createElement(J,{key:"polls",room:this.props.room})),t=s.length,s.push(h.a.createElement(z,{key:"controls_upload",roomId:this.props.room.roomId,relation:this.props.relation})),s.push(h.a.createElement($,{key:"emoji_button",addEmoji:this.addEmoji,menuPosition:e,narrowMode:this.state.narrowMode}))),this.shouldShowStickerPicker()){let e;this.state.narrowMode||(e=this.state.showStickers?Object(p.a)("Hide Stickers"):Object(p.a)("Show Stickers")),s.push(h.a.createElement(w.a,{id:"stickersButton",key:"controls_stickers",className:"mx_MessageComposer_button mx_MessageComposer_stickers",onClick:()=>this.showStickers(!this.state.showStickers),title:e,label:this.state.narrowMode?Object(p.a)("Send a sticker"):null}))}if(this.state.haveRecording||this.state.narrowMode||s.push(h.a.createElement(w.a,{key:"voice_message_send",className:"mx_MessageComposer_button mx_MessageComposer_voiceMessage",onClick:()=>{var e;return null===(e=this.voiceRecordingButton.current)||void 0===e?void 0:e.onRecordStartEndClick()},title:Object(p.a)("Send voice message")})),this.state.narrowMode){const n=m()({mx_MessageComposer_button:!0,mx_MessageComposer_buttonMenu:!0,mx_MessageComposer_closeButtonMenu:this.state.isMenuOpen});return h.a.createElement(h.a.Fragment,null,s[t],h.a.createElement(w.a,{className:n,onClick:this.toggleButtonMenu,title:Object(p.a)("More options"),tooltip:!1}),this.state.isMenuOpen&&h.a.createElement(_.n,l()({onFinished:this.toggleButtonMenu},e,{menuPaddingRight:10,menuPaddingTop:5,menuPaddingBottom:5,menuWidth:150,wrapperClassName:"mx_MessageComposer_Menu"}),s.slice(1).map((e,t)=>h.a.createElement(_.e,{className:"mx_CallContextMenu_item",key:t,onClick:this.toggleButtonMenu},e))))}return s}render(){const e=[this.state.me&&!this.props.compact?h.a.createElement(H,{key:"controls_avatar",me:this.state.me}):null,this.props.e2eStatus?h.a.createElement(E.b,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}):null];let t,n;if(this.ref.current){const e=this.ref.current.getBoundingClientRect();t=Object(_.j)(e)}if(!this.state.tombstone&&this.state.canSendMessages)e.push(h.a.createElement(P.a,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),permalinkCreator:this.props.permalinkCreator,relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording})),e.push(h.a.createElement(x.a,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room}));else if(this.state.tombstone){const t=this.state.tombstone.getContent().replacement_room,n=t?h.a.createElement("a",{href:Object(b.g)(t),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},Object(p.a)("The conversation continues here.")):"";e.push(h.a.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},h.a.createElement("div",{className:"mx_MessageComposer_replaced_valign"},h.a.createElement("img",{className:"mx_MessageComposer_roomReplaced_icon",src:s(1608)}),h.a.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},Object(p.a)("This room has been replaced and is no longer active.")),h.a.createElement("br",null),n)))}else e.push(h.a.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},Object(p.a)("You do not have permission to post to this room")));const i=Math.round(this.state.recordingTimeLeftSeconds);i&&(n=h.a.createElement(N.b,{label:Object(p.a)("%(seconds)ss left",{seconds:i}),alignment:N.a.Top,yOffset:-50})),e.push(h.a.createElement(f.a,{room:this.props.room,showStickers:this.state.showStickers,setShowStickers:this.showStickers,menuPosition:t,key:"stickers"}));const a=m()({mx_MessageComposer:!0,mx_GroupLayout:this.props.layout==R.a.IRC||this.props.layout==R.a.Group,sc_BubbleLayout:this.props.layout==R.a.Bubble,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:null!=this.props.e2eStatus});return h.a.createElement("div",{className:a,ref:this.ref},n,h.a.createElement("div",{className:"mx_MessageComposer_wrapper"},h.a.createElement(C.a,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator,userNameColorMode:this.props.userNameColorMode}),h.a.createElement("div",{className:"mx_MessageComposer_row"},e,this.renderButtons(t),h.a.createElement(q,{key:"controls_send",onClick:this.sendMessage,enabled:!this.state.isComposerEmpty||this.state.haveRecording,title:this.state.haveRecording?Object(p.a)("Send voice message"):void 0}))))}},r()(i,"contextType",B.b),r()(i,"defaultProps",{compact:!1}),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(88),o=s(84),r=s(177),c=s(93),l=s(90),d=s(961),h=s(166);const u=()=>{l.a.createTrackedDialog("Custom Server Dialog","",h.a,{title:Object(o.a)("Server Options"),description:Object(o.a)("You can use the custom server options to sign into other Matrix servers by specifying a different homeserver URL. This allows you to use Element with an existing Matrix account on a different homeserver."),button:Object(o.a)("Dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")};t.a=({title:e,dialogTitle:t,serverConfig:s,onServerConfigChange:n})=>{const h=c.a.get().disable_custom_urls;let m;if(!h&&n){const e=()=>{((e,t,s)=>{l.a.createTrackedDialog("Server Picker","",d.a,{title:e,serverConfig:t,onFinished:s})})(t,s,e=>{e&&n(e)})};m=i.a.createElement(a.a,{className:"mx_ServerPicker_change",kind:"link",onClick:e},Object(o.a)("Edit"))}let p,g=s.isNameResolvable?s.hsName:s.hsUrl;return s.hsNameIsDifferent&&(g=i.a.createElement(r.a,{class:"mx_Login_underlinedServerName",tooltip:s.hsUrl},s.hsName)),"matrix.org"===s.hsName&&(p=i.a.createElement("span",{className:"mx_ServerPicker_desc"},Object(o.a)("Join millions for free on the largest public server"))),i.a.createElement("div",{className:"mx_ServerPicker"},i.a.createElement("h3",null,e||Object(o.a)("Homeserver")),h?null:i.a.createElement(a.a,{className:"mx_ServerPicker_help",onClick:u}),i.a.createElement("span",{className:"mx_ServerPicker_server"},g),m,p)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return I}));var n,i,a,o,r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(231),u=s(962),m=s(90),p=s(84),g=s(93),v=s(822),f=s(160),b=s(334),y=s(278),E=s(124),S=s(101),_=s(963),w=s(85),C=s(406),O=s(1),k=s(581);!function(e){e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm"}(o||(o={}));const R=3;let I=Object(w.a)("views.auth.RegistrationForm")((a=i=class extends d.a.PureComponent{constructor(e){super(e),c()(this,"onSubmit",async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);E.a.instance.track("onboarding_registration_submit_warn"),m.a.createTrackedDialog("Email prompt dialog","",_.a,{onFinished:async(t,s)=>{t&&this.setState({email:s},()=>{this.doSubmit(e)})}})}else this.doSubmit(e);else E.a.instance.track("onboarding_registration_submit_failed")}),c()(this,"onEmailChange",e=>{this.setState({email:e.target.value})}),c()(this,"onEmailValidate",e=>{this.markFieldValid(o.Email,e.valid)}),c()(this,"validateEmailRules",Object(f.a)({description:()=>Object(p.a)("Use an email address to recover your account"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>Object(p.a)("Enter email address (required on this homeserver)")},{key:"email",test:({value:e})=>!e||h.a(e),invalid:()=>Object(p.a)("Doesn't look like a valid email address")}]})),c()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),c()(this,"onPasswordValidate",e=>{this.markFieldValid(o.Password,e.valid)}),c()(this,"onPasswordConfirmChange",e=>{this.setState({passwordConfirm:e.target.value})}),c()(this,"onPasswordConfirmValidate",e=>{this.markFieldValid(o.PasswordConfirm,e.valid)}),c()(this,"onPhoneCountryChange",e=>{this.setState({phoneCountry:e.iso2})}),c()(this,"onPhoneNumberChange",e=>{this.setState({phoneNumber:e.target.value})}),c()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(o.PhoneNumber,t.valid),t}),c()(this,"validatePhoneNumberRules",Object(f.a)({description:()=>Object(p.a)("Other users can invite you to rooms using your contact details"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>Object(p.a)("Enter phone number (required on this homeserver)")},{key:"email",test:({value:e})=>!e||Object(u.c)(e),invalid:()=>Object(p.a)("That phone number doesn't look quite right, please check and try again")}]})),c()(this,"onUsernameChange",e=>{this.setState({username:e.target.value})}),c()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(o.Username,t.valid),t}),c()(this,"validateUsernameRules",Object(f.a)({description:(e,t)=>{if(!t.every(({key:e,valid:t})=>"available"===e||t))return Object(p.a)("Use lowercase letters, numbers, dashes and underscores only")},hideDescriptionIfValid:!0,rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(p.a)("Enter username")},{key:"safeLocalpart",test:({value:e})=>!e||v.a.test(e),invalid:()=>Object(p.a)("Some characters not allowed")},{key:"available",final:!0,test:async({value:e})=>{if(!e)return!0;try{return await this.props.matrixClient.isUsernameAvailable(e),!0}catch(e){return!1}},invalid:()=>Object(p.a)("Someone already has that username. Try another or if it is you, sign in below.")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||"",passwordComplexity:null},E.a.instance.track("onboarding_registration_begin")}doSubmit(e){const t=this.state.email.trim();E.a.instance.track("onboarding_registration_submit_ok",{email:!!t});const s=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});s&&(e.target.disabled=!0,s.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[o.Username,o.Password,o.PasswordConfirm,o.Email,o.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}authStepIsRequired(e){return this.props.flows.every(t=>t.stages.includes(e))}authStepIsUsed(e){return this.props.flows.some(t=>t.stages.includes(e))}showEmail(){return!!this.authStepIsUsed("m.login.email.identity")}showPhoneNumber(){return!(g.a.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?Object(p.a)("Email"):Object(p.a)("Email (optional)");return d.a.createElement(b.a,{fieldRef:e=>this[o.Email]=e,label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate,onFocus:()=>E.a.instance.track("onboarding_registration_email_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_email_blur")})}renderPassword(){return d.a.createElement(y.a,{id:"mx_RegistrationForm_password",fieldRef:e=>this[o.Password]=e,minScore:R,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,onFocus:()=>E.a.instance.track("onboarding_registration_password_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_password_blur")})}renderPasswordConfirm(){return d.a.createElement(k.a,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>this[o.PasswordConfirm]=e,autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate,onFocus:()=>E.a.instance.track("onboarding_registration_passwordConfirm_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_passwordConfirm_blur")})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?Object(p.a)("Phone"):Object(p.a)("Phone (optional)"),t=d.a.createElement(C.a,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return d.a.createElement(S.a,{ref:e=>this[o.PhoneNumber]=e,type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return d.a.createElement(S.a,{id:"mx_RegistrationForm_username",ref:e=>this[o.Username]=e,type:"text",autoFocus:!0,label:Object(p.a)("Username"),placeholder:Object(p.a)("Username").toLocaleLowerCase(),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate,onFocus:()=>E.a.instance.track("onboarding_registration_username_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_username_blur")})}render(){const e=d.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(p.a)("Register"),disabled:!this.props.canSubmit});let t=null;return this.showEmail()&&(t=this.showPhoneNumber()?d.a.createElement("div",null,Object(p.a)("Add an email to be able to reset your password.")," ",Object(p.a)("Use email or phone to optionally be discoverable by existing contacts.")):d.a.createElement("div",null,Object(p.a)("Add an email to be able to reset your password.")," ",Object(p.a)("Use email to optionally be discoverable by existing contacts."))),d.a.createElement("div",null,d.a.createElement("form",{onSubmit:this.onSubmit},d.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),d.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),d.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}},c()(i,"defaultProps",{onValidationChange:O.a.error,canSubmit:!0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(962),l=s(93),d=s(84),h=s(85),u=s(229);const m={};for(const e of c.a)m[e.iso2]=e;function p(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||(t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e))}let g=Object(h.a)("views.auth.CountryDropdown")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onSearchChange",e=>{this.setState({searchQuery:e})}),a()(this,"onOptionChange",e=>{this.props.onOptionChange(m[e])}),a()(this,"getShortOption",e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+m[e].prefix),r.a.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)});let t=c.a[0];const s=l.a.get().defaultCountryCode;if(s){const e=c.a.find(e=>e.iso2===s.toUpperCase());e&&(t=e)}this.state={searchQuery:"",defaultCountry:t}}componentDidMount(){this.props.value||this.props.onOptionChange(this.state.defaultCountry)}flagImgForIso2(e){return r.a.createElement("div",{className:"mx_Dropdown_option_emoji"},Object(c.b)(e))}render(){let e;if(this.state.searchQuery){if(e=c.a.filter(p.bind(this,this.state.searchQuery)),2==this.state.searchQuery.length&&m[this.state.searchQuery.toUpperCase()]){const t=m[this.state.searchQuery.toUpperCase()];e=e.filter(e=>e.iso2!=t.iso2),e.unshift(t)}}else e=c.a;const t=e.map(e=>r.a.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),Object(d.a)(e.name)," (+",e.prefix,")")),s=this.props.value||this.state.defaultCountry.iso2;return r.a.createElement(u.a,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:s,searchEnabled:!0,disabled:this.props.disabled,label:Object(d.a)("Country Dropdown")},t)}})||n},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(112),d=s(91),h=s.n(d),u=s(121),m=s(88),p=s(84),g=s(327),v=s(111),f=s(103);const b=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini"],y=e=>{let{matrixClient:t,loginType:n,fragmentAfterLogin:a,idp:r,primary:l,mini:d}=e,y=o()(e,b);const E=r?Object(p.a)("Continue with %(provider)s",{provider:r.name}):Object(p.a)("Sign in with single sign-on"),S=()=>{u.a.get().startSingleSignOn(t,n,a,null==r?void 0:r.id)};let _,w;const C=r?(e=>{switch(e){case g.a.Apple:return s(1615);case g.a.Facebook:return s(1616);case g.a.Github:return s(1617);case g.a.Gitlab:return s(1618);case g.a.Google:return s(1619);case g.a.Twitter:return s(1620);default:return null}})(r.brand):null;if(C){const e=r.brand.split(".").pop();w="mx_SSOButton_brand_"+e,_=c.a.createElement("img",{src:C,height:"24",width:"24",alt:e})}else if("string"==typeof(null==r?void 0:r.icon)&&r.icon.startsWith("mxc://")){const e=Object(f.b)(r.icon,t).getSquareThumbnailHttp(24);_=c.a.createElement("img",{src:e,height:"24",width:"24",alt:r.name})}const O=h()("mx_SSOButton",{[w]:w,mx_SSOButton_mini:d,mx_SSOButton_default:!r,mx_SSOButton_primary:l});return d?c.a.createElement(v.a,i()({},y,{title:E,className:O,onClick:S}),_):c.a.createElement(m.a,i()({},y,{className:O,onClick:S}),_,E)};t.a=({matrixClient:e,flow:t,loginType:s,fragmentAfterLogin:n,primary:i})=>{const a=t.identity_providers||[];if(a.length<2)return c.a.createElement("div",{className:"mx_SSOButtons"},c.a.createElement(y,{matrixClient:e,loginType:s,fragmentAfterLogin:n,idp:a[0],primary:i}));const o=Math.ceil(a.length/6),r=Math.ceil(a.length/o);return c.a.createElement("div",{className:"mx_SSOButtons"},Object(l.chunk)(a,r).map(t=>c.a.createElement("div",{key:t[0].id,className:"mx_SSOButtons_row"},t.map(t=>c.a.createElement(y,{key:t.id,matrixClient:e,loginType:s,fragmentAfterLogin:n,idp:t,mini:!0,primary:i})))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(248),o=s(1);class r extends a.a{static set matrixClient(e){const t=r._matrixClient;r._matrixClient=e;for(const s of r.instances)s.initMatrixClient(t,e)}constructor(){super(),r.instances.push(this)}get client(){return r._matrixClient}initMatrixClient(e,t){o.a.warn("initMatrixClient not overridden")}}i()(r,"_matrixClient",void 0),i()(r,"instances",[])},,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(99),i=s.n(n),a=s(5),o=s(286),r=s(344),c=s(4),l=s(604),d=s(1);function h(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const i=[];n.onerror=()=>{t(new Error("Query failed: "+n.error))},n.onsuccess=()=>{const t=n.result;t?(i.push(s(t)),t.continue()):e(i)}})}function u(e){return new Promise((t,s)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){s(e.error)}})}function m(e){return new Promise((t,s)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){s(e.error)}})}function p(e){return m(e).then(t=>e.result)}class g{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),l.a(e,t)}constructor(e,t){this.indexedDB=e,i()(this,"dbName",void 0),i()(this,"syncAccumulator",void 0),i()(this,"db",null),i()(this,"disconnected",!0),i()(this,"_isNewlyCreated",!1),this.dbName="matrix-js-sdk:"+(t||"default"),this.syncAccumulator=new r.b}connect(){if(!this.disconnected)return d.a.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,d.a.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this.dbName,3);return e.onupgradeneeded=t=>{const s=e.result,n=t.oldVersion;d.a.log("LocalIndexedDBStoreBackend.connect: upgrading from "+n),n<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(s)),n<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(s),n<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(s)},e.onblocked=()=>{d.a.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},d.a.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),m(e).then(()=>(d.a.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.result,this.db.onversionchange=()=>{this.db.close()},this.init()))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(([e,t])=>{d.a.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,groups:t.groupsData,account_data:{events:e}},!0)})}getOutOfBandMembers(e){return new Promise((t,s)=>{const n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),a=n.openCursor(i),o=[];let r=!1;a.onsuccess=()=>{const e=a.result;if(!e)return o.length||r?t(o):t(null);const s=e.value;s.oob_written?r=!0:o.push(s),e.continue()},a.onerror=e=>{s(e)}}).then(t=>(d.a.log(`LL: got ${t&&t.length} membershipEvents from storage for room ${e} ...`),t))}async setOutOfBandMembers(e,t){d.a.log("LL: backend about to store "+t.length+" members for "+e);const s=this.db.transaction(["oob_membership_events"],"readwrite"),n=s.objectStore("oob_membership_events");t.forEach(e=>{n.put(e)});const i={room_id:e,oob_written:!0,state_key:0};n.put(i),await u(s),d.a.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),s=IDBKeyRange.only(e),n=p(t.openKeyCursor(s,"next")).then(e=>e&&e.primaryKey[1]),i=p(t.openKeyCursor(s,"prev")).then(e=>e&&e.primaryKey[1]),[a,o]=await Promise.all([n,i]),r=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),c=IDBKeyRange.bound([e,a],[e,o]);var l;d.a.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,a],[e,o]),await(l=r.delete(c),new Promise((e,t)=>{l.onsuccess=()=>e(l),l.onerror=e=>t(e)}))}clearDatabase(){return new Promise(e=>{d.a.log("Removing indexeddb instance: "+this.dbName);const t=this.indexedDB.deleteDatabase(this.dbName);t.onblocked=()=>{d.a.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},t.onerror=()=>{d.a.warn("unable to delete js-sdk store indexeddb: "+t.error),e()},t.onsuccess=()=>{d.a.log("Removed indexeddb instance: "+this.dbName),e()}})}getSavedSync(e=!0){const t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(c.j(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}async syncToDatabase(e){const t=this.syncAccumulator.getJSON(!0);await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])}persistSyncData(e,t,s){return d.a.log("Persisting sync data up to",e),c.C(()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:s}),u(n).then()})}persistAccountData(e){return c.C(()=>{const t=this.db.transaction(["accountData"],"readwrite"),s=t.objectStore("accountData");for(let t=0;t<e.length;t++)s.put(e[t]);return u(t).then()})}persistUserPresenceEvents(e){return c.C(()=>{const t=this.db.transaction(["users"],"readwrite"),s=t.objectStore("users");for(const t of e)s.put({userId:t[0],event:t[1]});return u(t).then()})}getUserPresenceEvents(){return c.C(()=>h(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))}loadAccountData(){return d.a.log("LocalIndexedDBStoreBackend: loading account data..."),c.C(()=>h(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(d.a.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}loadSyncData(){return d.a.log("LocalIndexedDBStoreBackend: loading sync data..."),c.C(()=>h(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(d.a.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&d.a.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}getClientOptions(){return Promise.resolve().then(()=>h(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{if(e.value&&e.value&&e.value.options)return e.value.options}).then(e=>e[0]))}async storeClientOptions(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await u(t)}}class v{constructor(e,t){this.workerFactory=e,this.dbName=t,i()(this,"worker",void 0),i()(this,"nextSeq",0),i()(this,"inFlight",{}),i()(this,"startPromise",null),i()(this,"onWorkerMessage",e=>{const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void d.a.error("Got reply from worker with no seq");const e=this.inFlight[t.seq];if(void 0===e)return void d.a.error("Got reply for unknown seq "+t.seq);if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const s=new Error(t.error.message);s.name=t.error.name,e.reject(s)}}else d.a.warn("Unrecognised message from worker: ",t)})}connect(){return this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}ensureStarted(){return null===this.startPromise&&(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("_setupWorker",[this.dbName]).then(()=>{d.a.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{const s=this.nextSeq++,n=Object(c.l)();return this.inFlight[s]=n,this.worker.postMessage({command:e,seq:s,args:t}),n.promise})}}var f=s(223),b=s(117);class y extends o.a{static exists(e,t){return g.exists(e,t)}constructor(e){if(super(e),i()(this,"backend",void 0),i()(this,"startedUp",!1),i()(this,"syncTs",0),i()(this,"userModifiedMap",{}),i()(this,"emitter",new a.EventEmitter),i()(this,"on",this.emitter.on.bind(this.emitter)),i()(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),i()(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),i()(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),i()(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{d.a.log("Deleted indexeddb data.")},e=>{throw d.a.error("Failed to delete indexeddb data: "+e),e})))),i()(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),i()(this,"setSyncData",this.degradable(e=>this.backend.setSyncData(e),"setSyncData")),i()(this,"getOutOfBandMembers",this.degradable(e=>this.backend.getOutOfBandMembers(e),"getOutOfBandMembers")),i()(this,"setOutOfBandMembers",this.degradable((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t)),"setOutOfBandMembers")),i()(this,"clearOutOfBandMembers",this.degradable(e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e)),"clearOutOfBandMembers")),i()(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),i()(this,"storeClientOptions",this.degradable(e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new v(e.workerFactory,e.dbName):this.backend=new g(e.indexedDB,e.dbName)}startup(){return this.startedUp?(d.a.log("IndexedDBStore.startup: already started"),Promise.resolve()):(d.a.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then(()=>(d.a.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{d.a.log("IndexedDBStore.startup: processing presence events"),e.forEach(([e,t])=>{const s=new f.a(e);t&&s.setPresenceEvent(new b.b(t)),this.userModifiedMap[s.userId]=s.getLastModifiedTime(),this.storeUser(s)})}))}wantsSave(){return Date.now()-this.syncTs>3e5}save(e=!1){return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){const s=super[t];return async(...t)=>{try{return e.call(this,...t)}catch(e){d.a.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emitter.emit("degraded",e);try{d.a.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),d.a.log("IndexedDBStore delete after degrading succeeded")}catch(e){d.a.warn("IndexedDBStore delete after degrading failed",e)}if(s)return s(...t)}}}}},function(e,t,s){"use strict";s.d(t,"e",(function(){return u})),s.d(t,"d",(function(){return m})),s.d(t,"g",(function(){return p})),s.d(t,"c",(function(){return g})),s.d(t,"f",(function(){return v})),s.d(t,"a",(function(){return f})),s.d(t,"b",(function(){return y}));var n=s(83),i=s.n(n),a=s(1254),o=s.n(a);class r{constructor(e){i()(this,"_regex",void 0);const t=o()(e,{extended:!1,globstar:!1}).toString().replace(/\\\?/g,".");this._regex=new RegExp(t.substring(1,t.length-1))}test(e){return this._regex.test(e)}}const c=["m.ban","org.matrix.mjolnir.ban"];function l(e,t=!0){return c.includes(e)?t?c[c.length-1]:"m.ban":null}class d{constructor(e,t,s,n){i()(this,"_glob",void 0),i()(this,"_entity",void 0),i()(this,"_action",void 0),i()(this,"_reason",void 0),i()(this,"_kind",void 0),this._glob=new r(e),this._entity=e,this._action=l(t,!1),this._reason=s,this._kind=n}get entity(){return this._entity}get reason(){return this._reason}get kind(){return this._kind}get recommendation(){return this._action}isMatch(e){return this._glob.test(e)}}var h=s(86);const u="m.room.rule.user",m="m.room.rule.server",p=[u,"org.matrix.mjolnir.rule.user"],g=["m.room.rule.room","org.matrix.mjolnir.rule.room"],v=[m,"org.matrix.mjolnir.rule.server"],f=[...p,...g,...v];function b(e,t=!0){return p.includes(e)?t?p[p.length-1]:u:g.includes(e)?t?g[g.length-1]:"m.room.rule.room":v.includes(e)?t?v[v.length-1]:m:null}class y{constructor(e){i()(this,"_rules",[]),i()(this,"_roomId",void 0),this._roomId=e,this.updateList()}get roomId(){return this._roomId}get serverRules(){return this._rules.filter(e=>e.kind===m)}get userRules(){return this._rules.filter(e=>e.kind===u)}get roomRules(){return this._rules.filter(e=>"m.room.rule.room"===e.kind)}async banEntity(e,t,s){await h.a.get().sendStateEvent(this._roomId,b(e,!0),{entity:t,reason:s,recommendation:l("m.ban",!0)},"rule:"+t),this._rules.push(new d(t,"m.ban",s,b(e,!1)))}async unbanEntity(e,t){await h.a.get().sendStateEvent(this._roomId,b(e,!0),{},"rule:"+t),this._rules=this._rules.filter(s=>s.kind!==b(e,!1)||s.entity!==t)}updateList(){this._rules=[];const e=h.a.get().getRoom(this._roomId);if(e)for(const t of f){const s=e.currentState.getStateEvents(t);for(const e of s){if(!e.getStateKey())continue;const s=b(t,!1),n=e.getContent().entity,i=e.getContent().recommendation,a=e.getContent().reason;n&&i&&a&&this._rules.push(new d(n,i,a,s))}}}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return Z})),s.d(t,"c",(function(){return ee})),s.d(t,"a",(function(){return te})),s.d(t,"d",(function(){return ce}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(84),d=s(86),h=s(120),u=s(130),m=s(93),p=s(231),g=s(296),v=s(256),f=s(87),b=s(210),y=s(90);var E,S,_,w=s(141),C=s(159),O=s(108),k=s(92),R=s(147),I=s(165),x=s(193),T=s(89),j=s(115),N=s(124),P=s(85),D=s(103),M=s(295),A=s(125),U=s(88),L=s(143),F=s(111),B=s(105),V=s(314),K=s(101),W=s(253),G=s(390),H=s(113),q=s(96),$=s(97),z=s(541),J=s(106),Y=s(1);function Q(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function X(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Q(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const Z="dm",ee="invite",te="call_transfer";var se;!function(e){e.UserDirectory="users",e.DialPad="dialpad"}(se||(se={}));class ne{}class ie extends ne{constructor(e){super(),i()(this,"_userId",void 0),i()(this,"displayName",void 0),i()(this,"avatarUrl",void 0),this._userId=e.user_id,this.displayName=e.display_name,this.avatarUrl=e.avatar_url}get name(){return this.displayName||this._userId}get userId(){return this._userId}getMxcAvatarUrl(){return this.avatarUrl}}class ae extends ne{constructor(e){super(),i()(this,"id",void 0),this.id=e}get isEmail(){return this.id.includes("@")}get name(){return this.id}get userId(){return this.id}getMxcAvatarUrl(){return null}}class oe extends o.a.PureComponent{constructor(...e){super(...e),i()(this,"onRemove",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRemove(this.props.member)})}render(){const e=this.props.member.isEmail?o.a.createElement("img",{className:"mx_InviteDialog_userTile_avatar mx_InviteDialog_userTile_threepidAvatar",src:s(812),width:20,height:20}):o.a.createElement(A.a,{className:"mx_InviteDialog_userTile_avatar",url:this.props.member.getMxcAvatarUrl()?Object(D.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(20):null,name:this.props.member.name,idName:this.props.member.userId,width:20,height:20});let t;return this.props.onRemove&&(t=o.a.createElement(U.a,{className:"mx_InviteDialog_userTile_remove",onClick:this.onRemove},o.a.createElement("img",{src:s(1561),alt:Object(l.a)("Remove"),width:8,height:8}))),o.a.createElement("span",{className:"mx_InviteDialog_userTile"},o.a.createElement("span",{className:"mx_InviteDialog_userTile_pill"},e,o.a.createElement("span",{className:"mx_InviteDialog_userTile_name"},this.props.member.name)),t)}}class re extends o.a.PureComponent{constructor(...e){super(...e),i()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onToggle(this.props.member)})}highlightName(e){if(!this.props.highlightWord)return e;const t=e.toLowerCase(),s=this.props.highlightWord.toLowerCase(),n=[];let i,a=0;for(;(i=t.indexOf(s,a))>=0;){i>a&&n.push(o.a.createElement("span",{key:a+"begin"},e.substring(a,i))),a=i;const t=e.substring(a,s.length+a);n.push(o.a.createElement("span",{className:"mx_InviteDialog_roomTile_highlight",key:a+"bold"},t)),a+=t.length}return a<e.length&&n.push(o.a.createElement("span",{key:a+"end"},e.substring(a))),n}render(){let e=null;if(this.props.lastActiveTs){const t=function(e){let t=(new Date).getTime()-e;const s=Math.abs(Math.ceil(t/6e4)),n=Math.ceil(s/60),i=Math.ceil(n/24);return t>=0?t<=15e3?Object(l.a)("a few seconds ago"):t<=75e3?Object(l.a)("about a minute ago"):s<=45?Object(l.a)("%(num)s minutes ago",{num:s}):s<=75?Object(l.a)("about an hour ago"):n<=23?Object(l.a)("%(num)s hours ago",{num:n}):n<=26?Object(l.a)("about a day ago"):Object(l.a)("%(num)s days ago",{num:i}):(t=Math.abs(t),t<=15e3?Object(l.a)("a few seconds from now"):t<=75e3?Object(l.a)("about a minute from now"):s<=45?Object(l.a)("%(num)s minutes from now",{num:s}):s<=75?Object(l.a)("about an hour from now"):n<=23?Object(l.a)("%(num)s hours from now",{num:n}):n<=26?Object(l.a)("about a day from now"):Object(l.a)("%(num)s days from now",{num:i}))}(this.props.lastActiveTs);e=o.a.createElement("span",{className:"mx_InviteDialog_roomTile_time"},t)}const t=this.props.member.isEmail?o.a.createElement("img",{src:s(812),width:36,height:36}):o.a.createElement(A.a,{url:this.props.member.getMxcAvatarUrl()?Object(D.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(36):null,name:this.props.member.name,idName:this.props.member.userId,width:36,height:36});let n=null;this.props.isSelected&&(n=o.a.createElement("div",{className:"mx_InviteDialog_roomTile_selected"}));const i=o.a.createElement("span",{className:"mx_InviteDialog_roomTile_avatarStack"},t,n),a=this.props.member.isEmail?Object(l.a)("Invite by email"):this.highlightName(this.props.member.userId);return o.a.createElement("div",{className:"mx_InviteDialog_roomTile",onClick:this.onClick},i,o.a.createElement("span",{className:"mx_InviteDialog_roomTile_nameStack"},o.a.createElement("div",{className:"mx_InviteDialog_roomTile_name"},this.highlightName(this.props.member.name)),o.a.createElement("div",{className:"mx_InviteDialog_roomTile_userId"},a)),e)}}let ce=Object(P.a)("views.dialogs.InviteDialog")((_=S=class e extends o.a.PureComponent{constructor(t){if(super(t),i()(this,"closeCopiedTooltip",void 0),i()(this,"debounceTimer",null),i()(this,"editorRef",Object(a.createRef)()),i()(this,"numberEntryFieldRef",Object(a.createRef)()),i()(this,"unmounted",!1),i()(this,"onConsultFirstChange",e=>{this.setState({consultFirst:e.target.checked})}),i()(this,"startDm",async()=>{this.setState({busy:!0});const e=d.a.get(),t=this.convertFilter(),s=t.map(e=>e.userId);let n;if(n=1===s.length?Object(w.e)(e,s[0]):u.a.shared().getDMRoomForIdentifiers(s),n)return f.a.dispatch({action:k.a.ViewRoom,room_id:n.roomId,should_peek:!1,joining:!1}),void this.props.onFinished();const i={inlineErrors:!0};if(Object(w.f)()){if(!t.some(e=>e instanceof ae)){await Object(w.a)(e,s)&&(i.encryption=!0)}}try{const t=1===s.length&&s[0]===e.getUserId();1!==s.length||t||(i.dmUserId=s[0]),s.length>1&&(i.createOpts=s.reduce((t,s)=>{const n=Object(M.c)(s);if("email"===n){const n={id_server:e.getIdentityServerUrl(!0),medium:"email",address:s};t.invite_3pid.push(n)}else"mx-user-id"===n&&t.invite.push(s);return t},{invite:[],invite_3pid:[]})),await Object(w.b)(i),this.props.onFinished()}catch(e){Y.a.error(e),this.setState({busy:!1,errorText:Object(l.a)("We couldn't create your DM.")})}}),i()(this,"inviteUsers",async()=>{const e=N.a.getTimestamp();this.setState({busy:!0}),this.convertFilter();const t=this.convertFilter().map(e=>e.userId),s=d.a.get(),n=s.getRoom(this.props.roomId);if(!n)return Y.a.error("Failed to find the room to invite users to"),void this.setState({busy:!1,errorText:Object(l.a)("Something went wrong trying to invite the users.")});try{const i=await Object(C.a)(this.props.roomId,t);if(N.a.instance.trackSendInvite(e,this.props.roomId,t.length),this.shouldAbortAfterInviteError(i,n)||this.props.onFinished(),s.isRoomEncrypted(this.props.roomId)){const e=n.currentState.getStateEvents("m.room.history_visibility",""),t=e&&e.getContent()&&e.getContent().history_visibility;if("world_readable"==t||"shared"==t){const e=[];for(const[t,s]of Object.entries(i.states))"invited"===s&&"mx-user-id"===Object(M.c)(t)&&e.push(t);Y.a.log("Sharing history with",e),s.sendSharedHistoryKeys(this.props.roomId,e)}}}catch(e){Y.a.error(e),this.setState({busy:!1,errorText:Object(l.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})}}),i()(this,"transferCall",async()=>{if(this.state.currentTabId==se.UserDirectory){this.convertFilter();const e=this.convertFilter().map(e=>e.userId);if(e.length>1)return void this.setState({errorText:Object(l.a)("A call can only be transferred to a single user.")});f.a.dispatch({action:k.a.TransferCallToMatrixID,call:this.props.call,destination:e[0],consultFirst:this.state.consultFirst})}else f.a.dispatch({action:k.a.TransferCallToPhoneNumber,call:this.props.call,destination:this.state.dialPadValue,consultFirst:this.state.consultFirst});this.props.onFinished()}),i()(this,"onKeyDown",e=>{if(this.state.busy)return;const t=e.target.value.trim(),s=e.ctrlKey||e.shiftKey||e.metaKey;!t&&this.state.targets.length>0&&e.key===O.a.BACKSPACE&&!s?(e.preventDefault(),this.removeMember(this.state.targets[this.state.targets.length-1])):(t&&e.key===O.a.ENTER&&!s||t&&e.key===O.a.SPACE&&!s&&t.includes("@")&&!t.includes(" "))&&(e.preventDefault(),this.convertFilter())}),i()(this,"onCancel",()=>{this.props.onFinished([])}),i()(this,"updateSuggestions",async e=>{if(d.a.get().searchUserDirectory({term:e}).then(async t=>{if(e===this.state.filterText){if(t.results||(t.results=[]),"@"===e[0]&&e.indexOf(":")>1)try{const s=await d.a.get().getProfileInfo(e);s&&t.results.splice(0,0,{user_id:e,display_name:s.displayname,avatar_url:s.avatar_url})}catch(s){Y.a.warn("Non-fatal error trying to make an invite for a user ID"),Y.a.warn(s),t.results.splice(0,0,{user_id:e,display_name:e,avatar_url:null})}this.setState({serverResultsMixin:t.results.map(e=>({userId:e.user_id,user:new ie(e)}))})}}).catch(e=>{Y.a.error("Error searching user directory:"),Y.a.error(e),this.setState({serverResultsMixin:[]})}),this.state.canUseIdentityServer){if(e.indexOf("@")>0&&p.a(e)&&T.b.getValue(j.b.IdentityServer)){this.setState({threepidResultsMixin:[{user:new ae(e),userId:e}]});try{const t=new b.a,s=await t.getAccessToken();if(e!==this.state.filterText)return;const n=await d.a.get().lookupThreePid("email",e,void 0,s);if(e!==this.state.filterText)return;if(!n||!n.mxid)return;const i=await d.a.get().getProfileInfo(n.mxid);if(e!==this.state.filterText||!i)return;this.setState({threepidResultsMixin:[...this.state.threepidResultsMixin,{user:new ie({user_id:n.mxid,display_name:i.displayname,avatar_url:i.avatar_url}),userId:n.mxid}]})}catch(e){Y.a.error("Error searching identity server:"),Y.a.error(e),this.setState({threepidResultsMixin:[]})}}}else this.setState({tryingIdentityServer:!0})}),i()(this,"updateFilter",e=>{const t=e.target.value;this.setState({filterText:t}),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.updateSuggestions(t)},150)}),i()(this,"showMoreRecents",()=>{this.setState({numRecentsShown:this.state.numRecentsShown+5})}),i()(this,"showMoreSuggestions",()=>{this.setState({numSuggestionsShown:this.state.numSuggestionsShown+5})}),i()(this,"toggleMember",e=>{if(!this.state.busy){let t=this.state.filterText,s=this.state.targets.map(e=>e);const n=s.indexOf(e);n>=0?s.splice(n,1):(this.props.kind===te&&s.length>0&&(s=[]),s.push(e),t=""),this.setState({targets:s,filterText:t}),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}}),i()(this,"removeMember",e=>{const t=this.state.targets.map(e=>e),s=t.indexOf(e);s>=0&&(t.splice(s,1),this.setState({targets:t})),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}),i()(this,"onPaste",async e=>{if(this.state.filterText)return;e.preventDefault();const t=e.clipboardData.getData("text"),s=[...this.state.recents,...this.state.suggestions,...this.state.serverResultsMixin,...this.state.threepidResultsMixin],n=[],i=[],a=t.split(/[\s,]+/).map(e=>e.trim()).filter(e=>!!e);for(const t of a){const a=s.find(e=>e.userId===t);if(a)n.push(a.user);else if(t.indexOf("@")>0&&p.a(t))n.push(new ae(t));else if("@"===t[0])try{const e=await d.a.get().getProfileInfo(t),s=e?e.displayname:null,i=e?e.avatar_url:null;n.push(new ie({user_id:t,display_name:s,avatar_url:i}))}catch(e){Y.a.error("Error looking up profile for "+t),Y.a.error(e),i.push(t)}else i.push(t)}this.unmounted||(i.length>0&&y.a.createTrackedDialog("Invite Paste Fail","",H.a,{title:Object(l.a)("Failed to find the following users"),description:Object(l.a)("The following users might not exist or are invalid, and cannot be invited: %(csvNames)s",{csvNames:i.join(", ")}),button:Object(l.a)("OK")}),this.setState({targets:[...this.state.targets,...n]}))}),i()(this,"onClickInputArea",e=>{e.preventDefault(),e.stopPropagation(),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}),i()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(g.d)(),this.setState({canUseIdentityServer:!0,tryingIdentityServer:!1})}),i()(this,"onManageSettingsClick",e=>{e.preventDefault(),f.a.fire(k.a.ViewUserSettings),this.props.onFinished()}),i()(this,"onCommunityInviteClick",e=>{this.props.onFinished(),Object(C.e)(x.a.instance.getSelectedCommunityId())}),i()(this,"onDialFormSubmit",e=>{e.preventDefault(),this.transferCall()}),i()(this,"onDialChange",e=>{this.setState({dialPadValue:e.currentTarget.value})}),i()(this,"onDigitPress",(e,t)=>{var s;(this.setState({dialPadValue:this.state.dialPadValue+e}),"click"===t.type)&&(null===(s=this.numberEntryFieldRef.current)||void 0===s||s.focus())}),i()(this,"onDeletePress",e=>{var t;0!==this.state.dialPadValue.length&&(this.setState({dialPadValue:this.state.dialPadValue.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))}),i()(this,"onTabChange",e=>{this.setState({currentTabId:e})}),i()(this,"onCopyClick",async e=>{e.preventDefault();const t=e.target,s=await Object(L.c)(Object(h.h)(d.a.get().getUserId())),n=t.getBoundingClientRect(),{close:i}=B.m(V.a,X(X({},Object(B.o)(n,2)),{},{message:s?Object(l.a)("Copied!"):Object(l.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=i}),t.kind===ee&&!t.roomId)throw new Error("When using KIND_INVITE a roomId is required for an InviteDialog");if(t.kind===te&&!t.call)throw new Error("When using KIND_CALL_TRANSFER a call is required for an InviteDialog");const s=new Set([d.a.get().getUserId(),m.a.get().welcomeUserId]);if(t.roomId){const e=d.a.get().getRoom(t.roomId);if(!e)throw new Error("Room ID given to InviteDialog does not look like a room");e.getMembersWithMembership("invite").forEach(e=>s.add(e.userId)),e.getMembersWithMembership("join").forEach(e=>s.add(e.userId)),e.getMembersWithMembership("ban").forEach(e=>s.add(e.userId)),N.a.instance.trackBeginInvite(t.roomId)}this.state={targets:[],filterText:this.props.initialText,recents:e.buildRecents(s),numRecentsShown:3,suggestions:this.buildSuggestions(s),numSuggestionsShown:3,serverResultsMixin:[],threepidResultsMixin:[],canUseIdentityServer:!!d.a.get().getIdentityServerUrl(),tryingIdentityServer:!1,consultFirst:!1,dialPadValue:"",currentTabId:se.UserDirectory,busy:!1,errorText:null}}componentDidMount(){this.props.initialText&&this.updateSuggestions(this.props.initialText)}componentWillUnmount(){this.unmounted=!0,this.closeCopiedTooltip&&this.closeCopiedTooltip()}static buildRecents(e){const t=u.a.shared().getUniqueRoomsWithIndividuals(),s=I.b.instance.orderedLists[R.a.DM]||[],n=d.a.get().getUserId();for(const e of s){const s=e.getJoinedMembers().filter(e=>e.userId!==n);for(const n of s)t[n.userId]||(Y.a.warn(`Adding DM room for ${n.userId} as ${e.roomId} from tag, not DM map`),t[n.userId]=e)}const i=[];for(const s in t){if(e.has(s)){Y.a.warn(`[Invite:Recents] Excluding ${s} from recents`);continue}const n=t[s],a=n.getMember(s);if(!a){Y.a.warn(`[Invite:Recents] ${s} is missing a member object in their own DM (${n.roomId})`);continue}const o=["m.room.message","m.room.encrypted","m.sticker"],r=20;let c=0;if(n.timeline&&n.timeline.length)for(let e=n.timeline.length-1;e>=0;e--){const t=n.timeline[e];if(o.includes(t.getType())){c=t.getTs();break}if(n.timeline.length-e>r)break}c?i.push({userId:s,user:a,lastActive:c}):Y.a.warn(`[Invite:Recents] ${s} (${n.roomId}) has a weird last timestamp: ${c}`)}return i||Y.a.warn("[Invite:Recents] No recents to suggest!"),i.sort((e,t)=>t.lastActive-e.lastActive),i}buildSuggestions(e){const t=d.a.get().getRooms().filter(e=>"join"===e.getMyMembership()&&e.getJoinedMemberCount()<=200).reduce((t,s)=>{if(u.a.shared().getUserIdForRoomId(s.roomId))return t;const n=s.getJoinedMembers().filter(t=>!e.has(t.userId));for(const i of n)e.has(i.userId)||(t[i.userId]||(t[i.userId]={member:i,pickedMemberRoomSize:s.getJoinedMemberCount(),rooms:[]}),t[i.userId].rooms.push(s),s.getJoinedMemberCount()<t[i.userId].pickedMemberRoomSize&&(t[i.userId].member=i,t[i.userId].pickedMemberRoomSize=s.getJoinedMemberCount()));return t},{}),s=Object.values(t).reduce((e,t)=>{const s=t.rooms.reduce((e,t)=>e+t.getJoinedMemberCount(),0),n=200*t.rooms.length;return e[t.member.userId]={member:t.member,numRooms:t.rooms.length,score:Math.max(0,Math.pow(1-s/n,5))},e},{}),n=d.a.get().getRooms().filter(e=>"join"===e.getMyMembership()),i=(new Date).getTime(),a=i-36e5,o={},r={};for(const t of n){const s=u.a.shared().getUserIdForRoomId(t.roomId);if(Object.keys(t.tags).includes("m.lowpriority")||s)continue;const n=t.getLiveTimeline().getEvents();for(let s=n.length-1;s>=Math.max(0,n.length-50);s--){const i=n[s];if(!e.has(i.getSender())){if(i.getTs()<=a)break;(!o[i.getSender()]||o[i.getSender()]<i.getTs())&&(o[i.getSender()]=i.getTs(),r[i.getSender()]=t.getMember(i.getSender()))}}}for(const e in o){const t=o[e],n=r[e];if(!n)continue;const c=i-a-Math.abs(i-t),l=Math.max(1,c/9e5);let d=s[e];d||(d=s[e]={score:0}),d.member=n,d.score+=l}const c=Object.values(s);return c.sort((e,t)=>e.score===t.score?e.numRooms===t.numRooms?Object(L.a)(e.member.userId,t.member.userId):t.numRooms-e.numRooms:t.score-e.score),c.map(e=>({userId:e.member.userId,user:e.member}))}shouldAbortAfterInviteError(e,t){this.setState({busy:!1});const s=new Map(this.state.targets.map(e=>[e.userId,e]));return!Object(C.d)(e.states,t,e.inviter,s)}convertFilter(){if(!this.state.filterText||!this.state.filterText.includes("@"))return this.state.targets||[];let e;this.state.filterText.startsWith("@")?e=new ie({user_id:this.state.filterText,display_name:null,avatar_url:null}):T.b.getValue(j.b.IdentityServer)&&(e=new ae(this.state.filterText));const t=[...this.state.targets||[],e];return this.setState({targets:t,filterText:""}),t}renderSection(e){let t="recents"===e?this.state.recents:this.state.suggestions,s="recents"===e?this.state.numRecentsShown:this.state.numSuggestionsShown;const n="recents"===e?this.showMoreRecents.bind(this):this.showMoreSuggestions.bind(this);let i="recents"===e?Object(l.a)("Recent Conversations"):Object(l.a)("Suggestions"),a=null;if("suggestions"===e&&x.a.instance.getSelectedCommunityId()){const e=x.a.instance.getSelectedCommunityName();a=Object(l.a)("May include members not in %(communityName)s",{communityName:e})}this.props.kind===ee&&(i="recents"===e?Object(l.a)("Recently Direct Messaged"):Object(l.a)("Suggestions"));let r=[],c=[];const d=this.state.serverResultsMixin||this.state.threepidResultsMixin;if(this.state.filterText&&d&&"suggestions"===e){const e=e=>!t.some(t=>t.userId===e.userId)&&!r.some(t=>t.userId===e.userId)&&!c.some(t=>t.userId===e.userId);c=this.state.serverResultsMixin.filter(e),r=this.state.threepidResultsMixin.filter(e)}const h=r.length>0||c.length>0;if(0===t.length&&!h)return null;if(this.state.filterText){const e=this.state.filterText.toLowerCase();if(t=t.filter(t=>t.user.name.toLowerCase().includes(e)||t.userId.toLowerCase().includes(e)),0===t.length&&!h)return o.a.createElement("div",{className:"mx_InviteDialog_section"},o.a.createElement("h3",null,i),o.a.createElement("p",null,Object(l.a)("No results")))}t=[...r,...t,...c],s===t.length-1&&s++;const u=t.slice(0,s);let m=null;u.length<t.length&&(m=o.a.createElement(U.a,{onClick:n,kind:"link"},Object(l.a)("Show more")));const p=u.map(t=>{return o.a.createElement(re,{member:t.user,lastActiveTs:(s=t,"recents"===e?s.lastActive:null),key:t.userId,onToggle:this.toggleMember,highlightWord:this.state.filterText,isSelected:this.state.targets.some(e=>e.userId===t.userId)});var s});return o.a.createElement("div",{className:"mx_InviteDialog_section"},o.a.createElement("h3",null,i),a?o.a.createElement("p",{className:"mx_InviteDialog_subname"},a):null,p,m)}renderEditor(){const e=this.props.kind==te&&0===this.state.targets.length&&0===this.state.filterText.length,t=this.state.targets.map(e=>o.a.createElement(oe,{member:e,onRemove:!this.state.busy&&this.removeMember,key:e.userId})),s=o.a.createElement("input",{type:"text",onKeyDown:this.onKeyDown,onChange:this.updateFilter,value:this.state.filterText,ref:this.editorRef,onPaste:this.onPaste,autoFocus:!0,disabled:this.state.busy||this.props.kind==te&&this.state.targets.length>0,autoComplete:"off",placeholder:e?Object(l.a)("Search"):null});return o.a.createElement("div",{className:"mx_InviteDialog_editor",onClick:this.onClickInputArea},t,s)}renderIdentityServerWarning(){if(!this.state.tryingIdentityServer||this.state.canUseIdentityServer||!T.b.getValue(j.b.IdentityServer))return null;const e=Object(g.c)();return e?o.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(v.a)(e)},{default:e=>o.a.createElement("a",{href:"#",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>o.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)})):o.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>o.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)}))}async onLinkClick(e){e.preventDefault(),Object(L.d)(e.target)}render(){let e,t,n,i,a,r,u,m=null;this.state.busy&&(m=o.a.createElement(q.a,{w:20,h:20}));let p=o.a.createElement("span",null);const g=T.b.getValue(j.b.IdentityServer),v=this.state.targets.length>0||this.state.filterText&&this.state.filterText.includes("@"),f=d.a.get(),b=f.getUserId();if(this.props.kind===Z){if(e=Object(l.a)("Direct Messages"),t=g?Object(l.a)("Start a conversation with someone using their name, email address or username (like <userId/>).",{},{userId:()=>o.a.createElement("a",{href:Object(h.h)(b),rel:"noreferrer noopener",target:"_blank"},b)}):Object(l.a)("Start a conversation with someone using their name or username (like <userId/>).",{},{userId:()=>o.a.createElement("a",{href:Object(h.h)(b),rel:"noreferrer noopener",target:"_blank"},b)}),x.a.instance.getSelectedCommunityId()){const e=x.a.instance.getSelectedCommunityName(),s=Object(l.a)("This won't invite them to %(communityName)s. To invite someone to %(communityName)s, click <a>here</a>",{communityName:e},{userId:()=>o.a.createElement("a",{href:Object(h.h)(b),rel:"noreferrer noopener",target:"_blank"},b),a:e=>o.a.createElement(U.a,{kind:"link",onClick:this.onCommunityInviteClick},e)});t=o.a.createElement(o.a.Fragment,null,t," ",s)}n=Object(l.a)("Go"),i=this.startDm,r=o.a.createElement("div",{className:"mx_InviteDialog_section_hidden_suggestions_disclaimer"},o.a.createElement("span",null,Object(l.a)("Some suggestions may be hidden for privacy.")),o.a.createElement("p",null,Object(l.a)("If you can't see who you're looking for, send them your invite link below.")));const s=Object(h.h)(d.a.get().getUserId());u=o.a.createElement("div",{className:"mx_InviteDialog_footer"},o.a.createElement("h3",null,Object(l.a)("Or send invite link")),o.a.createElement("div",{className:"mx_InviteDialog_footer_link"},o.a.createElement("a",{href:s,onClick:this.onLinkClick},s),o.a.createElement(F.a,{title:Object(l.a)("Copy"),onClick:this.onCopyClick,className:"mx_InviteDialog_footer_link_copy"},o.a.createElement("div",null))))}else if(this.props.kind===ee){var y;const a=null===(y=d.a.get())||void 0===y?void 0:y.getRoom(this.props.roomId),r=J.a.spacesEnabled&&(null==a?void 0:a.isSpaceRoom());let c;if(e=r?Object(l.a)("Invite to %(spaceName)s",{spaceName:a.name||Object(l.a)("Unnamed Space")}):Object(l.a)("Invite to %(roomName)s",{roomName:a.name||Object(l.a)("Unnamed Room")}),c=r?g?Object(l.b)("Invite someone using their name, email address, username (like <userId/>) or <a>share this space</a>."):Object(l.b)("Invite someone using their name, username (like <userId/>) or <a>share this space</a>."):g?Object(l.b)("Invite someone using their name, email address, username (like <userId/>) or <a>share this room</a>."):Object(l.b)("Invite someone using their name, username (like <userId/>) or <a>share this room</a>."),t=Object(l.a)(c,{},{userId:()=>o.a.createElement("a",{href:Object(h.h)(b),rel:"noreferrer noopener",target:"_blank"},b),a:e=>o.a.createElement("a",{href:Object(h.g)(this.props.roomId),rel:"noreferrer noopener",target:"_blank"},e)}),n=Object(l.a)("Invite"),i=this.inviteUsers,f.isRoomEncrypted(this.props.roomId)){const e=f.getRoom(this.props.roomId).currentState.getStateEvents("m.room.history_visibility",""),t=e&&e.getContent()&&e.getContent().history_visibility;"world_readable"!==t&&"shared"!==t||(p=o.a.createElement("p",{className:"mx_InviteDialog_helpText"},o.a.createElement("img",{src:s(1562),width:14,height:14})," "+Object(l.a)("Invited people will be able to read old messages.")))}}else this.props.kind===te?(e=Object(l.a)("Transfer"),a=o.a.createElement("div",{className:"mx_InviteDialog_transferConsultConnect"},o.a.createElement("label",null,o.a.createElement("input",{type:"checkbox",checked:this.state.consultFirst,onChange:this.onConsultFirstChange}),Object(l.a)("Consult first")),o.a.createElement(U.a,{kind:"secondary",onClick:this.onCancel,className:"mx_InviteDialog_transferConsultConnect_pushRight"},Object(l.a)("Cancel")),o.a.createElement(U.a,{kind:"primary",onClick:this.transferCall,className:"mx_InviteDialog_transferButton",disabled:!v&&""===this.state.dialPadValue},Object(l.a)("Transfer")))):Y.a.error("Unknown kind of InviteDialog: "+this.props.kind);const E=this.props.kind==te?null:o.a.createElement(U.a,{kind:"primary",onClick:i,className:"mx_InviteDialog_goButton",disabled:this.state.busy||!v},n),S=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",{className:"mx_InviteDialog_helpText"},t),o.a.createElement("div",{className:"mx_InviteDialog_addressBar"},this.renderEditor(),o.a.createElement("div",{className:"mx_InviteDialog_buttonAndSpinner"},E,m)),p,this.renderIdentityServerWarning(),o.a.createElement("div",{className:"error"},this.state.errorText),o.a.createElement("div",{className:"mx_InviteDialog_userSections"},this.renderSection("recents"),this.renderSection("suggestions"),r),u);let _;if(this.props.kind===te){const e=[];e.push(new W.a(se.UserDirectory,Object(l.b)("User Directory"),"mx_InviteDialog_userDirectoryIcon",S));const t=o.a.createElement(z.a,{onBackspacePress:this.onDeletePress});let s;s=0!==this.state.dialPadValue.length?o.a.createElement(K.a,{ref:this.numberEntryFieldRef,className:"mx_InviteDialog_dialPadField",id:"dialpad_number",value:this.state.dialPadValue,autoFocus:!0,onChange:this.onDialChange,postfixComponent:t}):o.a.createElement(K.a,{ref:this.numberEntryFieldRef,className:"mx_InviteDialog_dialPadField",id:"dialpad_number",value:this.state.dialPadValue,autoFocus:!0,onChange:this.onDialChange});const n=o.a.createElement("div",{className:"mx_InviteDialog_dialPad"},o.a.createElement("form",{onSubmit:this.onDialFormSubmit},s),o.a.createElement(G.a,{hasDial:!1,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress}));e.push(new W.a(se.DialPad,Object(l.b)("Dial pad"),"mx_InviteDialog_dialPadIcon",n)),_=o.a.createElement(o.a.Fragment,null,o.a.createElement(W.c,{tabs:e,initialTabId:this.state.currentTabId,tabLocation:W.b.TOP,onChange:this.onTabChange}),a)}else _=o.a.createElement(o.a.Fragment,null,S,a);return o.a.createElement($.a,{className:c()({mx_InviteDialog_transfer:this.props.kind===te,mx_InviteDialog_other:this.props.kind!==te,mx_InviteDialog_hasFooter:!!u}),hasCancel:!0,onFinished:this.props.onFinished,title:e},o.a.createElement("div",{className:"mx_InviteDialog_content"},_))}},i()(S,"defaultProps",{kind:Z,initialText:""}),E=_))||E},function(e,t,s){"use strict";s.d(t,"c",(function(){return v})),s.d(t,"a",(function(){return f})),s.d(t,"d",(function(){return b}));var n=s(82),i=s.n(n),a=s(117),o=s(94),r=s(84),c=s(182),l=s(96),d=s(98),h=s(135);var u=s(259),m=s(717),p=s(482),g=s(1);const v=e=>{const[t,s]=Object(n.useState)([]),i=Object(n.useCallback)(t=>{var n,i;e&&(t&&t.getType()!==o.a.RoomPinnedEvents||s((null===(n=e.currentState.getStateEvents(o.a.RoomPinnedEvents,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.pinned)||[]))},[e]);return Object(h.a)(null==e?void 0:e.currentState,"RoomState.events",i),Object(n.useEffect)(()=>(i(),()=>{s([])}),[i]),t},f="im.vector.room.read_pins",b=e=>{const[t,s]=Object(n.useState)(new Set),i=Object(n.useCallback)(t=>{var n,i;if(!e)return;if(t&&t.getType()!==f)return;const a=null===(n=e.getAccountData(f))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.event_ids;s(new Set(a||[]))},[e]);return Object(h.a)(e,"Room.accountData",i),Object(n.useEffect)(()=>(i(),()=>{s(new Set)}),[i]),t};t.b=({room:e,onClose:t,userNameColorMode:s})=>{const h=Object(n.useContext)(d.a),y=Object(p.a)(e,e=>e.mayClientSendStateEvent(o.a.RoomPinnedEvents,h)),E=v(e),S=b(e);Object(n.useEffect)(()=>{E.filter(e=>!S.has(e)).length>0&&h.setRoomAccountData(e.roomId,f,{event_ids:E})},[h,e.roomId,E,S]);const _=Object(u.a)(()=>{const t=E.map(async t=>{var s;const n=e.getUnfilteredTimelineSet(),i=null==n||null===(s=n.getTimelineForEvent(t))||void 0===s?void 0:s.getEvents().find(e=>e.getId()===t);if(i)return i;try{const s=await h.fetchRoomEvent(e.roomId,t),n=new a.b(s);if(n.isEncrypted()&&await h.decryptEventIfNeeded(n),n&&class{static isPinnable(e){return!!e&&("m.room.message"===e.getType()&&!e.isRedacted())}}.isPinnable(n))return n}catch(s){g.a.error("Error looking up pinned event "+t+" in room "+e.roomId),g.a.error(s)}return null});return Promise.all(t)},[h,e,E],null);let w;if(_)if(_.length>0){const t=async t=>{var s;const n=e.currentState.getStateEvents(o.a.RoomPinnedEvents,"");if(null!=n&&null!==(s=n.getContent())&&void 0!==s&&s.pinned){const s=n.getContent().pinned,i=s.indexOf(t.getId());-1!==i&&(s.splice(i,1),await h.sendStateEvent(e.roomId,o.a.RoomPinnedEvents,{pinned:s},""))}};w=_.filter(Boolean).reverse().map(n=>i.a.createElement(m.a,{key:n.getId(),room:e,event:n,onUnpinClicked:y?()=>t(n):void 0,userNameColorMode:s}))}else w=i.a.createElement("div",{className:"mx_PinnedMessagesCard_empty"},i.a.createElement("div",null,i.a.createElement("div",{className:"mx_PinnedMessagesCard_MessageActionBar"},i.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton"}),i.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton"}),i.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton"})),i.a.createElement("h2",null,Object(r.a)("Nothing pinned, yet")),Object(r.a)("If you have permissions, open the menu on any message and select <b>Pin</b> to stick them here.",{},{b:e=>i.a.createElement("b",null,e)})));else w=i.a.createElement(l.a,null);return i.a.createElement(c.b,{header:i.a.createElement("h2",null,Object(r.a)("Pinned messages")),className:"mx_PinnedMessagesCard",onClose:t},w)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return C})),s.d(t,"c",(function(){return O})),s.d(t,"b",(function(){return k}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(89),l=s(112),d=s(100);function h(){return c.b.getValue("recent_emoji")||[]}function u(e=24){let t=h();t.length<1&&(!function(){const e=JSON.parse(window.localStorage.mx_reaction_count||"{}"),t=Object.entries(e).sort(([,[e,t]],[,[s,n]])=>n-t).map(([e,[t,s]])=>[e,t]);c.b.setValue("recent_emoji",null,d.a.ACCOUNT,t.slice(0,100))}(),t=h());return Object(l.orderBy)(t,"1","desc").slice(0,e).map(([e])=>e)}var m,p=s(305),g=s(128),v=s(757),f=s(758),b=s(759),y=s(760),E=s(761),S=s(85),_=s(88);function w(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const C=20,O=35,k=8;let R=Object(S.a)("views.emojipicker.EmojiPicker")(m=class e extends o.a.Component{constructor(e){super(e),i()(this,"recentlyUsed",void 0),i()(this,"memoizedDataByCategory",void 0),i()(this,"categories",void 0),i()(this,"bodyRef",o.a.createRef()),i()(this,"onScroll",()=>{const e=this.bodyRef.current;this.setState({scrollTop:e.scrollTop,viewportHeight:e.clientHeight}),this.updateVisibility()}),i()(this,"updateVisibility",()=>{const e=this.bodyRef.current,t=e.getBoundingClientRect();for(const s of this.categories){const n=e.querySelector(`[data-category-id="${s.id}"]`);if(!n){s.visible=!1,s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible");continue}const i=n.getBoundingClientRect(),a=i.y-t.y,o=i.y+i.height-t.y;s.visible=a<t.height&&o>0,s.visible?(s.ref.current.classList.add("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected","true"),s.ref.current.setAttribute("tabindex","0")):(s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected","false"),s.ref.current.setAttribute("tabindex","-1"))}}),i()(this,"scrollToCategory",e=>{this.bodyRef.current.querySelector(`[data-category-id="${e}"]`).scrollIntoView()}),i()(this,"onChangeFilter",e=>{const t=e.toLowerCase().trim();for(const e of this.categories){let s;s=t.includes(this.state.filter)?this.memoizedDataByCategory[e.id]:"recent"===e.id?this.recentlyUsed:p.a[e.id],s=s.filter(e=>this.emojiMatchesFilter(e,t)),this.memoizedDataByCategory[e.id]=s,e.enabled=s.length>0,e.ref.current.disabled=!e.enabled}this.setState({filter:e}),setTimeout(this.updateVisibility,0)}),i()(this,"emojiMatchesFilter",(e,t)=>{var s;return e.annotation.toLowerCase().includes(t)||(null===(s=e.emoticon)||void 0===s?void 0:s.toLowerCase().includes(t))||e.shortcodes.some(e=>e.toLowerCase().includes(t))||e.unicode.split("‍").includes(t)}),i()(this,"onEnterFilter",()=>{const e=this.bodyRef.current.querySelector(".mx_EmojiPicker_item");e&&e.click()}),i()(this,"onHoverEmoji",e=>{this.setState({previewEmoji:e})}),i()(this,"onHoverEmojiEnd",e=>{this.setState({previewEmoji:null})}),i()(this,"onClickEmoji",e=>{!1!==this.props.onChoose(e.unicode)&&function(e){const t=h(),s=t.findIndex(([t])=>t===e);let n;s>=0?([n]=t.splice(s,1),n[1]++):n=[e,1],c.b.setValue("recent_emoji",null,d.a.ACCOUNT,[n,...t].slice(0,100))}(e.unicode)}),i()(this,"reactWith",e=>{this.props.onChoose(e)}),this.state={filter:"",previewEmoji:null,scrollTop:0,viewportHeight:280},this.recentlyUsed=Array.from(new Set(u().map(p.d).filter(Boolean))),this.memoizedDataByCategory=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?w(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({recent:this.recentlyUsed},p.a),this.categories=[{id:"recent",name:Object(r.a)("Frequently Used"),enabled:this.recentlyUsed.length>0,visible:this.recentlyUsed.length>0,ref:o.a.createRef()},{id:"people",name:Object(r.a)("Smileys & People"),enabled:!0,visible:!0,ref:o.a.createRef()},{id:"nature",name:Object(r.a)("Animals & Nature"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"foods",name:Object(r.a)("Food & Drink"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"activity",name:Object(r.a)("Activities"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"places",name:Object(r.a)("Travel & Places"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"objects",name:Object(r.a)("Objects"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"symbols",name:Object(r.a)("Symbols"),enabled:!0,visible:!1,ref:o.a.createRef()},{id:"flags",name:Object(r.a)("Flags"),enabled:!0,visible:!1,ref:o.a.createRef()}]}static categoryHeightForEmojiCount(e){return 0===e?0:C+Math.ceil(e/k)*O}render(){let t=0;return o.a.createElement("div",{className:"mx_EmojiPicker"},o.a.createElement(v.a,{categories:this.categories,onAnchorClick:this.scrollToCategory}),o.a.createElement(f.a,{query:this.state.filter,onChange:this.onChangeFilter,onEnter:this.onEnterFilter}),o.a.createElement(g.a,{className:"mx_EmojiPicker_body",wrappedRef:e=>{this.bodyRef.current=e},onScroll:this.onScroll},this.categories.map(s=>{const n=this.memoizedDataByCategory[s.id],i=o.a.createElement(E.a,{key:s.id,id:s.id,name:s.name,heightBefore:t,viewportHeight:this.state.viewportHeight,scrollTop:this.state.scrollTop,emojis:n,onClick:this.onClickEmoji,onMouseEnter:this.onHoverEmoji,onMouseLeave:this.onHoverEmojiEnd,selectedEmojis:this.props.selectedEmojis}),a=e.categoryHeightForEmojiCount(n.length);return t+=a,i})),this.props.allowUnlisted&&this.state.filter&&o.a.createElement(_.a,{kind:"link",onClick:()=>this.reactWith(this.state.filter)},Object(r.a)('React with "%(reaction)s"',{reaction:this.state.filter})),this.state.previewEmoji||!this.props.showQuickReactions?o.a.createElement(b.a,{emoji:this.state.previewEmoji}):o.a.createElement(y.a,{onClick:this.onClickEmoji,selectedEmojis:this.props.selectedEmojis}))}})||m;t.d=R},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(153),d=s(168),h=s(105),u=s(84),m=s(152),p=s(267),g=s(118),v=s(87),f=s(89),b=s(90),y=s(113),E=s(104),S=s(178),_=s(98),w=s(154),C=s(86),O=s(93),k=s(3);function R(){return O.a.get().audioStreamUrl}async function I(e,t){const s=await async function(e){const t=await C.a.get().getOpenIdToken(),s=R()+"/createStream",n=await window.fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:e,openid_token:t})});return(await n.json()).stream_id}(t);await e.transport.send(k.a.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+s})}var x=s(1);const T=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"];t.a=e=>{let{onFinished:t,app:s,userWidget:n,onDeleteClick:a,onEditClick:C,showUnpin:O}=e,k=o()(e,T);const j=Object(r.useContext)(_.a),{room:N,roomId:P}=Object(r.useContext)(g.b),D=p.a.instance.getMessagingForId(s.id),M=n||m.a.canUserModifyWidgets(P);let A,U,L,F,B;if(R()&&S.a.JITSI.matches(s.type)){const e=async()=>{try{await I(D,P)}catch(e){x.a.error("Failed to start livestream",e);const t=e.message||Object(u.a)("Unable to start audio streaming.");b.a.createTrackedDialog("WidgetContext Menu","Livestream failed",E.a,{title:Object(u.a)("Failed to start livestream"),description:t})}t()};A=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Start audio stream")})}if(O){const e=()=>{w.d.instance.moveToContainer(N,s,w.a.Right),t()};U=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Unpin")})}if(M&&m.a.isManagedByManager(s)){const e=()=>{C?C():m.a.editWidget(N,s),t()};L=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Edit")})}if(null!=D&&D.hasCapability(l.MatrixCapabilities.Screenshots)){const e=()=>{null==D||D.takeScreenshot().then(e=>{v.a.dispatch({action:"picture_snapshot",file:e.screenshot})}).catch(e=>{x.a.error("Failed to take screenshot: ",e)}),t()};F=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Take a picture")})}if(a||M){const e=()=>{a?a():b.a.createTrackedDialog("Delete Widget","",y.a,{title:Object(u.a)("Delete Widget"),description:Object(u.a)("Deleting a widget removes it for all users in this room. Are you sure you want to delete this widget?"),button:Object(u.a)("Delete widget"),onFinished:e=>{e&&m.a.setRoomWidget(P,s.id)}}),t()};B=c.a.createElement(d.b,{onClick:e,label:n?Object(u.a)("Remove"):Object(u.a)("Remove for everyone")})}let V=f.b.getValue("allowedWidgets",P)[s.eventId];void 0===V&&(V=s.creatorUserId===j.getUserId());const K=S.a.JITSI.matches(s.type);let W;if(!n&&!K&&V){const e=()=>{x.a.info("Revoking permission for widget to load: "+s.eventId);const e=f.b.getValue("allowedWidgets",P);e[s.eventId]=!1;const n=f.b.firstSupportedLevel("allowedWidgets");f.b.setValue("allowedWidgets",P,n,e).catch(e=>{x.a.error(e)}),t()};W=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Revoke permissions")})}const G=w.d.instance.getContainerWidgets(N,w.a.Top),H=G.findIndex(e=>e.id===s.id);let q,$;if(O&&H>0){const e=()=>{w.d.instance.moveWithinContainer(N,w.a.Top,s,-1),t()};q=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Move left")})}if(O&&H<G.length-1){const e=()=>{w.d.instance.moveWithinContainer(N,w.a.Top,s,1),t()};$=c.a.createElement(d.b,{onClick:e,label:Object(u.a)("Move right")})}return c.a.createElement(d.e,i()({},k,{chevronFace:h.a.None,onFinished:t}),c.a.createElement(d.c,null,A,L,W,B,F,q,$,U))}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(99),i=s.n(n),a=s(4),o=(s(1),s(94));class r{static RETRY_BACKOFF_RATELIMIT(e,t,s){if(400===s.httpStatus||403===s.httpStatus||401===s.httpStatus)return-1;if("rejected"===s.cors)return-1;if("M_TOO_LARGE"===s.name)return-1;if("M_LIMIT_EXCEEDED"===s.name){const e=s.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return e.getType()===o.a.RoomMessage||e.hasAssocation()?"message":null}constructor(e=r.RETRY_BACKOFF_RATELIMIT,t=r.QUEUE_MESSAGES){this.retryAlgorithm=e,this.queueAlgorithm=t,i()(this,"queues",{}),i()(this,"activeQueues",[]),i()(this,"procFn",null),i()(this,"processQueue",e=>{const t=this.peekNextEvent(e);if(!t){const t=this.activeQueues.indexOf(e);return t>=0&&this.activeQueues.splice(t,1),void c("Stopping queue '%s' as it is now empty",e)}c("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then(()=>this.procFn(t.event)).then(s=>{this.removeNextEvent(e),c("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(s),this.processQueue(e)},s=>{t.attempts+=1;const n=this.retryAlgorithm(t.event,t.attempts,s);c("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,s,t.event.getId(),n),-1===n?(c("Queue '%s' giving up on event %s",e,t.event.getId()),this.removeNextEvent(e),t.defer.reject(s),this.processQueue(e)):setTimeout(this.processQueue,n,e)})})}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let s=!1;return a.F(this.queues[t],t=>{if(t.event.getId()===e.getId())return s=!0,!0}),s}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const s=a.l();return this.queues[t].push({event:e,defer:s,attempts:0}),c("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),s.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),c("Spinning up queue: '%s'",e),this.processQueue(e)})}peekNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t[0]:null}removeNextEvent(e){const t=this.queues[e];return Array.isArray(t)?t.shift():null}}function c(...e){0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(99),a=s.n(i),o=s(5),r=s(181),c=s(1),l=s(4),d=s(94),h=s(127);!function(e){e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished"}(n||(n={}));class u extends o.EventEmitter{constructor(e,t={status:n.NotStarted}){super(),this.roomId=e,this.oobMemberFlags=t,a()(this,"sentinels",{}),a()(this,"displayNameToUserIds",{}),a()(this,"userIdsToDisplayNames",{}),a()(this,"tokenToInvite",{}),a()(this,"joinedMemberCount",null),a()(this,"summaryJoinedMemberCount",null),a()(this,"invitedMemberCount",null),a()(this,"summaryInvitedMemberCount",null),a()(this,"modified",void 0),a()(this,"members",{}),a()(this,"events",new Map),a()(this,"paginationToken",null),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new r.a(this.roomId,e);const s=this.members[e];s&&t.setMembershipEvent(s.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const s=this.events.get(e).get(t);return s||null}clone(){const e=new u(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=n.NotStarted,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==n.Finished&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){e.getMember(t.userId).markOutOfBand()}}),e}setUnknownStateEvents(e){const t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)}setStateEvents(e){this.updateModifiedTime(),e.forEach(e=>{if(e.getRoomId()!==this.roomId)return;if(!e.isState())return;const t=this.getStateEventMatching(e);this.setStateEvent(e),e.getType()===d.a.RoomMember&&(this.updateDisplayNameCache(e.getStateKey(),e.getContent().displayname),this.updateThirdPartyTokenCache(e)),this.emit("RoomState.events",e,this,t)}),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===d.a.RoomMember){const t=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const s=this.getOrCreateMember(t,e);s.setMembershipEvent(e,this),this.updateMember(s),this.emit("RoomState.members",e,this,s)}else if(e.getType()===d.a.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach(t=>{const s=t.getLastModifiedTime();t.setPowerLevelEvent(e),s!==t.getLastModifiedTime()&&this.emit("RoomState.members",e,this,t)}),this.sentinels={}}})}getOrCreateMember(e,t){let s=this.members[e];return s||(s=new r.a(this.roomId,e),this.members[e]=s,this.emit("RoomState.newMember",t,this,s)),s}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}getStateEventMatching(e){return this.events.has(e.getType())?this.events.get(e.getType()).get(e.getStateKey()):null}updateMember(e){const t=this.getStateEvents(d.a.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===n.NotStarted}markOutOfBandMembersStarted(){this.oobMemberFlags.status===n.NotStarted&&(this.oobMemberFlags.status=n.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===n.InProgress&&(this.oobMemberFlags.status=n.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),c.a.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=n.NotStarted}setOutOfBandMembers(e){c.a.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===n.InProgress&&(c.a.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=n.Finished,e.forEach(e=>this.setOutOfBandMember(e)))}setOutOfBandMember(e){if(e.getType()!==d.a.RoomMember)return;const t=e.getStateKey(),s=this.getMember(t);if(s&&!s.isOutOfBand())return;const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit("RoomState.members",e,this,n)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){return this.displayNameToUserIds[l.G(e)]||[]}maySendRedactionForEvent(e,t){const s=this.getMember(t);if(!s||"leave"===s.membership)return!1;if(e.status||e.isRedacted())return!1;const n=this.maySendEvent(d.a.RoomRedaction,t);return e.getSender()===t?n:this.hasSufficientPowerLevelFor("redact",s.powerLevel)}hasSufficientPowerLevelFor(e,t){const s=this.getStateEvents(d.a.RoomPowerLevels,"");let n={};s&&(n=s.getContent());let i=50;return l.w(n[e])&&(i=n[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(d.a.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,s){const n=this.getStateEvents(d.a.RoomPowerLevels,"");let i,a={},o=0,r=0,c=0;if(n){i=n.getContent(),a=i.events||{},o=Number.isSafeInteger(i.state_default)?i.state_default:50;const e=i.users&&i.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(i.users_default)&&(c=i.users_default),Number.isSafeInteger(i.events_default)&&(r=i.events_default)}let l=s?o:r;return Number.isSafeInteger(a[e])&&(l=a[e]),c>=l}mayTriggerNotifOfType(e,t){const s=this.getMember(t);if(!s)return!1;const n=this.getStateEvents(d.a.RoomPowerLevels,"");let i=50;return n&&n.getContent()&&n.getContent().notifications&&l.w(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),s.powerLevel>=i}getJoinRule(){var e;const t=this.getStateEvents(d.a.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||h.c.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(d.a.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||h.b.Shared}getGuestAccess(){var e;const t=this.getStateEvents(d.a.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||h.a.Forbidden}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;this.getStateEvents(d.a.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const s=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],s){const t=l.G(s),n=this.displayNameToUserIds[t];if(n){const s=n.filter(t=>t!==e);this.displayNameToUserIds[t]=s}}this.userIdsToDisplayNames[e]=t;const n=t&&l.G(t);n&&(this.displayNameToUserIds[n]||(this.displayNameToUserIds[n]=[]),this.displayNameToUserIds[n].push(e))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}));const n="org.matrix.msc3077.sdp_stream_metadata";let i;!function(e){e.Usermedia="m.usermedia",e.Screenshare="m.screenshare"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var n=s(99),i=s.n(n),a=s(5),o=s.n(a);let r;!function(e){e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.VolumeChanged="volume_changed",e.Speaking="speaking"}(r||(r={}));class c extends o.a{constructor(e){super(),i()(this,"stream",void 0),i()(this,"userId",void 0),i()(this,"purpose",void 0),i()(this,"speakingVolumeSamples",void 0),i()(this,"client",void 0),i()(this,"roomId",void 0),i()(this,"audioMuted",void 0),i()(this,"videoMuted",void 0),i()(this,"measuringVolumeActivity",!1),i()(this,"audioContext",void 0),i()(this,"analyser",void 0),i()(this,"frequencyBinCount",void 0),i()(this,"speakingThreshold",-60),i()(this,"speaking",!1),i()(this,"volumeLooperTimeout",void 0),i()(this,"onAddTrack",()=>{this.emit(r.NewStream,this.stream)}),i()(this,"volumeLooper",()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(let t=0;t<this.frequencyBinCount.length;t++)this.frequencyBinCount[t]>e&&(e=this.frequencyBinCount[t]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(r.VolumeChanged,e);let t=!1;for(let e=0;e<this.speakingVolumeSamples.length;e++){if(this.speakingVolumeSamples[e]>this.speakingThreshold){t=!0;break}}this.speaking!==t&&(this.speaking=t,this.emit(r.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)}),this.client=e.client,this.roomId=e.roomId,this.userId=e.userId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.updateStream(null,e.stream),this.hasAudioTrack&&this.initVolumeMeasuring()}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){t!==e&&(e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),t&&(this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1)),this.emit(r.NewStream,this.stream))}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!this.hasAudioTrack||!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){return this.client.getRoom(this.roomId).getMember(this.userId)}isLocal(){return this.userId===this.client.getUserId()}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioMuted(e){this.audioMuted=e,this.speakingVolumeSamples.fill(-1/0),this.emit(r.MuteStateChanged,this.audioMuted,this.videoMuted)}setVideoMuted(e){this.videoMuted=e,this.emit(r.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!(this.audioContext&&this.analyser&&this.frequencyBinCount&&this.hasAudioTrack))return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(r.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}dispose(){clearTimeout(this.volumeLooperTimeout)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return m}));var n=s(99),i=s.n(n),a=s(117),o=s(5),r=s(1),c=s(348),l=s(289),d=s(350);const h=new Error("Verification timed out");class u extends Error{constructor(e){super(),this.startEvent=e}}class m extends o.EventEmitter{constructor(e,t,s,n,a,o){super(),this.channel=e,this.baseApis=t,this.userId=s,this.deviceId=n,this.startEvent=a,this.request=o,i()(this,"cancelled",!1),i()(this,"_done",!1),i()(this,"promise",null),i()(this,"transactionTimeoutTimer",null),i()(this,"expectedEvent",void 0),i()(this,"resolve",void 0),i()(this,"reject",void 0),i()(this,"resolveEvent",void 0),i()(this,"rejectEvent",void 0),i()(this,"started",void 0),i()(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){r.a.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(r.a.info("Triggering verification timeout"),this.cancel(h))},6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise((e,t)=>{this.resolveEvent=e,this.rejectEvent=t}))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(r.a.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new u(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this.expectedEvent)"m.key.verification.done"!==this.expectedEvent&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),this.resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this.reject;if(this.reject=void 0,t){const s=e.getContent(),{reason:n,code:i}=s;t(new Error(`Other side cancelled verification because ${n} (${i})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),this.resolve(),Object(d.e)(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===h){const e=Object(l.e)();this.send(e.getType(),e.getContent())}else if(e instanceof a.b){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send("m.key.verification.cancel",t)):this.send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit("cancel",e)}}verify(){return this.promise||(this.promise=new Promise((e,t)=>{this.resolve=(...t)=>{this._done=!0,this.endTimer(),e(...t)},this.reject=e=>{this._done=!0,this.endTimer(),t(e)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),Promise.resolve(this.doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,s){const n=[];for(const[i,a]of Object.entries(t)){const t=i.split(":",2)[1],o=this.baseApis.getStoredDevice(e,t);if(o)s(i,o,a),n.push(t);else{const o=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);o&&o.getId()===t?(s(i,c.a.fromStorage({keys:{[i]:t}},t),a),n.push(t)):r.a.warn(`verification: Could not find device ${t} to verify`)}}if(!n.length)throw new Error("No devices could be verified");r.a.info("Verification completed! Marking devices verified: ",n);for(const t of n)await this.baseApis.setDeviceVerified(e,t)}get events(){}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var n=s(99),i=s.n(n),a=s(157);s(1);const o=function(){};class r{constructor(e,t,s={}){this.client=e,this.timelineSet=t,i()(this,"windowLimit",void 0),i()(this,"start",null),i()(this,"end",null),i()(this,"eventCount",0),this.windowLimit=s.windowLimit||1e3}load(e,t=20){const s=s=>{let n;const i=s.getEvents();if(e){for(let t=0;t<i.length;t++)if(i[t].getId()==e){n=t;break}if(void 0===n)throw new Error("getEventTimeline result didn't include requested event")}else n=i.length;const a=Math.min(i.length,n+Math.ceil(t/2)),o=Math.max(0,a-t);this.start=new c(s,o-s.getBaseIndex()),this.end=new c(s,a-s.getBaseIndex()),this.eventCount=a-o};if(e){const t=this.timelineSet.getTimelineForEvent(e);if(t)return s(t),Promise.resolve(t);return this.client.getEventTimeline(this.timelineSet,e).then(s)}return s(this.timelineSet.getLiveTimeline()),Promise.resolve()}getTimelineIndex(e){if(e==a.b.BACKWARDS)return this.start;if(e==a.b.FORWARDS)return this.end;throw new Error("Invalid direction '"+e+"'")}extend(e,t){const s=this.getTimelineIndex(e);if(!s)return o("TimelineWindow: no timeline yet"),!1;const n=e==a.b.BACKWARDS?s.retreat(t):s.advance(t);if(n){this.eventCount+=n,o("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");const t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=a.b.BACKWARDS),!0}return!1}canPaginate(e){const t=this.getTimelineIndex(e);if(!t)return o("TimelineWindow: no timeline yet"),!1;if(e==a.b.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))}paginate(e,t,s=!0,n=5){const i=this.getTimelineIndex(e);if(!i)return o("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!s||0===n)return Promise.resolve(!1);if(!i.timeline.getPaginationToken(e))return o("TimelineWindow: no token"),Promise.resolve(!1);o("TimelineWindow: starting request");const r=this.client.paginateEventTimeline(i.timeline,{backwards:e==a.b.BACKWARDS,limit:t}).finally((function(){i.pendingPaginate=null})).then(s=>(o("TimelineWindow: request completed with result "+s),!!s&&this.paginate(e,t,!0,n-1)));return i.pendingPaginate=r,r}unpaginate(e,t){const s=t?this.start:this.end;if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this.eventCount+" in the timeline");for(;e>0;){const n=t?s.advance(e):s.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,o("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];const e=[];let t=this.start.timeline;for(;;){const s=t.getEvents();let n=0,i=s.length;t===this.start.timeline&&(n=this.start.index+t.getBaseIndex()),t===this.end.timeline&&(i=this.end.index+t.getBaseIndex());for(let t=n;t<i;t++)e.push(s[t]);if(t===this.end.timeline)break;t=t.getNeighbouringTimeline(a.b.FORWARDS)}return e}}class c{constructor(e,t){this.timeline=e,this.index=t,i()(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const s=this.timeline.getNeighbouringTimeline(e<0?a.b.BACKWARDS:a.b.FORWARDS);return s?(this.timeline=s,this.index=e<0?this.maxIndex():this.minIndex(),o("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(4);s(1);const i="session.e2e.";function a(e){if(this.store=e,!(n.u(e.getItem)&&n.u(e.setItem)&&n.u(e.removeItem)&&n.u(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}a.prototype={removeEndToEndAccount:function(){this.store.removeItem(o)},getEndToEndAccount:function(){return this.store.getItem(o)},getAllEndToEndDevices:function(){const e=d(""),t={};for(let s=0;s<this.store.length;++s){const n=this.store.key(s),i=n.substr(e.length);n.startsWith(e)&&(t[i]=m(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return m(this.store,c)},getEndToEndDeviceSyncToken:function(){return m(this.store,r)},removeEndToEndDeviceData:function(){g(this.store,d("")),g(this.store,c),g(this.store,r)},getEndToEndSessions:function(e){return m(this.store,h(e))},getAllEndToEndSessions:function(){const e=p(this.store,h("")),t={};for(const s of e){t[s.substr(h("").length)]=m(this.store,s)}return t},removeAllEndToEndSessions:function(){g(this.store,h(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=i+"inboundgroupsessions/",t=[];for(let s=0;s<this.store.length;s++){const n=this.store.key(s);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const s=function(e,t){return i+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(s)},removeAllEndToEndInboundGroupSessions:function(){g(this.store,i+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=p(this.store,u("")),t={};for(const s of e){t[s.substr(u("").length)]=m(this.store,s)}return t},removeAllEndToEndRooms:function(){g(this.store,u(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(l,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(l)}};const o=i+"account",r=i+"device_sync_token",c=i+"device_tracking",l=i+"trusted_backup_pubkey";function d(e){return i+"devices/"+e}function h(e){return i+"sessions/"+e}function u(e){return i+"rooms/"+e}function m(e,t){try{return JSON.parse(e.getItem(t))}catch(e){v("Failed to get key %s: %s",t,e),v(e.stack)}return null}function p(e,t){const s=[];for(let n=0;n<e.length;++n){const i=e.key(n);i.startsWith(t)&&s.push(i)}return s}function g(e,t){const s=[];for(let n=0;n<e.length;++n){const i=e.key(n);i.startsWith(t)&&s.push(i)}for(const t of s)e.removeItem(t)}function v(){0}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(88);const d=["label","isExpanded","children","onClick","onContextMenu"],h=e=>{let{label:t,isExpanded:s,children:n,onClick:a,onContextMenu:r}=e,h=o()(e,d);return c.a.createElement(l.a,i()({},h,{onClick:a,onContextMenu:r||a,title:t,"aria-label":t,"aria-haspopup":!0,"aria-expanded":s}),n)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(83),i=s.n(n);class a{get action(){return"NOT_USED"}constructor(e){i()(this,"fn",void 0),this.fn=e}}},,,,,,function(e,t){},function(e,t){},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return m}));var n=s(82),i=s.n(n),a=s(247),o=s(84),r=s(93),c=s(87),l=s(92),d=s(158),h=s(1);let u;function m({isRoomEncrypted:e,kind:t}){if(!e)return null;if(a.a.get())return null;if(a.a.error)return i.a.createElement(i.a.Fragment,null,Object(o.a)("Message search initialisation failed, check <a>your settings</a> for more information",{},{a:e=>i.a.createElement("a",{onClick:e=>{e.preventDefault(),c.a.dispatch({action:l.a.ViewUserSettings,initialTabId:d.a.Security})}},e)}));const{desktopBuilds:s,brand:n}=r.a.get();let m=null,p=null;if(s.available)switch(p=i.a.createElement("img",{src:s.logo}),t){case u.Files:m=Object(o.a)("Use the <a>Desktop app</a> to see all encrypted files",{},{a:e=>i.a.createElement("a",{href:s.url,target:"_blank",rel:"noreferrer noopener"},e)});break;case u.Search:m=Object(o.a)("Use the <a>Desktop app</a> to search encrypted messages",{},{a:e=>i.a.createElement("a",{href:s.url,target:"_blank",rel:"noreferrer noopener"},e)})}else switch(t){case u.Files:m=Object(o.a)("This version of %(brand)s does not support viewing some encrypted files",{brand:n});break;case u.Search:m=Object(o.a)("This version of %(brand)s does not support searching encrypted messages",{brand:n})}return m?i.a.createElement("div",{className:"mx_DesktopBuildsNotice"},p,i.a.createElement("span",null,m)):(h.a.warn("Unknown desktop builds warning kind: ",t),null)}!function(e){e[e.Files=0]="Files",e[e.Search=1]="Search"}(u||(u={}))},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(88),l=s(91),d=s.n(l);t.a=({avatarUrl:e,avatarAltText:t,avatarName:s,uploadAvatar:n,removeAvatar:l})=>{const[h,u]=Object(a.useState)(!1),m={onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1)};let p,g,v=o.a.createElement(c.a,i()({element:"div",onClick:n,className:"mx_AvatarSetting_avatarPlaceholder"},m));e&&(v=o.a.createElement(c.a,i()({element:"img",src:e,alt:t,"aria-label":t,onClick:n},m))),n&&(p=o.a.createElement(c.a,i()({onClick:n,className:"mx_AvatarSetting_uploadButton"},m))),e&&l&&(g=o.a.createElement(c.a,{onClick:l,kind:"link_sm"},Object(r.a)("Remove")));const f=d()({mx_AvatarSetting_avatar:!0,mx_AvatarSetting_avatar_hovering:h&&n});return o.a.createElement("div",{className:f},v,o.a.createElement("div",{className:"mx_AvatarSetting_hover"},o.a.createElement("div",{className:"mx_AvatarSetting_hoverBg"}),o.a.createElement("span",null,Object(r.a)("Upload"))),p,g)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(89),d=s(85),h=s(96),u=s(229);let m=Object(d.a)("views.elements.LanguageDropdown")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onSearchChange",e=>{this.setState({searchQuery:e})}),this.state={searchQuery:"",langs:null}}componentDidMount(){if(c.c().then(e=>{e.sort((function(e,t){return e.label<t.label?-1:e.label>t.label?1:0})),this.setState({langs:e})}).catch(()=>{this.setState({langs:["en"]})}),!this.props.value){const e=c.g();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return r.a.createElement(h.a,null);let e;e=this.state.searchQuery?this.state.langs.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.langs;const t=e.map(e=>r.a.createElement("div",{key:e.value},e.label));let s=l.b.getValue("language",null,!0),n=null;return s||(s=navigator.language||navigator.userLanguage),n=this.props.value||s,r.a.createElement(u.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:Object(c.a)("Language Dropdown"),disabled:this.props.disabled},t)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(84);class c extends o.a.PureComponent{render(){return o.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",fill:"currentColor",width:this.props.w,height:this.props.h,className:this.props.className,"aria-label":Object(r.a)("Loading...")},o.a.createElement("circle",{transform:"translate(8 0)",cx:"0",cy:"16",r:"0"},o.a.createElement("animate",{attributeName:"r",values:"0; 4; 0; 0",dur:"1.2s",repeatCount:"indefinite",begin:"0",keyTimes:"0;0.2;0.7;1",keySplines:"0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8",calcMode:"spline"})),o.a.createElement("circle",{transform:"translate(16 0)",cx:"0",cy:"16",r:"0"},o.a.createElement("animate",{attributeName:"r",values:"0; 4; 0; 0",dur:"1.2s",repeatCount:"indefinite",begin:"0.3",keyTimes:"0;0.2;0.7;1",keySplines:"0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8",calcMode:"spline"})),o.a.createElement("circle",{transform:"translate(24 0)",cx:"0",cy:"16",r:"0"},o.a.createElement("animate",{attributeName:"r",values:"0; 4; 0; 0",dur:"1.2s",repeatCount:"indefinite",begin:"0.6",keyTimes:"0;0.2;0.7;1",keySplines:"0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8",calcMode:"spline"})))}}i()(c,"defaultProps",{w:32,h:32,className:"mx_Spinner_icon"})},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a}));var n=s(84);function i(e){return{undefined:Object(n.a)("Default"),0:Object(n.a)("Restricted"),[e]:Object(n.a)("Default"),50:Object(n.a)("Moderator"),100:Object(n.a)("Admin")}}function a(e,t){const s=i(t);return s[e]?s[e]:Object(n.a)("Custom (%(level)s)",{level:e})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return c})),s.d(t,"d",(function(){return l}));var n=s(110),i=s.n(n),a=s(84);const o=i.a.shape({userId:i.a.string.isRequired,displayname:i.a.string,avatarUrl:i.a.string}),r=i.a.shape({displayname:i.a.string,name:i.a.string,roomId:i.a.string.isRequired,canonicalAlias:i.a.string,avatarUrl:i.a.string});function c(e){return{userId:e.user_id,displayname:e.displayname,avatarUrl:e.avatar_url,isPrivileged:e.is_privileged}}function l(e){return{displayname:e.name||e.canonical_alias||Object(a.a)("Unnamed Room"),name:e.name,roomId:e.room_id,canonicalAlias:e.canonical_alias,avatarUrl:e.avatar_url,topic:e.topic,numJoinedMembers:e.num_joined_members,worldReadable:e.world_readable,guestCanJoin:e.guest_can_join,isPublic:!1!==e.is_public}}},function(e,t,s){"use strict";var n,i=s(661),a=s(120);function o(e){const t=e.scanner.TOKENS,s=e.parser.TOKENS.Base,n=e.parser.start;if(void 0===t.UNDERSCORE)throw new Error("linkify-matrix requires linkifyjs 2.1.1: this version is too old.");const i=function(e){s.call(this,e),this.type="roomalias",this.isLink=!0};i.prototype=new s;const a=n.jump(t.POUND),o=new e.parser.State,r=new e.parser.State,c=new e.parser.State(i),l=new e.parser.State,d=new e.parser.State(i),h=new e.parser.State,u=new e.parser.State(i),m=[t.DOT,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.UNDERSCORE,t.POUND,t.LOCALHOST];a.on(m,o),o.on(m,o),o.on(t.DOMAIN,o),o.on(t.COLON,r),r.on(t.DOMAIN,c),r.on(t.LOCALHOST,d),r.on(t.TLD,d),c.on(t.DOT,l),l.on(t.DOMAIN,c),l.on(t.TLD,d),d.on(t.DOT,l),d.on(t.COLON,h),h.on(t.NUM,u);const p=function(e){s.call(this,e),this.type="userid",this.isLink=!0};p.prototype=new s;const g=n.jump(t.AT),v=new e.parser.State,f=new e.parser.State,b=new e.parser.State(p),y=new e.parser.State,E=new e.parser.State(p),S=new e.parser.State,_=new e.parser.State(p),w=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];g.on(w,v),v.on(w,v),v.on(t.DOMAIN,v),v.on(t.COLON,f),f.on(t.DOMAIN,b),f.on(t.LOCALHOST,E),f.on(t.TLD,E),b.on(t.DOT,y),y.on(t.DOMAIN,b),y.on(t.TLD,E),E.on(t.DOT,y),E.on(t.COLON,S),S.on(t.NUM,_);const C=function(e){s.call(this,e),this.type="groupid",this.isLink=!0};C.prototype=new s;const O=n.jump(t.PLUS),k=new e.parser.State,R=new e.parser.State,I=new e.parser.State(C),x=new e.parser.State,T=new e.parser.State(C),j=new e.parser.State,N=new e.parser.State(C),P=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];O.on(P,k),k.on(P,k),k.on(t.DOMAIN,k),k.on(t.COLON,R),R.on(t.DOMAIN,I),R.on(t.LOCALHOST,T),R.on(t.TLD,T),I.on(t.DOT,x),x.on(t.DOMAIN,I),x.on(t.TLD,T),T.on(t.DOT,x),T.on(t.COLON,j),j.on(t.NUM,N)}!function(e){e.URL="url",e.UserId="userid",e.RoomAlias="roomalias",e.GroupId="groupid"}(n||(n={})),o.onUserClick=function(e,t){e.preventDefault()},o.onAliasClick=function(e,t){e.preventDefault()},o.onGroupClick=function(e,t){e.preventDefault()};o.ELEMENT_URL_PATTERN="^(?:https?://)?(?:"+((window.location.host+window.location.pathname).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"|(?:www\\.)?(?:riot|vector)\\.im/(?:app|beta|staging|develop)/|(?:app|beta|staging|develop)\\.element\\.io/)(#.*)"),o.MATRIXTO_URL_PATTERN="^(?:https?://)?(?:www\\.)?matrix\\.to/#/(([#@!+]).*)",o.MATRIXTO_MD_LINK_PATTERN="\\[([^\\]]*)\\]\\((?:https?://)?(?:www\\.)?matrix\\.to/#/([#@!+][^\\)]*)\\)",o.MATRIXTO_BASE_URL=i.a,o.options={events:function(e,t){switch(t){case n.URL:try{const t=Object(a.j)(e);if(t&&t.userId)return{click:function(e){o.onUserClick(e,t.userId)}}}catch(e){}break;case n.UserId:return{click:function(t){o.onUserClick(t,e)}};case n.RoomAlias:return{click:function(t){o.onAliasClick(t,e)}};case n.GroupId:return{click:function(t){o.onGroupClick(t,e)}}}},formatHref:function(e,t){switch(t){case n.RoomAlias:case n.UserId:case n.GroupId:default:return Object(a.k)(e)}},linkAttributes:{rel:"noreferrer noopener"},target:function(e,t){if(t===n.URL)try{return Object(a.l)(e)!==e||decodeURIComponent(e).match(o.ELEMENT_URL_PATTERN)?null:"_blank"}catch(e){}return null}},t.a=o},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(82),i=s.n(n),a=s(84),o=s(88),r=s(101);const c=({avatarUrl:e,avatarDisabled:t=!1,setAvatar:s})=>{const r=Object(n.useRef)(),[c,l]=Object(n.useState)(e);let d;return d=t?c?i.a.createElement("img",{className:"mx_SpaceBasicSettings_avatar",src:c,alt:""}):i.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar"}):c?i.a.createElement(i.a.Fragment,null,i.a.createElement(o.a,{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=r.current)||void 0===e?void 0:e.click()},element:"img",src:c,alt:""}),i.a.createElement(o.a,{onClick:()=>{r.current.value="",l(void 0),s(void 0)},kind:"link",className:"mx_SpaceBasicSettings_avatar_remove","aria-label":Object(a.a)("Delete avatar")},Object(a.a)("Delete"))):i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=r.current)||void 0===e?void 0:e.click()}}),i.a.createElement(o.a,{onClick:()=>{var e;return null===(e=r.current)||void 0===e?void 0:e.click()},kind:"link","aria-label":Object(a.a)("Upload avatar")},Object(a.a)("Upload"))),i.a.createElement("div",{className:"mx_SpaceBasicSettings_avatarContainer"},d,i.a.createElement("input",{type:"file",ref:r,onChange:e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;const n=e.target.files[0];s(n);const i=new FileReader;i.onload=e=>{l(e.target.result)},i.readAsDataURL(n)},accept:"image/*"}))};t.b=({avatarUrl:e,avatarDisabled:t=!1,setAvatar:s,name:n="",nameDisabled:o=!1,setName:l,topic:d="",topicDisabled:h=!1,setTopic:u})=>i.a.createElement("div",{className:"mx_SpaceBasicSettings"},i.a.createElement(c,{avatarUrl:e,avatarDisabled:t,setAvatar:s}),i.a.createElement(r.a,{name:"spaceName",label:Object(a.a)("Name"),autoFocus:!0,value:n,onChange:e=>l(e.target.value),disabled:o}),i.a.createElement(r.a,{name:"spaceTopic",element:"textarea",label:Object(a.a)("Description"),value:d,onChange:e=>u(e.target.value),rows:3,disabled:h}))},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(113),o=s(84),r=s(101),c=s(93),l=s(453),d=s(137),h=s(90),u=s(166);t.a=({title:e,subheading:t,children:s,rageshakeLabel:m,rageshakeData:p={},onFinished:g})=>{const[v,f]=Object(n.useState)(""),[b,y]=Object(n.useState)(!1);return i.a.createElement(a.a,{className:"mx_GenericFeatureFeedbackDialog",hasCancelButton:!0,title:e,description:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_GenericFeatureFeedbackDialog_subheading"},t," ",Object(o.a)("Your platform and username will be noted to help us use your feedback as much as we can."),s),i.a.createElement(r.a,{id:"feedbackComment",label:Object(o.a)("Feedback"),type:"text",autoComplete:"off",value:v,element:"textarea",onChange:e=>{f(e.target.value)},autoFocus:!0}),i.a.createElement(d.b,{checked:b,onChange:e=>y(e.target.checked)},Object(o.a)("You may contact me if you have any follow up questions"))),button:Object(o.a)("Send feedback"),buttonDisabled:!v,onFinished:async t=>{if(!t)return g(!1);Object(l.c)(c.a.get().bug_report_endpoint_url,m,v,b,p),g(!0),h.a.createTrackedDialog("Feedback Sent",m,u.a,{title:e,description:Object(o.a)("Thank you for your feedback, we really appreciate it."),button:Object(o.a)("Done"),hasCloseButton:!1,fixedWidth:!1})}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return v})),s.d(t,"c",(function(){return f}));var n=s(1180),i=s.n(n),a=s(86),o=s(121),r=s(84),c=s(1189),l=s.n(c),d=s(455),h=s(89),u=s(93),m=s(1);async function p(e={},t=!0){const s=e.progressCallback||(()=>{});s(Object(r.a)("Collecting app version information"));let n="UNKNOWN";try{n=await o.a.get().getAppVersion()}catch(e){}let c="UNKNOWN";window.navigator&&window.navigator.userAgent&&(c=window.navigator.userAgent);let l="UNKNOWN";try{l=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}let u="UNKNOWN";try{u=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}const p=a.a.get();m.a.log("Sending bug report.");const g=new FormData;if(g.append("text",e.userText||"User did not supply any additional text."),g.append("app","element-web"),g.append("version",n),g.append("user_agent",c),g.append("installed_pwa",l),g.append("touch_input",u),p&&(g.append("user_id",p.credentials.userId),g.append("device_id",p.deviceId),p.isCryptoEnabled())){const e=["ed25519:"+p.getDeviceEd25519Key()];p.getDeviceCurve25519Key&&e.push("curve25519:"+p.getDeviceCurve25519Key()),g.append("device_keys",e.join(", ")),g.append("cross_signing_key",p.getCrossSigningId());const t=p.crypto.crossSigningInfo,s=p.crypto.secretStorage;g.append("cross_signing_ready",String(await p.isCrossSigningReady())),g.append("cross_signing_supported_by_hs",String(await p.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))),g.append("cross_signing_key",t.getId()),g.append("cross_signing_privkey_in_secret_storage",String(!!await t.isStoredInSecretStorage(s)));const n=p.getCrossSigningCacheCallbacks();g.append("cross_signing_master_privkey_cached",String(!(!n||!await n.getCrossSigningKeyCache("master")))),g.append("cross_signing_self_signing_privkey_cached",String(!(!n||!await n.getCrossSigningKeyCache("self_signing")))),g.append("cross_signing_user_signing_privkey_cached",String(!(!n||!await n.getCrossSigningKeyCache("user_signing")))),g.append("secret_storage_ready",String(await p.isSecretStorageReady())),g.append("secret_storage_key_in_account",String(!!await s.hasKey())),g.append("session_backup_key_in_secret_storage",String(!!await p.isKeyBackupKeyStored()));const i=await p.crypto.getSessionBackupPrivateKey();g.append("session_backup_key_cached",String(!!i)),g.append("session_backup_key_well_formed",String(i instanceof Uint8Array))}e.label&&g.append("label",e.label);const v=h.b.getFeatureSettingNames().filter(e=>h.b.getValue(e));if(v.length&&g.append("enabled_labs",v.join(", ")),h.b.getValue("lowBandwidth")&&g.append("lowBandwidth","enabled"),navigator.storage&&navigator.storage.persisted)try{g.append("storageManager_persisted",String(await navigator.storage.persisted()))}catch(e){}else if(document.hasStorageAccess)try{g.append("storageManager_persisted",String(await document.hasStorageAccess()))}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();g.append("storageManager_quota",String(e.quota)),g.append("storageManager_usage",String(e.usage)),e.usageDetails&&Object.keys(e.usageDetails).forEach(t=>{g.append("storageManager_usage_"+t,String(e.usageDetails[t]))})}catch(e){}if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&g.append("modernizr_missing_features",e.join(", "))}if(g.append("mx_local_settings",localStorage.getItem("mx_local_settings")),e.sendLogs){s(Object(r.a)("Collecting logs"));const e=await d.c();for(const s of e){let e=(new TextEncoder).encode(s.lines);t&&(e=i.a.gzip(e)),g.append("compressed-log",new Blob([e]),s.id)}}return g}async function g(e,t={}){if(!e)throw new Error("No bug report endpoint has been set.");const s=t.progressCallback||(()=>{}),n=await p(t);s(Object(r.a)("Uploading logs")),await b(e,n,s)}async function v(e={}){const t=e.progressCallback||(()=>{}),s=await p(e,!1);t(Object(r.a)("Downloading logs"));let n="";const i=new l.a;let a=0;for(const[e,t]of s.entries())"compressed-log"===e?await new Promise(e=>{const s=new FileReader;s.addEventListener("loadend",t=>{i.append(`log-${a++}.log`,(new TextDecoder).decode(t.target.result)),e()}),s.readAsArrayBuffer(t)}):n+=`${e} = ${t}\n`;i.append("issue.txt",n);const o=document.createElement("a");o.href="data:application/octet-stream;base64,"+btoa(function(e){let t="";for(let s=0;s<e.length;s+=1)t+=String.fromCharCode(e[s]);return t}(i.out)),o.download="rageshake.tar",document.body.appendChild(o),o.click(),document.body.removeChild(o)}async function f(e,t,s,n=!1,i={}){var r;let c="UNKNOWN";try{c=await o.a.get().getAppVersion()}catch(e){}const l=new FormData;l.append("label",t),l.append("text",s),l.append("can_contact",n?"yes":"no"),l.append("app","element-web"),l.append("version",c),l.append("platform",o.a.get().getHumanReadableName()),l.append("user_id",null===(r=a.a.get())||void 0===r?void 0:r.getUserId());for(const e in i)l.append(e,i[e]);await b(u.a.get().bug_report_endpoint_url,l,()=>{})}function b(e,t,s){return new Promise((n,i)=>{const a=new XMLHttpRequest;a.open("POST",e),a.timeout=3e5,a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.LOADING)s(Object(r.a)("Waiting for response from server"));else if(a.readyState===XMLHttpRequest.DONE){if(a.status<200||a.status>=400)return void i(new Error("HTTP "+a.status));n()}},a.send(t)})}},,function(e,t,s){"use strict";(function(e){s.d(t,"d",(function(){return c})),s.d(t,"e",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return h})),s.d(t,"c",(function(){return u}));var n=s(83),i=s.n(n),a=s(1);class o{constructor(){i()(this,"logs","")}monkeyPatch(e){const t={log:"I",info:"I",warn:"W",error:"E"};Object.keys(t).forEach(s=>{const n=t[s],i=e[s].bind(e);e[s]=(...e)=>{this.log(n,...e),i(...e)}})}log(e,...t){let s=`${(new Date).toISOString()} ${e} ${(t=t.map(e=>{if(e instanceof DOMException)return e.message+` (${e.name} | ${e.code})`;if(e instanceof Error)return e.message+(e.stack?"\n"+e.stack:"");if("object"!=typeof e)return e;try{return JSON.stringify(e)}catch(t){return JSON.stringify(e,(e,t)=>e&&"object"==typeof t?"<object>":t)}})).join(" ")}\n`;s=s.replace(/token=[a-zA-Z0-9-]+/gm,"token=xxxxx"),this.logs+=s}flush(e){if(e)return this.logs;const t=this.logs;return this.logs="",t}}class r{constructor(e,t){this.indexedDB=e,this.logger=t,i()(this,"id",void 0),i()(this,"index",0),i()(this,"db",null),i()(this,"flushPromise",null),i()(this,"flushAgainPromise",null),this.id="instance-"+Math.random()+Date.now()}connect(){const e=this.indexedDB.open("logs");return new Promise((t,s)=>{e.onsuccess=e=>{this.db=e.target.result,setInterval(this.flush.bind(this),3e4),t()},e.onerror=e=>{const t="Failed to open log database: "+e.target.error.name;a.a.error(t),s(new Error(t))},e.onupgradeneeded=e=>{const t=e.target.result,s=t.createObjectStore("logs",{keyPath:["id","index"]});s.createIndex("id","id",{unique:!1}),s.add(this.generateLogEntry(new Date+" ::: Log database was created."));t.createObjectStore("logslastmod",{keyPath:"id"}).add(this.generateLastModifiedTime())}})}flush(){return this.flushPromise?(this.flushAgainPromise||(this.flushAgainPromise=this.flushPromise.then(()=>this.flush()).then(()=>{this.flushAgainPromise=null})),this.flushAgainPromise):(this.flushPromise=new Promise((e,t)=>{if(!this.db)return void t(new Error("No connected database"));const s=this.logger.flush();if(0===s.length)return void e();const n=this.db.transaction(["logs","logslastmod"],"readwrite"),i=n.objectStore("logs");n.oncomplete=t=>{e()},n.onerror=e=>{a.a.error("Failed to flush logs : ",e),t(new Error("Failed to write logs: "+e.target.errorCode))},i.add(this.generateLogEntry(s));n.objectStore("logslastmod").put(this.generateLastModifiedTime())}).then(()=>{this.flushPromise=null}),this.flushPromise)}async consume(){const e=this.db;function t(t,s){const n=e.transaction("logs","readonly").objectStore("logs");return new Promise((e,i)=>{const a=n.index("id").openCursor(IDBKeyRange.only(t),"prev");let o="";a.onerror=e=>{i(new Error("Query failed: "+e.target.errorCode))},a.onsuccess=t=>{const n=t.target.result;n?(o=n.value.lines+o,o.length>=s?e(o):n.continue()):e(o)}})}const s=await function(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const i=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(i.push(s(n)),n.continue()):e(i)}})}(e.transaction("logslastmod","readonly").objectStore("logslastmod"),void 0,e=>({id:e.value.id,ts:e.value.ts})).then(e=>e.sort((e,t)=>t.ts-e.ts).map(e=>e.id));let n=[];const i=[];let o=0;for(let e=0;e<s.length;e++){const a=await t(s[e],5242880-o);if(i.push({lines:a,id:s[e]}),o+=a.length,o>=5242880){n=s.slice(e+1);break}}return n.length>0&&(a.a.log("Removing logs: ",n),Promise.all(n.map(t=>function(t){return new Promise((s,n)=>{const i=e.transaction(["logs","logslastmod"],"readwrite"),a=i.objectStore("logs");a.index("id").openKeyCursor(IDBKeyRange.only(t)).onsuccess=e=>{const t=e.target.result;t&&(a.delete(t.primaryKey),t.continue())},i.oncomplete=()=>{s()},i.onerror=e=>{n(new Error(`Failed to delete logs for '${t}' : ${e.target.errorCode}`))};i.objectStore("logslastmod").delete(t)})}(t))).then(()=>{a.a.log(`Removed ${n.length} old logs.`)},e=>{a.a.error(e)})),i}generateLogEntry(e){return{id:this.id,lines:e,index:this.index++}}generateLastModifiedTime(){return{id:this.id,ts:Date.now()}}}function c(t=!0){return e.mx_rage_initPromise?e.mx_rage_initPromise:(e.mx_rage_logger=new o,e.mx_rage_logger.monkeyPatch(window.console),t?l():(e.mx_rage_initPromise=Promise.resolve(),e.mx_rage_initPromise))}function l(){if(e.mx_rage_initStoragePromise)return e.mx_rage_initStoragePromise;let t;a.a.log("Configuring rageshake persistence...");try{t=window.indexedDB}catch(e){}return t?(e.mx_rage_store=new r(t,e.mx_rage_logger),e.mx_rage_initStoragePromise=e.mx_rage_store.connect(),e.mx_rage_initStoragePromise):(e.mx_rage_initStoragePromise=Promise.resolve(),e.mx_rage_initStoragePromise)}function d(){e.mx_rage_store&&e.mx_rage_store.flush()}async function h(){e.mx_rage_store&&await e.mx_rage_store.consume()}async function u(){if(!e.mx_rage_logger)throw new Error("No console logger, did you forget to call init()?");return e.mx_rage_store?(await e.mx_rage_store.flush(),await e.mx_rage_store.consume()):[{lines:e.mx_rage_logger.flush(!0),id:"-"}]}}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(140),i=s(457),a=s(190),o=s(432);class r{static moveTag(e,t,s){let o=a.a.getOrderedTags(),r=a.a.getRemovedTagsAccountData()||[];if(!o)return;o=o.filter(e=>e!==t),o=[...o.slice(0,s),t,...o.slice(s)],r=r.filter(e=>e!==t);const c=a.a.getStoreId();return Object(i.a)("TagOrderActions.moveTag",()=>(n.a.trackEvent("TagOrderActions","commitTagOrdering"),e.setAccountData("im.vector.web.tag_ordering",{tags:o,removedTags:r,_storeId:c})),()=>({tags:o,removedTags:r}))}static removeTag(e,t){const s=a.a.getOrderedTags(),r=a.a.getRemovedTagsAccountData()||[];if(r.includes(t))return new o.a(()=>{});r.push(t);const c=a.a.getStoreId();return Object(i.a)("TagOrderActions.removeTag",()=>(n.a.trackEvent("TagOrderActions","removeTag"),e.setAccountData("im.vector.web.tag_ordering",{tags:s,removedTags:r,_storeId:c})),()=>({removedTags:r}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(432);function i(e,t,s){return new n.a(n=>{n({action:e+".pending",request:"function"==typeof s?s():void 0}),t().then(t=>{n({action:e+".success",result:t})}).catch(t=>{n({action:e+".failure",err:t})})})}},function(e,t){e.exports="img/element-icons/warning-badge.713e1ca.svg"},function(e,t,s){"use strict";function n(e,t){return e.size!==t.size||(!!Array.from(t).some(t=>!e.has(t))||!!Array.from(e).some(e=>!t.has(e)))}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(86),i=s(676),a=s(191),o=s(94);function r(e){const t=e.getType(),s=e.getContent(),n=e.getPrevContent();return t===o.a.RoomMember&&n.membership!==s.membership||"im.vector.user_status"!==t&&((t!==o.a.RoomMember||n.displayname===s.displayname)&&(t!==o.a.RoomMember||n.avatar_url===s.avatar_url))}const c=e=>{let t="";n.a.get()&&(t=n.a.get().getUserId());const s={},o=e=>{if(s[e.roomId])return s[e.roomId];const n=(()=>{if(!e||!e.timeline)return Number.MAX_SAFE_INTEGER;if(Object(a.b)(e.getMyMembership())!==a.a.Join){const s=e.currentState.getStateEvents("m.room.member",t);if(s&&!Array.isArray(s))return s.getTs()}for(let s=e.timeline.length-1;s>=0;--s){const n=e.timeline[s];if(n.getTs()&&(n.getSender()===t&&r(n)||i.b(n)))return n.getTs()}return e.timeline.length&&e.timeline[0].getTs()?e.timeline[0].getTs():Number.MAX_SAFE_INTEGER})();return s[e.roomId]=n,n};return e.sort((e,t)=>o(t)-o(e))};class l{sortRooms(e,t){return c(e)}}},,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(84),m=s(87),p=s(92),g=s(375),v=s(708),f=s(107),b=s(94),y=s(85),E=s(167),S=s(262),_=s(504),w=s(1);let C=Object(y.a)("views.rooms.ReplyTile")((a=i=class extends l.a.PureComponent{constructor(...e){super(...e),r()(this,"anchorElement",Object(c.createRef)()),r()(this,"onDecrypted",()=>{this.forceUpdate(),this.props.onHeightChanged&&this.props.onHeightChanged()}),r()(this,"onEventRequiresUpdate",()=>{this.forceUpdate()}),r()(this,"onClick",e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():m.a.dispatch({action:p.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()}))})}componentDidMount(){this.props.mxEvent.on("Event.decrypted",this.onDecrypted),this.props.mxEvent.on("Event.beforeRedaction",this.onEventRequiresUpdate),this.props.mxEvent.on("Event.replaced",this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener("Event.decrypted",this.onDecrypted),this.props.mxEvent.removeListener("Event.beforeRedaction",this.onEventRequiresUpdate),this.props.mxEvent.removeListener("Event.replaced",this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,s=e.getType(),{tileHandler:n,isInfoMessage:i}=Object(E.d)(e);if(!n){const{mxEvent:e}=this.props;return w.a.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),l.a.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},Object(u.a)("This event could not be displayed"))}const a=f.getComponent(n),o=h()("mx_ReplyTile",{mx_ReplyTile_info:i&&!e.isRedacted(),mx_ReplyTile_audio:t===b.b.Audio,mx_ReplyTile_video:t===b.b.Video});let r,c="#";this.props.permalinkCreator&&(c=this.props.permalinkCreator.forEvent(e.getId()));!i&&t!==b.b.Image&&n!==b.a.RoomCreate&&s!==b.a.Sticker&&(r=l.a.createElement(g.a,{mxEvent:e,enableFlair:!1,userNameColorMode:this.props.userNameColorMode}));const d={[b.b.Image]:v.a,[b.b.Audio]:Object(E.f)(e)?_.a:S.a,[b.b.Video]:S.a},m={[b.a.Sticker]:v.a};return l.a.createElement("div",{className:o},l.a.createElement("a",{href:c,onClick:this.onClick,ref:this.anchorElement},r,l.a.createElement(a,{ref:"tile",mxEvent:e,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,userNameColorMode:this.props.userNameColorMode,showUrlPreview:!1,overrideBodyTypes:d,overrideEventTypes:m,replacingEventId:e.replacingEventId(),maxImageHeight:96})))}},r()(i,"defaultProps",{onHeightChanged:()=>{}}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return x}));var n,i,a,o=s(95),r=s.n(o),c=s(83),l=s.n(c),d=s(82),h=s.n(d),u=s(1246),m=s(262),p=s(90),g=s(84),v=s(89),f=s(98),b=s(145),y=s(85),E=s(103),S=s(202),_=s(283),w=s(91),C=s.n(w),O=s(746),k=s(1),R=s(134),I=s(382);let x=Object(y.a)("views.messages.MImageBody")((a=i=class extends h.a.Component{constructor(e){super(e),l()(this,"unmounted",!0),l()(this,"image",Object(d.createRef)()),l()(this,"timeout",void 0),l()(this,"sizeWatcher",void 0),l()(this,"onClientSync",(e,t)=>{if(this.unmounted)return;"ERROR"!==e&&t!==e&&this.state.imgError&&this.setState({imgError:!1})}),l()(this,"onClick",e=>{if(0===e.button&&!e.metaKey){var t;if(e.preventDefault(),!this.state.showImage)return void this.showImage();const s=this.props.mxEvent.getContent(),n={src:this.getContentUrl(),name:(null===(t=s.body)||void 0===t?void 0:t.length)>0?s.body:Object(g.a)("Attachment"),mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator};if(s.info&&(n.width=s.info.w,n.height=s.info.h,n.fileSize=s.info.size),this.image.current){const e=this.image.current.getBoundingClientRect();n.thumbnailInfo={width:e.width,height:e.height,positionX:e.x,positionY:e.y}}p.a.createDialog(_.a,n,"mx_Dialog_lightbox",null,!0)}}),l()(this,"isGif",()=>{var e;return"image/gif"===(null===(e=this.props.mxEvent.getContent().info)||void 0===e?void 0:e.mimetype)}),l()(this,"onImageEnter",e=>{if(this.setState({hover:!0}),!this.state.showImage||!this.isGif()||v.b.getValue("autoplayGifs"))return;e.currentTarget.src=this.getContentUrl()}),l()(this,"onImageLeave",e=>{if(this.setState({hover:!1}),!this.state.showImage||!this.isGif()||v.b.getValue("autoplayGifs"))return;e.currentTarget.src=this.getThumbUrl()}),l()(this,"onImageError",()=>{this.clearBlurhashTimeout(),this.setState({imgError:!0})}),l()(this,"onImageLoad",()=>{let e;if(this.clearBlurhashTimeout(),this.props.onHeightChanged(),this.image.current){const{naturalWidth:t,naturalHeight:s}=this.image.current;e={naturalWidth:t,naturalHeight:s}}this.setState({imgLoaded:!0,loadedImageDimensions:e})}),this.state={decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,imgError:!1,imgLoaded:!1,loadedImageDimensions:null,hover:!1,showImage:v.b.getValue("showImages"),placeholder:"no-image"}}showImage(){localStorage.setItem("mx_ShowImage_"+this.props.mxEvent.getId(),"true"),this.setState({showImage:!0}),this.downloadImage()}getContentUrl(){var e;const t=this.props.mxEvent.getContent();return this.props.forExport?t.url||(null===(e=t.file)||void 0===e?void 0:e.url):this.media.isEncrypted?this.state.decryptedUrl:this.media.srcHttp}get media(){return Object(E.a)(this.props.mxEvent.getContent())}getThumbUrl(){const e=this.props.mxEvent.getContent(),t=Object(E.a)(e);if(t.isEncrypted)return this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.decryptedUrl;if(e.info&&"image/svg+xml"===e.info.mimetype&&t.hasThumbnail)return t.getThumbnailHttp(800,600,"scale");{const s=e.info;if(!this.isGif()&&1!==window.devicePixelRatio&&s&&s.w&&s.h&&s.size){const e=s.w>800||s.h>600;return s.size>1048576&&e?t.getThumbnailOfSourceHttp(800,600):t.srcHttp}return t.getThumbnailOfSourceHttp(800,600)}}async downloadImage(){if(this.props.mediaEventHelper.media.isEncrypted&&null===this.state.decryptedUrl)try{const e=await this.props.mediaEventHelper.thumbnailUrl.value;this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedThumbnailUrl:e,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value})}catch(e){if(this.unmounted)return;k.a.warn("Unable to decrypt attachment: ",e),this.setState({error:e})}}clearBlurhashTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}componentDidMount(){var e;this.unmounted=!1,this.context.on("sync",this.onClientSync);(this.state.showImage||"true"===localStorage.getItem("mx_ShowImage_"+this.props.mxEvent.getId()))&&(this.downloadImage(),this.setState({showImage:!0})),null!==(e=this.props.mxEvent.getContent().info)&&void 0!==e&&e[S.a]&&(this.clearBlurhashTimeout(),this.timeout=setTimeout(()=>{this.state.imgLoaded&&this.state.imgError||this.setState({placeholder:"blurhash"})},150)),this.sizeWatcher=v.b.watchSetting("Images.size",null,()=>{this.forceUpdate()})}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("sync",this.onClientSync),this.clearBlurhashTimeout(),v.b.unwatchSetting(this.sizeWatcher)}messageContent(e,t,s,n){var i;let a,o;if(s&&s.info&&s.info.w&&s.info.h)a=s.info.w,o=s.info.h;else{if(!this.state.loadedImageDimensions){let n;return n=this.state.showImage?h.a.createElement("img",{style:{display:"none"},src:t,ref:this.image,alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad}):h.a.createElement(T,null),this.wrapImage(e,n)}a=this.state.loadedImageDimensions.naturalWidth,o=this.state.loadedImageDimensions.naturalHeight}const r=v.b.getValue("Images.size"),c=a<o,l=Math.min(Object(I.b)(r,c).w,a),d=Math.min(Object(I.b)(r,c).h,o),u=a/o;let m,p;const g=n||this.props.maxImageHeight||d;g*u<l||r===I.a.Large?(m=g*u,p=g):(m=l,p=l/u);let f=null,b=null,y=null;this.props.forExport||this.state.imgLoaded||(b=this.getPlaceholder(m,p));let E=Boolean(b);t&&!this.state.imgError&&(f=h.a.createElement("img",{className:"mx_MImageBody_thumbnail",src:t,ref:this.image,style:{height:"100%"},alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad,onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})),this.state.showImage||(f=h.a.createElement(T,{maxWidth:m}),E=!1),!this.isGif()||v.b.getValue("autoplayGifs")||this.state.hover||(y=h.a.createElement("p",{className:"mx_MImageBody_gifLabel"},"GIF"));const _=C()({mx_MImageBody_thumbnail:!0,"mx_MImageBody_thumbnail--blurhash":null===(i=this.props.mxEvent.getContent().info)||void 0===i?void 0:i[S.a]}),w=O.CSSTransition,k=h.a.createElement("div",{className:"mx_MImageBody_thumbnail_container",style:{maxHeight:p,maxWidth:m,aspectRatio:`${a}/${o}`}},h.a.createElement(O.SwitchTransition,{mode:"out-in"},h.a.createElement(w,{classNames:"mx_rtg--fade",key:"img-"+E,timeout:300},h.a.createElement("div",null,E&&h.a.createElement("div",{className:_,style:{maxWidth:`min(100%, ${a}px)`,maxHeight:p,aspectRatio:`${a}/${o}`}},b)))),h.a.createElement("div",{style:{height:"100%"}},f,y),this.state.hover&&this.getTooltip());return this.wrapImage(e,k)}wrapImage(e,t){return h.a.createElement("a",{href:e,target:this.props.forExport?"_blank":void 0,onClick:this.onClick},t)}getPlaceholder(e,t){var s;const n=null===(s=this.props.mxEvent.getContent().info)||void 0===s?void 0:s[S.a];if(n){if("no-image"===this.state.placeholder)return h.a.createElement("div",{className:"mx_no-image-placeholder",style:{width:e,height:t}});if("blurhash"===this.state.placeholder)return h.a.createElement(u.Blurhash,{className:"mx_Blurhash",hash:n,width:e,height:t})}return h.a.createElement(b.a,{w:32,h:32})}getTooltip(){return null}getFileBody(){if(this.props.forExport)return null;return!this.props.tileShape||this.props.tileShape===R.a.Thread||this.props.tileShape===R.a.ThreadPanel?void 0:h.a.createElement(m.a,r()({},this.props,{showGenericPlaceholder:!1}))}render(){const e=this.props.mxEvent.getContent();if(null!==this.state.error)return h.a.createElement("div",{className:"sc_MImageBody_container"},h.a.createElement("div",{className:"mx_MImageBody"},h.a.createElement("img",{src:s(270),width:"16",height:"16"}),Object(g.a)("Error decrypting image"),this.props.scBubbleGroupTimestamp),this.props.scBubbleActionBar);const t=this.getContentUrl();let n;n=this.props.forExport||this.isGif()&&v.b.getValue("autoplayGifs")?t:this.getThumbUrl();const i=this.messageContent(t,n,e),a=this.getFileBody();return h.a.createElement("div",{className:"sc_MImageBody_container"},h.a.createElement("div",{className:"mx_MImageBody"},i,a,this.props.scBubbleGroupTimestamp),this.props.scBubbleActionBar)}},l()(i,"contextType",f.a),n=a))||n;class T extends h.a.PureComponent{render(){const e=this.props.maxWidth?this.props.maxWidth+"px":null;let t="mx_HiddenImagePlaceholder";return this.props.hover&&(t+=" mx_HiddenImagePlaceholder_hover"),h.a.createElement("div",{className:t,style:{maxWidth:`min(100%, ${e}px)`}},h.a.createElement("div",{className:"mx_HiddenImagePlaceholder_button"},h.a.createElement("span",{className:"mx_HiddenImagePlaceholder_eye"}),h.a.createElement("span",null,Object(g.a)("Show image"))))}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(117),i=s(86),a=s(87),o=s(1);class r{static resendUnsentEvents(e){return Promise.all(e.getPendingEvents().filter((function(e){return e.status===n.a.NOT_SENT})).map((function(e){return r.resend(e)})))}static cancelUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===n.a.NOT_SENT})).forEach((function(e){r.removeFromQueue(e)}))}static resend(e){const t=i.a.get().getRoom(e.getRoomId());return i.a.get().resendEvent(e,t).then((function(t){a.a.dispatch({action:"message_sent",event:e})}),(function(e){o.a.log("Resend got send failure: "+e.name+"("+e+")")}))}static removeFromQueue(e){i.a.get().cancelPendingEvent(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(83),i=s.n(n),a=s(86),o=s(415),r=s(89),c=s(84),l=s(87),d=s(100),h=s(127),u=s(1);class m{constructor(){i()(this,"_lists",[]),i()(this,"_roomIds",[]),i()(this,"mjolnirWatchRef",null),i()(this,"dispatcherRef",null),i()(this,"onAction",e=>{"setup_mjolnir"===e.action&&(u.a.log("Setting up Mjolnir: after sync"),this.setup())}),i()(this,"onEvent",e=>{a.a.get()&&this._roomIds.includes(e.getRoomId())&&o.a.includes(e.getType())&&this.updateLists(this._roomIds)})}get roomIds(){return this._roomIds}get lists(){return this._lists}start(){this.mjolnirWatchRef=r.b.watchSetting("mjolnirRooms",null,this.onListsChanged.bind(this)),this.dispatcherRef=l.a.register(this.onAction),l.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"setup_mjolnir"}})}setup(){a.a.get()&&(this.updateLists(r.b.getValue("mjolnirRooms")),a.a.get().on("RoomState.events",this.onEvent))}stop(){this.mjolnirWatchRef&&(r.b.unwatchSetting(this.mjolnirWatchRef),this.mjolnirWatchRef=null),this.dispatcherRef&&(l.a.unregister(this.dispatcherRef),this.dispatcherRef=null),a.a.get()&&a.a.get().removeListener("RoomState.events",this.onEvent)}async getOrCreatePersonalList(){let e=r.b.getValue("mjolnirPersonalRoom");if(!e){const t=await a.a.get().createRoom({name:Object(c.a)("My Ban List"),topic:Object(c.a)("This is your list of users/servers you have blocked - don't leave the room!"),preset:h.d.PrivateChat});e=t.room_id,await r.b.setValue("mjolnirPersonalRoom",null,d.a.ACCOUNT,e),await r.b.setValue("mjolnirRooms",null,d.a.ACCOUNT,[e,...this._roomIds])}if(!e)throw new Error("Error finding a room ID to use");let t=this._lists.find(t=>t.roomId===e);return t||(t=new o.b(e)),t}getPersonalList(){const e=r.b.getValue("mjolnirPersonalRoom");if(!e)return null;let t=this._lists.find(t=>t.roomId===e);return t||(t=new o.b(e)),t}async subscribeToList(e){const t=[...this._roomIds,e];await r.b.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists.push(new o.b(e))}async unsubscribeFromList(e){const t=this._roomIds.filter(t=>t!==e);await r.b.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists=this._lists.filter(t=>t.roomId!==e)}onListsChanged(e,t,s,n){this.updateLists(n)}updateLists(e){if(a.a.get()&&(u.a.log("Updating Mjolnir ban lists to: "+e),this._lists=[],this._roomIds=e||[],e))for(const t of e)this._lists.push(new o.b(t))}isServerBanned(e){for(const t of this._lists)for(const s of t.serverRules)if(s.isMatch(e))return!0;return!1}isUserBanned(e){for(const t of this._lists)for(const s of t.userRules)if(s.isMatch(e))return!0;return!1}static sharedInstance(){return m.instance||(m.instance=new m),m.instance}}i()(m,"instance",null)},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(98),r=s(136),c=s(89);const l=i.a.forwardRef(({mxEvent:e},t)=>{const s=Object(n.useContext)(o.a);let l=Object(a.a)("Message deleted");const d=e.getUnsigned(),h=d&&d.redacted_because&&d.redacted_because.sender;if(h&&h!==e.getSender()){const t=s.getRoom(e.getRoomId()),n=t&&t.getMember(h);l=Object(a.a)("Message deleted by %(name)s",{name:n?n.name:h})}const u=c.b.getValue("showTwelveHourTimestamps"),m=Object(r.c)(new Date(d.redacted_because.origin_server_ts),u),p=Object(a.a)("Message deleted on %(date)s",{date:m});return i.a.createElement("span",{className:"mx_RedactedBody",ref:t,title:p},l)});t.a=l},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(82),i=s(135);const a=e=>e,o=(e,t=a)=>{const[s,o]=Object(n.useState)(e?t(e.currentState):void 0),r=Object(n.useCallback)(()=>{e&&o(t(e.currentState))},[e,t]);return Object(i.a)(null==e?void 0:e.currentState,"RoomState.events",r),Object(n.useEffect)(()=>(r(),()=>{o(void 0)}),[r]),s}},function(e,t,s){"use strict";s.d(t,"b",(function(){return _})),s.d(t,"a",(function(){return w}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(479),u=s(87),m=s(307),p=s(92),g=s(85),v=s(117),f=s(192),b=s(264),y=s(88),E=s(145),S=s(98);function _(e){return e?e.getPendingEvents().filter((function(e){return e.status===v.a.NOT_SENT})):[]}let w=Object(g.a)("structures.RoomStatusBar")((a=i=class extends l.a.PureComponent{constructor(e,t){super(e,t),r()(this,"onSyncStateChange",(e,t,s)=>{"SYNCING"===e&&"SYNCING"===t||this.setState({syncState:e,syncStateData:s})}),r()(this,"onResendAllClick",()=>{h.a.resendUnsentEvents(this.props.room).then(()=>{this.setState({isResending:!1})}),this.setState({isResending:!0}),u.a.fire(p.a.FocusSendMessageComposer)}),r()(this,"onCancelAllClick",()=>{h.a.cancelUnsentEvents(this.props.room),u.a.fire(p.a.FocusSendMessageComposer)}),r()(this,"onRoomLocalEchoUpdated",(e,t)=>{if(t.roomId!==this.props.room.roomId)return;const s=_(this.props.room);this.setState({unsentMessages:s,isResending:s.length>0&&this.state.isResending})}),this.state={syncState:this.context.getSyncState(),syncStateData:this.context.getSyncStateData(),unsentMessages:_(this.props.room),isResending:!1}}componentDidMount(){const e=this.context;e.on("sync",this.onSyncStateChange),e.on("Room.localEchoUpdated",this.onRoomLocalEchoUpdated),this.checkSize()}componentDidUpdate(){this.checkSize()}componentWillUnmount(){const e=this.context;e&&(e.removeListener("sync",this.onSyncStateChange),e.removeListener("Room.localEchoUpdated",this.onRoomLocalEchoUpdated))}checkSize(){this.getSize()?this.props.onVisible&&this.props.onVisible():this.props.onHidden&&this.props.onHidden()}getSize(){return this.shouldShowConnectionError()?1:this.state.unsentMessages.length>0||this.state.isResending?2:0}shouldShowConnectionError(){const e=Boolean(this.state.syncStateData&&this.state.syncStateData.error&&"M_RESOURCE_LIMIT_EXCEEDED"===this.state.syncStateData.error.name);return"ERROR"===this.state.syncState&&!e}getUnsentMessageContent(){const e=this.state.unsentMessages;let t,s=null,n=null;for(const t of e){if(t.error&&"M_CONSENT_NOT_GIVEN"===t.error.errcode){s=t.error;break}if(t.error&&"M_RESOURCE_LIMIT_EXCEEDED"===t.error.errcode){n=t.error;break}}t=s?Object(d.a)("You can't send any messages until you review and agree to <consentLink>our terms and conditions</consentLink>.",{},{consentLink:e=>l.a.createElement("a",{href:s.data&&s.data.consent_uri,target:"_blank"},e)}):n?Object(m.a)(n.data.limit_type,n.data.admin_contact,{monthly_active_user:Object(d.b)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. Please <a>contact your service administrator</a> to continue using the service."),hs_disabled:Object(d.b)("Your message wasn't sent because this homeserver has been blocked by it's administrator. Please <a>contact your service administrator</a> to continue using the service."),"":Object(d.b)("Your message wasn't sent because this homeserver has exceeded a resource limit. Please <a>contact your service administrator</a> to continue using the service.")}):Object(d.a)("Some of your messages have not been sent");let i=l.a.createElement(l.a.Fragment,null,l.a.createElement(y.a,{onClick:this.onCancelAllClick,className:"mx_RoomStatusBar_unsentCancelAllBtn"},Object(d.a)("Delete all")),l.a.createElement(y.a,{onClick:this.onResendAllClick,className:"mx_RoomStatusBar_unsentResendAllBtn"},Object(d.a)("Retry all")));return this.state.isResending&&(i=l.a.createElement(l.a.Fragment,null,l.a.createElement(E.a,{w:20,h:20}),l.a.createElement("span",null,Object(d.a)("Sending")))),l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_RoomStatusBar mx_RoomStatusBar_unsentMessages"},l.a.createElement("div",{role:"alert"},l.a.createElement("div",{className:"mx_RoomStatusBar_unsentBadge"},l.a.createElement(f.a,{notification:b.a.RED_EXCLAMATION})),l.a.createElement("div",null,l.a.createElement("div",{className:"mx_RoomStatusBar_unsentTitle"},t),l.a.createElement("div",{className:"mx_RoomStatusBar_unsentDescription"},Object(d.a)("You can select all or individual messages to retry or delete"))),l.a.createElement("div",{className:"mx_RoomStatusBar_unsentButtonBar"},i))))}render(){return this.shouldShowConnectionError()?l.a.createElement("div",{className:"mx_RoomStatusBar"},l.a.createElement("div",{role:"alert"},l.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},l.a.createElement("img",{src:s(723),width:"24",height:"24",title:"/!\\ ",alt:"/!\\ "}),l.a.createElement("div",null,l.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},Object(d.a)("Connectivity to the server has been lost.")),l.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},Object(d.a)("Sent messages will be stored until your connection has returned.")))))):this.state.unsentMessages.length>0||this.state.isResending?this.getUnsentMessageContent():null}},r()(i,"contextType",S.a),n=a))||n},,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(169),o=s(309);class r extends a.a{constructor(e){super(),this.defaultTheme=e}getValueOverride(e,t,s,n){if(!s)return null;if(r.isLogin)return this.defaultTheme;return Object(o.a)()[s]?null:this.defaultTheme}}i()(r,"isLogin",!1)},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(87),u=s(108),m=s(85),p=s(96);let g=Object(m.a)("views.settings.IntegrationManager")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"dispatcherRef",void 0),r()(this,"state",{errored:!1}),r()(this,"onKeyDown",e=>{e.key===u.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),r()(this,"onAction",e=>{"close_scalar"===e.action&&this.props.onFinished()}),r()(this,"onError",()=>{this.setState({errored:!0})})}componentDidMount(){this.dispatcherRef=h.a.register(this.onAction),document.addEventListener("keydown",this.onKeyDown)}componentWillUnmount(){h.a.unregister(this.dispatcherRef),document.removeEventListener("keydown",this.onKeyDown)}render(){return this.props.loading?l.a.createElement("div",{className:"mx_IntegrationManager_loading"},l.a.createElement("h3",null,Object(d.a)("Connecting to integration manager...")),l.a.createElement(p.a,null)):!this.props.connected||this.state.errored?l.a.createElement("div",{className:"mx_IntegrationManager_error"},l.a.createElement("h3",null,Object(d.a)("Cannot connect to integration manager")),l.a.createElement("p",null,Object(d.a)("The integration manager is offline or it cannot reach your homeserver."))):l.a.createElement("iframe",{src:this.props.url,onError:this.onError})}},r()(i,"defaultProps",{connected:!0,loading:!1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(93),o=s(86),r=s(1);class c{constructor(){i()(this,"domain",void 0),i()(this,"update",async e=>{let t=(a.a.get().jitsi||{}).preferredDomain||"jitsi.riot.im";if(r.a.log("Attempting to get Jitsi conference information from homeserver"),e&&e["im.vector.riot.jitsi"]){const s=e["im.vector.riot.jitsi"].preferredDomain;s&&(t=s)}this.domain=t,r.a.log("Jitsi conference domain:",this.preferredDomain)})}get preferredDomain(){return this.domain||"jitsi.riot.im"}async getJitsiAuth(){if(!this.preferredDomain)return null;let e;try{const t=await fetch(`https://${this.preferredDomain}/.well-known/element/jitsi`);e=await t.json()}catch(e){return null}return e.auth?e.auth:null}start(){const e=o.a.get();e.on("WellKnown.client",this.update),this.update(e.getClientWellKnown())}parsePreferredConferenceUrl(e){const t=new URL(e);return t.hostname!==this.preferredDomain?null:{conferenceId:t.pathname.substring(1),domain:t.hostname,isAudioOnly:!1}}static getInstance(){return c.instance||(c.instance=new c),c.instance}}i()(c,"instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(85);let u=Object(h.a)("views.rooms.PresenceLabel")((a=i=class extends l.a.Component{getDuration(e){if(!e)return;const t=Math.round(e/1e3),s=t%60,n=Math.round(t/60)%60,i=Math.round(t/3600)%24,a=Math.round(t/86400);return t<60?t<0?Object(d.a)("%(duration)ss",{duration:0}):Object(d.a)("%(duration)ss",{duration:s}):t<3600?Object(d.a)("%(duration)sm",{duration:n}):t<86400?Object(d.a)("%(duration)sh",{duration:i}):Object(d.a)("%(duration)sd",{duration:a})}getPrettyPresence(e,t,s){if(!s&&void 0!==t&&t>0){const s=this.getDuration(t);return"online"===e?Object(d.a)("Online for %(duration)s",{duration:s}):"unavailable"===e?Object(d.a)("Idle for %(duration)s",{duration:s}):"offline"===e?Object(d.a)("Offline for %(duration)s",{duration:s}):Object(d.a)("Unknown for %(duration)s",{duration:s})}return"online"===e?Object(d.a)("Online"):"unavailable"===e?Object(d.a)("Idle"):"offline"===e?Object(d.a)("Offline"):Object(d.a)("Unknown")}render(){return l.a.createElement("div",{className:"mx_PresenceLabel"},this.getPrettyPresence(this.props.presenceState,this.props.activeAgo,this.props.currentlyActive))}},r()(i,"defaultProps",{activeAgo:-1,presenceState:null}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(82),a=s.n(i),o=s(496),r=s(84),c=s(98),l=s(379),d=s(167),h=s(86),u=s(85),m=s(97);let p=Object(u.a)("structures.ViewSource")(n=class extends a.a.Component{constructor(e){super(e),this.state={isEditing:!1}}onBack(){this.setState({isEditing:!1})}onEdit(){this.setState({isEditing:!0})}viewSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isEncrypted(),s=e.clearEvent,n=e.event;return t?a.a.createElement(a.a.Fragment,null,a.a.createElement("details",{open:!0,className:"mx_ViewSource_details"},a.a.createElement("summary",null,a.a.createElement("span",{className:"mx_ViewSource_heading"},Object(r.a)("Decrypted event source"))),a.a.createElement(o.a,{className:"json"},JSON.stringify(s,null,2))),a.a.createElement("details",{className:"mx_ViewSource_details"},a.a.createElement("summary",null,a.a.createElement("span",{className:"mx_ViewSource_heading"},Object(r.a)("Original event source"))),a.a.createElement(o.a,{className:"json"},JSON.stringify(n,null,2)))):a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"mx_ViewSource_heading"},Object(r.a)("Original event source")),a.a.createElement(o.a,{className:"json"},JSON.stringify(n,null,2)))}getBaseEventId(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isEncrypted(),s=this.props.mxEvent;var n,i,a,o;return t?null!==(n=null===(i=e.event.content["m.relates_to"])||void 0===i?void 0:i.event_id)&&void 0!==n?n:s.getId():null!==(a=null===(o=e.getContent()["m.relates_to"])||void 0===o?void 0:o.event_id)&&void 0!==a?a:s.getId()}editSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isState(),s=e.getRoomId(),n=e.getContent();if(t)return a.a.createElement(c.a.Consumer,null,t=>a.a.createElement(l.a,{room:t.getRoom(s),forceStateEvent:!0,onBack:()=>this.onBack(),inputs:{eventType:e.getType(),evContent:JSON.stringify(n,null,"\t"),stateKey:e.getStateKey()}}));{var i,o;const t=null!==(i=null===(o=n["m.new_content"])||void 0===o?void 0:o.body)&&void 0!==i?i:n.body,r={body:" * "+t,msgtype:n.msgtype,"m.new_content":{body:t,msgtype:n.msgtype},"m.relates_to":{rel_type:"m.replace",event_id:this.getBaseEventId()}};return a.a.createElement(c.a.Consumer,null,t=>a.a.createElement(l.a,{room:t.getRoom(s),forceStateEvent:!1,forceGeneralEvent:!0,onBack:()=>this.onBack(),inputs:{eventType:e.getType(),evContent:JSON.stringify(r,null,"\t")}}))}}canSendStateEvent(e){const t=h.a.get();return t.getRoom(e.getRoomId()).currentState.mayClientSendStateEvent(e.getType(),t)}render(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=this.state.isEditing,s=e.getRoomId(),n=e.getId(),i=e.isState()?this.canSendStateEvent(e):Object(d.a)(this.props.mxEvent);return a.a.createElement(m.a,{className:"mx_ViewSource",onFinished:this.props.onFinished,title:Object(r.a)("View Source")},a.a.createElement("div",null,a.a.createElement("div",null,"Room ID: ",s),a.a.createElement("div",null,"Event ID: ",n),a.a.createElement("div",{className:"mx_ViewSource_separator"}),t?this.editSourceContent():this.viewSourceContent()),!t&&i&&a.a.createElement("div",{className:"mx_Dialog_buttons"},a.a.createElement("button",{onClick:()=>this.onEdit()},Object(r.a)("Edit"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(740),l=s.n(c),d=s(85);let h=Object(d.a)("views.elements.SyntaxHighlight")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"el",null),a()(this,"ref",e=>{this.el=e,this.componentDidUpdate()})}componentDidUpdate(){this.el&&l.a.highlightElement(this.el)}render(){const{className:e,children:t}=this.props;return r.a.createElement("pre",{className:e+" mx_SyntaxHighlight",ref:this.ref},r.a.createElement("code",null,t))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(101),h=s(84),u=s(85),m=s(97),p=s(109);let g=Object(u.a)("views.dialogs.TextInputDialog")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"field",Object(c.createRef)()),r()(this,"onOk",async e=>{if(e.preventDefault(),this.props.validator&&(this.setState({busy:!0}),await this.field.current.validate({allowEmpty:!1}),!this.field.current.state.valid))return this.field.current.focus(),this.field.current.validate({allowEmpty:!1,focused:!0}),void this.setState({busy:!1});this.props.onFinished(!0,this.state.value)}),r()(this,"onCancel",()=>{this.props.onFinished(!1)}),r()(this,"onChange",e=>{this.setState({value:e.target.value})}),r()(this,"onValidate",async e=>{const t=await this.props.validator(e);return this.setState({valid:t.valid}),t}),this.state={value:this.props.value,busy:!1,valid:!1}}componentDidMount(){this.props.focus&&this.field.current.focus()}render(){return l.a.createElement(m.a,{className:"mx_TextInputDialog",onFinished:this.props.onFinished,title:this.props.title,fixedWidth:this.props.fixedWidth},l.a.createElement("form",{onSubmit:this.onOk},l.a.createElement("div",{className:"mx_Dialog_content"},l.a.createElement("div",{className:"mx_TextInputDialog_label"},l.a.createElement("label",{htmlFor:"textinput"}," ",this.props.description," ")),l.a.createElement("div",null,l.a.createElement(d.a,{className:"mx_TextInputDialog_input",ref:this.field,type:"text",label:this.props.placeholder,value:this.state.value,onChange:this.onChange,onValidate:this.props.validator?this.onValidate:void 0})))),l.a.createElement(p.a,{primaryButton:this.state.busy?Object(h.a)(this.props.busyMessage):this.props.button,disabled:this.state.busy,onPrimaryButtonClick:this.onOk,onCancel:this.onCancel,hasCancel:this.props.hasCancel}))}},r()(i,"defaultProps",{title:"",value:"",description:"",busyMessage:Object(h.b)("Loading..."),focus:!0,hasCancel:!0}),n=a))||n},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s(1480),l=s(91),d=s.n(l),h=s(84),u=s(96);const m=["data","className"];function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const v={errorCorrectionLevel:"L"};t.a=e=>{let{data:t,className:s}=e,n=o()(e,m);const[i,a]=r.useState(null);return r.useEffect(()=>{let e=!1;return Object(c.toDataURL)(t,g(g({},v),n)).then(t=>{e||a(t)}),()=>{e=!0}},[JSON.stringify(t),n]),r.createElement("div",{className:d()("mx_QRCode",s)},i?r.createElement("img",{src:i,className:"mx_VerificationQRCode",alt:Object(h.a)("QR Code")}):r.createElement(u.a,null))}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(82),a=s.n(i),o=s(136),r=s(85);let c=Object(r.a)("views.messages.MessageTimestamp")(n=class extends a.a.Component{render(){const e=new Date(this.props.ts);let t;return t=this.props.showRelative?Object(o.h)(e,this.props.showTwelveHour):this.props.showFullDate?Object(o.c)(e,this.props.showTwelveHour,this.props.showSeconds):this.props.showSeconds?Object(o.g)(e,this.props.showTwelveHour):Object(o.j)(e,this.props.showTwelveHour),a.a.createElement("span",{className:"mx_MessageTimestamp",title:Object(o.c)(e,this.props.showTwelveHour),"aria-hidden":!0},t)}})||n},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(95),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(145),d=s(84),h=s(505),u=s(596),m=s(262);let p=Object(c.a)("views.messages.MVoiceMessageBody")(n=class extends u.a{render(){return this.state.error?r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement("img",{src:s(270),width:"16",height:"16"}),Object(d.a)("Error processing voice message")):this.state.playback?r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement(h.a,{playback:this.state.playback,tileShape:this.props.tileShape}),this.props.tileShape&&r.a.createElement(m.a,a()({},this.props,{showGenericPlaceholder:!1})),this.props.scBubbleGroupTimestamp):r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement(l.a,null))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(82),a=s.n(i),o=s(506),r=s(507),c=s(85),l=s(134),d=s(751),h=s(509);let u=Object(c.a)("views.audio_messages.RecordingPlayback")(n=class extends h.a{get isWaveformable(){return this.props.tileShape!==l.a.Notif&&this.props.tileShape!==l.a.FileGrid&&this.props.tileShape!==l.a.Pinned}renderComponent(){const e=this.isWaveformable?"":"mx_VoiceMessagePrimaryContainer_noWaveform";return a.a.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer "+e},a.a.createElement(o.a,{playback:this.props.playback,playbackPhase:this.state.playbackPhase}),a.a.createElement(r.a,{playback:this.props.playback}),this.isWaveformable&&a.a.createElement(d.a,{playback:this.props.playback}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(85),u=s(111),m=s(84),p=s(203),g=s(91),v=s.n(g);const f=["playback","playbackPhase"];var b;let y=Object(h.a)("views.audio_messages.PlayPauseButton")(b=class extends d.a.PureComponent{constructor(e){super(e),c()(this,"onClick",()=>{this.toggleState()})}async toggleState(){await this.props.playback.toggle()}render(){const e=this.props,{playback:t,playbackPhase:s}=e,n=o()(e,f),a=t.isPlaying,r=s===p.d.Decoding,c=v()("mx_PlayPauseButton",{mx_PlayPauseButton_play:!a,mx_PlayPauseButton_pause:a,mx_PlayPauseButton_disabled:r});return d.a.createElement(u.a,i()({className:c,title:a?Object(m.a)("Pause"):Object(m.a)("Play"),onClick:this.onClick,disabled:r},n))}})||b},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(316),d=s(203),h=s(123);let u=Object(c.a)("views.audio_messages.PlaybackClock")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onPlaybackUpdate",e=>{e===d.d.Decoding&&(e=d.d.Stopped),this.setState({playbackPhase:e})}),a()(this,"onTimeUpdate",e=>{this.setState({seconds:e[0],durationSeconds:e[1]})}),this.state={seconds:this.props.playback.clockInfo.timeSeconds,durationSeconds:this.props.playback.clockInfo.durationSeconds,playbackPhase:d.d.Stopped},this.props.playback.on(h.b,this.onPlaybackUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){let e=this.state.seconds;return this.state.playbackPhase===d.d.Stopped&&(e=Number.isFinite(this.props.defaultDisplaySeconds)?this.props.defaultDisplaySeconds:this.state.durationSeconds),r.a.createElement(l.a,{seconds:e})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(85),h=s(91),u=s.n(h);let m=Object(d.a)("views.audio_messages.Waveform")((a=i=class extends l.a.PureComponent{render(){return l.a.createElement("div",{className:"mx_Waveform"},this.props.relHeights.map((e,t)=>{const s=this.props.progress,n=t/this.props.relHeights.length<=s&&s>0,i=u()({mx_Waveform_bar:!0,mx_Waveform_bar_100pct:n});return l.a.createElement("span",{key:t,style:{"--barHeight":e},className:i})}))}},r()(i,"defaultProps",{progress:1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(203),r=s(82),c=s.n(r),l=s(123),d=s(85),h=s(84),u=s(1);let m=Object(d.a)("views.audio_messages.AudioPlayerBase")(n=class extends c.a.PureComponent{constructor(e){super(e),a()(this,"onPlaybackUpdate",e=>{this.setState({playbackPhase:e})}),this.state={playbackPhase:o.d.Decoding},this.props.playback.on(l.b,this.onPlaybackUpdate),this.props.playback.prepare().catch(e=>{u.a.error("Error processing audio file:",e),this.setState({error:!0})})}render(){return c.a.createElement(c.a.Fragment,null,this.renderComponent(),this.state.error&&c.a.createElement("div",{className:"text-warning"},Object(h.a)("Error downloading audio")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(150);let d=Object(c.a)("views.elements.TooltipButton")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onMouseOver",()=>{this.setState({hover:!0})}),a()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=this.state.hover?r.a.createElement(l.b,{className:"mx_TooltipButton_container",tooltipClassName:"mx_TooltipButton_helpText",label:this.props.helpText}):r.a.createElement("div",null);return r.a.createElement("div",{className:"mx_TooltipButton",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},"?",e)}})||n},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(155),d=s(108);const h=["children"];t.a=e=>{let{children:t}=e,s=o()(e,h);return c.a.createElement(l.c,{handleHomeEnd:!0,onKeyDown:e=>{const t=e.target;if("INPUT"===t.tagName)return;let s=!0;switch(e.key){case d.a.ARROW_UP:case d.a.ARROW_DOWN:t.hasAttribute("aria-haspopup")&&t.click();break;default:s=!1}s&&(e.preventDefault(),e.stopPropagation())}},({onKeyDownHandler:e})=>c.a.createElement("div",i()({},s,{onKeyDown:e,role:"toolbar"}),t))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(111),d=s(155);const h=["inputRef"],u=e=>{let{inputRef:t}=e,s=o()(e,h);const[n,a,r]=Object(d.f)(t);return c.a.createElement(l.a,i()({},s,{onFocus:n,inputRef:r,tabIndex:a?0:-1}))}},function(e,t,s){"use strict";var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(418),l=s(86),d=s(87),h=s(85),u=s(92);let m=Object(h.a)("views.emojipicker.ReactionPicker")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onReactionsChange",()=>{this.setState({selectedEmojis:new Set(Object.keys(this.getReactions()))})}),a()(this,"onChoose",e=>{this.componentWillUnmount(),this.props.onFinished();const t=this.getReactions();return t.hasOwnProperty(e)?(l.a.get().redactEvent(this.props.mxEvent.getRoomId(),t[e]),d.a.fire(u.a.FocusAComposer),!1):(l.a.get().sendEvent(this.props.mxEvent.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:this.props.mxEvent.getId(),key:e}}),d.a.dispatch({action:"message_sent"}),d.a.fire(u.a.FocusAComposer),!0)}),this.state={selectedEmojis:new Set(Object.keys(this.getReactions()))},this.addListeners()}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.addListeners(),this.onReactionsChange())}addListeners(){this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange))}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener("Relations.add",this.onReactionsChange),this.props.reactions.removeListener("Relations.remove",this.onReactionsChange),this.props.reactions.removeListener("Relations.redaction",this.onReactionsChange))}getReactions(){if(!this.props.reactions)return{};const e=l.a.get().getUserId(),t=this.props.reactions.getAnnotationsBySender()[e]||[];return Object.fromEntries([...t].filter(e=>!e.isRedacted()).map(e=>[e.getRelation().key,e.getId()]))}render(){return r.a.createElement(c.d,{allowUnlisted:!0,onChoose:this.onChoose,selectedEmojis:this.state.selectedEmojis,showQuickReactions:!0})}})||n;t.a=m},function(e,t,s){"use strict";var n,i=s(82),a=s.n(i),o=s(105),r=s(85);let c=Object(r.a)("views.emojipicker.Emoji")(n=class extends a.a.PureComponent{render(){const{onClick:e,onMouseEnter:t,onMouseLeave:s,emoji:n,selectedEmojis:i}=this.props,r=i&&i.has(n.unicode);return a.a.createElement(o.e,{element:"li",onClick:()=>e(n),onMouseEnter:()=>t(n),onMouseLeave:()=>s(n),className:"mx_EmojiPicker_item_wrapper",label:n.unicode},a.a.createElement("div",{className:"mx_EmojiPicker_item "+(r?"mx_EmojiPicker_item_selected":"")},n.unicode))}})||n;t.a=c},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return o}));var n=s(86),i=s(84);function a(e,t){const s=n.a.get().getRoom(t),i=s&&s.getMember(e);return i?i.name:e}function o(e,t){const s=a(e,t);return s!==e?Object(i.a)("%(name)s (%(userId)s)",{name:s,userId:e}):e}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(82),o=s.n(a),r=s(87),c=s(92),l=s(143),d=s(105),h=s(84),u=s(168),m=s(154),p=s(86);t.a=({mxEvent:e,permalinkCreator:t,onMenuToggle:s})=>{const[n,g]=Object(a.useState)(null),v=Object(a.useCallback)(()=>{g(null)},[]),f=Object(a.useCallback)(t=>{t.preventDefault(),t.stopPropagation(),r.a.dispatch({action:c.a.ViewRoom,event_id:e.getId(),highlighted:!0,room_id:e.getRoomId()}),v()},[e,v]),b=Object(a.useCallback)(async s=>{s.preventDefault(),s.stopPropagation();const n=t.forEvent(e.getId());await Object(l.c)(n),v()},[e,v,t]),y=Object(a.useCallback)(e=>{if(n)v();else{const t=e.currentTarget.getBoundingClientRect();g(t)}},[v,n]);Object(a.useEffect)(()=>{s&&s(!!n)},[n,s]);const E=!m.d.instance.hasMaximisedWidget(p.a.get().getRoom(e.getRoomId()));return o.a.createElement(o.a.Fragment,null,o.a.createElement(d.c,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",onClick:y,title:Object(h.a)("Thread options"),isExpanded:!!n}),!!n&&o.a.createElement(u.e,i()({onFinished:v,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(S=n).left+window.pageXOffset+S.width,top:S.bottom+window.pageYOffset,chevronFace:d.a.None}),o.a.createElement(u.c,null,E&&o.a.createElement(u.b,{onClick:e=>f(e),label:Object(h.a)("View in room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),o.a.createElement(u.b,{onClick:e=>b(e),label:Object(h.a)("Copy link to thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var S}},function(e,t,s){"use strict";s.d(t,"a",(function(){return G})),s.d(t,"b",(function(){return J}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(94),h=s(84),u=s(155),m=s(165),p=s(132),g=s(147),v=s(87),f=s(518),b=s(86),y=s(320),E=s(779),S=s(264),_=s(92),w=s(173),C=s(780),O=s(116),k=s(144),R=s(168),I=s(88),x=s(193),T=s(106),j=s(185),N=s(186),P=s(85),D=s(126),M=s(89),A=s(91),U=s.n(A),L=s(381),F=s(111),B=s(221),V=s(115),K=s(127),W=s(98);const G=[g.a.Invite,g.a.Favourite,g.a.Unified,g.a.DM,g.a.Untagged,g.a.LowPriority,g.a.ServerNotice,g.a.Suggested,g.a.Archived],H=g.a.LowPriority,q=[g.a.DM,g.a.Untagged],$=[g.a.Unified],z={[g.a.Invite]:{sectionLabel:Object(h.b)("Invites"),isInvite:!0,defaultHidden:!1},[g.a.Favourite]:{sectionLabel:Object(h.b)("Favourites"),isInvite:!1,defaultHidden:!1},[g.a.Unified]:{sectionLabel:Object(h.b)("Normal priority"),isInvite:!1,defaultHidden:!1,addDirectRoomLabel:Object(h.b)("Start chat"),addGroupRoomLabel:Object(h.b)("Create new room"),onAddDirectRoom:e=>{(e||v.a).dispatch({action:"view_create_chat"})},onAddGroupRoom:e=>{(e||v.a).dispatch({action:"view_create_room"})}},[g.a.DM]:{sectionLabel:Object(h.b)("People"),isInvite:!1,defaultHidden:!1,addRoomLabel:Object(h.b)("Start chat"),onAddRoom:e=>{(e||v.a).dispatch({action:"view_create_chat"})}},[g.a.Untagged]:{sectionLabel:Object(h.b)("Rooms"),isInvite:!1,defaultHidden:!1,addRoomLabel:Object(h.b)("Add room"),addRoomContextMenu:e=>{if(T.a.instance.activeSpaceRoom){const t=b.a.get().getUserId(),s=T.a.instance.activeSpaceRoom,n=s.currentState.maySendStateEvent(d.a.SpaceChild,t);return l.a.createElement(R.c,{first:!0},Object(B.a)(V.a.CreateRooms)?l.a.createElement(l.a.Fragment,null,l.a.createElement(R.b,{label:Object(h.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),Object(N.g)(s)},disabled:!n,tooltip:n?void 0:Object(h.a)("You do not have permissions to create new rooms in this space")}),l.a.createElement(R.b,{label:Object(h.a)("Add existing room"),iconClassName:"mx_RoomList_iconHash",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),Object(N.f)(s)},disabled:!n,tooltip:n?void 0:Object(h.a)("You do not have permissions to add rooms to this space")})):null,l.a.createElement(R.b,{label:Object(h.a)("Explore rooms"),iconClassName:"mx_RoomList_iconBrowse",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),v.a.fire(_.a.ViewRoomDirectory)}}))}return l.a.createElement(R.c,{first:!0},l.a.createElement(R.b,{label:Object(h.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),v.a.dispatch({action:"view_create_room"})}}),l.a.createElement(R.b,{label:x.a.instance.getSelectedCommunityId()?Object(h.a)("Explore community rooms"):Object(h.a)("Explore public rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),v.a.fire(_.a.ViewRoomDirectory)}}))}},[g.a.LowPriority]:{sectionLabel:Object(h.b)("Low priority"),isInvite:!1,defaultHidden:!1},[g.a.ServerNotice]:{sectionLabel:Object(h.b)("System Alerts"),isInvite:!1,defaultHidden:!1},[g.a.Archived]:{sectionLabel:Object(h.b)("Historical"),isInvite:!1,defaultHidden:!0},[g.a.Suggested]:{sectionLabel:Object(h.b)("Suggested Rooms"),isInvite:!1,defaultHidden:!1}};let J=Object(P.a)("views.rooms.RoomList")((a=i=class extends l.a.PureComponent{constructor(e){super(e),r()(this,"dispatcherRef",void 0),r()(this,"customTagStoreRef",void 0),r()(this,"roomStoreToken",void 0),r()(this,"unifiedRoomListWatcherRef",void 0),r()(this,"treeRef",Object(c.createRef)()),r()(this,"context",void 0),r()(this,"onUnifiedRoomListChange",()=>{this.setState({unifiedRoomList:M.b.getValue("unifiedRoomList")})}),r()(this,"onRoomViewStoreUpdate",()=>{this.setState({currentRoomId:p.a.getRoomId()})}),r()(this,"onAction",e=>{if(e.action===_.a.ViewRoomDelta){const t=e,s=p.a.getRoomId(),n=this.getRoomDelta(s,t.delta,t.unread);n&&v.a.dispatch({action:_.a.ViewRoom,room_id:n.roomId,show_room_tile:!0})}else e.action===_.a.PstnSupportUpdated&&this.updateLists()}),r()(this,"getRoomDelta",(e,t,s=!1)=>{const n=m.b.instance.orderedLists,i=[];G.forEach(t=>{let a=n[t];s&&(a=a.filter(t=>{const s=w.a.instance.getRoomState(t);return s.room.roomId===e||s.isUnread})),i.push(...a)});const a=i.findIndex(t=>t.roomId===e),[o]=i.slice((a+t)%i.length);return o}),r()(this,"updateSuggestedRooms",e=>{this.setState({suggestedRooms:e})}),r()(this,"updateLists",()=>{const e=m.b.instance.orderedLists,t=Object.keys(this.state.sublists),s=Object.keys(e).filter(e=>!Object(g.d)(e)||C.a.getTags()[e]),n=!!m.b.instance.getFirstNameFilterCondition();let i=this.state.isNameFiltering!==n||Object(O.d)(t,s);if(!i)for(const t of s){const s=this.state.sublists[t],n=e[t];if(s.length!==n.length){i=!0;break}}if(i){const t=Object(k.g)(e,s),i=Object(k.f)(t,(e,t)=>Object(O.b)(t));this.setState({sublists:i,isNameFiltering:n},()=>{this.props.onResize()})}}),r()(this,"onStartChat",()=>{var e;const t=null===(e=m.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;v.a.dispatch({action:"view_create_chat",initialText:t})}),r()(this,"onExplore",()=>{var e;const t=null===(e=m.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;v.a.dispatch({action:_.a.ViewRoomDirectory,initialText:t})}),r()(this,"onSpaceInviteClick",()=>{var e;const t=null===(e=m.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;Object(N.i)(this.context.getRoom(this.props.activeSpace),t)}),this.state={sublists:{},isNameFiltering:!!m.b.instance.getFirstNameFilterCondition(),suggestedRooms:T.a.instance.suggestedRooms,unifiedRoomList:M.b.getValue("unifiedRoomList")},this.unifiedRoomListWatcherRef=M.b.watchSetting("unifiedRoomList",null,this.onUnifiedRoomListChange)}componentDidMount(){this.dispatcherRef=v.a.register(this.onAction),this.roomStoreToken=p.a.addListener(this.onRoomViewStoreUpdate),T.a.instance.on(j.e,this.updateSuggestedRooms),m.b.instance.on(m.a,this.updateLists),this.customTagStoreRef=C.a.addListener(this.updateLists),this.updateLists()}componentWillUnmount(){T.a.instance.off(j.e,this.updateSuggestedRooms),m.b.instance.off(m.a,this.updateLists),v.a.unregister(this.dispatcherRef),this.customTagStoreRef&&this.customTagStoreRef.remove(),this.roomStoreToken&&this.roomStoreToken.remove(),M.b.unwatchSetting(this.unifiedRoomListWatcherRef)}renderSuggestedRooms(){return this.state.suggestedRooms.map(e=>{var t;const s=e.name||e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0])||Object(h.a)("Empty room"),n=l.a.createElement(D.a,{oobData:{name:s,avatarUrl:e.avatar_url},width:32,height:32,resizeMethod:"crop"});return l.a.createElement(E.a,{isMinimized:this.props.isMinimized,isSelected:this.state.currentRoomId===e.room_id,displayName:s,avatar:n,onClick:()=>{var t;v.a.dispatch({action:"view_room",room_alias:e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0]),room_id:e.room_id,via_servers:e.viaServers,oobData:{avatarUrl:e.avatar_url,name:s}})},key:"suggestedRoomTile_"+e.room_id})})}renderCommunityInvites(){return T.a.spacesEnabled?[]:b.a.get().getGroups().filter(e=>"invite"===e.myMembership).map(e=>{const t=l.a.createElement(y.a,{groupId:e.groupId,groupName:e.name,groupAvatarUrl:e.avatarUrl,width:32,height:32,resizeMethod:"crop"});return l.a.createElement(E.a,{isMinimized:this.props.isMinimized,isSelected:!1,displayName:e.name,avatar:t,notificationState:S.a.RED_EXCLAMATION,onClick:()=>{v.a.dispatch({action:"view_group",group_id:e.groupId})},key:"temporaryGroupTile_"+e.groupId})})}renderSublists(){var e;const t=!this.state.isNameFiltering&&!(null!==(e=this.state.suggestedRooms)&&void 0!==e&&e.length)&&Object.values(m.b.instance.unfilteredLists).every(e=>!(null!=e&&e.length));return G.reduce((e,t)=>{if(t===H){const t=Object.keys(this.state.sublists).filter(e=>Object(g.d)(e));e.push(...t)}return e.push(t),e},[]).map(e=>{let s=null;e===g.a.Invite?s=this.renderCommunityInvites():e===g.a.Suggested&&(s=this.renderSuggestedRooms());const n=Object(g.d)(e)?((i=e).startsWith("u.")&&(i=i.substring(2)),{sectionLabel:Object(h.b)("Custom Tag"),sectionLabelRaw:i,isInvite:!1,defaultHidden:!1}):z[e];var i;if(!n)throw new Error(`Tag ${e} does not have aesthetics`);let a=(this.state.unifiedRoomList?$:q).includes(e);return(this.props.activeSpace===j.a.Favourites&&e!==g.a.Favourite||this.props.activeSpace===j.a.People&&e!==g.a.DM||this.props.activeSpace===j.a.Orphans&&e===g.a.DM)&&(a=!1),l.a.createElement(f.b,{key:"sublist-"+e,tagId:e,forRooms:!0,startAsHidden:n.defaultHidden,label:n.sectionLabelRaw?n.sectionLabelRaw:Object(h.a)(n.sectionLabel),onAddRoom:n.onAddRoom,onAddGroupRoom:n.onAddGroupRoom,onAddDirectRoom:n.onAddDirectRoom,addRoomLabel:n.addRoomLabel?Object(h.a)(n.addRoomLabel):n.addRoomLabel,addGroupRoomLabel:n.addGroupRoomLabel?Object(h.a)(n.addGroupRoomLabel):n.addGroupRoomLabel,addDirectRoomLabel:n.addDirectRoomLabel?Object(h.a)(n.addDirectRoomLabel):n.addDirectRoomLabel,addRoomContextMenu:n.addRoomContextMenu,isMinimized:this.props.isMinimized,showSkeleton:t,extraTiles:s,resizeNotifier:this.props.resizeNotifier,alwaysVisible:a,onListCollapse:this.props.onListCollapse})})}focus(){var e,t;null===(e=[...null===(t=this.treeRef.current)||void 0===t?void 0:t.querySelectorAll('[role="treeitem"]')].find(e=>null!==e.offsetParent))||void 0===e||e.focus()}render(){const e=b.a.get(),t=e.getUserId(),s="!"===this.props.activeSpace[0]?e.getRoom(this.props.activeSpace):null;let n;if(!this.props.isMinimized)if(this.state.isNameFiltering)n=l.a.createElement("div",{className:"mx_RoomList_explorePrompt"},l.a.createElement("div",null,Object(h.a)("Can't see what you're looking for?")),l.a.createElement(I.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(h.a)("Start a new chat")),l.a.createElement(I.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},s?Object(h.a)("Explore rooms"):Object(h.a)("Explore all public rooms")));else if(null!=s&&s.canInvite(t)||"join"===(null==s?void 0:s.getMyMembership())||(null==s?void 0:s.getJoinRule())===K.c.Public){const e=s.name,i=(null==s?void 0:s.canInvite(t))||(null==s?void 0:s.getJoinRule())===K.c.Public;n=l.a.createElement("div",{className:"mx_RoomList_explorePrompt"},l.a.createElement("div",null,Object(h.a)("Quick actions")),i&&l.a.createElement(F.a,{className:"mx_RoomList_explorePrompt_spaceInvite",onClick:this.onSpaceInviteClick,title:Object(h.a)("Invite to %(spaceName)s",{spaceName:e})},Object(h.a)("Invite people")),"join"===(null==s?void 0:s.getMyMembership())&&l.a.createElement(F.a,{className:"mx_RoomList_explorePrompt_spaceExplore",onClick:this.onExplore,title:Object(h.a)("Explore %(spaceName)s",{spaceName:e})},Object(h.a)("Explore rooms")))}else if(Object.values(this.state.sublists).some(e=>e.length>0)){const e=m.b.instance.unfilteredLists,t=e[g.a.Untagged]||[],s=e[g.a.Archived]||[],i=e[g.a.Favourite]||[];t.length<1&&s.length<1&&i.length<1&&(n=l.a.createElement("div",{className:"mx_RoomList_explorePrompt"},l.a.createElement("div",null,Object(h.a)("Use the + to make a new room or explore existing ones below")),l.a.createElement(I.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(h.a)("Start a new chat")),l.a.createElement(I.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},Object(h.a)("Explore all public rooms"))))}const i=M.b.getValue("roomListStyle"),a=U()({mx_RoomList:!0,mx_RoomList_Compact:i===L.a.Compact,mx_RoomList_Intermediate:i===L.a.Intermediate,mx_RoomList_Roomy:i===L.a.Roomy}),o=this.renderSublists();return l.a.createElement(u.c,{handleHomeEnd:!0,handleUpDown:!0,onKeyDown:this.props.onKeyDown},({onKeyDownHandler:e})=>l.a.createElement("div",{onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:e,className:a,role:"tree","aria-label":Object(h.a)("Rooms"),ref:this.treeRef},o,n))}},r()(i,"contextType",W.a),n=a))||n},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return M})),s.d(t,"b",(function(){return A}));var n,i=s(83),a=s.n(i),o=s(82),r=s(4),c=s(91),l=s.n(c),d=s(155),h=s(84),u=s(88),m=s(519),p=s(105),g=s(165),v=s(257),f=s(147),b=s(87),y=s(92),E=s(192),S=s(111),_=s(108),w=s(319),C=s(1522),O=s(173),k=s(1046),R=s(116),I=s(144),x=s(168),T=s(195),j=s(85),N=s(89),P=s(221),D=s(115);const M=32;Object(C.a)();let A=Object(j.a)("views.rooms.RoomSublist")(n=class t extends o.Component{constructor(t){super(t),a()(this,"headerButton",Object(o.createRef)()),a()(this,"sublistRef",Object(o.createRef)()),a()(this,"tilesRef",Object(o.createRef)()),a()(this,"dispatcherRef",void 0),a()(this,"layout",void 0),a()(this,"heightAtStart",void 0),a()(this,"isBeingFiltered",void 0),a()(this,"notificationState",void 0),a()(this,"settingWatchers",void 0),a()(this,"onListsUpdated",()=>{const e={};if(this.props.extraTiles){const t=g.b.instance.getFirstNameFilterCondition();t?e.filteredExtraTiles=this.props.extraTiles.filter(e=>t.matches(Object(r.z)(e.props.displayName||""))):this.state.filteredExtraTiles&&(e.filteredExtraTiles=null)}const t=this.state.rooms,s=Object(R.b)(g.b.instance.orderedLists[this.props.tagId]||[]);Object(R.e)(t,s)&&(e.rooms=s);const n=!!g.b.instance.getFirstNameFilterCondition();n!==this.isBeingFiltered&&(this.isBeingFiltered=n,e.isExpanded=!!n||!this.layout.isCollapsed),Object.keys(e).length>0&&this.setState(e)}),a()(this,"onAction",t=>{"view_room"===t.action&&t.show_room_tile&&this.state.rooms&&e(()=>{const e=this.state.rooms.findIndex(e=>e.roomId===t.room_id);!this.state.isExpanded&&e>-1&&this.toggleCollapsed(),e>=this.numVisibleTiles&&(this.layout.visibleTiles=this.layout.tilesWithPadding(e+1,32),this.forceUpdate())})}),a()(this,"onAddRoom",e=>{e.stopPropagation(),this.props.onAddRoom&&this.props.onAddRoom()}),a()(this,"onAddGroupRoom",e=>{e.stopPropagation(),this.props.onAddGroupRoom&&this.props.onAddGroupRoom()}),a()(this,"onAddDirectRoom",e=>{e.stopPropagation(),this.props.onAddDirectRoom&&this.props.onAddDirectRoom()}),a()(this,"onResize",(e,t,s,n)=>{const i=this.heightAtStart+n.height;this.applyHeightChange(i),this.setState({height:i})}),a()(this,"onResizeStart",()=>{this.heightAtStart=this.state.height,this.setState({isResizing:!0})}),a()(this,"onResizeStop",(e,t,s,n)=>{const i=this.heightAtStart+n.height;this.applyHeightChange(i),this.setState({isResizing:!1,height:i})}),a()(this,"onShowAllClick",()=>{const e=this.numVisibleTiles,t=this.layout.tilesToPixelsWithPadding(this.numTiles,this.padding);this.applyHeightChange(t),this.setState({height:t},()=>{this.focusRoomTile(e)})}),a()(this,"onShowLessClick",()=>{const e=this.layout.tilesToPixelsWithPadding(this.layout.defaultVisibleTiles,this.padding);this.applyHeightChange(e),this.setState({height:e})}),a()(this,"focusRoomTile",e=>{if(!this.sublistRef.current)return;const t=this.sublistRef.current.querySelectorAll(".mx_RoomTile"),s=t&&t[e];s&&s.focus()}),a()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),a()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,height:0}})}),a()(this,"onAddRoomContextMenu",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({addRoomContextMenuPosition:t.getBoundingClientRect()})}),a()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),a()(this,"onCloseAddRoomMenu",()=>{this.setState({addRoomContextMenuPosition:null})}),a()(this,"onUnreadFirstChanged",()=>{const e=g.b.instance.getListOrder(this.props.tagId)===v.a.Importance?v.a.Natural:v.a.Importance;g.b.instance.setListOrder(this.props.tagId,e),this.forceUpdate()}),a()(this,"onTagSortChanged",async e=>{await g.b.instance.setTagSorting(this.props.tagId,e)}),a()(this,"onMessagePreviewChanged",()=>{this.layout.showPreviews=!this.layout.showPreviews,this.forceUpdate()}),a()(this,"onBadgeClick",e=>{let t;e.preventDefault(),e.stopPropagation(),t=this.props.tagId===f.a.Invite?this.state.rooms&&this.state.rooms[0]:g.b.instance.unfilteredLists[this.props.tagId].find(e=>{const t=this.notificationState.getForRoom(e);return t.count>0&&t.color===this.notificationState.color}),t&&b.a.dispatch({action:y.a.ViewRoom,room_id:t.roomId,show_room_tile:!0})}),a()(this,"onHeaderClick",()=>{const t=this.headerButton.current.parentElement,s=t.parentElement.parentElement,n=s.parentElement.parentElement,i=Math.round(n.scrollTop),a=i<=Math.round(M),o=i>=Math.round(n.scrollHeight-n.offsetHeight),r=t.classList.contains("mx_RoomSublist_headerContainer_stickyTop"),c=t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom");if(c&&!o||r&&!a)s.scrollIntoView({behavior:"smooth"});else{const t=this.state.isExpanded;this.toggleCollapsed(),!t&&c&&e(()=>{s.scrollIntoView({behavior:"smooth"})})}}),a()(this,"toggleCollapsed",()=>{this.layout.isCollapsed=this.state.isExpanded,this.setState({isExpanded:!this.layout.isCollapsed}),this.props.onListCollapse&&this.props.onListCollapse(!this.layout.isCollapsed)}),a()(this,"onHeaderKeyDown",e=>{switch(Object(T.f)().getRoomListAction(e)){case T.e.CollapseSection:e.stopPropagation(),this.state.isExpanded&&this.toggleCollapsed();break;case T.e.ExpandSection:if(e.stopPropagation(),this.state.isExpanded){if(this.sublistRef.current){const e=this.sublistRef.current.querySelector(".mx_RoomTile");e&&e.focus()}}else this.toggleCollapsed()}}),a()(this,"onKeyDown",e=>{switch(e.key){case _.a.ARROW_LEFT:e.stopPropagation(),this.headerButton.current.focus();break;case _.a.ARROW_RIGHT:e.stopPropagation()}}),this.layout=k.a.instance.getLayoutFor(this.props.tagId),this.heightAtStart=0,this.isBeingFiltered=!!g.b.instance.getFirstNameFilterCondition(),this.notificationState=O.a.instance.getListState(this.props.tagId),this.state={contextMenuPosition:null,addRoomContextMenuPosition:null,isResizing:!1,isExpanded:this.isBeingFiltered?this.isBeingFiltered:!this.layout.isCollapsed,height:0,rooms:Object(R.b)(g.b.instance.orderedLists[this.props.tagId]||[]),baseFontSize:N.b.getValue("baseFontSize")},this.state=Object.assign(this.state,{height:this.calculateInitialHeight()}),this.settingWatchers=[N.b.watchSetting("baseFontSize",null,(...[,,,e])=>this.setState({baseFontSize:e}))]}calculateInitialHeight(){const e=Math.max(Math.floor(this.layout.visibleTiles),this.layout.minVisibleTiles),t=Math.min(this.numTiles,e);return this.layout.tilesToPixelsWithPadding(t,this.padding)}get padding(){let e=4;const t=this.numTiles>this.numVisibleTiles,s=this.numTiles>this.layout.defaultVisibleTiles;return(t||s)&&(e+=28),e}get extraTiles(){return this.state.filteredExtraTiles?this.state.filteredExtraTiles:this.props.extraTiles?this.props.extraTiles:null}get numTiles(){return t.calcNumTiles(this.state.rooms,this.extraTiles)}static calcNumTiles(e,t){return(e||[]).length+(t||[]).length}get numVisibleTiles(){const e=Math.ceil(this.layout.visibleTiles);return Math.min(e,this.numTiles)}componentDidUpdate(e,s){const n=s.filteredExtraTiles||e.extraTiles;t.calcNumTiles(s.rooms,n)!==this.numTiles&&this.setState({height:this.calculateInitialHeight()})}shouldComponentUpdate(e,s){if(Object(I.d)(this.props,e))return!0;const n=Object(I.c)(this.state,["rooms"]),i=Object(I.c)(s,["rooms"]);if(Object(I.d)(n,i))return!0;const a=this.props.extraTiles||[],o=s.filteredExtraTiles||e.extraTiles||[];if(a.length>0||o.length>0)return!0;if(t.calcNumTiles(s.rooms,o)!==this.numTiles)return!0;if(!s.isExpanded)return!1;if(this.state.rooms.length!==s.rooms.length)return!0;const r=this.state.rooms.slice(0,this.numVisibleTiles),c=s.rooms.slice(0,this.numVisibleTiles);return!!Object(R.e)(r,c)}componentDidMount(){var e;this.dispatcherRef=b.a.register(this.onAction),g.b.instance.on(g.a,this.onListsUpdated),null===(e=this.tilesRef.current)||void 0===e||e.addEventListener("scroll",this.onScrollPrevent,{passive:!0})}componentWillUnmount(){var e;b.a.unregister(this.dispatcherRef),g.b.instance.off(g.a,this.onListsUpdated),null===(e=this.tilesRef.current)||void 0===e||e.removeEventListener("scroll",this.onScrollPrevent);for(const e of this.settingWatchers)N.b.unwatchSetting(e)}applyHeightChange(e){const t=Math.ceil(this.layout.pixelsToTiles(e-this.padding));this.layout.visibleTiles=Math.min(this.numTiles,t)}renderVisibleTiles(){if(!this.state.isExpanded)return[];const e=[];if(this.state.rooms){const t=this.state.rooms.slice(0,this.numVisibleTiles);for(const s of t)e.push(o.createElement(m.b,{room:s,key:"room-"+s.roomId,showMessagePreview:this.layout.showPreviews,isMinimized:this.props.isMinimized,tag:this.props.tagId}))}return this.extraTiles&&e.push(...this.extraTiles),e.length>this.numVisibleTiles?e.slice(0,this.numVisibleTiles):e}renderMenu(){let e=null;if(this.state.contextMenuPosition){const t=g.b.instance.getTagSorting(this.props.tagId)===v.b.Alphabetic,s=g.b.instance.getListOrder(this.props.tagId)===v.a.Importance;let n=null;this.props.tagId!==f.a.Invite&&(n=o.createElement(o.Fragment,null,o.createElement("hr",null),o.createElement("div",null,o.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(h.a)("Appearance")),o.createElement(p.h,{onClose:this.onCloseMenu,onChange:this.onUnreadFirstChanged,checked:s},Object(h.a)("Show rooms with unread messages first")),o.createElement(p.h,{onClose:this.onCloseMenu,onChange:this.onMessagePreviewChanged,checked:this.layout.showPreviews},Object(h.a)("Show previews of messages"))))),e=o.createElement(p.n,{chevronFace:p.a.None,left:this.state.contextMenuPosition.left,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height,onFinished:this.onCloseMenu},o.createElement("div",{className:"mx_RoomSublist_contextMenu"},o.createElement("div",null,o.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(h.a)("Sort by")),o.createElement(p.i,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(v.b.Recent),checked:!t,name:`mx_${this.props.tagId}_sortBy`},Object(h.a)("Activity")),o.createElement(p.i,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(v.b.Alphabetic),checked:t,name:`mx_${this.props.tagId}_sortBy`},Object(h.a)("A-Z"))),n))}else this.state.addRoomContextMenuPosition&&(e=o.createElement(x.e,{chevronFace:p.a.None,left:this.state.addRoomContextMenuPosition.left-7,top:this.state.addRoomContextMenuPosition.top+this.state.addRoomContextMenuPosition.height,onFinished:this.onCloseAddRoomMenu,compact:!0},this.props.addRoomContextMenu(this.onCloseAddRoomMenu)));return o.createElement(o.Fragment,null,o.createElement(p.c,{className:"mx_RoomSublist_menuButton",onClick:this.onOpenMenuClick,title:Object(h.a)("List options"),isExpanded:!!this.state.contextMenuPosition}),e)}renderHeader(){return o.createElement(d.d,{inputRef:this.headerButton},({onFocus:e,isActive:t,ref:s})=>{const n=t?0:-1;let i=Object(h.a)("Jump to first unread room.");this.props.tagId===f.a.Invite&&(i=Object(h.a)("Jump to first invite."));const a=o.createElement(E.a,{forceCount:!0,notification:this.notificationState,onClick:this.onBadgeClick,tabIndex:n,"aria-label":i,showUnsentTooltip:!0});let r=null;this.props.onAddRoom&&Object(P.a)(D.a.CreateRooms)?r=o.createElement(S.a,{tabIndex:n,onClick:this.onAddRoom,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(h.a)("Add room"),title:this.props.addRoomLabel}):this.props.addRoomContextMenu&&(r=o.createElement(p.c,{tabIndex:n,onClick:this.onAddRoomContextMenu,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(h.a)("Add room"),title:this.props.addRoomLabel,isExpanded:!!this.state.addRoomContextMenuPosition}));let c=null;this.props.onAddGroupRoom&&(c=o.createElement(S.a,{tabIndex:n,onClick:this.onAddGroupRoom,className:"mx_RoomSublist_auxGroupButton","aria-label":this.props.addGroupRoomLabel||Object(h.a)("Add room"),title:this.props.addGroupRoomLabel,tooltipClassName:"mx_RoomSublist_addRoomTooltip"}));let d=null;this.props.onAddDirectRoom&&(d=o.createElement(S.a,{tabIndex:n,onClick:this.onAddDirectRoom,className:"mx_RoomSublist_auxDmButton","aria-label":this.props.addDirectRoomLabel||Object(h.a)("Add room"),title:this.props.addDirectRoomLabel,tooltipClassName:"mx_RoomSublist_addRoomTooltip"}));const m=l()({mx_RoomSublist_collapseBtn:!0,mx_RoomSublist_collapseBtn_collapsed:!this.state.isExpanded}),g=l()({mx_RoomSublist_headerContainer:!0,mx_RoomSublist_headerContainer_withAux:!!r||!!c||!!d}),v=o.createElement("div",{className:"mx_RoomSublist_badgeContainer"},a);let b=u.a;return this.props.isMinimized&&(b=S.a),o.createElement("div",{className:g,onKeyDown:this.onHeaderKeyDown,onFocus:e,"aria-label":this.props.label},o.createElement("div",{className:"mx_RoomSublist_stickable"},o.createElement(b,{onFocus:e,inputRef:s,tabIndex:n,className:"mx_RoomSublist_headerText",role:"treeitem","aria-expanded":this.state.isExpanded,"aria-level":1,onClick:this.onHeaderClick,onContextMenu:this.onContextMenu,title:this.props.isMinimized?this.props.label:void 0},o.createElement("span",{className:m}),o.createElement("span",null,this.props.label)),this.renderMenu(),this.props.isMinimized?null:v,this.props.isMinimized?null:r,this.props.isMinimized?null:d,this.props.isMinimized?null:c),this.props.isMinimized?v:null,this.props.isMinimized?r:null,this.props.isMinimized?d:null,this.props.isMinimized?c:null)})}onScrollPrevent(e){e.target.scrollTop=0}render(){var e;const t=this.renderVisibleTiles(),s=l()({mx_RoomSublist:!0,mx_RoomSublist_hasMenuOpen:!!this.state.contextMenuPosition,mx_RoomSublist_minimized:this.props.isMinimized,mx_RoomSublist_hidden:!(this.state.rooms.length||null!==(e=this.props.extraTiles)&&void 0!==e&&e.length||!0===this.props.alwaysVisible)});let n=null;if(t.length>0){const e=this.layout,s=Math.min(e.minVisibleTiles,this.numTiles),i=4+(s<this.numTiles?28:0),a=e.tilesToPixelsWithPadding(s,i),r=e.tilesToPixelsWithPadding(this.numTiles,this.padding),c=l()({mx_RoomSublist_showNButton:!0});let u=null;if(r>this.state.height){const e=this.state.height-4-28,t=Math.floor(e/this.layout.tileHeight),s=this.numTiles-t,n=Object(h.a)("Show %(count)s more",{count:s});let i=o.createElement("span",{className:"mx_RoomSublist_showNButtonText"},n);this.props.isMinimized&&(i=null),u=o.createElement(d.a,{role:"treeitem",onClick:this.onShowAllClick,className:c,"aria-label":n},o.createElement("span",{className:"mx_RoomSublist_showMoreButtonChevron mx_RoomSublist_showNButtonChevron"}),i)}else if(this.numTiles>this.layout.defaultVisibleTiles){const e=Object(h.a)("Show less");let t=o.createElement("span",{className:"mx_RoomSublist_showNButtonText"},e);this.props.isMinimized&&(t=null),u=o.createElement(d.a,{role:"treeitem",onClick:this.onShowLessClick,className:c,"aria-label":e},o.createElement("span",{className:"mx_RoomSublist_showLessButtonChevron mx_RoomSublist_showNButtonChevron"}),t)}const m={bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1};e.visibleTiles>=this.numTiles&&this.numTiles<=e.minVisibleTiles&&(m.bottom=!1);const p=l()({mx_RoomSublist_resizerHandles:!0,mx_RoomSublist_resizerHandles_showNButton:!!u});n=o.createElement(o.Fragment,null,o.createElement(w.Resizable,{size:{height:this.state.height/10*this.state.baseFontSize},minHeight:a/10*this.state.baseFontSize,maxHeight:r/10*this.state.baseFontSize,onResizeStart:this.onResizeStart,onResizeStop:this.onResizeStop,onResize:this.onResize,handleWrapperClass:p,handleClasses:{bottom:"mx_RoomSublist_resizerHandle"},className:"mx_RoomSublist_resizeBox",enable:m},o.createElement("div",{className:"mx_RoomSublist_tiles",ref:this.tilesRef},t),u))}else this.props.showSkeleton&&this.state.isExpanded&&(n=o.createElement("div",{className:"mx_RoomSublist_skeletonUI"}));return o.createElement("div",{ref:this.sublistRef,className:s,role:"group","aria-label":this.props.label,onKeyDown:this.onKeyDown},this.renderHeader(),n)}})||n}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return K})),s.d(t,"b",(function(){return W}));var n,i=s(95),a=s.n(i),o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(155),m=s(88),p=s(87),g=s(92),v=s(108),f=s(768),b=s(84),y=s(105),E=s(147),S=s(1027),_=s(284),w=s(258),C=s(86),O=s(192),k=s(165),R=s(769),I=s(173),x=s(213),T=s(111),j=s(520),N=s(771),P=s(772),D=s(168),M=s(193),A=s(85),U=s(1),L=s(180),F=s(89),B=s(106);const V=e=>"mx_RoomTile_messagePreview_"+e,K=e=>({left:e.left+window.pageXOffset-9,top:e.bottom+window.pageYOffset+17,chevronFace:y.a.None});let W=Object(A.a)("views.rooms.RoomTile")(n=class extends l.a.PureComponent{constructor(t){super(t),r()(this,"dispatcherRef",void 0),r()(this,"roomTileRef",Object(c.createRef)()),r()(this,"notificationState",void 0),r()(this,"roomProps",void 0),r()(this,"onRoomNameUpdate",e=>{this.forceUpdate()}),r()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),r()(this,"onRoomPropertyUpdate",e=>{e===N.a.NotificationVolume&&this.onNotificationUpdate()}),r()(this,"onAction",t=>{"view_room"===t.action&&t.room_id===this.props.room.roomId&&t.show_room_tile&&e(()=>{this.scrollIntoView()})}),r()(this,"onCommunityUpdate",e=>{e===this.props.room.roomId&&this.forceUpdate()}),r()(this,"onRoomPreviewChanged",e=>{this.props.room&&e.roomId===this.props.room.roomId&&this.generatePreview()}),r()(this,"scrollIntoView",()=>{this.roomTileRef.current&&this.roomTileRef.current.scrollIntoView({block:"nearest",behavior:"auto"})}),r()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:g.a.ViewRoom,show_room_tile:!0,room_id:this.props.room.roomId,clear_search:e&&(e.key===v.a.ENTER||e.key===v.a.SPACE)})}),r()(this,"onActiveRoomUpdate",e=>{this.setState({selected:e})}),r()(this,"onNotificationsMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({notificationsMenuPosition:t.getBoundingClientRect()})}),r()(this,"onCloseNotificationsMenu",()=>{this.setState({notificationsMenuPosition:null})}),r()(this,"onGeneralMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({generalMenuPosition:t.getBoundingClientRect()})}),r()(this,"onContextMenu",e=>{this.showContextMenu&&(e.preventDefault(),e.stopPropagation(),this.setState({generalMenuPosition:{left:e.clientX,bottom:e.clientY}}))}),r()(this,"onCloseGeneralMenu",()=>{this.setState({generalMenuPosition:null})}),r()(this,"onMarkUnreadClick",e=>{e.preventDefault(),e.stopPropagation(),this.state.selected&&("!"===B.a.instance.activeSpace[0]?p.a.dispatch({action:"view_room",room_id:B.a.instance.activeSpace}):p.a.dispatch({action:"view_home_page"})),Object(L.h)(this.props.room),this.setState({generalMenuPosition:null})}),r()(this,"onMarkReadClick",e=>{e.preventDefault(),e.stopPropagation();F.b.getValue("feature_mark_unread")&&Object(L.h)(this.props.room,!1);const t=this.props.room.getLiveTimeline().getEvents();t.length&&C.a.get().sendReadReceipt(t[t.length-1]),this.setState({generalMenuPosition:null})}),r()(this,"onTagRoom",(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===E.a.Favourite||t===E.a.LowPriority){const e=t===E.a.Favourite?E.a.LowPriority:E.a.Favourite,s=k.b.instance.getTagsForRoom(this.props.room).includes(t),n=s?t:e,i=s?null:t;p.a.dispatch(R.a.tagRoom(C.a.get(),this.props.room,n,i,void 0,0))}else U.a.warn(`Unexpected tag ${t} applied to ${this.props.room.roomId}`);e.key===v.a.ENTER&&this.setState({generalMenuPosition:null})}),r()(this,"onLeaveRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"leave_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onForgetRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"forget_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onOpenRoomSettings",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"open_room_settings",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onCopyRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"copy_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onInviteClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_invite",roomId:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onClickAllNotifs",e=>this.saveNotifState(e,w.a.AllMessages)),r()(this,"onClickAlertMe",e=>this.saveNotifState(e,w.a.AllMessagesLoud)),r()(this,"onClickMentions",e=>this.saveNotifState(e,w.a.MentionsOnly)),r()(this,"onClickMute",e=>this.saveNotifState(e,w.a.Mute)),this.state={selected:f.a.activeRoomId===this.props.room.roomId,notificationsMenuPosition:null,generalMenuPosition:null,messagePreview:""},this.generatePreview(),this.notificationState=I.a.instance.getRoomState(this.props.room),this.roomProps=j.a.forRoom(this.props.room)}get showContextMenu(){return this.props.tag!==E.a.Invite}get showMessagePreview(){return!this.props.isMinimized&&this.props.showMessagePreview}componentDidUpdate(e,t){var s,n;const i=e.showMessagePreview!==this.props.showMessagePreview,a=e.isMinimized!==this.props.isMinimized;var o,r,c,l,d,h,u,m;((i||a)&&this.generatePreview(),(null===(s=e.room)||void 0===s?void 0:s.roomId)!==(null===(n=this.props.room)||void 0===n?void 0:n.roomId))&&(S.a.instance.off(S.a.getPreviewChangedEventName(e.room),this.onRoomPreviewChanged),S.a.instance.on(S.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),M.a.instance.off(M.a.getUpdateEventName(null===(o=e.room)||void 0===o?void 0:o.roomId),this.onCommunityUpdate),M.a.instance.on(M.a.getUpdateEventName(null===(r=this.props.room)||void 0===r?void 0:r.roomId),this.onCommunityUpdate),null===(c=e.room)||void 0===c||c.off("Room.name",this.onRoomNameUpdate),null===(l=this.props.room)||void 0===l||l.on("Room.name",this.onRoomNameUpdate));(t.generalMenuPosition&&!this.state.generalMenuPosition||t.notificationsMenuPosition&&this.state.notificationsMenuPosition)&&(null===(d=this.roomTileRef)||void 0===d||null===(h=d.current)||void 0===h||h.focus(),null===(u=this.roomTileRef)||void 0===u||null===(m=u.current)||void 0===m||m.blur())}componentDidMount(){var e;this.state.selected&&this.scrollIntoView(),f.a.addListener(this.props.room.roomId,this.onActiveRoomUpdate),this.dispatcherRef=p.a.register(this.onAction),S.a.instance.on(S.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.notificationState.on(x.a,this.onNotificationUpdate),this.roomProps.on(P.b,this.onRoomPropertyUpdate),null===(e=this.props.room)||void 0===e||e.on("Room.name",this.onRoomNameUpdate),M.a.instance.on(M.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate)}componentWillUnmount(){this.props.room&&(f.a.removeListener(this.props.room.roomId,this.onActiveRoomUpdate),S.a.instance.off(S.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),M.a.instance.off(M.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate),this.props.room.off("Room.name",this.onRoomNameUpdate)),f.a.removeListener(this.props.room.roomId,this.onActiveRoomUpdate),p.a.unregister(this.dispatcherRef),this.notificationState.off(x.a,this.onNotificationUpdate),this.roomProps.off(P.b,this.onRoomPropertyUpdate),M.a.instance.off(M.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate)}async generatePreview(){if(!this.showMessagePreview)return null;const e=await S.a.instance.getPreviewForRoom(this.props.room,this.props.tag);this.setState({messagePreview:e})}async saveNotifState(e,t){if(e.preventDefault(),e.stopPropagation(),C.a.get().isGuest())return;this.roomProps.notificationVolume=t;e.key===v.a.ENTER&&this.setState({notificationsMenuPosition:null})}renderNotificationsMenu(e){if(C.a.get().isGuest()||this.props.tag===E.a.Archived||!this.showContextMenu||this.props.isMinimized)return null;const t=this.roomProps.notificationVolume;let s=null;this.state.notificationsMenuPosition&&(s=l.a.createElement(D.e,a()({},K(this.state.notificationsMenuPosition),{onFinished:this.onCloseNotificationsMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(D.c,{first:!0},l.a.createElement(D.d,{label:Object(b.a)("Use default"),active:t===w.a.AllMessages,iconClassName:"mx_RoomTile_iconBell",onClick:this.onClickAllNotifs}),l.a.createElement(D.d,{label:Object(b.a)("All messages"),active:t===w.a.AllMessagesLoud,iconClassName:"mx_RoomTile_iconBellDot",onClick:this.onClickAlertMe}),l.a.createElement(D.d,{label:Object(b.a)("Mentions & Keywords"),active:t===w.a.MentionsOnly,iconClassName:"mx_RoomTile_iconBellMentions",onClick:this.onClickMentions}),l.a.createElement(D.d,{label:Object(b.a)("None"),active:t===w.a.Mute,iconClassName:"mx_RoomTile_iconBellCrossed",onClick:this.onClickMute}))));const n=h()("mx_RoomTile_notificationsButton",{mx_RoomTile_iconBell:t===w.a.AllMessages,mx_RoomTile_iconBellDot:t===w.a.AllMessagesLoud,mx_RoomTile_iconBellMentions:t===w.a.MentionsOnly,mx_RoomTile_iconBellCrossed:t===w.a.Mute,mx_RoomTile_notificationsButton_show:!1});return l.a.createElement(l.a.Fragment,null,l.a.createElement(y.c,{className:n,onClick:this.onNotificationsMenuOpenClick,title:Object(b.a)("Notification options"),isExpanded:!!this.state.notificationsMenuPosition,tabIndex:e?0:-1}),s)}renderGeneralMenu(){if(!this.showContextMenu)return null;let e=null;if(this.state.generalMenuPosition&&this.props.tag===E.a.Archived)e=l.a.createElement(D.e,a()({},K(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(D.c,{red:!0},l.a.createElement(D.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(b.a)("Forget Room"),onClick:this.onForgetRoomClick})));else if(this.state.generalMenuPosition){const t=k.b.instance.getTagsForRoom(this.props.room),s=t.includes(E.a.Favourite),n=s?Object(b.a)("Favourited"):Object(b.a)("Favourite"),i=t.includes(E.a.LowPriority),o=Object(b.a)("Low Priority"),r=C.a.get().getUserId(),c=this.props.room.canInvite(r),d=F.b.getValue("feature_mark_unread"),h=this.notificationState.isUnread||d&&Object(L.e)(this.props.room);e=l.a.createElement(D.e,a()({},K(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(D.c,null,d&&!h?l.a.createElement(D.b,{onClick:this.onMarkUnreadClick,label:Object(b.a)("Mark as unread"),iconClassName:"mx_RoomTile_markAsUnread"}):null,d&&h?l.a.createElement(D.b,{onClick:this.onMarkReadClick,label:Object(b.a)("Mark as read"),iconClassName:"mx_RoomTile_markAsRead"}):null,l.a.createElement(D.a,{onClick:e=>this.onTagRoom(e,E.a.Favourite),active:s,label:n,iconClassName:"mx_RoomTile_iconStar"}),l.a.createElement(D.a,{onClick:e=>this.onTagRoom(e,E.a.LowPriority),active:i,label:o,iconClassName:"mx_RoomTile_iconArrowDown"}),c?l.a.createElement(D.b,{onClick:this.onInviteClick,label:Object(b.a)("Invite People"),iconClassName:"mx_RoomTile_iconInvite"}):null,l.a.createElement(D.b,{onClick:this.onCopyRoomClick,label:Object(b.a)("Copy Room Link"),iconClassName:"mx_RoomTile_iconCopyLink"}),l.a.createElement(D.b,{onClick:this.onOpenRoomSettings,label:Object(b.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"})),l.a.createElement(D.c,{red:!0},l.a.createElement(D.b,{onClick:this.onLeaveRoomClick,label:Object(b.a)("Leave Room"),iconClassName:"mx_RoomTile_iconSignOut"})))}return l.a.createElement(l.a.Fragment,null,l.a.createElement(y.c,{className:"mx_RoomTile_menuButton",onClick:this.onGeneralMenuOpenClick,title:Object(b.a)("Room options"),isExpanded:!!this.state.generalMenuPosition}),e)}render(){const e=h()({mx_RoomTile:!0,mx_RoomTile_selected:this.state.selected,mx_RoomTile_hasMenuOpen:!(!this.state.generalMenuPosition&&!this.state.notificationsMenuPosition),mx_RoomTile_minimized:this.props.isMinimized});let t={displayName:null,avatarMxc:null};this.props.tag===E.a.Invite&&(t=M.a.instance.getInviteProfile(this.props.room.roomId));let s=t.displayName||this.props.room.name;"string"!=typeof s&&(s=""),s=s.replace(":",":​");const n=l.a.createElement(_.a,{room:this.props.room,avatarSize:48,displayBadge:this.props.isMinimized,oobData:{avatarUrl:t.avatarMxc}});let i;!this.props.isMinimized&&this.notificationState&&(i=l.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},l.a.createElement(O.a,{notification:this.notificationState,forceCount:!1,roomId:this.props.room.roomId})));let o=null;this.showMessagePreview&&this.state.messagePreview&&(o=l.a.createElement("div",{className:"mx_RoomTile_messagePreview",id:V(this.props.room.roomId),title:this.state.messagePreview,dir:"auto"},this.state.messagePreview));const r=h()({mx_RoomTile_name:!0,mx_RoomTile_nameWithPreview:!!o,mx_RoomTile_nameHasUnreadEvents:this.notificationState.isUnread});let c=l.a.createElement("div",{className:"mx_RoomTile_nameContainer"},l.a.createElement("div",{title:s,className:r,tabIndex:-1,dir:"auto"},s),o);this.props.isMinimized&&(c=null);let d,p=s;this.props.tag===E.a.Invite||(this.notificationState.hasMentions?p+=" "+Object(b.a)("%(count)s unread messages including mentions.",{count:this.notificationState.count}):this.notificationState.hasUnreadCount?p+=" "+Object(b.a)("%(count)s unread messages.",{count:this.notificationState.count}):this.notificationState.isUnread&&(p+=" "+Object(b.a)("Unread messages."))),this.showMessagePreview&&(d=V(this.props.room.roomId));const g={};let v=m.a;return this.props.isMinimized&&(v=T.a,g.title=s,g.forceHide=!!this.state.generalMenuPosition),l.a.createElement(l.a.Fragment,null,l.a.createElement(u.d,{inputRef:this.roomTileRef},({onFocus:t,isActive:s,ref:o})=>l.a.createElement(v,a()({},g,{onFocus:t,tabIndex:s?0:-1,inputRef:o,className:e,onClick:this.onTileClick,onContextMenu:this.onContextMenu,role:"treeitem","aria-label":p,"aria-selected":this.state.selected,"aria-describedby":d}),n,c,i,this.renderGeneralMenu(),this.renderNotificationsMenu(s))))}})||n}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(770);class i{constructor(){}static forRoom(e){return n.a.instance.getOrCreateChamberForRoom(e)}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(773);let o;!function(e){e[e.Pending=0]="Pending",e[e.Success=1]="Success",e[e.Error=2]="Error"}(o||(o={}));class r extends a.a{constructor(e,t){super(),this.auditName=e,this.runFn=t,i()(this,"_status",o.Pending),i()(this,"didFail",!1),i()(this,"startTime",new Date)}get didPreviouslyFail(){return this.didFail}get status(){return this._status}run(){if(this.status===o.Success)throw new Error("Cannot re-run a successful echo transaction");this.setStatus(o.Pending),this.runFn().then(()=>this.setStatus(o.Success)).catch(()=>this.setStatus(o.Error))}cancel(){this.setStatus(o.Success)}setStatus(e){this._status=e,e===o.Error?this.didFail=!0:e===o.Success&&(this.didFail=!1),this.notifyCondition(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(784),h=s(86),u=s(84),m=s(101),p=s(96),g=s(104),v=s(88),f=s(90),b=s(1034),y=s(85),E=s(368),S=s(1);class _ extends d.a{constructor(...e){super(...e),r()(this,"aliasField",Object(c.createRef)()),r()(this,"onAliasAdded",async()=>{await this.aliasField.current.validate({allowEmpty:!1}),this.aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this.aliasField.current.focus(),this.aliasField.current.validate({allowEmpty:!1,focused:!0}))})}renderNewItemField(){if(!this.props.domain)return super.renderNewItemField();return l.a.createElement("form",{onSubmit:this.onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},l.a.createElement(E.a,{ref:this.aliasField,onChange:e=>this.onNewItemChanged({target:{value:e}}),value:this.props.newItem||"",domain:this.props.domain}),l.a.createElement(v.a,{onClick:this.onAliasAdded,kind:"primary"},Object(u.a)("Add")))}}let w=Object(y.a)("views.room_settings.AliasSettings")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onNewAliasChanged",e=>{this.setState({newAlias:e})}),r()(this,"onLocalAliasAdded",e=>{if(!e||0===e.length)return;const t=h.a.get().getDomain();e.includes(":")||(e+=":"+t),h.a.get().createAlias(e,this.props.roomId).then(()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:null}),this.state.canonicalAlias||this.changeCanonicalAlias(e)}).catch(e=>{S.a.error(e),f.a.createTrackedDialog("Error creating address","",g.a,{title:Object(u.a)("Error creating address"),description:Object(u.a)("There was an error creating that address. It may not be allowed by the server or a temporary failure occurred.")})})}),r()(this,"onLocalAliasDeleted",e=>{const t=this.state.localAliases[e];h.a.get().deleteAlias(t).then(()=>{const e=this.state.localAliases.filter(e=>e!==t);this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)}).catch(e=>{let t;S.a.error(e),t="M_FORBIDDEN"===e.errcode?Object(u.a)("You don't have permission to delete the address."):Object(u.a)("There was an error removing that address. It may no longer exist or a temporary error occurred."),f.a.createTrackedDialog("Error removing address","",g.a,{title:Object(u.a)("Error removing address"),description:t})})}),r()(this,"onLocalAliasesToggled",e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.currentTarget.open})}),r()(this,"onCanonicalAliasChange",e=>{this.changeCanonicalAlias(e.target.value)}),r()(this,"onNewAltAliasChanged",e=>{this.setState({newAltAlias:e})}),r()(this,"onAltAliasAdded",e=>{const t=this.state.altAliases.slice();t.some(t=>t.trim()===e.trim())||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))}),r()(this,"onAltAliasDeleted",e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)});const t={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const s=e.canonicalAliasEvent.getContent(),n=s.alt_aliases;Array.isArray(n)&&(t.altAliases=n.slice()),t.canonicalAlias=s.alias}this.state=t}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=h.a.get();let t=[];if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const s=await e.unstableGetLocalAliases(this.props.roomId);Array.isArray(s.aliases)&&(t=s.aliases)}this.setState({localAliases:t}),0===t.length&&this.setState({detailsOpen:!0})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const s={alt_aliases:this.state.altAliases};e&&(s.alias=e),h.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",s,"").catch(e=>{S.a.error(e),f.a.createTrackedDialog("Error updating main address","",g.a,{title:Object(u.a)("Error updating main address"),description:Object(u.a)("There was an error updating the room's main address. It may not be allowed by the server or a temporary failure occurred.")}),this.setState({canonicalAlias:t})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0,altAliases:e});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),h.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",t,"").catch(e=>{S.a.error(e),f.a.createTrackedDialog("Error updating alternative addresses","",g.a,{title:Object(u.a)("Error updating main address"),description:Object(u.a)("There was an error updating the room's alternative addresses. It may not be allowed by the server or a temporary failure occurred.")})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}getAliases(){return this.state.altAliases.concat(this.getLocalNonAltAliases())}getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter(t=>!e.includes(t))}render(){var e;const t=h.a.get(),s=t.getDomain(),n=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.isSpaceRoom();let i=!1;const a=this.state.canonicalAlias||"",o=l.a.createElement(m.a,{onChange:this.onCanonicalAliasChange,value:a,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:Object(u.a)("Main address")},l.a.createElement("option",{value:"",key:"unset"},Object(u.a)("not specified")),this.getAliases().map((e,t)=>(e===this.state.canonicalAlias&&(i=!0),l.a.createElement("option",{value:e,key:t},e))),i||!this.state.canonicalAlias?"":l.a.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let r;return r=this.state.localAliasesLoading?l.a.createElement(p.a,null):l.a.createElement(_,{id:"roomAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:n?Object(u.a)("This space has no local addresses"):Object(u.a)("This room has no local addresses"),placeholder:Object(u.a)("Local address"),domain:s}),l.a.createElement("div",{className:"mx_AliasSettings"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(u.a)("Published Addresses")),l.a.createElement("p",null,n?Object(u.a)("Published addresses can be used by anyone on any server to join your space."):Object(u.a)("Published addresses can be used by anyone on any server to join your room.")," ",Object(u.a)("To publish an address, it needs to be set as a local address first.")),o,this.props.hidePublishSetting?null:l.a.createElement(b.a,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),l.a.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this.getLocalNonAltAliases().map(e=>l.a.createElement("option",{value:e,key:e})),";"),l.a.createElement(_,{id:"roomAltAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:Object(u.a)("Other published addresses:"),noItemsLabel:Object(u.a)("No other published addresses yet, add one below"),placeholder:Object(u.a)("New published address (e.g. #alias:server)")}),l.a.createElement("span",{className:"mx_SettingsTab_subheading mx_AliasSettings_localAliasHeader"},Object(u.a)("Local Addresses")),l.a.createElement("p",null,n?Object(u.a)("Set addresses for this space so users can find this space through your homeserver (%(localDomain)s)",{localDomain:s}):Object(u.a)("Set addresses for this room so users can find this room through your homeserver (%(localDomain)s)",{localDomain:s})),l.a.createElement("details",{onToggle:this.onLocalAliasesToggled,open:this.state.detailsOpen},l.a.createElement("summary",null,this.state.detailsOpen?Object(u.a)("Show less"):Object(u.a)("Show more")),r))}},r()(i,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1}),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(127),o=s(94),r=s(216),c=s(84),l=s(88),d=s(126),h=s(106),u=s(86),m=s(90),p=s(786),g=s(524),v=s(388),f=s(116),b=s(785),y=s(87),E=s(325);t.a=({room:e,promptUpgrade:t,onError:s,beforeChange:n,closeSettingsFn:S})=>{const _=e.client,w=h.a.instance.restrictedJoinRuleSupport,C=Array.isArray(null==w?void 0:w.support)&&w.support.includes(e.getVersion()),O=!C&&t?null==w?void 0:w.preferred:void 0,k=!e.currentState.mayClientSendStateEvent(o.a.RoomJoinRules,_),[R,I]=Object(b.a)(()=>{var t;return null===(t=e.currentState.getStateEvents(o.a.RoomJoinRules,""))||void 0===t?void 0:t.getContent()},t=>_.sendStateEvent(e.roomId,o.a.RoomJoinRules,t,""),s),{join_rule:x}=R,T=x===a.c.Restricted?R.allow.filter(e=>e.type===a.e.RoomMembership).map(e=>e.room_id):void 0,j=async()=>{var t;let s=T;null!==(t=s)&&void 0!==t&&t.length||!h.a.instance.activeSpaceRoom||(s=[h.a.instance.activeSpaceRoom.roomId]);const n=u.a.get(),{finished:i}=m.a.createTrackedDialog("Edit restricted","",p.a,{matrixClient:n,room:e,selected:s},"mx_ManageRestrictedJoinRuleDialog_wrapper"),[a]=await i;return a},N=[{value:a.c.Invite,label:Object(c.a)("Private (invite only)"),description:Object(c.a)("Only invited people can join."),checked:x===a.c.Invite||x===a.c.Restricted&&!(null!=T&&T.length)},{value:a.c.Public,label:Object(c.a)("Public"),description:Object(c.a)("Anyone can find and join.")}];if(C||O||x===a.c.Restricted){let e,t;if(O&&(e=i.a.createElement("span",{className:"mx_JoinRuleSettings_upgradeRequired"},Object(c.a)("Upgrade required"))),x===a.c.Restricted&&null!=T&&T.length){const e=T.map(e=>_.getRoom(e)).filter(e=>null==e?void 0:e.isSpaceRoom()).slice(0,4);let s;e.length<T.length&&(s=e.length>0?Object(c.a)("& %(count)s more",{count:T.length-e.length}):Object(c.a)("Currently, %(count)s spaces have access",{count:T.length}));const n=e=>{Object(f.d)(T||[],e)&&(e.length?I({join_rule:a.c.Restricted,allow:e.map(e=>({type:a.e.RoomMembership,room_id:e}))}):I({join_rule:a.c.Invite}))},o=async()=>{const e=await j();Array.isArray(e)&&(e.length>0?n(e):P(a.c.Invite))};t=i.a.createElement("div",null,i.a.createElement("span",null,Object(c.a)("Anyone in a space can find and join. <a>Edit which spaces can access here.</a>",{},{a:e=>i.a.createElement(l.a,{disabled:k,onClick:o,kind:"link",className:"mx_JoinRuleSettings_linkButton"},e)})),i.a.createElement("div",{className:"mx_JoinRuleSettings_spacesWithAccess"},i.a.createElement("h4",null,Object(c.a)("Spaces with access")),e.map(e=>i.a.createElement("span",{key:e.roomId},i.a.createElement(d.a,{room:e,height:32,width:32}),e.name)),s&&i.a.createElement("span",null,s)))}else t=h.a.instance.activeSpaceRoom?Object(c.a)("Anyone in <spaceName/> can find and join. You can select other spaces too.",{},{spaceName:()=>i.a.createElement("b",null,h.a.instance.activeSpaceRoom.name)}):Object(c.a)("Anyone in a space can find and join. You can select multiple spaces.");N.splice(1,0,{value:a.c.Restricted,label:i.a.createElement(i.a.Fragment,null,Object(c.a)("Space members"),e),description:t,checked:x===a.c.Restricted&&!(null==T||!T.length)})}const P=async t=>{const s=R.join_rule;let r;if(t===a.c.Restricted){if(s===a.c.Restricted||C){if(r=await j(),!Array.isArray(r))return}else if(O){const t=O;let s;const n=_.getUserId();return Array.from(h.a.instance.getKnownParents(e.roomId)).some(e=>{var t;return!(null!==(t=_.getRoom(e))&&void 0!==t&&t.currentState.maySendStateEvent(o.a.SpaceChild,n))})&&(s=i.a.createElement("b",null,Object(c.a)("This room is in some spaces you're not an admin of. In those spaces, the old room will still be shown, but people will be prompted to join the new one."))),void m.a.createTrackedDialog("Restricted join rule upgrade","",g.a,{roomId:e.roomId,targetVersion:t,description:i.a.createElement(i.a.Fragment,null,Object(c.a)("This upgrade will allow members of selected spaces access to this room without an invite."),s),doUpgrade:async(s,n)=>{const i=await Object(v.b)(e,t,s.invite,!0,!0,!0,e=>{const t=2+e.updateSpacesTotal+e.inviteUsersTotal;e.roomUpgraded?e.roomSynced?e.inviteUsersProgress<e.inviteUsersTotal?n(Object(c.a)("Sending invites... (%(progress)s out of %(count)s)",{progress:e.inviteUsersProgress,count:e.inviteUsersTotal}),2+e.inviteUsersProgress,t):e.updateSpacesProgress<e.updateSpacesTotal&&n(Object(c.a)("Updating spaces... (%(progress)s out of %(count)s)",{progress:e.updateSpacesProgress,count:e.updateSpacesTotal}),2+e.inviteUsersProgress+e.updateSpacesProgress,t):n(Object(c.a)("Loading new room"),1,t):n(Object(c.a)("Upgrading room"),0,t)});S(),y.a.dispatch({action:"view_room",room_id:i}),y.a.dispatch({action:"open_room_settings",initial_tab_id:E.b})}})}r.length||(t=a.c.Invite)}if(s===t&&!r)return;if(n&&!await n(t))return;const l={join_rule:t};t===a.c.Restricted&&(l.allow=r.map(e=>({type:a.e.RoomMembership,room_id:e}))),I(l)};return i.a.createElement(r.a,{name:"joinRule",value:x,onChange:P,definitions:N,disabled:k,className:"mx_JoinRuleSettings_radioButton"})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(94),l=s(127),d=s(84),h=s(93),u=s(187),m=s(86),p=s(90),g=s(85),v=s(200),f=s(97),b=s(109),y=s(301);let E=Object(g.a)("views.dialogs.RoomUpgradeWarningDialog")(n=class extends r.a.Component{constructor(e){var t;super(e),a()(this,"isPrivate",void 0),a()(this,"currentVersion",void 0),a()(this,"onProgressCallback",(e,t,s)=>{this.setState({progressText:e,progress:t,total:s})}),a()(this,"onContinue",()=>{const e={continue:!0,invite:this.isPrivate&&this.state.inviteUsersToNewRoom};this.props.doUpgrade?this.props.doUpgrade(e,this.onProgressCallback).then(()=>{this.props.onFinished(e)}):this.props.onFinished(e)}),a()(this,"onCancel",()=>{this.props.onFinished({continue:!1,invite:!1})}),a()(this,"onInviteUsersToggle",e=>{this.setState({inviteUsersToNewRoom:e})}),a()(this,"openBugReportDialog",e=>{e.preventDefault(),e.stopPropagation(),p.a.createTrackedDialog("Bug Report Dialog","",v.a,{})});const s=m.a.get().getRoom(this.props.roomId),n=null==s?void 0:s.currentState.getStateEvents(c.a.RoomJoinRules,"");this.isPrivate=null===(t=(null==n?void 0:n.getContent().join_rule)!==l.c.Public)||void 0===t||t,this.currentVersion=null==s?void 0:s.getVersion(),this.state={inviteUsersToNewRoom:!0}}render(){const e=h.a.get().brand;let t=null;this.isPrivate&&(t=r.a.createElement(u.a,{value:this.state.inviteUsersToNewRoom,onChange:this.onInviteUsersToggle,label:Object(d.a)("Automatically invite members from this room to the new one")}));const s=this.isPrivate?Object(d.a)("Upgrade private room"):Object(d.a)("Upgrade public room");let n,i=r.a.createElement("p",null,Object(d.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please report a bug.",{brand:e}));return h.a.get().bug_report_endpoint_url&&(i=r.a.createElement("p",null,Object(d.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please <a>report a bug</a>.",{brand:e},{a:e=>r.a.createElement("a",{href:"#",onClick:this.openBugReportDialog},e)}))),n=this.state.progressText?r.a.createElement("span",{className:"mx_RoomUpgradeWarningDialog_progress"},r.a.createElement(y.a,{value:this.state.progress,max:this.state.total}),r.a.createElement("div",{className:"mx_RoomUpgradeWarningDialog_progressText"},this.state.progressText)):r.a.createElement(b.a,{primaryButton:Object(d.a)("Upgrade"),onPrimaryButtonClick:this.onContinue,cancelButton:Object(d.a)("Cancel"),onCancel:this.onCancel}),r.a.createElement(f.a,{className:"mx_RoomUpgradeWarningDialog",hasCancel:!0,fixedWidth:!1,onFinished:this.props.onFinished,title:s},r.a.createElement("div",null,r.a.createElement("p",null,this.props.description||Object(d.a)("Upgrading a room is an advanced action and is usually recommended when a room is unstable due to bugs, missing features or security vulnerabilities.")),r.a.createElement("p",null,Object(d.a)("<b>Please note upgrading will make a new version of the room</b>. All current messages will stay in this archived room.",{},{b:e=>r.a.createElement("b",null,e)})),i,r.a.createElement("p",null,Object(d.a)("You'll upgrade this room from <oldVersion /> to <newVersion />.",{},{oldVersion:()=>r.a.createElement("code",null,this.currentVersion),newVersion:()=>r.a.createElement("code",null,this.props.targetVersion)})),t),n)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return m})),s.d(t,"c",(function(){return p})),s.d(t,"a",(function(){return g}));var n=s(1523),i=s(93),a=s(86),o=s(89);async function r(){const e={};if(navigator.storage&&navigator.storage.persisted)try{e.storageManager_persisted=String(await navigator.storage.persisted())}catch(e){}else if(document.hasStorageAccess)try{e.storageManager_persisted=String(await document.hasStorageAccess())}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const t=await navigator.storage.estimate();if(e.storageManager_quota=String(t.quota),e.storageManager_usage=String(t.usage),t.usageDetails){const s=[];Object.keys(t.usageDetails).forEach(e=>{s.push(`${e}: ${String(t.usageDetails[e])}`)}),e.storageManager_usage=s.join(", ")}}catch(e){}return e}function c(e){return{username:e.credentials.userId,enabled_labs:l(),low_bandwidth:o.b.getValue("lowBandwidth")?"enabled":"disabled"}}function l(){const e=o.b.getFeatureSettingNames().filter(e=>o.b.getValue(e));return e.length?e.join(", "):""}async function d(e){if(!e.isCryptoEnabled())return{};const t=["ed25519:"+e.getDeviceEd25519Key()];e.getDeviceCurve25519Key&&t.push("curve25519:"+e.getDeviceCurve25519Key());const s=e.crypto.crossSigningInfo,n=e.crypto.secretStorage,i=e.getCrossSigningCacheCallbacks(),a=await e.crypto.getSessionBackupPrivateKey();return{device_keys:t.join(", "),cross_signing_ready:String(await e.isCrossSigningReady()),cross_signing_supported_by_hs:String(await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")),cross_signing_key:s.getId(),cross_signing_privkey_in_secret_storage:String(!!await s.isStoredInSecretStorage(n)),cross_signing_master_privkey_cached:String(!(!i||!await i.getCrossSigningKeyCache("master"))),cross_signing_user_signing_privkey_cached:String(!(!i||!await i.getCrossSigningKeyCache("user_signing"))),secret_storage_ready:String(await e.isSecretStorageReady()),secret_storage_key_in_account:String(!!await n.hasKey()),session_backup_key_in_secret_storage:String(!!await e.isKeyBackupKeyStored()),session_backup_key_cached:String(!!a),session_backup_key_well_formed:String(a instanceof Uint8Array)}}function h(e){const t={device_id:null==e?void 0:e.deviceId,mx_local_settings:localStorage.getItem("mx_local_settings")};if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&(t.modernizr_missing_features=e.join(", "))}return t}async function u(){const e=a.a.get();return{user:c(e),crypto:await d(e),device:h(e),storage:await r()}}async function m(e,t,s){if(!i.a.get().sentry)return;const a={contexts:await u(),extra:{user_text:e,issue_url:t}};s?n.captureException(s,a):t&&n.captureMessage("Issue: "+t,a)}function p(e){i.a.get().sentry&&o.b.getValue("automaticErrorReporting")&&n.setUser({username:e})}async function g(e){if(!e)return;const t=[new n.Integrations.InboundFilters,new n.Integrations.FunctionToString,new n.Integrations.Breadcrumbs,new n.Integrations.UserAgent,new n.Integrations.Dedupe];o.b.getValue("automaticErrorReporting")&&(t.push(new n.Integrations.GlobalHandlers({onerror:!1,onunhandledrejection:!0})),t.push(new n.Integrations.TryCatch)),n.init({dsn:e.dsn,release:"!!UNSET!!",environment:e.environment,defaultIntegrations:!1,autoSessionTracking:!1,integrations:t,tracesSampleRate:1})}window.mxSendSentryReport=m},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(94),l=s(84),d=s(86),h=s(88),u=s(536),m=s(379),p=s(90),g=s(87),v=s(92),f=s(85);function b(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let y=Object(f.a)("views.settings.tabs.room.AdvancedRoomSettingsTab")(n=class extends r.a.Component{constructor(e,t){super(e,t),a()(this,"upgradeRoom",e=>{const t=d.a.get().getRoom(this.props.roomId);p.a.createTrackedDialog("Upgrade Room Version","",u.a,{room:t})}),a()(this,"openDevtools",e=>{p.a.createDialog(m.b,{roomId:this.props.roomId})}),a()(this,"onOldRoomClicked",e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:v.a.ViewRoom,room_id:this.state.oldRoomId,event_id:this.state.oldEventId}),this.props.closeSettingsFn()}),this.state={upgradeRecommendation:null};const s=d.a.get().getRoom(this.props.roomId);s.getRecommendedVersion().then(e=>{const t=s.currentState.getStateEvents(c.a.RoomTombstone,""),n={},i=s.currentState.getStateEvents(c.a.RoomCreate,""),o=i?i.getContent().predecessor:null;o&&o.room_id&&(n.oldRoomId=o.room_id,n.oldEventId=o.event_id),this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?b(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):b(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({upgraded:!(null==t||!t.getContent().replacement_room),upgradeRecommendation:e},n))})}render(){const e=d.a.get().getRoom(this.props.roomId);let t;const s=e.currentState.getStateEvents(c.a.RoomCreate,"");let n,i;if(s&&!1===s.getContent()["m.federate"]&&(t=r.a.createElement("div",null,Object(l.a)("This room is not accessible by remote Matrix servers"))),this.state.upgradeRecommendation&&this.state.upgradeRecommendation.needsUpgrade&&!this.state.upgraded&&(n=r.a.createElement("div",null,r.a.createElement("p",{className:"mx_SettingsTab_warningText"},Object(l.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>r.a.createElement("b",null,e),i:e=>r.a.createElement("i",null,e)})),r.a.createElement(h.a,{onClick:this.upgradeRoom,kind:"primary"},Object(l.a)("Upgrade this room to the recommended room version")))),this.state.oldRoomId){let e=Object(l.a)("this room");const t=d.a.get().getRoom(this.props.roomId);t&&t.name&&(e=t.name),i=r.a.createElement(h.a,{element:"a",onClick:this.onOldRoomClicked},Object(l.a)("View older messages in %(roomName)s.",{roomName:e}))}return r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},null!=e&&e.isSpaceRoom()?Object(l.a)("Space information"):Object(l.a)("Room information")),r.a.createElement("div",null,r.a.createElement("span",null,Object(l.a)("Internal room ID:"))," ",this.props.roomId),t),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Room version")),r.a.createElement("div",null,r.a.createElement("span",null,Object(l.a)("Room version:"))," ",e.getVersion()),i,n),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Developer options")),r.a.createElement(h.a,{onClick:this.openDevtools,kind:"primary"},Object(l.a)("Open Devtools"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(90),l=s(84),d=s(85),h=s(388),u=s(97),m=s(104),p=s(109),g=s(96);let v=Object(d.a)("views.dialogs.RoomUpgradeDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"targetVersion",void 0),a()(this,"state",{busy:!0}),a()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),a()(this,"onUpgradeClick",()=>{this.setState({busy:!0}),Object(h.b)(this.props.room,this.targetVersion,!1,!1).then(()=>{this.props.onFinished(!0)}).catch(e=>{c.a.createTrackedDialog("Failed to upgrade room","",m.a,{title:Object(l.a)("Failed to upgrade room"),description:e&&e.message?e.message:Object(l.a)("The room upgrade could not be completed")})}).finally(()=>{this.setState({busy:!1})})})}async componentDidMount(){const e=await this.props.room.getRecommendedVersion();this.targetVersion=e.version,this.setState({busy:!1})}render(){let e;return e=this.state.busy?r.a.createElement(g.a,null):r.a.createElement(p.a,{primaryButton:Object(l.a)("Upgrade this room to version %(version)s",{version:this.targetVersion}),primaryButtonClass:"danger",hasCancel:!0,onPrimaryButtonClick:this.onUpgradeClick,onCancel:this.onCancelClick}),r.a.createElement(u.a,{className:"mx_RoomUpgradeDialog",onFinished:this.props.onFinished,title:Object(l.a)("Upgrade Room Version"),contentId:"mx_Dialog_content",hasCancel:!0},r.a.createElement("p",null,Object(l.a)("Upgrading this room requires closing down the current instance of the room and creating a new room in its place. To give room members the best possible experience, we will:")),r.a.createElement("ol",null,r.a.createElement("li",null,Object(l.a)("Create a new room with the same name, description and avatar")),r.a.createElement("li",null,Object(l.a)("Update any local room aliases to point to the new room")),r.a.createElement("li",null,Object(l.a)("Stop users from speaking in the old version of the room, and post a message advising users to move to the new room")),r.a.createElement("li",null,Object(l.a)("Put a link back to the old room at the start of the new room so people can see old messages"))),e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(88),h=s(90),u=s(85),m=s(94),p=s(143),g=s(104),v=s(538),f=s(1);const b={[m.a.RoomAvatar]:{isState:!0},[m.a.RoomName]:{isState:!0},[m.a.RoomCanonicalAlias]:{isState:!0},[m.a.SpaceChild]:{isState:!0,hideForRoom:!0},[m.a.RoomHistoryVisibility]:{isState:!0,hideForSpace:!0},[m.a.RoomPowerLevels]:{isState:!0},[m.a.RoomTopic]:{isState:!0},[m.a.RoomTombstone]:{isState:!0,hideForSpace:!0},[m.a.RoomEncryption]:{isState:!0,hideForSpace:!0},[m.a.RoomServerAcl]:{isState:!0,hideForSpace:!0},"im.vector.modular.widgets":{isState:!0,hideForSpace:!0}};function y(e,t){const s=parseInt(e);return isNaN(s)?t:s}class E extends r.a.Component{constructor(...e){super(...e),a()(this,"onUnbanClick",e=>{l.a.get().unban(this.props.member.roomId,this.props.member.userId).catch(e=>{f.a.error("Failed to unban: "+e),h.a.createTrackedDialog("Failed to unban","",g.a,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to unban")})})})}render(){let e;this.props.canUnban&&(e=r.a.createElement(d.a,{className:"mx_RolesRoomSettingsTab_unbanBtn",kind:"danger_sm",onClick:this.onUnbanClick},Object(c.a)("Unban")));const t=this.props.member.name===this.props.member.userId?null:this.props.member.userId;return r.a.createElement("li",null,e,r.a.createElement("span",{title:Object(c.a)("Banned by %(displayName)s",{displayName:this.props.by})},r.a.createElement("strong",null,this.props.member.name)," ",t,this.props.reason?" "+Object(c.a)("Reason")+": "+this.props.reason:""))}}let S=Object(u.a)("views.settings.tabs.room.RolesRoomSettingsTab")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onRoomMembership",(e,t,s)=>{t.roomId===this.props.roomId&&this.forceUpdate()}),a()(this,"onPowerLevelsChanged",(e,t)=>{const s=l.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents(m.a.RoomPowerLevels,"");let i=n&&n.getContent()||{};i=Object.assign({},i);if(t.startsWith("event_levels_"))i.events=Object.assign({},i.events||{}),i.events[t.slice("event_levels_".length)]=e;else{const s=t.split(".");let n,a=i;for(const e of s)a[e]||(a[e]={}),n=a,a=a[e];n[s[s.length-1]]=e}s.sendStateEvent(this.props.roomId,m.a.RoomPowerLevels,i).catch(e=>{f.a.error(e),h.a.createTrackedDialog("Power level requirement change failed","",g.a,{title:Object(c.a)("Error changing power level requirement"),description:Object(c.a)("An error occurred changing the room's power level requirements. Ensure you have sufficient permissions and try again.")})})}),a()(this,"onUserPowerLevelChanged",(e,t)=>{const s=l.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents(m.a.RoomPowerLevels,"");let i=n&&n.getContent()||{};i=Object.assign({},i),i.users||(i.users={}),i.users[t]=e,s.sendStateEvent(this.props.roomId,m.a.RoomPowerLevels,i).catch(e=>{f.a.error(e),h.a.createTrackedDialog("Power level change failed","",g.a,{title:Object(c.a)("Error changing power level"),description:Object(c.a)("An error occurred changing the user's power level. Ensure you have sufficient permissions and try again.")})})})}componentDidMount(){l.a.get().on("RoomState.members",this.onRoomMembership)}componentWillUnmount(){const e=l.a.get();e&&e.removeListener("RoomState.members",this.onRoomMembership)}populateDefaultPlEvents(e,t,s){for(const n of Object.keys(b))n in e||(e[n]=b[n].isState?t:s)}render(){const e=l.a.get(),t=e.getRoom(this.props.roomId),s=t.isSpaceRoom(),n=t.currentState.getStateEvents(m.a.RoomPowerLevels,""),i=n&&n.getContent()||{},a=t.currentState.mayClientSendStateEvent(m.a.RoomPowerLevels,e),o={[m.a.RoomAvatar]:s?Object(c.b)("Change space avatar"):Object(c.b)("Change room avatar"),[m.a.RoomName]:s?Object(c.b)("Change space name"):Object(c.b)("Change room name"),[m.a.RoomCanonicalAlias]:s?Object(c.b)("Change main address for the space"):Object(c.b)("Change main address for the room"),[m.a.SpaceChild]:Object(c.b)("Manage rooms in this space"),[m.a.RoomHistoryVisibility]:Object(c.b)("Change history visibility"),[m.a.RoomPowerLevels]:Object(c.b)("Change permissions"),[m.a.RoomTopic]:s?Object(c.b)("Change description"):Object(c.b)("Change topic"),[m.a.RoomTombstone]:Object(c.b)("Upgrade the room"),[m.a.RoomEncryption]:Object(c.b)("Enable room encryption"),[m.a.RoomServerAcl]:Object(c.b)("Change server ACLs"),"im.vector.modular.widgets":s?null:Object(c.b)("Modify widgets")},d={users_default:{desc:Object(c.a)("Default role"),defaultValue:0},events_default:{desc:Object(c.a)("Send messages"),defaultValue:0,hideForSpace:!0},invite:{desc:Object(c.a)("Invite users"),defaultValue:50},state_default:{desc:Object(c.a)("Change settings"),defaultValue:50},kick:{desc:Object(c.a)("Kick users"),defaultValue:50},ban:{desc:Object(c.a)("Ban users"),defaultValue:50},redact:{desc:Object(c.a)("Remove messages sent by others"),defaultValue:50,hideForSpace:!0},"notifications.room":{desc:Object(c.a)("Notify everyone"),defaultValue:50,hideForSpace:!0}},h=i.events||{},u=i.users||{},g=y(i.ban,d.ban.defaultValue),f=y(i.users_default,d.users_default.defaultValue);let S=u[e.getUserId()];void 0===S&&(S=f),this.populateDefaultPlEvents(h,y(i.state_default,d.state_default.defaultValue),y(i.events_default,d.events_default.defaultValue));let _,w=r.a.createElement("div",null,Object(c.a)("No users have specific privileges in this room"));if(Object.keys(u).length){const e=[],t=[];Object.keys(u).forEach(s=>{if(!Number.isInteger(u[s]))return;const n=u[s]<S&&a;u[s]>f?e.push(r.a.createElement(v.a,{value:u[s],disabled:!n,label:s,key:s,powerLevelKey:s,onChange:this.onUserPowerLevelChanged})):u[s]<f&&t.push(r.a.createElement(v.a,{value:u[s],disabled:!n,label:s,key:s,powerLevelKey:s,onChange:this.onUserPowerLevelChanged}))});const s=(e,t)=>{const s=u[t.key]-u[e.key];return 0!==s?s:Object(p.a)(e.key.toLocaleLowerCase(),t.key.toLocaleLowerCase())};e.sort(s),t.sort(s),e.length&&(w=r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Privileged Users")),e)),t.length&&(_=r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Muted Users")),t))}const C=t.getMembersWithMembership("ban");let O;if(C.length){const e=S>=g;O=r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Banned users")),r.a.createElement("ul",null,C.map(s=>{const n=s.events.member.getContent(),i=t.getMember(s.events.member.getSender());let a=s.events.member.getSender();return i&&(a=i.name),r.a.createElement(E,{key:s.userId,canUnban:e,member:s,reason:n.reason,by:a})})))}const k=Object.keys(d).map((e,t)=>{const n=d[e];if(s&&n.hideForSpace)return null;const o=e.split(".");let c=i;for(const e of o){if(void 0===c)break;c=c[e]}const l=y(c,n.defaultValue);return r.a.createElement("div",{key:t,className:""},r.a.createElement(v.a,{label:n.desc,value:l,usersDefault:f,disabled:!a||S<l,powerLevelKey:e,onChange:this.onPowerLevelsChanged}))}).filter(Boolean);e.isRoomEncrypted(this.props.roomId)&&delete h[m.a.RoomEncryption];const R=Object.keys(h).map((e,t)=>{var n,i;if(s&&null!==(n=b[e])&&void 0!==n&&n.hideForSpace)return null;if(!s&&null!==(i=b[e])&&void 0!==i&&i.hideForRoom)return null;let l=o[e];return l=l?Object(c.a)(l):Object(c.a)("Send %(eventType)s events",{eventType:e}),r.a.createElement("div",{className:"",key:e},r.a.createElement(v.a,{label:l,value:h[e],usersDefault:f,disabled:!a||S<h[e],powerLevelKey:"event_levels_"+e,onChange:this.onPowerLevelsChanged}))}).filter(Boolean);return r.a.createElement("div",{className:"mx_SettingsTab mx_RolesRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Roles & Permissions")),w,_,O,r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Permissions")),r.a.createElement("p",null,s?Object(c.a)("Select the roles required to change various parts of the space"):Object(c.a)("Select the roles required to change various parts of the room")),k,R))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(448),h=s(84),u=s(101),m=s(108),p=s(85);let g=Object(p.a)("views.elements.PowerSelector")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onSelectChange",e=>{if("SELECT_VALUE_CUSTOM"===e.target.value)this.setState({custom:!0});else{const t=parseInt(e.target.value);this.props.onChange(t,this.props.powerLevelKey),this.setState({selectValue:t})}}),r()(this,"onCustomChange",e=>{this.setState({customValue:parseInt(e.target.value)})}),r()(this,"onCustomBlur",e=>{e.preventDefault(),e.stopPropagation(),this.props.onChange(this.state.customValue,this.props.powerLevelKey)}),r()(this,"onCustomKeyDown",e=>{e.key===m.a.ENTER&&(e.preventDefault(),e.stopPropagation(),e.target.blur())}),this.state={levelRoleMap:{},options:[],customValue:this.props.value,selectValue:0}}UNSAFE_componentWillMount(){this.initStateFromProps(this.props)}UNSAFE_componentWillReceiveProps(e){this.initStateFromProps(e)}initStateFromProps(e){const t=d.a(e.usersDefault),s=Object.keys(t).filter(t=>void 0===t||parseInt(t)<=e.maxValue||parseInt(t)==e.value).map(e=>parseInt(e)),n=void 0===t[e.value];this.setState({levelRoleMap:t,options:s,custom:n,customLevel:e.value,selectValue:n?"SELECT_VALUE_CUSTOM":e.value})}render(){let e;const t=void 0===this.props.label?Object(h.a)("Power level"):this.props.label;if(this.state.custom)e=l.a.createElement(u.a,{type:"number",label:t,max:this.props.maxValue,onBlur:this.onCustomBlur,onKeyDown:this.onCustomKeyDown,onChange:this.onCustomChange,value:String(this.state.customValue),disabled:this.props.disabled});else{const s=this.state.options.map(e=>({value:String(e),text:d.b(e,this.props.usersDefault)}));s.push({value:"SELECT_VALUE_CUSTOM",text:Object(h.a)("Custom level")});const n=s.map(e=>l.a.createElement("option",{value:e.value,key:e.value},e.text));e=l.a.createElement(u.a,{element:"select",label:t,onChange:this.onSelectChange,value:String(this.state.selectValue),disabled:this.props.disabled},n)}return l.a.createElement("div",{className:"mx_PowerSelector"},e)}},r()(i,"defaultProps",{maxValue:1/0,usersDefault:0}),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(4),o=s(84),r=s(88),c=s(143),l=s(120),d=s(159),h=s(86),u=s(221),m=s(115);t.a=({space:e,onFinished:t})=>{var s;const[p,g]=Object(n.useState)(Object(o.a)("Click to copy"));return i.a.createElement("div",{className:"mx_SpacePublicShare"},i.a.createElement(r.a,{className:"mx_SpacePublicShare_shareButton",onClick:async()=>{const t=new l.a(e);t.load();const s=await Object(c.c)(t.forShareableRoom())?Object(o.a)("Copied!"):Object(o.a)("Failed to copy");g(s),await Object(a.I)(5e3),p===s&&g(Object(o.a)("Click to copy"))}},i.a.createElement("h3",null,Object(o.a)("Share invite link")),i.a.createElement("span",null,p)),e.canInvite(null===(s=h.a.get())||void 0===s?void 0:s.getUserId())&&Object(u.a)(m.a.InviteUsers)?i.a.createElement(r.a,{className:"mx_SpacePublicShare_inviteButton",onClick:()=>{t&&t(),Object(d.g)(e.roomId)}},i.a.createElement("h3",null,Object(o.a)("Invite people")),i.a.createElement("span",null,Object(o.a)("Invite with email or username"))):null)}},function(e,t,s){"use strict";var n,i=s(82),a=s.n(i),o=s(84),r=s(216),c=s(214),l=s(237),d=s(128),h=s(273);!function(e){e.All="All",e.Specific="Specific",e.None="None"}(n||(n={}));const u=({filterPlaceholder:e,rooms:t,selected:s,onChange:n})=>{const[r,u]=Object(i.useState)(""),m=r.toLowerCase().trim(),p=Object(i.useMemo)(()=>{if(!m)return t;return new c.a(t,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(m)},[t,m]);return a.a.createElement("div",{className:"mx_SpaceChildrenPicker"},a.a.createElement(l.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:e,onSearch:u,autoFocus:!0}),a.a.createElement(d.a,null,p.map(e=>a.a.createElement(h.b,{key:e.roomId,room:e,checked:s.has(e),onChange:t=>{n(t,e)}})),p.length<1?a.a.createElement("span",{className:"mx_SpaceChildrenPicker_noResults"},Object(o.a)("No results")):void 0))};t.a=({space:e,spaceChildren:t,selected:s,onChange:c,noneLabel:l,allLabel:d,specificLabel:h})=>{const[m,p]=Object(i.useState)(l?n.None:n.All);return Object(i.useEffect)(()=>{m===n.All?c(t):c([])},[c,m,t]),a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"mx_SpaceChildrenPicker"},a.a.createElement(r.a,{name:"roomsToLeave",value:m,onChange:p,definitions:[{value:n.None,label:l},{value:n.All,label:d},{value:n.Specific,label:h}].filter(e=>e.label)})),m===n.Specific&&a.a.createElement(u,{filterPlaceholder:Object(o.a)("Search %(spaceName)s",{spaceName:e.name}),rooms:t,selected:s,onChange:(e,t)=>{c(e?[t,...s]:[...s].filter(e=>e!==t))}}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(82),i=s(88);class a extends n.PureComponent{render(){return n.createElement("div",{className:"mx_DialPadBackspaceButtonWrapper"},n.createElement(i.a,{className:"mx_DialPadBackspaceButton",onClick:this.props.onBackspacePress}))}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(84),i=s(254),a=s(179),o=s(146);const r=()=>{i.default.setEnabled(!0)},c=()=>{i.default.setPromptHidden(!0)},l=e=>{o.a.sharedInstance().addOrReplaceToast({key:"desktopnotifications",title:e?Object(n.a)("Don't miss a reply"):Object(n.a)("Notifications"),props:{description:Object(n.a)("Enable desktop notifications"),acceptLabel:Object(n.a)("Enable"),onAccept:r,rejectLabel:Object(n.a)("Dismiss"),onReject:c},component:a.a,priority:30})},d=()=>{o.a.sharedInstance().dismissToast("desktopnotifications")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(87),o=s(274);class r{constructor(e,t){this.window=e,this.document=t,i()(this,"activeNowTimeout",void 0),i()(this,"activeRecentlyTimeout",void 0),i()(this,"attachedActiveNowTimers",[]),i()(this,"attachedActiveRecentlyTimers",[]),i()(this,"lastScreenX",0),i()(this,"lastScreenY",0),i()(this,"onPageVisibilityChanged",e=>{"hidden"===this.document.visibilityState?(this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()):this.onUserActivity(e)}),i()(this,"onWindowBlurred",()=>{this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()}),i()(this,"onUserActivity",e=>{if(this.document.hasFocus()){if(e.screenX&&"mousemove"===e.type){if(e.screenX===this.lastScreenX&&e.screenY===this.lastScreenY)return;this.lastScreenX=e.screenX,this.lastScreenY=e.screenY}a.a.dispatch({action:"user_activity"}),this.activeNowTimeout.isRunning()?this.activeNowTimeout.restart():(this.activeNowTimeout.start(),a.a.dispatch({action:"user_activity_start"}),r.runTimersUntilTimeout(this.attachedActiveNowTimers,this.activeNowTimeout)),this.activeRecentlyTimeout.isRunning()?this.activeRecentlyTimeout.restart():(this.activeRecentlyTimeout.start(),r.runTimersUntilTimeout(this.attachedActiveRecentlyTimers,this.activeRecentlyTimeout))}}),this.activeNowTimeout=new o.a(700),this.activeRecentlyTimeout=new o.a(12e4)}static sharedInstance(){return void 0===window.mxUserActivity&&(window.mxUserActivity=new r(window,document)),window.mxUserActivity}timeWhileActiveNow(e){this.timeWhile(e,this.attachedActiveNowTimers),this.userActiveNow()&&e.start()}timeWhileActiveRecently(e){this.timeWhile(e,this.attachedActiveRecentlyTimers),this.userActiveRecently()&&e.start()}timeWhile(e,t){-1===t.indexOf(e)&&(t.push(e),e.finished().finally(()=>{const s=t.indexOf(e);-1!==s&&t.splice(s,1)}).catch(e=>{}))}start(){this.document.addEventListener("mousedown",this.onUserActivity),this.document.addEventListener("mousemove",this.onUserActivity),this.document.addEventListener("keydown",this.onUserActivity),this.document.addEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.addEventListener("blur",this.onWindowBlurred),this.window.addEventListener("focus",this.onUserActivity),this.window.addEventListener("wheel",this.onUserActivity,{passive:!0,capture:!0})}stop(){this.document.removeEventListener("mousedown",this.onUserActivity),this.document.removeEventListener("mousemove",this.onUserActivity),this.document.removeEventListener("keydown",this.onUserActivity),this.window.removeEventListener("wheel",this.onUserActivity,{capture:!0}),this.document.removeEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.removeEventListener("blur",this.onWindowBlurred),this.window.removeEventListener("focus",this.onUserActivity)}userActiveNow(){return this.activeNowTimeout.isRunning()}userActiveRecently(){return this.activeRecentlyTimeout.isRunning()}static async runTimersUntilTimeout(e,t){e.forEach(e=>e.start());try{await t.finished()}catch(e){}e.forEach(e=>e.abort())}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(90),h=s(393),u=s(547),m=s(85),p=s(394),g=s(88),v=s(96),f=s(1);let b=Object(m.a)("structures.auth.SetupEncryptionBody")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onStoreUpdate",()=>{const e=u.b.sharedInstance();e.phase!==u.a.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()}),a()(this,"onUsePassphraseClick",async()=>{u.b.sharedInstance().usePassPhrase()}),a()(this,"onVerifyClick",()=>{const e=l.a.get(),t=e.getUserId(),s=e.requestVerification(t);this.props.onFinished(),d.a.createTrackedDialog("New Session Verification","Starting dialog",h.a,{verificationRequestPromise:s,member:e.getUser(t),onFinished:async()=>{(await s).cancel(),this.props.onFinished()}})}),a()(this,"onSkipConfirmClick",()=>{u.b.sharedInstance().skipConfirm()}),a()(this,"onSkipBackClick",()=>{u.b.sharedInstance().returnAfterSkip()}),a()(this,"onResetClick",e=>{e.preventDefault();u.b.sharedInstance().reset()}),a()(this,"onResetConfirmClick",()=>{this.props.onFinished();u.b.sharedInstance().resetConfirm()}),a()(this,"onResetBackClick",()=>{u.b.sharedInstance().returnAfterReset()}),a()(this,"onDoneClick",()=>{u.b.sharedInstance().done()}),a()(this,"onEncryptionPanelClose",()=>{this.props.onFinished()});const t=u.b.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=u.b.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;if(this.state.verificationRequest)return r.a.createElement(p.a,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:l.a.get().getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(e===u.a.Intro){if(t)return r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("It looks like you don't have a Security Key or any other devices you can verify against.  This device will not be able to access old encrypted messages. In order to verify your identity on this device, you'll need to reset your verification keys.")),r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r.a.createElement(g.a,{kind:"primary",onClick:this.onResetConfirmClick},Object(c.a)("Proceed with reset"))));{const e=u.b.sharedInstance();let t,n,i;return e.keyInfo&&(s=e.keyInfo,Boolean(s.passphrase&&s.passphrase.salt&&s.passphrase.iterations))?t=Object(c.a)("Verify with Security Key or Phrase"):e.keyInfo&&(t=Object(c.a)("Verify with Security Key")),t&&(n=r.a.createElement(g.a,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(i=r.a.createElement(g.a,{kind:"primary",onClick:this.onVerifyClick},Object(c.a)("Verify with another login"))),r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("Verify your identity to access encrypted messages and prove your identity to others.")),r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i,n),r.a.createElement("div",{className:"mx_SetupEncryptionBody_reset"},Object(c.a)("Forgotten or lost all recovery methods? <a>Reset all</a>",null,{a:e=>r.a.createElement("a",{href:"",onClick:this.onResetClick,className:"mx_SetupEncryptionBody_reset_link"},e)})))}}if(e===u.a.Done){let e;return e=this.state.backupInfo?r.a.createElement("p",null,Object(c.a)("Your new session is now verified. It has access to your encrypted messages, and other users will see it as trusted.")):r.a.createElement("p",null,Object(c.a)("Your new session is now verified. Other users will see it as trusted.")),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r.a.createElement(g.a,{kind:"primary",onClick:this.onDoneClick},Object(c.a)("Done"))))}return e===u.a.ConfirmSkip?r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("Without verifying, you won't have access to all your messages and may appear as untrusted to others.")),r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r.a.createElement(g.a,{kind:"danger_outline",onClick:this.onSkipConfirmClick},Object(c.a)("I'll verify later")),r.a.createElement(g.a,{kind:"primary",onClick:this.onSkipBackClick},Object(c.a)("Go Back")))):e===u.a.ConfirmReset?r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("Resetting your verification keys cannot be undone. After resetting, you won't have access to old encrypted messages, and any friends who have previously verified you will see security warnings until you re-verify with them.")),r.a.createElement("p",null,Object(c.a)("Please only proceed if you're sure you've lost all of your other devices and your security key.")),r.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},r.a.createElement(g.a,{kind:"danger_outline",onClick:this.onResetConfirmClick},Object(c.a)("Proceed with reset")),r.a.createElement(g.a,{kind:"primary",onClick:this.onResetBackClick},Object(c.a)("Go Back")))):e===u.a.Busy||e===u.a.Loading?r.a.createElement(v.a,null):void f.a.log("SetupEncryptionBody: Unknown phase "+e);var s}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(82),i=s.n(n),a=s(84),o=s(88),r=s(96);const c=({text:e})=>i.a.createElement("div",{className:"mx_EncryptionInfo_spinner"},i.a.createElement(r.a,null),e);t.b=({waitingForOtherParty:e,waitingForNetwork:t,member:s,onStartVerification:n,isRoomEncrypted:r,inDialog:l,isSelfVerification:d})=>{let h,u;if(e&&d)h=i.a.createElement("div",null,Object(a.a)("To proceed, please accept the verification request on your other login."));else if(e||t){let t;t=e?Object(a.a)("Waiting for %(displayName)s to accept…",{displayName:s.displayName||s.name||s.userId}):Object(a.a)("Accepting…"),h=i.a.createElement(c,{text:t})}else h=i.a.createElement(o.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:n},Object(a.a)("Start Verification"));return u=r?i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("Messages in this room are end-to-end encrypted.")),i.a.createElement("p",null,Object(a.a)("Your messages are secured and only you and the recipient have the unique keys to unlock them."))):i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("Messages in this room are not end-to-end encrypted.")),i.a.createElement("p",null,Object(a.a)("In encrypted rooms, your messages are secured and only you and the recipient have the unique keys to unlock them."))),l?h:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(a.a)("Encryption")),u),i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(a.a)("Verify User")),i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("For extra security, verify this user by checking a one-time code on both of your devices.")),i.a.createElement("p",null,Object(a.a)("To be secure, do this in person or use a trusted way to communicate.")),h)))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(545),d=s(88),h=s(817),u=s(85);let m=Object(u.a)("views.verification.VerificationShowSas")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onMatchClick",()=>{this.setState({pending:!0}),this.props.onDone()}),a()(this,"onDontMatchClick",()=>{this.setState({cancelling:!0}),this.props.onCancel()}),this.state={pending:!1}}componentWillMount(){Object(h.a)()}render(){let e,t,s;if(this.props.sas.emoji){const s=this.props.sas.emoji.map((e,t)=>{return r.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_block",key:t},r.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_emoji"},e[0]),r.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_label"},Object(c.a)((s=e[1]).charAt(0).toUpperCase()+s.slice(1))));var s});e=r.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas"},s.slice(0,4),r.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_break"}),s.slice(4)),t=this.props.isSelf?Object(c.a)("Confirm the emoji below are displayed on both sessions, in the same order:"):Object(c.a)("Verify this user by confirming the following emoji appear on their screen.")}else{if(!this.props.sas.decimal)return r.a.createElement("div",null,Object(c.a)("Unable to find a supported verification method."),r.a.createElement(d.a,{kind:"primary",onClick:this.props.onCancel},Object(c.a)("Cancel")));{const s=this.props.sas.decimal.map((e,t)=>r.a.createElement("span",{key:t},e));e=r.a.createElement("div",{className:"mx_VerificationShowSas_decimalSas"},s),t=this.props.isSelf?Object(c.a)("Verify this session by confirming the following number appears on its screen."):Object(c.a)("Verify this user by confirming the following number appears on their screen.")}}if(this.state.pending&&this.props.isSelf){let e;e=this.props.device?Object(c.a)("Waiting for you to verify on your other session, %(deviceName)s (%(deviceId)s)…",{deviceName:this.props.device?this.props.device.getDisplayName():"",deviceId:this.props.device?this.props.device.deviceId:""}):Object(c.a)("Waiting for you to verify on your other session…"),s=r.a.createElement("p",null,e)}else if(this.state.pending||this.state.cancelling){let e;if(this.state.pending){const{displayName:t}=this.props;e=Object(c.a)("Waiting for %(displayName)s to verify…",{displayName:t})}else e=Object(c.a)("Cancelling…");s=r.a.createElement(l.a,{text:e})}else s=r.a.createElement("div",{className:"mx_VerificationShowSas_buttonRow"},r.a.createElement(d.a,{onClick:this.onDontMatchClick,kind:"danger"},Object(c.a)("They don't match")),r.a.createElement(d.a,{onClick:this.onMatchClick,kind:"primary"},Object(c.a)("They match")));return r.a.createElement("div",{className:"mx_VerificationShowSas"},r.a.createElement("p",null,t),e,r.a.createElement("p",null,this.props.isSelf?"":Object(c.a)("To be secure, do this in person or use a trusted way to communicate.")),s)}})||n;Object(c.b)("Dog"),Object(c.b)("Cat"),Object(c.b)("Lion"),Object(c.b)("Horse"),Object(c.b)("Unicorn"),Object(c.b)("Pig"),Object(c.b)("Elephant"),Object(c.b)("Rabbit"),Object(c.b)("Panda"),Object(c.b)("Rooster"),Object(c.b)("Penguin"),Object(c.b)("Turtle"),Object(c.b)("Fish"),Object(c.b)("Octopus"),Object(c.b)("Butterfly"),Object(c.b)("Flower"),Object(c.b)("Tree"),Object(c.b)("Cactus"),Object(c.b)("Mushroom"),Object(c.b)("Globe"),Object(c.b)("Moon"),Object(c.b)("Cloud"),Object(c.b)("Fire"),Object(c.b)("Banana"),Object(c.b)("Apple"),Object(c.b)("Strawberry"),Object(c.b)("Corn"),Object(c.b)("Pizza"),Object(c.b)("Cake"),Object(c.b)("Heart"),Object(c.b)("Smiley"),Object(c.b)("Robot"),Object(c.b)("Hat"),Object(c.b)("Glasses"),Object(c.b)("Spanner"),Object(c.b)("Santa"),Object(c.b)("Thumbs up"),Object(c.b)("Umbrella"),Object(c.b)("Hourglass"),Object(c.b)("Clock"),Object(c.b)("Gift"),Object(c.b)("Light bulb"),Object(c.b)("Book"),Object(c.b)("Pencil"),Object(c.b)("Paperclip"),Object(c.b)("Scissors"),Object(c.b)("Lock"),Object(c.b)("Key"),Object(c.b)("Hammer"),Object(c.b)("Telephone"),Object(c.b)("Flag"),Object(c.b)("Train"),Object(c.b)("Bicycle"),Object(c.b)("Aeroplane"),Object(c.b)("Rocket"),Object(c.b)("Trophy"),Object(c.b)("Ball"),Object(c.b)("Guitar"),Object(c.b)("Trumpet"),Object(c.b)("Bell"),Object(c.b)("Anchor"),Object(c.b)("Headphones"),Object(c.b)("Folder"),Object(c.b)("Pin")},function(e,t,s){"use strict";s.d(t,"a",(function(){return p})),s.d(t,"b",(function(){return g}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a),r=s(225),c=s(86),l=s(188),d=s(90),h=s(242),u=s(84),m=s(1);let p;!function(e){e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e[e.ConfirmReset=6]="ConfirmReset"}(p||(p={}));class g extends o.a{constructor(...e){super(...e),i()(this,"started",void 0),i()(this,"phase",void 0),i()(this,"verificationRequest",void 0),i()(this,"backupInfo",void 0),i()(this,"keyId",void 0),i()(this,"keyInfo",void 0),i()(this,"hasDevicesToVerifyAgainst",void 0),i()(this,"onUserTrustStatusChanged",e=>{if(e!==c.a.get().getUserId())return;c.a.get().getCrossSigningId()&&(this.phase=p.Done,this.emit("update"))}),i()(this,"onVerificationRequest",e=>{this.setActiveVerificationRequest(e)}),i()(this,"onVerificationRequestChange",()=>{if(this.verificationRequest.cancelled)this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if(this.verificationRequest.phase===r.c){this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null;const e=c.a.get().getCrossSigningId();this.phase=e?p.Done:p.Busy,this.emit("update")}})}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new g),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=p.Loading,this.verificationRequest=null,this.backupInfo=null,this.keyId=null,this.keyInfo=null;const e=c.a.get();e.on("crypto.verification.request",this.onVerificationRequest),e.on("userTrustStatusChanged",this.onUserTrustStatusChanged);const t=e.getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){this.started&&(this.started=!1,this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),c.a.get()&&(c.a.get().removeListener("crypto.verification.request",this.onVerificationRequest),c.a.get().removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged)))}async fetchKeyInfo(){const e=c.a.get(),t=await e.isSecretStored("m.cross_signing.master",!1);null===t||0===Object.keys(t).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(t)[0],this.keyInfo=t[this.keyId]);const s=await e.getDehydratedDevice(),n=e.getUserId(),i=e.getStoredCrossSigningForUser(n);this.hasDevicesToVerifyAgainst=e.getStoredDevicesForUser(n).some(e=>e.getIdentityKey()&&(!s||e.deviceId!=s.device_id)&&i.checkDeviceTrust(i,e,!1,!0).isCrossSigningVerified()),this.phase=p.Intro,this.emit("update")}async usePassPhrase(){this.phase=p.Busy,this.emit("update");const e=c.a.get();try{const t=await e.getKeyBackupVersion();this.backupInfo=t,this.emit("update"),await new Promise((s,n)=>{Object(l.b)(async()=>{await e.checkOwnCrossSigningTrust(),s(),t&&await e.restoreKeyBackupWithSecretStorage(t)}).catch(n)}),e.getCrossSigningId()&&(this.phase=p.Done,this.emit("update"))}catch(e){e instanceof l.a||m.a.log(e),this.phase=p.Intro,this.emit("update")}}skip(){this.phase=p.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=p.Finished,this.emit("update")}returnAfterSkip(){this.phase=p.Intro,this.emit("update")}reset(){this.phase=p.ConfirmReset,this.emit("update")}async resetConfirm(){try{await Object(l.b)(async()=>{const e=c.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:s}=d.a.createTrackedDialog("Cross-signing keys dialog","",h.a,{title:Object(u.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.phase=p.Finished},!0)}catch(e){m.a.error("Error resetting cross-signing",e),this.phase=p.Intro}this.emit("update")}returnAfterReset(){this.phase=p.Intro,this.emit("update")}done(){this.phase=p.Finished,this.emit("update"),c.a.get().crypto.cancelAndResendAllOutgoingKeyRequests()}async setActiveVerificationRequest(e){e.otherUserId===c.a.get().getUserId()&&(this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on("change",this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}},function(e,t,s){"use strict";function n(e){const t=e.embeddedPages;let s=null==t?void 0:t.homeUrl;return s||(s=e.welcomePageUrl),s}function i(e){const t=e.embeddedPages;return!0===(null==t?void 0:t.loginForWelcome)}s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return B})),s.d(t,"b",(function(){return V}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(127),l=s(86),d=s(87),h=s(90),u=s(138),m=s(84),p=s(93),g=s(828),v=s(140),f=s(829),b=s(89),y=s(190),E=s(131),S=s(183),_=s(124),w=s(85),C=s(103),O=s(88),k=s(125),R=s(104),I=s(113),x=s(97),T=s(830),j=s(328),N=s(96),P=s(180),D=s(1),M=s(92);function A(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function U(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?A(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):A(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const L="mx_last_room_directory_instance";function F(e){v.a.trackEvent("RoomDirectory",e)}let B=Object(w.a)("structures.RoomDirectory")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"startTime",void 0),a()(this,"unmounted",!1),a()(this,"nextBatch",null),a()(this,"filterTimeout",void 0),a()(this,"protocols",void 0),a()(this,"refreshRoomList",()=>{this.state.selectedCommunityId?this.setState({publicRooms:E.a.getGroupRooms(this.state.selectedCommunityId).map(e=>({room_id:e.roomId,name:e.name,topic:e.topic,canonical_alias:e.canonicalAlias,num_joined_members:e.numJoinedMembers,avatarUrl:e.avatarUrl,world_readable:e.worldReadable,guest_can_join:e.guestsCanJoin})).filter(e=>{const t=this.state.filterString;if(t){const s=e=>(e||"").toLowerCase().includes(t.toLowerCase());return s(e.name)||s(e.topic)||s(e.canonical_alias)}return!0}),loading:!1}):(this.nextBatch=null,this.setState({publicRooms:[],loading:!0}),this.getMoreRooms())}),a()(this,"onRoomClicked",(e,t)=>{t.shiftKey&&!this.state.selectedCommunityId&&(t.preventDefault(),this.removeFromDirectory(e))}),a()(this,"onOptionChange",(e,t)=>{this.nextBatch=null,this.setState({publicRooms:[],roomServer:e,instanceId:t,error:null},this.refreshRoomList),localStorage.setItem("mx_last_room_directory_server",e),t?localStorage.setItem(L,t):localStorage.removeItem(L)}),a()(this,"onFillRequest",e=>e||!this.nextBatch?Promise.resolve(!1):this.getMoreRooms()),a()(this,"onFilterChange",e=>{this.setState({filterString:e||""}),this.filterTimeout&&clearTimeout(this.filterTimeout),this.filterTimeout=setTimeout(()=>{this.filterTimeout=null,this.refreshRoomList()},700)}),a()(this,"onFilterClear",()=>{this.setState({filterString:""},this.refreshRoomList),this.filterTimeout&&clearTimeout(this.filterTimeout)}),a()(this,"onJoinFromSearchClick",e=>{if(this.state.instanceId&&this.state.instanceId!==f.a){const t=Object(g.b)(this.protocols,this.state.instanceId),s=Object(g.a)(this.protocols,this.state.instanceId),n=t?this.getFieldsForThirdPartyLocation(e,this.protocols[t],s):null;if(!n){const e=p.a.get().brand;return void h.a.createTrackedDialog("Unable to join network","",R.a,{title:Object(m.a)("Unable to join network"),description:Object(m.a)("%(brand)s does not know how to join a room on this network",{brand:e})})}l.a.get().getThirdpartyLocation(t,n).then(e=>{e.length>0&&e[0].alias?this.showRoomAlias(e[0].alias,!0):h.a.createTrackedDialog("Room not found","",R.a,{title:Object(m.a)("Room not found"),description:Object(m.a)("Couldn't find a matching Matrix room")})},e=>{h.a.createTrackedDialog("Fetching third party location failed","",R.a,{title:Object(m.a)("Fetching third party location failed"),description:Object(m.a)("Unable to look up room ID from server")})})}else-1==e.indexOf(":")&&(e=e+":"+this.state.roomServer),this.showRoomAlias(e,!0)}),a()(this,"onPreviewClick",(e,t)=>{this.showRoom(t,null,!1,!0),e.stopPropagation()}),a()(this,"onViewClick",(e,t)=>{this.showRoom(t),e.stopPropagation()}),a()(this,"onJoinClick",(e,t)=>{this.showRoom(t,null,!0),e.stopPropagation()}),a()(this,"onCreateRoomClick",()=>{this.onFinished(),d.a.dispatch({action:"view_create_room",public:!0,defaultName:this.state.filterString.trim()})}),a()(this,"onFinished",()=>{_.a.instance.trackRoomDirectory(this.startTime),this.props.onFinished(!1)}),_.a.instance.trackRoomDirectoryBegin(),this.startTime=_.a.getTimestamp();const t=b.b.getValue("feature_communities_v2_prototypes")?y.a.getSelectedTags()[0]:null;let s=!0;l.a.get()?t?(s=!1,S.a.getGroupProfileCached(l.a.get(),this.state.selectedCommunityId).then(e=>{this.setState({communityName:e.name})})):l.a.get().getThirdpartyProtocols().then(e=>{var t,s,n;this.protocols=e;const i=l.a.getHomeserverName(),a=localStorage.getItem("mx_last_room_directory_server"),o=localStorage.getItem(L);let r=i;(null!==(t=p.a.get().roomDirectory)&&void 0!==t&&null!==(s=t.servers)&&void 0!==s&&s.includes(a)||null!==(n=b.b.getValue("room_directory_servers"))&&void 0!==n&&n.includes(a))&&(r=a);let c=null;if(r!==i||o!==f.a&&!Object.values(this.protocols).some(e=>e.instances.some(e=>e.instance_id===o))||(c=o),this.state.instanceId!==c||this.state.roomServer!==r)return this.setState({protocolsLoading:!1,instanceId:c,roomServer:r}),void this.refreshRoomList();this.setState({protocolsLoading:!1})},e=>{if(D.a.warn("error loading third party protocols: "+e),this.setState({protocolsLoading:!1}),l.a.get().isGuest())return;F("Failed to get protocol list from homeserver");const t=p.a.get().brand;this.setState({error:Object(m.a)("%(brand)s failed to get the protocol list from the homeserver. The homeserver may be too old to support third party networks.",{brand:t})})}):s=!1,this.state={publicRooms:[],loading:!0,error:null,instanceId:localStorage.getItem(L),roomServer:localStorage.getItem("mx_last_room_directory_server"),filterString:this.props.initialText||"",selectedCommunityId:t,communityName:null,protocolsLoading:s}}componentDidMount(){this.refreshRoomList()}componentWillUnmount(){this.filterTimeout&&clearTimeout(this.filterTimeout),this.unmounted=!0}getMoreRooms(){if(this.state.selectedCommunityId)return Promise.resolve(!1);if(!l.a.get())return Promise.resolve(!1);this.setState({loading:!0});const e=this.state.filterString,t=this.state.roomServer,s=this.nextBatch,n={limit:20};return t!=l.a.getHomeserverName()&&(n.server=t),this.state.instanceId===f.a?n.include_all_networks=!0:this.state.instanceId&&(n.third_party_instance_id=this.state.instanceId),this.nextBatch&&(n.since=this.nextBatch),e&&(n.filter={generic_search_term:e}),l.a.get().publicRooms(n).then(n=>{if(e!=this.state.filterString||t!=this.state.roomServer||s!=this.nextBatch)return!1;if(this.unmounted)return!1;if(this.state.filterString){const e=n.total_room_count_estimate||n.chunk.length;_.a.instance.trackRoomDirectorySearch(e,this.state.filterString)}return this.nextBatch=n.next_batch,this.setState(e=>U(U({},e),{},{publicRooms:[...e.publicRooms,...n.chunk||[]],loading:!1})),Boolean(n.next_batch)},n=>{if(e!=this.state.filterString||t!=this.state.roomServer||s!=this.nextBatch)return!1;if(this.unmounted)return!1;D.a.error("Failed to get publicRooms: %s",JSON.stringify(n)),F("Failed to get public room list");const i=p.a.get().brand;this.setState({loading:!1,error:Object(m.a)("%(brand)s failed to get the public room list.",{brand:i})+(n&&n.message)?n.message:Object(m.a)("The homeserver may be unavailable or overloaded.")})})}removeFromDirectory(e){const t=V(e),s=e.name||t||Object(m.a)("Unnamed room");let n;n=t?Object(m.a)("Delete the room address %(alias)s and remove %(name)s from the directory?",{alias:t,name:s}):Object(m.a)("Remove %(name)s from the directory?",{name:s}),h.a.createTrackedDialog("Remove from Directory","",I.a,{title:Object(m.a)("Remove from Directory"),description:n,onFinished:n=>{if(!n)return;const i=h.a.createDialog(N.a);let a=Object(m.a)("remove %(name)s from the directory.",{name:s});l.a.get().setRoomDirectoryVisibility(e.room_id,c.f.Private).then(()=>{if(t)return a=Object(m.a)("delete the address."),l.a.get().deleteAlias(t)}).then(()=>{i.close(),this.refreshRoomList()},e=>{i.close(),this.refreshRoomList(),D.a.error("Failed to "+a+": "+e),h.a.createTrackedDialog("Remove from Directory Error","",R.a,{title:Object(m.a)("Error"),description:e&&e.message?e.message:Object(m.a)("The server may be unavailable or overloaded")})})}})}showRoomAlias(e,t=!1){this.showRoom(null,e,t)}showRoom(e,t,s=!1,n=!1){this.onFinished();const i={action:M.a.ViewRoom,auto_join:s,should_peek:n,_type:"room_directory"};if(e){if(l.a.get().isGuest()&&!e.world_readable&&!e.guest_can_join)return void d.a.dispatch({action:"require_registration"});t||(t=V(e)),i.oob_data={avatarUrl:e.avatar_url,name:e.name||t||Object(m.a)("Unnamed room")},this.state.roomServer&&(i.via_servers=[this.state.roomServer],i.opts={viaServers:[this.state.roomServer]})}t?i.room_alias=t:i.room_id=e.room_id,d.a.dispatch(i)}createRoomCells(e){const t=l.a.get(),s=t.getRoom(e.room_id),n=s&&"join"===s.getMyMembership(),i=t.isGuest();let a,o;n||!e.world_readable&&!i||(a=r.a.createElement(O.a,{kind:"secondary",onClick:t=>this.onPreviewClick(t,e)},Object(m.a)("Preview"))),n?o=r.a.createElement(O.a,{kind:"secondary",onClick:t=>this.onViewClick(t,e)},Object(m.a)("View")):i||(o=r.a.createElement(O.a,{kind:"primary",onClick:t=>this.onJoinClick(t,e)},Object(m.a)("Join")));let c=e.name||V(e)||Object(m.a)("Unnamed room");c.length>80&&(c=c.substring(0,80)+"...");let d=e.topic||"";d.length>800&&(d=d.substring(0,800)+"..."),d=Object(u.f)(d);let h=null;return e.avatar_url&&(h=Object(C.b)(e.avatar_url).getSquareThumbnailHttp(32)),r.a.createElement("div",{key:e.room_id,role:"listitem",className:"mx_RoomDirectory_listItem"},r.a.createElement("div",{onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_roomAvatar"},r.a.createElement(k.a,{width:32,height:32,resizeMethod:"crop",name:c,idName:c,url:h})),r.a.createElement("div",{onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_roomDescription"},r.a.createElement("div",{className:"mx_RoomDirectory_name",onMouseDown:t=>this.onRoomClicked(e,t)},c)," ",r.a.createElement("div",{className:"mx_RoomDirectory_topic",onMouseDown:t=>this.onRoomClicked(e,t),dangerouslySetInnerHTML:{__html:d}}),r.a.createElement("div",{className:"mx_RoomDirectory_alias",onMouseDown:t=>this.onRoomClicked(e,t)},V(e))),r.a.createElement("div",{onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_roomMemberCount"},e.num_joined_members),r.a.createElement("div",{onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_preview"},a),r.a.createElement("div",{onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_join"},o))}stringLooksLikeId(e,t){let s=/^#[^\s]+:[^\s]/;return t&&t.regexp&&(s=new RegExp(t.regexp)),s.test(e)}getFieldsForThirdPartyLocation(e,t,s){const n=t.location_fields;if(!n)return null;const i={};for(let e=0;e<n.length-1;++e){const t=n[e];if(void 0===s.fields[t])return null;i[t]=s.fields[t]}return i[n[n.length-1]]=e,i}render(){let e,t;if(this.state.error)e=this.state.error;else if(this.state.protocolsLoading)e=r.a.createElement(N.a,null);else{const t=(this.state.publicRooms||[]).reduce((e,t)=>e.concat(this.createRoomCells(t)),[]);let s;this.state.loading&&(s=r.a.createElement(N.a,null));const n=r.a.createElement(r.a.Fragment,null,r.a.createElement("hr",null),r.a.createElement(O.a,{kind:"primary",onClick:this.onCreateRoomClick,className:"mx_RoomDirectory_newRoom"},Object(m.a)("Create new room")));let i,a;0!==t.length||this.state.loading?(i=r.a.createElement("div",{className:"mx_RoomDirectory_table"},t),this.state.loading||this.nextBatch||(a=n)):a=r.a.createElement(r.a.Fragment,null,r.a.createElement("h5",null,Object(m.a)('No results for "%(query)s"',{query:this.state.filterString.trim()})),r.a.createElement("p",null,Object(m.a)("Try different words or check for typos. Some results may not be visible as they're private and you need an invite to join them.")),n),e=r.a.createElement(j.a,{className:"mx_RoomDirectory_tableWrapper",onFillRequest:this.onFillRequest,stickyBottom:!1,startAtBottom:!1},i,s,a&&r.a.createElement("div",{className:"mx_RoomDirectory_footer"},a))}if(!this.state.protocolsLoading){const e=Object(g.b)(this.protocols,this.state.instanceId);let s;if(e&&this.protocols&&this.protocols[e]&&this.protocols[e].location_fields.length>0&&this.protocols[e].field_types){const t=this.protocols[e].location_fields.slice(-1)[0];s=this.protocols[e].field_types[t]}let n=Object(m.a)("Find a room…");this.state.instanceId&&this.state.instanceId!==f.a?s&&(n=s.placeholder):n=Object(m.a)("Find a room… (e.g. %(exampleRoom)s)",{exampleRoom:"#example:"+this.state.roomServer});let i=this.stringLooksLikeId(this.state.filterString,s);if(e){const t=Object(g.a)(this.protocols,this.state.instanceId);null===this.getFieldsForThirdPartyLocation(this.state.filterString,this.protocols[e],t)&&(i=!1)}let a=r.a.createElement(f.b,{protocols:this.protocols,onOptionChange:this.onOptionChange,selectedServerName:this.state.roomServer,selectedInstanceId:this.state.instanceId});this.state.selectedCommunityId&&(a=null),t=r.a.createElement("div",{className:"mx_RoomDirectory_listheader"},r.a.createElement(T.a,{className:"mx_RoomDirectory_searchbox",onChange:this.onFilterChange,onClear:this.onFilterClear,onJoinClick:this.onJoinFromSearchClick,placeholder:n,showJoinButton:i,initialText:this.props.initialText}),a)}const s=Object(m.a)("If you can't find the room you're looking for, ask for an invite or <a>Create a new room</a>.",null,{a:e=>r.a.createElement(O.a,{kind:"secondary",onClick:this.onCreateRoomClick},e)}),n=this.state.selectedCommunityId?Object(m.a)("Explore rooms in %(communityName)s",{communityName:this.state.communityName||this.state.selectedCommunityId}):Object(m.a)("Explore rooms");return r.a.createElement(x.a,{className:"mx_RoomDirectory_dialog",hasCancel:!0,onFinished:this.onFinished,title:n},r.a.createElement("div",{className:"mx_RoomDirectory"},s,r.a.createElement("div",{className:"mx_RoomDirectory_list"},t,e)))}})||n;function V(e){return Object(P.b)(e.canonical_alias,e.aliases)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n,i=s(82),a=s.n(i),o=s(85);let r=Object(o.a)("views.auth.CompleteSecurityBody")(n=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n);t.a=({vertical:e,reverse:t,id:s,passRef:n})=>{const a=["mx_ResizeHandle"];return e?a.push("mx_ResizeHandle_vertical"):a.push("mx_ResizeHandle_horizontal"),t&&a.push("mx_ResizeHandle_reverse"),i.a.createElement("div",{ref:n,className:a.join(" "),"data-id":s},i.a.createElement("div",null))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(838),i=s(397);class a extends n.a{start(e){this.vertical?e.style.minHeight=null:e.style.minWidth=null}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const s=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=s,e.style.height=s}else{const s=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=s,e.style.width=s}}}class o extends i.a{static createSizer(e,t,s){return new a(e,t,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(83),i=s.n(n),a=s(112);class o{constructor(e,t,s){this.container=e,this.distributorCtor=t,this.config=s,i()(this,"classNames",void 0),i()(this,"onMouseDown",e=>{var t;const s=e.target&&e.target.closest("."+this.classNames.handle),n=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!s||!n&&s.parentElement!==this.container||n&&s!==n)return;var i,a;(e.preventDefault(),this.classNames.resizing)&&(null===(i=this.container)||void 0===i||null===(a=i.classList)||void 0===a||a.add(this.classNames.resizing));this.config.onResizeStart&&this.config.onResizeStart();const{sizer:o,distributor:r}=this.createSizerAndDistributor(s);r.start();const c=e=>{const t=o.offsetFromEvent(e);r.resizeFromContainerOffset(t)},l=document.body,d=()=>{var e,t;this.classNames.resizing&&(null===(e=this.container)||void 0===e||null===(t=e.classList)||void 0===t||t.remove(this.classNames.resizing));r.finish(),this.config.onResizeStop&&this.config.onResizeStop(),l.removeEventListener("mouseup",d,!1),document.removeEventListener("mouseleave",d,!1),l.removeEventListener("mousemove",c,!1)};l.addEventListener("mouseup",d,!1),document.addEventListener("mouseleave",d,!1),l.addEventListener("mousemove",c,!1)}),i()(this,"onResize",Object(a.throttle)(()=>{const e=this.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())},100,{trailing:!0,leading:!0})),i()(this,"getDistributors",()=>this.getResizeHandles().map(e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})),this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t,s;(null!==(e=null==this||null===(t=this.config)||void 0===t||null===(s=t.handler)||void 0===s?void 0:s.parentElement)&&void 0!==e?e:this.container).addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t,s;(null!==(e=null==this||null===(t=this.config)||void 0===t||null===(s=t.handler)||void 0===s?void 0:s.parentElement)&&void 0!==e?e:this.container).removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find(t=>t.getAttribute("data-id")===e);if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e&&e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e&&e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){const t=e.classList.contains(this.classNames.vertical),s=this.isReverseResizeHandle(e),n=this.distributorCtor,i=this.config&&this.config.handler?this.container:void 0,a=n.createSizer(this.container,t,s),o=n.createItem(e,this,a,i);return{sizer:a,distributor:new n(o)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll("."+this.classNames.handle)):[]}}},function(e,t,s){"use strict";var n=s(82),i=s(128),a=s(548),o=s(84),r=s(93),c=s(107),l=s(87),d=s(92),h=s(125),u=s(228),m=s(88),p=s(123),g=s(135),v=s(98),f=s(555),b=s(140),y=s(124);const E=()=>{b.a.trackEvent("home_page","button","dm"),y.a.instance.track("home_page_button",{button:"dm"}),l.a.dispatch({action:"view_create_chat"})},S=()=>{b.a.trackEvent("home_page","button","room_directory"),y.a.instance.track("home_page_button",{button:"room_directory"}),l.a.fire(d.a.ViewRoomDirectory)},_=()=>{b.a.trackEvent("home_page","button","create_room"),y.a.instance.track("home_page_button",{button:"create_room"}),l.a.dispatch({action:"view_create_room"})},w=e=>({displayName:u.a.instance.displayName||e,avatarUrl:u.a.instance.getHttpAvatarUrl(f.a)}),C=()=>{const e=Object(n.useContext)(v.a),t=e.getUserId(),[s,i]=Object(n.useState)(w(t));return Object(g.a)(u.a.instance,p.b,()=>{i(w(t))}),n.createElement("div",null,n.createElement(f.b,{hasAvatar:!!s.avatarUrl,hasAvatarLabel:Object(o.a)("Great, that'll help people know it's you"),noAvatarLabel:Object(o.a)("Add a photo so people know it's you."),setAvatarUrl:t=>e.setAvatarUrl(t)},n.createElement(h.a,{idName:t,name:s.displayName,url:s.avatarUrl,width:f.a,height:f.a,resizeMethod:"crop"})),n.createElement("h1",null,Object(o.a)("Welcome %(name)s",{name:s.displayName})),n.createElement("h4",null,Object(o.a)("Now, let's help you get started")))};t.a=({justRegistered:e=!1})=>{const t=r.a.get(),s=Object(a.a)(t);if(s){const e=c.getComponent("structures.EmbeddedPage");return n.createElement(e,{className:"mx_HomePage",url:s,scrollbar:!0})}let l;if(e)l=n.createElement(C,null);else{const e=t.branding;let s="themes/element/img/logos/element-logo.svg";e&&e.authHeaderLogoUrl&&(s=e.authHeaderLogoUrl),l=n.createElement(n.Fragment,null,n.createElement("img",{src:s,alt:t.brand}),n.createElement("h1",null,Object(o.a)("Welcome to %(appName)s",{appName:t.brand})),n.createElement("h4",null,Object(o.a)("Own your conversations.")))}return n.createElement(i.a,{className:"mx_HomePage mx_HomePage_default"},n.createElement("div",{className:"mx_HomePage_default_wrapper"},l,n.createElement("div",{className:"mx_HomePage_default_buttons"},n.createElement(m.a,{onClick:E,className:"mx_HomePage_button_sendDm"},Object(o.a)("Send a Direct Message")),n.createElement(m.a,{onClick:S,className:"mx_HomePage_button_explore"},Object(o.a)("Explore Public Rooms")),n.createElement(m.a,{onClick:_,className:"mx_HomePage_button_createGroup"},Object(o.a)("Create a Group Chat")))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(82),i=s.n(n),a=s(94),o=s(91),r=s.n(o),c=s(88),l=s(96),d=s(98),h=s(839),u=s(140),m=s(124),p=s(118);const g=52;t.b=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:s,setAvatarUrl:o,children:g})=>{const v=Object(n.useContext)(d.a),[f,b]=Object(n.useState)(!1),[y,E]=Object(n.useState)(!1),[S,_]=Object(n.useState)(!1);Object(h.b)(()=>{_(!0)},3e3),Object(h.b)(()=>{_(!1)},13e3);const w=Object(n.useRef)(),C=e||f?t:s,{room:O}=Object(n.useContext)(p.b);if(!(null==O?void 0:O.currentState.maySendStateEvent(a.a.RoomAvatar,v.getUserId())))return i.a.createElement(i.a.Fragment,null,g);const k=!!C&&(y||S);return i.a.createElement(i.a.Fragment,null,i.a.createElement("input",{type:"file",ref:w,className:"mx_MiniAvatarUploader_input",onChange:async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;b(!0),u.a.trackEvent("mini_avatar","upload"),m.a.instance.track("mini_avatar_upload");const s=e.target.files[0],n=await v.uploadContent(s);await o(n),b(!1)},accept:"image/*"}),i.a.createElement(c.a,{className:r()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:f,mx_MiniAvatarUploader_hasAvatar:e}),disabled:f,onClick:()=>{w.current.click()},onMouseOver:()=>E(!0),onMouseLeave:()=>E(!1)},g,i.a.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},f?i.a.createElement(l.a,{w:20,h:20}):i.a.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})),i.a.createElement("div",{className:r()("mx_Tooltip",{mx_Tooltip_visible:k,mx_Tooltip_invisible:!k})},i.a.createElement("div",{className:"mx_Tooltip_chevron"}),C)))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(90),h=s(87),u=s(84),m=s(86),p=s(275),g=s(85),v=s(1),f=s(113),b=s(97),y=s(96),E=s(109);let S=Object(g.a)("views.dialogs.LogoutDialog")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onSettingsLinkClick",()=>{this.props.onFinished(!0)}),r()(this,"onExportE2eKeysClicked",()=>{d.a.createTrackedDialogAsync("Export E2E Keys","",s.e(5).then(s.bind(null,589)),{matrixClient:m.a.get()})}),r()(this,"onFinished",e=>{e&&h.a.dispatch({action:"logout"}),this.props.onFinished(e)}),r()(this,"onSetRecoveryMethodClick",()=>{this.state.backupInfo?d.a.createTrackedDialog("Restore Backup","",p.a,null,null,!1,!0):d.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(6).then(s.bind(null,591)),null,null,!1,!0),this.props.onFinished(!0)}),r()(this,"onLogoutConfirm",()=>{h.a.dispatch({action:"logout"}),this.props.onFinished(!0)});const t=m.a.get(),n=t.isCryptoEnabled()&&!t.getKeyBackupEnabled();this.state={shouldLoadBackupStatus:n,loading:n,backupInfo:null,error:null},n&&this.loadBackupStatus()}async loadBackupStatus(){try{const e=await m.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){v.a.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}render(){if(this.state.shouldLoadBackupStatus){const e=l.a.createElement("div",null,l.a.createElement("p",null,Object(u.a)("Encrypted messages are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.")),l.a.createElement("p",null,Object(u.a)("Back up your keys before signing out to avoid losing them.")));let t;if(this.state.loading)t=l.a.createElement(y.a,null);else{let s;s=this.state.backupInfo?Object(u.a)("Connect this session to Key Backup"):Object(u.a)("Start using Key Backup"),t=l.a.createElement("div",null,l.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),l.a.createElement(E.a,{primaryButton:s,hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},l.a.createElement("button",{onClick:this.onLogoutConfirm},Object(u.a)("I don't want my encrypted messages"))),l.a.createElement("details",null,l.a.createElement("summary",null,Object(u.a)("Advanced")),l.a.createElement("p",null,l.a.createElement("button",{onClick:this.onExportE2eKeysClicked},Object(u.a)("Manually export keys")))))}return l.a.createElement(b.a,{title:Object(u.a)("You'll lose access to your encrypted messages"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},t)}return l.a.createElement(f.a,{hasCancelButton:!0,title:Object(u.a)("Sign out"),description:Object(u.a)("Are you sure you want to sign out?"),button:Object(u.a)("Sign out"),onFinished:this.onFinished})}},r()(i,"defaultProps",{onFinished:function(){}}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(87),o=s(123);class r extends o.a{constructor(){super(a.a,{hostSignupActive:!1})}static get instance(){return r.internalInstance}get isHostSignupActive(){return this.state.hostSignupActive}async setHostSignupActive(e){return this.updateState({hostSignupActive:e})}onDispatch(e){}}i()(r,"internalInstance",new r)},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(125),u=s(103);const m=["app","className","width","height"];t.a=e=>{let{app:t,className:n,width:a=20,height:r=20}=e,l=o()(e,m),p=[s(1570)];return t.type.includes("jitsi")?p=[s(1571)]:t.type.includes("meeting")||t.type.includes("calendar")?p=[s(1572)]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?p=[s(1573)]:t.type.includes("clock")&&(p=[s(1574)]),c.a.createElement(h.a,i()({},l,{name:t.id,className:d()("mx_WidgetAvatar",n),url:t.avatar_url?Object(u.b)(t.avatar_url).getSquareThumbnailHttp(20):void 0,urls:p,width:a,height:r}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return x}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(87),l=s(151),d=s(86),h=s(84),u=s(560),m=s(126),p=s(163),g=s(91),v=s.n(g),f=s(88),b=s(108),y=s(199),E=s(85),S=s(859),_=s(90),w=s(423),C=s(860),O=s(861),k=s(862);function R(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function I(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}let x=Object(E.a)("views.voip.CallView")(n=class e extends r.a.Component{constructor(t){super(t),a()(this,"dispatcherRef",void 0),a()(this,"contentRef",Object(o.createRef)()),a()(this,"buttonsRef",Object(o.createRef)()),a()(this,"onAction",e=>{switch(e.action){case"video_fullscreen":if(!this.contentRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentRef.current):R()&&I()}}),a()(this,"onCallState",e=>{this.setState({callState:e})}),a()(this,"onFeedsChanged",t=>{const{primary:s,secondary:n}=e.getOrderedFeeds(t);this.setState({primaryFeed:s,secondaryFeeds:n,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})}),a()(this,"onCallLocalHoldUnhold",()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})}),a()(this,"onCallRemoteHoldUnhold",()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})}),a()(this,"onMouseMove",()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()}),a()(this,"onMicMuteClick",async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})}),a()(this,"onVidMuteClick",async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})}),a()(this,"onScreenshareClick",async()=>{let e;var t;if(this.state.screensharing)e=await this.props.call.setScreensharingEnabled(!1);else if(null!==(t=window.electron)&&void 0!==t&&t.getDesktopCapturerSources){const{finished:t}=_.a.createDialog(S.a),[s]=await t;if(!s)return;e=await this.props.call.setScreensharingEnabled(!0,s)}else e=await this.props.call.setScreensharingEnabled(!0);this.setState({sidebarShown:!0,screensharing:e})}),a()(this,"onNativeKeyDown",e=>{let t=!1;const s=Object(b.d)(e);switch(e.key){case b.a.D:var n;if(s)this.onMicMuteClick(),null===(n=this.buttonsRef.current)||void 0===n||n.showControls(),t=!0;break;case b.a.E:var i;if(s)this.onVidMuteClick(),null===(i=this.buttonsRef.current)||void 0===i||i.showControls(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}),a()(this,"onCallResumeClick",()=>{const e=l.d.sharedInstance().roomIdForCall(this.props.call);l.d.sharedInstance().setActiveCallRoomId(e)}),a()(this,"onTransferClick",()=>{const e=l.d.sharedInstance().getTransfereeForCallId(this.props.call.callId);this.props.call.transferToCall(e)}),a()(this,"onHangupClick",()=>{c.a.dispatch({action:"hangup",room_id:l.d.sharedInstance().roomIdForCall(this.props.call)})}),a()(this,"onToggleSidebar",()=>{this.setState({sidebarShown:!this.state.sidebarShown})});const{primary:s,secondary:n}=e.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,controlsVisible:!0,hoveringControls:!1,showMoreMenu:!1,showDialpad:!1,primaryFeed:s,secondaryFeeds:n,sidebarShown:!0},this.updateCallListeners(null,this.props.call)}componentDidMount(){this.dispatcherRef=c.a.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){R()&&I(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),c.a.unregister(this.dispatcherRef)}static getDerivedStateFromProps(t){const{primary:s,secondary:n}=e.getOrderedFeeds(t.call.getFeeds());return{primaryFeed:s,secondaryFeeds:n}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(p.c.State,this.onCallState),e.removeListener(p.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(p.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(p.c.FeedsChanged,this.onFeedsChanged)),t&&(t.on(p.c.State,this.onCallState),t.on(p.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(p.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(p.c.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){let t;const s=e.filter(e=>e.purpose===w.b.Screenshare);t=s.find(e=>!e.isLocal())||s[0],t||(t=e.find(e=>!e.isLocal()));const n=[...e];return t&&n.splice(n.indexOf(t),1),n.sort((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0),{primary:t,secondary:n}}renderCallControls(){var e;const t=this.props.call.type===p.f.Video,s=(this.props.call.opponentSupportsSDPStreamMetadata()||this.props.call.type===p.f.Video)&&this.props.call.state===p.e.Connected,n=(null===(e=this.state.primaryFeed)||void 0===e?void 0:e.purpose)===w.b.Screenshare||this.props.call.isScreensharing(),i=this.state.callState===p.e.Connected,a=this.state.callState===p.e.Connected&&this.props.call.opponentSupportsDTMF();return r.a.createElement(k.a,{ref:this.buttonsRef,call:this.props.call,pipMode:this.props.pipMode,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:this.state.micMuted,vidMuted:this.state.vidMuted,sidebarShown:this.state.sidebarShown,screensharing:this.state.screensharing},buttonsVisibility:{vidMute:t,screensharing:s,sidebar:n,contextMenu:i,dialpad:a}})}render(){const e=d.a.get(),t=l.d.sharedInstance().roomIdForCall(this.props.call),s=l.d.sharedInstance().roomIdForCall(this.props.secondaryCall),n=e.getRoom(t),i=this.props.secondaryCall?e.getRoom(s):null,a=this.props.pipMode?76:160,o=l.d.sharedInstance().getTransfereeForCallId(this.props.call.callId),c=this.state.isLocalOnHold||this.state.isRemoteOnHold,g=this.props.call.isScreensharing(),b=this.state.sidebarShown,E=this.props.call.getFeeds().some(e=>e.purpose===w.b.Screenshare),S=this.props.call.type===p.f.Video;let _,k,R;if(o){const e=d.a.get().getRoom(l.d.sharedInstance().roomIdForCall(this.props.call)),t=e?e.name:Object(h.a)("unknown person"),s=d.a.get().getRoom(l.d.sharedInstance().roomIdForCall(o)),n=s?s.name:Object(h.a)("unknown person");k=r.a.createElement("div",{className:"mx_CallView_holdTransferContent"},Object(h.a)("Consulting with %(transferTarget)s. <a>Transfer to %(transferee)s</a>",{transferTarget:t,transferee:n},{a:e=>r.a.createElement(f.a,{kind:"link",onClick:this.onTransferClick},e)}))}else if(c){let e=null;if(this.state.isRemoteOnHold){const t=l.d.sharedInstance().hasAnyUnheldCall()?Object(h.b)("You held the call <a>Switch</a>"):Object(h.b)("You held the call <a>Resume</a>");e=Object(h.a)(t,{},{a:e=>r.a.createElement(f.a,{kind:"link",onClick:this.onCallResumeClick},e)})}else this.state.isLocalOnHold&&(e=Object(h.a)("%(peerName)s held the call",{peerName:this.props.call.getOpponentMember().name}));k=r.a.createElement("div",{className:"mx_CallView_holdTransferContent"},e)}if(c||o||!b||!S&&!E||(R=r.a.createElement(C.a,{feeds:this.state.secondaryFeeds,call:this.props.call,pipMode:this.props.pipMode})),c||o)if(S){const e=v()({mx_CallView_content:!0,mx_CallView_video:!0,mx_CallView_video_hold:c});let t=null;const s={},n=Object(y.a)(this.props.call.getOpponentMember(),1024,1024,"crop");s.backgroundImage="url("+n+")",t=r.a.createElement("div",{className:"mx_CallView_video_holdBackground",style:s}),_=r.a.createElement("div",{className:e,ref:this.contentRef,onMouseMove:this.onMouseMove},t,k,this.renderCallControls())}else{const e=v()({mx_CallView_content:!0,mx_CallView_voice:!0,mx_CallView_voice_hold:c});_=r.a.createElement("div",{className:e,onMouseMove:this.onMouseMove},r.a.createElement("div",{className:"mx_CallView_voice_avatarsContainer"},r.a.createElement("div",{className:"mx_CallView_voice_avatarContainer",style:{width:a,height:a}},r.a.createElement(m.a,{room:n,height:a,width:a}))),k,this.renderCallControls())}else if(this.props.call.noIncomingFeeds()){const e=v()({mx_CallView_content:!0,mx_CallView_voice:!0});_=r.a.createElement("div",{className:e,onMouseMove:this.onMouseMove,ref:this.contentRef},R,r.a.createElement("div",{className:"mx_CallView_voice_avatarsContainer"},r.a.createElement("div",{className:"mx_CallView_voice_avatarContainer",style:{width:a,height:a}},r.a.createElement(m.a,{room:n,height:a,width:a}))),r.a.createElement("div",{className:"mx_CallView_holdTransferContent"},Object(h.a)("Connecting")),this.renderCallControls())}else{const e=v()({mx_CallView_content:!0,mx_CallView_video:!0});let t;if(E){const e=v()({mx_CallView_presenting:!0,mx_CallView_presenting_hidden:!this.state.controlsVisible}),s=this.state.primaryFeed.getMember().name;let n=g?Object(h.a)("You are presenting"):Object(h.a)("%(sharerName)s is presenting",{sharerName:s});!this.state.sidebarShown&&S&&(n+=" • "+(this.props.call.isLocalVideoMuted()?Object(h.a)("Your camera is turned off"):Object(h.a)("Your camera is still enabled"))),t=r.a.createElement("div",{className:e},n)}_=r.a.createElement("div",{className:e,ref:this.contentRef,onMouseMove:this.onMouseMove},t,R,r.a.createElement(u.a,{feed:this.state.primaryFeed,call:this.props.call,pipMode:this.props.pipMode,onResize:this.props.onResize,primary:!0}),this.renderCallControls())}const I=v()({mx_CallView:!0,mx_CallView_pip:this.props.pipMode,mx_CallView_large:!this.props.pipMode,mx_CallView_belowWidget:this.props.showApps});return r.a.createElement("div",{className:I},r.a.createElement(O.a,{onPipMouseDown:this.props.onMouseDownOnHeader,pipMode:this.props.pipMode,type:this.props.call.type,callRooms:[n,i]}),_)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(91),r=s.n(o),c=s(82),l=s.n(c),d=s(89),h=s(424),u=s(1),m=s(142),p=s(85),g=s(423);let v=Object(p.a)("views.voip.VideoFeed")(n=class extends l.a.PureComponent{constructor(e){super(e),a()(this,"element",void 0),a()(this,"setElementRef",e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)}),a()(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})}),a()(this,"onMuteStateChanged",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})}),a()(this,"onResize",e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)}),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener(h.b.NewStream,this.onNewStream),this.props.feed.removeListener(h.b.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===g.b.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener(h.b.NewStream,this.onNewStream),this.props.feed.addListener(h.b.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===g.b.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){u.a.info("Failed to play media element with feed",this.props.feed,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.src=null)}render(){const{pipMode:e,primary:t,feed:s}=this.props,n=r()("mx_VideoFeed",{mx_VideoFeed_voice:this.state.videoMuted}),i=r()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let a,o;if(s.purpose===g.b.Screenshare||t||e||(a=l.a.createElement("div",{className:i})),this.state.videoMuted){const s=this.props.feed.getMember();let n;e&&t?n=76:e&&!t?n=16:!e&&t&&(n=160),o=l.a.createElement(m.a,{member:s,height:n,width:n})}else{const e=r()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===g.b.Usermedia&&d.b.getValue("VideoView.flipVideoHorizontally")});o=l.a.createElement("video",{className:e,ref:this.setElementRef})}return l.a.createElement("div",{className:n},a,o)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return g}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(89),l=s(100),d=s(137),h=s(236),u=s(185);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const g=e=>t=>{const s=c.b.getValue("Spaces.enabledMetaSpaces");c.b.setValue("Spaces.enabledMetaSpaces",null,l.a.ACCOUNT,p(p({},s),{},{[e]:t.target.checked}))};t.a=()=>{const{[u.a.Home]:e,[u.a.Favourites]:t,[u.a.People]:s,[u.a.Orphans]:n}=Object(h.b)("Spaces.enabledMetaSpaces"),i=Object(h.b)("Spaces.allRoomsInHome");return o.a.createElement("div",{className:"mx_SettingsTab mx_SidebarUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(r.a)("Sidebar")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(r.a)("Spaces")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(r.a)("Spaces are ways to group rooms and people.")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_subheading"},Object(r.a)("Spaces to show")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(r.a)("Along with the spaces you're in, you can use some pre-built ones too.")),o.a.createElement(d.b,{checked:!!e,onChange:g(u.a.Home),className:"mx_SidebarUserSettingsTab_homeCheckbox"},Object(r.a)("Home")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Home is useful for getting an overview of everything.")),o.a.createElement(d.b,{checked:i,disabled:!e,onChange:e=>{c.b.setValue("Spaces.allRoomsInHome",null,l.a.ACCOUNT,e.target.checked)},className:"mx_SidebarUserSettingsTab_homeAllRoomsCheckbox"},Object(r.a)("Show all rooms")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Show all your rooms in Home, even if they're in a space.")),o.a.createElement(d.b,{checked:!!t,onChange:g(u.a.Favourites),className:"mx_SidebarUserSettingsTab_favouritesCheckbox"},Object(r.a)("Favourites")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Automatically group all your favourite rooms and people together in one place.")),o.a.createElement(d.b,{checked:!!s,onChange:g(u.a.People),className:"mx_SidebarUserSettingsTab_peopleCheckbox"},Object(r.a)("People")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Automatically group all your people together in one place.")),o.a.createElement(d.b,{checked:!!n,onChange:g(u.a.Orphans),className:"mx_SidebarUserSettingsTab_orphansCheckbox"},Object(r.a)("Rooms outside of a space")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.a)("Automatically group all your rooms that aren't part of a space in one place."))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(89),d=s(309),h=s(265),u=s(88),m=s(87),p=s(92),g=s(101),v=s(216),f=s(100),b=s(85),y=s(1),E=s(176),S=s(266),_=s(371);function w(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function C(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?w(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let O=Object(b.a)("views.settings.tabs.user.ThemeChoicePanel")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"themeTimer",void 0),a()(this,"onLightThemeChange",e=>{if(this.state.lightTheme===e)return;const t=l.b.getValue("light_theme");l.b.setValue("light_theme",null,f.a.DEVICE,e).catch(()=>{m.a.dispatch({action:p.a.RecheckTheme}),this.setState({lightTheme:t})}),this.setState({lightTheme:e}),m.a.dispatch({action:p.a.RecheckTheme})}),a()(this,"onDarkThemeChange",e=>{if(this.state.darkTheme===e)return;const t=l.b.getValue("dark_theme");l.b.setValue("dark_theme",null,f.a.DEVICE,e).catch(()=>{m.a.dispatch({action:p.a.RecheckTheme}),this.setState({darkTheme:t})}),this.setState({darkTheme:e}),m.a.dispatch({action:p.a.RecheckTheme})}),a()(this,"onThemeInUseChange",e=>{const t=e.target.value;this.setState({themeInUse:t}),l.b.setValue("theme_in_use",null,f.a.DEVICE,t),m.a.dispatch({action:p.a.RecheckTheme})}),a()(this,"onAddCustomTheme",async()=>{let e=l.b.getValue("custom_themes");e||(e=[]),e=e.map(e=>e),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),s=await t.json();if(!s||"string"!=typeof s.name||"object"!=typeof s.colors)return void this.setState({customThemeMessage:{text:Object(c.a)("Invalid theme schema."),isError:!0}});e.push(s)}catch(e){return y.a.error(e),void this.setState({customThemeMessage:{text:Object(c.a)("Error downloading theme information."),isError:!0}})}await l.b.setValue("custom_themes",null,f.a.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:Object(c.a)("Theme added!"),isError:!1}}),this.themeTimer=setTimeout(()=>{this.setState({customThemeMessage:{text:"",isError:!1}})},3e3)}),a()(this,"onCustomThemeChange",e=>{this.setState({customThemeUrl:e.target.value})}),a()(this,"onUserNameColorModeChange",(e,t)=>{const s=t.target.value;this.setState(t=>C(C({},t),{},{[e]:s})),l.b.setValue(e,null,f.a.DEVICE,s)}),this.state={lightTheme:l.b.getValue("light_theme"),darkTheme:l.b.getValue("dark_theme"),themeInUse:l.b.getValue("theme_in_use"),customThemeUrl:"",customThemeMessage:{isError:!1,text:""},showAdvancedThemeSettings:!1,userNameColorModeDM:l.b.getValue("userNameColorModeDM"),userNameColorModeGroup:l.b.getValue("userNameColorModeGroup"),userNameColorModePublic:l.b.getValue("userNameColorModePublic")}}renderUserNameColorModeSection(){const e=(e,t)=>(console.log("asdf"+this.state[e]),r.a.createElement(E.a,{name:e,value:t,checked:this.state[e]===t,onChange:t=>this.onUserNameColorModeChange(e,t)})),t=(t,s)=>r.a.createElement("tr",null,r.a.createElement("td",null,t),r.a.createElement("td",null,e(s,_.a.Uniform)),r.a.createElement("td",null,e(s,_.a.PowerLevel)),r.a.createElement("td",null,e(s,_.a.MXID)));return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_userNameColorModeSection"},r.a.createElement("table",{className:"mx_SettingsTab_settingsTable"},r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("User name color mode"))),r.a.createElement("th",null,Object(c.a)("Uniform")),r.a.createElement("th",null,Object(c.a)("PowerLevel")),r.a.createElement("th",null,Object(c.a)("MXID")))),r.a.createElement("tbody",null,t(Object(c.a)("For people"),"userNameColorModeDM"),t(Object(c.a)("In group chats"),"userNameColorModeGroup"),t(Object(c.a)("In public rooms"),"userNameColorModePublic")))))}render(){const e=new h.a,t=r.a.createElement("div",{className:"mx_SettingsTab_inlineRadioSelectors"},r.a.createElement("label",null,r.a.createElement(E.a,{name:"theme_in_use",value:S.a.Light,checked:this.state.themeInUse===S.a.Light,onChange:this.onThemeInUseChange},Object(c.a)("Light"))),r.a.createElement("label",null,r.a.createElement(E.a,{name:"theme_in_use",value:S.a.Dark,checked:this.state.themeInUse===S.a.Dark,onChange:this.onThemeInUseChange},Object(c.a)("Dark"))),e.isSystemThemeSupported()?r.a.createElement("label",null,r.a.createElement(E.a,{name:"theme_in_use",value:S.a.System,checked:this.state.themeInUse===S.a.System,onChange:this.onThemeInUseChange},Object(c.a)("System"))):null);let s;if(l.b.getValue("feature_custom_themes")){let e=null;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?r.a.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):r.a.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),s=r.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_addCustomThemeSection"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Add custom theme")),r.a.createElement("form",{onSubmit:this.onAddCustomTheme},r.a.createElement(g.a,{label:Object(c.a)("Custom theme URL"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),r.a.createElement(u.a,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},Object(c.a)("Add theme")),e))}const n=r.a.createElement("div",{className:"mx_ThemeChoicePanel_AdvancedToggle",onClick:()=>this.setState({showAdvancedThemeSettings:!this.state.showAdvancedThemeSettings})},this.state.showAdvancedThemeSettings?Object(c.a)("Hide advanced theme settings"):Object(c.a)("Show advanced theme settings"));let i;if(this.state.showAdvancedThemeSettings){const e=Object(d.e)();i=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Light theme")),r.a.createElement("div",{className:"mx_ThemeSelectors"},r.a.createElement(v.a,{name:"light_theme",definitions:e.map(e=>({value:e.id,label:e.name,className:"mx_ThemeSelector_"+e.id})),onChange:this.onLightThemeChange,value:this.state.lightTheme,outlined:!0}))),r.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Dark theme")),r.a.createElement("div",{className:"mx_ThemeSelectors"},r.a.createElement(v.a,{name:"dark_theme",definitions:e.map(e=>({value:e.id,label:e.name,className:"mx_ThemeSelector_"+e.id})),onChange:this.onDarkThemeChange,value:this.state.darkTheme,outlined:!0}))),s,this.renderUserNameColorModeSection())}return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Theme")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_themeInUseSection"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Theme in use")),t),r.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_Advanced"},n,i))}})||n},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a}));var n=s(130);let i;async function a(e,t){const s=(await t.getEncryptionTargetMembers()).map(({userId:e})=>e),a=!!n.a.shared().getUserIdForRoomId(t.roomId),o=[],r=[];s.filter(t=>t!==e.getUserId()).forEach(t=>{(e.checkUserTrust(t).isCrossSigningVerified()?o:r).push(t)});for(const t of r)if(e.checkUserTrust(t).wasCrossSigningVerified())return i.Warning;const c=o.length>0&&!a&&2!==s.length||1===s.length?[...o,e.getUserId()]:o;for(const t of c){if(e.getStoredDevicesForUser(t).some(({deviceId:s})=>!e.checkDeviceTrust(t,s).isVerified()))return i.Warning}return 0===r.length?i.Verified:i.Normal}!function(e){e.Warning="warning",e.Verified="verified",e.Normal="normal"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(82),i=s(135),a=s(112);const o=(e,t=250)=>{const[s,o]=Object(n.useState)(e.getJoinedMembers());return Object(i.a)(e.currentState,"RoomState.members",Object(a.throttle)(()=>{o(e.getJoinedMembers())},t,{leading:!0,trailing:!0})),s},r=(e,t=250)=>{const[s,o]=Object(n.useState)(e.getJoinedMemberCount());return Object(i.a)(e.currentState,"RoomState.members",Object(a.throttle)(()=>{o(e.getJoinedMemberCount())},t,{leading:!0,trailing:!0})),s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(83),i=s.n(n),a=s(86),o=s(887),r=s(720),c=s(103),l=s(136),d=s(167),h=s(157),u=s(401),m=s(84),p=s(93),g=s(1);class v{constructor(e,t,s,n){if(this.room=e,this.exportType=t,this.exportOptions=s,this.setProgressText=n,i()(this,"files",[]),i()(this,"client",void 0),i()(this,"cancelled",!1),s.maxSize<1048576||s.maxSize>2097152e3||s.numberOfMessages>10**8)throw new Error("Invalid export options");this.client=a.a.get(),window.addEventListener("beforeunload",this.onBeforeUnload)}onBeforeUnload(e){return e.preventDefault(),e.returnValue=Object(m.a)("Are you sure you want to exit during this export?")}updateProgress(e,t=!0,s=!0){t&&g.a.log(e),s&&this.setProgressText(e)}addFile(e,t){const s={name:e,blob:t};this.files.push(s)}async downloadZIP(){const e=`${p.a.get().brand} - Chat Export - ${Object(l.d)(new Date)}`,t=e+".zip",{default:n}=await s.e(35).then(s.t.bind(null,1646,7)),i=new n;if(this.cancelled)return this.cleanUp();this.updateProgress("Generating a ZIP");for(const t of this.files)i.file(e+"/"+t.name,t.blob);const a=await i.generateAsync({type:"blob"});Object(u.saveAs)(a,t)}cleanUp(){return g.a.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){g.a.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const s=new Blob([t],{type:"text"});Object(u.saveAs)(s,e)}setEventMetadata(e){const t=this.client.getRoom(this.room.roomId).currentState;return e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e}getLimit(){let e;switch(this.exportType){case o.b.LastNMessages:e=this.exportOptions.numberOfMessages;break;case o.b.Timeline:e=40;break;default:e=10**8}return e}async getRequiredEvents(){const e=this.client.getEventMapper();let t=null,s=this.getLimit();const n=[];for(;s;){const i=Math.min(s,1e3),a=await this.client.createMessagesRequest(this.room.roomId,t,i,h.a.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===a.chunk.length)break;s-=a.chunk.length;const r=a.chunk.map(e);for(const e of r)n.push(e);this.updateProgress("Fetched "+n.length+" events "+(this.exportType===o.b.LastNMessages?"out of "+this.exportOptions.numberOfMessages:"so far")),t=a.end}for(let e=0;e<Math.floor(n.length/2);e++)[n[e],n[n.length-e-1]]=[n[n.length-e-1],n[e]];const i=n.filter(e=>e.isEncrypted()).map(e=>this.client.decryptEventIfNeeded(e,{isRetry:!0,emit:!1}));await Promise.all(i);for(let e=0;e<n.length;e++)this.setEventMetadata(n[e]);return n}async getMediaBlob(e){let t;try{const s=e.isEncrypted(),n=e.getContent();if(s&&n.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await Object(r.a)(n.file);else{const e=Object(c.a)(n),s=await fetch(e.srcHttp);t=await s.blob()}}catch(e){g.a.log("Error decrypting media")}return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const s=Object(l.d)(new Date(e.getTs()));let[n,i]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(i=".png"),Object(d.f)(e)&&(i=".ogg"),t+"/"+n+"-"+s+i}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return B})),s.d(t,"a",(function(){return V}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(148),h=s.n(d),u=s(94),m=s(302),p=s(136),g=s(86),v=s(89),f=s(118),b=s(133),y=s(84),E=s(134),S=s(255),_=s(888),w=s(130),C=s(890),O=s(85),k=s(87),R=s(891),I=s(1039),x=s(328),T=s(569),j=s(892),N=s(332),P=s(277),D=s(96),M=s(893),A=s(1),U=s(92);const L=[u.a.Sticker,u.a.RoomMessage],F=[u.a.RoomMember,u.a.RoomThirdPartyInvite,u.a.RoomServerAcl,u.a.RoomPinnedEvents];function B(e,t,s,n){return n!==f.a.ThreadsList&&(!!(e&&e.sender&&t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||L.includes(t.getType())&&L.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&!!Object(E.d)(e,s))))))}let V=Object(O.a)("structures.MessagePanel")((a=i=class extends l.a.Component{constructor(e,t){super(e,t),r()(this,"context",void 0),r()(this,"readReceiptMap",{}),r()(this,"readReceiptsByEvent",{}),r()(this,"readReceiptsByUserId",{}),r()(this,"showHiddenEventsInTimeline",void 0),r()(this,"isMounted",!1),r()(this,"readMarkerNode",Object(c.createRef)()),r()(this,"whoIsTyping",Object(c.createRef)()),r()(this,"scrollPanel",Object(c.createRef)()),r()(this,"showTypingNotificationsWatcherRef",void 0),r()(this,"eventNodes",void 0),r()(this,"callEventGroupers",new Map),r()(this,"updateIsDirect",()=>{var e;const t=!!w.a.shared().getUserIdForRoomId(null===(e=this.props.room)||void 0===e?void 0:e.roomId);t!==this.state.isDirect&&this.setState({isDirect:t})}),r()(this,"onAccountData",e=>{"m.direct"===e.getType()&&this.updateIsDirect()}),r()(this,"onShowTypingNotificationsChange",()=>{this.setState({showTypingNotifications:v.b.getValue("showTypingNotifications")})}),r()(this,"isUnmounting",()=>!this.isMounted),r()(this,"collectGhostReadMarker",e=>{e&&requestAnimationFrame(()=>{e.style.width="10%",e.style.opacity="0"})}),r()(this,"onGhostTransitionEnd",e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter(e=>e!==t)})}),r()(this,"collectEventNode",(e,t)=>{var s;this.eventNodes[e]=null==t||null===(s=t.ref)||void 0===s?void 0:s.current}),r()(this,"onHeightChanged",()=>{const e=this.scrollPanel.current;e&&e.checkScroll()}),r()(this,"onTypingShown",()=>{const e=this.scrollPanel.current;e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()}),r()(this,"onTypingHidden",()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())}),this.state={ghostReadMarkers:[],showTypingNotifications:v.b.getValue("showTypingNotifications"),isDirect:!1},this.showHiddenEventsInTimeline=v.b.getValue("showHiddenEventsInTimeline"),this.showTypingNotificationsWatcherRef=v.b.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){var e;this.updateIsDirect(),null===(e=this.props.room)||void 0===e||e.on("accountData",this.onAccountData),this.isMounted=!0}componentWillUnmount(){var e;this.isMounted=!1,null===(e=this.props.room)||void 0===e||e.off("accountData",this.onAccountData),v.b.unwatchSetting(this.showTypingNotificationsWatcherRef)}componentDidUpdate(e,t){if(this.updateIsDirect(),e.readMarkerVisible&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const s=this.pendingEditItem;!this.props.editState&&this.props.room&&s&&k.a.dispatch({action:U.a.EditEvent,event:this.props.room.findEventById(s),timelineRenderingType:this.context.timelineRenderingType})}getNodeForEventId(e){if(this.eventNodes)return this.eventNodes[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){const e=this.readMarkerNode.current,t=this.scrollPanel.current;if(!e||!t)return null;const s=h.a.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<s.top?-1:n.top<s.bottom?0:1}scrollToTop(){this.scrollPanel.current&&this.scrollPanel.current.scrollToTop()}scrollToBottom(){this.scrollPanel.current&&this.scrollPanel.current.scrollToBottom()}scrollRelative(e){this.scrollPanel.current&&this.scrollPanel.current.scrollRelative(e)}handleScrollKey(e){this.scrollPanel.current&&this.scrollPanel.current.handleScrollKey(e)}scrollToEvent(e,t,s){this.scrollPanel.current&&this.scrollPanel.current.scrollToToken(e,t,s)}scrollToEventIfNeeded(e){const t=this.eventNodes[e];t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}checkFillState(){this.scrollPanel.current&&this.scrollPanel.current.checkFillState()}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEventsInTimeline)&&void 0!==e?e:this.showHiddenEventsInTimeline}shouldShowEvent(e){return!g.a.get().isUserIgnored(e.getSender())&&(!!this.showHiddenEvents||!!Object(E.d)(e,this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!(e.isThreadRelation&&this.props.hideThreadedMessages&&v.b.getValue("feature_thread"))&&!Object(m.a)(e,this.context)))}readMarkerForEvent(e,t){const s=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return s&&(t=l.a.createElement("hr",{className:"mx_RoomView_myReadMarker",style:{opacity:1,width:"99%"}})),l.a.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_RoomView_myReadMarker_container","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=l.a.createElement("hr",{className:"mx_RoomView_myReadMarker",ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return l.a.createElement("li",{key:"_readuptoghost_"+e,className:"mx_RoomView_myReadMarker_container"},t)}return null}getNextEventInfo(e,t){return{nextEvent:t<e.length-1?e[t+1]:null,nextTile:e.slice(t+1).find(e=>this.shouldShowEvent(e))}}get pendingEditItem(){if(this.props.room)try{return localStorage.getItem(`mx_edit_room_${this.props.room.roomId}_${this.context.timelineRenderingType}`)}catch(e){return void A.a.error(e)}}getEventTiles(){let e,t;this.eventNodes={};let s=-1;for(e=this.props.events.length-1;e>=0;e--){const n=this.props.events[e];if(this.shouldShowEvent(n)&&(void 0===t&&(t=n),!n.status)){s=e;break}}const n=[];let i=null;this.readReceiptsByEvent={},this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent());let a=null;for(e=0;e<this.props.events.length;e++){const o=this.props.events[e],r=o.getId(),c=o===t,{nextEvent:l,nextTile:d}=this.getNextEventInfo(this.props.events,e);if(0===o.getType().indexOf("m.call.")||0===o.getType().indexOf("org.matrix.call.")){const e=o.getContent().call_id;if(this.callEventGroupers.has(e))this.callEventGroupers.get(e).add(o);else{const t=new R.c;t.add(o),this.callEventGroupers.set(e,t)}}if(a){if(a.shouldGroup(o)){a.add(o,this.showHiddenEvents);continue}n.push(...a.getTiles()),i=a.getNewPrevEvent(),a=null}for(const e of q)e.canStartGroup(this,o)&&!this.props.disableGrouping&&(a=new e(this,o,i,t,this.props.layout,l,d));if(!a){const t=!1;this.shouldShowEvent(o)&&(n.push(...this.getTilesForEvent(i,o,c,t,l,d)),i=o);const a=this.readMarkerForEvent(r,e>=s);a&&n.push(a)}}return a&&n.push(...a.getTiles()),n}getTilesForEvent(e,t,s=!1,n=!1,i,a){const o=[],r=this.props.editState&&this.props.editState.getEvent().getId()===t.getId();let c=t.getTs(),d=t.getDate();t.status&&(d=new Date,c=d.getTime());const h=this.wantsDateSeparator(e,d);if(h&&!n){const e=l.a.createElement("li",{key:c},l.a.createElement(N.a,{key:c,ts:c}));o.push(e)}let u=!1,m=!0;a&&(u=this.wantsDateSeparator(t,a.getDate()||new Date),m=u||t.getSender()!==a.getSender());const p=!h&&B(e,t,this.showHiddenEvents,this.context.timelineRenderingType),v=t.getId(),f=v===this.props.highlightedEventId,y=this.readReceiptsByEvent[v];let S=!1;const _=e=>!e||"sent"===e,w=_(t.getAssociatedStatus()),C=i&&this.shouldShowEvent(i);(!C&&w||C&&w&&!_(i.getAssociatedStatus()))&&(S=!0),a&&a!==i&&_(a.getAssociatedStatus())&&(S=!1),S=S&&t.getSender()===g.a.get().getUserId();const O=this.callEventGroupers.get(t.getContent().call_id);return o.push(l.a.createElement(M.a,{key:t.getTxnId()||v,mxEvent:t},l.a.createElement(E.b,{as:"li",ref:this.collectEventNode.bind(this,v),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:t,continuation:p,isRedacted:t.isRedacted(),replacingEventId:t.replacingEventId(),editState:r&&this.props.editState,onHeightChanged:this.onHeightChanged,readReceipts:y,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:t.getAssociatedStatus(),tileShape:this.props.tileShape,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:s,lastInSection:m,lastSuccessful:S,isSelectedEvent:f,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,userNameColorMode:this.props.userNameColorMode,enableFlair:this.props.enableFlair,showReadReceipts:this.props.showReadReceipts,callEventGrouper:O,hideSender:this.state.isDirect&&this.props.layout===b.a.Bubble,timelineRenderingType:this.context.timelineRenderingType}))),o}wantsDateSeparator(e,t){return this.context.timelineRenderingType!==f.a.ThreadsList&&(null==e?!this.props.suppressFirstDateSeparator:Object(p.k)(e.getDate(),t))}getReadReceiptsForEvent(e){const t=g.a.get().credentials.userId,{room:s}=this.props;if(!s)return null;const n=[];return s.getReceiptsForEvent(e).forEach(e=>{if(!e.userId||"m.read"!==e.type||e.userId===t)return;if(g.a.get().isUserIgnored(e.userId))return;const i=s.getMember(e.userId);n.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})}),n}getReadReceiptsByShownEvent(){const e={},t={};let s;for(const n of this.props.events){if(this.shouldShowEvent(n)&&(s=n.getId()),!s)continue;const i=e[s]||[],a=this.getReadReceiptsForEvent(n);e[s]=i.concat(a);for(const e of a)t[e.userId]={lastShownEventId:s,receipt:e}}for(const s in this.readReceiptsByUserId){if(t[s])continue;const{lastShownEventId:n,receipt:i}=this.readReceiptsByUserId[s],a=e[n]||[];e[n]=a.concat(i),t[s]={lastShownEventId:n,receipt:i}}this.readReceiptsByUserId=t;for(const t in e)e[t].sort((e,t)=>t.ts-e.ts);return e}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),s=this.whoIsTyping.current,n=s&&s.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=l.a.createElement("li",{key:"_topSpinner"},l.a.createElement(D.a,null))),this.props.forwardPaginating&&(t=l.a.createElement("li",{key:"_bottomSpinner"},l.a.createElement(D.a,null)));const s=this.props.hidden?{display:"none"}:{};let n;this.props.room&&!this.props.tileShape&&this.state.showTypingNotifications&&(n=l.a.createElement(I.a,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping}));let i=null;return this.props.layout==b.a.IRC&&(i=l.a.createElement(_.a,{minWidth:20,maxWidth:600,roomId:this.props.room?this.props.room.roomId:null})),l.a.createElement(P.a,null,l.a.createElement(x.a,{ref:this.scrollPanel,className:this.props.className,onScroll:this.props.onScroll,onUserScroll:this.props.onUserScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:s,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:i},e,this.getEventTiles(),n,t))}},r()(i,"contextType",f.b),r()(i,"defaultProps",{disableGrouping:!1}),n=a))||n;class K{constructor(e,t,s,n,i,a,o){this.panel=e,this.event=t,this.prevEvent=s,this.lastShownEvent=n,this.layout=i,this.nextEvent=a,this.nextEventTile=o,r()(this,"events",[]),r()(this,"ejectedEvents",[]),r()(this,"readMarker",void 0),this.readMarker=e.readMarkerForEvent(t.getId(),t===n)}}r()(K,"canStartGroup",(e,t)=>!0);class W extends K{shouldGroup(e){const t=this.panel,s=this.event;return!t.shouldShowEvent(e)||!t.wantsDateSeparator(this.event,e.getDate())&&((e.getType()!==u.a.RoomMember||e.getStateKey()===s.getSender()&&"join"===e.getContent().membership)&&!(!e.isState()||e.getSender()!==s.getSender()))}add(e){const t=this.panel;this.readMarker=this.readMarker||t.readMarkerForEvent(e.getId(),e===this.lastShownEvent),t.shouldShowEvent(e)&&(e.getType()===u.a.RoomEncryption?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=this.panel,t=[],s=this.event,n=this.lastShownEvent;if(e.wantsDateSeparator(this.prevEvent,s.getDate())){const e=s.getTs();t.push(l.a.createElement("li",{key:e+"~"},l.a.createElement(N.a,{key:e+"~",ts:e})))}e.shouldShowEvent(s)&&t.push(...e.getTilesForEvent(s,s));for(const i of this.ejectedEvents)t.push(...e.getTilesForEvent(s,i,s===n,!0));const i=this.events.map(t=>e.getTilesForEvent(t,t,t===n,!0)).reduce((e,t)=>e.concat(t),[]),a=this.events[this.events.length-1];let o;const r=a.getRoomId(),c=a.sender?a.sender.name:a.getSender();return o=w.a.shared().getUserIdForRoomId(r)?Object(y.a)("%(creator)s created this DM.",{creator:c}):Object(y.a)("%(creator)s created and configured the room.",{creator:c}),t.push(l.a.createElement(C.a,{key:"newroomintro"})),t.push(l.a.createElement(T.a,{key:"roomcreationsummary",events:this.events,onToggle:e.onHeightChanged,summaryMembers:[a.sender],summaryText:o,layout:this.layout},i)),this.readMarker&&t.push(this.readMarker),t}getNewPrevEvent(){return this.event}}r()(W,"canStartGroup",(function(e,t){return t.getType()===u.a.RoomCreate}));class G extends K{constructor(e,t,s,n,i,a,o){super(e,t,s,n,i,a,o),this.events=[t]}shouldGroup(e){return!this.panel.shouldShowEvent(e)||!this.panel.wantsDateSeparator(this.events[0],e.getDate())&&e.isRedacted()}add(e){this.readMarker=this.readMarker||this.panel.readMarkerForEvent(e.getId(),e===this.lastShownEvent),this.panel.shouldShowEvent(e)&&this.events.push(e)}getTiles(){if(!this.events||!this.events.length)return[];const e=this.panel,t=[],s=this.lastShownEvent;if(e.wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const e=this.events[0].getTs();t.push(l.a.createElement("li",{key:e+"~"},l.a.createElement(N.a,{key:e+"~",ts:e})))}const n="redactioneventlistsummary-"+(this.prevEvent?this.events[0].getId():"initial"),i=new Set;let a=this.events.map((t,n)=>{i.add(t.sender);const a=0===n?this.prevEvent:this.events[n-1];return e.getTilesForEvent(a,t,t===s,!0,this.nextEvent,this.nextEventTile)}).reduce((e,t)=>e.concat(t),[]);return 0===a.length&&(a=null),t.push(l.a.createElement(T.a,{key:n,threshold:2,events:this.events,onToggle:e.onHeightChanged,summaryMembers:Array.from(i),summaryText:Object(y.a)("%(count)s messages deleted.",{count:a.length}),layout:this.layout},a)),this.readMarker&&t.push(this.readMarker),t}getNewPrevEvent(){return this.events[this.events.length-1]}}r()(G,"canStartGroup",(function(e,t){return e.shouldShowEvent(t)&&t.isRedacted()}));class H extends K{constructor(e,t,s,n,i){super(e,t,s,n,i),this.panel=e,this.event=t,this.prevEvent=s,this.lastShownEvent=n,this.layout=i,this.events=[t]}shouldGroup(e){return!this.panel.wantsDateSeparator(this.events[0],e.getDate())&&F.includes(e.getType())}add(e,t){(e.getType()!==u.a.RoomMember||Object(S.a)(e,t))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(e.getId(),e===this.lastShownEvent),this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=this.panel,t=this.lastShownEvent,s=[];if(e.wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const e=this.events[0].getTs();s.push(l.a.createElement("li",{key:e+"~"},l.a.createElement(N.a,{key:e+"~",ts:e})))}const n="membereventlistsummary-"+(this.prevEvent?this.events[0].getId():"initial");let i,a=this.events.map(s=>(s.getId()===e.props.highlightedEventId&&(i=!0),e.getTilesForEvent(s,s,s===t,!0))).reduce((e,t)=>e.concat(t),[]);return 0===a.length&&(a=null),s.push(l.a.createElement(j.a,{key:n,events:this.events,onToggle:e.onHeightChanged,startExpanded:i,layout:this.layout},a)),this.readMarker&&s.push(this.readMarker),s}getNewPrevEvent(){return this.events[0]}}r()(H,"canStartGroup",(function(e,t){return e.shouldShowEvent(t)&&F.includes(t.getType())}));const q=[W,H,G]},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(112),o=s(142),r=s(84),c=s(387),l=s(88),d=s(133);const h=({events:e,children:t,threshold:s=3,onToggle:h,startExpanded:u,summaryMembers:m=[],summaryText:p,layout:g})=>{const[v,f]=Object(c.a)(u);Object(n.useEffect)(()=>{h&&h()},[v]);const b=e.map(e=>e.getId()).join(",");if(e.length<s)return i.a.createElement("li",{className:"mx_EventListSummary","data-scroll-tokens":b,"data-expanded":!0,"data-layout":g},t);let y;if(v)y=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_EventListSummary_line"}," "),t);else{const e=Object(a.uniqBy)(m,e=>e.getMxcAvatarUrl()).map(e=>i.a.createElement(o.a,{key:e.userId,member:e,width:14,height:14}));y=g===d.a.Bubble?i.a.createElement("div",{className:"mx_EventTile_line sc_EventTile_bubbleLine sc_EventTile_bubbleLine_info"},i.a.createElement("div",{className:"sc_EventTile_bubbleArea sc_EventTile_bubbleArea_center sc_EventTile_bubbleArea_info"},i.a.createElement("div",{className:"sc_EventTile_bubble sc_EventTile_bubble_info sc_EventTile_bubble_center"},i.a.createElement("span",{className:"mx_EventListSummary_avatars",onClick:f},e),i.a.createElement("span",{className:"mx_TextualEvent mx_EventListSummary_summary"},p)))):i.a.createElement("div",{className:"mx_EventTile_line"},i.a.createElement("div",{className:"mx_EventTile_info"},i.a.createElement("span",{className:"mx_EventListSummary_avatars",onClick:f},e),i.a.createElement("span",{className:"mx_TextualEvent mx_EventListSummary_summary"},p)))}return i.a.createElement("li",{className:"mx_EventListSummary","data-scroll-tokens":b,"data-expanded":v+"","data-layout":g},i.a.createElement(l.a,{className:"mx_EventListSummary_toggle",onClick:f,"aria-expanded":v},v?Object(r.a)("collapse"):Object(r.a)("expand")),y)};h.defaultProps={startExpanded:!1,layout:d.a.Group},t.a=h},function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return m}));var n=s(82),i=s.n(n),a=s(90),o=s(107),r=s(366),c=s(84),l=s(86),d=s(131),h=s(137);function u(e){return new Promise((t,s)=>{const n=i.a.createElement("div",null,i.a.createElement("div",null,Object(c.a)("Who would you like to add to this community?")),i.a.createElement("div",{className:"warning"},Object(c.a)("Warning: any person you add to a community will be publicly visible to anyone who knows the community ID"))),l=o.getComponent("dialogs.AddressPickerDialog");a.a.createTrackedDialog("Group Invite","",l,{title:Object(c.a)("Invite new community members"),description:n,placeholder:Object(c.a)("Name or Matrix ID"),button:Object(c.a)("Invite to Community"),validAddressTypes:["mx-user-id"],onFinished:(n,i)=>{n&&function(e,t){const s=new r.a(e),n=t.map(e=>e.address);return s.invite(n).then(s=>{const n=[];for(const e of Object.keys(s))"error"===t[e]&&n.push(e);if(n.length>0){const t=o.getComponent("dialogs.ErrorDialog");a.a.createTrackedDialog("Failed to invite the following users to the group","",t,{title:Object(c.a)("Failed to invite the following users to %(groupId)s:",{groupId:e}),description:n.join(", ")})}}).catch(t=>{const s=o.getComponent("dialogs.ErrorDialog");a.a.createTrackedDialog("Failed to invite users to group","",s,{title:Object(c.a)("Failed to invite users to community"),description:Object(c.a)("Failed to invite users to %(groupId)s",{groupId:e})})})}(e,i).then(t,s)}},null,!1,!0)})}function m(e){return new Promise((t,s)=>{let n=!1;const r=i.a.createElement("div",null,i.a.createElement("div",null,Object(c.a)("Which rooms would you like to add to this community?"))),u=i.a.createElement(h.b,{className:"mx_GroupAddressPicker_checkboxContainer",onChange:e=>{n=e.target.checked}},Object(c.a)("Show these rooms to non-members on the community page and room list?")),m=o.getComponent("dialogs.AddressPickerDialog");a.a.createTrackedDialog("Add Rooms to Group","",m,{title:Object(c.a)("Add rooms to the community"),description:r,extraNode:u,placeholder:Object(c.a)("Room name or address"),button:Object(c.a)("Add to community"),pickerType:"room",validAddressTypes:["mx-room-id"],onFinished:(i,r)=>{i&&function(e,t,s){const n=l.a.get(),i=[];return Promise.allSettled(t.map(t=>d.a.addRoomToGroup(e,t.address,s).catch(()=>{i.push(t.address)}).then(()=>{const s=t.address,i=n.getRoom(s);if(!i||!i.currentState.mayClientSendStateEvent("m.room.related_groups",n))return;const a=i.currentState.getStateEvents("m.room.related_groups",""),o=a&&a.getContent().groups||[];return o.includes(e)?void 0:(o.push(e),l.a.get().sendStateEvent(s,"m.room.related_groups",{groups:o},""))}))).then(()=>{if(0===i.length)return;const t=o.getComponent("dialogs.ErrorDialog");a.a.createTrackedDialog("Failed to add the following room to the group","",t,{title:Object(c.a)("Failed to add the following rooms to %(groupId)s:",{groupId:e}),description:i.join(", ")})})}(e,r,n).then(t,s)}},null,!1,!0)})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(84),m=s(85),p=s(103),g=s(142),v=s(125),f=s(97),b=s(109),y=s(101);let E=Object(m.a)("views.dialogs.ConfirmUserActionDialog")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onOk",e=>{e.preventDefault(),this.props.onFinished(!0,this.state.reason)}),r()(this,"onCancel",()=>{this.props.onFinished(!1)}),r()(this,"onReasonChange",e=>{this.setState({reason:e.target.value})}),this.state={reason:""}}render(){const e=this.props.danger?"danger":"";let t,s,n,i;if(this.props.askReason&&(t=l.a.createElement("form",{onSubmit:this.onOk},l.a.createElement(y.a,{type:"text",onChange:this.onReasonChange,value:this.state.reason,className:"mx_ConfirmUserActionDialog_reasonField",label:Object(u.a)("Reason"),autoFocus:!0}))),this.props.member)s=l.a.createElement(g.a,{member:this.props.member,width:48,height:48}),n=this.props.member.name,i=this.props.member.userId;else{const e=this.props.groupMember.avatarUrl?Object(p.b)(this.props.groupMember.avatarUrl).getSquareThumbnailHttp(48):null;n=this.props.groupMember.displayname||this.props.groupMember.userId,i=this.props.groupMember.userId,s=l.a.createElement(v.a,{name:n,url:e,width:48,height:48})}return l.a.createElement(f.a,{className:h()("mx_ConfirmUserActionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content"},l.a.createElement("div",{id:"mx_Dialog_content",className:"mx_Dialog_content"},l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_user"},l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_avatar"},s),l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_name"},n),l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_userId"},i)),t,this.props.children),l.a.createElement(b.a,{primaryButton:this.props.action,onPrimaryButtonClick:this.onOk,primaryButtonClass:e,focus:!this.props.askReason,onCancel:this.onCancel}))}},r()(i,"defaultProps",{danger:!1,askReason:!1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(83),i=s.n(n);const a=(e,t,s)=>""===s.text[t].trim();class o{constructor(e,t,s=t){this.model=e,i()(this,"_start",void 0),i()(this,"_end",void 0);const n=t.compare(s)<0;this._start=n?t:s,this._end=n?s:t}moveStartForwards(e){this._start=this._start.forwardsWhile(this.model,()=>(e-=1)>=0)}moveEndBackwards(e){this._end=this._end.backwardsWhile(this.model,()=>(e-=1)>=0)}trim(){this._start=this._start.forwardsWhile(this.model,a),this._end=this._end.backwardsWhile(this.model,a)}expandBackwardsWhile(e){this._start=this._start.backwardsWhile(this.model,e)}get text(){let e="";return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const i=t.text.substring(s,n);e+=i}),e}replace(e){const t=e.reduce((e,t)=>e+t.text.length,0);let s=0;return this._start.iteratePartsBetween(this._end,this.model,(e,t,n)=>{s+=n-t}),this.model.replaceRange(this._start,this._end,e),t-s}get parts(){const e=[];return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const i=t.serialize();i.text=t.text.substring(s,n);const a=this.model.partCreator.deserializePart(i);e.push(a)}),e}get length(){let e=0;return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{e+=n-s}),e}get start(){return this._start}get end(){return this._end}}},function(e,t,s){"use strict";s.d(t,"d",(function(){return i})),s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return d})),s.d(t,"e",(function(){return u}));var n=s(222);function i(e,t){const s=!t||t.type===n.b.Newline;return!e.canEdit&&(s||!t.canEdit)}function a(e,t){return!e.canEdit&&t}function o(e,t){const s=e.nextSibling;s?e.parentElement.insertBefore(t,s):e.parentElement.appendChild(t)}const r="\ufeff";function c(){const e=document.createElement("span");return e.className="caretNode",e.appendChild(document.createTextNode(r)),e}function l(e){e.textContent!==r&&(e.textContent=r)}function d(e){return e&&"SPAN"===e.tagName&&"caretNode"===e.className}function h(e){if(e)for(e=e.nextSibling;e;){const t=e;e=e.nextSibling,t.remove()}}function u(e,t){const s=t.parts.reduce((e,t)=>{if(t.type===n.b.Newline)e.push([]);else{e[e.length-1].push(t)}return e},[[]]);s.forEach((t,s)=>{let n=e.childNodes[s];for(;n&&("DIV"!==n.tagName||n.className);)e.removeChild(n),n=e.childNodes[s];n||(n=document.createElement("div"),e.appendChild(n)),t.length?function(e,t){let s,n;const r=t[t.length-1];for(const h of t){for(s=!n?e.firstChild:s.nextSibling,i(h,n)&&(d(s)?(l(s),s=s.nextSibling):e.insertBefore(c(),s));s&&!h.canUpdateDOMNode(s);){const t=s.nextSibling;e.removeChild(s),s=t}if(s&&h?h.updateDOMNode(s):h&&(s=h.toDOMNode(),e.appendChild(s)),a(h,h===r))if(d(s.nextSibling))s=s.nextSibling,l(s);else{const e=c();o(s,e),s=e}n=h}h(s)}(n,t):function(e){let t=!1,s=e.firstChild;for(;s;){const e=s.nextSibling;t||"BR"!==s.tagName?s.remove():t=!0,s=e}t||e.appendChild(document.createElement("br"))}(n)}),s.length?h(e.children[s.length-1]):function(e){const t=e.firstChild;t&&(h(t),t.remove())}(e)}},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return c}));var n=s(573),i=s(914);function a(e,t,s){let n=e.firstChild;for(;n&&n!==e;){if(t(n)&&n.firstChild)n=n.firstChild;else if(n.nextSibling)n=n.nextSibling;else{for(;!n.nextSibling&&n!==e;)n=n.parentElement,n!==e&&s(n);n!==e&&(n=n.nextSibling)}}}function o(e,t){const{offset:s,text:n}=r(e,t.focusNode,t.focusOffset);return{caret:s,text:n}}function r(e,t,s){const{node:o,characterOffset:r}=function(e,t){for(;e&&e.nodeType===Node.ELEMENT_NODE;){const s=e.childNodes.length;if(!s)break;t>=s?t=(e=e.lastChild).nodeType===Node.TEXT_NODE?e.textContent.length:Number.MAX_SAFE_INTEGER:(e=e.childNodes[t],t=0)}return{node:e,characterOffset:t}}(t,s),{text:c,offsetToNode:l}=function(e,t){let s=0,i=!1,o="";function r(e){i||e===t&&(i=!0),"BR"===e.tagName&&e.nextSibling&&(i||(s+=1),o+="\n");const a=e.nodeType===Node.TEXT_NODE&&function(e){const t=e.nodeValue;return Object(n.b)(e.parentElement)?1!==t.length?t.replace(n.a,""):"":t}(e);return a&&(i||(s+=a.length),o+=a),!0}function c(e){"DIV"===e.tagName&&e.nextSibling&&"DIV"===e.nextSibling.tagName&&(o+="\n",i||(s+=1))}return a(e,r,c),{text:o,offsetToNode:s}}(e,o);return{offset:function(e,t,s){if(!e)return new i.a(0,!1);let a=s===e.textContent.length;if(e.nodeType===Node.TEXT_NODE&&Object(n.b)(e.parentElement)){const t=e.nodeValue.indexOf(n.a);-1!==t&&t<s&&(s-=1),a=!0}return new i.a(t+s,a)}(o,l,r),text:c}}function c(e,t,s){const n=r(e,s.focusNode,s.focusOffset).offset,i=r(e,s.anchorNode,s.anchorOffset).offset,a=n.asPosition(t),o=i.asPosition(t);return t.startRange(a,o)}},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.Send="send",e.Edit="edit"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(202),h=s(87),u=s(306),m=s.n(u),p=s(84),g=s(92),v=s(301),f=s(88),b=s(85),y=s(98);let E=Object(b.a)("structures.UploadBar")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"dispatcherRef",void 0),r()(this,"mounted",void 0),r()(this,"onAction",e=>{switch(e.action){case g.a.UploadStarted:case g.a.UploadProgress:case g.a.UploadFinished:case g.a.UploadCanceled:case g.a.UploadFailed:{if(!this.mounted)return;const e=this.getUploadsInRoom();this.setState({currentUpload:e[0],uploadsHere:e});break}}}),r()(this,"onCancelClick",e=>{e.preventDefault(),d.b.sharedInstance().cancelUpload(this.state.currentUpload.promise,this.context)});const t=this.getUploadsInRoom();this.state={currentUpload:t[0],uploadsHere:t}}componentDidMount(){this.dispatcherRef=h.a.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,h.a.unregister(this.dispatcherRef)}getUploadsInRoom(){return d.b.sharedInstance().getCurrentUploads(this.props.relation).filter(e=>e.roomId===this.props.room.roomId)}render(){if(!this.state.currentUpload)return null;const e=Object(p.a)("Uploading %(filename)s and %(count)s others",{filename:this.state.currentUpload.fileName,count:this.state.uploadsHere.length-1}),t=m()(this.state.currentUpload.total);return l.a.createElement("div",{className:"mx_UploadBar"},l.a.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),l.a.createElement(f.a,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),l.a.createElement(v.a,{value:this.state.currentUpload.loaded,max:this.state.currentUpload.total}))}},r()(i,"contextType",y.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(319),m=s(276),p=s(87),g=s(733),v=s(152),f=s(308),b=s(551),y=s(553),E=s(552),S=s(154),_=s(233),w=s(894),C=s(85),O=s(139),k=s(96);let R=Object(C.a)("views.rooms.AppsDrawer")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"resizeContainer",void 0),r()(this,"resizer",void 0),r()(this,"dispatcherRef",void 0),r()(this,"onIsResizing",e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()}),r()(this,"collectResizer",e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()}),r()(this,"getAppsHash",e=>e.map(e=>e.id).join("~")),r()(this,"relaxResizer",()=>{const e=this.resizer.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())}),r()(this,"loadResizerPreferences",()=>{const e=S.d.instance.getResizerDistributions(this.props.room,S.a.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach((e,t)=>{const s=this.resizer.forHandleAt(t);s&&(s.size=e,s.finish())});else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach(e=>e.item.clearSize()),e.forEach(e=>e.start()),e.forEach(e=>e.finish())}}),r()(this,"onAction",e=>{const t=this.props.room.roomId+"_hide_widget_drawer";switch(e.action){case"appsDrawer":e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")}}),r()(this,"getApps",()=>{const e={};return e[S.a.Top]=S.d.instance.getContainerWidgets(this.props.room,S.a.Top),e[S.a.Center]=S.d.instance.getContainerWidgets(this.props.room,S.a.Center),e}),r()(this,"topApps",()=>this.state.apps[S.a.Top]),r()(this,"centerApps",()=>this.state.apps[S.a.Center]),r()(this,"updateApps",()=>{this.setState({apps:this.getApps()})}),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer(),this.props.resizeNotifier.on("isResizing",this.onIsResizing)}componentDidMount(){g.b(),S.d.instance.on(S.d.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=p.a.register(this.onAction)}componentWillUnmount(){g.c(),S.d.instance.off(S.d.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef&&p.a.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e={onResizeStart:()=>{this.resizeContainer.classList.add("mx_AppsDrawer_resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{this.resizeContainer.classList.remove("mx_AppsDrawer_resizing"),S.d.instance.setResizerDistributions(this.props.room,S.a.Top,this.topApps().slice(1).map((e,t)=>this.resizer.forHandleAt(t).size)),this.setState({resizingHorizontal:!1})}},t=new y.a(null,E.a,e);return t.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),t}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[S.a.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return l.a.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map((e,t,s)=>l.a.createElement(m.a,{key:e.id,app:e,fullWidth:s.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:v.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0}));if(0===t.length)return l.a.createElement("div",null);let s;0===t.length&&f.a.roomHasPendingWidgets(this.props.room.roomId,v.a.getRoomWidgets(this.props.room))&&(s=l.a.createElement(k.a,null));const n=h()({mx_AppsDrawer:!0,mx_AppsDrawer_maximise:e,mx_AppsDrawer_fullWidth:t.length<2,mx_AppsDrawer_resizing:this.state.resizing,mx_AppsDrawer_2apps:2===t.length,mx_AppsDrawer_3apps:3===t.length}),i=l.a.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map((e,s)=>s<1?e:l.a.createElement(l.a.Fragment,{key:e.key},l.a.createElement(b.a,{reverse:s>t.length/2}),e)));let a;return a=e?i:l.a.createElement(I,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight||!e?this.props.maxHeight-50:void 0,handleClass:"mx_AppsContainer_resizerHandle",handleWrapperClass:"mx_AppsContainer_resizerHandleContainer",className:"mx_AppsContainer_resizer",resizeNotifier:this.props.resizeNotifier},i),l.a.createElement("div",{className:n},a,s)}},r()(i,"defaultProps",{showApps:!0}),n=a))||n;const I=({room:e,minHeight:t,maxHeight:s,className:n,handleWrapperClass:i,handleClass:a,resizeNotifier:o,children:r})=>{let c=S.d.instance.getContainerHeight(e,S.a.Top);t||(t=100),s||(s=O.b.instance.windowHeight/4*3),c?(c=Object(_.a)(c,0,100),c=Object(_.d)(c/100,t,s)):c=280;const[d,h]=Object(w.a)(c,n=>{n=100*Object(_.c)(n,t,s),S.d.instance.setContainerHeight(e,S.a.Top,n)});return l.a.createElement(u.Resizable,{size:{height:Math.min(d,s),width:void 0},minHeight:t,maxHeight:s,onResizeStart:()=>{o.startResizing()},onResize:()=>{o.notifyTimelineHeightChanged()},onResizeStop:(e,t,s,n)=>{h(d+n.height),o.stopResizing()},handleWrapperClass:i,handleClasses:{bottom:a},className:n,enable:{bottom:!0}},r)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(91),u=s.n(h),m=s(140),p=s(111),g=s(85);const v=["isHighlighted","onClick","analytics","name","title"];var f;let b=Object(g.a)("views.right_panel.HeaderButton")(f=class extends d.a.Component{constructor(...e){super(...e),c()(this,"onClick",()=>{m.a.trackEvent(...this.props.analytics),this.props.onClick()})}render(){const e=this.props,{isHighlighted:t,onClick:s,analytics:n,name:a,title:r}=e,c=o()(e,v),l=u()({mx_RightPanel_headerButton:!0,mx_RightPanel_headerButton_highlight:t,["mx_RightPanel_"+a]:!0});return d.a.createElement(p.a,i()({},c,{"aria-selected":t,role:"tab",title:r,className:l,onClick:this.onClick}))}})||f},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(87),l=s(244),d=s(92),h=s(85);let u;!function(e){e.Room="room",e.Group="group"}(u||(u={}));let m=Object(h.a)("views.right_panel.HeaderButtons")(n=class extends r.a.Component{constructor(e,t){super(e),a()(this,"storeToken",void 0),a()(this,"dispatcherRef",void 0);const s=l.a.getSharedInstance();this.state={headerKind:t,phase:t===u.Room?s.visibleRoomPanelPhase:s.visibleGroupPanelPhase}}componentDidMount(){this.storeToken=l.a.getSharedInstance().addListener(this.onRightPanelUpdate.bind(this)),this.dispatcherRef=c.a.register(this.onAction.bind(this))}componentWillUnmount(){this.storeToken&&this.storeToken.remove(),this.dispatcherRef&&c.a.unregister(this.dispatcherRef)}setPhase(e,t){c.a.dispatch({action:d.a.SetRightPanelPhase,phase:e,refireParams:t})}isPhase(e){return Array.isArray(e)?e.includes(this.state.phase):e===this.state.phase}onRightPanelUpdate(){const e=l.a.getSharedInstance();this.state.headerKind===u.Room?this.setState({phase:e.visibleRoomPanelPhase}):this.state.headerKind===u.Group&&this.setState({phase:e.visibleGroupPanelPhase})}render(){return r.a.createElement("div",{className:"mx_HeaderButtons"},this.renderButtons())}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(93),i=s(84),a=s(89),o=s(121),r=s(82),c=s.n(r),l=s(100),d=s(446);function h(e){Object(i.d)()!==e&&(a.b.setValue("language",null,l.a.DEVICE,e),o.a.get().reload())}function u({disabled:e}){return n.a.get().disable_login_language_selector?c.a.createElement("div",null):c.a.createElement(d.a,{className:"mx_AuthBody_language",onOptionChange:h,value:Object(i.d)(),disabled:e})}},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(85),h=s(101),u=s(160),m=s(84);let p=Object(d.a)("views.auth.EmailField")((a=i=class extends c.PureComponent{constructor(...e){super(...e),r()(this,"validate",Object(u.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(m.a)(this.props.labelRequired)},{key:"match",test:({value:e})=>!e||e===this.props.password,invalid:()=>Object(m.a)(this.props.labelInvalid)}]})),r()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t})}render(){return l.a.createElement(h.a,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:Object(m.a)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}},r()(i,"defaultProps",{label:Object(m.b)("Confirm password"),labelRequired:Object(m.b)("Confirm password"),labelInvalid:Object(m.b)("Passwords don't match")}),n=a))||n;t.a=p},function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return v}));var n=s(82),i=s.n(n),a=s(84),o=s(93),r=s(179),c=s(146),l=s(113),d=s(972),h=s(121),u=s(90);function m(e){const t=e.split("-");return 5===t.length&&"react"===t[1]&&"js"===t[3]}function p(){h.a.get().installUpdate()}const g=(e,t,s)=>{let n,g=Object(a.a)("What's new?");s?n=()=>{u.a.createTrackedDialog("Display release notes","",l.a,{title:Object(a.a)("What's New"),description:i.a.createElement("pre",null,s),button:Object(a.a)("Update"),onFinished:e=>{e&&h.a.get()&&h.a.get().installUpdate()}})}:m(e)&&m(t)?n=()=>{u.a.createTrackedDialog("Display Changelog","",d.a,{version:e,newVersion:t,onFinished:e=>{e&&h.a.get()&&h.a.get().installUpdate()}})}:(n=p,g=Object(a.a)("Update"));const v=o.a.get().brand;c.a.sharedInstance().addOrReplaceToast({key:"update",title:Object(a.a)("Update %(brand)s",{brand:v}),props:{description:Object(a.a)("New version of %(brand)s is available",{brand:v}),acceptLabel:g,onAccept:n,rejectLabel:Object(a.a)("Dismiss"),onReject:function(){h.a.get().deferUpdate(t)}},component:r.a,priority:20})},v=()=>{c.a.sharedInstance().dismissToast("update")}},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.Email="email",e.Phone="msisdn"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i,a,o,r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(108),u=s(85);!function(e){e.Display="display",e.Edit="edit"}(o||(o={}));let m=Object(u.a)("views.elements.EditableText")((a=i=class extends d.a.Component{constructor(e){super(e),c()(this,"value",""),c()(this,"placeholder",!1),c()(this,"editableDiv",Object(l.createRef)()),c()(this,"showPlaceholder",e=>{e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1)}),c()(this,"cancelEdit",()=>{this.setState({phase:o.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),this.editableDiv.current.blur()}),c()(this,"onValueChanged",e=>{this.props.onValueChanged(this.value,e)}),c()(this,"onKeyDown",e=>{this.placeholder&&this.showPlaceholder(!1),e.key===h.a.ENTER&&(e.stopPropagation(),e.preventDefault())}),c()(this,"onKeyUp",e=>{e.target.textContent?this.placeholder||(this.value=e.target.textContent):this.showPlaceholder(!0),e.key===h.a.ENTER?this.onFinish(e):e.key===h.a.ESCAPE&&this.cancelEdit()}),c()(this,"onClickDiv",()=>{this.props.editable&&this.setState({phase:o.Edit})}),c()(this,"onFocus",e=>{const t=e.target.childNodes[0];if(t){const s=document.createRange();s.setStart(t,0),s.setEnd(t,e.target.childNodes.length);const n=window.getSelection();n.removeAllRanges(),n.addRange(s)}}),c()(this,"onFinish",(e,t)=>{const s=this,n="key"in e&&e.key===h.a.ENTER||t;this.setState({phase:o.Display},()=>{this.value!==this.props.initialValue&&s.onValueChanged(n)})}),c()(this,"onBlur",e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)}),this.state={phase:o.Display}}UNSAFE_componentWillReceiveProps(e){e.initialValue!==this.props.initialValue&&(this.value=e.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:s,label:n,labelClassName:i}=this.props;let a;return a=!t||this.state.phase===o.Display&&(n||i)&&!this.value?d.a.createElement("div",{className:e+" "+i,onClick:this.onClickDiv},n||s):d.a.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),a}},c()(i,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1}),n=a))||n},,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return W})),s.d(t,"c",(function(){return G})),s.d(t,"b",(function(){return H}));var n=s(204),i=s(84),a=s(741),o=s(169),r=s(87);class c extends o.a{onChange(e,t,s){r.a.dispatch({action:"feature_custom_status_changed"})}}var l=s(491),d=s(86);class h extends o.a{constructor(e,t){super(),this.setter=e,this.inverse=t}onChange(e,t,s){this.setter.call(d.a.get(),this.inverse?!s:s)}}var u=s(121);class m extends o.a{onChange(e,t,s){u.a.get().reload()}}var p=s(92);class g extends o.a{constructor(){super()}onChange(e,t,s){r.a.dispatch({action:p.a.UpdateFontSize,size:s})}}var v=s(89);class f extends o.a{constructor(){super()}onChange(e,t,s){r.a.dispatch({action:p.a.UpdateSystemFont,useSystemFont:v.b.getValue("useSystemFont"),font:s})}}class b extends o.a{constructor(){super()}onChange(e,t,s){r.a.dispatch({action:p.a.UpdateSystemFont,useSystemFont:s,font:v.b.getValue("systemFont")})}}var y=s(100),E=s(122),S=s(108);class _ extends o.a{constructor(e,t=!1){super(),this.uiFeatureName=e,this.forcedValue=t}getValueOverride(e,t,s,n){return this.settingDisabled?this.forcedValue:null}get settingDisabled(){return!v.b.getValue(this.uiFeatureName)}}var w=s(115);class C extends o.a{constructor(e){super(),this.controllers=e}getValueOverride(e,t,s,n){for(const i of this.controllers){const a=i.getValueOverride(e,t,s,n);if(null!=a)return a}return null}onChange(e,t,s){for(const n of this.controllers)n.onChange(e,t,s)}get settingDisabled(){for(const e of this.controllers)if(e.settingDisabled)return!0;return!1}}var O=s(133);class k extends o.a{getValueOverride(e,t,s,n){return!this.prefersReducedMotion()&&null}get settingDisabled(){return this.prefersReducedMotion()}prefersReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}}class R extends o.a{constructor(e,t=!1,s=!0){super(),this.settingName=e,this.forcedValue=t,this.incompatibleValue=s}getValueOverride(e,t,s,n){return this.incompatibleSetting?this.forcedValue:null}get settingDisabled(){return this.incompatibleSetting}get incompatibleSetting(){return v.b.getValue(this.settingName)===this.incompatibleValue}}var I=s(380);class x extends o.a{onChange(e,t,s){I.a.instance.updateAnonymityFromSettings(d.a.get().getUserId())}}var T=s(266),j=s(371),N=s(381),P=s(382),D=s(185);const M=[y.a.DEVICE,y.a.ROOM_DEVICE,y.a.ROOM_ACCOUNT,y.a.ACCOUNT,y.a.CONFIG],A=[y.a.ROOM_ACCOUNT,y.a.ACCOUNT],U=[y.a.DEVICE,y.a.ROOM_DEVICE,y.a.ROOM_ACCOUNT,y.a.ACCOUNT,y.a.CONFIG,y.a.ROOM],L=[y.a.DEVICE,y.a.ACCOUNT,y.a.CONFIG],F=[y.a.DEVICE,y.a.CONFIG],B=[y.a.DEVICE],V=[y.a.DEVICE,y.a.CONFIG],K=[y.a.CONFIG];let W;!function(e){e[e.Messaging=0]="Messaging",e[e.Profile=1]="Profile",e[e.Spaces=2]="Spaces",e[e.Widgets=3]="Widgets",e[e.Rooms=4]="Rooms",e[e.Moderation=5]="Moderation",e[e.Analytics=6]="Analytics",e[e.MessagePreviews=7]="MessagePreviews",e[e.Themes=8]="Themes",e[e.Encryption=9]="Encryption",e[e.Experimental=10]="Experimental",e[e.Developer=11]="Developer"}(W||(W={}));const G={[W.Messaging]:Object(i.b)("Messaging"),[W.Profile]:Object(i.b)("Profile"),[W.Spaces]:Object(i.b)("Spaces"),[W.Widgets]:Object(i.b)("Widgets"),[W.Rooms]:Object(i.b)("Rooms"),[W.Moderation]:Object(i.b)("Moderation"),[W.Analytics]:Object(i.b)("Analytics"),[W.MessagePreviews]:Object(i.b)("Message Previews"),[W.Themes]:Object(i.b)("Themes"),[W.Encryption]:Object(i.b)("Encryption"),[W.Experimental]:Object(i.b)("Experimental"),[W.Developer]:Object(i.b)("Developer")},H={feature_report_to_moderators:{isFeature:!0,labsGroup:W.Moderation,displayName:Object(i.b)("Report to moderators prototype. In rooms that support moderation, the `report` button will let you report abuse to room moderators"),supportedLevels:F,default:!1},feature_dnd:{isFeature:!0,labsGroup:W.Profile,displayName:Object(i.b)("Show options to enable 'Do not disturb' mode"),supportedLevels:F,default:!1},feature_latex_maths:{isFeature:!0,labsGroup:W.Messaging,displayName:Object(i.b)("Render LaTeX maths in messages"),supportedLevels:F,default:!1},feature_mark_unread:{isFeature:!0,labsGroup:W.Rooms,displayName:Object(i.b)("Mark rooms as unread"),supportedLevels:F,default:!0},feature_communities_v2_prototypes:{isFeature:!0,labsGroup:W.Spaces,displayName:Object(i.b)("Communities v2 prototypes. Requires compatible homeserver. Highly experimental - use with caution."),supportedLevels:F,default:!1,controller:new R("showCommunitiesInsteadOfSpaces",!1,!1)},feature_pinning:{isFeature:!0,labsGroup:W.Messaging,displayName:Object(i.b)("Message Pinning"),supportedLevels:F,default:!0},feature_maximised_widgets:{isFeature:!0,labsGroup:W.Widgets,displayName:Object(i.b)("Maximised widgets"),supportedLevels:F,default:!1},feature_thread:{isFeature:!0,labsGroup:W.Messaging,controller:new m,displayName:Object(i.b)("Threaded messaging"),supportedLevels:F,default:!1},feature_custom_status:{isFeature:!0,labsGroup:W.Profile,displayName:Object(i.b)("Custom user status messages"),supportedLevels:F,default:!1,controller:new c},feature_custom_tags:{isFeature:!0,labsGroup:W.Experimental,displayName:Object(i.b)("Group & filter rooms by custom tags (refresh to apply changes)"),supportedLevels:F,default:!1,controller:new R("showCommunitiesInsteadOfSpaces",!1,!1)},feature_state_counters:{isFeature:!0,labsGroup:W.Rooms,displayName:Object(i.b)("Render simple counters in room header"),supportedLevels:F,default:!1},feature_many_integration_managers:{isFeature:!0,labsGroup:W.Experimental,displayName:Object(i.b)("Multiple integration managers (requires manual setup)"),supportedLevels:F,default:!1},feature_mjolnir:{isFeature:!0,labsGroup:W.Moderation,displayName:Object(i.b)("Try out new ways to ignore people (experimental)"),supportedLevels:F,default:!1},feature_custom_themes:{isFeature:!0,labsGroup:W.Themes,displayName:Object(i.b)("Support adding custom themes"),supportedLevels:F,default:!1},feature_roomlist_preview_reactions_dms:{isFeature:!0,labsGroup:W.MessagePreviews,displayName:Object(i.b)("Show message previews for reactions in DMs"),supportedLevels:F,default:!0,controller:new R("feature_roomlist_preview_reactions_all")},feature_roomlist_preview_reactions_all:{isFeature:!0,labsGroup:W.MessagePreviews,displayName:Object(i.b)("Show message previews for reactions in all rooms"),supportedLevels:F,default:!0},feature_dehydration:{isFeature:!0,labsGroup:W.Encryption,displayName:Object(i.b)("Offline encrypted messaging using dehydrated devices"),supportedLevels:F,default:!1},feature_pseudonymous_analytics_opt_in:{isFeature:!0,labsGroup:W.Analytics,supportedLevels:F,displayName:Object(i.b)("Send pseudonymous analytics data"),default:!1,controller:new x},scShowUpdateAnnouncementRoomToast:{supportedLevels:V,default:!0},feature_polls:{isFeature:!0,labsGroup:W.Messaging,supportedLevels:F,displayName:Object(i.b)("Polls (under active development)"),default:!1},doNotDisturb:{supportedLevels:[y.a.DEVICE],default:!1},mjolnirRooms:{supportedLevels:[y.a.ACCOUNT],default:[]},mjolnirPersonalRoom:{supportedLevels:[y.a.ACCOUNT],default:null},feature_bridge_state:{isFeature:!0,labsGroup:W.Rooms,supportedLevels:F,displayName:Object(i.b)("Show info about bridges in room settings"),default:!1},feature_spaces_metaspaces:{isFeature:!0,labsGroup:W.Spaces,supportedLevels:F,displayName:Object(i.b)("Meta Spaces"),default:!1,controller:new C([new R("showCommunitiesInsteadOfSpaces"),new m])},"RoomList.backgroundImage":{supportedLevels:L,default:null},feature_hidden_read_receipts:{supportedLevels:F,displayName:Object(i.b)("Don't send read receipts"),default:!1},baseFontSize:{displayName:Object(i.b)("Font size"),supportedLevels:L,default:10,controller:new g},useCustomFontSize:{displayName:Object(i.b)("Use custom size"),supportedLevels:L,default:!1},"MessageComposerInput.suggestEmoji":{supportedLevels:L,displayName:Object(i.b)("Enable Emoji suggestions while typing"),default:!0,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},"MessageComposerInput.showStickersButton":{supportedLevels:L,displayName:Object(i.b)("Show stickers button"),default:!0},"Notifications.alwaysShowBadgeCounts":{supportedLevels:A,default:!1},useCompactLayout:{supportedLevels:B,displayName:Object(i.b)("Use a more compact 'Modern' layout"),default:!1},showRedactions:{supportedLevels:U,displayName:Object(i.b)("Show a placeholder for removed messages"),default:!1,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:U,displayName:Object(i.b)("Show join/leave messages (invites/kicks/bans unaffected)"),default:!0,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:U,displayName:Object(i.b)("Show avatar changes"),default:!0,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:U,displayName:Object(i.b)("Show display name changes"),default:!0,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:M,displayName:Object(i.b)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:L,displayName:Object(i.b)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:L,displayName:Object(i.b)("Always show message timestamps"),default:!0},autoplayGifs:{supportedLevels:L,displayName:Object(i.b)("Autoplay GIFs"),default:!0},autoplayVideo:{supportedLevels:L,displayName:Object(i.b)("Autoplay videos"),default:!1},enableSyntaxHighlightLanguageDetection:{supportedLevels:L,displayName:Object(i.b)("Enable automatic language detection for syntax highlighting"),default:!1},expandCodeByDefault:{supportedLevels:L,displayName:Object(i.b)("Expand code blocks by default"),default:!1},showCodeLineNumbers:{supportedLevels:L,displayName:Object(i.b)("Show line numbers in code blocks"),default:!0},scrollToBottomOnMessageSent:{supportedLevels:L,displayName:Object(i.b)("Jump to the bottom of the timeline when you send a message"),default:!0},"Pill.shouldShowPillAvatar":{supportedLevels:L,displayName:Object(i.b)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:L,displayName:Object(i.b)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:L,default:!1},"MessageComposer.showFormatting":{supportedLevels:L,default:!1},sendTypingNotifications:{supportedLevels:L,displayName:Object(i.b)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},showTypingNotifications:{supportedLevels:L,displayName:Object(i.b)("Show typing notifications"),default:!0},ctrlFForSearch:{supportedLevels:L,displayName:S.b?Object(i.b)("Use Command + F to search timeline"):Object(i.b)("Use Ctrl + F to search timeline"),default:!0},"MessageComposerInput.ctrlEnterToSend":{supportedLevels:L,displayName:S.b?Object(i.b)("Use Command + Enter to send a message"):Object(i.b)("Use Ctrl + Enter to send a message"),default:!1},"MessageComposerInput.surroundWith":{supportedLevels:L,displayName:Object(i.b)("Surround selected text when typing special characters"),default:!1},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:L,displayName:Object(i.b)("Automatically replace plain text Emoji"),default:!1},"VideoView.flipVideoHorizontally":{supportedLevels:L,displayName:Object(i.b)("Mirror local video feed"),default:!1},"TagPanel.enableTagPanel":{supportedLevels:L,displayName:Object(i.b)("Enable Community Filter Panel"),default:!0,invertedSettingName:"TagPanel.disableTagPanel",controller:new _(w.b.Communities,!0)},light_theme:{supportedLevels:L,default:"light",controller:new l.a("light")},dark_theme:{supportedLevels:L,default:"dark",controller:new l.a("dark")},theme_in_use:{supportedLevels:V,default:T.a.System},custom_themes:{supportedLevels:L,default:[]},userNameColorModeDM:{supportedLevels:V,default:j.a.Uniform},userNameColorModeGroup:{supportedLevels:V,default:j.a.Uniform},userNameColorModePublic:{supportedLevels:V,default:j.a.Uniform},useSystemFont:{supportedLevels:B,default:!1,displayName:Object(i.b)("Use a system font"),controller:new b},systemFont:{supportedLevels:B,default:"",displayName:Object(i.b)("System font name"),controller:new f},webRtcAllowPeerToPeer:{supportedLevels:V,displayName:Object(i.b)("Allow Peer-to-Peer for 1:1 calls (if you enable this, the other party might be able to see your IP address)"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:B,default:null},webrtc_audioinput:{supportedLevels:B,default:null},webrtc_videoinput:{supportedLevels:B,default:null},language:{supportedLevels:V,default:"en"},breadcrumb_rooms:{supportedLevels:[y.a.ACCOUNT],default:[]},recent_emoji:{supportedLevels:[y.a.ACCOUNT],default:[]},room_directory_servers:{supportedLevels:[y.a.ACCOUNT],default:[]},integrationProvisioning:{supportedLevels:[y.a.ACCOUNT],default:!0},allowedWidgets:{supportedLevels:[y.a.ROOM_ACCOUNT,y.a.ROOM_DEVICE],supportedLevelsAreOrdered:!0,default:{}},analyticsOptIn:{supportedLevels:V,displayName:Object(i.b)("Send analytics data"),default:!1},showCookieBar:{supportedLevels:V,default:!0},autocompleteDelay:{supportedLevels:V,default:200},readMarkerInViewThresholdMs:{supportedLevels:V,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:V,default:3e4},blacklistUnverifiedDevices:{supportedLevels:[y.a.ROOM_DEVICE,y.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:{default:Object(i.b)("Never send encrypted messages to unverified sessions from this session"),"room-device":Object(i.b)("Never send encrypted messages to unverified sessions in this room from this session")},default:!1,controller:new _(w.b.AdvancedEncryption)},urlPreviewsEnabled:{supportedLevels:U,displayName:{default:Object(i.b)("Enable inline URL previews by default"),"room-account":Object(i.b)("Enable URL previews for this room (only affects you)"),room:Object(i.b)("Enable URL previews by default for participants in this room")},default:!0,controller:new _(w.b.URLPreviews)},urlPreviewsEnabled_e2ee:{supportedLevels:[y.a.ROOM_DEVICE,y.a.ROOM_ACCOUNT],displayName:{"room-account":Object(i.b)("Enable URL previews for this room (only affects you)")},default:!1,controller:new _(w.b.URLPreviews)},notificationsEnabled:{supportedLevels:B,default:!1,controller:new a.b},notificationSound:{supportedLevels:A,default:!1},notificationBodyEnabled:{supportedLevels:B,default:!0,controller:new a.a},audioNotificationsEnabled:{supportedLevels:B,default:!0},enableWidgetScreenshots:{supportedLevels:L,displayName:Object(i.b)("Enable widget screenshots on supported widgets"),default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:L,displayName:Object(i.b)("Prompt before sending invites to potentially invalid matrix IDs"),default:!0},showDeveloperTools:{supportedLevels:L,displayName:Object(i.b)("Show developer tools"),default:!1},widgetOpenIDPermissions:{supportedLevels:B,default:{allow:[],deny:[]}},"RoomList.orderAlphabetically":{supportedLevels:L,displayName:Object(i.b)("Order rooms by name"),default:!1},"RoomList.orderByImportance":{supportedLevels:L,displayName:Object(i.b)("Show rooms with unread notifications first"),default:!0},unifiedRoomList:{supportedLevels:L,displayName:Object(i.b)("Show people and rooms in a combined list"),default:!0,controller:new m},roomListStyle:{supportedLevels:L,default:N.a.Roomy,controller:new m},breadcrumbs:{supportedLevels:L,displayName:Object(i.b)("Show shortcuts to recently viewed rooms above the room list"),default:!0},showHiddenEventsInTimeline:{displayName:Object(i.b)("Show hidden events in timeline"),supportedLevels:B,default:!1},lowBandwidth:{supportedLevels:V,displayName:Object(i.b)("Low bandwidth mode (requires compatible homeserver)"),default:!1,controller:new m},fallbackICEServerAllowed:{supportedLevels:B,displayName:Object(i.b)("Allow fallback call assist server turn.matrix.org when your homeserver does not offer one (your IP address would be shared during a call)"),default:null},showImages:{supportedLevels:L,displayName:Object(i.b)("Show previews/thumbnails for images"),default:!0},showRightPanelInRoom:{supportedLevels:B,default:!1},showRightPanelInGroup:{supportedLevels:B,default:!1},lastRightPanelPhaseForRoom:{supportedLevels:B,default:E.c.RoomSummary},lastRightPanelPhaseForGroup:{supportedLevels:B,default:E.c.GroupMemberList},enableEventIndexing:{supportedLevels:B,displayName:Object(i.b)("Enable message search in encrypted rooms"),default:!0},crawlerSleepTime:{supportedLevels:B,displayName:Object(i.b)("How fast should messages be downloaded."),default:3e3},showCallButtonsInComposer:{supportedLevels:V,default:!0,controller:new _(w.b.Voip)},"e2ee.manuallyVerifyAllSessions":{supportedLevels:B,displayName:Object(i.b)("Manually verify all remote sessions"),default:!1,controller:new C([new _(w.b.AdvancedEncryption),new h(n.b.prototype.setCryptoTrustCrossSignedDevices,!0)])},ircDisplayNameWidth:{supportedLevels:[y.a.ROOM_DEVICE,y.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:Object(i.b)("IRC display name width"),default:80},layout:{supportedLevels:L,default:O.a.Bubble},singleSideBubbles:{supportedLevels:U,displayName:Object(i.b)("Show message bubbles on one side only"),default:!1},adaptiveSideBubbles:{supportedLevels:U,displayName:Object(i.b)("Show message bubbles depending on the width either on both sides or only on one side"),default:!0},"Images.size":{supportedLevels:L,default:P.a.Normal},showChatEffects:{supportedLevels:U,displayName:Object(i.b)("Show chat effects (animations when receiving e.g. confetti)"),default:!0,controller:new k},"Performance.addSendMessageTimingMetadata":{supportedLevels:[y.a.CONFIG],default:!1},"Widgets.pinned":{supportedLevels:A,default:{}},"Widgets.layout":{supportedLevels:A,default:{}},"Widgets.leftPanel":{supportedLevels:L,default:null},"Spaces.allRoomsInHome":{displayName:Object(i.b)("Show all rooms in Home"),description:Object(i.b)("All rooms you're in will appear in Home."),supportedLevels:L,default:!0,controller:new R("showCommunitiesInsteadOfSpaces",null)},"Spaces.showSpaceMemberDMs":{displayName:Object(i.b)("Show people in spaces"),description:Object(i.b)("If disabled, you can still add Direct Messages to Personal Spaces. If enabled, you'll automatically see everyone who is a member of the Space."),supportedLevels:L,default:!1,controller:new R("showCommunitiesInsteadOfSpaces",null)},"Spaces.showSpaceDMBadges":{displayName:Object(i.b)("Show notification badges for People in Spaces"),supportedLevels:L,default:!0,controller:new R("showCommunitiesInsteadOfSpaces",null)},"Spaces.returnToPreviouslyOpenedRoom":{displayName:Object(i.b)("Return to the room previously opened in a space"),description:Object(i.b)("If disabled, the space overview will be shown when switching to another space."),supportedLevels:L,default:!1,controller:new R("showCommunitiesInsteadOfSpaces",null)},"Spaces.enabledMetaSpaces":{supportedLevels:L,default:{[D.a.Home]:!0},controller:new R("feature_spaces_metaspaces",{[D.a.Home]:!0},!1)},showCommunitiesInsteadOfSpaces:{displayName:Object(i.b)("Display Communities instead of Spaces"),description:Object(i.b)("Temporarily show communities instead of Spaces for this session. Support for this will be removed in the near future. This will reload Element."),supportedLevels:V,default:!1,controller:new m},developerMode:{displayName:Object(i.b)("Developer mode"),supportedLevels:L,default:!1},automaticErrorReporting:{displayName:Object(i.b)("Automatically send debug logs on any error"),supportedLevels:L,default:!1,controller:new m},[w.b.RoomHistorySettings]:{supportedLevels:K,default:!0},[w.b.AdvancedEncryption]:{supportedLevels:K,default:!0},[w.b.URLPreviews]:{supportedLevels:K,default:!0},[w.b.Widgets]:{supportedLevels:K,default:!0},[w.b.Voip]:{supportedLevels:K,default:!0},[w.b.Feedback]:{supportedLevels:K,default:!0},[w.b.Registration]:{supportedLevels:K,default:!0},[w.b.PasswordReset]:{supportedLevels:K,default:!0},[w.b.Deactivate]:{supportedLevels:K,default:!0},[w.b.ShareQRCode]:{supportedLevels:K,default:!0},[w.b.ShareSocial]:{supportedLevels:K,default:!0},[w.b.IdentityServer]:{supportedLevels:K,default:!0,controller:new _(w.b.ThirdPartyID)},[w.b.ThirdPartyID]:{supportedLevels:K,default:!0},[w.b.Flair]:{supportedLevels:K,default:!0,controller:new _(w.b.Communities)},[w.b.Communities]:{supportedLevels:K,default:!0,controller:new R("showCommunitiesInsteadOfSpaces",!1,!1)},[w.b.AdvancedSettings]:{supportedLevels:K,default:!0}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return L})),s.d(t,"b",(function(){return G}));var n=s(83),i=s.n(n),a=s(91),o=s.n(a),r=s(82),c=s.n(r),l=s(919),d=s.n(l);class h{constructor(){i()(this,"stack",[]),i()(this,"newlyTypedCharCount",0),i()(this,"currentIndex",-1),i()(this,"changedSinceLastPush",!1),i()(this,"lastCaret",null),i()(this,"nonWordBoundarySinceLastPush",!1),i()(this,"addedSinceLastPush",!1),i()(this,"removedSinceLastPush",!1)}clear(){this.stack=[],this.newlyTypedCharCount=0,this.currentIndex=-1,this.changedSinceLastPush=!1,this.lastCaret=null,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}shouldPush(e,t){if(t&&("insertText"===e||"deleteContentForward"===e||"deleteContentBackward"===e)){if(t.added&&(this.addedSinceLastPush=!0),t.removed&&(this.removedSinceLastPush=!0),this.addedSinceLastPush!==this.removedSinceLastPush){const e=t.added?t.added:t.removed,s=" "===e||"\t"===e||"\n"===e;return!(!this.nonWordBoundarySinceLastPush||!s)||(s||(this.nonWordBoundarySinceLastPush=!0),this.newlyTypedCharCount+=e.length,this.newlyTypedCharCount>10)}return!0}return!0}pushState(e,t){for(;this.currentIndex<this.stack.length-1;)this.stack.pop();const s=e.serializeParts();this.stack.push({parts:s,caret:t}),this.currentIndex=this.stack.length-1,this.lastCaret=null,this.changedSinceLastPush=!1,this.newlyTypedCharCount=0,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}tryPush(e,t,s,n){if("historyUndo"===s||"historyRedo"===s)return!1;const i=this.shouldPush(s,n);return i?this.pushState(e,t):(this.lastCaret=t,this.changedSinceLastPush=!0),i}ensureLastChangesPushed(e){this.changedSinceLastPush&&this.pushState(e,this.lastCaret)}canUndo(){return this.currentIndex>=1||this.changedSinceLastPush}canRedo(){return this.currentIndex<this.stack.length-1}undo(e){if(this.canUndo())return this.ensureLastChangesPushed(e),this.currentIndex-=1,this.stack[this.currentIndex]}redo(){if(this.canRedo())return this.changedSinceLastPush=!1,this.currentIndex+=1,this.stack[this.currentIndex]}}var u=s(573),m=s(572),p=s(222);function g(e,t,s){s instanceof m.a?function(e,t,s){const n=document.getSelection();n.removeAllRanges();const i=document.createRange(),a=v(e,t,s.start);i.setStart(a.node,a.offset);const o=v(e,t,s.end);i.setEnd(o.node,o.offset),n.addRange(i)}(e,t,s):function(e,t,s){const n=document.createRange(),{node:i,offset:a}=v(e,t,s);n.setStart(i,a),n.collapse(!0);const o=document.getSelection();if(1===o.rangeCount){const e=o.getRangeAt(0);if(e.startContainer===n.startContainer&&e.startOffset===n.startOffset&&e.collapsed===n.collapsed)return}o.removeAllRanges(),o.addRange(n)}(e,t,s)}function v(e,t,s){const{offset:n,lineIndex:i,nodeIndex:a}=function(e,t){const{parts:s}=e,n=t.index,i=function(e,t){let s=0,n=-1,i=null;for(let a=0;a<=t;++a){const o=e[a];if(o.type===p.b.Newline)s+=1,n=-1,i=null;else{if(n+=1,Object(u.d)(o,i)&&(n+=1),a<t){const t=e[a+1],s=!t||t.type===p.b.Newline;Object(u.c)(o,s)&&(n+=1)}i=o}}return{lineIndex:s,nodeIndex:n}}(s,n),{lineIndex:a}=i;let{nodeIndex:o}=i,{offset:r}=t;-1===o?r=0:({nodeIndex:o,offset:r}=function(e,t,s,n){const i=e[t];if(i&&!i.canEdit)if(0===n){s-=1;const a=e[t-1];Object(u.d)(i,a)||(n=a.text.length)}else s+=1,n=0;return{nodeIndex:s,offset:n}}(s,n,o,r));return{lineIndex:a,nodeIndex:o,offset:r}}(t,s),o=e.childNodes[i];let r;return-1===a?r=o:(r=o.childNodes[a],r.nodeType===Node.ELEMENT_NODE&&r.firstChild&&(r=r.firstChild)),{node:r,offset:n}}function f(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,i=e.replace(t),a=e.start.asOffset(s),o=a.add(n+i);return s.startRange(a.asPosition(s),o.asPosition(s))})}function b(e,t,s=0){const{model:n}=e;n.transform(()=>{const i=e.length,a=e.replace(t);return e.start.asOffset(n).add(i+a+s).asPosition(n)})}function y(e){const{model:t}=e,s=0!==e.start.offset,n=0===e.start.index,i=!n&&t.parts[e.start.index-1].type===p.b.Newline;return!s&&(n||i)}function E(e){const{model:t}=e,s=t.parts[e.end.index],n=e.end.offset!==s.text.length,i=e.end.index===t.parts.length-1,a=!i&&t.parts[e.end.index+1].type===p.b.Newline;return!n&&(i||a)}const S=e=>!e.text||!/\S/.test(e.text),_=e=>e.type===p.b.Newline;function w(e,t,s=t){const{model:n,parts:i}=e,{partCreator:a}=n,o=[];let r=0;for(let e=2;e<i.length;e++)S(i[e-2])&&_(i[e-1])&&!_(i[e])&&!S(i[e])&&(r=e),_(i[e-1])&&_(i[e])?(o.push([r,e-1]),r=e+1):_(i[e-2])&&S(i[e-1])&&_(i[e])&&(o.push([r,e-2]),r=e+1);const c=i.map(S).lastIndexOf(!1);r<=c&&o.push([r,c+1]);let l=0;o.forEach(([e,n])=>{const o=e+l,r=n+l;if(r-o>0&&i[o].text.startsWith(t)&&i[r-1].text.endsWith(s)){const e=i[o].serialize();e.text=e.text.substr(t.length),i[o]=a.deserializePart(e);const n=i[r-1].serialize(),c=n.text;n.text=c.substring(0,c.length-s.length),i[r-1]=a.deserializePart(n)}else i.splice(r,0,a.plain(s)),i.splice(o,0,a.plain(t)),l+=2}),f(e,i)}var C,O=s(574),k=s(1025),R=s(920),I=s(814),x=s(89),T=s(108),j=s(305),N=s(333),P=s(921),D=s(195),M=s(85),A=s(1);const U=new RegExp("(?:^|\\s)("+d.a.source+")\\s|:^$"),L=new RegExp("(?:^|\\s)("+d.a.source+")$"),F=-1!==navigator.platform.indexOf("Mac"),B=['"',"_","`","'","*","~","$"],V=new Map([["(",")"],["[","]"],["{","}"],["<",">"]]);function K(e){return(F?"⌘":"Ctrl")+"+"+e}function W(e){return{anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed,rangeCount:e.rangeCount,type:e.type}}let G=Object(M.a)("views.rooms.BasicMessageEditor")(C=class extends c.a.Component{constructor(e){super(e),i()(this,"editorRef",Object(r.createRef)()),i()(this,"autocompleteRef",Object(r.createRef)()),i()(this,"formatBarRef",Object(r.createRef)()),i()(this,"modifiedFlag",!1),i()(this,"isIMEComposing",!1),i()(this,"hasTextSelected",!1),i()(this,"_isCaretAtEnd",void 0),i()(this,"lastCaret",void 0),i()(this,"lastSelection",void 0),i()(this,"emoticonSettingHandle",void 0),i()(this,"shouldShowPillAvatarSettingHandle",void 0),i()(this,"surroundWithHandle",void 0),i()(this,"historyManager",new h),i()(this,"updateEditorState",(e,t,s)=>{if(Object(u.e)(this.editorRef.current,this.props.model),e){try{g(this.editorRef.current,this.props.model,e)}catch(e){A.a.error(e)}const t=e instanceof m.a?e.end:e;this.setLastCaretFromPosition(t)}const{isEmpty:n}=this.props.model;this.props.placeholder&&(n?this.showPlaceholder():this.hidePlaceholder()),n&&this.formatBarRef.current.hide(),this.setState({autoComplete:this.props.model.autoComplete,showVisualBell:!s&&this.state.showVisualBell}),this.historyManager.tryPush(this.props.model,e,t,s);let i=!this.props.model.isEmpty;if(i&&"command"===this.props.model.parts[0].type){const{cmd:e}=Object(N.e)(this.props.model.parts[0].text),t=N.b.get(e);t&&t.isEnabled()&&t.category===N.a.messages||(i=!1)}I.a.sharedInstance().setSelfTyping(this.props.room.roomId,this.props.threadId,i),this.props.onChange&&this.props.onChange()}),i()(this,"onCompositionStart",()=>{this.isIMEComposing=!0,this.hidePlaceholder()}),i()(this,"onCompositionEnd",()=>{this.isIMEComposing=!1;const e=navigator.userAgent.toLowerCase();e.includes("safari/")&&!e.includes("chrome/")?this.onInput({inputType:"insertCompositionText"}):Promise.resolve().then(()=>{this.onInput({inputType:"insertCompositionText"})})}),i()(this,"onCutCopy",(e,t)=>{const s=document.getSelection(),n=s.toString();if(n){const{model:i}=this.props,a=Object(O.b)(this.editorRef.current,i,s),o=a.parts.map(e=>e.serialize());e.clipboardData.setData("application/x-element-composer",JSON.stringify(o)),e.clipboardData.setData("text/plain",n),"cut"===t&&(this.modifiedFlag=!0,b(a,[])),e.preventDefault()}}),i()(this,"onCopy",e=>{this.onCutCopy(e,"copy")}),i()(this,"onCut",e=>{this.onCutCopy(e,"cut")}),i()(this,"onPaste",e=>{if(e.preventDefault(),this.props.onPaste&&this.props.onPaste(e,this.props.model))return!0;const{model:t}=this.props,{partCreator:s}=t,n=e.clipboardData.getData("application/x-element-composer");let i;if(n){i=JSON.parse(n).map(e=>s.deserializePart(e))}else{const t=e.clipboardData.getData("text/plain");i=Object(R.b)(t,s)}this.modifiedFlag=!0;b(Object(O.b)(this.editorRef.current,t,document.getSelection()),i)}),i()(this,"onInput",e=>{if(this.isIMEComposing)return;this.modifiedFlag=!0;const t=document.getSelection(),{caret:s,text:n}=Object(O.a)(this.editorRef.current,t);this.props.model.update(n,e.inputType,s)}),i()(this,"onBlur",()=>{document.removeEventListener("selectionchange",this.onSelectionChange)}),i()(this,"onFocus",()=>{document.addEventListener("selectionchange",this.onSelectionChange),this.lastSelection=null,this.refreshLastCaretIfNeeded()}),i()(this,"onSelectionChange",()=>{const{isEmpty:e}=this.props.model;this.refreshLastCaretIfNeeded();const t=document.getSelection();if(this.hasTextSelected&&t.isCollapsed)this.hasTextSelected=!1,this.formatBarRef.current&&this.formatBarRef.current.hide();else if(!t.isCollapsed&&!e&&(this.hasTextSelected=!0,this.formatBarRef.current)){const e=t.getRangeAt(0).getBoundingClientRect();this.formatBarRef.current.showAt(e)}}),i()(this,"onKeyDown",e=>{var t;const s=this.props.model;let n=!1;if(this.state.surroundWith&&"Caret"!==document.getSelection().type){const t=Object(O.b)(this.editorRef.current,this.props.model,document.getSelection());t.trim(),[...V.keys(),...B].includes(e.key)&&(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,w(t,e.key,V.get(e.key)),n=!0)}const i=Object(D.f)().getAutocompleteAction(e);if(null!==(t=s.autoComplete)&&void 0!==t&&t.hasCompletions()){const t=s.autoComplete;switch(i){case D.a.ForceComplete:case D.a.Complete:this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,t.confirmCompletion(),n=!0;break;case D.a.PrevSelection:t.selectPreviousSelection(),n=!0;break;case D.a.NextSelection:t.selectNextSelection(),n=!0;break;case D.a.Cancel:t.onEscape(e),n=!0;break;default:return}}else i!==D.a.ForceComplete||this.state.showVisualBell?e.key!==T.a.BACKSPACE&&e.key!==T.a.DELETE||this.formatBarRef.current.hide():(this.tabCompleteName(),n=!0);if(n)return e.preventDefault(),void e.stopPropagation();switch(Object(D.f)().getMessageComposerAction(e)){case D.b.FormatBold:this.onFormatAction(P.a.Bold),n=!0;break;case D.b.FormatItalics:this.onFormatAction(P.a.Italics),n=!0;break;case D.b.FormatQuote:this.onFormatAction(P.a.Quote),n=!0;break;case D.b.EditRedo:if(this.historyManager.canRedo()){const{parts:e,caret:t}=this.historyManager.redo();s.reset(e,t,"historyRedo")}n=!0;break;case D.b.EditUndo:if(this.historyManager.canUndo()){const{parts:e,caret:t}=this.historyManager.undo(this.props.model);s.reset(e,t,"historyUndo")}n=!0;break;case D.b.NewLine:this.insertText("\n"),n=!0;break;case D.b.MoveCursorToStart:g(this.editorRef.current,s,{index:0,offset:0}),n=!0;break;case D.b.MoveCursorToEnd:g(this.editorRef.current,s,{index:s.parts.length-1,offset:s.parts[s.parts.length-1].text.length}),n=!0}n&&(e.preventDefault(),e.stopPropagation())}),i()(this,"onAutoCompleteConfirm",e=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentConfirm(e)}),i()(this,"onAutoCompleteSelectionChange",e=>{this.modifiedFlag=!0,this.setState({completionIndex:e})}),i()(this,"configureEmoticonAutoReplace",()=>{this.props.model.setTransformCallback(this.transform)}),i()(this,"configureShouldShowPillAvatar",()=>{const e=x.b.getValue("Pill.shouldShowPillAvatar");this.setState({showPillAvatar:e})}),i()(this,"surroundWithSettingChanged",()=>{const e=x.b.getValue("MessageComposerInput.surroundWith");this.setState({surroundWith:e})}),i()(this,"transform",e=>{x.b.getValue("MessageComposerInput.autoReplaceEmoji")&&this.replaceEmoticon(e,U)}),i()(this,"onFormatAction",e=>{const t=Object(O.b)(this.editorRef.current,this.props.model,document.getSelection());if(t.trim(),0!==t.length)switch(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,e){case P.a.Bold:w(t,"**");break;case P.a.Italics:w(t,"_");break;case P.a.Strikethrough:w(t,"<del>","</del>");break;case P.a.Code:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;s.some(e=>e.type===p.b.Newline)?(s.unshift(n.plain("```"),n.newline()),y(e)||s.unshift(n.newline()),s.push(n.newline(),n.plain("```")),E(e)||s.push(n.newline())):(s.unshift(n.plain("`")),s.push(n.plain("`"))),f(e,s)}(t);break;case P.a.Quote:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;for(let e=0;e<s.length;++e){s[e].type===p.b.Newline&&s.splice(e+1,0,n.plain("> "))}s.unshift(n.plain("> ")),y(e)||s.unshift(n.newline()),E(e)||s.push(n.newline()),s.push(n.newline()),f(e,s)}(t);break;case P.a.InsertLink:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;s.unshift(n.plain("[")),s.push(n.plain("]()")),b(e,s,-1)}(t)}}),this.state={showPillAvatar:x.b.getValue("Pill.shouldShowPillAvatar"),surroundWith:x.b.getValue("MessageComposerInput.surroundWith"),showVisualBell:!1},this.emoticonSettingHandle=x.b.watchSetting("MessageComposerInput.autoReplaceEmoji",null,this.configureEmoticonAutoReplace),this.configureEmoticonAutoReplace(),this.shouldShowPillAvatarSettingHandle=x.b.watchSetting("Pill.shouldShowPillAvatar",null,this.configureShouldShowPillAvatar),this.surroundWithHandle=x.b.watchSetting("MessageComposerInput.surroundWith",null,this.surroundWithSettingChanged)}componentDidUpdate(e){const t=this.props.disabled!==e.disabled,s=this.props.placeholder!==e.placeholder;if(this.props.placeholder&&(s||t)){const{isEmpty:e}=this.props.model;e?this.showPlaceholder():this.hidePlaceholder()}}replaceEmoticon(e,t){const{model:s}=this.props,n=s.startRange(e);let i=8;n.expandBackwardsWhile((e,t)=>{const n=s.parts[e];return i-=1,i>=0&&[p.b.Plain,p.b.PillCandidate,p.b.Newline].includes(n.type)});const a=t.exec(n.text);if(a){const e=a[1].replace("-",""),t=j.c.get(e)||j.c.get(e.toLowerCase());if(t){const{partCreator:e}=s,i=a[0],o=" "===i[0]?1:0;return n.moveStartForwards(a.index+o),["\n"," "].includes(i[i.length-1])&&n.moveEndBackwards(1),n.replace([e.plain(t.unicode)])}}}showPlaceholder(){const e=this.props.placeholder.replace(/'/g,"\\'");this.editorRef.current.style.setProperty("--placeholder",`'${e}'`),this.editorRef.current.classList.add("mx_BasicMessageComposer_inputEmpty")}hidePlaceholder(){this.editorRef.current.classList.remove("mx_BasicMessageComposer_inputEmpty"),this.editorRef.current.style.removeProperty("--placeholder")}isComposing(e){return!!(this.isIMEComposing||e.nativeEvent&&e.nativeEvent.isComposing)}insertText(e,t="insertText"){const s=document.getSelection(),{caret:n,text:i}=Object(O.a)(this.editorRef.current,s),a=i.substr(0,n.offset)+e+i.substr(n.offset);n.offset+=e.length,this.modifiedFlag=!0,this.props.model.update(a,t,n)}setLastCaretFromPosition(e){const{model:t}=this.props;this._isCaretAtEnd=e.isAtEnd(t),this.lastCaret=e.asOffset(t),this.lastSelection=W(document.getSelection())}refreshLastCaretIfNeeded(){if(!this.editorRef.current)return;const e=document.getSelection();if(!this.lastSelection||(t=this.lastSelection,s=e,t.anchorNode!==s.anchorNode||t.anchorOffset!==s.anchorOffset||t.focusNode!==s.focusNode||t.focusOffset!==s.focusOffset||t.isCollapsed!==s.isCollapsed||t.rangeCount!==s.rangeCount||t.type!==s.type)){this.lastSelection=W(e);const{caret:t,text:s}=Object(O.a)(this.editorRef.current,e);this.lastCaret=t,this._isCaretAtEnd=t.offset===s.length}var t,s;return this.lastCaret}clearUndoHistory(){this.historyManager.clear()}getCaret(){return this.lastCaret}isSelectionCollapsed(){return!this.lastSelection||this.lastSelection.isCollapsed}isCaretAtStart(){return 0===this.getCaret().offset}isCaretAtEnd(){return this._isCaretAtEnd}async tabCompleteName(){try{await new Promise(e=>this.setState({showVisualBell:!1},e));const{model:e}=this.props,t=this.getCaret(),s=e.positionForOffset(t.offset,t.atNodeEnd),n=e.startRange(s);n.expandBackwardsWhile((e,t,s)=>" "!==s.text[t]&&"+"!==s.text[t]&&(s.type===p.b.Plain||s.type===p.b.PillCandidate||s.type===p.b.Command));const{partCreator:i}=e;await e.transform(()=>{const s=n.replace([i.pillCandidate(n.text)]);return e.positionForOffset(t.offset+s,!0)}),e.autoComplete?(await e.autoComplete.startSelection(),e.autoComplete.hasSelection()||(this.setState({showVisualBell:!0}),e.autoComplete.close())):this.setState({showVisualBell:!0})}catch(e){A.a.error(e)}}isModified(){return this.modifiedFlag}componentWillUnmount(){document.removeEventListener("selectionchange",this.onSelectionChange),this.editorRef.current.removeEventListener("input",this.onInput,!0),this.editorRef.current.removeEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.removeEventListener("compositionend",this.onCompositionEnd,!0),x.b.unwatchSetting(this.emoticonSettingHandle),x.b.unwatchSetting(this.shouldShowPillAvatarSettingHandle),x.b.unwatchSetting(this.surroundWithHandle)}componentDidMount(){const e=this.props.model;e.setUpdateCallback(this.updateEditorState);e.partCreator.setAutoCompleteCreator(Object(p.c)(()=>this.autocompleteRef.current,e=>new Promise(t=>this.setState({query:e},t)))),this.updateEditorState(this.getInitialCaretPosition()),this.editorRef.current.addEventListener("input",this.onInput,!0),this.editorRef.current.addEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.addEventListener("compositionend",this.onCompositionEnd,!0),this.editorRef.current.focus()}getInitialCaretPosition(){let e;if(this.props.initialCaret){const t=this.props.initialCaret;e=this.props.model.positionForOffset(t.offset,t.atNodeEnd)}else e=this.props.model.getPositionAtEnd();return e}render(){let e;if(this.state.autoComplete){const t=this.state.query,s=t.length;e=c.a.createElement("div",{className:"mx_BasicMessageComposer_AutoCompleteWrapper"},c.a.createElement(k.a,{ref:this.autocompleteRef,query:t,onConfirm:this.onAutoCompleteConfirm,onSelectionChange:this.onAutoCompleteSelectionChange,selection:{beginning:!0,end:s,start:s},room:this.props.room}))}const t=o()("mx_BasicMessageComposer",{mx_BasicMessageComposer_input_error:this.state.showVisualBell}),s=o()("mx_BasicMessageComposer_input",{mx_BasicMessageComposer_input_shouldShowPillAvatar:this.state.showPillAvatar,mx_BasicMessageComposer_input_disabled:this.props.disabled}),n={[P.a.Bold]:K("B"),[P.a.Italics]:K("I"),[P.a.Quote]:K(">")},{completionIndex:i}=this.state,a=Boolean(this.state.autoComplete);let r;return a&&i>=0&&(r=Object(k.b)(i)),c.a.createElement("div",{className:t},e,c.a.createElement(P.b,{ref:this.formatBarRef,onAction:this.onFormatAction,shortcuts:n}),c.a.createElement("div",{className:s,contentEditable:!this.props.disabled||null,tabIndex:0,onBlur:this.onBlur,onFocus:this.onFocus,onCopy:this.onCopy,onCut:this.onCut,onPaste:this.onPaste,onKeyDown:this.onKeyDown,ref:this.editorRef,"aria-label":this.props.label,role:"textbox","aria-multiline":"true","aria-autocomplete":"list","aria-haspopup":"listbox","aria-expanded":a,"aria-owns":"mx_Autocomplete","aria-activedescendant":r,dir:"auto","aria-disabled":this.props.disabled}))}focus(){this.editorRef.current.focus()}insertMention(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:s}=t,n=this.props.room.getMember(e),i=n?n.rawDisplayName:e,a=this.getCaret(),o=t.positionForOffset(a.offset,a.atNodeEnd),r=s.createMentionParts(0===a.offset,i,e);t.transform(()=>{const e=t.insert(r,o);return t.positionForOffset(a.offset+e,!0)}),this.focus()}insertQuotedMessage(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:s}=t,n=Object(R.a)(e,s,{isQuotedMessage:!0});n.push(s.newline()),n.push(s.newline()),t.transform(()=>{const e=t.insert(n,t.positionForOffset(0));return t.positionForOffset(e,!0)}),this.focus()}insertPlaintext(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:s}=t,n=this.getCaret(),i=t.positionForOffset(n.offset,n.atNodeEnd);t.transform(()=>{const a=t.insert([s.plain(e)],i);return t.positionForOffset(n.offset+a,!0)})}})||C},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(97),r=s(109),c=s(101),l=s(216),d=s(137),h=s(887),u=s(160),m=s(1600),p=s(83),g=s.n(p),v=s(567),f=s(136),b=s(134),y=s(94),E=s(1);class S extends v.a{constructor(e,t,s,n){super(e,t,s,n),g()(this,"totalSize",0),g()(this,"messages",[])}createJSONString(){var e,t,s,n,i,a,o;const r=Object(f.e)(new Date),c=null===(e=this.room.currentState.getStateEvents(y.a.RoomCreate,""))||void 0===e?void 0:e.getSender(),l=(null===(t=this.room)||void 0===t||null===(s=t.getMember(c))||void 0===s?void 0:s.rawDisplayName)||c,d=(null===(n=this.room.currentState.getStateEvents(y.a.RoomTopic,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.topic)||"",h=this.client.getUserId(),u=(null===(a=this.room)||void 0===a||null===(o=a.getMember(h))||void 0===o?void 0:o.rawDisplayName)||h,m={room_name:this.room.name,room_creator:l,topic:d,export_date:r,exported_by:u,messages:this.messages};return JSON.stringify(m,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const s=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(s,t)}}catch(e){E.a.log("Error fetching file: "+e)}const t=e.toJSON();return e.isEncrypted()?t.decrypted:t}async createOutput(e){for(let t=0;t<e.length;t++){const s=e[t];if(this.updateProgress(`Processing event ${t+1} out of ${e.length}`,!1,!0),this.cancelled)return this.cleanUp();Object(b.d)(s)&&this.messages.push(await this.getJSONString(s))}return this.createJSONString()}async export(){E.a.info("Starting export process..."),E.a.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),s=performance.now();E.a.log(`Fetched ${t.length} events in ${(s-e)/1e3}s`),E.a.info("Creating output...");const n=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([n])),await this.downloadZIP();else{const e=`matrix-export-${Object(f.d)(new Date)}.json`;this.downloadPlainText(e,n)}const i=performance.now();this.cancelled?E.a.info("Export cancelled successfully"):(E.a.info("Export successful!"),E.a.log(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}var _=s(255);class w extends v.a{constructor(e,t,s,n){super(e,t,s,n),g()(this,"totalSize",void 0),g()(this,"mediaOmitText",void 0),g()(this,"textForReplyEvent",e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let s;const n=t[1],i=t[3];s=t[2].substring(1);const a=s.split("\n").filter(e=>!/^\s*$/.test(e));return a.length>0?(s=a[0].substring(0,32),a[0].length>32&&(s+="..."),s=` "${s}"`):s="",`<${n}${s}> ${i}`}),g()(this,"plainTextForEvent",async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let s="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)s=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const n=this.getFilePath(e);s=" ("+Object(a.a)("File Attached")+")",this.addFile(n,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){s=" ("+Object(a.a)("Error fetching file")+")",E.a.log("Error fetching file "+e)}else s=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+s:Object(_.b)(e)+s}),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?Object(a.a)("Media omitted - file size limit exceeded"):Object(a.a)("Media omitted")}async createOutput(e){let t="";for(let s=0;s<e.length;s++){const n=e[s];if(this.updateProgress(`Processing event ${s+1} out of ${e.length}`,!1,!0),this.cancelled)return this.cleanUp();if(!Object(b.d)(n))continue;const i=await this.plainTextForEvent(n);t+=i&&`${new Date(n.getTs()).toLocaleString()} - ${i}\n`}return t}async export(){this.updateProgress("Starting export process..."),this.updateProgress("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),s=performance.now();E.a.log(`Fetched ${t.length} events in ${(s-e)/1e3}s`),this.updateProgress("Creating output...");const n=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([n])),await this.downloadZIP();else{const e=`matrix-export-${Object(f.d)(new Date)}.txt`;this.downloadPlainText(e,n)}const i=performance.now();this.cancelled?E.a.info("Export cancelled successfully"):(E.a.info("Export successful!"),E.a.log(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}var C=s(894),O=s(96),k=s(166);t.a=({room:e,onFinished:t})=>{const[s,p]=Object(n.useState)(h.a.Html),[g,v]=Object(n.useState)(h.b.Timeline),[f,b]=Object(n.useState)(!1),[y,_]=Object(n.useState)(!1),[R,I]=Object(n.useState)(100),[x,T]=Object(n.useState)(8),j=Object(n.useRef)(),N=Object(n.useRef)(),[P,D]=Object(n.useState)("Processing..."),[M,A]=Object(n.useState)(!1),[U,L]=Object(n.useState)(!1),[F,B]=Object(n.useState)(!1),[V,K]=Object(C.a)(null,async e=>{await(null==e?void 0:e.export().then(()=>{U||B(!0)}))}),W=async()=>{if(await j.current.validate({focused:!1})){if(g===h.b.LastNMessages){if(!await N.current.validate({focused:!1}))return void N.current.validate({focused:!0})}_(!0),await(async()=>{const t={numberOfMessages:R,attachmentsIncluded:f,maxSize:1024*x*1024};switch(s){case h.a.Html:K(new m.a(e,h.b[g],t,D));break;case h.a.Json:K(new S(e,h.b[g],t,D));break;case h.a.PlainText:K(new w(e,h.b[g],t,D));break;default:return void E.a.error("Unknown export format")}})()}else j.current.validate({focused:!0})},G=Object(u.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(a.a)("Enter a number between %(min)s and %(max)s",{min:1,max:10**8})},{key:"number",test:({value:e})=>{const t=parseFloat(e);return!(isNaN(t)||1>t||t>2e3)},invalid:()=>Object(a.a)("Size can only be a number between %(min)s MB and %(max)s MB",{min:1,max:2e3})}]}),H=async e=>await G(e),q=Object(u.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(a.a)("Enter a number between %(min)s and %(max)s",{min:1,max:10**8})},{key:"number",test:({value:e})=>{const t=parseFloat(e);return!isNaN(t)&&!(1>t||t>10**8)},invalid:()=>Object(a.a)("Number of messages can only be a number between %(min)s and %(max)s",{min:1,max:10**8})}]}),$=async e=>await q(e),z=async()=>{y?A(!0):t(!1)},J=async()=>{await(null==V?void 0:V.cancelExport()),L(!0),_(!1),K(null)},Y=Object.keys(h.a).map(e=>({value:h.a[e],label:Object(h.c)(h.a[e])})),Q=Object.keys(h.b).map(e=>i.a.createElement("option",{key:e,value:h.b[e]},Object(h.d)(h.b[e])));let X=null;g===h.b.LastNMessages&&(X=i.a.createElement(c.a,{element:"input",type:"number",value:R.toString(),ref:N,onValidate:$,label:Object(a.a)("Number of messages"),onChange:e=>{I(parseInt(e.target.value))}}));const Z=i.a.createElement("span",null,Object(a.a)("MB"));return U?i.a.createElement(k.a,{title:Object(a.a)("Export Successful"),description:Object(a.a)("The export was cancelled successfully"),hasCloseButton:!0,onFinished:t}):F?i.a.createElement(k.a,{title:Object(a.a)("Export Successful"),description:Object(a.a)("Your export was successful. Find it in your Downloads folder."),hasCloseButton:!0,onFinished:t}):M?i.a.createElement(o.a,{title:Object(a.a)("Warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:t,fixedWidth:!0},i.a.createElement("p",null,Object(a.a)("Are you sure you want to stop exporting your data? If you do, you'll need to start over.")),i.a.createElement(r.a,{primaryButton:Object(a.a)("Stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:Object(a.a)("Continue"),onCancel:()=>A(!1),onPrimaryButtonClick:J})):i.a.createElement(o.a,{title:y?Object(a.a)("Exporting your data"):Object(a.a)("Export Chat"),className:"mx_ExportDialog "+(y&&"mx_ExportDialog_Exporting"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:t,fixedWidth:!0},y?null:i.a.createElement("p",null,Object(a.a)("Select from the options below to export chats from your timeline")),i.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(a.a)("Format")),i.a.createElement("div",{className:"mx_ExportDialog_options"},i.a.createElement(l.a,{name:"exportFormat",value:s,onChange:e=>p(h.a[e]),definitions:Y}),i.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(a.a)("Messages")),i.a.createElement(c.a,{element:"select",value:g,onChange:e=>{v(h.b[e.target.value])}},Q),X,i.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(a.a)("Size Limit")),i.a.createElement(c.a,{type:"number",autoComplete:"off",onValidate:H,element:"input",ref:j,value:x.toString(),postfixComponent:Z,onChange:e=>T(parseInt(e.target.value))}),i.a.createElement(d.b,{checked:f,onChange:e=>b(e.target.checked)},Object(a.a)("Include Attachments"))),y?i.a.createElement("div",{className:"mx_ExportDialog_progress"},i.a.createElement(O.a,{w:24,h:24}),i.a.createElement("p",null,P),i.a.createElement(r.a,{primaryButton:Object(a.a)("Cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:z})):i.a.createElement(r.a,{primaryButton:Object(a.a)("Export"),onPrimaryButtonClick:W,onCancel:()=>t(!1)}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i=s(95),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(145),d=s(84),h=s(752),u=s(262),m=s(598),p=s(167),g=s(83),v=s.n(g),f=s(203),b=s(123),y=s(86),E=s(116),S=s(132),_=s(94),w=s(1);class C{constructor(e,t){this.client=e,this.room=t,v()(this,"playbacks",new Map),v()(this,"clockStates",new Map),v()(this,"playbackIdOrder",[]),v()(this,"currentPlaybackId",void 0),v()(this,"recentFullPlays",new Set),this.loadClocks(),S.a.addListener(()=>{S.a.getRoomId()===this.room.roomId&&(this.currentPlaybackId=null,this.recentFullPlays=new Set,this.playbackIdOrder=[])})}static forRoom(e){const t=y.a.get(),s=t.getRoom(e);if(!s)throw new Error("Unknown room");if(C.queues.has(s.roomId))return C.queues.get(s.roomId);const n=new C(t,s);return C.queues.set(s.roomId,n),n}persistClocks(){localStorage.setItem("mx_voice_message_clocks_"+this.room.roomId,JSON.stringify(Array.from(this.clockStates.entries())))}loadClocks(){const e=localStorage.getItem("mx_voice_message_clocks_"+this.room.roomId);e&&(this.clockStates=new Map(JSON.parse(e)))}unsortedEnqueue(e,t){this.playbacks.set(e.getId(),t),t.on(b.b,s=>this.onPlaybackStateChange(t,e,s)),t.clockInfo.liveData.onUpdate(s=>this.onPlaybackClock(t,e,s))}onPlaybackStateChange(e,t,s){const n=this.currentPlaybackId===t.getId();if(s===f.d.Stopped&&this.clockStates.has(t.getId())&&!n)e.skipTo(this.clockStates.get(t.getId()));else if(s===f.d.Stopped&&(this.clockStates.delete(t.getId()),n)){this.recentFullPlays.add(this.currentPlaybackId);const e=Object(E.b)(this.playbackIdOrder),s=e.pop();if(s===this.currentPlaybackId){const n=e.pop();if(n){const t=this.playbacks.get(n);t?(this.playbackIdOrder=e,m.a.instance.pauseAllExcept(t),t.play()):w.a.warn(`Voice message queue desync: Missing playback for next message: Current=${this.currentPlaybackId} Last=${s} Next=${n}`)}else{const s=Object(E.b)(this.room.getLiveTimeline().getEvents());let n,i=!1;for(const e of s){if(e.getId()===t.getId()){i=!0;continue}if(!i)continue;if(!Object(p.f)(e)){const t=e.getType();if(t!==_.a.RoomMessage&&t!==_.a.Sticker)continue;break}const s=this.playbacks.has(e.getId()),a=this.recentFullPlays.has(e.getId());if(s&&!a){n=e;break}}if(n){this.playbackIdOrder=e;const t=this.playbacks.get(n.getId());m.a.instance.pauseAllExcept(t),t.play()}else this.recentFullPlays=new Set,this.playbackIdOrder=[]}}else w.a.warn(`Voice message queue desync: Expected playback stop to be last in order. Current=${this.currentPlaybackId} Last=${s} EventID=${t.getId()}`)}if(s===f.d.Playing){const e=this.playbackIdOrder;if(this.currentPlaybackId!==t.getId()&&this.currentPlaybackId&&(0===e.length||e[e.length-1]!==this.currentPlaybackId)){const t=this.playbacks.get(this.currentPlaybackId);t.currentState!==f.d.Playing&&t.currentState!==f.d.Paused||e.push(this.currentPlaybackId)}this.currentPlaybackId=t.getId(),0!==e.length&&e[e.length-1]===this.currentPlaybackId||e.push(this.currentPlaybackId)}s!==f.d.Paused&&s!==f.d.Stopped||this.persistClocks()}onPlaybackClock(e,t,s){e.currentState!==f.d.Decoding&&e.currentState!==f.d.Stopped&&this.clockStates.set(t.getId(),s[0])}}v()(C,"queues",new Map);let O=Object(c.a)("views.messages.MAudioBody")(n=class extends r.a.PureComponent{constructor(e){super(e),this.state={}}async componentDidMount(){var e,t;let s;try{try{const e=await this.props.mediaEventHelper.sourceBlob.value;s=await e.arrayBuffer()}catch(e){return this.setState({error:e}),void w.a.warn("Unable to decrypt audio message",e)}}catch(e){return this.setState({error:e}),void w.a.warn("Unable to decrypt/download audio message",e)}const n=this.props.mxEvent.getContent(),i=null==n||null===(e=n["org.matrix.msc1767.audio"])||void 0===e||null===(t=e.waveform)||void 0===t?void 0:t.map(e=>e/1024),a=m.a.instance.createPlaybackInstance(s,i);a.clockInfo.populatePlaceholdersFrom(this.props.mxEvent),this.setState({playback:a}),Object(p.f)(this.props.mxEvent)&&C.forRoom(this.props.mxEvent.getRoomId()).unsortedEnqueue(this.props.mxEvent,a)}componentWillUnmount(){var e;null===(e=this.state.playback)||void 0===e||e.destroy()}render(){if(this.state.error)return r.a.createElement("span",{className:"mx_MAudioBody"},r.a.createElement("img",{src:s(270),width:"16",height:"16"}),Object(d.a)("Error processing audio message"));if(this.props.forExport){var e;const t=this.props.mxEvent.getContent(),s=(null===(e=t.file)||void 0===e?void 0:e.url)||t.url;return r.a.createElement("span",{className:"mx_MAudioBody"},r.a.createElement("audio",{src:s,controls:!0}))}return this.state.playback?r.a.createElement("span",{className:"mx_MAudioBody"},r.a.createElement(h.a,{playback:this.state.playback,mediaName:this.props.mxEvent.getContent().body}),this.props.tileShape&&r.a.createElement(u.a,a()({},this.props,{showGenericPlaceholder:!1})),this.props.scBubbleGroupTimestamp):r.a.createElement("span",{className:"mx_MAudioBody"},r.a.createElement(l.a,null))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n);class a{constructor(e){this.getFn=e,i()(this,"val",void 0),i()(this,"prom",void 0),i()(this,"done",!1)}get present(){return this.done}get cachedValue(){return this.val}get value(){return this.prom||(this.prom=this.getFn(),this.prom.then(e=>{this.val=e,this.done=!0})),this.prom}}var o=s(103),r=s(720),c=s(94),l=s(1);class d{constructor(e){this.event=e,i()(this,"sourceUrl",void 0),i()(this,"thumbnailUrl",void 0),i()(this,"sourceBlob",void 0),i()(this,"thumbnailBlob",void 0),i()(this,"media",void 0),i()(this,"prepareSourceUrl",async()=>{if(this.media.isEncrypted){const e=await this.sourceBlob.value;return URL.createObjectURL(e)}return this.media.srcHttp}),i()(this,"prepareThumbnailUrl",async()=>{if(this.media.isEncrypted){const e=await this.thumbnailBlob.value;return null===e?null:URL.createObjectURL(e)}return this.media.thumbnailHttp}),i()(this,"fetchSource",()=>{if(this.media.isEncrypted){const e=this.event.getContent();return Object(r.a)(e.file,e.info)}return this.media.downloadSource().then(e=>e.blob())}),i()(this,"fetchThumbnail",()=>{if(!this.media.hasThumbnail)return Promise.resolve(null);if(this.media.isEncrypted){var e;const t=this.event.getContent();return null!==(e=t.info)&&void 0!==e&&e.thumbnail_file?Object(r.a)(t.info.thumbnail_file,t.info.thumbnail_info):(l.a.warn("Media claims to have thumbnail and is encrypted, but no thumbnail_file found"),Promise.resolve(null))}return fetch(this.media.thumbnailHttp).then(e=>e.blob())}),this.sourceUrl=new a(this.prepareSourceUrl),this.thumbnailUrl=new a(this.prepareThumbnailUrl),this.sourceBlob=new a(this.fetchSource),this.thumbnailBlob=new a(this.fetchThumbnail),this.media=Object(o.a)(this.event.getContent())}get fileName(){return this.event.getContent().body||"download"}destroy(){this.media.isEncrypted&&(this.sourceUrl.present&&URL.revokeObjectURL(this.sourceUrl.cachedValue),this.thumbnailUrl.present&&URL.revokeObjectURL(this.thumbnailUrl.cachedValue))}static isEligible(e){if(!e)return!1;if(e.isRedacted())return!1;if(e.getType()===c.a.Sticker)return!0;if(e.getType()!==c.a.RoomMessage)return!1;const t=e.getContent();return!![c.b.Video,c.b.Audio,c.b.Image,c.b.File].includes(t.msgtype)||"string"==typeof t.url}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(203);class o extends a.c{constructor(e,t,s=a.a){super(t,s),this.manager=e}async play(){return this.manager.pauseAllExcept(this),super.play()}destroy(){this.manager.destroyPlaybackInstance(this),super.destroy()}}class r{constructor(){i()(this,"instances",[])}static get instance(){return r.internalInstance||(r.internalInstance=new r),r.internalInstance}pauseAllExcept(e){this.instances.filter(t=>t!==e&&t.currentState===a.d.Playing).forEach(e=>e.pause())}destroyPlaybackInstance(e){this.instances=this.instances.filter(t=>t!==e)}createPlaybackInstance(e,t=a.a){const s=new o(this,e,t);return this.instances.push(s),s}}i()(r,"internalInstance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(151);const o={};var r=s(736),c=s(106);class l{constructor(){}static get instance(){return l.internalInstance||(l.internalInstance=new l),l.internalInstance}async onNewInvitedRoom(e){await r.a.sharedInstance().onNewInvitedRoom(e)}isRoomVisible(e){if(!e)return!1;if(a.d.sharedInstance().getSupportsVirtualRooms()&&r.a.sharedInstance().isVirtualRoom(e))return!1;if(c.a.spacesEnabled&&e.isSpaceRoom())return!1;const t=o.isRoomVisible;return!t||t(e)}}i()(l,"internalInstance",void 0)},,,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(1),i=s(285);function a(e){return"crypto.sessions/"+e}function o(e){return"crypto.session.problems/"+e}function r(e,t){return"crypto.inboundgroupsessions/"+e+"/"+t}function c(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function l(e){return"crypto.rooms/"+e}class d extends i.a{static exists(e){const t=e.length;for(let s=0;s<t;s++)if(e.key(s).startsWith("crypto."))return!0;return!1}constructor(e){super(),this.store=e}countEndToEndSessions(e,t){let s=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(a(""))&&++s;t(s)}_getEndToEndSessions(e){const t=h(this.store,a(e)),s={};for(const[e,n]of Object.entries(t||{}))s[e]="string"==typeof n?{session:n}:n;return s}getEndToEndSession(e,t,s,n){n(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,s){s(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(a(""))){const s=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(s)))t(e)}}storeEndToEndSession(e,t,s,n){const i=this._getEndToEndSessions(e)||{};i[t]=s,u(this.store,a(e),i)}async storeEndToEndSessionProblem(e,t,s){const n=o(e),i=h(this.store,n)||[];i.push({type:t,fixed:s,time:Date.now()}),i.sort((e,t)=>e.time-t.time),u(this.store,n,i)}async getEndToEndSessionProblem(e,t){const s=o(e),n=h(this.store,s)||[];if(!n.length)return null;const i=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=h(this.store,"crypto.notified_error_devices")||{},s=[];for(const n of e){const{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(s.push(n),t[e][i.deviceId]=!0):(s.push(n),t[e]={[i.deviceId]:!0})}return u(this.store,"crypto.notified_error_devices",t),s}getEndToEndInboundGroupSession(e,t,s,n){n(h(this.store,r(e,t)),h(this.store,c(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const s=this.store.key(e);s.startsWith("crypto.inboundgroupsessions/")&&t({senderKey:s.substr("crypto.inboundgroupsessions/".length,43),sessionId:s.substr("crypto.inboundgroupsessions/".length+44),sessionData:h(this.store,s)})}t(null)}addEndToEndInboundGroupSession(e,t,s,n){h(this.store,r(e,t))||this.storeEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSession(e,t,s,n){u(this.store,r(e,t),s)}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){u(this.store,c(e,t),s)}getEndToEndDeviceData(e,t){t(h(this.store,"crypto.device_data"))}storeEndToEndDeviceData(e,t){u(this.store,"crypto.device_data",e)}storeEndToEndRoom(e,t,s){u(this.store,l(e),t)}getEndToEndRooms(e,t){const s={},n=l("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(t.startsWith(n)){s[t.substr(n.length)]=h(this.store,t)}}t(s)}getSessionsNeedingBackup(e){const t=h(this.store,"crypto.sessionsneedingbackup")||{},s=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const t=n.substr(0,43),i=n.substr(44);if(this.getEndToEndInboundGroupSession(t,i,null,e=>{s.push({senderKey:t,sessionId:i,sessionData:e})}),e&&n.length>=e)break}return Promise.resolve(s)}countSessionsNeedingBackup(){const e=h(this.store,"crypto.sessionsneedingbackup")||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=h(this.store,"crypto.sessionsneedingbackup")||{};for(const s of e)delete t[s.senderKey+"/"+s.sessionId];return u(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}markSessionsNeedingBackup(e){const t=h(this.store,"crypto.sessionsneedingbackup")||{};for(const s of e)t[s.senderKey+"/"+s.sessionId]=!0;return u(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}deleteAllData(){return this.store.removeItem("crypto.account"),Promise.resolve()}getAccount(e,t){t(h(this.store,"crypto.account"))}storeAccount(e,t){u(this.store,"crypto.account",t)}getCrossSigningKeys(e,t){t(h(this.store,"crypto.cross_signing_keys"))}getSecretStorePrivateKey(e,t,s){t(h(this.store,"crypto.ssss_cache."+s))}storeCrossSigningKeys(e,t){u(this.store,"crypto.cross_signing_keys",t)}storeSecretStorePrivateKey(e,t,s){u(this.store,"crypto.ssss_cache."+t,s)}doTxn(e,t,s){return Promise.resolve(s(null))}}function h(e,t){try{return JSON.parse(e.getItem(t))}catch(e){n.a.log("Error: Failed to get key %s: %s",t,e.stack||e),n.a.log(e.stack)}return null}function u(e,t,s){e.setItem(t,JSON.stringify(s))}},function(e,t,s){"use strict";function n(e,t){return new Promise((s,n)=>{let i=!0;const a=e.open(t);a.onupgradeneeded=()=>{i=!1},a.onblocked=()=>n(a.error),a.onsuccess=()=>{a.result.close(),i||e.deleteDatabase(t),s(i)},a.onerror=e=>n(a.error)})}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(99),i=s.n(n),a=s(1),o=s(174),r=s(1045);function c(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}class l{constructor(e){this.cryptoStore=e,i()(this,"pickleKey","DEFAULT_KEY"),i()(this,"deviceCurve25519Key",null),i()(this,"deviceEd25519Key",null),i()(this,"maxOneTimeKeys",null),i()(this,"outboundGroupSessionStore",{}),i()(this,"inboundGroupSessionMessageIndexes",{}),i()(this,"sessionsInProgress",{}),i()(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return e.Olm.get_library_version()}async init({pickleKey:t,fromExportedDevice:s}={}){let n;const i=new e.Olm.Account;try{s?(t&&a.a.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=s.pickleKey,await this.initialiseFromExportedDevice(s,i)):(t&&(this.pickleKey=t),await this.initialiseAccount(i)),n=JSON.parse(i.identity_keys()),this.maxOneTimeKeys=i.max_number_of_one_time_keys()}finally{i.free()}this.deviceCurve25519Key=n.curve25519,this.deviceEd25519Key=n.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT,o.a.STORE_SESSIONS],t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach(e=>{const{deviceKey:s,sessionId:n}=e,i={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(s,n,i,t)})}),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT],t=>{this.cryptoStore.getAccount(t,s=>{null!==s?e.unpickle(this.pickleKey,s):(e.create(),s=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,s))})})}getAccount(t,s){this.cryptoStore.getAccount(t,t=>{const n=new e.Olm.Account;try{n.unpickle(this.pickleKey,t),s(n)}finally{n.free()}})}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[o.a.STORE_ACCOUNT,o.a.STORE_SESSIONS],t=>{this.cryptoStore.getAccount(t,t=>{e.pickledAccount=t}),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,t=>{e.sessions.push(t)})}),e}getSession(e,t,s,n){this.cryptoStore.getEndToEndSession(e,t,s,e=>{this.unpickleSession(e,n)})}unpickleSession(t,s){const n=new e.Olm.Session;try{n.unpickle(this.pickleKey,t.session);s(Object.assign({},t,{session:n}))}finally{n.free()}}saveSession(e,t,s){const n=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,i,s)}getUtility(t){const s=new e.Olm.Utility;try{return t(s)}finally{s.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_ACCOUNT],s=>{this.getAccount(s,s=>{t=s.sign(e)})}),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_ACCOUNT],t=>{this.getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e}maxNumberOfOneTimeKeys(){return this.maxOneTimeKeys}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.mark_keys_as_published(),this.storeAccount(e,t)})})}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT],t=>{this.getAccount(t,s=>{s.generate_one_time_keys(e),this.storeAccount(t,s)})})}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.generate_fallback_key(),this.storeAccount(e,t)})})}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_ACCOUNT],t=>{this.getAccount(t,t=>{e=JSON.parse(t.fallback_key())})}),e}async createOutboundSession(t,s){let n;return await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT,o.a.STORE_SESSIONS],i=>{this.getAccount(i,a=>{const o=new e.Olm.Session;try{o.create_outbound(a,t,s),n=o.session_id(),this.storeAccount(i,a);const e={session:o,lastReceivedMessageTs:Date.now()};this.saveSession(t,e,i)}finally{o.free()}})},a.a.withPrefix("[createOutboundSession]")),n}async createInboundSession(t,s,n){if(0!==s)throw new Error("Need messageType == 0 to create inbound session");let i;return await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ACCOUNT,o.a.STORE_SESSIONS],a=>{this.getAccount(a,o=>{const r=new e.Olm.Session;try{r.create_inbound_from(o,t,n),o.remove_one_time_keys(r),this.storeAccount(a,o);const e=r.decrypt(s,n),c={session:r,lastReceivedMessageTs:Date.now()};this.saveSession(t,c,a),i={payload:e,session_id:r.session_id()}}finally{r.free()}})},a.a.withPrefix("[createInboundSession]")),i}async getSessionIdsForDevice(e){const t=a.a.withPrefix("[getSessionIdsForDevice]");if(this.sessionsInProgress[e]){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}let s;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_SESSIONS],t=>{this.cryptoStore.getEndToEndSessions(e,t,e=>{s=Object.keys(e)})},t),s}async getSessionIdForDevice(e,t=!1,s){const n=await this.getSessionInfoForDevice(e,t,s);if(0===n.length)return null;let i=0;for(let e=1;e<n.length;e++){const t=n[e],s=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,a=n[i],o=void 0===a.lastReceivedMessageTs?0:a.lastReceivedMessageTs;(s>o||s===o&&t.sessionId<a.sessionId)&&(i=e)}return n[i].sessionId}async getSessionInfoForDevice(e,t=!1,s=a.a){if(s=s.withPrefix("[getSessionInfoForDevice]"),this.sessionsInProgress[e]&&!t){s.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}const n=[];return await this.cryptoStore.doTxn("readonly",[o.a.STORE_SESSIONS],t=>{this.cryptoStore.getEndToEndSessions(e,t,e=>{const t=Object.keys(e).sort();for(const s of t)this.unpickleSession(e[s],e=>{n.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:s})})})},s),n}async encryptMessage(e,t,s){let n;return c(s),await this.cryptoStore.doTxn("readwrite",[o.a.STORE_SESSIONS],i=>{this.getSession(e,t,i,o=>{const r=o.session.describe();a.a.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+r),n=o.session.encrypt(s),this.saveSession(e,o,i)})},a.a.withPrefix("[encryptMessage]")),n}async decryptMessage(e,t,s,n){let i;return await this.cryptoStore.doTxn("readwrite",[o.a.STORE_SESSIONS],o=>{this.getSession(e,t,o,r=>{const c=r.session.describe();a.a.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),i=r.session.decrypt(s,n),r.lastReceivedMessageTs=Date.now(),this.saveSession(e,r,o)})},a.a.withPrefix("[decryptMessage]")),i}async matchesSession(e,t,s,n){if(0!==s)return!1;let i;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_SESSIONS],s=>{this.getSession(e,t,s,e=>{i=e.session.matches_inbound(n)})},a.a.withPrefix("[matchesSession]")),i}async recordSessionProblem(e,t,s){await this.cryptoStore.storeEndToEndSessionProblem(e,t,s)}async sessionMayHaveProblems(e,t){return await this.cryptoStore.getEndToEndSessionProblem(e,t)}async filterOutNotifiedErrorDevices(e){return await this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(t,s){const n=this.outboundGroupSessionStore[t];if(void 0===n)throw new Error("Unknown outbound group session "+t);const i=new e.Olm.OutboundGroupSession;try{return i.unpickle(this.pickleKey,n),s(i)}finally{i.free()}}createOutboundGroupSession(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this.saveOutboundGroupSession(t),t.session_id()}finally{t.free()}}encryptGroupMessage(e,t){return a.a.log("encrypting msg with megolm session "+e),c(t),this.getOutboundGroupSession(e,e=>{const s=e.encrypt(t);return this.saveOutboundGroupSession(e),s})}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(t,s){const n=new e.Olm.InboundGroupSession;try{return n.unpickle(this.pickleKey,t.session),s(n)}finally{n.free()}}getInboundGroupSession(e,t,s,n,i){this.cryptoStore.getEndToEndInboundGroupSession(t,s,n,(t,s)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,e=>{i(e,t,s)})}else i(null,null,s)})}async addInboundGroupSession(t,s,n,i,r,c,l,d={}){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_INBOUND_GROUP_SESSIONS,o.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,o.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],o=>{this.getInboundGroupSession(t,s,i,o,(h,u)=>{const m=new e.Olm.InboundGroupSession;try{if(l?m.import_session(r):m.create(r),i!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+s);if(h&&(a.a.log("Update for megolm session "+s+"/"+i),h.first_known_index()<=m.first_known_index()&&(h.first_known_index()!=m.first_known_index()||d.untrusted||!u.untrusted)))return void a.a.log("Keeping existing megolm session "+i);a.a.info("Storing megolm session "+s+"/"+i+" with first index "+m.first_known_index());const e=Object.assign({},d,{room_id:t,session:m.pickle(this.pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:n});this.cryptoStore.storeEndToEndInboundGroupSession(s,i,e,o),!h&&d.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(t,s,i,o)}finally{m.free()}})},a.a.withPrefix("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,s,n,i){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],a=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,s,{room_id:e,code:n,reason:i},a)})}async decryptGroupMessage(e,t,s,n,i,c){let l,d;if(await this.cryptoStore.doTxn("readwrite",[o.a.STORE_INBOUND_GROUP_SESSIONS,o.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],a=>{this.getInboundGroupSession(e,t,s,a,(e,o,u)=>{if(null===e)return u&&(d=new r.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",h(u),{session:t+"|"+s})),void(l=null);let m;try{m=e.decrypt(n)}catch(e){return void(d=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&u?new r.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",h(u),{session:t+"|"+s}):e)}let p=m.plaintext;if(void 0===p)p=m;else{const e=t+"|"+s+"|"+m.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==i||t.timestamp!==c)return void(d=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:i,timestamp:c}}o.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,s,o,a),l={result:p,keysClaimed:o.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:o.forwardingCurve25519KeyChain||[],untrusted:o.untrusted}})},a.a.withPrefix("[decryptGroupMessage]")),d)throw d;return l}async hasInboundSessionKeys(e,t,s){let n;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_INBOUND_GROUP_SESSIONS,o.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this.cryptoStore.getEndToEndInboundGroupSession(t,s,i,i=>{null!==i?e!==i.room_id?(a.a.warn(`requested keys for inbound group session ${t}|`+s+", with incorrect room_id "+`(expected ${i.room_id}, `+`was ${e})`),n=!1):n=!0:n=!1})},a.a.withPrefix("[hasInboundSessionKeys]")),n}async getInboundGroupSessionKey(e,t,s,n){let i;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_INBOUND_GROUP_SESSIONS,o.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],a=>{this.getInboundGroupSession(e,t,s,a,(e,t)=>{if(null===e)return void(i=null);void 0===n&&(n=e.first_known_index());const s=e.export_session(n),a=(t.keysClaimed||{}).ed25519||null;i={chain_index:n,key:s,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:a,shared_history:t.sharedHistory||!1}})},a.a.withPrefix("[getInboundGroupSessionKey]")),i}exportInboundGroupSession(e,t,s){return this.unpickleInboundGroupSession(s,n=>{const i=n.first_known_index();return{sender_key:e,sender_claimed_keys:s.keysClaimed,room_id:s.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:s.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":s.sharedHistory||!1}})}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[o.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],s=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,s)},a.a.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,s){this.getUtility((function(n){n.ed25519_verify(e,t,s)}))}}const d={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function h(e){return e.code&&e.code in d?d[e.code]:e.reason?e.reason:"decryption key withheld"}}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(99),i=s.n(n),a=s(1),o=s(149),r=s(349),c=s(605);function l(e){var t,s;const n=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),i=null==n||null===(s=n.getContent())||void 0===s?void 0:s.history_visibility;return["world_readable","shared"].includes(i)}class d{constructor(e,t=!1){this.sessionId=e,this.sharedHistory=t,i()(this,"useCount",0),i()(this,"creationTime",void 0),i()(this,"sharedWithDevices",{}),i()(this,"blockedDevicesNotified",{}),this.creationTime=(new Date).getTime()}needsRotation(e,t){const s=(new Date).getTime()-this.creationTime;return(this.useCount>=e||s>=t)&&(a.a.log("Rotating megolm session after "+this.useCount+" messages, "+s+"ms"),!0)}markSharedWithDevice(e,t,s,n){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]={deviceKey:s,messageIndex:n}}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0}sharedWithTooManyDevices(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return a.a.log("Starting new megolm session because we shared with "+t),!0;for(const s in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(s)&&!e[t].hasOwnProperty(s))return a.a.log("Starting new megolm session because we shared with "+t+":"+s),!0}}}class h extends r.e{constructor(e){var t,s,n,a;super(e),i()(this,"setupPromise",Promise.resolve(void 0)),i()(this,"outboundSessions",{}),i()(this,"sessionRotationPeriodMsgs",void 0),i()(this,"sessionRotationPeriodMs",void 0),i()(this,"encryptionPreparation",void 0),i()(this,"encryptionPreparationMetadata",void 0),this.sessionRotationPeriodMsgs=null!==(t=null===(s=e.config)||void 0===s?void 0:s.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(n=null===(a=e.config)||void 0===a?void 0:a.rotation_period_ms)&&void 0!==n?n:6048e5}async ensureOutboundSession(e,t,s,n=!1){let i;function r(){return i}const c=this.setupPromise.then(async r=>{i=r;const c=l(e);i&&c!==i.sharedHistory&&(i=null),i&&i.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(a.a.log("Starting new megolm session because we need to rotate."),i=null),i&&i.sharedWithTooManyDevices(t)&&(i=null),i||(a.a.log("Starting new megolm session for room "+this.roomId),i=await this.prepareNewSession(c),a.a.log(`Started new megolm session ${i.sessionId} for room `+this.roomId),this.outboundSessions[i.sessionId]=i);const d={};for(const[e,s]of Object.entries(t))for(const[t,n]of Object.entries(s)){n.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(i.sharedWithDevices[e]&&void 0!==i.sharedWithDevices[e][t]||(d[e]=d[e]||[],d[e].push(n)))}const h=this.olmDevice.getOutboundGroupSessionKey(i.sessionId),u={type:"m.room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:i.sessionId,session_key:h.key,chain_index:h.chain_index,"org.matrix.msc3061.shared_history":c}},[m,p]=await o.getExistingOlmSessions(this.olmDevice,this.baseApis,d);await Promise.all([(async()=>{a.a.debug("Sharing keys with existing Olm sessions in "+this.roomId,p),await this.shareKeyWithOlmSessions(i,h,u,p),a.a.debug("Shared keys with existing Olm sessions in "+this.roomId)})(),(async()=>{a.a.debug("Sharing keys (start phase 1) with new Olm sessions in "+this.roomId,m);const e=[],t=Date.now(),s=[];await this.shareKeyWithDevices(i,h,u,m,e,n?1e4:2e3,s),a.a.debug("Shared keys (end phase 1) with new Olm sessions in "+this.roomId),!n&&Date.now()-t<1e4?(async()=>{const t={},n=new Set;for(const e of s)n.add(e);const o=[];for(const{userId:s,deviceInfo:i}of e){const e=s.slice(s.indexOf(":")+1);n.has(e)?(t[s]=t[s]||[],t[s].push(i)):o.push({userId:s,deviceInfo:i})}a.a.debug("Sharing keys (start phase 2) with new Olm sessions in "+this.roomId),await this.shareKeyWithDevices(i,h,u,t,o,3e4),a.a.debug("Shared keys (end phase 2) with new Olm sessions in "+this.roomId),await this.notifyFailedOlmDevices(i,h,o)})():await this.notifyFailedOlmDevices(i,h,e),a.a.debug("Shared keys (all phases done) with new Olm sessions in "+this.roomId)})(),(async()=>{a.a.debug(`There are ${Object.entries(s).length} blocked devices in ${this.roomId}`,Object.entries(s)),a.a.debug("Notifying newly blocked devices in "+this.roomId);const e={};let t=0;for(const[n,a]of Object.entries(s))for(const[s,o]of Object.entries(a))i.blockedDevicesNotified[n]&&void 0!==i.blockedDevicesNotified[n][s]||(e[n]=e[n]||{},e[n][s]={device:o},t++);await this.notifyBlockedDevices(i,e),a.a.debug(`Notified ${t} newly blocked devices in ${this.roomId}`,e)})()])});return c.catch(e=>{a.a.error("Failed to ensure outbound session in "+this.roomId,e)}),this.setupPromise=c.then(r,r),c.then(r)}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),s=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,s.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new d(t,e)}getDevicesWithoutSessions(e,t,s=[]){for(const[n,i]of Object.entries(t)){const t=e[n];for(const e of i){const i=e.deviceId;t[i].sessionId||(s.push({userId:n,deviceInfo:e}),delete t[i])}}return s}splitDevices(e){let t=[];const s=[t];for(const[n,i]of Object.entries(e)){for(const e of Object.values(i))t.push({userId:n,deviceInfo:e.device});t.length>20&&(t=[],s.push(t))}return 0===t.length&&s.pop(),s}encryptAndSendKeysToDevices(e,t,s,n){const i={},r=new Map,c=[];for(let e=0;e<s.length;e++){const t={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},a=s[e],l=a.userId,d=a.deviceInfo,h=d.deviceId;r.set(h,d),i[l]||(i[l]={}),i[l][h]=t,c.push(o.encryptMessageForDevice(t.ciphertext,this.userId,this.deviceId,this.olmDevice,l,d,n))}return Promise.all(c).then(()=>{for(const e of Object.keys(i)){for(const t of Object.keys(i[e]))0===Object.keys(i[e][t].ciphertext).length&&(a.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete i[e][t]);0===Object.keys(i[e]).length&&(a.a.log("Pruned all devices for user "+e),delete i[e])}if(0!==Object.keys(i).length)return this.baseApis.sendToDevice("m.room.encrypted",i).then(()=>{for(const s of Object.keys(i))for(const n of Object.keys(i[s]))e.markSharedWithDevice(s,n,r.get(n).getIdentityKey(),t)});a.a.log("No users left to send to: aborting")})}async sendBlockedNotificationsToDevices(e,t,s){const n={};for(const e of t){const t=e.userId,i=e.deviceInfo,a=i.deviceInfo.deviceId,o=Object.assign({},s);o.code=i.code,o.reason=i.reason,"m.no_olm"===o.code&&(delete o.room_id,delete o.session_id),n[t]||(n[t]={}),n[t][a]=o}await this.baseApis.sendToDevice("org.matrix.room_key.withheld",n);for(const t of Object.keys(n))for(const s of Object.keys(n[t]))e.markNotifiedBlockedDevice(t,s)}async reshareKeyWithDevice(e,t,s,n){const i=this.outboundSessions[t];if(!i)return void a.a.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===i.sharedWithDevices[s])return void a.a.debug(`megolm session ${t} never shared with user ${s}`);const r=i.sharedWithDevices[s][n.deviceId];if(void 0===r)return void a.a.debug("megolm session ID "+t+" never shared with device "+s+":"+n.deviceId);if(r.deviceKey!==n.getIdentityKey())return void a.a.warn(`Session has been shared with device ${n.deviceId} but with identity key ${r.deviceKey}. Key is now ${n.getIdentityKey()}!`);const c=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,r.messageIndex);if(!c)return void a.a.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[s]:[n]});const l={type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},d={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(d.ciphertext,this.userId,this.deviceId,this.olmDevice,s,n,l),await this.baseApis.sendToDevice("m.room.encrypted",{[s]:{[n.deviceId]:d}}),a.a.debug(`Re-shared key for megolm session ${t} with ${s}:${n.deviceId}`)}async shareKeyWithDevices(e,t,s,n,i,r,c){a.a.debug("Ensuring Olm sessions for devices in "+this.roomId);const l=await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,!1,r,c,a.a.withPrefix(`[${this.roomId}]`));a.a.debug("Ensured Olm sessions for devices in "+this.roomId),this.getDevicesWithoutSessions(l,n,i),a.a.debug("Sharing keys with newly created Olm sessions in "+this.roomId),await this.shareKeyWithOlmSessions(e,t,s,l),a.a.debug("Shared keys with newly created Olm sessions in "+this.roomId)}async shareKeyWithOlmSessions(e,t,s,n){const i=this.splitDevices(n);for(let n=0;n<i.length;n++){const o=`megolm keys for ${e.sessionId} in ${this.roomId} (slice ${n+1}/${i.length})`;try{a.a.debug("Sharing "+o,i[n].map(e=>`${e.userId}/${e.deviceInfo.deviceId}`)),await this.encryptAndSendKeysToDevices(e,t.chain_index,i[n],s),a.a.debug("Shared "+o)}catch(e){throw a.a.error("Failed to share "+o),e}}}async notifyFailedOlmDevices(e,t,s){a.a.debug(`Notifying ${s.length} devices we failed to create Olm sessions in `+this.roomId);for(const{userId:n,deviceInfo:i}of s){const s=i.deviceId;e.markSharedWithDevice(n,s,i.getIdentityKey(),t.chain_index)}const n=await this.olmDevice.filterOutNotifiedErrorDevices(s);a.a.debug(`Need to notify ${n.length} failed devices which haven't been notified before in `+this.roomId);const i={};for(const{userId:e,deviceInfo:t}of n)i[e]=i[e]||{},i[e][t.deviceId]={device:{code:"m.no_olm",reason:c.b["m.no_olm"],deviceInfo:t}};await this.notifyBlockedDevices(e,i),a.a.debug(`Notified ${n.length} devices we failed to create Olm sessions in `+this.roomId)}async notifyBlockedDevices(e,t){const s={room_id:this.roomId,session_id:e.sessionId,algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},n=this.splitDevices(t);for(let t=0;t<n.length;t++)try{await this.sendBlockedNotificationsToDevices(e,n[t],s),a.a.log(`Completed blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${t+1}/${n.length})`)}catch(s){throw a.a.log(`blacklist notification for ${e.sessionId} in ${this.roomId} (slice ${t+1}/${n.length}) failed`),s}}prepareToEncrypt(e){if(this.encryptionPreparation){const e=Date.now()-this.encryptionPreparationMetadata.startTime;a.a.debug(`Already started preparing to encrypt for ${this.roomId} `+e+" ms ago, skipping")}else a.a.debug("Preparing to encrypt events for "+this.roomId),this.encryptionPreparationMetadata={startTime:Date.now()},this.encryptionPreparation=(async()=>{try{a.a.debug("Getting devices in "+this.roomId);const[t,s]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.removeUnknownDevices(t),a.a.debug("Ensuring outbound session in "+this.roomId),await this.ensureOutboundSession(e,t,s,!0),a.a.debug("Ready to encrypt events for "+this.roomId)}catch(e){a.a.error("Failed to prepare to encrypt events for "+this.roomId,e)}finally{delete this.encryptionPreparationMetadata,delete this.encryptionPreparation}})()}async encryptMessage(e,t,s){if(a.a.log("Starting to encrypt event for "+this.roomId),this.encryptionPreparation)try{await this.encryptionPreparation}catch(e){}const[n,i]=await this.getDevicesInRoom(e);this.crypto.getGlobalErrorOnUnknownDevices()&&this.checkForUnknownDevices(n);const r=await this.ensureOutboundSession(e,n,i),c={room_id:this.roomId,type:t,content:s},l=this.olmDevice.encryptGroupMessage(r.sessionId,JSON.stringify(c)),d={algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:r.sessionId,device_id:this.deviceId};return r.useCount++,d}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(e){const t={};if(Object.keys(e).forEach(s=>{Object.keys(e[s]).forEach(n=>{const i=e[s][n];i.isUnverified()&&!i.isKnown()&&(t[s]||(t[s]={}),t[s][n]=i)})}),Object.keys(t).length)throw new r.f("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,s]of Object.entries(e)){for(const[e,t]of Object.entries(s))t.isUnverified()&&!t.isKnown()&&delete s[e];0===Object.keys(s).length&&delete e[t]}}async getDevicesInRoom(e){const t=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));let s=this.crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(s=e.getBlacklistUnverifiedDevices());const n=await this.crypto.downloadKeys(t,!1),i={};for(const e in n){if(!n.hasOwnProperty(e))continue;const t=n[e];for(const n in t){if(!t.hasOwnProperty(n))continue;const a=this.crypto.checkDeviceTrust(e,n);if(t[n].isBlocked()||!a.isVerified()&&s){i[e]||(i[e]={});const s=t[n].isBlocked();i[e][n]={code:s?"m.blacklisted":"m.unverified",reason:c.b[s?"m.blacklisted":"m.unverified"],deviceInfo:t[n]},delete t[n]}}}return[n,i]}}class u extends r.b{constructor(...e){super(...e),i()(this,"pendingEvents",{}),i()(this,"olmlib",o)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new r.c("MEGOLM_MISSING_FIELDS","Missing fields in input");let s;this.addEventToPendingList(e);try{s=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(s){if("DecryptionError"===s.name)throw s;let n="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw s&&"OLM.UNKNOWN_MESSAGE_INDEX"===s.message&&(this.requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new r.c(n,s?s.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===s){this.requestKeysForEvent(e);const s=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(s){let e=m[s.type]||m.unknown;throw s.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new r.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new r.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this.removeEventFromPendingList(e);const n=JSON.parse(s.result);if(n.room_id!==e.getRoomId())throw new r.c("MEGOLM_BAD_ROOM","Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:s.senderKey,claimedEd25519Key:s.keysClaimed.ed25519,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain,untrusted:s.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),s=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},s)}addEventToPendingList(e){const t=e.getWireContent(),s=t.sender_key,n=t.session_id;this.pendingEvents[s]||(this.pendingEvents[s]=new Map);const i=this.pendingEvents[s];i.has(n)||i.set(n,new Set),i.get(n).add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),s=t.sender_key,n=t.session_id,i=this.pendingEvents[s],a=i&&i.get(n);a&&(a.delete(e),0===a.size&&i.delete(s),0===i.size&&delete this.pendingEvents[s])}onRoomKeyEvent(e){const t=e.getContent(),s=t.session_id;let n,i=e.getSenderKey(),o=[],r=!1;if(!t.room_id||!s||!t.session_key)return void a.a.error("key event is missing fields");if(!i)return void a.a.error("key event has no sender key (not encrypted?)");if("m.forwarded_room_key"==e.getType()){if(r=!0,o=t.forwarding_curve25519_key_chain,Array.isArray(o)||(o=[]),o=o.slice(),o.push(i),i=t.sender_key,!i)return void a.a.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void a.a.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");n={ed25519:e}}else n=e.getKeysClaimed();const c={};return t["org.matrix.msc3061.shared_history"]&&(c.sharedHistory=!0),this.olmDevice.addInboundGroupSession(t.room_id,i,o,s,t.session_key,n,r,c).then(()=>{this.retryDecryption(i,s).then(e=>{e&&this.crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:i})})}).then(()=>{this.crypto.backupManager.backupGroupSession(i,t.session_id)}).catch(e=>{a.a.error("Error handling m.room_key_event: "+e)})}async onRoomKeyWithheldEvent(e){const t=e.getContent(),s=t.sender_key;if("m.no_olm"===t.code){const n=e.getSender();if(a.a.warn(`${n}:${s} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(s))return a.a.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(s,"no_olm",!0),void this.retryDecryptionFromSender(s);let i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,s);if(!i&&(await this.crypto.downloadKeys([n],!1),i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,s),!i))return a.a.info("Couldn't find device for identity key "+s+": not establishing session"),await this.olmDevice.recordSessionProblem(s,"no_olm",!1),void this.retryDecryptionFromSender(s);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[n]:[i]},!1);const r={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(r.ciphertext,this.userId,void 0,this.olmDevice,n,i,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(s,"no_olm",!0),this.retryDecryptionFromSender(s),await this.baseApis.sendToDevice("m.room.encrypted",{[n]:{[i.deviceId]:r}})}else await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,s,t.session_id,t.code,t.reason)}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,s=e.deviceId,n=this.crypto.getStoredDevice(t,s),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,{[t]:[n]}).then(e=>e[t][s].sessionId?(a.a.log("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+s),this.buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null).then(e=>{const i={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,t,n,e).then(()=>{const e={[t]:{[s]:i}};return this.baseApis.sendToDevice("m.room.encrypted",e)})})}async buildKeyForwardingMessage(e,t,s){const n=await this.olmDevice.getInboundGroupSessionKey(e,t,s);return{type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:s,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":n.shared_history||!1}}}importRoomKey(e,t={}){const s={};return(t.untrusted||e.untrusted)&&(s.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(s.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,s).then(()=>{"backup"!==t.source&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(e=>{a.a.log("Failed to back up megolm session",e)}),this.retryDecryption(e.sender_key,e.session_id)})}async retryDecryption(e,t){const s=this.pendingEvents[e];if(!s)return!0;const n=s.get(t);return!n||(a.a.debug("Retrying decryption on events",[...n]),await Promise.all([...n].map(async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0})}catch(e){}})),!(this.pendingEvents[e]||{})[t])}async retryDecryptionFromSender(e){const t=this.pendingEvents[e];return!t||(delete this.pendingEvents[e],await Promise.all([...t].map(async([e,t])=>{await Promise.all([...t].map(async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}}))})),!this.pendingEvents[e])}async sendSharedHistoryInboundSessions(e){await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e),a.a.log("sendSharedHistoryInboundSessions to users",Object.keys(e));const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);a.a.log("shared-history sessions",t);for(const[s,n]of t){const t=await this.buildKeyForwardingMessage(this.roomId,s,n),i=[],r={};for(const[s,n]of Object.entries(e)){r[s]={};for(const e of n){const n={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};r[s][e.deviceId]=n,i.push(o.encryptMessageForDevice(n.ciphertext,this.userId,void 0,this.olmDevice,s,e,t))}}await Promise.all(i);for(const e of Object.keys(r)){for(const t of Object.keys(r[e]))0===Object.keys(r[e][t].ciphertext).length&&(a.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete r[e][t]);0===Object.keys(r[e]).length&&(a.a.log("Pruned all devices for user "+e),delete r[e])}if(0===Object.keys(r).length)return void a.a.log("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",r)}}}const m={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};Object(r.g)(o.MEGOLM_ALGORITHM,h,u)},function(e,t,s){"use strict";(function(e,n){s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return m}));var i=s(99),a=s.n(i),o=s(149),r=s(174),c=s(252),l=s(346),d=s.n(l),h=s(1);const u="org.matrix.msc2697.v1.olm.libolm_pickle";class m{constructor(e){this.crypto=e,a()(this,"inProgress",!1),a()(this,"timeoutId",void 0),a()(this,"key",void 0),a()(this,"keyInfo",void 0),a()(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}async getDehydrationKeyFromCache(){return await this.crypto.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,async t=>{if(t){const{key:s,keyInfo:i,deviceDisplayName:a,time:r}=t,l=e.from(this.crypto.olmDevice.pickleKey),d=await Object(c.b)(s,l,u);this.key=Object(o.decodeBase64)(d),this.keyInfo=i,this.deviceDisplayName=a;const h=Date.now(),m=Math.max(1,r+6048e5-h);this.timeoutId=n.setTimeout(this.dehydrateDevice.bind(this),m)}},"dehydration")})}async setKeyAndQueueDehydration(e,t={},s){await this.setKey(e,t,s)||this.dehydrateDevice()}async setKey(e,t={},s){if(!e)return this.timeoutId&&(n.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)}),this.key=void 0,void(this.keyInfo=void 0);let i=this.key&&e.length==this.key.length;for(let t=0;i&&t<e.length;t++)e[t]!=this.key[t]&&(i=!1);return i||(this.key=e,this.keyInfo=t,this.deviceDisplayName=s),i}async dehydrateDevice(){if(this.inProgress)h.a.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(n.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const t=e.from(this.crypto.olmDevice.pickleKey),s=await Object(c.c)(Object(o.encodeBase64)(this.key),t,u);await this.crypto.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:s,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),h.a.log("Attempting to dehydrate device"),h.a.log("Creating account");const i=new n.Olm.Account;i.create();const a=JSON.parse(i.identity_keys()),l=i.max_number_of_one_time_keys();i.generate_one_time_keys(l/2),i.generate_fallback_key();const m=JSON.parse(i.one_time_keys()),p=JSON.parse(i.fallback_key());i.mark_keys_as_published();const g=i.pickle(new Uint8Array(this.key)),v={algorithm:u,account:g};this.keyInfo.passphrase&&(v.passphrase=this.keyInfo.passphrase),h.a.log("Uploading account to server");const f=(await this.crypto.baseApis.http.authedRequest(void 0,"PUT","/dehydrated_device",void 0,{device_data:v,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;h.a.log("Preparing device keys",f);const b={algorithms:this.crypto.supportedAlgorithms,device_id:f,user_id:this.crypto.userId,keys:{["ed25519:"+f]:a.ed25519,["curve25519:"+f]:a.curve25519}},y=i.sign(d.a.stringify(b));b.signatures={[this.crypto.userId]:{["ed25519:"+f]:y}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(b,"self_signing"),h.a.log("Preparing one-time keys");const E={};for(const[e,t]of Object.entries(m.curve25519)){const s={key:t},n=i.sign(d.a.stringify(s));s.signatures={[this.crypto.userId]:{["ed25519:"+f]:n}},E["signed_curve25519:"+e]=s}h.a.log("Preparing fallback keys");const S={};for(const[e,t]of Object.entries(p.curve25519)){const s={key:t,fallback:!0},n=i.sign(d.a.stringify(s));s.signatures={[this.crypto.userId]:{["ed25519:"+f]:n}},S["signed_curve25519:"+e]=s}return h.a.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(void 0,"POST","/keys/upload/"+encodeURI(f),void 0,{device_keys:b,one_time_keys:E,"org.matrix.msc2732.fallback_keys":S}),h.a.log("Done dehydrating"),this.timeoutId=n.setTimeout(this.dehydrateDevice.bind(this),6048e5),f}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(n.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}}).call(this,s(27).Buffer,s(26))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return p}));var n=s(99),i=s.n(n),a=s(204),o=s(1),r=s(149),c=s(352),l=s(4),d=s(174),h=s(353),u=s(252),m=s(342);class p{constructor(e,t){this.baseApis=e,this.getKey=t,i()(this,"algorithm",void 0),i()(this,"backupInfo",void 0),i()(this,"checkedForBackup",void 0),i()(this,"sendingBackups",void 0),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=b[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static async makeAlgorithm(e,t){const s=b[e.algorithm];if(!s)throw new Error("Unknown backup algorithm");return await s.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await p.makeAlgorithm(e,this.getKey),this.baseApis.emit("crypto.keyBackupStatus",!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit("crypto.keyBackupStatus",!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const s=t?b[t]:y;if(!s)throw new Error("Unknown backup algorithm");const[n,i]=await s.prepare(e),a=Object(h.b)(n);return{algorithm:s.algorithmName,auth_data:i,recovery_key:a,privateKey:n}}async createKeyBackupVersion(e){this.algorithm=await p.makeAlgorithm(e,this.getKey)}async checkAndStart(){if(o.a.log("Checking key backup status..."),this.baseApis.isGuest())return o.a.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=await this.baseApis.getKeyBackupVersion()}catch(e){return o.a.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(o.a.log("Found usable key backup v"+e.version+": enabling key backups"),await this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(o.a.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(o.a.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):o.a.log("Backup version "+e.version+" still current")):o.a.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.signatures))return o.a.info("Key backup is absent or missing required data"),t;const s=this.baseApis.crypto.sessionStore.getLocalTrustedBackupPubKey();"public_key"in e.auth_data&&e.auth_data.public_key===s&&(o.a.info("Backup public key "+s+" is trusted locally"),t.trusted_locally=!0);const n=e.auth_data.signatures[this.baseApis.getUserId()]||[];for(const s of Object.keys(n)){const n=s.split(":");if("ed25519"!==n[0]){o.a.log("Ignoring unknown signature type: "+n[0]);continue}const i={deviceId:n[1]},a=this.baseApis.crypto.crossSigningInfo.getId();if(a===i.deviceId){i.crossSigningId=!0;try{await Object(r.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),i.deviceId,a),i.valid=!0}catch(e){o.a.warn("Bad signature from cross signing key "+a,e),i.valid=!1}t.sigs.push(i);continue}const c=this.baseApis.crypto.deviceList.getStoredDevice(this.baseApis.getUserId(),i.deviceId);if(c){i.device=c,i.deviceTrust=await this.baseApis.checkDeviceTrust(this.baseApis.getUserId(),i.deviceId);try{await Object(r.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),c.deviceId,c.getFingerprint()),i.valid=!0}catch(t){o.a.info("Bad signature from key ID "+s+" userID "+this.baseApis.getUserId()+" device ID "+c.deviceId+" fingerprint: "+c.getFingerprint(),e.auth_data,t),i.valid=!1}}else i.valid=null,o.a.info("Ignoring signature from unknown key "+s);t.sigs.push(i)}return t.usable=t.sigs.some(e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)),t.usable=t.usable||t.trusted_locally,t}async scheduleKeyBackupSend(e=1e4){if(!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;await Object(l.I)(t,void 0);let s=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return;s=0}catch(e){if(s++,o.a.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit("crypto.keyBackupFailed",e.data.errcode),e}s&&await Object(l.I)(1e3*Math.pow(2,Math.min(s-1,4)),void 0)}}finally{this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let s=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit("crypto.keyBackupSessionsRemaining",s);const n={};for(const e of t){const t=e.sessionData.room_id;void 0===n[t]&&(n[t]={sessions:{}});const s=await this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);s.algorithm=r.MEGOLM_ALGORITHM;const i=(s.forwarding_curve25519_key_chain||[]).length,a=this.baseApis.crypto.deviceList.getUserByIdentityKey(r.MEGOLM_ALGORITHM,e.senderKey),o=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(r.MEGOLM_ALGORITHM,e.senderKey),c=this.baseApis.crypto.checkDeviceInfoTrust(a,o).isVerified();n[t].sessions[e.sessionId]={first_message_index:s.first_known_index,forwarded_count:i,is_verified:c,session_data:await this.algorithm.encryptSession(s)}}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),s=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit("crypto.keyBackupSessionsRemaining",s),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.a.STORE_INBOUND_GROUP_SESSIONS,d.a.STORE_BACKUP],e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)})});const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit("crypto.keyBackupSessionsRemaining",e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class g{constructor(e,t,s){this.authData=e,this.publicKey=t,this.getKey=s}static async init(t,s){if(!t||!("public_key"in t))throw new Error("auth_data missing required information");const n=new e.Olm.PkEncryption;return n.set_recipient_key(t.public_key),new g(t,n,s)}static async prepare(t){const s=new e.Olm.PkDecryption;try{const n={};if(t)if(t instanceof Uint8Array)n.public_key=s.init_with_private_key(t);else{const e=await Object(c.c)(t);n.private_key_salt=e.salt,n.private_key_iterations=e.iterations,n.public_key=s.init_with_private_key(e.key)}else n.public_key=s.generate_key();return(new e.Olm.PkEncryption).set_recipient_key(n.public_key),[s.get_private_key(),n]}finally{s.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(t){const s=await this.getKey(),n=new e.Olm.PkDecryption;try{if(n.init_with_private_key(s)!==this.authData.public_key)throw{errcode:a.b.RESTORE_BACKUP_ERROR_BAD_KEY};const e=[];for(const[s,i]of Object.entries(t))try{const t=JSON.parse(n.decrypt(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext));t.session_id=s,e.push(t)}catch(e){o.a.log("Failed to decrypt megolm session from backup",e,i)}return e}finally{n.free()}}async keyMatches(t){const s=new e.Olm.PkDecryption;let n;try{n=s.init_with_private_key(t)}finally{s.free()}return n===this.authData.public_key}free(){this.publicKey.free()}}i()(g,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const v=new m.a(null,"org.matrix.msc3270.v1.aes-hmac-sha2");class f{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const s=await t();if(e.mac){const{mac:t}=await Object(u.a)(s,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new f(e,s)}static async prepare(e){let t;const s={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const n=await Object(c.c)(e);s.private_key_salt=n.salt,s.private_key_iterations=n.iterations,t=n.key}else t=function(e){var t;const s=Object(l.r)();if(s)return s.randomBytes(e);if(null!==(t=window)&&void 0!==t&&t.crypto){const t=new Uint8Array(e);return window.crypto.getRandomValues(t),t}throw new Error("No usable crypto implementation")}(32);const{iv:n,mac:i}=await Object(u.a)(t);return s.iv=n,s.mac=i,[t,s]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,await Object(u.c)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[s,n]of Object.entries(e))try{const e=JSON.parse(await Object(u.b)(n.session_data,this.key,s));e.session_id=s,t.push(e)}catch(e){o.a.log("Failed to decrypt megolm session from backup",e,n)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await Object(u.a)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}i()(f,"algorithmName",v.name);const b={[g.algorithmName]:g,[f.algorithmName]:f},y=g}).call(this,s(26))},function(e,t,s){"use strict";var n;let i;s.d(t,"a",(function(){return i})),function(e){e.RoomId="room_id",e.Sender="sender"}(n||(n={})),function(e){e.Recent="recent",e.Rank="rank"}(i||(i={}))},function(e,t,s){"use strict";s(82);t.a=({backgroundImage:e,blurMultiplier:t})=>null},,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r);const l=["children","label"],d=e=>{let{children:t,label:s}=e,n=o()(e,l);return c.a.createElement("div",i()({},n,{role:"group","aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(88),d=s(111);const h=["children","label","tooltip"],u=e=>{let{children:t,label:s,tooltip:n}=e,a=o()(e,h);const r=a["aria-label"]||s;return n?c.a.createElement(d.a,i()({},a,{role:"menuitem",tabIndex:-1,"aria-label":r,title:n}),t):c.a.createElement(l.a,i()({},a,{role:"menuitem",tabIndex:-1,"aria-label":r}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(88);const d=["children","label","active","disabled"],h=e=>{let{children:t,label:s,active:n,disabled:a}=e,r=o()(e,d);return c.a.createElement(l.a,i()({},r,{role:"menuitemcheckbox","aria-checked":n,"aria-disabled":a,disabled:a,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(88);const d=["children","label","active","disabled"],h=e=>{let{children:t,label:s,active:n,disabled:a}=e,r=o()(e,d);return c.a.createElement(l.a,i()({},r,{role:"menuitemradio","aria-checked":n,"aria-disabled":a,disabled:a,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(108),d=s(137);const h=["children","label","onChange","onClose"],u=e=>{let{children:t,label:s,onChange:n,onClose:a}=e,r=o()(e,h);return c.a.createElement(d.b,i()({},r,{role:"menuitemcheckbox",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==l.a.ENTER&&e.key!==l.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===l.a.ENTER&&a())},onKeyUp:e=>{e.key!==l.a.SPACE&&e.key!==l.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(108),d=s(176);const h=["children","label","onChange","onClose"],u=e=>{let{children:t,label:s,onChange:n,onClose:a}=e,r=o()(e,h);return c.a.createElement(d.a,i()({},r,{role:"menuitemradio",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==l.a.ENTER&&e.key!==l.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===l.a.ENTER&&a())},onKeyUp:e=>{e.key!==l.a.SPACE&&e.key!==l.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(340),c=s.n(r),l=s(84),d=s(362),h=s.n(d),u=s(87),m=s(86),p=s(91),g=s.n(p),v=s(98),f=s(128),b=s(1);class y extends o.a.PureComponent{constructor(e,t){super(e,t),i()(this,"unmounted",!1),i()(this,"dispatcherRef",null),i()(this,"onAction",e=>{"client_started"===e.action&&this.forceUpdate()}),this.state={page:""}}translate(e){return h()(Object(l.a)(e))}componentDidMount(){this.unmounted=!1,this.props.url&&(c()({method:"GET",url:this.props.url},(e,t,s)=>{if(!this.unmounted){if(e||t.status<200||t.status>=300)return b.a.warn("Error loading page: "+e),void this.setState({page:Object(l.a)("Couldn't load page")});s=s.replace(/_t\(['"]([\s\S]*?)['"]\)/gm,(e,t)=>this.translate(t)),this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach(e=>{s=s.split(e).join(this.props.replaceMap[e])}),this.setState({page:s})}}),this.dispatcherRef=u.a.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,null!==this.dispatcherRef&&u.a.unregister(this.dispatcherRef)}render(){const e=this.context||m.a.get(),t=!e||e.isGuest(),s=this.props.className,n=g()({[s]:!0,[s+"_guest"]:t,[s+"_loggedIn"]:!!e}),i=o.a.createElement("div",{className:s+"_body",dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?o.a.createElement(f.a,{className:n},i):o.a.createElement("div",{className:n},i)}}i()(y,"contextType",v.a)},,,,,,,,,,,,,function(e,t){},,,function(e,t){},,,,,,function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(339),h=s(86),u=s(247),m=s(84),p=s(182),g=s(122),v=s(444),f=s(85),b=s(245),y=s(96),E=s(134),S=s(133),_=s(118),w=s(1);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function O(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let k=Object(f.a)("structures.FilePanel")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"decryptingEvents",new Set),r()(this,"noRoom",void 0),r()(this,"state",{timelineSet:null}),r()(this,"onRoomTimeline",(e,t,s,n,i)=>{var a;if((null==t?void 0:t.roomId)!==(null===(a=this.props)||void 0===a?void 0:a.roomId))return;if(s||!i||!i.liveEvent||e.isRedacted())return;h.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)}),r()(this,"onEventDecrypted",(e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const s=e.getId();this.decryptingEvents.delete(s)&&(t||this.addEncryptedLiveEvent(e))}),r()(this,"onPaginationRequest",(e,t,s)=>{const n=h.a.get(),i=u.a.get(),a=this.props.roomId,o=n.getRoom(a);return n.isRoomEncrypted(a)&&null!==i?i.paginateTimelineWindow(o,e,t,s):e.paginate(t,s)})}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&-1!=["m.file","m.image","m.video","m.audio"].indexOf(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,!1))}async componentDidMount(){const e=h.a.get();await this.updateTimelineSet(this.props.roomId),h.a.get().isRoomEncrypted(this.props.roomId)&&null!==u.a.get()&&(e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted))}componentWillUnmount(){const e=h.a.get();null!==e&&h.a.get().isRoomEncrypted(this.props.roomId)&&null!==u.a.get()&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted))}async fetchFileEventsServer(e){const t=h.a.get(),s=new d.a(t.credentials.userId);s.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}});const n=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,s);s.filterId=n;return e.getOrCreateFilteredTimelineSet(s)}async updateTimelineSet(e){const t=h.a.get(),s=t.getRoom(e),n=u.a.get();if(this.noRoom=!s,s){let i;try{if(i=await this.fetchFileEventsServer(s),t.isRoomEncrypted(e)&&null!==n){const e=i.getLiveTimeline();await n.populateFileTimeline(i,e,s,10)}this.setState({timelineSet:i})}catch(e){w.a.error("Failed to get or create file panel filter",e)}}else w.a.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(h.a.get().isGuest())return l.a.createElement(p.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:g.c.RoomSummary},l.a.createElement("div",{className:"mx_RoomView_empty"},Object(m.a)("You must <a>register</a> to use this functionality",{},{a:e=>l.a.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return l.a.createElement(p.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:g.c.RoomSummary},l.a.createElement("div",{className:"mx_RoomView_empty"},Object(m.a)("You must join the room to see its files")));const e=l.a.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},l.a.createElement("h2",null,Object(m.a)("No files visible in this room")),l.a.createElement("p",null,Object(m.a)("Attach files from chat or just drag and drop them anywhere in a room."))),t=!this.noRoom&&h.a.get().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?l.a.createElement(_.b.Provider,{value:O(O({},this.context),{},{timelineRenderingType:_.a.File})},l.a.createElement(p.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:g.c.RoomSummary,withoutScrollContainer:!0},l.a.createElement(v.b,{isRoomEncrypted:t,kind:v.a.Files}),l.a.createElement(b.a,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,tileShape:E.a.FileGrid,resizeNotifier:this.props.resizeNotifier,empty:e,layout:S.a.Group,userNameColorMode:this.props.userNameColorMode}))):l.a.createElement(_.b.Provider,{value:O(O({},this.context),{},{timelineRenderingType:_.a.File})},l.a.createElement(p.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:g.c.RoomSummary},l.a.createElement(y.a,null)))}},r()(i,"contextType",_.b),n=a))||n;t.a=k},function(e,t,s){"use strict";s.d(t,"a",(function(){return B}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(652),d=s(89),h=s(446),u=s(656),m=s(88),p=s(658),g=s(121),v=s(86),f=s(90),b=s(87),y=s(297),E=s(205),S=s(210),_=s(256),w=s(978),C=s(96),O=s(100),k=s(115),R=s(85),I=s(104),x=s(979),T=s(980),j=s(981),N=s(982),P=s(983),D=s(985),M=s(986),A=s(987),U=s(1);function L(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function F(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?L(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):L(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let B=Object(R.a)("views.settings.tabs.user.GeneralUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"onAction",e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(v.a.get().getIdentityServerUrl())}),this.getThreepidState())}),a()(this,"onEmailsChange",e=>{this.setState({emails:e})}),a()(this,"onMsisdnsChange",e=>{this.setState({msisdns:e})}),a()(this,"onLanguageChange",e=>{if(this.state.language===e)return;d.b.setValue("language",null,O.a.DEVICE,e),this.setState({language:e});const t=g.a.get();t&&(t.setLanguage([e]),t.reload())}),a()(this,"onSpellCheckLanguagesChange",e=>{this.setState({spellCheckLanguages:e});const t=g.a.get();t&&t.setSpellCheckLanguages(e)}),a()(this,"onPasswordChangeError",e=>{let t=e.error||e.message||"";403===e.httpStatus?t=Object(c.a)("Failed to change password. Is your password correct?"):t||(t+=` (HTTP status ${e.httpStatus})`),U.a.error("Failed to change password: "+t),f.a.createTrackedDialog("Failed to change password","",I.a,{title:Object(c.a)("Error"),description:t})}),a()(this,"onPasswordChanged",()=>{f.a.createTrackedDialog("Password changed","",I.a,{title:Object(c.a)("Success"),description:Object(c.a)("Your password was successfully changed. You will not receive push notifications on other sessions until you log back in to them")+"."})}),a()(this,"onDeactivateClicked",()=>{f.a.createTrackedDialog("Deactivate Account","",p.a,{onFinished:e=>{e&&this.props.closeSettingsFn()}})}),this.state={language:c.d(),spellCheckLanguages:[],haveIdServer:Boolean(v.a.get().getIdentityServerUrl()),serverSupportsSeparateAddAndBind:null,idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1,policiesAndServices:null,agreedUrls:null,resolve:null},emails:[],msisdns:[],loading3pids:!0,canChangePassword:!1,idServerName:null},this.dispatcherRef=b.a.register(this.onAction)}async UNSAFE_componentWillMount(){const e=v.a.get(),t=await e.doesServerSupportSeparateAddAndBind(),s=(await e.getCapabilities())["m.change_password"],n=!s||!1!==s.enabled;this.setState({serverSupportsSeparateAddAndBind:t,canChangePassword:n}),this.getThreepidState()}async componentDidMount(){const e=g.a.get();e&&this.setState({spellCheckLanguages:await e.getSpellCheckLanguages()})}componentWillUnmount(){b.a.unregister(this.dispatcherRef)}async getThreepidState(){const e=v.a.get();this.checkTerms();let t=[];try{t=await Object(w.a)(e)}catch(e){const t=v.a.get().getIdentityServerUrl();U.a.warn(`Unable to reach identity server at ${t} to check for 3PIDs bindings in Settings`),U.a.warn(e)}this.setState({emails:t.filter(e=>"email"===e.medium),msisdns:t.filter(e=>"msisdn"===e.medium),loading3pids:!1})}async checkTerms(){if(!this.state.haveIdServer)return void this.setState({idServerHasUnsignedTerms:!1});const e=v.a.get().getIdentityServerUrl(),t=new S.a;try{const s=await t.getAccessToken({check:!1});await Object(y.d)([new y.a(E.a.IS,e,s)],(t,s,n)=>new Promise((n,i)=>{this.setState({idServerName:Object(_.a)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:s,resolve:n}})})),this.setState({requiredPolicyInfo:F({hasTerms:!1},this.state.requiredPolicyInfo)})}catch(t){U.a.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),U.a.warn(t)}}renderProfileSection(){return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(l.a,null))}renderAccountSection(){let e=r.a.createElement(P.a,{className:"mx_GeneralUserSettingsTab_changePassword",rowClassName:"",buttonKind:"primary",onError:this.onPasswordChangeError,onFinished:this.onPasswordChanged}),t=null;if(d.b.getValue(k.b.ThirdPartyID)&&(this.state.haveIdServer||!0===this.state.serverSupportsSeparateAddAndBind)){const e=this.state.loading3pids?r.a.createElement(C.a,null):r.a.createElement(T.a,{emails:this.state.emails,onEmailsChange:this.onEmailsChange}),s=this.state.loading3pids?r.a.createElement(C.a,null):r.a.createElement(x.a,{msisdns:this.state.msisdns,onMsisdnsChange:this.onMsisdnsChange});t=r.a.createElement("div",null,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Email addresses")),e,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Phone numbers")),s)}else null===this.state.serverSupportsSeparateAddAndBind&&(t=r.a.createElement(C.a,null));let s=Object(c.a)("Set a new account password...");return this.state.canChangePassword||(s=null,e=null),r.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralUserSettingsTab_accountSection"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Account")),r.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},s),e,t)}renderLanguageSection(){return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Language and region")),r.a.createElement(h.a,{className:"mx_GeneralUserSettingsTab_languageInput",onOptionChange:this.onLanguageChange,value:this.state.language}))}renderSpellCheckSection(){return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Spell check dictionaries")),r.a.createElement(u.a,{languages:this.state.spellCheckLanguages,onLanguagesChange:this.onSpellCheckLanguagesChange}))}renderDiscoverySection(){if(this.state.requiredPolicyInfo.hasTerms){const e=r.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Agree to the identity server (%(serverName)s) Terms of Service to allow yourself to be discoverable by email address or phone number.",{serverName:this.state.idServerName}));return r.a.createElement("div",null,r.a.createElement(D.a,{policiesAndServicePairs:this.state.requiredPolicyInfo.policiesAndServices,agreedUrls:this.state.requiredPolicyInfo.agreedUrls,onFinished:this.state.requiredPolicyInfo.resolve,introElement:e}),r.a.createElement(M.a,{missingTerms:!0}))}const e=this.state.loading3pids?r.a.createElement(C.a,null):r.a.createElement(j.a,{emails:this.state.emails}),t=this.state.loading3pids?r.a.createElement(C.a,null):r.a.createElement(N.a,{msisdns:this.state.msisdns}),s=this.state.haveIdServer?r.a.createElement("div",{className:"mx_GeneralUserSettingsTab_discovery"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Email addresses")),e,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Phone numbers")),t):null;return r.a.createElement("div",{className:"mx_SettingsTab_section"},s,r.a.createElement(M.a,{missingTerms:!1}))}renderManagementSection(){return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Account management")),r.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Deactivating your account is a permanent action - be careful!")),r.a.createElement(m.a,{onClick:this.onDeactivateClicked,kind:"danger"},Object(c.a)("Deactivate Account")))}renderIntegrationManagerSection(){return d.b.getValue(k.b.Widgets)?r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(A.a,null)):null}render(){const e=g.a.get().supportsMultiLanguageSpellCheck(),t=this.state.requiredPolicyInfo.hasTerms?r.a.createElement("img",{className:"mx_GeneralUserSettingsTab_warningIcon",src:s(723),width:"18",height:"18",alt:Object(c.a)("Warning")}):null;let n,i;return d.b.getValue(k.b.Deactivate)&&(n=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Deactivate account")),this.renderManagementSection())),d.b.getValue(k.b.IdentityServer)&&(i=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_heading"},t," ",Object(c.a)("Discovery")),this.renderDiscoverySection())),r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("General")),this.renderProfileSection(),this.renderAccountSection(),this.renderLanguageSection(),e?this.renderSpellCheckSection():null,i,this.renderIntegrationManagerSection(),n)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(101),h=s(653),u=s(228),m=s(90),p=s(104),g=s(85),v=s(103),f=s(88),b=s(445),y=s(1);let E=Object(g.a)("views.settings.ProfileSettings")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"avatarUpload",Object(o.createRef)()),a()(this,"uploadAvatar",()=>{this.avatarUpload.current.click()}),a()(this,"removeAvatar",()=>{this.avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,enableProfileSave:!0})}),a()(this,"cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),a()(this,"saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=l.a.get(),s={},n=this.state.displayName.trim();try{if(this.state.originalDisplayName!==this.state.displayName&&(await t.setDisplayName(n),s.originalDisplayName=n,s.displayName=n),this.state.avatarFile){y.a.log(`Uploading new avatar, ${this.state.avatarFile.name} of type ${this.state.avatarFile.type}, (${this.state.avatarFile.size}) bytes`);const e=await t.uploadContent(this.state.avatarFile);await t.setAvatarUrl(e),s.avatarUrl=Object(v.b)(e).getSquareThumbnailHttp(96),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.setAvatarUrl("")}catch(e){y.a.log("Failed to save profile",e),m.a.createTrackedDialog("Failed to save profile","",p.a,{title:Object(c.a)("Failed to save your profile"),description:e&&e.message?e.message:Object(c.a)("The operation could not be completed")})}this.setState(s)}),a()(this,"onDisplayNameChanged",e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})}),a()(this,"onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const t=l.a.get();let s=u.a.instance.avatarMxc;s&&(s=Object(v.b)(s).getSquareThumbnailHttp(96)),this.state={userId:t.getUserId(),originalDisplayName:u.a.instance.displayName,displayName:u.a.instance.displayName,originalAvatarUrl:s,avatarUrl:s,avatarFile:null,enableProfileSave:!1}}render(){var e;const t=Object(h.a)("user-settings");let n=null;return t&&(n=r.a.createElement("span",{className:"mx_ProfileSettings_hostingSignup"},Object(c.a)("<a>Upgrade</a> to your own domain",{},{a:e=>r.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e)}),r.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},r.a.createElement("img",{src:s(655),width:"11",height:"10",alt:""})))),r.a.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},r.a.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this.onAvatarChanged,accept:"image/*"}),r.a.createElement("div",{className:"mx_ProfileSettings_profile"},r.a.createElement("div",{className:"mx_ProfileSettings_controls"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Profile")),r.a.createElement(d.a,{label:Object(c.a)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged}),r.a.createElement("p",null,this.state.userId,n)),r.a.createElement(b.a,{avatarUrl:null===(e=this.state.avatarUrl)||void 0===e?void 0:e.toString(),avatarName:this.state.displayName||this.state.userId,avatarAltText:Object(c.a)("Profile picture"),uploadAvatar:this.uploadAvatar,removeAvatar:this.removeAvatar})),r.a.createElement("div",{className:"mx_ProfileSettings_buttons"},r.a.createElement(f.a,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(c.a)("Cancel")),r.a.createElement(f.a,{onClick:this.saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(c.a)("Save"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(93),i=s(86);function a(e){const t=n.a.get().hosting_signup_link;if(!t)return null;if(!e)return t;if("matrix.org"!==i.a.get().getDomain())return null;try{const s=new URL(t);return s.searchParams.set("utm_campaign",e),s.toString()}catch(e){return t}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(86),o=s(5);class r extends o.EventEmitter{constructor(e){super(),this.dispatcher=e,i()(this,"matrixClient",void 0),i()(this,"dispatcherRef",void 0),i()(this,"onAction",async e=>{if("MatrixActions.sync"===e.action){if("PREPARED"!==e.prevState||"PREPARED"===e.state)return;this.matrixClient!==e.matrixClient&&(this.matrixClient&&await this.onNotReady(),this.matrixClient=e.matrixClient,await this.onReady())}else"on_client_not_viable"!==e.action&&"on_logged_out"!==e.action||this.matrixClient&&(await this.onNotReady(),this.matrixClient=null)}),this.dispatcherRef=this.dispatcher.register(this.onAction),a.a.get()&&(this.matrixClient=a.a.get(),this.onReady())}get mxClient(){return this.matrixClient}useUnitTestClient(e){this.matrixClient=e}destroy(){this.dispatcher.unregister(this.dispatcherRef)}async onReady(){}async onNotReady(){}}},function(e,t){e.exports="img/external-link.a8d3e9b.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(657),l=s(88),d=s(84),h=s(85);class u extends r.a.Component{constructor(...e){super(...e),a()(this,"onRemove",e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language)))}render(){return r.a.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},r.a.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},this.props.language),r.a.createElement(l.a,{onClick:this.onRemove,kind:"danger_sm"},Object(d.a)("Remove")))}}let m=Object(h.a)("views.settings.SpellCheckLanguages")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onRemoved",e=>{const t=this.props.languages.filter(t=>t!==e);this.props.onLanguagesChange(t)}),a()(this,"onAddClick",e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))}),a()(this,"onNewLanguageChange",e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})}),this.state={newLanguage:""}}render(){const e=this.props.languages.map(e=>r.a.createElement(u,{language:e,onRemoved:this.onRemoved,key:e})),t=r.a.createElement(l.a,{onClick:this.onAddClick,kind:"primary"},Object(d.a)("Add"));return r.a.createElement("div",{className:"mx_SpellCheckLanguages"},e,r.a.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},r.a.createElement(c.a,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),t))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(82),a=s.n(i),o=s(229),r=s(121),c=s(89),l=s(84),d=s(85),h=s(96);let u=Object(d.a)("views.elements.SpellCheckLanguagesDropdown")(n=class extends a.a.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:"",languages:null}}componentDidMount(){const e=r.a.get();e&&e.getAvailableSpellCheckLanguages().then(e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach(e=>{t.push({label:e,value:e})}),this.setState({languages:t})}).catch(e=>{this.setState({languages:["en"]})})}onSearchChange(e){this.setState({searchQuery:e})}render(){if(null===this.state.languages)return a.a.createElement(h.a,null);let e;e=this.state.searchQuery?this.state.languages.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.languages;const t=e.map(e=>a.a.createElement("div",{key:e.value},e.label));let s=c.b.getValue("language",null,!0),n=null;return s||(s=navigator.language||navigator.userLanguage),n=this.props.value||s,a.a.createElement(o.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:n,label:Object(l.a)("Language Dropdown")},t)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(140),l=s(86),d=s(294),h=s(84),u=s(395),m=s(217),p=s(137),g=s(85),v=s(97),f=s(1);let b=Object(g.a)("views.dialogs.DeactivateAccountDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onStagePhaseChange",(e,t)=>{const s={[m.c.PHASE_PREAUTH]:{body:Object(h.a)("Confirm your account deactivation by using Single Sign On to prove your identity."),continueText:Object(h.a)("Single Sign On"),continueKind:"danger"},[m.c.PHASE_POSTAUTH]:{body:Object(h.a)("Are you sure you want to deactivate your account? This is irreversible."),continueText:Object(h.a)("Confirm account deactivation"),continueKind:"danger"}},n={[m.c.LOGIN_TYPE]:s,[m.c.UNSTABLE_LOGIN_TYPE]:s,[m.b.LOGIN_TYPE]:{[m.a]:{body:Object(h.a)("To continue, please enter your password:")}}}[e];let i=null,a=null,o=null;if(n){const e=n[t];e&&e.body&&(i=e.body),e&&e.continueText&&(a=e.continueText),e&&e.continueKind&&(o=e.continueKind)}this.setState({bodyText:i,continueText:a,continueKind:o})}),a()(this,"onUIAuthFinished",(e,t)=>{e||(t!==u.a?(f.a.error("Error during UI Auth:",{result:t}),this.setState({errStr:Object(h.a)("There was a problem communicating with the server. Please try again.")})):this.onCancel())}),a()(this,"onUIAuthComplete",e=>{l.a.get().deactivateAccount(e,this.state.shouldErase).then(e=>{c.a.trackEvent("Account","Deactivate Account"),d.j(),this.props.onFinished(!0)}).catch(e=>{f.a.error(e),this.setState({errStr:Object(h.a)("There was a problem communicating with the server. Please try again.")})})}),a()(this,"onEraseFieldChange",e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)}),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0,bodyText:null,continueText:null,continueKind:null},this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){l.a.get().deactivateAccount(null,e).then(e=>{f.a.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:Object(h.a)("Server did not require any authentication")})}).catch(e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:Object(h.a)("Server did not return valid authentication information.")})})}render(){let e=null;this.state.errStr&&(e=r.a.createElement("div",{className:"error"},this.state.errStr));let t=r.a.createElement("div",null,Object(h.a)("Loading..."));return this.state.authData&&this.state.authEnabled&&(t=r.a.createElement("div",null,this.state.bodyText,r.a.createElement(u.b,{matrixClient:l.a.get(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),r.a.createElement(v.a,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:Object(h.a)("Deactivate Account")},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("p",null,Object(h.a)("This will make your account permanently unusable. You will not be able to log in, and no one will be able to re-register the same user ID. This will cause your account to leave all rooms it is participating in, and it will remove your account details from your identity server. <b>This action is irreversible.</b>",{},{b:e=>r.a.createElement("b",null," ",e," ")})),r.a.createElement("p",null,Object(h.a)("Deactivating your account <b>does not by default cause us to forget messages you have sent.</b> If you would like us to forget your messages, please tick the box below.",{},{b:e=>r.a.createElement("b",null," ",e," ")})),r.a.createElement("p",null,Object(h.a)("Message visibility in Matrix is similar to email. Our forgetting your messages means that messages you have sent will not be shared with any new or unregistered users, but registered users who already have access to these messages will still have access to their copy.")),r.a.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},r.a.createElement("p",null,r.a.createElement(p.b,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},Object(h.a)("Please forget all messages I have sent when my account is deactivated (<b>Warning:</b> this will cause future users to see an incomplete view of conversations)",{},{b:e=>r.a.createElement("b",null,e)}))),e,t)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(83),i=s.n(n),a=s(1166),o=s.n(a),r=s(156),c=s(174),l=s(427),d=s(414);function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function u(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const m=window.localStorage;let p;try{p=window.indexedDB}catch(e){}function g(e){const t={useAuthorizationHeader:!0};return p&&m&&(t.store=new d.a({indexedDB:p,dbName:"riot-web-sync",localStorage:m,workerFactory:()=>new o.a})),m&&(t.sessionStore=new l.a(m)),p&&(t.cryptoStore=new c.a(p,"matrix-js-sdk:crypto")),Object(r.createClient)(u(u({},t),e))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(89),d=s(100),h=s(85),u=s(97);let m=Object(h.a)("views.dialogs.AskInviteAnywayDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onInviteClicked",()=>{this.props.onInviteAnyways(),this.props.onFinished(!0)}),a()(this,"onInviteNeverWarnClicked",()=>{l.b.setValue("promptBeforeInviteUnknownUsers",null,d.a.ACCOUNT,!1),this.props.onInviteAnyways(),this.props.onFinished(!0)}),a()(this,"onGiveUpClicked",()=>{this.props.onGiveUp(),this.props.onFinished(!1)})}render(){const e=this.props.unknownProfileUsers.map(e=>r.a.createElement("li",{key:e.userId},e.userId,": ",e.errorText));return r.a.createElement(u.a,{className:"mx_RetryInvitesDialog",onFinished:this.onGiveUpClicked,title:Object(c.a)("The following users may not exist"),contentId:"mx_Dialog_content"},r.a.createElement("div",{id:"mx_Dialog_content"},r.a.createElement("p",null,Object(c.a)("Unable to find profiles for the Matrix IDs listed below - would you like to invite them anyway?")),r.a.createElement("ul",null,e)),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onGiveUpClicked},Object(c.a)("Close")),r.a.createElement("button",{onClick:this.onInviteNeverWarnClicked},Object(c.a)("Invite anyway and never warn me again")),r.a.createElement("button",{onClick:this.onInviteClicked,autoFocus:!0},Object(c.a)("Invite anyway"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a}));var n=s(662);const i="https://matrix.to";class a extends n.b{constructor(){super()}forEvent(e,t,s){return`${i}/#/${e}/${t}${this.encodeServerCandidates(s)}`}forRoom(e,t){return`${i}/#/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${i}/#/${e}`}forGroup(e){return`${i}/#/${e}`}forEntity(e){return`${i}/#/${e}`}isPermalinkHost(e){return"matrix.to"===e}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(i))throw new Error("Does not appear to be a permalink");const t=e.substring((i+"/#/").length).split("/"),s=t[0];if("@"===s[0])return n.a.forUser(s);if("+"===s[0])return n.a.forGroup(s);if("#"===s[0]||"!"===s[0]){if(1===t.length){const[e,t=""]=s.split("?"),i=t.split(/&?via=/g).filter(e=>!!e);return n.a.forRoom(e,i)}const e=t.length>1?t.slice(1).join("/"):"",[i,a=""]=e.split("?"),o=a.split(/&?via=/g).filter(e=>!!e);return n.a.forEvent(s,i,o)}throw new Error("Unknown entity type in permalink")}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return o}));var n=s(83),i=s.n(n);class a{forEvent(e,t,s=[]){throw new Error("Not implemented")}forRoom(e,t=[]){throw new Error("Not implemented")}forGroup(e){throw new Error("Not implemented")}forUser(e){throw new Error("Not implemented")}forEntity(e){throw new Error("Not implemented")}isPermalinkHost(e){throw new Error("Not implemented")}parsePermalink(e){throw new Error("Not implemented")}}class o{constructor(e,t,s,n,a){i()(this,"roomIdOrAlias",void 0),i()(this,"eventId",void 0),i()(this,"userId",void 0),i()(this,"groupId",void 0),i()(this,"viaServers",void 0),this.roomIdOrAlias=e,this.eventId=t,this.groupId=n,this.userId=s,this.viaServers=a}static forUser(e){return new o(null,null,e,null,null)}static forGroup(e){return new o(null,null,null,e,null)}static forRoom(e,t=[]){return new o(e,null,null,null,t)}static forEvent(e,t,s=[]){return new o(e,t,null,null,s)}get primaryEntityId(){return this.roomIdOrAlias||this.userId||this.groupId}get sigil(){return this.primaryEntityId[0]}}},function(e,t,s){"use strict";function n(e,t){const s=t.getUserId();for(const t of Object.keys(e.getContent())){if(Object.keys(e.getContent()[t]["m.read"]||{}).includes(s))return!0}}s.d(t,"a",(function(){return n}))},,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return a}));const n=new Map;function i(e,t){n.set(e,t)}function a(e){return n.get(e)}},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var n=s(94),i=s(86),a=s(302),o=s(134);function r(e){if(e.getSender()===i.a.get().credentials.userId)return!1;switch(e.getType()){case n.a.RoomMember:case n.a.RoomThirdPartyInvite:case n.a.CallAnswer:case n.a.CallHangup:case n.a.RoomAliases:case n.a.RoomCanonicalAlias:case n.a.RoomServerAcl:return!1}return!e.isRedacted()&&Object(o.d)(e)}function c(e){const t=i.a.get().getUserId(),s=e.getEventReadUpTo(t);if(e.timeline.length&&e.timeline[e.timeline.length-1].getSender()===t)return!1;for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getId()==s)return!1;if(!Object(a.a)(n)&&r(n))return!0}return!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(82),i=s.n(n);function a(e,t){const s=[];return e.forEach((n,i)=>{s.push(n,i===e.length-1?null:t)}),i.a.createElement("span",null,s)}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(82),a=s.n(i),o=s(110),r=s.n(o),c=s(183),l=s(87),d=s(98),h=s(85),u=s(103),m=s(1);class p extends a.a.Component{constructor(){super(),this.onClick=this.onClick.bind(this)}onClick(e){e.preventDefault(),e.stopPropagation(),l.a.dispatch({action:"view_group",group_id:this.props.groupProfile.groupId})}render(){const e=Object(u.b)(this.props.groupProfile.avatarUrl).getSquareThumbnailHttp(16),t=this.props.groupProfile.name?`${this.props.groupProfile.name} (${this.props.groupProfile.groupId})`:this.props.groupProfile.groupId;return a.a.createElement("img",{src:e,width:"16",height:"16",onClick:this.onClick,title:t})}}p.propTypes={groupProfile:r.a.shape({groupId:r.a.string.isRequired,name:r.a.string,avatarUrl:r.a.string.isRequired})},p.contextType=d.a;let g=Object(h.a)("views.elements.Flair")(n=class extends a.a.Component{constructor(){super(),this.state={profiles:[]}}componentDidMount(){this._unmounted=!1,this._generateAvatars(this.props.groups)}componentWillUnmount(){this._unmounted=!0}UNSAFE_componentWillReceiveProps(e){this._generateAvatars(e.groups)}async _getGroupProfiles(e){const t=[];for(const s of e){let e=null;try{e=await c.a.getGroupProfileCached(this.context,s)}catch(e){m.a.error("Could not get profile for group",s,e)}t.push(e)}return t.filter(e=>null!==e)}async _generateAvatars(e){if(!e||0===e.length)return;const t=await this._getGroupProfiles(e);this.unmounted||this.setState({profiles:t.filter(e=>!!e&&e.avatarUrl)})}render(){if(0===this.state.profiles.length)return null;const e=this.state.profiles.map((e,t)=>a.a.createElement(p,{key:t,groupProfile:e}));return a.a.createElement("span",{className:"mx_Flair"},e)}})||n;g.propTypes={groups:r.a.arrayOf(r.a.string)},g.contextType=d.a},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(477),c=s(713),l=s(375),d=s(94),h=s(84);class u extends r.a{constructor(...e){super(...e),i()(this,"onClick",e=>{e.preventDefault()})}wrapImage(e,t){return t}getFileBody(){const e=this.props.mxEvent.getType()===d.a.Sticker;return Object(c.a)(this.props.mxEvent.getContent(),e?Object(h.a)("Sticker"):Object(h.a)("Image"),!e)}render(){if(null!==this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.getContentUrl(),s=this.messageContent(t,this.getThumbUrl(),e,44),n=this.getFileBody(),i=o.a.createElement(l.a,{mxEvent:this.props.mxEvent,enableFlair:!1});return o.a.createElement("div",{className:"mx_MImageReplyBody"},s,o.a.createElement("div",{className:"mx_MImageReplyBody_info"},o.a.createElement("div",{className:"mx_MImageReplyBody_sender"},i),o.a.createElement("div",{className:"mx_MImageReplyBody_filename"},n)))}}},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(306),i=s.n(n),a=s(84);function o(e,t=Object(a.a)("Attachment"),s=!0,n=!1){let o=t;if(e.body&&e.body.length>0&&(o=e.body),n&&o.length>19){const e=o.split(".");let t=e.slice(0,e.length-1).join(".").substring(0,15);const s=e[e.length-1];t=t.replace(/\.*$/g,""),o=`${t}...${s}`}return e.info&&e.info.size&&s&&(o+=" ("+i()(e.info.size)+")"),o}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n);function a(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function o(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?a(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):a(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const r={imgSrc:"",imgStyle:null,style:"",textContent:""};let c,l;class d{constructor(e=null){this.iframeFn=e,i()(this,"onLoadPromise",void 0)}get iframe(){var e;const t=null===(e=this.iframeFn)||void 0===e?void 0:e.call(this);if(!t){const e=(c||(c=document.createElement("iframe"),document.body.appendChild(c),c.style.display="none",c.sandbox="allow-scripts allow-downloads allow-downloads-without-user-activation",l=new Promise(e=>{c.onload=()=>{e()},c.src="usercontent/"})),{iframe:c,onLoadPromise:l});return this.onLoadPromise=e.onLoadPromise,e.iframe}return this.onLoadPromise=null,t}async download({blob:e,name:t,autoDownload:s=!0,opts:n=r}){const i=this.iframe;this.onLoadPromise&&await this.onLoadPromise,i.contentWindow.postMessage(o(o({},n),{},{blob:e,download:t,auto:s}),"*")}}},,function(e,t,s){"use strict";function n(e){e["io.element.performance_metrics"]={sendStartTs:Date.now()}}function i(e,t,s){e.sendEvent(t,"io.element.performance_metric",{"io.element.performance_metrics":{forEventId:s,responseTs:Date.now(),kind:"send_time"}})}s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(87),h=s(92),u=s(88),m=s(718),p=s(142),g=s(84),v=s(136),f=s(85),b=s(98),y=s(161),E=s(111),S=s(134);let _=Object(f.a)("views.rooms.PinnedEventTile")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"onTileClicked",()=>{d.a.dispatch({action:h.a.ViewRoom,event_id:this.props.event.getId(),highlighted:!0,room_id:this.props.event.getRoomId()})})}render(){const e=this.props.event.getSender(),t=this.props.room.getMember(e);let s=null;return this.props.onUnpinClicked&&(s=l.a.createElement(E.a,{onClick:this.props.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton",title:Object(g.a)("Unpin")})),l.a.createElement("div",{className:"mx_PinnedEventTile"},l.a.createElement(p.a,{className:"mx_PinnedEventTile_senderAvatar",member:t,width:24,height:24,fallbackUserId:e}),l.a.createElement("span",{className:"mx_PinnedEventTile_sender "+Object(y.f)(this.props.userNameColorMode,e,this.props.room)},(null==t?void 0:t.name)||e),s,l.a.createElement("div",{className:"mx_PinnedEventTile_message"},l.a.createElement(m.a,{mxEvent:this.props.event,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{},tileShape:S.a.Pinned})),l.a.createElement("div",{className:"mx_PinnedEventTile_footer"},l.a.createElement("span",{className:"mx_PinnedEventTile_timestamp"},Object(v.b)(new Date(this.props.event.getTs()))),l.a.createElement(u.a,{onClick:this.onTileClicked,kind:"link"},Object(g.a)("View message"))))}},r()(i,"contextType",b.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(107),l=s(89),d=s(480),h=s(481),u=s(719),m=s(85),p=s(597),g=s(94),v=s(263);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let y=Object(m.a)("views.messages.MessageEvent")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"body",Object(o.createRef)()),a()(this,"mediaHelper",void 0),a()(this,"getEventTileOps",()=>{var e,t;return(null===(e=this.body.current)||void 0===e||null===(t=e.getEventTileOps)||void 0===t?void 0:t.call(e))||null}),a()(this,"onTileUpdate",()=>{this.forceUpdate()}),p.a.isEligible(this.props.mxEvent)&&(this.mediaHelper=new p.a(this.props.mxEvent))}componentWillUnmount(){var e;null===(e=this.mediaHelper)||void 0===e||e.destroy()}componentDidUpdate(e){var t;this.props.mxEvent!==e.mxEvent&&p.a.isEligible(this.props.mxEvent)&&(null===(t=this.mediaHelper)||void 0===t||t.destroy(),this.mediaHelper=new p.a(this.props.mxEvent))}get bodyTypes(){return b({[g.b.Text]:c.getComponent("messages.TextualBody"),[g.b.Notice]:c.getComponent("messages.TextualBody"),[g.b.Emote]:c.getComponent("messages.TextualBody"),[g.b.Image]:c.getComponent("messages.MImageBody"),[g.b.File]:c.getComponent("messages.MFileBody"),[g.b.Audio]:c.getComponent("messages.MVoiceOrAudioBody"),[g.b.Video]:c.getComponent("messages.MVideoBody")},this.props.overrideBodyTypes||{})}get evTypes(){return b({[g.a.Sticker]:c.getComponent("messages.MStickerBody")},this.props.overrideEventTypes||{})}getMediaHelper(){return this.mediaHelper}render(){const e=this.props.mxEvent.getContent(),t=this.props.mxEvent.getType(),s=e.msgtype;let n=h.a;if(this.props.mxEvent.isRedacted()||(n=t&&this.evTypes[t]?this.evTypes[t]:s&&this.bodyTypes[s]?this.bodyTypes[s]:e.url?this.bodyTypes[g.b.File]:u.a,t&&t===v.c.name&&l.b.getValue("feature_polls")&&(n=c.getComponent("messages.MPollBody"))),l.b.getValue("feature_mjolnir")){const e=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;if(!("true"===localStorage.getItem(e))){const e=this.props.mxEvent.getSender().split(":").slice(1).join(":"),t=d.a.sharedInstance().isUserBanned(this.props.mxEvent.getSender()),s=d.a.sharedInstance().isServerBanned(e);(t||s)&&(n=c.getComponent("messages.MjolnirBody"))}}return n?r.a.createElement(n,{ref:this.body,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,forExport:this.props.forExport,maxImageHeight:this.props.maxImageHeight,replacingEventId:this.props.replacingEventId,editState:this.props.editState,onHeightChanged:this.props.onHeightChanged,onMessageAllowed:this.onTileUpdate,permalinkCreator:this.props.permalinkCreator,mediaEventHelper:this.mediaHelper,scBubble:this.props.scBubble,scBubbleGroupTimestamp:this.props.scBubbleGroupTimestamp,scBubbleActionBar:this.props.scBubbleActionBar,getRelationsForEvent:this.props.getRelationsForEvent}):null}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n);t.a=Object(n.forwardRef)(({mxEvent:e,children:t},s)=>{const n=e.getContent().body;return i.a.createElement("span",{className:"mx_UnknownBody",ref:s},n,t)})},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(715),i=s.n(n),a=s(103),o=s(721);function r(e,t){return Object(a.a)({file:e}).downloadSource().then(e=>e.arrayBuffer()).then(t=>i.a.decryptAttachment(t,e)).then(e=>{let s=null!=t&&t.mimetype?t.mimetype.split(";")[0].trim():"";return s=Object(o.a)(s),new Blob([e],{type:s})})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const n=["image/jpeg","image/gif","image/png","video/mp4","video/webm","video/ogg","audio/mp4","audio/webm","audio/aac","audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/x-pn-wav","audio/flac","audio/x-flac"];function i(e){return n.includes(e)?e:"application/octet-stream"}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(91),o=s.n(a),r=s(117),c=s(84),l=s(87),d=s(236),h=s(115),u=s(133),m=s(97),p=s(199),g=s(134),v=s(237),f=s(284),b=s(150),y=s(111),E=s(128),S=s(264),_=s(192),w=s(460),C=s(214),O=s(311),k=s(312),R=s(125),I=s(106),x=s(180);var T;!function(e){e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed"}(T||(T={}));const j=({room:e,event:t,matrixClient:s,onFinished:a})=>{const[o,r]=Object(n.useState)(T.CanSend);let d,h,u,m=!1;o===T.CanSend?(d="mx_ForwardList_canSend",e.maySendMessage()?h=Object(c.a)("Send"):(m=!0,h=Object(c.a)("You don't have permission to do this"))):o===T.Sending?(d="mx_ForwardList_sending",m=!0,h=Object(c.a)("Sending"),u=i.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):o===T.Sent?(d="mx_ForwardList_sent",m=!0,h=Object(c.a)("Sent"),u=i.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":h})):(d="mx_ForwardList_sendFailed",m=!0,h=Object(c.a)("Failed to send"),u=i.a.createElement(_.a,{notification:S.a.RED_EXCLAMATION}));const p=Object(x.f)(e);return i.a.createElement("div",{className:"mx_ForwardList_entry"},i.a.createElement(y.a,{className:"mx_ForwardList_roomButton",onClick:()=>{l.a.dispatch({action:"view_room",room_id:e.roomId}),a(!0)},title:Object(c.a)("Open link"),yOffset:-20,alignment:b.a.Top},i.a.createElement(f.a,{room:e,avatarSize:32}),i.a.createElement("span",{className:"mx_ForwardList_entry_name"},e.name),p&&i.a.createElement("span",{className:"mx_ForwardList_entry_detail"},p)),i.a.createElement(y.a,{kind:o===T.Failed?"danger_outline":"primary_outline",className:"mx_ForwardList_sendButton "+d,onClick:async()=>{r(T.Sending);try{await s.sendEvent(e.roomId,t.getType(),t.getContent()),r(T.Sent)}catch(e){r(T.Failed)}},disabled:m,title:h,yOffset:-20,alignment:b.a.Top},i.a.createElement("div",{className:"mx_ForwardList_sendLabel"},Object(c.a)("Send")),u))};t.a=({matrixClient:e,event:t,permalinkCreator:a,onFinished:l})=>{const f=e.getUserId(),[b,y]=Object(n.useState)({});Object(n.useEffect)(()=>{e.getProfileInfo(f).then(e=>y(e))},[e,f]);const S=new r.b({type:"m.room.message",sender:f,content:t.getContent(),unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:t.getRoomId()});S.sender={name:b.displayname||f,rawDisplayName:b.displayname,userId:f,getAvatarUrl:(...e)=>Object(p.c)({avatarUrl:b.avatar_url},30,30,"crop"),getMxcAvatarUrl:()=>b.avatar_url};const[_,x]=Object(n.useState)(""),T=_.toLowerCase(),N=I.a.spacesEnabled,P=Object(d.a)(h.b.Flair),D=Object(d.b)("layout");let M=Object(n.useMemo)(()=>Object(w.b)(e.getVisibleRooms().filter(e=>"join"===e.getMyMembership()&&!(N&&e.isSpaceRoom()))),[e,N]);T&&(M=new C.a(M,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(T));const[A,U]=Object(n.useState)(20);return i.a.createElement(m.a,{title:Object(c.a)("Forward message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:l,fixedWidth:!1},i.a.createElement("h3",null,Object(c.a)("Message preview")),i.a.createElement("div",{className:o()("mx_ForwardDialog_preview",{mx_IRCLayout:D==u.a.IRC,mx_GroupLayout:D==u.a.Group,sc_BubbleLayout:D==u.a.Bubble})},i.a.createElement(g.b,{mxEvent:S,layout:D,enableFlair:P,permalinkCreator:a,as:"div"})),i.a.createElement("hr",null),i.a.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},i.a.createElement(v.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Search for rooms or people"),onSearch:x,autoFocus:!0}),i.a.createElement(E.a,{className:"mx_ForwardList_content"},M.length>0?i.a.createElement("div",{className:"mx_ForwardList_results"},i.a.createElement(O.a,{truncateAt:A,createOverflowElement:function(e,t){const n=Object(c.a)("and %(count)s others...",{count:e});return i.a.createElement(k.b,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(R.a,{url:s(313),name:"...",width:36,height:36}),name:n,presenceState:"online",suppressOnHover:!0,onClick:()=>U(t)})},getChildren:(s,n)=>M.slice(s,n).map(s=>i.a.createElement(j,{key:s.roomId,room:s,event:t,matrixClient:e,onFinished:l})),getChildCount:()=>M.length})):i.a.createElement("span",{className:"mx_ForwardList_noResults"},Object(c.a)("No results")))))}},function(e,t){e.exports="img/feather-customised/warning-triangle.67c7f88.svg"},,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(93),d=s(85),h=s(97),u=s(109);let m=Object(d.a)("views.dialogs.IntegrationsImpossibleDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onAcknowledgeClick",()=>{this.props.onFinished()})}render(){const e=l.a.get().brand;return r.a.createElement(h.a,{className:"mx_IntegrationsImpossibleDialog",hasCancel:!1,onFinished:this.props.onFinished,title:Object(c.a)("Integrations not allowed")},r.a.createElement("div",{className:"mx_IntegrationsImpossibleDialog_content"},r.a.createElement("p",null,Object(c.a)("Your %(brand)s doesn't allow you to use an integration manager to do this. Please contact an admin.",{brand:e}))),r.a.createElement(u.a,{primaryButton:Object(c.a)("OK"),onPrimaryButtonClick:this.onAcknowledgeClick,hasCancel:!1}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(201),l=s(297),d=s(91),h=s.n(d),u=s(733),m=s(85),p=s(88),g=s(492),v=s(1);let f=Object(m.a)("views.dialogs.TabbedIntegrationManagerDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"openManager",async(e,t=!1)=>{if(e===this.state.currentIndex&&!t)return;const s=this.state.managers[e],n=s.getScalarClient();this.setState({busy:!0,currentIndex:e,currentLoading:!0,currentConnected:!1,currentScalarClient:n}),u.a(s.uiUrl),n.setTermsInteractionCallback((e,t)=>Object(l.c)(e,t,"mx_TermsDialog_forIntegrationManager"));try{await n.connect(),n.hasCredentials()?this.setState({busy:!1,currentLoading:!1,currentConnected:!0}):this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}catch(e){if(e instanceof l.b)return;v.a.error(e),this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}}),this.state={managers:c.a.sharedInstance().getOrderedManagers(),busy:!0,currentIndex:0,currentConnected:!1,currentLoading:!0,currentScalarClient:null}}componentDidMount(){this.openManager(0,!0)}renderTabs(){return this.state.managers.map((e,t)=>{const s=h()({mx_TabbedIntegrationManagerDialog_tab:!0,mx_TabbedIntegrationManagerDialog_currentTab:this.state.currentIndex===t});return r.a.createElement(p.a,{className:s,onClick:()=>this.openManager(t),key:"tab_"+t,disabled:this.state.busy},e.name)})}renderTab(){let e=null;return this.state.currentScalarClient&&(e=this.state.currentScalarClient.getScalarInterfaceUrlForRoom(this.props.room,this.props.screen,this.props.integrationId)),r.a.createElement(g.a,{loading:this.state.currentLoading,connected:this.state.currentConnected,url:e,onFinished:()=>{}})}render(){return r.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_container"},r.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_tabs"},this.renderTabs()),r.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_currentManager"},this.renderTab()))}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return _})),s.d(t,"c",(function(){return w})),s.d(t,"a",(function(){return C}));var n,i=s(86),a=s(117),o=s(87),r=s(152),c=s(132),l=s(84),d=s(201),h=s(178),u=s(144),m=s(1);function p(e,t){const s=Object(u.a)(e.data);s.response=t,e.source.postMessage(s,e.origin)}function g(e,t,s){m.a.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(u.a)(e.data);n.response={error:{message:t}},s&&(n.response.error._error=s),e.source.postMessage(n,e.origin)}function v(e,t){const s=e.data.widget_id;let n=e.data.type;const i=e.data.url,a=e.data.name,c=e.data.data,d=e.data.userWidget;if(s&&void 0!==i){if(null!==i){if(void 0!==a&&"string"!=typeof a)return void g(e,Object(l.a)("Unable to create widget."),new Error("Optional field 'name' must be a string."));if(void 0!==c&&!(c instanceof Object))return void g(e,Object(l.a)("Unable to create widget."),new Error("Optional field 'data' must be an Object."));if("string"!=typeof n)return void g(e,Object(l.a)("Unable to create widget."),new Error("Field 'type' must be a string."));if("string"!=typeof i)return void g(e,Object(l.a)("Unable to create widget."),new Error("Field 'url' must be a string or null."))}n=h.a.fromString(n),d?r.a.setUserWidget(s,n,i,a,c).then(()=>{p(e,{success:!0}),o.a.dispatch({action:"user_widget_updated"})}).catch(t=>{g(e,Object(l.a)("Unable to create widget."),t)}):(t||g(e,Object(l.a)("Missing roomId."),null),r.a.setRoomWidget(t,s,n,i,a,c).then(()=>{p(e,{success:!0})},t=>{g(e,Object(l.a)("Failed to send request."),t)}))}else g(e,Object(l.a)("Unable to create widget."),new Error("Missing required widget fields."))}function f(e,t){const s=i.a.get();if(!s)return void g(e,Object(l.a)("You need to be logged in."));let n=[];if(t){const i=s.getRoom(t);if(!i)return void g(e,Object(l.a)("This room is not recognised."));n=r.a.getRoomWidgets(i).map(e=>e.event)}const a=r.a.getUserWidgetsArray();n=n.concat(a),p(e,n)}function b(e,t,s,n){const a=i.a.get();if(!a)return void g(e,Object(l.a)("You need to be logged in."));const o=a.getRoom(t);if(!o)return void g(e,Object(l.a)("This room is not recognised."));const r=o.currentState.getStateEvents(s,n);p(e,r?r.getContent():null)}!function(e){e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidgets="set_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power"}(n||(n={}));const y=function(e){let t,s;e.origin||(e.origin=e.originalEvent.origin);try{S||(S=d.a.sharedInstance().getPrimaryManager().uiUrl),t=new URL(S)}catch(e){return}try{s=new URL(e.origin)}catch(e){return}if(t.origin!==s.origin||!e.data.action||e.data.api)return;if(e.data.action===n.CloseScalar)return o.a.dispatch({action:n.CloseScalar}),void p(e,null);const r=e.data.room_id,h=e.data.user_id;if(!r)return e.data.action===n.GetWidgets?void f(e,null):e.data.action===n.SetWidgets?void v(e,null):void g(e,Object(l.a)("Missing room_id in request"));if(r===c.a.getRoomId())if(e.data.action!==n.GetWidgets)if(e.data.action!==n.SetWidget)if(e.data.action!==n.JoinRulesState)if(e.data.action!==n.SetPlumbingState)if(e.data.action!==n.GetMembershipCount)if(e.data.action!==n.GetRoomEncryptionState)if(e.data.action!==n.CanSendEvent)if(h)switch(e.data.action){case n.MembershipState:!function(e,t,s){m.a.log(`membership_state of ${s} in room ${t} requested.`),b(e,t,"m.room.member",s)}(e,r,h);break;case n.invite:!function(e,t,s){m.a.log(`Received request to invite ${s} into room ${t}`);const n=i.a.get();if(!n)return void g(e,Object(l.a)("You need to be logged in."));const a=n.getRoom(t);if(a){const t=a.getMember(s);if(t&&"invite"===t.membership)return void p(e,{success:!0})}n.invite(t,s).then((function(){p(e,{success:!0})}),(function(t){g(e,Object(l.a)("You need to be able to invite users to do that."),t)}))}(e,r,h);break;case n.BotOptions:!function(e,t,s){m.a.log(`bot_options of ${s} in room ${t} requested.`),b(e,t,"m.room.bot.options","_"+s)}(e,r,h);break;case n.SetBotOptions:!function(e,t,s){m.a.log(`Received request to set options for bot ${s} in room ${t}`);const n=i.a.get();n?n.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+s).then(()=>{p(e,{success:!0})},t=>{g(e,t.message?t.message:Object(l.a)("Failed to send request."),t)}):g(e,Object(l.a)("You need to be logged in."))}(e,r,h);break;case n.SetBotPower:!async function(e,t,s,n,o){if(!(Number.isInteger(n)&&n>=0))return void g(e,Object(l.a)("Power level must be positive integer."));m.a.log(`Received request to set power level to ${n} for bot ${s} in room ${t}.`);const r=i.a.get();if(r)try{const i=await r.getStateEvent(t,"m.room.power_levels","");if(!0===o){if((i.content.users&&i.content.users[s]||i.content.users_default||0)>=n)return p(e,{success:!0})}await r.setPowerLevel(t,s,n,new a.b({type:"m.room.power_levels",content:i})),p(e,{success:!0})}catch(t){g(e,t.message?t.message:Object(l.a)("Failed to send request."),t)}else g(e,Object(l.a)("You need to be logged in."))}(e,r,h,e.data.level,e.data.ignoreIfGreater);break;default:m.a.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else g(e,Object(l.a)("Missing user_id in request"));else!function(e,t){const s=""+e.data.event_type,n=Boolean(e.data.is_state),a=i.a.get();if(!a)return void g(e,Object(l.a)("You need to be logged in."));const o=a.getRoom(t);if(!o)return void g(e,Object(l.a)("This room is not recognised."));if("join"!==o.getMyMembership())return void g(e,Object(l.a)("You are not in this room."));const r=a.credentials.userId;let c=!1;c=n?o.currentState.maySendStateEvent(s,r):o.currentState.maySendEvent(s,r),c?p(e,!0):g(e,Object(l.a)("You do not have permission to do that in this room."))}(e,r);else!function(e,t){const s=i.a.get();if(!s)return void g(e,Object(l.a)("You need to be logged in."));if(!s.getRoom(t))return void g(e,Object(l.a)("This room is not recognised."));p(e,i.a.get().isRoomEncrypted(t))}(e,r);else!function(e,t){const s=i.a.get();if(!s)return void g(e,Object(l.a)("You need to be logged in."));const n=s.getRoom(t);if(!n)return void g(e,Object(l.a)("This room is not recognised."));p(e,n.getJoinedMemberCount())}(e,r);else!function(e,t,s){if("string"!=typeof s)throw new Error("Plumbing state status should be a string");m.a.log(`Received request to set plumbing state to status "${s}" in room ${t}`);const n=i.a.get();n?n.sendStateEvent(t,"m.room.plumbing",{status:s}).then(()=>{p(e,{success:!0})},t=>{g(e,t.message?t.message:Object(l.a)("Failed to send request."),t)}):g(e,Object(l.a)("You need to be logged in."))}(e,r,e.data.status);else!function(e,t){m.a.log(`join_rules of ${t} requested.`),b(e,t,"m.room.join_rules","")}(e,r);else v(e,r);else f(e,r);else g(e,Object(l.a)("Room %(roomId)s not visible",{roomId:r}))};let E=0,S=null;function _(){0===E&&window.addEventListener("message",y,!1),E+=1}function w(){if(E-=1,0===E&&window.removeEventListener("message",y),E<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");m.a.error(e)}}function C(e){S=e}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(87),d=s(92),h=s(85),u=s(97),m=s(109);let p=Object(h.a)("views.dialogs.IntegrationsDisabledDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onAcknowledgeClick",()=>{this.props.onFinished()}),a()(this,"onOpenSettingsClick",()=>{this.props.onFinished(),l.a.fire(d.a.ViewUserSettings)})}render(){return r.a.createElement(u.a,{className:"mx_IntegrationsDisabledDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Integrations are disabled")},r.a.createElement("div",{className:"mx_IntegrationsDisabledDialog_content"},r.a.createElement("p",null,Object(c.a)("Enable 'Manage Integrations' in Settings to do this."))),r.a.createElement(m.a,{primaryButton:Object(c.a)("Settings"),onPrimaryButtonClick:this.onOpenSettingsClick,cancelButton:Object(c.a)("OK"),onCancel:this.onAcknowledgeClick}))}})||n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n),a=s(141),o=s(86),r=s(130),c=s(151),l=s(1);class d{constructor(){i()(this,"virtualToNativeRoomIdCache",new Map)}static sharedInstance(){return void 0===window.mxVoipUserMapper&&(window.mxVoipUserMapper=new d),window.mxVoipUserMapper}async userToVirtualUser(e){const t=await c.d.sharedInstance().sipVirtualLookup(e);return 0!==t.length&&t[0].fields.lookup_success?t[0].userid:null}async getOrCreateVirtualRoomForRoom(e){const t=r.a.shared().getUserIdForRoomId(e);if(!t)return null;const s=await this.userToVirtualUser(t);if(!s)return null;const n=await Object(a.d)(o.a.get(),s,e);return o.a.get().setRoomAccountData(n,c.c,{native_room:e}),this.virtualToNativeRoomIdCache.set(n,e),n}nativeRoomForVirtualRoom(e){const t=this.virtualToNativeRoomIdCache.get(e);if(t)return l.a.log("Returning native room ID "+t+" for virtual room ID "+e+" from cache"),t;const s=o.a.get().getRoom(e);if(!s)return null;const n=s.getAccountData(c.c);if(!n||!n.getContent())return null;const i=n.getContent().native_room,a=o.a.get().getRoom(i);return a&&"join"===a.getMyMembership()?i:null}isVirtualRoom(e){if(this.nativeRoomForVirtualRoom(e.roomId))return!0;if(this.virtualToNativeRoomIdCache.has(e.roomId))return!0;const t=e.currentState.getStateEvents("m.room.create","");if(!t||!t.getContent())return!1;if(t.getSender()!==o.a.get().getUserId())return!1;const s=t.getContent()[c.c];return Boolean(s)}async onNewInvitedRoom(e){if(!c.d.sharedInstance().getSupportsVirtualRooms())return;const t=e.getDMInviter();l.a.log(`Checking virtual-ness of room ID ${e.roomId}, invited by ${t}`);const s=await c.d.sharedInstance().sipNativeLookup(t);if(0!==s.length&&s[0].fields.is_virtual){const t=s[0].userid,n=Object(a.e)(o.a.get(),t);n&&(o.a.get().setRoomAccountData(e.roomId,c.c,{native_room:n.roomId}),o.a.get().joinRoom(e.roomId)),this.virtualToNativeRoomIdCache.set(e.roomId,n.roomId)}}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return y})),s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(163),l=s(91),d=s.n(l),h=s(85),u=s(151),m=s(87),p=s(86),g=s(84),v=s(126),f=s(111),b=s(88);const y=e=>"call_"+e;let E=Object(h.a)("views.voip.IncomingCallToast")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"componentDidMount",()=>{u.d.sharedInstance().addListener(u.a.SilencedCallsChanged,this.onSilencedCallsChanged)}),a()(this,"onSilencedCallsChanged",()=>{this.setState({silenced:u.d.sharedInstance().isCallSilenced(this.props.call.callId)})}),a()(this,"onAnswerClick",e=>{e.stopPropagation(),m.a.dispatch({action:"answer",room_id:u.d.sharedInstance().roomIdForCall(this.props.call)})}),a()(this,"onRejectClick",e=>{e.stopPropagation(),m.a.dispatch({action:"reject",room_id:u.d.sharedInstance().roomIdForCall(this.props.call)})}),a()(this,"onSilenceClick",e=>{e.stopPropagation();const t=this.props.call.callId;this.state.silenced?u.d.sharedInstance().unSilenceCall(t):u.d.sharedInstance().silenceCall(t)}),this.state={silenced:u.d.sharedInstance().isCallSilenced(this.props.call.callId)}}componentWillUnmount(){u.d.sharedInstance().removeListener(u.a.SilencedCallsChanged,this.onSilencedCallsChanged)}render(){const e=this.props.call,t=p.a.get().getRoom(u.d.sharedInstance().roomIdForCall(e)),s=e.type===c.f.Voice,n=d()("mx_IncomingCallToast_content",{mx_IncomingCallToast_content_voice:s,mx_IncomingCallToast_content_video:!s}),i=d()("mx_IncomingCallToast_iconButton",{mx_IncomingCallToast_unSilence:this.state.silenced,mx_IncomingCallToast_silence:!this.state.silenced});return r.a.createElement(r.a.Fragment,null,r.a.createElement(v.a,{room:t,height:32,width:32}),r.a.createElement("div",{className:n},r.a.createElement("span",{className:"mx_CallEvent_caller"},t?t.name:Object(g.a)("Unknown caller")),r.a.createElement("div",{className:"mx_CallEvent_type"},r.a.createElement("div",{className:"mx_CallEvent_type_icon"}),s?Object(g.a)("Voice call"):Object(g.a)("Video call")),r.a.createElement("div",{className:"mx_IncomingCallToast_buttons"},r.a.createElement(b.a,{className:"mx_IncomingCallToast_button mx_IncomingCallToast_button_decline",onClick:this.onRejectClick,kind:"danger"},r.a.createElement("span",null," ",Object(g.a)("Decline")," ")),r.a.createElement(b.a,{className:"mx_IncomingCallToast_button mx_IncomingCallToast_button_accept",onClick:this.onAnswerClick,kind:"primary"},r.a.createElement("span",null," ",Object(g.a)("Accept")," ")))),r.a.createElement(f.a,{className:i,onClick:this.onSilenceClick,title:this.state.silenced?Object(g.a)("Sound on"):Object(g.a)("Silence call")}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(141),d=s(86),h=s(93),u=s(739),m=s(85),p=s(89),g=s(176),v=s(97),f=s(109),b=s(101),y=s(96);const E=["org.matrix.msc3215.room.moderation.moderated_by"];var S,_;!function(e){e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other"}(S||(S={})),function(e){e.Admin="non-standard.abuse.nature.admin"}(_||(_={}));let w=Object(m.a)("views.dialogs.ReportEventDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"moderation",void 0),a()(this,"onReasonChange",({target:{value:e}})=>{this.setState({reason:e})}),a()(this,"onNatureChosen",e=>{this.setState({nature:e.currentTarget.value})}),a()(this,"onCancel",()=>{this.props.onFinished(!1)}),a()(this,"onSubmit",async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==S.Other||this.state.nature==_.Admin)&&!e)return void this.setState({err:Object(c.a)("Please fill why you're reporting.")})}else if(!e)return void this.setState({err:Object(c.a)("Please fill why you're reporting.")});this.setState({busy:!0,err:null});try{const e=d.a.get(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!=_.Admin){const s=this.state.nature,n=await Object(l.c)(e,this.moderation.moderationBotUserId);await e.sendEvent(n,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:s,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.props.onFinished(!0)}catch(e){this.setState({busy:!1,err:e.message})}});let t=null,s=null;if(p.b.getValue("feature_report_to_moderators")){const n=d.a.get().getRoom(e.mxEvent.getRoomId());for(const e of E){const i=n.currentState.getStateEvents(e,e);if(!i)continue;if(Array.isArray(i))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const a=i.event;if(!("content"in a)||"object"!=typeof a.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",a);continue}const o=a.content;"room_id"in o&&"string"==typeof o.room_id?"user_id"in o&&"string"==typeof o.user_id?(t=o.room_id,s=o.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",a):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",a)}t&&s&&(this.moderation={moderationRoomId:t,moderationBotUserId:s})}this.state={reason:"",busy:!1,err:null,nature:null}}render(){let e=null;this.state.err&&(e=r.a.createElement("div",{className:"error"},this.state.err));let t=null;this.state.busy&&(t=r.a.createElement("div",{className:"progress"},r.a.createElement(y.a,null)));const s=h.a.get().reportEvent&&h.a.get().reportEvent.adminMessageMD;let n;if(s){const e=new u.a(s).toHTML({externalLinks:!0});n=r.a.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const s=d.a.get(),n=h.a.get().validated_server_config.hsName;let i;switch(this.state.nature){case S.Disagreement:i=Object(c.a)("What this user is writing is wrong.\nThis will be reported to the room moderators.");break;case S.Toxic:i=Object(c.a)("This user is displaying toxic behaviour, for instance by insulting other users or sharing  adult-only content in a family-friendly room  or otherwise violating the rules of this room.\nThis will be reported to the room moderators.");break;case S.Illegal:i=Object(c.a)("This user is displaying illegal behaviour, for instance by doxing people or threatening violence.\nThis will be reported to the room moderators who may escalate this to legal authorities.");break;case S.Spam:i=Object(c.a)("This user is spamming the room with ads, links to ads or to propaganda.\nThis will be reported to the room moderators.");break;case _.Admin:i=s.isRoomEncrypted(this.props.mxEvent.getRoomId())?Object(c.a)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\nThis will be reported to the administrators of %(homeserver)s. The administrators will NOT be able to read the encrypted content of this room.",{homeserver:n}):Object(c.a)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\n This will be reported to the administrators of %(homeserver)s.",{homeserver:n});break;case S.Other:i=Object(c.a)("Any other reason. Please describe the problem.\nThis will be reported to the room moderators.");break;default:i=Object(c.a)("Please pick a nature and describe what makes this message abusive.")}return r.a.createElement(v.a,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(c.a)("Report Content"),contentId:"mx_ReportEventDialog"},r.a.createElement("div",null,r.a.createElement(g.a,{name:"nature",value:S.Disagreement,checked:this.state.nature==S.Disagreement,onChange:this.onNatureChosen},Object(c.a)("Disagree")),r.a.createElement(g.a,{name:"nature",value:S.Toxic,checked:this.state.nature==S.Toxic,onChange:this.onNatureChosen},Object(c.a)("Toxic Behaviour")),r.a.createElement(g.a,{name:"nature",value:S.Illegal,checked:this.state.nature==S.Illegal,onChange:this.onNatureChosen},Object(c.a)("Illegal Content")),r.a.createElement(g.a,{name:"nature",value:S.Spam,checked:this.state.nature==S.Spam,onChange:this.onNatureChosen},Object(c.a)("Spam or propaganda")),r.a.createElement(g.a,{name:"nature",value:_.Admin,checked:this.state.nature==_.Admin,onChange:this.onNatureChosen},Object(c.a)("Report the entire room")),r.a.createElement(g.a,{name:"nature",value:S.Other,checked:this.state.nature==S.Other,onChange:this.onNatureChosen},Object(c.a)("Other")),r.a.createElement("p",null,i),r.a.createElement(b.a,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(c.a)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),t,e),r.a.createElement(f.a,{primaryButton:Object(c.a)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return r.a.createElement(v.a,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(c.a)("Report Content to Your Homeserver Administrator"),contentId:"mx_ReportEventDialog"},r.a.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},r.a.createElement("p",null,Object(c.a)("Reporting this message will send its unique 'event ID' to the administrator of your homeserver. If messages in this room are encrypted, your homeserver administrator will not be able to read the message text or view any files or images.")),n,r.a.createElement(b.a,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(c.a)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),t,e),r.a.createElement(f.a,{primaryButton:Object(c.a)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(1286),o=s(112);const r=["sub","sup","del","u"],c=["text","softbreak","linebreak","paragraph","document"];function l(e){if(null!=e.literal&&null!=e.literal.match('^<((div|span) data-mx-maths="[^"]*"|/(div|span))>$'))return!0;const t=/^<\/?(.*)>$/.exec(e.literal);if(t&&2==t.length){const e=t[1];return r.indexOf(e)>-1}return!1}function d(e){let t=e;for(;t.parent;)t=t.parent;return t.firstChild!=t.lastChild}class h{constructor(e){i()(this,"input",void 0),i()(this,"parsed",void 0),this.input=e;const t=new a.Parser;this.parsed=t.parse(this.input)}isPlainText(){const e=this.parsed.walker();let t;for(;t=e.next();){const e=t.node;if(!(c.indexOf(e.type)>-1)){if("html_inline"!=e.type&&"html_block"!=e.type)return!1;if(l(e))return!1}}return!0}toHTML({externalLinks:e=!1}={}){const t=new a.HtmlRenderer({safe:!1,softbreak:"<br />"}),s=t.paragraph;return t.paragraph=function(e,t){("block_quote"===e.parent.type||d(e))&&s.call(this,e,t)},t.link=function(t,s){const n=this.attrs(t);s?(n.push(["href",this.esc(t.destination)]),t.title&&n.push(["title",this.esc(t.title)]),e&&(n.push(["target","_blank"]),n.push(["rel","noreferrer noopener"])),this.tag("a",n)):this.tag("/a")},t.html_inline=function(e){l(e)?this.lit(e.literal):this.lit(Object(o.escape)(e.literal))},t.html_block=function(e){t.html_inline(e)},t.render(this.parsed)}toPlaintext(){const e=new a.HtmlRenderer({safe:!1});return e.paragraph=function(e,t){d(e)&&!t&&e.next&&this.lit("\n\n")},e.html_block=function(e){this.lit(e.literal),d(e)&&e.next&&this.lit("\n\n")},e.render(this.parsed)}}},,function(e,t,s){"use strict";s.d(t,"c",(function(){return c})),s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return h}));var n=s(169),i=s(86),a=s(250),o=s(196),r=s(1);function c(){const e=new a.a(i.a.get()).getPushRuleById(".m.rule.master");return e?e.enabled&&!e.actions.includes(o.b.Notify):(r.a.warn("No master push rule! Notifications are disabled for this user."),!0)}function l(){let e=s(254);return e.default&&(e=e.default),e}class d extends n.a{getValueOverride(e,t,s,n){return!!l().isPossible()&&(null===s||"default"===n?!c():s)}onChange(e,t,s){l().supportsDesktopNotifications()&&l().setEnabled(s)}}class h extends n.a{getValueOverride(e,t,s){return!!l().isPossible()&&(null===s?!c():s)}}},,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(338),i=s(1516),a=s(1517),o=s(1518),r=s(1);function c(e){if(window.AudioContext)return new AudioContext(e);if(window.webkitAudioContext)return new window.webkitAudioContext(e);throw new Error("Unsupported browser")}function l(e){return new Promise(t=>{r.a.log("Decoder WASM path: "+i.a);const s=new Uint8Array(e),c=new Worker(o.a),l=new Worker(a.a);c.postMessage({command:"init",decoderSampleRate:n.c,outputBufferSampleRate:n.c}),l.postMessage({command:"init",wavBitDepth:24,wavSampleRate:n.c}),c.onmessage=e=>{null!==e.data?l.postMessage({command:"encode",buffers:e.data},e.data.map(e=>e.buffer)):l.postMessage({command:"done"})},l.onmessage=e=>{"page"===e.data.message&&t(new Blob([e.data.page],{type:"audio/wav"}).arrayBuffer())},c.postMessage({command:"decode",pages:s},[s.buffer])})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(116),d=s(508),h=s(203),u=s(233);let m=Object(c.a)("views.audio_messages.PlaybackWaveform")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onWaveformUpdate",e=>{this.setState({heights:this.toHeights(e)})}),a()(this,"onTimeUpdate",e=>{const t=Number(Object(u.c)(e[0],0,e[1]).toFixed(3));this.setState({progress:t})}),this.state={heights:this.toHeights(this.props.playback.waveform),progress:0},this.props.playback.waveformData.onUpdate(this.onWaveformUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}toHeights(e){const t=Object(l.h)(0,h.b);return Object(l.j)(e,h.b,t)}render(){return r.a.createElement(d.a,{relHeights:this.state.heights,progress:this.state.progress})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(506),l=s(85),d=s(161),h=s(753),u=s(108),m=s(84),p=s(754),g=s(507),v=s(509);let f=Object(l.a)("views.audio_messages.AudioPlayer")(n=class extends v.a{constructor(...e){super(...e),a()(this,"playPauseRef",Object(o.createRef)()),a()(this,"seekRef",Object(o.createRef)()),a()(this,"onKeyDown",e=>{var t;if(e.key===u.a.SPACE)e.stopPropagation(),null===(t=this.playPauseRef.current)||void 0===t||t.toggleState();else if(e.key===u.a.ARROW_LEFT){var s;e.stopPropagation(),null===(s=this.seekRef.current)||void 0===s||s.left()}else if(e.key===u.a.ARROW_RIGHT){var n;e.stopPropagation(),null===(n=this.seekRef.current)||void 0===n||n.right()}})}renderFileSize(){const e=this.props.playback.sizeBytes;return e?`(${Object(d.a)(e)})`:null}renderComponent(){return r.a.createElement("div",{className:"mx_MediaBody mx_AudioPlayer_container",tabIndex:0,onKeyDown:this.onKeyDown},r.a.createElement("div",{className:"mx_AudioPlayer_primaryContainer"},r.a.createElement(c.a,{playback:this.props.playback,playbackPhase:this.state.playbackPhase,tabIndex:-1,ref:this.playPauseRef}),r.a.createElement("div",{className:"mx_AudioPlayer_mediaInfo"},r.a.createElement("span",{className:"mx_AudioPlayer_mediaName"},this.props.mediaName||Object(m.a)("Unnamed audio")),r.a.createElement("div",{className:"mx_AudioPlayer_byline"},r.a.createElement(h.a,{playback:this.props.playback}),"  ",this.renderFileSize()))),r.a.createElement("div",{className:"mx_AudioPlayer_seek"},r.a.createElement(p.a,{playback:this.props.playback,tabIndex:-1,playbackPhase:this.state.playbackPhase,ref:this.seekRef}),r.a.createElement(g.a,{playback:this.props.playback,defaultDisplaySeconds:0})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(316);let d=Object(c.a)("views.audio_messages.DurationClock")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onTimeUpdate",e=>{this.setState({durationSeconds:e[1]})}),this.state={durationSeconds:this.props.playback.clockInfo.durationSeconds},this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){return r.a.createElement(l.a,{seconds:this.state.durationSeconds})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i,a,o=s(83),r=s.n(o),c=s(203),l=s(82),d=s.n(l),h=s(85),u=s(317),m=s(233);let p=Object(h.a)("views.audio_messages.SeekBar")((a=i=class extends d.a.PureComponent{constructor(e){super(e),r()(this,"animationFrameFn",new u.a(()=>this.doUpdate(),()=>requestAnimationFrame(()=>this.animationFrameFn.trigger()))),r()(this,"onChange",e=>{this.props.playback.skipTo(Number(e.target.value)*this.props.playback.clockInfo.durationSeconds)}),this.state={percentage:0},this.props.playback.clockInfo.liveData.onUpdate(()=>this.animationFrameFn.mark())}doUpdate(){this.setState({percentage:Object(m.c)(this.props.playback.clockInfo.timeSeconds,0,this.props.playback.clockInfo.durationSeconds)})}left(){this.props.playback.skipTo(this.props.playback.clockInfo.timeSeconds-5)}right(){this.props.playback.skipTo(this.props.playback.clockInfo.timeSeconds+5)}render(){return d.a.createElement("input",{type:"range",className:"mx_SeekBar",tabIndex:this.props.tabIndex,onChange:this.onChange,min:0,max:1,value:this.state.percentage,step:.001,style:{"--fillTo":this.state.percentage},disabled:this.props.playbackPhase===c.d.Decoding})}},r()(i,"defaultProps",{tabIndex:0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return A}));var n,i,a,o=s(83),r=s.n(o),c=s(95),l=s.n(c),d=s(82),h=s.n(d),u=s(117),m=s(84),p=s(87),g=s(92),v=s(105),f=s(167),b=s(118),y=s(511),E=s(155),S=s(85),_=s(377),w=s(479),C=s(86),O=s(597),k=s(756),R=s(91),I=s.n(R),x=s(89),T=s(234),j=s(318),N=s(513),P=s(94);const D=({mxEvent:e,getTile:t,getReplyChain:s,permalinkCreator:n,onFocusChange:i})=>{const[a,o,r,c]=Object(v.p)(),[u,p,g]=Object(E.f)(o);let f;if(Object(d.useEffect)(()=>{i(a)},[i,a]),a){const i=t&&t(),a=s&&s(),r=o.current.getBoundingClientRect();f=h.a.createElement(_.b,l()({},Object(v.j)(r),{mxEvent:e,permalinkCreator:n,eventTileOps:i&&i.getEventTileOps?i.getEventTileOps():void 0,collapseReplyChain:a&&a.canCollapse()?a.collapse:void 0,onFinished:c}))}return h.a.createElement(h.a.Fragment,null,h.a.createElement(v.c,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",title:Object(m.a)("Options"),onClick:r,isExpanded:a,inputRef:g,onFocus:u,tabIndex:p?0:-1}),f)},M=({mxEvent:e,reactions:t,onFocusChange:s})=>{const[n,i,a,o]=Object(v.p)(),[r,c,u]=Object(E.f)(i);let p;if(Object(d.useEffect)(()=>{s(n)},[s,n]),n){const s=i.current.getBoundingClientRect();p=h.a.createElement(v.n,l()({},Object(v.j)(s),{onFinished:o,managed:!1}),h.a.createElement(N.a,{mxEvent:e,reactions:t,onFinished:o}))}return h.a.createElement(h.a.Fragment,null,h.a.createElement(v.c,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton",title:Object(m.a)("React"),onClick:a,isExpanded:n,inputRef:u,onFocus:r,tabIndex:c?0:-1}),p)};let A=Object(S.a)("views.messages.MessageActionBar")((a=i=class extends h.a.PureComponent{constructor(...e){super(...e),r()(this,"onDecrypted",()=>{this.forceUpdate()}),r()(this,"onBeforeRedaction",()=>{this.forceUpdate()}),r()(this,"onSent",()=>{this.forceUpdate()}),r()(this,"onFocusChange",e=>{this.props.onFocusChange&&this.props.onFocusChange(e)}),r()(this,"onReplyClick",e=>{p.a.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})}),r()(this,"onThreadClick",()=>{Object(j.a)(this.props.mxEvent),p.a.dispatch({action:g.a.FocusSendMessageComposer,context:b.a.Thread})}),r()(this,"onEditClick",e=>{p.a.dispatch({action:g.a.EditEvent,event:this.props.mxEvent,timelineRenderingType:this.context.timelineRenderingType})}),r()(this,"forbiddenThreadHeadMsgType",[P.b.KeyVerificationRequest]),r()(this,"onResendClick",e=>{this.runActionOnFailedEv(e=>w.a.resend(e))}),r()(this,"onCancelClick",e=>{this.runActionOnFailedEv(e=>w.a.removeFromQueue(e),e=>Object(_.a)(e.status))})}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==u.a.SENT&&this.props.mxEvent.on("Event.status",this.onSent);C.a.get().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once("Event.decrypted",this.onDecrypted),this.props.mxEvent.on("Event.beforeRedaction",this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off("Event.status",this.onSent),this.props.mxEvent.off("Event.decrypted",this.onDecrypted),this.props.mxEvent.off("Event.beforeRedaction",this.onBeforeRedaction)}get showReplyInThreadAction(){const e=x.b.getValue("feature_thread"),t=this.context.timelineRenderingType!==b.a.Thread,s=!this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype);return e&&t&&s}runActionOnFailedEv(e,t){t||(t=()=>!0);const s=this.props.mxEvent,n=s.replacingEvent(),i=[s.localRedactionEvent(),n,s];for(const s of i)if(s&&t(s)){e(s);break}}render(){const e=[];Object(f.a)(this.props.mxEvent)&&e.push(h.a.createElement(E.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_editButton",title:Object(m.a)("Edit"),onClick:this.onEditClick,key:"edit"}));const t=h.a.createElement(E.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_cancelButton",title:Object(m.a)("Delete"),onClick:this.onCancelClick,key:"cancel"}),s=this.props.mxEvent,n=s.replacingEvent()&&s.replacingEvent().status,i=s.localRedactionEvent()&&s.localRedactionEvent().status,a=Object(_.a)(s.status)||Object(_.a)(n)||Object(_.a)(i),o=[s.status,n,i].includes(u.a.NOT_SENT);if(a&&o)e.splice(0,0,h.a.createElement(E.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_resendButton",title:Object(m.a)("Retry"),onClick:this.onResendClick,key:"resend"})),e.push(t);else{if(Object(f.e)(this.props.mxEvent)&&(this.context.canReply&&e.splice(0,0,h.a.createElement(h.a.Fragment,null,h.a.createElement(E.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton",title:Object(m.a)("Reply"),onClick:this.onReplyClick,key:"reply"}),this.showReplyInThreadAction&&h.a.createElement(E.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_threadButton",title:Object(m.a)("Reply in thread"),onClick:this.onThreadClick,key:"thread"}))),this.context.canReact&&e.splice(0,0,h.a.createElement(M,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"})),O.a.isEligible(this.props.mxEvent)&&e.splice(0,0,h.a.createElement(k.a,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t,s,n;return null===(e=(t=this.props).getTile)||void 0===e||null===(s=(n=e.call(t)).getMediaHelper)||void 0===s?void 0:s.call(n)},key:"download"}))),this.context.timelineRenderingType===b.a.Room&&x.b.getValue("feature_thread")&&this.props.mxEvent.getThread()&&!Object(f.e)(this.props.mxEvent)&&e.unshift(h.a.createElement(E.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_threadButton",title:Object(m.a)("Reply in thread"),onClick:this.onThreadClick,key:"thread"})),a&&e.push(t),void 0!==this.props.isQuoteExpanded&&T.a.hasReply(this.props.mxEvent)){const t=I()({mx_MessageActionBar_maskButton:!0,mx_MessageActionBar_expandMessageButton:!this.props.isQuoteExpanded,mx_MessageActionBar_collapseMessageButton:this.props.isQuoteExpanded});e.push(h.a.createElement(E.b,{className:t,title:this.props.isQuoteExpanded?Object(m.a)("Collapse quotes │ ⇧+click"):Object(m.a)("Expand quotes │ ⇧+click"),onClick:this.props.toggleThreadExpanded,key:"expand"}))}e.push(h.a.createElement(D,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu"}))}return h.a.createElement(y.a,{className:"mx_MessageActionBar","aria-label":Object(m.a)("Message Actions"),"aria-live":"off"},e)}},r()(i,"contextType",b.b),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(155),l=s(96),d=s(91),h=s.n(d),u=s(84),m=s(85),p=s(714);let g=Object(m.a)("views.messages.DownloadActionButton")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"downloader",new p.a),a()(this,"onDownloadClick",async()=>{if(this.state.loading)return;if(this.props.mediaEventHelperGet().media.isEncrypted&&this.setState({tooltip:Object(u.b)("Decrypting")}),this.setState({loading:!0}),this.state.blob)return this.doDownload();const e=await this.props.mediaEventHelperGet().sourceBlob.value;this.setState({blob:e}),await this.doDownload()}),this.state={loading:!1,tooltip:Object(u.b)("Downloading")}}async doDownload(){await this.downloader.download({blob:this.state.blob,name:this.props.mediaEventHelperGet().fileName}),this.setState({loading:!1})}render(){let e;this.state.loading&&(e=r.a.createElement(l.a,{w:18,h:18}));const t=h()({mx_MessageActionBar_maskButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:!!e});return r.a.createElement(c.b,{className:t,title:e?Object(u.a)(this.state.tooltip):Object(u.a)("Download"),onClick:this.onDownloadClick,disabled:!!e},e)}})||n},function(e,t,s){"use strict";var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(84),h=s(108),u=s(85);let m=Object(u.a)("views.emojipicker.Header")(n=class extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"onKeyDown",e=>{let t=!0;switch(e.key){case h.a.ARROW_LEFT:this.changeCategoryRelative(-1);break;case h.a.ARROW_RIGHT:this.changeCategoryRelative(1);break;case h.a.HOME:this.changeCategoryAbsolute(0);break;case h.a.END:this.changeCategoryAbsolute(this.props.categories.length-1,-1);break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})}findNearestEnabled(e,t){e+=this.props.categories.length;const s=[...this.props.categories,...this.props.categories,...this.props.categories];for(;e<s.length&&e>=0;){if(s[e].enabled)return e%this.props.categories.length;e+=t>0?1:-1}}changeCategoryRelative(e){const t=this.props.categories.findIndex(e=>e.visible);this.changeCategoryAbsolute(t+e,e)}changeCategoryAbsolute(e,t=1){const s=this.props.categories[this.findNearestEnabled(e,t)];s&&(this.props.onAnchorClick(s.id),s.ref.current.focus())}render(){return r.a.createElement("nav",{className:"mx_EmojiPicker_header",role:"tablist","aria-label":Object(d.a)("Categories"),onKeyDown:this.onKeyDown},this.props.categories.map(e=>{const t=l()("mx_EmojiPicker_anchor mx_EmojiPicker_anchor_"+e.id,{mx_EmojiPicker_anchor_visible:e.visible});return r.a.createElement("button",{disabled:!e.enabled,key:e.id,ref:e.ref,className:t,onClick:()=>this.props.onAnchorClick(e.id),title:e.name,role:"tab",tabIndex:e.visible?0:-1,"aria-selected":e.visible,"aria-controls":"mx_EmojiPicker_category_"+e.id})}))}})||n;t.a=m},function(e,t,s){"use strict";var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(108),d=s(85);let h=Object(d.a)("views.emojipicker.Search")(n=class extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"inputRef",r.a.createRef()),a()(this,"onKeyDown",e=>{e.key===l.a.ENTER&&(this.props.onEnter(),e.stopPropagation(),e.preventDefault())})}componentDidMount(){setTimeout(()=>this.inputRef.current.focus(),0)}render(){let e;return e=this.props.query?r.a.createElement("button",{onClick:()=>this.props.onChange(""),className:"mx_EmojiPicker_search_icon mx_EmojiPicker_search_clear",title:Object(c.a)("Cancel search")}):r.a.createElement("span",{className:"mx_EmojiPicker_search_icon"}),r.a.createElement("div",{className:"mx_EmojiPicker_search"},r.a.createElement("input",{autoFocus:!0,type:"text",placeholder:"Search",value:this.props.query,onChange:e=>this.props.onChange(e.target.value),onKeyDown:this.onKeyDown,ref:this.inputRef}),e)}})||n;t.a=h},function(e,t,s){"use strict";var n,i=s(82),a=s.n(i),o=s(85);let r=Object(o.a)("views.emojipicker.Preview")(n=class extends a.a.PureComponent{render(){const{unicode:e,annotation:t,shortcodes:[s]}=this.props.emoji;return a.a.createElement("div",{className:"mx_EmojiPicker_footer mx_EmojiPicker_preview"},a.a.createElement("div",{className:"mx_EmojiPicker_preview_emoji"},e),a.a.createElement("div",{className:"mx_EmojiPicker_preview_text"},a.a.createElement("div",{className:"mx_EmojiPicker_name mx_EmojiPicker_preview_name"},t),a.a.createElement("div",{className:"mx_EmojiPicker_shortcode"},s)))}})||n;t.a=r},function(e,t,s){"use strict";var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(305),d=s(514),h=s(85);const u=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map(e=>{const t=Object(l.d)(e);if(!t)throw new Error(`Emoji ${e} doesn't exist in emojibase`);return t});let m=Object(h.a)("views.emojipicker.QuickReactions")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onMouseEnter",e=>{this.setState({hover:e})}),a()(this,"onMouseLeave",()=>{this.setState({hover:null})}),this.state={hover:null}}render(){return r.a.createElement("section",{className:"mx_EmojiPicker_footer mx_EmojiPicker_quick mx_EmojiPicker_category"},r.a.createElement("h2",{className:"mx_EmojiPicker_quick_header mx_EmojiPicker_category_label"},this.state.hover?r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_EmojiPicker_name"},this.state.hover.annotation),r.a.createElement("span",{className:"mx_EmojiPicker_shortcode"},this.state.hover.shortcodes[0])):Object(c.a)("Quick Reactions")),r.a.createElement("ul",{className:"mx_EmojiPicker_list","aria-label":Object(c.a)("Quick Reactions")},u.map(e=>r.a.createElement(d.a,{key:e.hexcode,emoji:e,onClick:this.props.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,selectedEmojis:this.props.selectedEmojis}))))}})||n;t.a=m},function(e,t,s){"use strict";var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(418),l=s(762),d=s(514),h=s(85);let u=Object(h.a)("views.emojipicker.Category")(n=class extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"renderEmojiRow",e=>{const{onClick:t,onMouseEnter:s,onMouseLeave:n,selectedEmojis:i,emojis:a}=this.props,o=a.slice(8*e,8*(e+1));return r.a.createElement("div",{key:e},o.map(e=>r.a.createElement(d.a,{key:e.hexcode,emoji:e,selectedEmojis:i,onClick:t,onMouseEnter:s,onMouseLeave:n})))})}render(){const{emojis:e,name:t,heightBefore:s,viewportHeight:n,scrollTop:i}=this.props;if(!e||0===e.length)return null;const a=new Array(Math.ceil(e.length/c.b));for(let e=0;e<a.length;++e)a[e]=e;const o=i,d=o+n,h=s+c.a,u=h+a.length*c.c,m=Math.max(o,h),p=Math.min(d,u),g=Math.max(0,p-m),v=Math.max(0,i-h);return r.a.createElement("section",{id:"mx_EmojiPicker_category_"+this.props.id,className:"mx_EmojiPicker_category","data-category-id":this.props.id,role:"tabpanel","aria-label":t},r.a.createElement("h2",{className:"mx_EmojiPicker_category_label"},t),r.a.createElement(l.a,{element:"ul",className:"mx_EmojiPicker_list",itemHeight:c.c,items:a,scrollTop:v,height:g,overflowItems:3,overflowMargin:0,renderItem:this.renderEmojiRow}))}})||n;t.a=u},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(85);class h{constructor(e,t,s){this.topCount=e,this.renderCount=t,this.bottomCount=s}contains(e){return!(!e.renderCount&&this.renderCount)&&(e.topCount>=this.topCount&&e.topCount+e.renderCount<=this.topCount+this.renderCount)}expand(e){if(0===this.renderCount)return this;const t=Math.min(e,this.topCount),s=Math.min(e,this.bottomCount);return new h(this.topCount-t,this.renderCount+t+s,this.bottomCount-s)}totalSize(){return this.topCount+this.renderCount+this.bottomCount}}let u=Object(d.a)("views.elements.LazyRenderList")((a=i=class e extends l.a.Component{constructor(e){super(e),this.state={renderRange:null}}static getDerivedStateFromProps(t,s){const n=e.getVisibleRangeFromProps(t),i=n.expand(t.overflowMargin),a=n.expand(t.overflowItems);return!(!!s.renderRange&&a.totalSize()!==s.renderRange.totalSize())&&s.renderRange&&s.renderRange.contains(i)?null:{renderRange:a}}static getVisibleRangeFromProps(e){const{items:t,itemHeight:s,scrollTop:n,height:i}=e,a=t?t.length:0,o=Math.min(Math.max(0,Math.floor(n/s)),a),r=a-o,c=0!==i?Math.ceil(i/s):0,l=Math.min(c,r);return new h(o,l,r-l)}render(){const{itemHeight:e,items:t,renderItem:s}=this.props,{renderRange:n}=this.state,{topCount:i,renderCount:a,bottomCount:o}=n,r=i*e,c=o*e,d=(t||[]).slice(i,i+a),h=this.props.element||"div",u={style:{paddingTop:r+"px",paddingBottom:c+"px"},className:this.props.className};return l.a.createElement(h,u,d.map(s))}},r()(i,"defaultProps",{overflowItems:20,overflowMargin:5}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i,a,o=s(83),r=s.n(o),c=s(95),l=s.n(c),d=s(82),h=s.n(d),u=s(91),m=s.n(u),p=s(94),g=s(84),v=s(167),f=s(85),b=s(291),y=s(105),E=s(513),S=s(764),_=s(98);const w=({mxEvent:e,reactions:t})=>{const[s,n,i,a]=Object(y.p)();let o;if(s){const s=n.current.getBoundingClientRect();o=h.a.createElement(y.n,l()({},Object(y.j)(s),{onFinished:a,managed:!1}),h.a.createElement(E.a,{mxEvent:e,reactions:t,onFinished:a}))}return h.a.createElement(h.a.Fragment,null,h.a.createElement(b.a,{className:m()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:s}),title:Object(g.a)("Add reaction"),onClick:i,onContextMenu:e=>{e.preventDefault(),i()},isExpanded:s,inputRef:n}),o)};let C=Object(f.a)("views.messages.ReactionsRow")((a=i=class extends h.a.PureComponent{constructor(e,t){super(e,t),r()(this,"onDecrypted",()=>{this.forceUpdate()}),r()(this,"onReactionsChange",()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()}),r()(this,"onShowAllClick",()=>{this.setState({showAll:!0})}),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once("Event.decrypted",this.onDecrypted),t&&(t.on("Relations.add",this.onReactionsChange),t.on("Relations.remove",this.onReactionsChange),t.on("Relations.redaction",this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off("Event.decrypted",this.onDecrypted),t&&(t.off("Relations.add",this.onReactionsChange),t.off("Relations.remove",this.onReactionsChange),t.off("Relations.redaction",this.onReactionsChange))}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange),this.onReactionsChange())}getMyReactions(){const e=this.props.reactions;if(!e)return null;const t=this.context.getUserId(),s=e.getAnnotationsBySender()[t];return s?[...s.values()]:null}render(){const{mxEvent:e,reactions:t}=this.props,{myReactions:s,showAll:n}=this.state;if(!t||!Object(v.e)(e))return null;let i,a=t.getSortedAnnotationsByKey().map(([t,n])=>{const i=n.size;if(!i)return null;const a=s&&s.find(e=>!e.isRedacted()&&e.getRelation().key===t);return h.a.createElement(S.a,{key:t,content:t,count:i,mxEvent:e,reactionEvents:n,myReactionEvent:a})}).filter(e=>!!e);if(!a.length)return null;a.length>9&&!n&&(a=a.slice(0,8),i=h.a.createElement("a",{className:"mx_ReactionsRow_showAll",href:"#",onClick:this.onShowAllClick},Object(g.a)("Show all")));const o=this.context;let r;const c=o.getRoom(e.getRoomId());return"join"===c.getMyMembership()&&c.currentState.maySendEvent(p.a.Reaction,o.getUserId())&&(r=h.a.createElement(w,{mxEvent:e,reactions:t})),h.a.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":Object(g.a)("Reactions")},a,i,r)}},r()(i,"contextType",_.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(84),m=s(161),p=s(87),g=s(85),v=s(765),f=s(88),b=s(98);let y=Object(g.a)("views.messages.ReactionsRowButton")((a=i=class extends l.a.PureComponent{constructor(...e){super(...e),r()(this,"state",{tooltipRendered:!1,tooltipVisible:!1}),r()(this,"onClick",()=>{const{mxEvent:e,myReactionEvent:t,content:s}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:e.getId(),key:s}}),p.a.dispatch({action:"message_sent"}))}),r()(this,"onMouseOver",()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})}),r()(this,"onMouseLeave",()=>{this.setState({tooltipVisible:!1})})}render(){const{mxEvent:e,content:t,count:s,reactionEvents:n,myReactionEvent:i}=this.props,a=h()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!i});let o;this.state.tooltipRendered&&(o=l.a.createElement(v.a,{mxEvent:this.props.mxEvent,content:t,reactionEvents:n,visible:this.state.tooltipVisible}));const r=this.context.getRoom(e.getRoomId());let c;if(r){const e=[];for(const t of n){const s=r.getMember(t.getSender());e.push((null==s?void 0:s.name)||t.getSender())}const s=Object(m.b)(e,6);c=t?Object(u.a)("%(reactors)s reacted with %(content)s",{reactors:s,content:t}):s}const d="join"!==r.getMyMembership();return l.a.createElement(f.a,{className:a,"aria-label":c,onClick:this.onClick,disabled:d,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},l.a.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t),l.a.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},s),o)}},r()(i,"contextType",b.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(138),h=s(84),u=s(161),m=s(85),p=s(150),g=s(98);let v=Object(m.a)("views.messages.ReactionsRowButtonTooltip")((a=i=class extends l.a.PureComponent{render(){const{content:e,reactionEvents:t,mxEvent:s,visible:n}=this.props,i=this.context.getRoom(s.getRoomId());let a,o;if(i){const s=[];for(const e of t){const t=i.getMember(e.getSender()),n=t?t.name:e.getSender();s.push(n)}const n=Object(d.i)(e);a=l.a.createElement("div",null,Object(h.a)("<reactors/><reactedWith>reacted with %(shortName)s</reactedWith>",{shortName:n},{reactors:()=>l.a.createElement("div",{className:"mx_Tooltip_title"},Object(u.b)(s,6)),reactedWith:e=>n?l.a.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return a&&(o=l.a.createElement(p.b,{visible:n,label:a})),o}},r()(i,"contextType",g.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(86),h=s(84),u=s(515),m=s(241),p=s(85),g=s(94);let v=Object(p.a)("views.messages.MKeyVerificationConclusion")(n=class e extends r.a.Component{constructor(e){super(e),a()(this,"onRequestChanged",()=>{this.forceUpdate()}),a()(this,"onTrustChanged",e=>{const{mxEvent:t}=this.props,s=t.verificationRequest;s&&s.otherUserId===e&&this.forceUpdate()})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this.onRequestChanged),d.a.get().on("userTrustStatusChanged",this.onTrustChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this.onRequestChanged);const t=d.a.get();t&&t.removeListener("userTrustStatusChanged",this.onTrustChanged)}static shouldRender(e,t){return!!t&&(!(e.getType()===g.a.KeyVerificationCancel&&!t.cancelled)&&(!(e.getType()===g.a.KeyVerificationDone&&!t.done)&&(!t.pending&&!!d.a.get().checkUserTrust(t.otherUserId).isCrossSigningVerified())))}render(){const{mxEvent:t}=this.props,s=t.verificationRequest;if(!e.shouldRender(t,s))return null;const n=d.a.get().getUserId();let i;if(s.done)i=Object(h.a)("You verified %(name)s",{name:Object(u.a)(s.otherUserId,t.getRoomId())});else if(s.cancelled){const e=s.cancellingUserId;i=e===n?Object(h.a)("You cancelled verifying %(name)s",{name:Object(u.a)(s.otherUserId,t.getRoomId())}):Object(h.a)("%(name)s cancelled verifying",{name:Object(u.a)(e,t.getRoomId())})}if(i){const e=l()("mx_cryptoEvent mx_cryptoEvent_icon",{mx_cryptoEvent_icon_verified:s.done});return r.a.createElement(m.a,{className:e,title:i,subtitle:Object(u.b)(s.otherUserId,t.getRoomId())})}return null}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(298),o=s(5),r=s(4),c=s(112);class l extends o.EventEmitter{constructor(){super(),i()(this,"_search",""),i()(this,"callUpdate",Object(c.throttle)(()=>{this.emit(a.a)},200,{trailing:!0,leading:!0}))}get kind(){return a.b.Runtime}get search(){return this._search}set search(e){this._search=e,this.callUpdate()}isVisible(e){const t=this.search.toLowerCase();if("#"===this.search[0]){if(e.getCanonicalAlias()&&e.getCanonicalAlias().toLowerCase().startsWith(t))return!0;if(e.getAltAliases().some(e=>e.toLowerCase().startsWith(t)))return!0}return!!e.name&&this.matches(e.normalizedName)}matches(e){return e.includes(Object(r.z)(this.search))}}},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(132),o=s(1);class r{constructor(){i()(this,"listeners",{}),i()(this,"_activeRoomId",a.a.getRoomId()),i()(this,"roomStoreToken",void 0),i()(this,"onRoomViewStoreUpdate",()=>{this._activeRoomId&&this.emit(this._activeRoomId,!1),this._activeRoomId=a.a.getRoomId(),this._activeRoomId&&this.emit(this._activeRoomId,!0)}),this.roomStoreToken=a.a.addListener(this.onRoomViewStoreUpdate)}get activeRoomId(){return this._activeRoomId}addListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeListener(e,t){if(this.listeners[e]){const s=this.listeners[e].indexOf(t);s>-1&&this.listeners[e].splice(s,1)}else o.a.warn("Unregistering unrecognised listener (roomId="+e+")")}emit(e,t){if(this.listeners[e])for(const s of this.listeners[e])s.call(null,t)}}void 0===window.mxActiveRoomObserver&&(window.mxActiveRoomObserver=new r),t.a=window.mxActiveRoomObserver},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(457),i=s(90),a=s(180),o=s(84),r=s(165),c=s(257),l=s(147),d=s(104),h=s(1);class u{static tagRoom(e,t,s,u,m,p){let g=null;const v=r.b.instance;if(u&&v.getTagSorting(u)===c.b.Manual){const e=[...v.orderedLists[u]];e.sort((e,t)=>e.tags[u].order-t.tags[u].order);const t=u===s&&m<p?1:0,n=t+p-1,i=t+p,a=n<=0?0:e[n].tags[u].order,o=i>=e.length?1:e[i].tags[u].order;g={order:(a+o)/2}}return Object(n.a)("RoomListActions.tagRoom",()=>{const n=[],r=t.roomId;if(void 0===s&&u===l.a.DM||s===l.a.DM&&void 0===u)return a.d(t,u===l.a.DM).catch(e=>{h.a.error("Failed to set direct chat tag "+e),i.a.createTrackedDialog("Failed to set direct chat tag","",d.a,{title:Object(o.a)("Failed to set direct chat tag"),description:e&&e.message?e.message:Object(o.a)("Operation failed")})});const c=s!==u;if(s&&s!==l.a.DM&&c){const t=e.deleteRoomTag(r,s).catch((function(e){h.a.error("Failed to remove tag "+s+" from room: "+e),i.a.createTrackedDialog("Failed to remove tag from room","",d.a,{title:Object(o.a)("Failed to remove tag %(tagName)s from room",{tagName:s}),description:e&&e.message?e.message:Object(o.a)("Operation failed")})}));n.push(t)}if(u&&u!==l.a.DM&&(c||g)){g=g||{};const t=e.setRoomTag(r,u,g).catch((function(e){throw h.a.error("Failed to add tag "+u+" to room: "+e),i.a.createTrackedDialog("Failed to add tag to room","",d.a,{title:Object(o.a)("Failed to add tag %(tagName)s to room",{tagName:u}),description:e&&e.message?e.message:Object(o.a)("Operation failed")}),e}));n.push(t)}return Promise.all(n)},()=>({room:t,oldTag:s,newTag:u,metaData:g}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(83),i=s.n(n),a=s(771),o=s(774),r=s(164),c=s(87),l=s(775),d=s(776),h=s(777);const u=e=>"room-"+e.roomId;class m extends r.a{constructor(){super(c.a),i()(this,"caches",new Map)}static get instance(){return m._instance||(m._instance=new m),m._instance}get contexts(){return Array.from(this.caches.values()).map(e=>e.context)}getOrCreateChamberForRoom(e){if(this.caches.has(u(e)))return this.caches.get(u(e));const t=new o.a(e);t.whenAnything(()=>this.checkContexts());const s=new a.b(t);return s.setClient(this.matrixClient),this.caches.set(u(e),s),s}async checkContexts(){let e=!1;for(const t of this.caches.values())if(e=t.context.state===l.a.PendingErrors,e)break;if(e&&!this.state.toastRef){const e=d.a.instance.addToast(h.a);await this.updateState({toastRef:e})}else!e&&this.state.toastRef&&(d.a.instance.removeToast(this.state.toastRef),await this.updateState({toastRef:null}))}async onReady(){if(this.caches)for(const e of this.caches.values())e.setClient(this.matrixClient)}async onNotReady(){for(const e of this.caches.values())e.setClient(null)}async onAction(e){return Promise.resolve()}}i()(m,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(83),i=s.n(n),a=s(772),o=s(258),r=s(84),c=s(94);let l;!function(e){e[e.NotificationVolume=0]="NotificationVolume"}(l||(l={}));class d extends a.a{constructor(e){super(e,e=>this.properties.get(e)),i()(this,"properties",new Map),i()(this,"onAccountData",e=>{if(e.getType()===c.a.PushRules){this.properties.get(l.NotificationVolume)!==Object(o.c)(this.context.room.roomId)&&this.updateNotificationVolume()}})}onClientChanged(e,t){this.properties.clear(),e&&e.removeListener("accountData",this.onAccountData),t&&(t.on("accountData",this.onAccountData),this.updateNotificationVolume())}updateNotificationVolume(){this.properties.set(l.NotificationVolume,Object(o.c)(this.context.room.roomId)),this.markEchoReceived(l.NotificationVolume),this.emit(a.b,l.NotificationVolume)}get notificationVolume(){return this.getValue(l.NotificationVolume)}set notificationVolume(e){this.setValue(Object(r.a)("Change notification settings"),l.NotificationVolume,e,async()=>Object(o.e)(this.context.room.roomId,e),a.c)}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(521),o=s(5);async function r(){}const c="property_updated";class l extends o.EventEmitter{constructor(e,t){super(),this.context=e,this.lookupFn=t,i()(this,"cache",new Map),i()(this,"matrixClient",void 0)}setClient(e){const t=this.matrixClient;this.matrixClient=e,this.onClientChanged(t,e)}getValue(e){return this.cache.has(e)?this.cache.get(e).val:this.lookupFn(e)}cacheVal(e,t,s){this.cache.set(e,{txn:s,val:t}),this.emit(c,e)}decacheKey(e){this.cache.has(e)&&(this.context.disownTransaction(this.cache.get(e).txn),this.cache.delete(e),this.emit(c,e))}markEchoReceived(e){if(this.cache.has(e)){const t=this.cache.get(e).txn;this.context.disownTransaction(t),t.cancel()}this.decacheKey(e)}setValue(e,t,s,n,i){this.cache.has(t)&&this.cache.get(t).txn.cancel();const o=this.context.beginTransaction(e,n);this.cacheVal(t,s,o),o.when(a.b.Pending,()=>this.cacheVal(t,s,o)).when(a.b.Error,()=>i()),o.run()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(116),o=s(1);class r{constructor(){i()(this,"listeners",[])}when(e,t){return this.listeners.push({condition:e,fn:t}),this}whenAnyOf(e,t){for(const s of e)this.when(s,t);return this}whenAnything(e){return this.listeners.push({condition:null,fn:e}),this}notifyCondition(e){const t=Object(a.b)(this.listeners);for(const s of t)if(null===s.condition||s.condition===e)try{s.fn(this)}catch(t){o.a.error(`Error calling whenable listener for ${e}:`,t)}}destroy(){this.listeners=[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(775);class i extends n.b{constructor(e){super(),this.room=e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(83),i=s.n(n),a=s(521),o=s(116),r=s(773);let c;!function(e){e[e.NotStarted=0]="NotStarted",e[e.PendingErrors=1]="PendingErrors",e[e.AllSuccessful=2]="AllSuccessful"}(c||(c={}));class l extends r.a{constructor(...e){super(...e),i()(this,"_transactions",[]),i()(this,"_state",c.NotStarted),i()(this,"checkTransactions",()=>{let e=c.AllSuccessful;for(const t of this.transactions){if(t.status===a.b.Error||t.didPreviouslyFail){e=c.PendingErrors;break}t.status===a.b.Pending&&(e=c.NotStarted)}this._state=e,this.notifyCondition(e)})}get transactions(){return Object(o.b)(this._transactions)}get state(){return this._state}get firstFailedTime(){const e=this.transactions.find(e=>e.didPreviouslyFail||e.status===a.b.Error);return e?e.startTime:null}disownTransaction(e){const t=this._transactions.indexOf(e);t>=0&&this._transactions.splice(t,1),e.destroy(),this.checkTransactions()}beginTransaction(e,t){const s=new a.a(e,t);return this._transactions.push(s),s.whenAnything(this.checkTransactions),s.when(a.b.Success,()=>s.destroy()),s}destroy(){for(const e of this.transactions)e.destroy();this._transactions=[],super.destroy()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a),r=s(123);class c extends o.a{constructor(...e){super(...e),i()(this,"toasts",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}get components(){return Array.from(this.toasts.values())}addToast(e){const t=Symbol();return this.toasts.set(t,e),this.emit(r.b),t}removeToast(e){this.toasts.delete(e),this.emit(r.b)}}i()(c,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(88),d=s(90),h=s(778),u=s(85);let m=Object(u.a)("views.toasts.NonUrgentEchoFailureToast")(n=class extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"openDialog",()=>{d.a.createTrackedDialog("Local Echo Server Error","",h.a,{})})}render(){return r.a.createElement("div",{className:"mx_NonUrgentEchoFailureToast"},r.a.createElement("span",{className:"mx_NonUrgentEchoFailureToast_icon"}),Object(c.a)("Your server isn't responding to some <a>requests</a>.",{},{a:e=>r.a.createElement(l.a,{kind:"link",onClick:this.openDialog},e)}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s(97),c=s(84),l=s(770),d=s(136),h=s(89),u=s(774),m=s(126),p=s(521),g=s(96),v=s(88),f=s(123),b=s(86),y=s(85);let E=Object(y.a)("views.dialogs.ServerOfflineDialog")(n=class extends o.PureComponent{constructor(...e){super(...e),a()(this,"onEchosUpdated",()=>{this.forceUpdate()})}componentDidMount(){l.a.instance.on(f.b,this.onEchosUpdated)}componentWillUnmount(){l.a.instance.off(f.b,this.onEchosUpdated)}renderTimeline(){return l.a.instance.contexts.map((e,t)=>{if(!e.firstFailedTime)return null;if(!(e instanceof u.a))throw new Error("Cannot render unknown context: "+e);const s=o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline_header"},o.createElement(m.a,{width:24,height:24,room:e.room}),o.createElement("span",null,e.room.name)),n=e.transactions.filter(e=>e.status===p.b.Error||e.didPreviouslyFail).map((e,t)=>{let s=o.createElement(g.a,{w:19,h:19});return e.status===p.b.Error&&(s=o.createElement(v.a,{kind:"link",onClick:()=>e.run()},Object(c.a)("Resend"))),o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_txn",key:"txn-"+t},o.createElement("span",{className:"mx_ServerOfflineDialog_content_context_txn_desc"},e.auditName),s)});return o.createElement("div",{className:"mx_ServerOfflineDialog_content_context",key:"context-"+t},o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timestamp"},Object(d.j)(e.firstFailedTime,h.b.getValue("showTwelveHourTimestamps"))),o.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline"},s,n))})}render(){let e=this.renderTimeline().filter(e=>!!e);0===e.length&&(e=[o.createElement("div",{key:1},Object(c.a)("You're all caught up."))]);const t=b.a.getHomeserverName();return o.createElement(r.a,{title:Object(c.a)("Server isn't responding"),className:"mx_ServerOfflineDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished,hasCancel:!0},o.createElement("div",{className:"mx_ServerOfflineDialog_content"},o.createElement("p",null,Object(c.a)("Your server isn't responding to some of your requests. Below are some of the most likely reasons.")),o.createElement("ul",null,o.createElement("li",null,Object(c.a)("The server (%(serverName)s) took too long to respond.",{serverName:t})),o.createElement("li",null,Object(c.a)("Your firewall or anti-virus is blocking the request.")),o.createElement("li",null,Object(c.a)("A browser extension is preventing the request.")),o.createElement("li",null,Object(c.a)("The server is offline.")),o.createElement("li",null,Object(c.a)("The server has denied your request.")),o.createElement("li",null,Object(c.a)("Your area is experiencing difficulties connecting to the internet.")),o.createElement("li",null,Object(c.a)("A connection error occurred while trying to contact the server.")),o.createElement("li",null,Object(c.a)("The server is not configured to indicate what the problem is (CORS)."))),o.createElement("hr",null),o.createElement("h2",null,Object(c.a)("Recent changes that have not yet been received")),e))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(155),d=s(192);class h extends o.a.Component{constructor(e){super(e),i()(this,"onTileMouseEnter",()=>{this.setState({hover:!0})}),i()(this,"onTileMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){var e;const t=c()({mx_ExtraTile:!0,mx_RoomTile:!0,mx_RoomTile_selected:this.props.isSelected,mx_RoomTile_minimized:this.props.isMinimized});let s;this.props.notificationState&&(s=o.a.createElement(d.a,{notification:this.props.notificationState,forceCount:!1}));let n=this.props.displayName;"string"!=typeof n&&(n=""),n=n.replace(":",":​");const i=c()({mx_RoomTile_name:!0,mx_RoomTile_nameHasUnreadEvents:null===(e=this.props.notificationState)||void 0===e?void 0:e.isUnread});let a=o.a.createElement("div",{className:"mx_RoomTile_nameContainer"},o.a.createElement("div",{title:n,className:i,tabIndex:-1,dir:"auto"},n));this.props.isMinimized&&(a=null);let r=l.a;return this.props.isMinimized&&(r=l.b),o.a.createElement(o.a.Fragment,null,o.a.createElement(r,{className:t,onMouseEnter:this.onTileMouseEnter,onMouseLeave:this.onTileMouseLeave,onClick:this.props.onClick,role:"treeitem",title:this.props.isMinimized?n:void 0},o.a.createElement("div",{className:"mx_RoomTile_avatarContainer"},this.props.avatar),a,o.a.createElement("div",{className:"mx_RoomTile_badgeContainer"},s)))}}},function(e,t,s){"use strict";(function(e){var n=s(83),i=s.n(n),a=s(87),o=s(5),r=s.n(o),c=s(112),l=s(89),d=s(165),h=s(173),u=s(147),m=s(144);function p(e,t){const s=Math.min(e.length,t.length);let n;for(let i=0;i<s;++i)if(e.charAt(i)!==t.charAt(i)){n=e.substr(0,i);break}void 0===n&&(n=e.substr(0,s));const i=n.indexOf(" ");return-1!==i&&(n=n.substr(0,i+1)),n.length>=2?n:""}class g extends r.a{constructor(){super(),i()(this,"_onListsUpdated",()=>{const e=this._getUpdatedTags();this._state.tags&&!Object(m.d)(this._state.tags,e)||this._setState({tags:e})}),this._state={tags:{}},this._getUpdatedTags=Object(c.throttle)(this._getUpdatedTags,500,{leading:!0,trailing:!0}),d.b.instance.on(d.a,this._onListsUpdated),a.a.register(e=>this._onDispatch(e))}getTags(){return this._state.tags}_setState(e){this._state=Object.assign(this._state,e),this.emit("change")}addListener(e){return this.on("change",e),{remove:()=>{this.removeListener("change",e)}}}getSortedTags(){const e=Object.keys(this._state.tags).sort(),t=e.map((t,s)=>{const n=0===s,i=s===e.length-1,a=n?"":p(t,e[s-1]),o=i?"":p(t,e[s+1]);return a.length>o.length?a:o});return e.map((e,s)=>{const n=h.a.instance.getListState(e);let i;n.hasUnreadCount&&(i=n);const a=e.substr(t[s].length,1);return{name:e,avatarLetter:a,badgeNotifState:i,selected:this._state.tags[e]}})}_onDispatch(e){switch(e.action){case"select_custom_room_tag":{const t=this._state.tags;if(t.hasOwnProperty(e.tag)){const s={};s[e.tag]=!t[e.tag];const n=Object.assign({},t,s);this._setState({tags:n})}break}case"on_client_not_viable":case"on_logged_out":this._state={tags:{}},d.b.instance.off(d.a,this._onListsUpdated)}}_getUpdatedTags(){if(!l.b.getValue("feature_custom_tags"))return{};const e=Object.keys(d.b.instance.orderedLists).filter(e=>Object(u.d)(e)).sort(),t=this._state&&this._state.tags;return e.reduce((e,s)=>(e[s]=t&&t[s]||!1,e),{})}}void 0===e.singletonCustomRoomTagStore&&(e.singletonCustomRoomTagStore=new g),t.a=e.singletonCustomRoomTagStore}).call(this,s(26))},function(e,t,s){"use strict";var n=s(102),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(97),l=s(87),d=s(321),h=s(253),u=s(782),m=s(783),p=s(89),g=s(115),v=s(535),f=s(537);const b=["action"];let y;!function(e){e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.Advanced="SPACE_ADVANCED_TAB"}(y||(y={}));t.a=({matrixClient:e,space:t,onFinished:s})=>{Object(d.a)(l.a,e=>{let{action:n}=e,a=i()(e,b);"after_leave_room"===n&&a.room_id===t.roomId&&s(!1)});const n=Object(a.useMemo)(()=>[new h.a(y.General,Object(r.b)("General"),"mx_SpaceSettingsDialog_generalIcon",o.a.createElement(u.a,{matrixClient:e,space:t,onFinished:s})),new h.a(y.Visibility,Object(r.b)("Visibility"),"mx_SpaceSettingsDialog_visibilityIcon",o.a.createElement(m.a,{matrixClient:e,space:t,closeSettingsFn:s})),new h.a(y.Roles,Object(r.b)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",o.a.createElement(f.a,{roomId:t.roomId})),p.b.getValue(g.b.AdvancedSettings)?new h.a(y.Advanced,Object(r.b)("Advanced"),"mx_RoomSettingsDialog_warningIcon",o.a.createElement(v.a,{roomId:t.roomId,closeSettingsFn:s})):null].filter(Boolean),[e,t,s]);return o.a.createElement(c.a,{title:Object(r.a)("Space settings"),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:s,fixedWidth:!1},o.a.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog",title:Object(r.a)("Settings - %(spaceName)s",{spaceName:t.name})},o.a.createElement(h.c,{tabs:n})))}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(94),o=s(84),r=s(88),c=s(451),l=s(199),d=s(386),h=s(186),u=s(1);t.a=({matrixClient:e,space:t,onFinished:s})=>{const[m,p]=Object(n.useState)(!1),[g,v]=Object(n.useState)(""),f=e.getUserId(),[b,y]=Object(n.useState)(null),E=t.currentState.maySendStateEvent(a.a.RoomAvatar,f),S=null!==b,[_,w]=Object(n.useState)(t.name),C=t.currentState.maySendStateEvent(a.a.RoomName,f),O=_!==t.name,k=Object(d.b)(t),[R,I]=Object(n.useState)(k),x=t.currentState.maySendStateEvent(a.a.RoomTopic,f),T=R!==k;return i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(o.a)("General")),i.a.createElement("div",null,Object(o.a)("Edit settings relating to your space.")),g&&i.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},g),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(c.b,{avatarUrl:Object(l.b)(t,80,80,"crop"),avatarDisabled:m||!E,setAvatar:y,name:_,nameDisabled:m||!C,setName:w,topic:R,topicDisabled:m||!x,setTopic:I}),i.a.createElement(r.a,{onClick:()=>{y(null),w(t.name),I(k)},disabled:m||!(S||O||T),kind:"link"},Object(o.a)("Cancel")),i.a.createElement(r.a,{onClick:async()=>{p(!0);const s=[];S&&(b?s.push(e.sendStateEvent(t.roomId,a.a.RoomAvatar,{url:await e.uploadContent(b)},"")):s.push(e.sendStateEvent(t.roomId,a.a.RoomAvatar,{},""))),O&&s.push(e.setRoomName(t.roomId,_)),T&&s.push(e.setRoomTopic(t.roomId,R));const n=await Promise.allSettled(s);p(!1);const i=n.filter(e=>"rejected"===e.status);i.length>0&&(u.a.error("Failed to save space settings: ",i),v(Object(o.a)("Failed to save space settings.")))},disabled:m,kind:"primary"},m?Object(o.a)("Saving..."):Object(o.a)("Save Changes"))),i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(o.a)("Leave Space")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement(r.a,{kind:"danger",onClick:()=>{Object(h.c)(t)}},Object(o.a)("Leave Space"))))}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(94),o=s(127),r=s(84),c=s(88),l=s(522),d=s(387),h=s(187),u=s(785),m=s(523),p=s(482);t.a=({matrixClient:e,space:t,closeSettingsFn:s})=>{const[g,v]=Object(n.useState)(""),f=e.getUserId(),b=Object(p.a)(t,e=>e.getJoinRule()),[y,E]=Object(u.a)(()=>{var e,s;return(null===(e=t.currentState.getStateEvents(a.a.RoomGuestAccess,""))||void 0===e||null===(s=e.getContent())||void 0===s?void 0:s.guest_access)===o.a.CanJoin},s=>e.sendStateEvent(t.roomId,a.a.RoomGuestAccess,{guest_access:s?o.a.CanJoin:o.a.Forbidden},""),()=>v(Object(r.a)("Failed to update the guest access of this space"))),[S,_]=Object(u.a)(()=>{var e,s;return(null===(e=t.currentState.getStateEvents(a.a.RoomHistoryVisibility,""))||void 0===e||null===(s=e.getContent())||void 0===s?void 0:s.history_visibility)||o.b.Shared},s=>e.sendStateEvent(t.roomId,a.a.RoomHistoryVisibility,{history_visibility:s},""),()=>v(Object(r.a)("Failed to update the history visibility of this space"))),[w,C]=Object(d.a)(),O=t.currentState.maySendStateEvent(a.a.RoomGuestAccess,f),k=t.currentState.maySendStateEvent(a.a.RoomHistoryVisibility,f),R=t.currentState.mayClientSendStateEvent(a.a.RoomCanonicalAlias,e),I=t.currentState.getStateEvents(a.a.RoomCanonicalAlias,"");let x,T;return b===o.c.Public&&(x=w?i.a.createElement(i.a.Fragment,null,i.a.createElement(c.a,{onClick:C,kind:"link",className:"mx_SettingsTab_showAdvanced"},Object(r.a)("Hide advanced")),i.a.createElement(h.a,{value:y,onChange:E,disabled:!O,label:Object(r.a)("Enable guest access")}),i.a.createElement("p",null,Object(r.a)("Guests can join a space without having an account."),i.a.createElement("br",null),Object(r.a)("This may be useful for public spaces."))):i.a.createElement(i.a.Fragment,null,i.a.createElement(c.a,{onClick:C,kind:"link",className:"mx_SettingsTab_showAdvanced"},Object(r.a)("Show advanced")))),t.getJoinRule()===o.c.Public&&(T=i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(r.a)("Address")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement(l.a,{roomId:t.roomId,canSetCanonicalAlias:R,canSetAliases:!0,canonicalAliasEvent:I,hidePublishSetting:!0})))),i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(r.a)("Visibility")),g&&i.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},g),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("div",{className:"mx_SettingsTab_section_caption"},Object(r.a)("Decide who can view and join %(spaceName)s.",{spaceName:t.name})),i.a.createElement("div",null,i.a.createElement(m.a,{room:t,onError:()=>v(Object(r.a)("Failed to update the visibility of this space")),closeSettingsFn:s})),x,i.a.createElement(h.a,{value:S===o.b.WorldReadable,onChange:e=>{_(e?o.b.WorldReadable:o.b.Shared)},disabled:!k,label:Object(r.a)("Preview Space")}),i.a.createElement("div",null,Object(r.a)("Allow people to preview your space before they join.")),i.a.createElement("b",null,Object(r.a)("Recommended for public spaces."))),T)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(101),d=s(88),h=s(85);class u extends r.a.Component{constructor(...e){super(...e),a()(this,"state",{verifyRemove:!1}),a()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),a()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),a()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})})}render(){return this.state.verifyRemove?r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("span",{className:"mx_EditableItem_promptText"},Object(c.a)("Are you sure?")),r.a.createElement(d.a,{onClick:this.onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("Yes")),r.a.createElement(d.a,{onClick:this.onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("No"))):r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("div",{onClick:this.onRemove,className:"mx_EditableItem_delete",title:Object(c.a)("Remove"),role:"button"}),r.a.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}let m=Object(h.a)("views.elements.EditableItemList")(n=class extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"onItemAdded",e=>{e.stopPropagation(),e.preventDefault(),this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem)}),a()(this,"onItemRemoved",e=>{this.props.onItemRemoved&&this.props.onItemRemoved(e)}),a()(this,"onNewItemChanged",e=>{this.props.onNewItemChanged&&this.props.onNewItemChanged(e.target.value)})}renderNewItemField(){return r.a.createElement("form",{onSubmit:this.onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},r.a.createElement(l.a,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this.onNewItemChanged,list:this.props.suggestionsListId}),r.a.createElement(d.a,{onClick:this.onItemAdded,kind:"primary",type:"submit",disabled:!this.props.newItem},Object(c.a)("Add")))}render(){const e=this.props.items.map((e,t)=>this.props.canRemove?r.a.createElement(u,{key:e,index:t,value:e,onRemove:this.onItemRemoved}):r.a.createElement("li",{key:e},e)),t=this.props.canRemove?e:r.a.createElement("ul",null,e),s=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return r.a.createElement("div",{className:"mx_EditableItemList"},r.a.createElement("div",{className:"mx_EditableItemList_label"},s),t,this.props.canEdit?this.renderNewItemField():r.a.createElement("div",null))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82);const i=(e,t,s)=>{const[i,a]=Object(n.useState)(e);return[i,async n=>{a(n);try{await t(n)}catch(t){a(e()),s(t)}}]}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(194),o=s(84),r=s(97),c=s(237),l=s(106),d=s(126),h=s(88),u=s(128),m=s(137),p=s(98);const g=({room:e,checked:t,onChange:s})=>{const n=e instanceof a.b;let r;if(n){r=Object(o.a)("%(count)s members",{count:e.getJoinedMemberCount()});const t=l.a.instance.getChildRooms(e.roomId).length;t>0&&(r+=" · "+Object(o.a)("%(count)s rooms",{count:t}))}return i.a.createElement("label",{className:"mx_ManageRestrictedJoinRuleDialog_entry"},i.a.createElement("div",null,i.a.createElement("div",null,n?i.a.createElement(d.a,{room:e,height:20,width:20}):i.a.createElement(d.a,{oobData:e,height:20,width:20}),i.a.createElement("span",{className:"mx_ManageRestrictedJoinRuleDialog_entry_name"},e.name)),r&&i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_entry_description"},r)),i.a.createElement(m.b,{onChange:s?e=>s(e.target.checked):null,checked:t,disabled:!s}))},v=(e,t)=>{const s=t.client;Array.from(l.a.instance.getKnownParents(t.roomId)).map(e=>s.getRoom(e)).forEach(t=>{e.has(t)||(e.add(t),v(e,t))})};t.a=({room:e,selected:t=[],onFinished:s})=>{const a=e.client,[l,d]=Object(n.useState)(new Set(t)),[m,f]=Object(n.useState)(""),b=m.toLowerCase().trim(),[y,E]=Object(n.useMemo)(()=>{const s=new Set;return v(s,e),[Array.from(s),t.map(e=>{const t=a.getRoom(e);return t?"join"===t.getMyMembership()&&t.isSpaceRoom()?void 0:t:{roomId:e,name:e}}).filter(Boolean)]},[a,t,e]),[S,_]=Object(n.useMemo)(()=>[y.filter(e=>e.name.toLowerCase().includes(b)),E.filter(e=>e.name.toLowerCase().includes(b))],[y,E,b]),w=(e,t)=>{e?l.add(t.roomId):l.delete(t.roomId),d(new Set(l))};let C;return l.size<1&&(C=i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section_info"},Object(o.a)("You're removing all spaces. Access will default to invite only"))),i.a.createElement(r.a,{title:Object(o.a)("Select spaces"),className:"mx_ManageRestrictedJoinRuleDialog",onFinished:s,fixedWidth:!1},i.a.createElement("p",null,Object(o.a)("Decide which spaces can access this room. If a space is selected, its members can find and join <RoomName/>.",{},{RoomName:()=>i.a.createElement("b",null,e.name)})),i.a.createElement(p.a.Provider,{value:a},i.a.createElement(c.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(o.a)("Search spaces"),onSearch:f,autoFocus:!0}),i.a.createElement(u.a,{className:"mx_ManageRestrictedJoinRuleDialog_content"},S.length>0?i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section"},i.a.createElement("h3",null,e.isSpaceRoom()?Object(o.a)("Spaces you know that contain this space"):Object(o.a)("Spaces you know that contain this room")),S.map(e=>i.a.createElement(g,{key:e.roomId,room:e,checked:l.has(e.roomId),onChange:t=>{w(t,e)}}))):void 0,_.length>0?i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section"},i.a.createElement("h3",null,Object(o.a)("Other spaces or rooms you might not know")),i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section_info"},i.a.createElement("div",null,Object(o.a)("These are likely ones other room admins are a part of."))),_.map(e=>i.a.createElement(g,{key:e.roomId,room:e,checked:l.has(e.roomId),onChange:t=>{w(t,e)}}))):null,S.length+_.length<1?i.a.createElement("span",{className:"mx_ManageRestrictedJoinRuleDialog_noResults"},Object(o.a)("No results")):void 0),i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_footer"},C,i.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_footer_buttons"},i.a.createElement(h.a,{kind:"primary_outline",onClick:()=>s()},Object(o.a)("Cancel")),i.a.createElement(h.a,{kind:"primary",onClick:()=>s(Array.from(l))},Object(o.a)("Confirm"))))))}},,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(801),u=s(88),m=s(87),p=s(98),g=s(89),v=s(115),f=s(85),b=s(802),y=s(803),E=s(522);let S=Object(f.a)("views.settings.tabs.room.GeneralRoomSettingsTab")((a=i=class extends l.a.Component{constructor(e,t){super(e,t),r()(this,"context",void 0),r()(this,"onLeaveClick",()=>{m.a.dispatch({action:"leave_room",room_id:this.props.roomId})}),this.state={isRoomPublished:!1}}render(){const e=this.context,t=e.getRoom(this.props.roomId),s=t.currentState.mayClientSendStateEvent("m.room.canonical_alias",e),n=t.currentState.getStateEvents("m.room.canonical_alias",""),i=t.currentState.mayClientSendStateEvent("m.room.related_groups",e),a=t.currentState.getStateEvents("m.room.related_groups","");let o,r,c=l.a.createElement(l.a.Fragment,null,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("URL Previews")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement(b.a,{room:t})));return g.b.getValue(v.b.URLPreviews)||(c=null),g.b.getValue(v.b.Flair)&&(o=l.a.createElement(l.a.Fragment,null,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Flair")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},l.a.createElement(y.a,{roomId:t.roomId,canSetRelatedGroups:i,relatedGroupsEvent:a})))),"join"===t.getMyMembership()&&(r=l.a.createElement(l.a.Fragment,null,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Leave room")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement(u.a,{kind:"danger",onClick:this.onLeaveClick},Object(d.a)("Leave room"))))),l.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("General")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},l.a.createElement(h.a,{roomId:this.props.roomId})),l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("Room Addresses")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},l.a.createElement(E.a,{roomId:this.props.roomId,canSetCanonicalAlias:s,canSetAliases:!0,canonicalAliasEvent:n})),l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("Other")),o,c,r)}},r()(i,"contextType",p.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(101),h=s(85),u=s(103),m=s(88),p=s(445);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let f=Object(h.a)("views.room_settings.RoomProfileSettings")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"avatarUpload",Object(o.createRef)()),a()(this,"uploadAvatar",()=>{this.avatarUpload.current.click()}),a()(this,"removeAvatar",()=>{this.avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{avatar:!0})})}),a()(this,"isSaveEnabled",()=>Boolean(Object.values(this.state.profileFieldsTouched).length)),a()(this,"cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.isSaveEnabled()&&this.setState({profileFieldsTouched:{},displayName:this.state.originalDisplayName,topic:this.state.originalTopic,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),a()(this,"saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.isSaveEnabled())return;this.setState({profileFieldsTouched:{}});const t=l.a.get(),s={},n=this.state.displayName.trim();if(this.state.originalDisplayName!==this.state.displayName&&(await t.setRoomName(this.props.roomId,n),s.originalDisplayName=n,s.displayName=n),this.state.avatarFile){const e=await t.uploadContent(this.state.avatarFile);await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:e},""),s.avatarUrl=Object(u.b)(e).getSquareThumbnailHttp(96),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.sendStateEvent(this.props.roomId,"m.room.avatar",{},"");this.state.originalTopic!==this.state.topic&&(await t.setRoomTopic(this.props.roomId,this.state.topic),s.originalTopic=this.state.topic),this.setState(s)}),a()(this,"onDisplayNameChanged",e=>{this.setState({displayName:e.target.value}),this.state.originalDisplayName===e.target.value?this.setState({profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{name:!1})}):this.setState({profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{name:!0})})}),a()(this,"onTopicChanged",e=>{this.setState({topic:e.target.value}),this.state.originalTopic===e.target.value?this.setState({profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{topic:!1})}):this.setState({profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{topic:!0})})}),a()(this,"onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{avatar:!1})});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:String(e.target.result),avatarFile:t,profileFieldsTouched:v(v({},this.state.profileFieldsTouched),{},{avatar:!0})})},s.readAsDataURL(t)});const t=l.a.get(),s=t.getRoom(e.roomId);if(!s)throw new Error("Expected a room for ID: "+e.roomId);const n=s.currentState.getStateEvents("m.room.avatar","");let i=n&&n.getContent()?n.getContent().url:null;i&&(i=Object(u.b)(i).getSquareThumbnailHttp(96));const r=s.currentState.getStateEvents("m.room.topic",""),c=r&&r.getContent()?r.getContent().topic:"",d=s.currentState.getStateEvents("m.room.name",""),h=d&&d.getContent()?d.getContent().name:"";this.state={originalDisplayName:h,displayName:h,originalAvatarUrl:i,avatarUrl:i,avatarFile:null,originalTopic:c,topic:c,profileFieldsTouched:{},canSetName:s.currentState.maySendStateEvent("m.room.name",t.getUserId()),canSetTopic:s.currentState.maySendStateEvent("m.room.topic",t.getUserId()),canSetAvatar:s.currentState.maySendStateEvent("m.room.avatar",t.getUserId())}}render(){let e;return(this.state.canSetName||this.state.canSetTopic||this.state.canSetAvatar)&&(e=r.a.createElement("div",{className:"mx_ProfileSettings_buttons"},r.a.createElement(m.a,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.isSaveEnabled()},Object(c.a)("Cancel")),r.a.createElement(m.a,{onClick:this.saveProfile,kind:"primary",disabled:!this.isSaveEnabled()},Object(c.a)("Save")))),r.a.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},r.a.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this.onAvatarChanged,accept:"image/*"}),r.a.createElement("div",{className:"mx_ProfileSettings_profile"},r.a.createElement("div",{className:"mx_ProfileSettings_controls"},r.a.createElement(d.a,{label:Object(c.a)("Room Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged,disabled:!this.state.canSetName}),r.a.createElement(d.a,{className:"mx_ProfileSettings_controls_topic",id:"profileTopic",label:Object(c.a)("Room Topic"),disabled:!this.state.canSetTopic,type:"text",value:this.state.topic,autoComplete:"off",onChange:this.onTopicChanged,element:"textarea"})),r.a.createElement(p.a,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.props.roomId,avatarAltText:Object(c.a)("Room avatar"),uploadAvatar:this.state.canSetAvatar?this.uploadAvatar:void 0,removeAvatar:this.state.canSetAvatar?this.removeAvatar:void 0})),e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(89),d=s(87),h=s(86),u=s(92),m=s(100),p=s(85),g=s(172);let v=Object(p.a)("views.room_settings.UrlPreviewSettings")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onClickUserSettings",e=>{e.preventDefault(),e.stopPropagation(),d.a.fire(u.a.ViewUserSettings)})}render(){const e=this.props.room.roomId,t=h.a.get().isRoomEncrypted(e);let s=null,n=null;if(t)s=Object(c.a)("In encrypted rooms, like this one, URL previews are disabled by default to ensure that your homeserver (where the previews are generated) cannot gather information about links you see in this room.");else{if(s=l.b.getValueAt(m.a.ACCOUNT,"urlPreviewsEnabled")?Object(c.a)("You have <a>enabled</a> URL previews by default.",{},{a:e=>r.a.createElement("a",{onClick:this.onClickUserSettings,href:""},e)}):Object(c.a)("You have <a>disabled</a> URL previews by default.",{},{a:e=>r.a.createElement("a",{onClick:this.onClickUserSettings,href:""},e)}),l.b.canSetValue("urlPreviewsEnabled",e,m.a.ROOM))n=r.a.createElement("label",null,r.a.createElement(g.a,{name:"urlPreviewsEnabled",level:m.a.ROOM,roomId:e,isExplicit:!0}));else{let t=Object(c.b)("URL previews are enabled by default for participants in this room.");l.b.getValueAt(m.a.ROOM,"urlPreviewsEnabled",e,!0)||(t=Object(c.b)("URL previews are disabled by default for participants in this room.")),n=r.a.createElement("label",null,Object(c.a)(t))}}const i=r.a.createElement(g.a,{name:t?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled",level:m.a.ROOM_ACCOUNT,roomId:e});return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("When someone puts a URL in their message, a URL preview can be shown to give more information about that link such as the title, description, and an image from the website.")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},s),n,r.a.createElement("label",null,i))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(110),h=s.n(d),u=s(117),m=s(107),p=s(84),g=s(90),v=s(104),f=s(98),b=s(85),y=s(1);const E=/\+\S+:\S+/;let S=Object(b.a)("views.room_settings.RelatedGroupSettings")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onNewGroupChanged",e=>{this.setState({newGroupId:e})}),r()(this,"onGroupAdded",e=>{if(0===e.length||!this.validateGroupId(e))return;const t=[...this.state.newGroupsList,e];this.setState({newGroupsList:t,newGroupId:""}),this.updateGroups(t)}),r()(this,"onGroupDeleted",e=>{const t=this.state.newGroupsList[e],s=this.state.newGroupsList.filter(e=>e!==t);this.setState({newGroupsList:s}),this.updateGroups(s)}),this.state={newGroupId:"",newGroupsList:e.relatedGroupsEvent&&e.relatedGroupsEvent.getContent().groups||[]}}updateGroups(e){this.context.sendStateEvent(this.props.roomId,"m.room.related_groups",{groups:e},"").catch(e=>{y.a.error(e),g.a.createTrackedDialog("Error updating flair","",v.a,{title:Object(p.a)("Error updating flair"),description:Object(p.a)("There was an error updating the flair for this room. The server may not allow it or a temporary error occurred.")})})}validateGroupId(e){if(!E.test(e)){const t=m.getComponent("dialogs.ErrorDialog");return g.a.createTrackedDialog("Invalid related community ID","",t,{title:Object(p.a)("Invalid community ID"),description:Object(p.a)("'%(groupId)s' is not a valid community ID",{groupId:e})}),!1}return!0}render(){const e=this.context.getDomain(),t=m.getComponent("elements.EditableItemList");return l.a.createElement("div",null,l.a.createElement(t,{id:"relatedGroups",items:this.state.newGroupsList,className:"mx_RelatedGroupSettings",newItem:this.state.newGroupId,canRemove:this.props.canSetRelatedGroups,canEdit:this.props.canSetRelatedGroups,onNewItemChanged:this.onNewGroupChanged,onItemAdded:this.onGroupAdded,onItemRemoved:this.onGroupDeleted,itemsLabel:Object(p.a)("Showing flair for these communities:"),noItemsLabel:Object(p.a)("This room is not showing flair for any communities"),placeholder:Object(p.a)("New community ID (e.g. +foo:%(localDomain)s)",{localDomain:e})}))}},r()(i,"propTypes",{roomId:h.a.string.isRequired,canSetRelatedGroups:h.a.bool.isRequired,relatedGroupsEvent:h.a.instanceOf(u.b)}),r()(i,"contextType",f.a),r()(i,"defaultProps",{canSetRelatedGroups:!1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(127),l=s(94),d=s(84),h=s(86),u=s(187),m=s(90),p=s(113),g=s(216),v=s(100),f=s(89),b=s(115),y=s(85),E=s(88),S=s(172),_=s(141),w=s(389),C=s(523),O=s(104),k=s(1);let R=Object(y.a)("views.settings.tabs.room.SecurityRoomSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onStateEvent",e=>{[l.a.RoomJoinRules,l.a.RoomGuestAccess,l.a.RoomHistoryVisibility,l.a.RoomEncryption].includes(e.getType())&&this.forceUpdate()}),a()(this,"onEncryptionChange",async()=>{var e;if((null===(e=h.a.get().getRoom(this.props.roomId))||void 0===e?void 0:e.getJoinRule())===c.c.Public){const e=m.a.createTrackedDialog("Confirm Public Encrypted Room","",p.a,{title:Object(d.a)("Are you sure you want to add encryption to this public room?"),description:r.a.createElement("div",null,r.a.createElement("p",null," ",Object(d.a)("<b>It's not recommended to add encryption to public rooms.</b>Anyone can find and join public rooms, so anyone can read messages in them. You'll get none of the benefits of encryption, and you won't be able to turn it off later. Encrypting messages in a public room will make receiving and sending messages slower.",null,{b:e=>r.a.createElement("b",null,e)})," "),r.a.createElement("p",null," ",Object(d.a)("To avoid these issues, create a <a>new encrypted room</a> for the conversation you plan to have.",null,{a:t=>r.a.createElement("a",{className:"mx_linkButton",onClick:()=>{e.close(),this.createNewRoom(!1,!0)}}," ",t," ")})," "))}),{finished:t}=e,[s]=await t;if(!s)return}m.a.createTrackedDialog("Enable encryption","",p.a,{title:Object(d.a)("Enable encryption?"),description:Object(d.a)("Once enabled, encryption for a room cannot be disabled. Messages sent in an encrypted room cannot be seen by the server, only by the participants of the room. Enabling encryption may prevent many bots and bridges from working correctly. <a>Learn more about encryption.</a>",{},{a:e=>r.a.createElement("a",{href:"https://element.io/help#encryption",rel:"noreferrer noopener",target:"_blank"},e)}),onFinished:e=>{if(!e)return void this.setState({encrypted:!1});const t=this.state.encrypted;this.setState({encrypted:!0}),h.a.get().sendStateEvent(this.props.roomId,l.a.RoomEncryption,{algorithm:"m.megolm.v1.aes-sha2"}).catch(e=>{k.a.error(e),this.setState({encrypted:t})})}})}),a()(this,"onGuestAccessChange",e=>{const t=e?c.a.CanJoin:c.a.Forbidden,s=this.state.guestAccess;if(s===t)return;this.setState({guestAccess:t});h.a.get().sendStateEvent(this.props.roomId,l.a.RoomGuestAccess,{guest_access:t},"").catch(e=>{k.a.error(e),this.setState({guestAccess:s})})}),a()(this,"createNewRoom",async(e,t)=>{const s=m.a.createTrackedDialog("Create Room","Create room after trying to make an E2EE room public",w.a,{defaultPublic:e,defaultEncrypted:t}),[n,i]=await s.finished;return n&&await Object(_.b)(i),n}),a()(this,"onHistoryRadioToggle",e=>{const t=this.state.history;t!==e&&(this.setState({history:e}),h.a.get().sendStateEvent(this.props.roomId,l.a.RoomHistoryVisibility,{history_visibility:e},"").catch(e=>{k.a.error(e),this.setState({history:t})}))}),a()(this,"updateBlacklistDevicesFlag",e=>{h.a.get().getRoom(this.props.roomId).setBlacklistUnverifiedDevices(e)}),a()(this,"onJoinRuleChangeError",e=>{var t;m.a.createTrackedDialog("Room not found","",O.a,{title:Object(d.a)("Failed to update the join rules"),description:null!==(t=e.message)&&void 0!==t?t:Object(d.a)("Unknown failure")})}),a()(this,"onBeforeJoinRuleChange",async e=>{if(this.state.encrypted&&e===c.c.Public){const e=m.a.createTrackedDialog("Confirm Public Encrypted Room","",p.a,{title:Object(d.a)("Are you sure you want to make this encrypted room public?"),description:r.a.createElement("div",null,r.a.createElement("p",null," ",Object(d.a)("<b>It's not recommended to make encrypted rooms public.</b> It will mean anyone can find and join the room, so anyone can read messages. You'll get none of the benefits of encryption. Encrypting messages in a public room will make receiving and sending messages slower.",null,{b:e=>r.a.createElement("b",null,e)})," "),r.a.createElement("p",null," ",Object(d.a)("To avoid these issues, create a <a>new public room</a> for the conversation you plan to have.",null,{a:t=>r.a.createElement("a",{className:"mx_linkButton",onClick:()=>{e.close(),this.createNewRoom(!0,!1)}}," ",t," ")})," "))}),{finished:t}=e,[s]=await t;if(!s)return!1}return!0}),a()(this,"toggleAdvancedSection",()=>{this.setState({showAdvancedSection:!this.state.showAdvancedSection})}),this.state={guestAccess:c.a.Forbidden,history:c.b.Shared,hasAliases:!1,encrypted:!1,showAdvancedSection:!1}}UNSAFE_componentWillMount(){var e,t;const s=h.a.get();s.on("RoomState.events",this.onStateEvent);const n=s.getRoom(this.props.roomId).currentState,i=n.getStateEvents(l.a.RoomJoinRules,""),a=this.pullContentPropertyFromEvent(i,"join_rule",c.c.Invite)===c.c.Restricted?null==i||null===(e=i.getContent().allow)||void 0===e||null===(t=e.filter(e=>e.type===c.e.RoomMembership))||void 0===t?void 0:t.map(e=>e.room_id):void 0,o=this.pullContentPropertyFromEvent(n.getStateEvents(l.a.RoomGuestAccess,""),"guest_access",c.a.Forbidden),r=this.pullContentPropertyFromEvent(n.getStateEvents(l.a.RoomHistoryVisibility,""),"history_visibility",c.b.Shared),d=h.a.get().isRoomEncrypted(this.props.roomId);this.setState({restrictedAllowRoomIds:a,guestAccess:o,history:r,encrypted:d}),this.hasAliases().then(e=>this.setState({hasAliases:e}))}pullContentPropertyFromEvent(e,t,s){return(null==e?void 0:e.getContent()[t])||s}componentWillUnmount(){h.a.get().removeListener("RoomState.events",this.onStateEvent)}async hasAliases(){const e=h.a.get();if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const t=(await e.unstableGetLocalAliases(this.props.roomId)).aliases;return Array.isArray(t)&&0!==t.length}return!!(e.getRoom(this.props.roomId).currentState.getStateEvents(l.a.RoomAliases)||[]).find(e=>(e.getContent().aliases||[]).length>0)}renderJoinRule(){const e=h.a.get().getRoom(this.props.roomId);let t=null;return e.getJoinRule()!==c.c.Public||this.state.hasAliases||(t=r.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},r.a.createElement("img",{src:s(270),width:15,height:15}),r.a.createElement("span",null,Object(d.a)("To link to this room, please add an address.")))),r.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_joinRule"},r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",null,Object(d.a)("Decide who can join %(roomName)s.",{roomName:null==e?void 0:e.name}))),t,r.a.createElement(C.a,{room:e,beforeChange:this.onBeforeJoinRuleChange,onError:this.onJoinRuleChangeError,closeSettingsFn:this.props.closeSettingsFn,promptUpgrade:!0}))}renderHistory(){const e=h.a.get(),t=this.state.history,s=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent(l.a.RoomHistoryVisibility,e),n=[{value:c.b.Shared,label:Object(d.a)("Members only (since the point in time of selecting this option)")},{value:c.b.Invited,label:Object(d.a)("Members only (since they were invited)")},{value:c.b.Joined,label:Object(d.a)("Members only (since they joined)")}];return this.state.encrypted&&t!==c.b.WorldReadable||n.unshift({value:c.b.WorldReadable,label:Object(d.a)("Anyone")}),r.a.createElement("div",null,r.a.createElement("div",null,Object(d.a)("Changes to who can read history will only apply to future messages in this room. The visibility of existing history will be unchanged.")),r.a.createElement(g.a,{name:"historyVis",value:t,onChange:this.onHistoryRadioToggle,disabled:!s,definitions:n}))}renderAdvanced(){const e=h.a.get(),t=this.state.guestAccess,s=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent(l.a.RoomGuestAccess,e);return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(u.a,{value:t===c.a.CanJoin,onChange:this.onGuestAccessChange,disabled:!s,label:Object(d.a)("Enable guest access")}),r.a.createElement("p",null,Object(d.a)("People with supported clients will be able to join the room without having a registered account.")))}render(){const e=h.a.get(),t=e.getRoom(this.props.roomId),s=this.state.encrypted,n=t.currentState.mayClientSendStateEvent(l.a.RoomEncryption,e),i=!s&&n;let a=null;s&&f.b.isEnabled("blacklistUnverifiedDevices")&&(a=r.a.createElement(S.a,{name:"blacklistUnverifiedDevices",level:v.a.ROOM_DEVICE,onChange:this.updateBlacklistDevicesFlag,roomId:this.props.roomId}));let o,m=r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Who can read history?")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this.renderHistory()));return f.b.getValue(b.b.RoomHistorySettings)||(m=null),t.getJoinRule()===c.c.Public&&(o=r.a.createElement(r.a.Fragment,null,r.a.createElement(E.a,{onClick:this.toggleAdvancedSection,kind:"link",className:"mx_SettingsTab_showAdvanced"},this.state.showAdvancedSection?Object(d.a)("Hide advanced"):Object(d.a)("Show advanced")),this.state.showAdvancedSection&&this.renderAdvanced())),r.a.createElement("div",{className:"mx_SettingsTab mx_SecurityRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("Security & Privacy")),r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Encryption")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityRoomSettingsTab_encryptionSection"},r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",null,Object(d.a)("Once enabled, encryption cannot be disabled."))),r.a.createElement(u.a,{value:s,onChange:this.onEncryptionChange,label:Object(d.a)("Encrypted"),disabled:!i})),a),r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Access")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this.renderJoinRule()),o,m)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(86),u=s(88),m=s(254),p=s(89),g=s(100),v=s(85),f=s(1),b=s(520),y=s(98),E=s(216),S=s(258),_=s(87),w=s(92),C=s(158);let O=Object(v.a)("views.settings.tabs.room.NotificationsSettingsTab")((a=i=class extends l.a.Component{constructor(e,t){super(e,t),r()(this,"roomProps",void 0),r()(this,"soundUpload",Object(c.createRef)()),r()(this,"context",void 0),r()(this,"triggerUploader",async e=>{e.stopPropagation(),e.preventDefault(),this.soundUpload.current.click()}),r()(this,"onSoundUploadChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({uploadedFile:null});const t=e.target.files[0];this.setState({uploadedFile:t})}),r()(this,"onClickSaveSound",async e=>{e.stopPropagation(),e.preventDefault();try{await this.saveSound()}catch(e){f.a.error("Unable to save notification sound for "+this.props.roomId),f.a.error(e)}}),r()(this,"clearSound",e=>{e.stopPropagation(),e.preventDefault(),p.b.setValue("notificationSound",this.props.roomId,g.a.ROOM_ACCOUNT,null),this.setState({currentSound:"default"})}),r()(this,"onRoomNotificationChange",e=>{this.roomProps.notificationVolume=e,this.forceUpdate()}),r()(this,"onOpenSettingsClick",()=>{this.props.closeSettingsFn(),_.a.dispatch({action:w.a.ViewUserSettings,initialTabId:C.a.Notifications})}),this.roomProps=b.a.forRoom(t.getRoom(this.props.roomId)),this.state={currentSound:"default",uploadedFile:null}}UNSAFE_componentWillMount(){const e=m.default.getSoundForRoom(this.props.roomId);e&&this.setState({currentSound:e.name||e.url})}async saveSound(){if(!this.state.uploadedFile)return;let e=this.state.uploadedFile.type;"video/ogg"===e&&(e="audio/ogg");const t=await h.a.get().uploadContent(this.state.uploadedFile,{type:e});await p.b.setValue("notificationSound",this.props.roomId,g.a.ROOM_ACCOUNT,{name:this.state.uploadedFile.name,type:e,size:this.state.uploadedFile.size,url:t}),this.setState({uploadedFile:null,currentSound:this.state.uploadedFile.name})}render(){let e=null;return this.state.uploadedFile&&(e=l.a.createElement("div",null,l.a.createElement("span",null,Object(d.a)("Uploaded sound"),": ",l.a.createElement("code",null,this.state.uploadedFile.name)))),l.a.createElement("div",{className:"mx_SettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("Notifications")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_NotificationSettingsTab_notificationsSection"},l.a.createElement(E.a,{name:"roomNotificationSetting",definitions:[{value:S.a.AllMessages,className:"mx_NotificationSettingsTab_defaultEntry",label:l.a.createElement(l.a.Fragment,null,Object(d.a)("Default"),l.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(d.a)("Get notifications as set up in your <a>settings</a>",{},{a:e=>l.a.createElement(u.a,{kind:"link",onClick:this.onOpenSettingsClick},e)})))},{value:S.a.AllMessagesLoud,className:"mx_NotificationSettingsTab_allMessagesEntry",label:l.a.createElement(l.a.Fragment,null,Object(d.a)("All messages"),l.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(d.a)("Get notified for every message")))},{value:S.a.MentionsOnly,className:"mx_NotificationSettingsTab_mentionsKeywordsEntry",label:l.a.createElement(l.a.Fragment,null,Object(d.a)("@mentions & keywords"),l.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(d.a)("Get notified only with mentions and keywords as set up in your <a>settings</a>",{},{a:e=>l.a.createElement(u.a,{kind:"link",onClick:this.onOpenSettingsClick},e)})))},{value:S.a.Mute,className:"mx_NotificationSettingsTab_noneEntry",label:l.a.createElement(l.a.Fragment,null,Object(d.a)("Off"),l.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(d.a)("You won't get any notifications")))}],onChange:this.onRoomNotificationChange,value:this.roomProps.notificationVolume})),l.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Sounds")),l.a.createElement("div",null,l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},l.a.createElement("span",null,Object(d.a)("Notification sound"),": ",l.a.createElement("code",null,this.state.currentSound))),l.a.createElement(u.a,{className:"mx_NotificationSound_resetSound",disabled:"default"==this.state.currentSound,onClick:this.clearSound,kind:"primary"},Object(d.a)("Reset"))),l.a.createElement("div",null,l.a.createElement("h3",null,Object(d.a)("Set a new custom sound")),l.a.createElement("div",{className:"mx_SettingsFlag"},l.a.createElement("form",{autoComplete:"off",noValidate:!0},l.a.createElement("input",{ref:this.soundUpload,className:"mx_NotificationSound_soundUpload",type:"file",onChange:this.onSoundUploadChanged,accept:"audio/*"})),e),l.a.createElement(u.a,{className:"mx_NotificationSound_browse",onClick:this.triggerUploader,kind:"primary"},Object(d.a)("Browse")),l.a.createElement(u.a,{className:"mx_NotificationSound_save",disabled:null==this.state.uploadedFile,onClick:this.onClickSaveSound,kind:"primary"},Object(d.a)("Save")),l.a.createElement("br",null))))}},r()(i,"contextType",y.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(82),a=s.n(i),o=s(84),r=s(86),c=s(807),l=s(85);const d=["uk.half-shot.bridge"];let h=Object(l.a)("views.settings.tabs.room.BridgeSettingsTab")(n=class e extends a.a.Component{renderBridgeCard(e,t){const s=e.getContent();return s&&s.channel&&s.protocol?a.a.createElement(c.a,{key:e.getId(),room:t,ev:e}):null}static getBridgeStateEvents(e){const t=r.a.get().getRoom(e).currentState;return d.map(e=>t.getStateEvents(e)).flat(1)}render(){const t=e.getBridgeStateEvents(this.props.roomId),s=r.a.get().getRoom(this.props.roomId);let n;return n=t.length>0?a.a.createElement("div",null,a.a.createElement("p",null,Object(o.a)("This room is bridging messages to the following platforms. <a>Learn more.</a>",{},{a:e=>a.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),a.a.createElement("ul",{className:"mx_RoomSettingsDialog_BridgeList"},t.map(e=>this.renderBridgeCard(e,s)))):a.a.createElement("p",null,Object(o.a)("This room isn't bridging messages to any platforms. <a>Learn more.</a>",{},{a:e=>a.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),a.a.createElement("div",{className:"mx_SettingsTab"},a.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(o.a)("Bridges")),a.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},n))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(110),h=s.n(d),u=s(84),m=s(385),p=s(120),g=s(125),v=s(89),f=s(138),b=s(85),y=s(103),E=s(1);let S=Object(b.a)("views.settings.BridgeTile")((a=i=class extends l.a.PureComponent{render(){var e,t;const s=this.props.ev.getContent();if(null===(e=s.channel)||void 0===e||!e.id||null===(t=s.protocol)||void 0===t||!t.id)return E.a.warn(`Bridge info event ${this.props.ev.getId()} has missing content. Tile will not render`),null;s.bridgebot||(E.a.warn(`Bridge info event ${this.props.ev.getId()} does not provide a 'bridgebot' key whichis deprecated behaviour. Using sender for now.`),s.bridgebot=this.props.ev.getSender());const{channel:n,network:i,protocol:a}=s,o=a.displayname||a.id,r=n.displayname||n.id;let c=null;s.creator&&(c=l.a.createElement("li",null,Object(u.a)("This bridge was provisioned by <user />.",{},{user:()=>l.a.createElement(m.a,{type:m.a.TYPE_USER_MENTION,room:this.props.room,url:Object(p.h)(s.creator),shouldShowPillAvatar:v.b.getValue("Pill.shouldShowPillAvatar")})})));const d=l.a.createElement("li",null,Object(u.a)("This bridge is managed by <user />.",{},{user:()=>l.a.createElement(m.a,{type:m.a.TYPE_USER_MENTION,room:this.props.room,url:Object(p.h)(s.bridgebot),shouldShowPillAvatar:v.b.getValue("Pill.shouldShowPillAvatar")})}));let h;if(a.avatar_url){const e=Object(y.b)(a.avatar_url).getSquareThumbnailHttp(64);h=l.a.createElement(g.a,{className:"protocol-icon",width:48,height:48,resizeMethod:"crop",name:o,idName:o,url:e})}else h=l.a.createElement("div",{className:"noProtocolIcon"});let b=null;if(i){const e=i.displayname||i.id;let t=l.a.createElement("span",null,e);"string"==typeof i.external_url&&Object(f.e)(i.external_url)&&(t=l.a.createElement("a",{href:i.external_url,target:"_blank",rel:"noreferrer noopener"},e)),b=Object(u.a)("Workspace: <networkLink/>",{},{networkLink:()=>t})}let S=l.a.createElement("span",null,r);"string"==typeof n.external_url&&Object(f.e)(n.external_url)&&(S=l.a.createElement("a",{href:n.external_url,target:"_blank",rel:"noreferrer noopener"},r));const _=this.props.ev.getId();return l.a.createElement("li",{key:_},l.a.createElement("div",{className:"column-icon"},h),l.a.createElement("div",{className:"column-data"},l.a.createElement("h3",null,o),l.a.createElement("p",{className:"workspace-channel-details"},b,l.a.createElement("span",{className:"channel"},Object(u.a)("Channel: <channelLink/>",{},{channelLink:()=>S}))),l.a.createElement("ul",{className:"metadata"},c," ",d)))}},r()(i,"propTypes",{ev:h.a.object.isRequired,room:h.a.object.isRequired}),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(127),o=s(84),r=s(97),c=s(88),l=s(98),d=s(326),h=s(106),u=s(300),m=s(273),p=s(369),g=s(1);t.a=({space:e,onAddExistingSpaceClick:t,onFinished:s})=>{var v;const[f,b]=Object(n.useState)(e),[y,E]=Object(n.useState)(!1),[S,_]=Object(n.useState)(""),w=Object(n.useRef)(),[C,O]=Object(n.useState)(""),k=Object(n.useRef)(),[R,I]=Object(n.useState)(null),[x,T]=Object(n.useState)(""),j=!(null===(v=h.a.instance.restrictedJoinRuleSupport)||void 0===v||!v.preferred),N=e.getJoinRule();let P=a.c.Invite;N===a.c.Public?P=a.c.Public:j&&(P=a.c.Restricted);const[D,M]=Object(n.useState)(P),A=async e=>{if(e.preventDefault(),!y){if(E(!0),!await w.current.validate({allowEmpty:!1}))return w.current.focus(),w.current.validate({allowEmpty:!1,focused:!0}),void E(!1);if(D===a.c.Public&&!await k.current.validate({allowEmpty:!0}))return k.current.focus(),k.current.validate({allowEmpty:!0,focused:!0}),void E(!1);try{await Object(u.c)(S,D===a.c.Public,C,x,R,{},{parentSpace:f,joinRule:D}),s(!0)}catch(e){g.a.error(e)}}};let U;return D===a.c.Restricted?U=i.a.createElement("p",null,Object(o.a)("Anyone in <SpaceName/> will be able to find and join.",{},{SpaceName:()=>i.a.createElement("b",null,f.name)})):D===a.c.Public?U=i.a.createElement("p",null,Object(o.a)("Anyone will be able to find and join this space, not just members of <SpaceName/>.",{},{SpaceName:()=>i.a.createElement("b",null,f.name)})):D===a.c.Invite&&(U=i.a.createElement("p",null,Object(o.a)("Only people invited will be able to find and join this space."))),i.a.createElement(r.a,{title:i.a.createElement(m.c,{title:Object(o.a)("Create a space"),space:e,value:f,onChange:b}),className:"mx_CreateSubspaceDialog",contentId:"mx_CreateSubspaceDialog",onFinished:s,fixedWidth:!1},i.a.createElement(l.a.Provider,{value:e.client},i.a.createElement("div",{className:"mx_CreateSubspaceDialog_content"},i.a.createElement("div",{className:"mx_CreateSubspaceDialog_betaNotice"},i.a.createElement(d.a,null),Object(o.a)("Add a space to a space you manage.")),i.a.createElement(u.a,{busy:y,onSubmit:A,setAvatar:I,name:S,setName:_,nameFieldRef:w,topic:x,setTopic:T,alias:C,setAlias:O,showAliasField:D===a.c.Public,aliasFieldRef:k},i.a.createElement(p.a,{label:Object(o.a)("Space visibility"),labelInvite:Object(o.a)("Private space (invite only)"),labelPublic:Object(o.a)("Public space"),labelRestricted:j?Object(o.a)("Visible to space members"):void 0,width:478,value:D,onChange:M}),U)),i.a.createElement("div",{className:"mx_CreateSubspaceDialog_footer"},i.a.createElement("div",{className:"mx_CreateSubspaceDialog_footer_prompt"},i.a.createElement("div",null,Object(o.a)("Want to add an existing space instead?")),i.a.createElement(c.a,{kind:"link",onClick:()=>{t(),s()}},Object(o.a)("Add existing space"))),i.a.createElement(c.a,{kind:"primary_outline",disabled:y,onClick:()=>s(!1)},Object(o.a)("Cancel")),i.a.createElement(c.a,{kind:"primary",disabled:y,onClick:A},y?Object(o.a)("Adding..."):Object(o.a)("Add")))))}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(89),r=s(88),c=s(87),l=s(92),d=s(158),h=s(452);t.a=({featureId:e,onFinished:t})=>{var s;const n=o.b.getBetaInfo(e);return i.a.createElement(h.a,{title:Object(a.a)("%(featureName)s beta feedback",{featureName:n.title}),subheading:Object(a.a)(n.feedbackSubheading),onFinished:t,rageshakeLabel:n.feedbackLabel,rageshakeData:Object.fromEntries(((null===(s=o.b.getBetaInfo(e))||void 0===s?void 0:s.extraSettings)||[]).map(e=>o.b.getValue(e)))},i.a.createElement(r.a,{kind:"link",onClick:()=>{t(!1),c.a.dispatch({action:l.a.ViewUserSettings,initialTabId:d.a.Labs})}},Object(a.a)("To leave the beta, visit your settings.")))}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(97),r=s(88),c=s(98),l=s(273);t.a=({space:e,onCreateSubspaceClick:t,onFinished:s})=>{const[d,h]=Object(n.useState)(e);return i.a.createElement(o.a,{title:i.a.createElement(l.c,{title:Object(a.a)("Add existing space"),space:e,value:d,onChange:h}),className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:s,fixedWidth:!1},i.a.createElement(c.a.Provider,{value:e.client},i.a.createElement(l.a,{space:e,onFinished:s,footerPrompt:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",null,Object(a.a)("Want to add a new space instead?")),i.a.createElement(r.a,{onClick:t,kind:"link"},Object(a.a)("Create a new space"))),filterPlaceholder:Object(a.a)("Search for spaces"),spacesRenderer:l.g})))}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(127),o=s(84),r=s(109),c=s(97),l=s(106),d=s(540);const h=e=>{const t=e.client.getUserId();return 100===e.getMember(t).powerLevelNorm&&e.getJoinedMembers().every(e=>e.userId===t||e.powerLevelNorm<100)};t.a=({space:e,onFinished:t})=>{const s=Object(n.useMemo)(()=>l.a.instance.getChildren(e.roomId),[e.roomId]),[u,m]=Object(n.useState)([]),p=Object(n.useMemo)(()=>new Set(u),[u]);let g,v;if(e.getJoinRule()!==a.c.Public&&(g=Object(o.a)("You won't be able to rejoin unless you are re-invited.")),h(e))v=Object(o.a)("You're the only admin of this space. Leaving it will mean no one has control over it.");else{u.filter(h).length>0&&(v=Object(o.a)("You're the only admin of some of the rooms or spaces you wish to leave. Leaving them will leave them without any admins."))}return i.a.createElement(c.a,{title:Object(o.a)("Leave %(spaceName)s",{spaceName:e.name}),className:"mx_LeaveSpaceDialog",contentId:"mx_LeaveSpaceDialog",onFinished:()=>t(!1),fixedWidth:!1},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_LeaveSpaceDialog"},i.a.createElement("p",null,Object(o.a)("You are about to leave <spaceName/>.",{},{spaceName:()=>i.a.createElement("b",null,e.name)})," ",g,g&&i.a.createElement(i.a.Fragment,null," "),s.length>0&&Object(o.a)("Would you like to leave the rooms in this space?")),s.length>0&&i.a.createElement(d.a,{space:e,spaceChildren:s,selected:p,onChange:m,noneLabel:Object(o.a)("Don't leave any rooms"),allLabel:Object(o.a)("Leave all rooms"),specificLabel:Object(o.a)("Leave some rooms")}),v&&i.a.createElement("div",{className:"mx_LeaveSpaceDialog_section_warning"},v)),i.a.createElement(r.a,{primaryButton:Object(o.a)("Leave space"),onPrimaryButtonClick:()=>t(!0,u),hasCancel:!0,onCancel:()=>t(!1)}))}},function(e,t){e.exports="img/icon-email-pill-avatar.802ffb9.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(97),l=s(84),d=s(101),h=s(88),u=s(86),m=s(116),p=s(93),g=s(416),v=s(125),f=s(159),b=s(137),y=s(90),E=s(104),S=s(85),_=s(103),w=s(1);let C=Object(S.a)("views.dialogs.CommunityPrototypeInviteDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onSubmit",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=[...this.state.emailTargets,...this.state.userTargets],t=await Object(f.a)(this.props.roomId,e),s=u.a.get().getRoom(this.props.roomId);Object(f.d)(t.states,s,t.inviter)?this.props.onFinished(!0):this.setState({busy:!1})}catch(e){this.setState({busy:!1}),w.a.error(e),y.a.createTrackedDialog("Failed to invite","",E.a,{title:Object(l.a)("Failed to invite"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}),a()(this,"onAddressChange",(e,t)=>{const s=Object(m.b)(this.state.emailTargets);t>=s.length?s.push(e.target.value):s[t]=e.target.value,this.setState({emailTargets:s})}),a()(this,"onAddressBlur",e=>{const t=Object(m.b)(this.state.emailTargets);e>=t.length||""===t[e].trim()&&(t.splice(e,1),this.setState({emailTargets:t}))}),a()(this,"onShowPeopleClick",()=>{this.setState({showPeople:!this.state.showPeople})}),a()(this,"setPersonToggle",(e,t)=>{const s=Object(m.b)(this.state.userTargets);t&&!s.includes(e.userId)?s.push(e.userId):!t&&s.includes(e.userId)&&s.splice(s.indexOf(e.userId),1),this.setState({userTargets:s})}),a()(this,"onShowMorePeople",()=>{this.setState({numPeople:this.state.numPeople+5})}),this.state={emailTargets:[],userTargets:[],showPeople:!1,people:this.buildSuggestions(),numPeople:5,busy:!1}}buildSuggestions(){const e=new Set([u.a.get().getUserId(),p.a.get().welcomeUserId]);if(this.props.roomId){const t=u.a.get().getRoom(this.props.roomId);if(!t)throw new Error("Room ID given to InviteDialog does not look like a room");t.getMembersWithMembership("invite").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("join").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("ban").forEach(t=>e.add(t.userId))}return g.d.buildRecents(e)}renderPerson(e,t){let s=null;return e.user.getMxcAvatarUrl()&&(s=Object(_.b)(e.user.getMxcAvatarUrl()).getSquareThumbnailHttp(36)),r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_person",key:t},r.a.createElement(v.a,{url:s,name:e.user.name,idName:e.user.userId,width:36,height:36}),r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_personIdentifiers"},r.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personName"},e.user.name),r.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personId"},e.userId)),r.a.createElement(b.b,{onChange:t=>this.setPersonToggle(e,t.target.checked)}))}render(){const e=[];this.state.emailTargets.forEach((t,s)=>{e.push(r.a.createElement(d.a,{key:s,value:t,onChange:e=>this.onAddressChange(e,s),label:Object(l.a)("Email address"),placeholder:Object(l.a)("Email address"),onBlur:()=>this.onAddressBlur(s)}))}),e.push(r.a.createElement(d.a,{key:e.length,value:"",onChange:t=>this.onAddressChange(t,e.length),label:e.length>0?Object(l.a)("Add another email"):Object(l.a)("Email address"),placeholder:e.length>0?Object(l.a)("Add another email"):Object(l.a)("Email address")}));let t=null;const s=[];if(this.state.showPeople){const e=this.state.people.slice(0,this.state.numPeople);e.forEach((e,t)=>{s.push(this.renderPerson(e,t))}),e.length<this.state.people.length&&s.push(r.a.createElement(h.a,{onClick:this.onShowMorePeople,kind:"link",key:"more",className:"mx_CommunityPrototypeInviteDialog_morePeople"},Object(l.a)("Show more")))}this.state.people.length>0&&(t=r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_people"},r.a.createElement("span",null,Object(l.a)("People you know on %(brand)s",{brand:p.a.get().brand})),r.a.createElement(h.a,{onClick:this.onShowPeopleClick},this.state.showPeople?Object(l.a)("Hide"):Object(l.a)("Show"))));let n=Object(l.a)("Skip");const i=this.state.userTargets.length+this.state.emailTargets.length;return i>0&&(n=Object(l.a)("Send %(count)s invites",{count:i})),r.a.createElement(c.a,{className:"mx_CommunityPrototypeInviteDialog",onFinished:this.props.onFinished,title:Object(l.a)("Invite people to join %(communityName)s",{communityName:this.props.communityName})},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},e,t,s,r.a.createElement(h.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy,className:"mx_CommunityPrototypeInviteDialog_primaryButton"},n))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(86),o=s(89),r=s(274);class c{constructor(){i()(this,"typingStates",void 0),this.reset()}static sharedInstance(){return void 0===window.mxTypingStore&&(window.mxTypingStore=new c),window.mxTypingStore}reset(){this.typingStates={}}setSelfTyping(e,t,s){if(!o.b.getValue("sendTypingNotifications"))return;if(o.b.getValue("lowBandwidth"))return;if(o.b.getValue("feature_thread")&&t)return;let n=this.typingStates[e];!s&&!n||n&&n.isTyping===s||(n||(n=this.typingStates[e]={isTyping:s,serverTimer:new r.a(3e4),userTimer:new r.a(1e4)}),n.isTyping=s,s&&(n.serverTimer.isRunning()?n.serverTimer.restart():n.serverTimer.restart().finished().then(()=>{const t=this.typingStates[e];t&&(t.isTyping=!1)}),n.userTimer.isRunning()?n.userTimer.restart():n.userTimer.restart().finished().then(()=>{this.setSelfTyping(e,t,!1)})),a.a.get().sendTyping(e,s,3e4))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(347),d=s(351),h=s(816),u=s(84),m=s(93),p=s(215),g=s(225),v=s(96),f=s(85),b=s(88),y=s(546),E=s(1);let S=Object(f.a)("views.right_panel.VerificationPanel")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"hasVerifier",void 0),a()(this,"onReciprocateYesClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.confirm()}),a()(this,"onReciprocateNoClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.cancel()}),a()(this,"startSAS",async()=>{this.setState({emojiButtonClicked:!0});const e=this.props.request.beginKeyVerification(l.d.SAS);try{await e.verify()}catch(e){E.a.error(e)}}),a()(this,"onSasMatchesClick",()=>{this.state.sasEvent.confirm()}),a()(this,"onSasMismatchesClick",()=>{this.state.sasEvent.mismatch()}),a()(this,"updateVerifierState",()=>{const{request:e}=this.props,t=e.verifier.sasEvent,s=e.verifier.reciprocateQREvent;e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState),this.setState({sasEvent:t,reciprocateQREvent:s})}),a()(this,"onRequestChange",async()=>{const{request:e}=this.props,t=this.hasVerifier;if(this.hasVerifier=!!e.verifier,!t&&this.hasVerifier){e.verifier.on("show_sas",this.updateVerifierState),e.verifier.on("show_reciprocate_qr",this.updateVerifierState);try{await e.verifier.verify()}catch(e){E.a.error("error verify",e)}}}),this.state={},this.hasVerifier=!1}renderQRPhase(){const{member:e,request:t}=this.props,s=t.otherPartySupportsMethod(l.d.SAS),n=t.otherPartySupportsMethod(d.c),i=m.a.get().brand,a=s||n?null:r.a.createElement("p",null,Object(u.a)("The session you are trying to verify doesn't support scanning a QR code or emoji verification, which is what %(brand)s supports. Try with a different client.",{brand:i}));if("dialog"===this.props.layout){let e,i;n&&(e=r.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},r.a.createElement("p",null,Object(u.a)("Scan this unique code")),r.a.createElement(h.a,{qrCodeData:t.qrCodeData}))),s&&(i=r.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},r.a.createElement("p",null,Object(u.a)("Compare unique emoji")),r.a.createElement("span",{className:"mx_VerificationPanel_QRPhase_helpText"},Object(u.a)("Compare a unique set of emoji if you don't have a camera on either device")),r.a.createElement(b.a,{disabled:this.state.emojiButtonClicked,onClick:this.startSAS,kind:"primary"},Object(u.a)("Start"))));const o=e&&i?r.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_betweenText"},Object(u.a)("or")):null;return r.a.createElement("div",null,Object(u.a)("Verify this session by completing one of the following:"),r.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOptions"},e,o,i,a))}let o,c;if(n&&(o=r.a.createElement("div",{className:"mx_UserInfo_container"},r.a.createElement("h3",null,Object(u.a)("Verify by scanning")),r.a.createElement("p",null,Object(u.a)("Ask %(displayName)s to scan your code:",{displayName:e.displayName||e.name||e.userId})),r.a.createElement("div",{className:"mx_VerificationPanel_qrCode"},r.a.createElement(h.a,{qrCodeData:t.qrCodeData})))),s){const e=this.state.emojiButtonClicked,t=n?Object(u.a)("If you can't scan the code above, verify by comparing unique emoji."):Object(u.a)("Verify by comparing unique emoji.");c=r.a.createElement("div",{className:"mx_UserInfo_container"},r.a.createElement("h3",null,Object(u.a)("Verify by emoji")),r.a.createElement("p",null,t),r.a.createElement(b.a,{disabled:e,kind:"primary",className:"mx_UserInfo_wideButton mx_VerificationPanel_verifyByEmojiButton",onClick:this.startSAS},Object(u.a)("Verify by emoji")))}const p=a?r.a.createElement("div",{className:"mx_UserInfo_container"},a):null;return r.a.createElement(r.a.Fragment,null,o,c,p)}getDevice(){const e=this.props.request&&this.props.request.channel.deviceId;return c.a.get().getStoredDevice(c.a.get().getUserId(),e)}renderQRReciprocatePhase(){const{member:e,request:t}=this.props,s=t.isSelfVerification?Object(u.a)("Almost there! Is your other session showing the same shield?"):Object(u.a)("Almost there! Is %(displayName)s showing the same shield?",{displayName:e.displayName||e.name||e.userId});let n;return n=this.state.reciprocateQREvent?r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,s),r.a.createElement(p.b,{isUser:!0,status:p.a.Verified,size:128,hideTooltip:!0}),r.a.createElement("div",{className:"mx_VerificationPanel_reciprocateButtons"},r.a.createElement(b.a,{kind:"danger",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateNoClick},Object(u.a)("No")),r.a.createElement(b.a,{kind:"primary",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateYesClick},Object(u.a)("Yes")))):r.a.createElement("p",null,r.a.createElement(v.a,null)),r.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_reciprocate_section"},r.a.createElement("h3",null,Object(u.a)("Verify by scanning")),n)}renderVerifiedPhase(){const{member:e,request:t}=this.props;let s,n;if(t.isSelfVerification||(s=this.props.isRoomEncrypted?Object(u.a)("Verify all users in a room to ensure it's secure."):Object(u.a)("In encrypted rooms, verify all users to ensure it's secure.")),t.isSelfVerification){const e=this.getDevice();e?n=Object(u.a)("You've successfully verified %(deviceName)s (%(deviceId)s)!",{deviceName:e?e.getDisplayName():"",deviceId:this.props.request.channel.deviceId}):(E.a.warn("Verified device we don't know about: "+this.props.request.channel.deviceId),n=Object(u.a)("You've successfully verified your device!"))}else n=Object(u.a)("You've successfully verified %(displayName)s!",{displayName:e.displayName||e.name||e.userId});return r.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},r.a.createElement("p",null,n),r.a.createElement(p.b,{isUser:!0,status:p.a.Verified,size:128,hideTooltip:!0}),s?r.a.createElement("p",null,s):null,r.a.createElement(b.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(u.a)("Got it")))}renderCancelledPhase(){const{member:e,request:t}=this.props;let s,n;return s=t.isSelfVerification?Object(u.a)("Start verification again from the notification."):Object(u.a)("Start verification again from their profile."),"m.timeout"===t.cancellationCode?n=Object(u.a)("Verification timed out.")+" "+s:t.cancellingUserId===t.otherUserId?(n=t.isSelfVerification?Object(u.a)("You cancelled verification on your other session."):Object(u.a)("%(displayName)s cancelled verification.",{displayName:e.displayName||e.name||e.userId}),n=`${n} ${s}`):n=Object(u.a)("You cancelled verification.")+" "+s,r.a.createElement("div",{className:"mx_UserInfo_container"},r.a.createElement("h3",null,Object(u.a)("Verification cancelled")),r.a.createElement("p",null,n),r.a.createElement(b.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(u.a)("Got it")))}render(){const{member:e,phase:t,request:s}=this.props,n=e.displayName||e.name||e.userId;switch(t){case g.h.Ready:return this.renderQRPhase();case g.h.Started:switch(s.chosenMethod){case l.d.RECIPROCATE_QR_CODE:return this.renderQRReciprocatePhase();case l.d.SAS:{const e=this.state.sasEvent?r.a.createElement(y.a,{displayName:n,device:this.getDevice(),sas:this.state.sasEvent.sas,onCancel:this.onSasMismatchesClick,onDone:this.onSasMatchesClick,inDialog:this.props.inDialog,isSelf:s.isSelfVerification}):r.a.createElement(v.a,null);return r.a.createElement("div",{className:"mx_UserInfo_container"},e)}default:return null}case g.h.Done:return this.renderVerifiedPhase();case g.h.Cancelled:return this.renderCancelledPhase()}return E.a.error("VerificationPanel unhandled phase:",t),null}componentDidMount(){const{request:e}=this.props;if(e.on("change",this.onRequestChange),e.verifier){const t=e.verifier.sasEvent,s=e.verifier.reciprocateQREvent;this.setState({sasEvent:t,reciprocateQREvent:s})}this.onRequestChange()}componentWillUnmount(){const{request:e}=this.props;e.verifier&&(e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState)),e.off("change",this.onRequestChange)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(82),a=s.n(i),o=s(85),r=s(498);let c=Object(o.a)("views.elements.crypto.VerificationQRCode")(n=class extends a.a.PureComponent{render(){return a.a.createElement(r.a,{data:[{data:this.props.qrCodeData.getBuffer(),mode:"byte"}],className:"mx_VerificationQRCode",width:196})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1);async function i(){n.a.log("Checking for COLR support");const{userAgent:e}=navigator;if(e.includes("Firefox"))return n.a.log("Browser is Firefox - assuming COLR is supported"),!0;if(!e.includes("Chrome")&&e.includes("Safari"))return function(e){n.a.log("Browser is Safari - checking version for COLR support");try{const t=e.match(/Mac OS X ([\d|_]+).*Version\/([\d|.]+).*Safari/);if(t){const e=t[1],s=t[2],i=e.split("_").map(e=>parseInt(e,10)),a=s.split(".").map(e=>parseInt(e,10)),o=i[0]>=10&&i[1]>=14&&a[0]>=12;return n.a.log(`COLR support on Safari requires macOS 10.14 and Safari 12, detected Safari ${s} on macOS ${e}, COLR supported: `+o),o}}catch(e){n.a.error("Error in Safari COLR version check",e)}return n.a.warn("Couldn't determine Safari version to check COLR font support, assuming no."),!1}(e);try{const e=document.createElement("canvas"),t=e.getContext("2d"),s=new Image,i=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" style="background:#fff;fill:#000;">\n            <style type="text/css">\n                @font-face {\n                    font-family: "chromacheck-colr";\n                    src: url(data:application/x-font-woff;base64,${"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA=="}) format("woff");\n                }\n            </style>\n            <text x="0" y="0" font-size="20">\n                <tspan font-family="chromacheck-colr" x="0" dy="20">&#xe900;</tspan>\n            </text>\n        </svg>`;e.width=20,e.height=100,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(i),n.a.log("Waiting for COLR SVG to load"),await new Promise(e=>s.onload=e),n.a.log("Drawing canvas to detect COLR support"),t.drawImage(s,0,0);const a=200===t.getImageData(10,10,1,1).data[0];return n.a.log("Canvas check revealed COLR is supported? "+a),a}catch(e){return n.a.error("Couldn't load COLR font",e),!1}}let a=!1;async function o(){if(!a)if(a=!0,await i()){const e=`url('${s(1564)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:"600"})),document.fonts.add(new FontFace("Twemoji",e,{weight:"700"}))}else{const e=`url('${s(1565)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:"600"})),document.fonts.add(new FontFace("Twemoji",e,{weight:"700"}))}}},function(e,t){e.exports="img/e2e/warning.78bb264.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(83),i=s.n(n),a=s(112),o=s(91),r=s.n(o),c=s(82),l=s.n(c),d=s(107),h=s(86),u=s(101),m=s(88),p=s(84),g=s(188),v=s(90),f=s(1);class b extends l.a.PureComponent{constructor(e){super(e),i()(this,"fileUpload",l.a.createRef()),i()(this,"onCancel",()=>{this.state.resetting&&this.setState({resetting:!1}),this.props.onFinished(!1)}),i()(this,"onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),i()(this,"validateRecoveryKeyOnChange",Object(a.debounce)(async()=>{await this.validateRecoveryKey()},200)),i()(this,"onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyFileError:null}),this.fileUpload.current&&(this.fileUpload.current.value=null),this.validateRecoveryKeyOnChange()}),i()(this,"onRecoveryKeyFileChange",async e=>{if(0===e.target.files.length)return;const t=e.target.files[0];if(t.size>128)this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1});else{const e=await t.text();/^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\s]+$/.test(e)?(this.setState({recoveryKeyFileError:null,recoveryKey:e.trim()}),await this.validateRecoveryKey()):this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1,recoveryKey:""})}}),i()(this,"onRecoveryKeyFileUploadClick",()=>{this.fileUpload.current.click()}),i()(this,"onPassPhraseNext",async e=>{if(e.preventDefault(),this.state.passPhrase.length<=0)return;this.setState({keyMatches:null});const t={passphrase:this.state.passPhrase},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),i()(this,"onRecoveryKeyNext",async e=>{if(e.preventDefault(),!this.state.recoveryKeyValid)return;this.setState({keyMatches:null});const t={recoveryKey:this.state.recoveryKey},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),i()(this,"onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value,keyMatches:null})}),i()(this,"onResetAllClick",e=>{e.preventDefault(),this.setState({resetting:!0})}),i()(this,"onConfirmResetAllClick",async()=>{v.a.toggleCurrentDialogVisibility();try{await Object(g.b)(async()=>{const e=h.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const s=d.getComponent("views.dialogs.InteractiveAuthDialog"),{finished:n}=v.a.createTrackedDialog("Cross-signing keys dialog","",s,{title:Object(p.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.props.onFinished(!0)},!0)}catch(e){f.a.error(e),this.props.onFinished(!1)}}),this.state={recoveryKey:"",recoveryKeyValid:null,recoveryKeyCorrect:null,recoveryKeyFileError:null,forceRecoveryKey:!1,passPhrase:"",keyMatches:null,resetting:!1}}async validateRecoveryKey(){if(""!==this.state.recoveryKey)try{const e=h.a.get(),t=e.keyBackupKeyFromRecoveryKey(this.state.recoveryKey),s=await e.checkSecretStorageKey(t,this.props.keyInfo);this.setState({recoveryKeyValid:!0,recoveryKeyCorrect:s})}catch(e){this.setState({recoveryKeyValid:!1,recoveryKeyCorrect:!1})}else this.setState({recoveryKeyValid:null,recoveryKeyCorrect:null})}getKeyValidationText(){return this.state.recoveryKeyFileError?Object(p.a)("Wrong file type"):this.state.recoveryKeyCorrect?Object(p.a)("Looks good!"):this.state.recoveryKeyValid?Object(p.a)("Wrong Security Key"):null===this.state.recoveryKeyValid?"":Object(p.a)("Invalid Security Key")}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=this.props.keyInfo&&this.props.keyInfo.passphrase&&this.props.keyInfo.passphrase.salt&&this.props.keyInfo.passphrase.iterations,n=l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_reset"},Object(p.a)("Forgotten or lost all recovery methods? <a>Reset all</a>",null,{a:e=>l.a.createElement("a",{href:"",onClick:this.onResetAllClick,className:"mx_AccessSecretStorageDialog_reset_link"},e)}));let i,a,o;if(this.state.resetting)a=Object(p.a)("Reset everything"),o=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_resetBadge"],i=l.a.createElement("div",null,l.a.createElement("p",null,Object(p.a)("Only do this if you have no other device to complete verification with.")),l.a.createElement("p",null,Object(p.a)("If you reset everything, you will restart with no trusted sessions, no trusted users, and might not be able to see past messages.")),l.a.createElement(t,{primaryButton:Object(p.a)("Reset"),onPrimaryButtonClick:this.onConfirmResetAllClick,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryButtonClass:"danger"}));else if(s&&!this.state.forceRecoveryKey){const e=d.getComponent("elements.AccessibleButton");let s;a=Object(p.a)("Security Phrase"),o=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_securePhraseTitle"],s=!1===this.state.keyMatches?l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"},"👎 ",Object(p.a)("Unable to access secret storage. Please verify that you entered the correct Security Phrase.")):l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"}),i=l.a.createElement("div",null,l.a.createElement("p",null,Object(p.a)("Enter your Security Phrase or <button>use your Security Key</button> to continue.",{},{button:t=>l.a.createElement(e,{className:"mx_linkButton",element:"span",onClick:this.onUseRecoveryKeyClick},t)})),l.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onPassPhraseNext},l.a.createElement(u.a,{id:"mx_passPhraseInput",className:"mx_AccessSecretStorageDialog_passPhraseInput",type:"password",label:Object(p.a)("Security Phrase"),value:this.state.passPhrase,onChange:this.onPassPhraseChange,autoFocus:!0,autoComplete:"new-password"}),s,l.a.createElement(t,{primaryButton:Object(p.a)("Continue"),onPrimaryButtonClick:this.onPassPhraseNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:0===this.state.passPhrase.length,additive:n})))}else{a=Object(p.a)("Security Key"),o=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_secureBackupTitle"];const e=r()({mx_AccessSecretStorageDialog_recoveryKeyFeedback:!0,mx_AccessSecretStorageDialog_recoveryKeyFeedback_valid:!0===this.state.recoveryKeyCorrect,mx_AccessSecretStorageDialog_recoveryKeyFeedback_invalid:!1===this.state.recoveryKeyCorrect}),s=l.a.createElement("div",{className:e},this.getKeyValidationText());i=l.a.createElement("div",null,l.a.createElement("p",null,Object(p.a)("Use your Security Key to continue.")),l.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onRecoveryKeyNext,spellCheck:!1,autoComplete:"off"},l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry"},l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_textInput"},l.a.createElement(u.a,{type:"password",label:Object(p.a)("Security Key"),value:this.state.recoveryKey,onChange:this.onRecoveryKeyChange,forceValidity:this.state.recoveryKeyCorrect,autoComplete:"off"})),l.a.createElement("span",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_entryControlSeparatorText"},Object(p.a)("or")),l.a.createElement("div",null,l.a.createElement("input",{type:"file",className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_fileInput",ref:this.fileUpload,onChange:this.onRecoveryKeyFileChange}),l.a.createElement(m.a,{kind:"primary",onClick:this.onRecoveryKeyFileUploadClick},Object(p.a)("Upload")))),s,l.a.createElement(t,{primaryButton:Object(p.a)("Continue"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,cancelButton:Object(p.a)("Go Back"),cancelButtonClass:"danger",onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid,additive:n})))}return l.a.createElement(e,{className:"mx_AccessSecretStorageDialog",onFinished:this.props.onFinished,title:a,titleClass:o},l.a.createElement("div",null,i))}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return p}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(124),u=s(85),m=s(1);let p=Object(u.a)("views.auth.CaptchaForm")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"captchaWidgetId",void 0),r()(this,"recaptchaContainer",Object(c.createRef)()),this.state={errorText:void 0},h.a.instance.track("onboarding_grecaptcha_begin")}componentDidMount(){if(this.isRecaptchaReady())this.onCaptchaLoaded();else{m.a.log("Loading recaptcha script..."),window.mxOnRecaptchaLoaded=()=>{this.onCaptchaLoaded()};const e=document.createElement("script");e.setAttribute("src","https://www.recaptcha.net/recaptcha/api.js?onload=mxOnRecaptchaLoaded&render=explicit"),this.recaptchaContainer.current.appendChild(e)}}componentWillUnmount(){this.resetRecaptcha()}isRecaptchaReady(){return"undefined"!=typeof window&&void 0!==e.grecaptcha&&"function"==typeof e.grecaptcha.render}renderRecaptcha(t){if(!this.isRecaptchaReady())throw m.a.error("grecaptcha not loaded!"),new Error("Recaptcha did not load successfully");const s=this.props.sitePublicKey;if(!s)throw m.a.error("No public key for recaptcha!"),new Error("This server has not supplied enough information for Recaptcha authentication");m.a.info("Rendering to %s",t),this.captchaWidgetId=e.grecaptcha.render(t,{sitekey:s,callback:this.props.onCaptchaResponse})}resetRecaptcha(){var t,s;this.captchaWidgetId&&(null===(t=e)||void 0===t||null===(s=t.grecaptcha)||void 0===s||s.reset(this.captchaWidgetId))}onCaptchaLoaded(){m.a.log("Loaded recaptcha script.");try{this.renderRecaptcha("mx_recaptcha"),this.setState({errorText:null}),h.a.instance.track("onboarding_grecaptcha_loaded")}catch(e){this.setState({errorText:e.toString()}),h.a.instance.track("onboarding_grecaptcha_error",{error:e.toString()})}}render(){let e=null;return this.state.errorText&&(e=l.a.createElement("div",{className:"error"},this.state.errorText)),l.a.createElement("div",{ref:this.recaptchaContainer},l.a.createElement("p",null,Object(d.a)("This homeserver would like to make sure you are not a robot.")),l.a.createElement("div",{id:"mx_recaptcha"}),e)}},r()(i,"defaultProps",{onCaptchaResponse:()=>{}}),n=a))||n}).call(this,s(26))},function(e,t,s){"use strict";var n;!function(e){e.HomePage="home_page",e.RoomView="room_view",e.RoomDirectory="room_directory",e.UserView="user_view",e.GroupView="group_view",e.MyGroups="my_groups"}(n||(n={})),t.a=n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(82),i=s.n(n),a=s(87),o=s(90),r=s(84),c=s(113);const l=/^[a-z0-9=_\-./]+$/;async function d(e){void 0===e&&(e={});const t=o.a.createTrackedDialog("Registration required","",c.a,{hasCancelButton:!0,quitOnly:!0,title:Object(r.a)("Sign In or Create Account"),description:Object(r.a)("Use your account or create a new one to continue."),button:Object(r.a)("Create Account"),extraButtons:[i.a.createElement("button",{key:"start_login",onClick:()=>{t.close(),a.a.dispatch({action:"start_login",screenAfterLogin:e.screen_after})}},Object(r.a)("Sign In"))],onFinished:t=>{t?a.a.dispatch({action:"start_registration",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?a.a.dispatch({action:"view_home_page"}):e.go_welcome_on_cancel&&a.a.dispatch({action:"view_welcome_page"})}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n),a=s(87),o=s(89),r=s(376),c=s(92),l=s(100);class d{constructor(){i()(this,"dispatcherRef",void 0),i()(this,"onAction",e=>{e.action===c.a.UpdateFontSize?this.setRootFontSize(e.size):e.action===c.a.UpdateSystemFont&&this.setSystemFont(e)}),i()(this,"setRootFontSize",e=>{const t=Math.max(Math.min(d.MAX_SIZE,e),d.MIN_SIZE);t!==e&&o.b.setValue("baseFontSize",null,l.a.DEVICE,t),document.querySelector(":root").style.fontSize=Object(r.a)(t)}),i()(this,"setSystemFont",({useSystemFont:e,font:t})=>{document.body.style.fontFamily=e?t:""}),this.dispatcherRef=null}start(){this.setRootFontSize(o.b.getValue("baseFontSize")),this.setSystemFont({useSystemFont:o.b.getValue("useSystemFont"),font:o.b.getValue("systemFont")}),this.dispatcherRef=a.a.register(this.onAction)}stop(){a.a.unregister(this.dispatcherRef)}}i()(d,"MIN_SIZE",8),i()(d,"MAX_SIZE",15),i()(d,"SIZE_DIFF",5)},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(97),l=s(84),d=s(101),h=s(88),u=s(86),m=s(396),p=s(87),g=s(92),v=s(159),f=s(131),b=s(85),y=s(1);let E=Object(b.a)("views.dialogs.CreateCommunityPrototypeDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"avatarUploadRef",r.a.createRef()),a()(this,"onNameChange",e=>{const t=(e.target.value||"").toLowerCase().replace(/[^a-z0-9.\-_]/g,"-");this.setState({name:e.target.value,localpart:t})}),a()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e="";this.state.avatarFile&&(e=await u.a.get().uploadContent(this.state.avatarFile));const t=await u.a.get().createGroup({localpart:this.state.localpart,profile:{name:this.state.name,avatar_url:e}});p.a.dispatch({action:"deselect_tags"},!0),p.a.dispatch({action:"select_tag",tag:t.group_id}),this.props.onFinished(!0),t.room_id?(await f.a.refreshGroupRooms(t.group_id),p.a.dispatch({action:g.a.ViewRoom,room_id:t.room_id}),Object(v.f)(t.room_id,this.state.name)):p.a.dispatch({action:"view_group",group_id:t.group_id,group_is_new:!0})}catch(e){y.a.error(e),this.setState({busy:!1,error:Object(l.a)("There was an error creating your community. The name may be taken or the server is unable to process your request.")})}}}),a()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),a()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()}),this.state={name:"",localpart:"",error:null,busy:!1,avatarFile:null,avatarPreview:null}}render(){let e=null;this.state.localpart&&(e=r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_communityId"},Object(l.a)("Community ID: +<localpart />:%(domain)s",{domain:u.a.getHomeserverName()},{localpart:()=>r.a.createElement("u",null,this.state.localpart)}),r.a.createElement(m.b,{tooltip:Object(l.a)("Use this when referencing your community to others. The community ID cannot be changed.")})));let t=r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"},Object(l.a)("You can change this later if needed."));if(this.state.error){const e="mx_CreateCommunityPrototypeDialog_subtext mx_CreateCommunityPrototypeDialog_subtext_error";t=r.a.createElement("span",{className:e},this.state.error)}let s=r.a.createElement("img",{src:this.state.avatarPreview,className:"mx_CreateCommunityPrototypeDialog_avatar"});return this.state.avatarPreview||(s=r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_placeholderAvatar"})),r.a.createElement(c.a,{className:"mx_CreateCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(l.a)("What's the name of your community or team?")},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colName"},r.a.createElement(d.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(l.a)("Enter name"),label:Object(l.a)("Enter name")}),t,r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"}," ",e),r.a.createElement(h.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(l.a)("Create"))),r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colAvatar"},r.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),r.a.createElement(h.a,{onClick:this.onChangeAvatar,className:"mx_CreateCommunityPrototypeDialog_avatarContainer"},s),r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_tip"},r.a.createElement("b",null,Object(l.a)("Add image (optional)")),r.a.createElement("span",null,Object(l.a)("An image will help people identify your community.")))))))}})||n},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(5),o=s.n(a),r=s(735);function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class l extends o.a{static get instance(){return l._instance||(l._instance=new l),l._instance}storeInvite(e,t){const s=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({roomId:e},t),n=this.generateIdOf(s);return localStorage.setItem("mx_threepid_invite_"+n,JSON.stringify(s)),this.translateInvite(s)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s.startsWith("mx_threepid_invite_")&&e.push(JSON.parse(localStorage.getItem(s)))}return e}getInvites(){return this.getWireInvites().map(e=>this.translateInvite(e))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem("mx_threepid_invite_"+e.id)}generateIdOf(t){return r.base32.stringify(e.from(JSON.stringify(t)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}i()(l,"_instance",void 0)}).call(this,s(27).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s(88),c=s(101),l=s(390),d=s(87),h=s(85),u=s(92),m=s(541);let p=Object(h.a)("views.voip.DialPadModal")(n=class extends o.PureComponent{constructor(e){super(e),a()(this,"numberEntryFieldRef",Object(o.createRef)()),a()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),a()(this,"onChange",e=>{this.setState({value:e.target.value})}),a()(this,"onFormSubmit",e=>{e.preventDefault(),this.onDialPress()}),a()(this,"onDigitPress",(e,t)=>{var s;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(s=this.numberEntryFieldRef.current)||void 0===s||s.focus())}),a()(this,"onDeletePress",e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))}),a()(this,"onDialPress",async()=>{const e={action:u.a.DialNumber,number:this.state.value};d.a.dispatch(e),this.props.onFinished(!0)}),this.state={value:""}}render(){const e=o.createElement(m.a,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?o.createElement(c.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):o.createElement(c.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),o.createElement("div",{className:"mx_DialPadModal"},o.createElement("div",null,o.createElement(r.a,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),o.createElement("div",{className:"mx_DialPadModal_header"},o.createElement("form",{onSubmit:this.onFormSubmit},t)),o.createElement("div",{className:"mx_DialPadModal_dialPad"},o.createElement(l.a,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(87),l=s(84),d=s(86),h=s(85),u=s(97),m=s(96);let p=Object(h.a)("views.dialogs.CreateGroupDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"state",{groupName:"",groupId:"",groupIdError:"",creating:!1,createError:null}),a()(this,"onGroupNameChange",e=>{this.setState({groupName:e.currentTarget.value})}),a()(this,"onGroupIdChange",e=>{this.setState({groupId:e.currentTarget.value})}),a()(this,"onGroupIdBlur",()=>{this.checkGroupId()}),a()(this,"onFormSubmit",e=>{if(e.preventDefault(),this.checkGroupId())return;const t={};""!==this.state.groupName&&(t.name=this.state.groupName),this.setState({creating:!0}),d.a.get().createGroup({localpart:this.state.groupId,profile:t}).then(e=>{c.a.dispatch({action:"view_group",group_id:e.group_id,group_is_new:!0}),this.props.onFinished(!0)}).catch(e=>{this.setState({createError:e})}).finally(()=>{this.setState({creating:!1})})}),a()(this,"onCancel",()=>{this.props.onFinished(!1)})}checkGroupId(){let e=null;return this.state.groupId?/^[a-z0-9=_\-./]*$/.test(this.state.groupId)||(e=Object(l.a)("Community IDs may only contain characters a-z, 0-9, or '=_-./'")):e=Object(l.a)("Community IDs cannot be empty."),this.setState({groupIdError:e,createError:null}),e}render(){if(this.state.creating)return r.a.createElement(m.a,null);let e;return this.state.createError&&(e=r.a.createElement("div",{className:"error",role:"alert"},r.a.createElement("div",null,Object(l.a)("Something went wrong whilst creating your community")),r.a.createElement("div",null,this.state.createError.message))),r.a.createElement(u.a,{className:"mx_CreateGroupDialog",onFinished:this.props.onFinished,title:Object(l.a)("Create Community")},r.a.createElement("form",{onSubmit:this.onFormSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},r.a.createElement("div",{className:"mx_CreateGroupDialog_label"},r.a.createElement("label",{htmlFor:"groupname"},Object(l.a)("Community Name"))),r.a.createElement("div",null,r.a.createElement("input",{id:"groupname",className:"mx_CreateGroupDialog_input",autoFocus:!0,size:64,placeholder:Object(l.a)("Example"),onChange:this.onGroupNameChange,value:this.state.groupName}))),r.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},r.a.createElement("div",{className:"mx_CreateGroupDialog_label"},r.a.createElement("label",{htmlFor:"groupid"},Object(l.a)("Community ID"))),r.a.createElement("div",{className:"mx_CreateGroupDialog_input_group"},r.a.createElement("span",{className:"mx_CreateGroupDialog_prefix"},"+"),r.a.createElement("input",{id:"groupid",className:"mx_CreateGroupDialog_input mx_CreateGroupDialog_input_hasPrefixAndSuffix",size:32,placeholder:Object(l.a)("example"),onChange:this.onGroupIdChange,onBlur:this.onGroupIdBlur,value:this.state.groupId}),r.a.createElement("span",{className:"mx_CreateGroupDialog_suffix"},":",d.a.get().getDomain()))),r.a.createElement("div",{className:"error"},this.state.groupIdError),e),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("input",{type:"submit",value:Object(l.a)("Create"),className:"mx_Dialog_primary"}),r.a.createElement("button",{onClick:this.onCancel},Object(l.a)("Cancel")))))}})||n},function(e,t,s){"use strict";function n(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return n}function i(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return s}s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(95),i=s.n(n),a=s(82),o=s.n(a),r=s(86),c=s(828),l=s(105),d=s(84),h=s(93),u=s(236),m=s(90),p=s(89),g=s(160),v=s(100),f=s(497),b=s(113),y=s(139),E=s(143);const S="ALL_ROOMS",_=Object(g.a)({deriveData:async({value:e})=>{try{return await r.a.get().publicRooms({limit:1,server:e}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(d.a)("Enter a server name")},{key:"available",final:!0,test:async(e,{error:t})=>!t,valid:()=>Object(d.a)("Looks good"),invalid:({error:e})=>"M_FORBIDDEN"===e.errcode?Object(d.a)("You are not allowed to view this server's rooms list"):Object(d.a)("Can't find this server or its room list")}]});t.b=({onOptionChange:e,protocols:t={},selectedServerName:s,selectedInstanceId:n})=>{const[g,w,C,O]=Object(l.p)(),k=Object(u.b)("room_directory_servers"),[R,I]=Object(a.useState)(k),x=(t,s)=>()=>{e(t,s),O()},T=e=>{I(e),p.b.setValue("room_directory_servers",null,v.a.ACCOUNT,e)};let j;if(Object(a.useEffect)(()=>{I(k)},[k]),g){const a=h.a.get().roomDirectory||{},c=r.a.getHomeserverName(),u=new Set(a.servers),p=new Set(R.filter(e=>!u.has(e)&&e!==c)),g=[c,...Array.from(u).filter(e=>e!==c).sort(),...Array.from(p).sort()],v=g.map(i=>{const a=i===s,r=[],h=i===c?Object.values(t):[];let u,v;if(h.length>0&&h.push({instances:[{fields:[],network_id:"",instance_id:S,desc:Object(d.a)("All rooms")}],location_fields:[],user_fields:[],field_types:{},icon:""}),h.forEach(({instances:e=[]})=>{[...e].sort((e,t)=>Object(E.a)(t.desc,e.desc)).forEach(({desc:e,instance_id:t})=>{r.push(o.a.createElement(l.g,{key:String(t),active:a&&t===n,onClick:x(i,t),label:e,className:"mx_NetworkDropdown_server_network"},e))})}),i===c&&(u=o.a.createElement("div",{className:"mx_NetworkDropdown_server_subtitle"},Object(d.a)("Your server"))),p.has(i)){const t=async()=>{O();const{finished:t}=m.a.createTrackedDialog("Network Dropdown","Remove server",b.a,{title:Object(d.a)("Are you sure?"),description:Object(d.a)("Are you sure you want to remove <b>%(serverName)s</b>",{serverName:i},{b:e=>o.a.createElement("b",null,e)}),button:Object(d.a)("Remove"),fixedWidth:!1},"mx_NetworkDropdown_dialog"),[s]=await t;s&&(T(g.filter(e=>e!==i)),a&&e(c,void 0))};v=o.a.createElement(l.e,{onClick:t,label:Object(d.a)("Remove server")})}return o.a.createElement(l.d,{label:i,className:"mx_NetworkDropdown_server",key:i},o.a.createElement("div",{className:"mx_NetworkDropdown_server_title"},i,v),u,o.a.createElement(l.g,{active:a&&!n,onClick:x(i,void 0),label:Object(d.a)("Matrix"),className:"mx_NetworkDropdown_server_network"},Object(d.a)("Matrix")),r)}),C=async()=>{O();const{finished:t}=m.a.createTrackedDialog("Network Dropdown","Add a new server",f.a,{title:Object(d.a)("Add a new server"),description:Object(d.a)("Enter the name of a new server you want to explore."),button:Object(d.a)("Add"),hasCancel:!1,placeholder:Object(d.a)("Server name"),validator:_,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[s,n]=await t;s&&(R.includes(n)||T([...R,n]),e(n))},k=w.current.getBoundingClientRect();j=o.a.createElement(l.n,i()({},(N=k,{right:y.b.instance.windowWidth-N.right,top:N.top,chevronOffset:0,chevronFace:l.a.None}),{onFinished:O,focusLock:!0}),o.a.createElement("div",{className:"mx_NetworkDropdown_menu"},v,o.a.createElement(l.e,{className:"mx_NetworkDropdown_server_add",label:void 0,onClick:C},Object(d.a)("Add a new server..."))))}else{let e;if(n===S)e=Object(d.a)("All rooms");else if(n){const s=Object(c.a)(t,n);e=Object(d.a)("%(networkName)s rooms",{networkName:s.desc})}else e=Object(d.a)("Matrix rooms");j=o.a.createElement(l.b,{className:"mx_NetworkDropdown_handle",onClick:C,isExpanded:g},o.a.createElement("span",null,e)," ",o.a.createElement("span",{className:"mx_NetworkDropdown_handle_server"},"(",s,")"))}var N;return o.a.createElement("div",{className:"mx_NetworkDropdown",ref:w},j)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(85),d=s(88);let h=Object(l.a)("views.elements.DirectorySearchBox")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"input",Object(o.createRef)()),a()(this,"onClearClick",()=>{this.setState({value:""}),this.input.current&&(this.input.current.focus(),this.props.onClear&&this.props.onClear())}),a()(this,"onChange",e=>{this.input.current&&(this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value))}),a()(this,"onKeyUp",e=>{"Enter"==e.key&&this.props.showJoinButton&&this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}),a()(this,"onJoinButtonClick",()=>{this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}),this.state={value:this.props.initialText||""}}render(){let e;return{mx_DirectorySearchBox:!0}[this.props.className]=!0,this.props.showJoinButton&&(e=r.a.createElement(d.a,{className:"mx_DirectorySearchBox_joinButton",onClick:this.onJoinButtonClick},Object(c.a)("Join"))),r.a.createElement("div",{className:`mx_DirectorySearchBox ${this.props.className} mx_textinput`},r.a.createElement("input",{type:"text",name:"dirsearch",value:this.state.value,className:"mx_textinput_icon mx_textinput_search",ref:this.input,onChange:this.onChange,onKeyUp:this.onKeyUp,placeholder:this.props.placeholder,autoFocus:!0}),e,r.a.createElement(d.a,{className:"mx_DirectorySearchBox_clear",onClick:this.onClearClick}))}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(93),r=s(97),c=s(109),l=s(96);t.a=({failures:e,source:t,continuation:s,onFinished:d})=>{const[h,u]=Object(n.useState)(2),[m,p]=Object(n.useState)(!1),[g,v]=Object(n.useState)(!1),[f,b]=Object(n.useState)(!1),y=Object(n.useRef)(d),E=new Map([["_afterCrossSigningLocalKeyChange",Object(a.a)("a new master key signature")],["checkOwnCrossSigningTrust",Object(a.a)("a new cross-signing key signature")],["setDeviceVerification",Object(a.a)("a device cross-signing signature")]]),S=Object(a.a)("a key signature"),_=Object(n.useCallback)(async()=>{try{v(!0);const e=new Promise((e,t)=>{y.current=t}).finally(()=>{p(!0)});await Promise.race([s(),e]),b(!0)}catch(e){u(e=>e-1)}finally{y.current=d,v(!1)}},[s,d]);let w;if(!f&&!m&&s&&h>0){const s=E.get(t)||S,n=o.a.get().brand;w=i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("%(brand)s encountered an error during upload of:",{brand:n})),i.a.createElement("p",null,s),g&&i.a.createElement(l.a,null),i.a.createElement("pre",null,JSON.stringify(e,null,2)),i.a.createElement(c.a,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:_,onCancel:y.current,primaryDisabled:g}))}else w=i.a.createElement("div",null,f?i.a.createElement("span",null,Object(a.a)("Upload completed")):m?i.a.createElement("span",null,Object(a.a)("Cancelled signature upload")):i.a.createElement("span",null,Object(a.a)("Unable to upload")),i.a.createElement(c.a,{primaryButton:Object(a.a)("OK"),hasCancel:!1,onPrimaryButtonClick:d}));return i.a.createElement(r.a,{title:f?Object(a.a)("Signature upload success"):Object(a.a)("Signature upload failed"),fixedWidth:!1,onFinished:()=>{}},w)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(85),h=s(103),u=s(833),m=s(834),p=s(125),g=s(96),v=s(546),f=s(97),b=s(109),y=s(1);let E=Object(d.a)("views.dialogs.IncomingSasDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"showSasEvent",void 0),a()(this,"onFinished",()=>{this.props.onFinished(3===this.state.phase)}),a()(this,"onCancelClick",()=>{this.props.onFinished(3===this.state.phase)}),a()(this,"onContinueClick",()=>{this.setState({phase:2}),this.props.verifier.verify().then(()=>{this.setState({phase:3})}).catch(e=>{y.a.log("Verification failed",e)})}),a()(this,"onVerifierShowSas",e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})}),a()(this,"onVerifierCancel",()=>{this.setState({phase:4})}),a()(this,"onSasMatchesClick",()=>{this.showSasEvent.confirm(),this.setState({phase:2})}),a()(this,"onVerifiedDoneClick",()=>{this.props.onFinished(!0)});let t=0;this.props.verifier.hasBeenCancelled&&(y.a.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null},this.props.verifier.on("show_sas",this.onVerifierShowSas),this.props.verifier.on("cancel",this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener("show_sas",this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await c.a.get().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){const e=this.props.verifier.userId===c.a.get().getUserId();let t;const s=this.state.opponentProfile;if(s){const e=s.avatar_url?Object(h.b)(s.avatar_url).getSquareThumbnailHttp(48):null;t=r.a.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},r.a.createElement(p.a,{name:s.displayname,idName:this.props.verifier.userId,url:e,width:48,height:48,resizeMethod:"crop"}),r.a.createElement("h2",null,s.displayname))}else t=this.state.opponentProfileError?r.a.createElement("div",null,r.a.createElement(p.a,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,width:48,height:48}),r.a.createElement("h2",null,this.props.verifier.userId)):r.a.createElement(g.a,null);const n=[r.a.createElement("p",{key:"p1"},Object(l.a)("Verify this user to mark them as trusted. Trusting users gives you extra peace of mind when using end-to-end encrypted messages.")),r.a.createElement("p",{key:"p2"},Object(l.a)("Verifying this user will mark their session as trusted, and also mark your session as trusted to them."))],i=[r.a.createElement("p",{key:"p1"},Object(l.a)("Verify this device to mark it as trusted. Trusting this device gives you and other users extra peace of mind when using end-to-end encrypted messages.")),r.a.createElement("p",{key:"p2"},Object(l.a)("Verifying this device will mark it as trusted, and users who have verified with you will trust this device."))];return r.a.createElement("div",null,t,e?i:n,r.a.createElement(b.a,{primaryButton:Object(l.a)("Continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return r.a.createElement(v.a,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===c.a.get().getUserId(),inDialog:!0})}renderPhaseWaitForPartnerToConfirm(){return r.a.createElement("div",null,r.a.createElement(g.a,null),r.a.createElement("p",null,Object(l.a)("Waiting for partner to confirm...")))}renderPhaseVerified(){return r.a.createElement(u.a,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return r.a.createElement(m.a,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return r.a.createElement(f.a,{title:Object(l.a)("Incoming Verification Request"),onFinished:this.onFinished,fixedWidth:!1},e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(84),r=s(85),c=s(109);let l=Object(r.a)("views.verification.VerificationComplete")(n=class extends a.a.Component{render(){return a.a.createElement("div",null,a.a.createElement("h2",null,Object(o.a)("Verified!")),a.a.createElement("p",null,Object(o.a)("You've successfully verified this user.")),a.a.createElement("p",null,Object(o.a)("Secure messages with this user are end-to-end encrypted and not able to be read by third parties.")),a.a.createElement(c.a,{onPrimaryButtonClick:this.props.onDone,primaryButton:Object(o.a)("Got It"),hasCancel:!1}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(84),r=s(85),c=s(109);let l=Object(r.a)("views.verification.VerificationCancelled")(n=class extends a.a.Component{render(){return a.a.createElement("div",null,a.a.createElement("p",null,Object(o.a)("The other party cancelled the verification.")),a.a.createElement(c.a,{primaryButton:Object(o.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(547),d=s(544),h=s(85),u=s(88),m=s(550),p=s(218);let g=Object(h.a)("structures.auth.CompleteSecurity")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onStoreUpdate",()=>{const e=l.b.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})}),a()(this,"onSkipClick",()=>{l.b.sharedInstance().skip()});const t=l.b.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=l.b.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let s,n,i;if(e===l.a.Loading)return null;if(e===l.a.Intro)t?(s=r.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(c.a)("Unable to verify this login")):(s=r.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(c.a)("Verify this login"));else if(e===l.a.Done)s=r.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),n=Object(c.a)("Session verified");else if(e===l.a.ConfirmSkip)s=r.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(c.a)("Are you sure?");else if(e===l.a.Busy)s=r.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(c.a)("Verify this login");else if(e===l.a.ConfirmReset)s=r.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(c.a)("Really reset verification keys?");else if(e!==l.a.Finished)throw new Error("Unknown phase "+e);return e!==l.a.Intro&&e!==l.a.ConfirmReset||(i=r.a.createElement(u.a,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":Object(c.a)("Skip verification for now")})),r.a.createElement(p.a,null,r.a.createElement(m.a,null,r.a.createElement("h2",{className:"mx_CompleteSecurity_header"},s,n,i),r.a.createElement("div",{className:"mx_CompleteSecurity_body"},r.a.createElement(d.a,{onFinished:this.props.onFinished}))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(84),a=s(82),o=s.n(a),r=s(85);let c=Object(r.a)("views.auth.AuthFooter")(n=class extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_AuthFooter"},o.a.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},Object(i.a)("powered by Matrix")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(83),i=s.n(n);class a{constructor(e,t,s,n){this.resizer=t,this.sizer=s,this.container=n,i()(this,"domNode",void 0),i()(this,"id",void 0),i()(this,"reverse",void 0),this.reverse=t.isReverseResizeHandle(e),this.domNode=n||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,s,n){return new(0,this.constructor)(e,t,s,n)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const s=e!==this.reverse;do{t=s?t.nextElementSibling:t.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){this.setRawSize(Math.round(e)+"px");const t=this.resizer.config.onResized;t&&t(e,this.id,this.domNode)}clearSize(){this.sizer.clearItemSize(this.domNode);const e=this.resizer.config.onResized;e&&e(null,this.id,this.domNode)}first(){const e=Array.from(this.domNode.parentElement.children).find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}last(){const e=Array.from(this.domNode.parentElement.children).reverse().find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e,t,s){this.container=e,this.vertical=t,this.reverse=s}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.height=null:e.style.width=null}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return a}));var n=s(82);const i=(e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setTimeout(()=>{s.current()},t);return()=>clearTimeout(e)},[t])},a=(e,t,s)=>{const[i,a]=Object(n.useState)(s);return((e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setInterval(()=>{s.current()},t);return()=>clearInterval(e)},[t])})(()=>a(e=>e-1),t),0===i&&e(),i}},function(e,t,s){"use strict";s.d(t,"a",(function(){return M}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s(91),d=s.n(l),h=s(87),u=s(84),m=s(517),p=s(151),g=s(518),v=s(92),f=s(841),b=s(845),y=s(846),E=s(847),S=s(123),_=s(165),w=s(848),C=s(111),O=s(849),k=s(1030),R=s(85),I=s(106),x=s(185),T=s(195),j=s(139),N=s(155),P=s(98),D=s(108);let M=Object(R.a)("structures.LeftPanel")((a=i=class extends c.Component{constructor(e){super(e),r()(this,"ref",Object(c.createRef)()),r()(this,"listContainerRef",Object(c.createRef)()),r()(this,"roomSearchRef",Object(c.createRef)()),r()(this,"roomListRef",Object(c.createRef)()),r()(this,"focusedElement",null),r()(this,"isDoingStickyHeaders",!1),r()(this,"context",void 0),r()(this,"updateActiveSpace",e=>{this.setState({activeSpace:e})}),r()(this,"onDialPad",()=>{h.a.fire(v.a.OpenDialPad)}),r()(this,"onExplore",()=>{h.a.fire(v.a.ViewRoomDirectory)}),r()(this,"refreshStickyHeaders",()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)}),r()(this,"onBreadcrumbsUpdate",()=>{const e=E.a.instance.visible;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}}),r()(this,"onScroll",e=>{const t=e.target;this.handleStickyHeaders(t)}),r()(this,"onFocus",e=>{this.focusedElement=e.target}),r()(this,"onBlur",()=>{this.focusedElement=null}),r()(this,"onKeyDown",(e,t)=>{if(!this.focusedElement)return;switch(Object(T.f)().getRoomListAction(e)){case T.e.NextRoom:var s;if(!t)e.stopPropagation(),e.preventDefault(),null===(s=this.roomListRef.current)||void 0===s||s.focus();break;case T.e.PrevRoom:var n;if(t&&t.activeRef===Object(N.e)(t.refs,0))e.stopPropagation(),e.preventDefault(),null===(n=this.roomSearchRef.current)||void 0===n||n.focus()}}),r()(this,"onRoomListKeydown",e=>{var t;if(!(e.altKey||e.ctrlKey||e.metaKey))if(1===e.key.length)e.preventDefault(),e.stopPropagation(),null===(t=this.roomSearchRef.current)||void 0===t||t.appendChar(e.key);else if(e.key===D.a.BACKSPACE){var s;e.preventDefault(),e.stopPropagation(),null===(s=this.roomSearchRef.current)||void 0===s||s.backspace()}}),r()(this,"selectRoom",()=>{const e=this.listContainerRef.current.querySelector(".mx_RoomTile");if(e)return e.click(),!0}),this.state={showBreadcrumbs:E.a.instance.visible,activeSpace:I.a.instance.activeSpace},E.a.instance.on(S.b,this.onBreadcrumbsUpdate),_.b.instance.on(_.a,this.onBreadcrumbsUpdate),I.a.instance.on(x.d,this.updateActiveSpace)}componentDidMount(){var e;j.b.instance.trackElementDimensions("LeftPanel",this.ref.current),j.b.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),j.b.instance.on("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.addEventListener("scroll",this.onScroll,{passive:!0})}componentWillUnmount(){var e;E.a.instance.off(S.b,this.onBreadcrumbsUpdate),_.b.instance.off(_.a,this.onBreadcrumbsUpdate),I.a.instance.off(x.d,this.updateActiveSpace),j.b.instance.stopTrackingElementDimensions("ListContainer"),j.b.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame(()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1}))}doStickyHeaders(e){const t=e.scrollTop,s=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),i=new Map;let a,o;for(const e of n){const r=e.querySelector(".mx_RoomSublist_stickable");r.style.removeProperty("display");const c=.4,l=e.offsetTop+c*g.a<=t,d=e.offsetTop+c*g.a>=s;l||e===n[0]?(i.set(r,{stickyTop:!0}),a&&(a.style.display="none",i.set(a,{makeInvisible:!0})),a=r):d&&!o?(i.set(r,{stickyBottom:!0}),o=r):i.set(r,{})}for(const t of i.keys()){const s=i.get(t);if(s.makeInvisible)t.style.display="none";else{if(s.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const s=e.parentElement.offsetTop+"px";t.style.top!==s&&(t.style.top=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const s=j.b.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)+"px";t.style.bottom!==s&&(t.style.bottom=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(s.stickyTop||s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=j.b.instance.getElementDimensions("ListContainer");if(e){const s=15,n=e.width-s+"px";t.style.width!==n&&(t.style.width=n)}}else s.stickyTop||s.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const r=e.parentElement;a?r.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),o?r.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom")}renderHeader(){return c.createElement("div",{className:"mx_LeftPanel_userHeader"},c.createElement(f.a,{isMinimized:this.props.isMinimized}))}renderBreadcrumbs(){if(this.state.showBreadcrumbs&&!this.props.isMinimized)return c.createElement(w.a,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},c.createElement(y.a,null))}renderSearchDialExplore(){let e=null;p.d.sharedInstance().getSupportsPstnProtocol()&&(e=c.createElement(C.a,{className:d()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:Object(u.a)("Open dial pad")}));const t="!"===this.state.activeSpace[0]?this.context.getRoom(this.state.activeSpace):null;return c.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},c.createElement(b.a,{isMinimized:this.props.isMinimized,ref:this.roomSearchRef,onSelectRoom:this.selectRoom}),e,c.createElement(C.a,{className:d()("mx_LeftPanel_exploreButton",{mx_LeftPanel_exploreButton_space:!!this.state.activeSpace}),onClick:this.onExplore,title:t?Object(u.a)("Explore %(spaceName)s",{spaceName:t.name}):Object(u.a)("Explore rooms")}))}render(){const e=c.createElement(m.b,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef}),t=d()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),s=d()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return c.createElement("div",{className:t,ref:this.ref},c.createElement("aside",{className:"mx_LeftPanel_roomListContainer"},this.renderHeader(),this.renderSearchDialExplore(),this.renderBreadcrumbs(),c.createElement(O.a,{onVisibilityChange:this.refreshStickyHeaders}),c.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},c.createElement("div",{className:s,ref:this.listContainerRef,tabIndex:-1,onKeyDown:this.onRoomListKeydown},e)),!this.props.isMinimized&&c.createElement(k.a,null)))}},r()(i,"contextType",P.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return H}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(86),h=s(87),u=s(92),m=s(84),p=s(105),g=s(158),v=s(842),f=s(90),b=s(556),y=s(89),E=s(88),S=s(93),_=s(548),w=s(228),C=s(123),O=s(125),k=s(111),R=s(100),I=s(168),x=s(193),T=s(190),j=s(159),N=s(122),P=s(104),D=s(843),M=s(115),A=s(844),U=s(106),L=s(185),F=s(219),B=s(85),V=s(145),K=s(510),W=s(266),G=s(1);let H=Object(B.a)("structures.UserMenu")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"themeInUseWatcherRef",void 0),a()(this,"dndWatcherRef",void 0),a()(this,"buttonRef",Object(o.createRef)()),a()(this,"tagStoreRef",void 0),a()(this,"onRoom",e=>{this.removePendingJoinRoom(e.roomId)}),a()(this,"onTagStoreUpdate",()=>{this.forceUpdate()}),a()(this,"onProfileUpdate",async()=>{this.forceUpdate()}),a()(this,"onSelectedSpaceUpdate",async()=>{this.setState({selectedSpace:U.a.instance.activeSpaceRoom})}),a()(this,"onThemeInUseChanged",()=>{this.setState({themeInUse:y.b.getValue("theme_in_use")})}),a()(this,"onAction",e=>{switch(e.action){case u.a.ToggleUserMenu:this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click();break;case u.a.JoinRoom:this.addPendingJoinRoom(e.roomId);break;case u.a.JoinRoomReady:case u.a.JoinRoomError:this.removePendingJoinRoom(e.roomId)}}),a()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),a()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})}),a()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),a()(this,"onSwitchThemeClick",e=>{e.preventDefault(),e.stopPropagation();const t=this.state.themeInUse===W.a.Dark?W.a.Light:W.a.Dark;y.b.setValue("theme_in_use",null,R.a.DEVICE,t)}),a()(this,"onSettingsOpen",(e,t)=>{e.preventDefault(),e.stopPropagation();const s={action:u.a.ViewUserSettings,initialTabId:t};h.a.dispatch(s),this.setState({contextMenuPosition:null})}),a()(this,"onShowArchived",e=>{e.preventDefault(),e.stopPropagation(),G.a.log("TODO: Show archived rooms")}),a()(this,"onProvideFeedback",e=>{e.preventDefault(),e.stopPropagation(),f.a.createTrackedDialog("Feedback Dialog","",v.a),this.setState({contextMenuPosition:null})}),a()(this,"onSignOutClick",async e=>{var t;e.preventDefault(),e.stopPropagation();const s=d.a.get();s&&s.isCryptoEnabled()&&null!==(t=await s.exportRoomKeys())&&void 0!==t&&t.length?f.a.createTrackedDialog("Logout from LeftPanel","",b.a):h.a.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})}),a()(this,"onSignInClick",()=>{h.a.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})}),a()(this,"onRegisterClick",()=>{h.a.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})}),a()(this,"onHomeClick",e=>{e.preventDefault(),e.stopPropagation(),h.a.dispatch({action:"view_home_page"}),this.setState({contextMenuPosition:null})}),a()(this,"onCommunitySettingsClick",e=>{e.preventDefault(),e.stopPropagation(),f.a.createTrackedDialog("Edit Community","",D.a,{communityId:x.a.instance.getSelectedCommunityId()}),this.setState({contextMenuPosition:null})}),a()(this,"onCommunityMembersClick",e=>{e.preventDefault(),e.stopPropagation();const t=x.a.instance.getSelectedCommunityGeneralChat();t?(h.a.dispatch({action:u.a.ViewRoom,room_id:t.roomId},!0),h.a.dispatch({action:u.a.SetRightPanelPhase,phase:N.c.RoomMemberList})):f.a.createTrackedDialog("Failed to find general chat","",P.a,{title:Object(m.a)("Failed to find the general chat for this community"),description:Object(m.a)("Failed to find the general chat for this community")}),this.setState({contextMenuPosition:null})}),a()(this,"onCommunityInviteClick",e=>{e.preventDefault(),e.stopPropagation(),Object(j.e)(x.a.instance.getSelectedCommunityId()),this.setState({contextMenuPosition:null})}),a()(this,"onDndToggle",e=>{e.stopPropagation();const t=y.b.getValue("doNotDisturb");y.b.setValue("doNotDisturb",null,R.a.DEVICE,!t)}),a()(this,"renderContextMenu",()=>{if(!this.state.contextMenuPosition)return null;const e=x.a.instance.getSelectedCommunityName();let t;const n=S.a.get().hostSignup;if(d.a.get().isGuest())t=r.a.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},Object(m.a)("Got an account? <a>Sign in</a>",{},{a:e=>r.a.createElement(E.a,{kind:"link",onClick:this.onSignInClick},e)}),Object(m.a)("New here? <a>Create an account</a>",{},{a:e=>r.a.createElement(E.a,{kind:"link",onClick:this.onRegisterClick},e)}));else if(n&&n&&n.url){const e=n.domains||[],s=d.a.get().getDomain(),i=e.filter(e=>e===s||s.endsWith("."+e));(!n.domains||i.length>0)&&(t=r.a.createElement(A.a,{onClick:this.onCloseMenu}))}let i,a=null;this.hasHomePage&&(a=r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconHome",label:Object(m.a)("Home"),onClick:this.onHomeClick})),y.b.getValue(M.b.Feedback)&&(i=r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconMessage",label:Object(m.a)("Feedback"),onClick:this.onProvideFeedback}));let o=r.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},r.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},w.a.instance.displayName),r.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},d.a.get().getUserId())),c=r.a.createElement(r.a.Fragment,null,r.a.createElement(I.c,null,a,r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconBell",label:Object(m.a)("Notification settings"),onClick:e=>this.onSettingsOpen(e,g.a.Notifications)}),r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconLock",label:Object(m.a)("Security & privacy"),onClick:e=>this.onSettingsOpen(e,g.a.Security)}),r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(m.a)("All settings"),onClick:e=>this.onSettingsOpen(e,null)}),i),r.a.createElement(I.c,{red:!0},r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(m.a)("Sign out"),onClick:this.onSignOutClick}))),h=null;if(e){const t=x.a.instance.getSelectedCommunityId();let s,n;o=r.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},r.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},e)),x.a.instance.canInviteTo(t)&&(n=r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconInvite",label:Object(m.a)("Invite"),onClick:this.onCommunityInviteClick})),x.a.instance.isAdminOf(t)&&(s=r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(m.a)("Settings"),"aria-label":Object(m.a)("Community settings"),onClick:this.onCommunitySettingsClick})),c=r.a.createElement(I.c,null,s,r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconMembers",label:Object(m.a)("Members"),onClick:this.onCommunityMembersClick}),n),h=r.a.createElement(r.a.Fragment,null,r.a.createElement("hr",null),r.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},r.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},r.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},w.a.instance.displayName),r.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},d.a.get().getUserId()))),r.a.createElement(I.c,null,r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(m.a)("Settings"),"aria-label":Object(m.a)("User settings"),onClick:e=>this.onSettingsOpen(e,null)}),i),r.a.createElement(I.c,{red:!0},r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(m.a)("Sign out"),onClick:this.onSignOutClick})))}else d.a.get().isGuest()&&(c=r.a.createElement(r.a.Fragment,null,r.a.createElement(I.c,null,a,r.a.createElement(I.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(m.a)("Settings"),onClick:e=>this.onSettingsOpen(e,null)}),i)));const u=l()({mx_UserMenu_contextMenu:!0,mx_UserMenu_contextMenu_prototype:!!e});return r.a.createElement(I.e,{left:this.state.contextMenuPosition.width+this.state.contextMenuPosition.left-10,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height+8,onFinished:this.onCloseMenu,className:u},r.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},o,this.state.themeInUse!==W.a.System?r.a.createElement(k.a,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.themeInUse===W.a.Dark?Object(m.a)("Switch to light mode"):Object(m.a)("Switch to dark mode")},r.a.createElement("img",{src:s(1569),alt:Object(m.a)("Switch theme"),width:16})):null),t,c,h)}),this.state={contextMenuPosition:null,themeInUse:y.b.getValue("theme_in_use"),pendingRoomJoin:new Set,selectedSpace:U.a.instance.activeSpaceRoom},w.a.instance.on(C.b,this.onProfileUpdate),U.a.spacesEnabled&&U.a.instance.on(L.d,this.onSelectedSpaceUpdate),this.dndWatcherRef=y.b.watchSetting("doNotDisturb",null,()=>this.forceUpdate())}get hasHomePage(){return!!Object(_.a)(S.a.get())}componentDidMount(){this.dispatcherRef=h.a.register(this.onAction),this.themeInUseWatcherRef=y.b.watchSetting("theme_in_use",null,this.onThemeInUseChanged),this.tagStoreRef=T.a.addListener(this.onTagStoreUpdate),d.a.get().on("Room",this.onRoom)}componentWillUnmount(){this.themeInUseWatcherRef&&y.b.unwatchSetting(this.themeInUseWatcherRef),this.dndWatcherRef&&y.b.unwatchSetting(this.dndWatcherRef),this.dispatcherRef&&h.a.unregister(this.dispatcherRef),w.a.instance.off(C.b,this.onProfileUpdate),this.tagStoreRef.remove(),U.a.spacesEnabled&&U.a.instance.off(L.d,this.onSelectedSpaceUpdate),d.a.get().removeListener("Room",this.onRoom)}addPendingJoinRoom(e){this.setState({pendingRoomJoin:new Set(this.state.pendingRoomJoin).add(e)})}removePendingJoinRoom(e){this.state.pendingRoomJoin.delete(e)&&this.setState({pendingRoomJoin:new Set(this.state.pendingRoomJoin)})}render(){const e=d.a.get().getUserId(),t=w.a.instance.displayName||e,s=w.a.instance.getHttpAvatarUrl(32),n=x.a.instance.getSelectedCommunityName();let i,a=!1,o=Object(m.a)("User menu"),c=r.a.createElement("span",{className:"mx_UserMenu_userName"},t),h=r.a.createElement("span",{className:"mx_UserMenu_headerButtons"});if(this.state.selectedSpace)c=r.a.createElement("div",{className:"mx_UserMenu_doubleName"},r.a.createElement("span",{className:"mx_UserMenu_userName"},t),r.a.createElement(F.a,{room:this.state.selectedSpace},e=>r.a.createElement("span",{className:"mx_UserMenu_subUserName"},e)));else if(n)c=r.a.createElement("div",{className:"mx_UserMenu_doubleName"},r.a.createElement("span",{className:"mx_UserMenu_userName"},n),r.a.createElement("span",{className:"mx_UserMenu_subUserName"},t)),o=Object(m.a)("Community and user menu"),a=!0;else if(y.b.getValue("feature_communities_v2_prototypes"))c=r.a.createElement("div",{className:"mx_UserMenu_doubleName"},r.a.createElement("span",{className:"mx_UserMenu_userName"},Object(m.a)("Home")),r.a.createElement("span",{className:"mx_UserMenu_subUserName"},t)),a=!0;else if(y.b.getValue("feature_dnd")){const e=y.b.getValue("doNotDisturb");i=r.a.createElement(E.a,{onClick:this.onDndToggle,className:l()({mx_UserMenu_dnd:!0,mx_UserMenu_dnd_noisy:!e,mx_UserMenu_dnd_muted:e})})}this.props.isMinimized&&(c=null,h=null);const u=l()({mx_UserMenu:!0,mx_UserMenu_minimized:this.props.isMinimized,mx_UserMenu_prototype:a});return r.a.createElement(r.a.Fragment,null,r.a.createElement(p.b,{className:u,onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:o,isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},r.a.createElement("div",{className:"mx_UserMenu_row"},r.a.createElement("span",{className:"mx_UserMenu_userAvatarContainer"},r.a.createElement(O.a,{idName:e,name:t,url:s,width:32,height:32,resizeMethod:"crop",className:"mx_UserMenu_userAvatar"})),c,this.state.pendingRoomJoin.size>0&&r.a.createElement(V.a,null,r.a.createElement(K.a,{helpText:Object(m.a)("Currently joining %(count)s rooms",{count:this.state.pendingRoomJoin.size})})),i,h)),this.renderContextMenu())}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(113),o=s(84),r=s(101),c=s(88),l=s(124),d=s(93),h=s(90),u=s(200),m=s(166),p=s(216);t.a=e=>{const[t,s]=Object(n.useState)(),[g,v]=Object(n.useState)(""),f=()=>{e.onFinished(),h.a.createTrackedDialog("Bug Report Dialog","",u.a,{})},b=l.a.instance.canEnable(),y=d.a.get().brand;let E,S;b&&(E=i.a.createElement(i.a.Fragment,null,i.a.createElement("hr",null),i.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},i.a.createElement("h3",null,Object(o.a)("Rate %(brand)s",{brand:y})),i.a.createElement("p",null,Object(o.a)("Tell us below how you feel about %(brand)s so far.",{brand:y})),i.a.createElement("p",null,Object(o.a)("Please go into as much detail as you like, so we can track down the problem.")),i.a.createElement(p.a,{name:"feedbackRating",value:String(t),onChange:e=>s(parseInt(e,10)),definitions:[{value:"1",label:"😠"},{value:"2",label:"😞"},{value:"3",label:"😑"},{value:"4",label:"😄"},{value:"5",label:"😍"}]}),i.a.createElement(r.a,{id:"feedbackComment",label:Object(o.a)("Add comment"),placeholder:Object(o.a)("Comment"),type:"text",autoComplete:"off",value:g,element:"textarea",onChange:e=>{v(e.target.value)}})))),b&&(S=i.a.createElement("h2",null,Object(o.a)("There are two ways you can provide feedback and help us improve %(brand)s.",{brand:y})));let _=null;return d.a.get().bug_report_endpoint_url&&(_=i.a.createElement("p",null,Object(o.a)("PRO TIP: If you start a bug, please submit <debugLogsLink>debug logs</debugLogsLink> to help us track down the problem.",{},{debugLogsLink:e=>i.a.createElement(c.a,{kind:"link",onClick:f},e)}))),i.a.createElement(a.a,{className:"mx_FeedbackDialog",hasCancelButton:!!b,title:Object(o.a)("Feedback"),description:i.a.createElement(i.a.Fragment,null,S,i.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},i.a.createElement("h3",null,Object(o.a)("Report a bug")),i.a.createElement("p",null,Object(o.a)("Please view <existingIssuesLink>existing bugs on Github</existingIssuesLink> first. No match? <newIssueLink>Start a new one</newIssueLink>.",{},{existingIssuesLink:e=>i.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/SchildiChat/schildichat-desktop/issues?q=is%3Aopen+is%3Aissue+sort%3Areactions-%2B1-desc"},e),newIssueLink:e=>i.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose"},e)})),_),E),button:b?Object(o.a)("Send feedback"):Object(o.a)("Go back"),buttonDisabled:b&&!t,onFinished:s=>{b&&s&&(l.a.instance.reportFeedback(t,g),h.a.createTrackedDialog("Feedback sent","",m.a,{title:Object(o.a)("Feedback sent"),description:Object(o.a)("Thank you!")})),e.onFinished()}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(97),l=s(84),d=s(101),h=s(88),u=s(86),m=s(193),p=s(183),g=s(85),v=s(103),f=s(1);let b=Object(g.a)("views.dialogs.EditCommunityPrototypeDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"avatarUploadRef",r.a.createRef()),a()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),a()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e=this.state.currentAvatarUrl||"";this.state.avatarFile&&(e=await u.a.get().uploadContent(this.state.avatarFile)),await u.a.get().setGroupProfile(this.props.communityId,{name:this.state.name,avatar_url:e}),await p.a.refreshGroupProfile(u.a.get(),this.props.communityId),this.props.onFinished(!0)}catch(e){f.a.error(e),this.setState({busy:!1,error:Object(l.a)("There was an error updating your community. The server is unable to process your request.")})}}}),a()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),a()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()});const t=m.a.instance.getCommunityProfile(e.communityId);this.state={name:(null==t?void 0:t.name)||"",error:null,busy:!1,avatarFile:null,avatarPreview:null,currentAvatarUrl:null==t?void 0:t.avatarUrl}}render(){let e=r.a.createElement("img",{src:this.state.avatarPreview,className:"mx_EditCommunityPrototypeDialog_avatar"});if(!this.state.avatarPreview)if(this.state.currentAvatarUrl){const t=Object(v.b)(this.state.currentAvatarUrl).srcHttp;e=r.a.createElement("img",{src:t,className:"mx_EditCommunityPrototypeDialog_avatar"})}else e=r.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_placeholderAvatar"});return r.a.createElement(c.a,{className:"mx_EditCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(l.a)("Update community")},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowName"},r.a.createElement(d.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(l.a)("Enter name"),label:Object(l.a)("Enter name")})),r.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowAvatar"},r.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),r.a.createElement(h.a,{onClick:this.onChangeAvatar,className:"mx_EditCommunityPrototypeDialog_avatarContainer"},e),r.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_tip"},r.a.createElement("b",null,Object(l.a)("Add image (optional)")),r.a.createElement("span",null,Object(l.a)("An image will help people identify your community.")))),r.a.createElement(h.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(l.a)("Save")))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(168),l=s(84),d=s(557),h=s(93),u=s(85);let m=Object(u.a)("structures.HostSignupAction")(n=class extends r.a.PureComponent{constructor(...e){super(...e),a()(this,"openDialog",async()=>{var e,t;null===(e=(t=this.props).onClick)||void 0===e||e.call(t),await d.a.instance.setHostSignupActive(!0)})}render(){const e=h.a.get().hostSignup;return null!=e&&e.brand?r.a.createElement(c.c,null,r.a.createElement(c.b,{iconClassName:"mx_UserMenu_iconHosting",label:Object(l.a)("Upgrade to %(hostSignupBrand)s",{hostSignupBrand:e.brand}),onClick:this.openDialog})):null}})||n},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s(91),c=s.n(r),l=s(87),d=s(84),h=s(88),u=s(92),m=s(165),p=s(767),g=s(195),v=s(85),f=s(106),b=s(185);let y=Object(v.a)("structures.RoomSearch")(n=class extends o.PureComponent{constructor(t){super(t),a()(this,"dispatcherRef",void 0),a()(this,"inputRef",Object(o.createRef)()),a()(this,"searchFilter",new p.a),a()(this,"onSpaces",e=>{this.setState({inSpaces:e.length>0})}),a()(this,"onAction",e=>{e.action===u.a.ViewRoom&&e.clear_search?this.clearInput():"focus_room_filter"===e.action&&this.inputRef.current&&this.inputRef.current.focus()}),a()(this,"clearInput",()=>{this.inputRef.current&&(this.inputRef.current.value="",this.onChange())}),a()(this,"openSearch",()=>{l.a.dispatch({action:"show_left_panel"}),l.a.dispatch({action:"focus_room_filter"})}),a()(this,"onChange",()=>{this.inputRef.current&&this.setState({query:this.inputRef.current.value})}),a()(this,"onFocus",e=>{this.setState({focused:!0}),e.target.select()}),a()(this,"onBlur",e=>{this.setState({focused:!1})}),a()(this,"onKeyDown",t=>{switch(Object(g.f)().getRoomListAction(t)){case g.e.ClearSearch:this.clearInput(),l.a.fire(u.a.FocusSendMessageComposer);break;case g.e.SelectRoom:this.props.onSelectRoom()&&e(()=>{this.clearInput()});break}}),this.state={query:"",focused:!1,inSpaces:!1},this.dispatcherRef=l.a.register(this.onAction),f.a.instance.on(b.d,this.clearInput),f.a.instance.on(b.f,this.onSpaces)}componentDidUpdate(e,t){if(t.query!==this.state.query){const e=!!this.searchFilter.search.trim(),t=!!this.state.query.trim();this.searchFilter.search=this.state.query,!e&&t?m.b.instance.addFilter(this.searchFilter):e&&!t&&m.b.instance.removeFilter(this.searchFilter)}}componentWillUnmount(){l.a.unregister(this.dispatcherRef),f.a.instance.off(b.d,this.clearInput),f.a.instance.off(b.f,this.onSpaces)}focus(){var e;null===(e=this.inputRef.current)||void 0===e||e.focus()}render(){const e=c()({mx_RoomSearch:!0,mx_RoomSearch_hasQuery:this.state.query,mx_RoomSearch_focused:this.state.focused,mx_RoomSearch_minimized:this.props.isMinimized}),t=c()({mx_RoomSearch_input:!0,mx_RoomSearch_inputExpanded:this.state.query||this.state.focused});let s=Object(d.a)("Filter");this.state.inSpaces&&(s=Object(d.a)("Filter all spaces"));let n=o.createElement("div",{className:"mx_RoomSearch_icon"}),i=o.createElement("input",{type:"text",ref:this.inputRef,className:t,value:this.state.query,onFocus:this.onFocus,onBlur:this.onBlur,onChange:this.onChange,onKeyDown:this.onKeyDown,placeholder:s,autoComplete:"off"}),a=o.createElement(h.a,{tabIndex:-1,title:Object(d.a)("Clear filter"),className:"mx_RoomSearch_clearButton",onClick:this.clearInput});return this.props.isMinimized&&(n=o.createElement(h.a,{title:Object(d.a)("Filter rooms and people"),className:"mx_RoomSearch_icon mx_RoomSearch_minimizedHandle",onClick:this.openSearch}),i=null,a=null),o.createElement("div",{className:e},n,i,a)}appendChar(e){this.setState({query:this.state.query+e})}backspace(){this.setState({query:this.state.query.substring(0,this.state.query.length-1)})}})||n}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(847),l=s(284),d=s(84),h=s(87),u=s(140),m=s(123),p=s(746),g=s(155),v=s(511),f=s(85);let b=Object(f.a)("views.rooms.RoomBreadcrumbs")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"isMounted",!0),a()(this,"onBreadcrumbsUpdate",()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),setTimeout(()=>this.setState({doAnimation:!0,skipFirst:!1}),0))}),a()(this,"viewRoom",(e,t)=>{u.a.trackEvent("Breadcrumbs","click_node",String(t)),h.a.dispatch({action:"view_room",room_id:e.roomId})}),this.state={doAnimation:!0,skipFirst:!1},c.a.instance.on(m.b,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,c.a.instance.off(m.b,this.onBreadcrumbsUpdate)}render(){const e=c.a.instance.rooms.map((e,t)=>r.a.createElement(g.b,{className:"mx_RoomBreadcrumbs_crumb",key:e.roomId,onClick:()=>this.viewRoom(e,t),"aria-label":Object(d.a)("Room %(name)s",{name:e.name}),title:e.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip"},r.a.createElement(l.a,{room:e,avatarSize:32,displayBadge:!0,forceCount:!0})));return e.length>0?r.a.createElement(p.CSSTransition,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},r.a.createElement(v.a,{className:"mx_RoomBreadcrumbs","aria-label":Object(d.a)("Recently visited rooms")},e.slice(this.state.skipFirst?1:0))):r.a.createElement("div",{className:"mx_RoomBreadcrumbs"},r.a.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},Object(d.a)("No recently visited rooms")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(83),i=s.n(n),a=s(89),o=s(164),r=s(87),c=s(116),l=s(4),d=s(100),h=s(106),u=s(92);class m extends o.a{constructor(){super(r.a),i()(this,"waitingRooms",[]),i()(this,"onMyMembership",async e=>{const t=a.b.getValue("breadcrumbs",null,!0);this.meetsRoomRequirement&&Object(l.v)(t)&&await a.b.setValue("breadcrumbs",null,d.a.ACCOUNT,!0)}),i()(this,"onRoom",async e=>{const t=this.waitingRooms.find(t=>t.roomId===e.roomId);t&&(this.waitingRooms.splice(this.waitingRooms.indexOf(t),1),Date.now()-t.addedTs>9e4||await this.appendRoom(e))}),a.b.monitorSetting("breadcrumb_rooms",null),a.b.monitorSetting("breadcrumbs",null)}static get instance(){return m.internalInstance}get rooms(){return this.state.rooms||[]}get visible(){return this.state.enabled&&this.meetsRoomRequirement}get meetsRoomRequirement(){return this.matrixClient&&this.matrixClient.getVisibleRooms().length>=20}async onAction(e){if(this.matrixClient)if(e.action===u.a.SettingUpdated){const t=e;"breadcrumb_rooms"===t.settingName?await this.updateRooms():"breadcrumbs"===t.settingName&&await this.updateState({enabled:a.b.getValue("breadcrumbs",null)})}else if(e.action===u.a.ViewRoom)if(e.auto_join&&!this.matrixClient.getRoom(e.room_id))this.waitingRooms.push({roomId:e.room_id,addedTs:Date.now()});else{const t=this.matrixClient.getRoom(e.room_id);t&&await this.appendRoom(t)}}async onReady(){await this.updateRooms(),await this.updateState({enabled:a.b.getValue("breadcrumbs",null)}),this.matrixClient.on("Room.myMembership",this.onMyMembership),this.matrixClient.on("Room",this.onRoom)}async onNotReady(){this.matrixClient.removeListener("Room.myMembership",this.onMyMembership),this.matrixClient.removeListener("Room",this.onRoom)}async updateRooms(){let e=a.b.getValue("breadcrumb_rooms");e&&0!==e.length||(e=[]);const t=e.map(e=>this.matrixClient.getRoom(e)).filter(e=>!!e),s=this.state.rooms||[];Object(c.d)(t,s)&&await this.updateState({rooms:t})}async appendRoom(e){if(h.a.spacesEnabled&&e.isSpaceRoom())return;let t=!1;const s=(this.state.rooms||[]).slice(),n=this.matrixClient.getRoomUpgradeHistory(e.roomId);if(n.length>1){e=n[n.length-1];for(let e=0;e<n.length-1;e++){const i=s.findIndex(t=>t.roomId===n[e].roomId);-1!==i&&(s.splice(i,1),t=!0)}}const i=s.findIndex(t=>t.roomId===e.roomId);if(0!==i&&(-1!==i&&s.splice(i,1),s.splice(0,0,e),t=!0),s.length>20&&(s.splice(20,s.length-20),t=!0),t){await this.updateState({rooms:s});const e=s.map(e=>e.roomId);e.length>0&&await a.b.setValue("breadcrumb_rooms",null,d.a.ACCOUNT,e)}}}i()(m,"internalInstance",new m)},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(83),c=s.n(r),l=s(82),d=s.n(l),h=s(128),u=s(85);const m=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];var p;let g=Object(u.a)("structures.IndicatorScrollbar")(p=class extends d.a.Component{constructor(e){super(e),c()(this,"autoHideScrollbar",Object(l.createRef)()),c()(this,"scrollElement",void 0),c()(this,"likelyTrackpadUser",null),c()(this,"checkAgainForTrackpad",0),c()(this,"collectScroller",e=>{e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())}),c()(this,"checkOverflow",()=>{const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,s=this.scrollElement.scrollLeft>0,n=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),s?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:s?this.scrollElement.scrollLeft+"px":"0",rightIndicatorOffset:n?`-${this.scrollElement.scrollLeft}px`:"0"})}),c()(this,"onMouseWheel",e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,s=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=n+6e4):this.likelyTrackpadUser&&n>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=n*s}}}),this.state={leftIndicatorOffset:0,rightIndicatorOffset:0}}componentDidUpdate(e){d.a.Children.count(e.children)!==d.a.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow()}componentWillUnmount(){this.scrollElement&&this.scrollElement.removeEventListener("scroll",this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:s,verticalScrollsHorizontally:n}=e,a=o()(e,m),r={left:this.state.leftIndicatorOffset},c={right:this.state.rightIndicatorOffset},l=s?d.a.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:r}):null,u=s?d.a.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:c}):null;return d.a.createElement(h.a,i()({ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel},a),l,t,u)}})||p},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(165),r=s(135),c=s(106);t.a=({onVisibilityChange:e})=>{const[t,s]=Object(n.useState)(null);return Object(r.a)(o.b.instance,o.a,()=>{if(o.b.instance.getFirstNameFilterCondition()){const e=Object.values(o.b.instance.orderedLists).flat(1).length;s(e)}else s(null)}),Object(n.useEffect)(()=>{e&&e()},[t,e]),"number"!=typeof t?null:i.a.createElement("div",{className:"mx_LeftPanel_roomListFilterCount"},c.a.instance.spacePanelSpaces.length?Object(a.a)("%(count)s results in all spaces",{count:t}):Object(a.a)("%(count)s results",{count:t}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(189),h=s.n(d),u=s(84),m=s(93),p=s(152),g=s(86),v=s(85),f=s(142),b=s(125),y=s(88),E=s(177);function S(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let _=Object(v.a)("views.elements.AppPermission")((a=i=class extends l.a.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),s=g.a.get().getRoom(this.props.roomId);let n;s&&(n=s.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?S(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):S(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({widgetDomain:null,isWrapped:null,roomMember:n},t)}parseWidgetUrl(){const e=h.a.parse(this.props.url),t=new URLSearchParams(e.search);if(p.a.isScalarUrl(this.props.url)&&t&&t.get("url")){const e=h.a.parse(t.get("url"));return{widgetDomain:e.host||e.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=m.a.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,s=t===this.props.creatorUserId?null:this.props.creatorUserId,n=this.state.roomMember?l.a.createElement(f.a,{member:this.state.roomMember,width:38,height:38}):l.a.createElement(b.a,{name:this.props.creatorUserId,width:38,height:38}),i=l.a.createElement("div",null,Object(u.a)("Any of the following data may be shared:"),l.a.createElement("ul",null,l.a.createElement("li",null,Object(u.a)("Your display name")),l.a.createElement("li",null,Object(u.a)("Your avatar URL")),l.a.createElement("li",null,Object(u.a)("Your user ID")),l.a.createElement("li",null,Object(u.a)("Your theme")),l.a.createElement("li",null,Object(u.a)("%(brand)s URL",{brand:e})),l.a.createElement("li",null,Object(u.a)("Room ID")),l.a.createElement("li",null,Object(u.a)("Widget ID")))),a=l.a.createElement(E.a,{tooltip:i,tooltipClass:"mx_AppPermissionWarning_tooltip mx_Tooltip_dark"},l.a.createElement("span",{className:"mx_AppPermissionWarning_helpIcon"})),o=this.state.isWrapped?Object(u.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your integration manager.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>a}):Object(u.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>a}),r=this.props.isRoomEncrypted?Object(u.a)("Widgets do not use message encryption."):null;return l.a.createElement("div",{className:"mx_AppPermissionWarning"},l.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"},Object(u.a)("Widget added by")),l.a.createElement("div",{className:"mx_AppPermissionWarning_row"},n,l.a.createElement("h4",{className:"mx_AppPermissionWarning_bolder"},t),l.a.createElement("div",{className:"mx_AppPermissionWarning_smallText"},s)),l.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},o),l.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},Object(u.a)("This widget may use cookies.")," ",r),l.a.createElement("div",{className:"mx_AppPermissionWarning_row"},l.a.createElement(y.a,{kind:"primary_sm",onClick:this.props.onPermissionGranted},Object(u.a)("Continue"))))}},r()(i,"defaultProps",{onPermissionGranted:()=>{}}),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n);t.a=e=>i.a.createElement("div",{className:"mx_AppPermissionWarning"},i.a.createElement("div",{className:"mx_AppPermissionWarningImage"},i.a.createElement("img",{src:s(270),alt:""})),i.a.createElement("div",{className:"mx_AppPermissionWarningText"},i.a.createElement("span",{className:"mx_AppPermissionWarningTextLabel"},e.errorMsg||"Error")))},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(187),d=s(853),h=s(85),u=s(97),m=s(109),p=s(1);let g=Object(h.a)("views.dialogs.WidgetOpenIDPermissionsDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onAllow",()=>{this.onPermissionSelection(!0)}),a()(this,"onDeny",()=>{this.onPermissionSelection(!1)}),a()(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(p.a.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),d.b.instance.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?d.a.Allowed:d.a.Denied)),this.props.onFinished(e)}render(){return r.a.createElement(u.a,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Allow this widget to verify your identity")},r.a.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},r.a.createElement("p",null,Object(c.a)("The widget will verify your user ID, but won't be able to perform actions for you:")),r.a.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),r.a.createElement(m.a,{primaryButton:Object(c.a)("Continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:r.a.createElement(l.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(c.a)("Remember this")})}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(83),i=s.n(n),a=s(89),o=s(153),r=s(86),c=s(100);let l;!function(e){e[e.Allowed=0]="Allowed",e[e.Denied=1]="Denied",e[e.Unknown=2]="Unknown"}(l||(l={}));class d{constructor(){}static get instance(){return d.internalInstance||(d.internalInstance=new d),d.internalInstance}packSettingKey(e,t,s){let n=s;if(t!==o.WidgetKind.Room&&(n=r.a.get().getUserId()),t===o.WidgetKind.Modal&&(n="*MODAL*-"+n),!n)throw new Error("Failed to determine a location to check the widget's OIDC state with");return encodeURIComponent(`${n}::${e.templateUrl}`)}getOIDCState(e,t,s){var n,i;const o=this.packSettingKey(e,t,s),r=a.b.getValue("widgetOpenIDPermissions");return null!=r&&null!==(n=r.deny)&&void 0!==n&&n.includes(o)?l.Denied:null!=r&&null!==(i=r.allow)&&void 0!==i&&i.includes(o)?l.Allowed:l.Unknown}setOIDCState(e,t,s,n){const i=this.packSettingKey(e,t,s),o=a.b.getValue("widgetOpenIDPermissions");o.allow||(o.allow=[]),o.deny||(o.deny=[]),n===l.Allowed?o.allow.push(i):n===l.Denied?o.deny.push(i):(o.allow=o.allow.filter(e=>e!==i),o.deny=o.deny.filter(e=>e!==i)),a.b.setValue("widgetOpenIDPermissions",null,c.a.DEVICE,o)}}i()(d,"internalInstance",void 0)},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.CanChangeViewedRoom="io.element.view_room"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s(97),c=s(84),l=s(88),d=s(153),h=s(1032),u=s(86),m=s(228),p=s(116),g=s(1031),v=s(85),f=s(856),b=s(265);function y(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?y(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):y(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let S=Object(v.a)("views.dialogs.ModalWidgetDialog")(n=class extends o.PureComponent{constructor(e){super(e),a()(this,"widget",void 0),a()(this,"possibleButtons",void 0),a()(this,"appFrame",o.createRef()),a()(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter(e=>e.disabled).map(e=>e.id)}),a()(this,"onReady",()=>{this.state.messaging.sendWidgetConfig(this.props.widgetDefinition)}),a()(this,"onLoad",()=>{this.state.messaging.once("ready",this.onReady),this.state.messaging.on("action:"+d.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.on("action:"+d.WidgetApiFromWidgetAction.SetModalButtonEnabled,this.onButtonEnableToggle)}),a()(this,"onWidgetClose",e=>{this.props.onFinished(!0,e.detail.data)}),a()(this,"onButtonEnableToggle",e=>{e.preventDefault();if(e.detail.data.button===d.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return this.state.messaging.transport.reply(e.detail,{error:{message:"Invalid button"}});let t;if(e.detail.data.enabled)t=Object(p.b)(this.state.disabledButtonIds).filter(t=>t!==e.detail.data.button);else{const s=new Set(this.state.disabledButtonIds);s.add(e.detail.data.button),t=Array.from(s)}this.setState({disabledButtonIds:t}),this.state.messaging.transport.reply(e.detail,{})}),this.widget=new g.a(E(E({},this.props.widgetDefinition),{},{creatorUserId:u.a.get().getUserId(),id:"modal_"+this.props.sourceWidgetId})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map(e=>e.id)}componentDidMount(){const e=new h.a([],this.widget,d.WidgetKind.Modal),t=new d.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging.off("ready",this.onReady),this.state.messaging.off("action:"+d.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.stop()}render(){const e=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:u.a.get().getUserId(),userDisplayName:m.a.instance.displayName,userHttpAvatarUrl:m.a.instance.getHttpAvatarUrl(),clientId:f.a,clientTheme:b.a.getCurrentTheme(),clientLanguage:Object(c.g)()}),t=new URL(e);t.searchParams.set("widgetId",this.widget.id),t.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const n=t.toString().replace(/%24/g,"$");let i;return this.props.widgetDefinition.buttons&&(i=this.props.widgetDefinition.buttons.slice(0,3).reverse().map(e=>{let t="secondary";switch(e.kind){case d.ModalButtonKind.Primary:t="primary";break;case d.ModalButtonKind.Secondary:t="primary_outline";break;case d.ModalButtonKind.Danger:t="danger"}const s=this.state.disabledButtonIds.includes(e.id);return o.createElement(l.a,{key:e.id,kind:t,onClick:()=>{this.state.messaging.notifyModalWidgetButtonClicked(e.id)},disabled:s},e.label)})),o.createElement(r.a,{title:this.props.widgetDefinition.name||Object(c.a)("Modal Widget"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},o.createElement("div",{className:"mx_ModalWidgetDialog_warning"},o.createElement("img",{src:s(458),height:"16",width:"16",alt:""}),Object(c.a)("Data on this screen is shared with %(widgetDomain)s",{widgetDomain:t.hostname})),o.createElement("div",null,o.createElement("iframe",{ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:n,onLoad:this.onLoad})),o.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},i))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));const n="io.element.web"},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(82),a=s.n(i),o=s(858),r=s(85);let c=Object(r.a)("views.voip.CallContainer")(n=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_CallContainer"},a.a.createElement(o.a,null))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(559),l=s(132),d=s(151),h=s(87),u=s(865),m=s(89),p=s(163),g=s(86),v=s(85),f=s(1036),b=s(1),y=s(154);const E=[p.e.Connected,p.e.InviteSent,p.e.Connecting,p.e.CreateAnswer,p.e.CreateOffer,p.e.WaitLocalMedia];function S(e){const t=d.d.sharedInstance().getAllActiveCallsForPip(e);let s=null,n=[];for(const e of t)E.includes(e.state)&&(e.isRemoteOnHold()||null!==s?n.push(e):s=e);return null===s&&n.length>0&&(s=n[0],n=n.slice(1)),n.length>1&&b.a.log("Found more than 1 secondary call! Other calls will not be shown."),[s,n]}let _=Object(v.a)("views.voip.CallPreview")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"roomStoreToken",void 0),a()(this,"dispatcherRef",void 0),a()(this,"settingsWatcherRef",void 0),a()(this,"onRoomViewStoreUpdate",()=>{var e,t;const s=l.a.getRoomId(),n=this.state.roomId;if(s===n)return;const i=null===(e=g.a.get())||void 0===e?void 0:e.getRoom(n);i&&y.d.instance.off(y.d.emissionForRoom(i),this.updateCalls);const a=null===(t=g.a.get())||void 0===t?void 0:t.getRoom(s);if(a&&y.d.instance.on(y.d.emissionForRoom(a),this.updateCalls),!s)return;const[o,r]=S(s);this.setState({roomId:s,primaryCall:o,secondaryCall:r[0]})}),a()(this,"onAction",e=>{switch(e.action){case"call_state":this.updateCalls()}}),a()(this,"updateCalls",()=>{if(!this.state.roomId)return;const[e,t]=S(this.state.roomId);this.setState({primaryCall:e,secondaryCall:t[0]})}),a()(this,"onCallRemoteHold",()=>{if(!this.state.roomId)return;const[e,t]=S(this.state.roomId);this.setState({primaryCall:e,secondaryCall:t[0]})}),a()(this,"onDoubleClick",()=>{h.a.dispatch({action:"view_room",room_id:this.state.primaryCall.roomId})});const t=l.a.getRoomId(),[s,n]=S(t);this.state={roomId:t,primaryCall:s,secondaryCall:n[0]}}componentDidMount(){var e;d.d.sharedInstance().addListener(d.a.CallChangeRoom,this.updateCalls),this.roomStoreToken=l.a.addListener(this.onRoomViewStoreUpdate),this.dispatcherRef=h.a.register(this.onAction),g.a.get().on(p.c.RemoteHoldUnhold,this.onCallRemoteHold);const t=null===(e=g.a.get())||void 0===e?void 0:e.getRoom(this.state.roomId);t&&y.d.instance.on(y.d.emissionForRoom(t),this.updateCalls)}componentWillUnmount(){d.d.sharedInstance().removeListener(d.a.CallChangeRoom,this.updateCalls),g.a.get().removeListener(p.c.RemoteHoldUnhold,this.onCallRemoteHold),this.roomStoreToken&&this.roomStoreToken.remove(),h.a.unregister(this.dispatcherRef),m.b.unwatchSetting(this.settingsWatcherRef);const e=g.a.get().getRoom(this.state.roomId);e&&y.d.instance.off(y.d.emissionForRoom(e),this.updateCalls)}render(){return this.state.primaryCall?r.a.createElement(f.a,{className:"mx_CallPreview",draggable:!0,onDoubleClick:this.onDoubleClick},({onStartMoving:e,onResize:t})=>r.a.createElement(c.a,{onMouseDownOnHeader:e,call:this.state.primaryCall,secondaryCall:this.state.secondaryCall,pipMode:!0,onResize:t})):r.a.createElement(u.a,null)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(97),d=s(109),h=s(91),u=s.n(h),m=s(88),p=s(85),g=s(253);function v(){return window.electron.getDesktopCapturerSources({thumbnailSize:{height:176,width:312},types:["screen","window"]})}let f;!function(e){e.Screens="screen",e.Windows="window"}(f||(f={}));class b extends r.a.Component{constructor(e){super(e),a()(this,"onClick",()=>{this.props.onSelect(this.props.source)})}render(){const e=u()({mx_desktopCapturerSourcePicker_source_thumbnail:!0,mx_desktopCapturerSourcePicker_source_thumbnail_selected:this.props.selected});return r.a.createElement(m.a,{className:"mx_desktopCapturerSourcePicker_source",title:this.props.source.name,onClick:this.onClick},r.a.createElement("img",{className:e,src:this.props.source.thumbnailURL}),r.a.createElement("span",{className:"mx_desktopCapturerSourcePicker_source_name"},this.props.source.name))}}let y=Object(p.a)("views.elements.DesktopCapturerSourcePicker")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"interval",void 0),a()(this,"onSelect",e=>{this.setState({selectedSource:e})}),a()(this,"onShare",()=>{this.props.onFinished(this.state.selectedSource.id)}),a()(this,"onTabChange",()=>{this.setState({selectedSource:null})}),a()(this,"onCloseClick",()=>{this.props.onFinished(null)}),this.state={selectedTab:f.Screens,sources:[],selectedSource:null}}async componentDidMount(){this.setState({sources:await v()}),this.interval=setInterval(async()=>{this.setState({sources:await v()})},500)}componentWillUnmount(){clearInterval(this.interval)}getTab(e,t){const s=this.state.sources.filter(t=>t.id.startsWith(e)).map(e=>{var t;return r.a.createElement(b,{selected:(null===(t=this.state.selectedSource)||void 0===t?void 0:t.id)===e.id,source:e,onSelect:this.onSelect,key:e.id})});return new g.a(e,t,null,r.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_tab"},s))}render(){const e=[this.getTab("screen",Object(c.a)("Share entire screen")),this.getTab("window",Object(c.a)("Application window"))];return r.a.createElement(l.a,{className:"mx_desktopCapturerSourcePicker",onFinished:this.onCloseClick,title:Object(c.a)("Share content")},r.a.createElement(g.c,{tabs:e,tabLocation:g.b.TOP,onChange:this.onTabChange}),r.a.createElement(d.a,{primaryButton:Object(c.a)("Share"),hasCancel:!0,onCancel:this.onCloseClick,onPrimaryButtonClick:this.onShare,primaryDisabled:!this.state.selectedSource}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(82),i=s.n(n),a=s(560),o=s(91),r=s.n(o);class c extends i.a.Component{render(){const e=this.props.feeds.map(e=>i.a.createElement(a.a,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode})),t=r()("mx_CallViewSidebar",{mx_CallViewSidebar_pipMode:this.props.pipMode});return i.a.createElement("div",{className:t},e)}}},function(e,t,s){"use strict";var n=s(163),i=s(82),a=s.n(i),o=s(84),r=s(126),c=s(87),l=s(92),d=s(91),h=s.n(d),u=s(111);const m={[n.f.Video]:Object(o.b)("Video Call"),[n.f.Voice]:Object(o.b)("Voice Call")},p=()=>{c.a.dispatch({action:"video_fullscreen",fullscreen:!0})},g=({pipMode:e=!1,type:t,roomId:s})=>a.a.createElement("div",{className:"mx_CallViewHeader_controls"},!e&&a.a.createElement(u.a,{className:"mx_CallViewHeader_button mx_CallViewHeader_button_fullscreen",onClick:p,title:Object(o.a)("Fill Screen")}),e&&a.a.createElement(u.a,{className:"mx_CallViewHeader_button mx_CallViewHeader_button_expand",onClick:()=>(e=>{c.a.dispatch({action:l.a.ViewRoom,room_id:e})})(s),title:Object(o.a)("Return to call")})),v=({callRoom:e})=>a.a.createElement("span",{className:"mx_CallViewHeader_secondaryCallInfo"},a.a.createElement(r.a,{room:e,height:16,width:16}),a.a.createElement("span",{className:"mx_CallView_secondaryCall_roomName"},Object(o.a)("%(name)s on hold",{name:e.name}))),f=({type:e})=>{const t=h()({mx_CallViewHeader_callTypeIcon:!0,mx_CallViewHeader_callTypeIcon_video:e===n.f.Video,mx_CallViewHeader_callTypeIcon_voice:e===n.f.Voice});return a.a.createElement("div",{className:t})};t.a=({type:e,pipMode:t=!1,callRooms:s=[],onPipMouseDown:n})=>{const[i,c]=s,l=Object(o.a)(m[e]),d=i.name,{roomId:h}=i;return t?a.a.createElement("div",{className:"mx_CallViewHeader",onMouseDown:n},a.a.createElement(r.a,{room:i,height:32,width:32}),a.a.createElement("div",{className:"mx_CallViewHeader_callInfo"},a.a.createElement("div",{className:"mx_CallViewHeader_roomName"},d),a.a.createElement("div",{className:"mx_CallViewHeader_callTypeSmall"},l,c&&a.a.createElement(v,{callRoom:c}))),a.a.createElement(g,{roomId:h,pipMode:t,type:e})):a.a.createElement("div",{className:"mx_CallViewHeader"},a.a.createElement(f,{type:e}),a.a.createElement("span",{className:"mx_CallViewHeader_callType"},l),a.a.createElement(g,{roomId:h,pipMode:t,type:e}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(95),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(111),u=s(863),m=s(864),p=s(150),g=s(105),v=s(84);const f=({state:e,className:t,onLabel:s,offLabel:n,onClick:i})=>{const a=d()("mx_CallViewButtons_button",t,{mx_CallViewButtons_button_on:e,mx_CallViewButtons_button_off:!e});return c.a.createElement(h.a,{className:a,onClick:i,title:e?s:n,alignment:p.a.Top,yOffset:-24})};class b extends c.a.Component{constructor(e){super(e),o()(this,"dialpadButton",Object(r.createRef)()),o()(this,"contextMenuButton",Object(r.createRef)()),o()(this,"controlsHideTimer",null),o()(this,"onControlsHideTimer",()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))}),o()(this,"onMouseEnter",()=>{this.setState({hoveringControls:!0})}),o()(this,"onMouseLeave",()=>{this.setState({hoveringControls:!1})}),o()(this,"onDialpadClick",()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())}),o()(this,"onMoreClick",()=>{this.setState({showMoreMenu:!0}),this.showControls()}),o()(this,"closeDialpad",()=>{this.setState({showDialpad:!1})}),o()(this,"closeContextMenu",()=>{this.setState({showMoreMenu:!1})}),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=d()("mx_CallViewButtons",{mx_CallViewButtons_hidden:!this.state.visible});let t,s;return this.state.showDialpad&&(t=c.a.createElement(m.a,i()({},Object(g.l)(this.dialpadButton.current.getBoundingClientRect(),g.a.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&(s=c.a.createElement(u.a,i()({},Object(g.k)(this.contextMenuButton.current.getBoundingClientRect(),g.a.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),c.a.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,s,this.props.buttonsVisibility.dialpad&&c.a.createElement(g.c,{className:"mx_CallViewButtons_button mx_CallViewButtons_dialpad",inputRef:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:Object(v.a)("Dialpad"),alignment:p.a.Top,yOffset:-24}),c.a.createElement(f,{state:!this.props.buttonsState.micMuted,className:"mx_CallViewButtons_button_mic",onLabel:Object(v.a)("Mute the microphone"),offLabel:Object(v.a)("Unmute the microphone"),onClick:this.props.handlers.onMicMuteClick}),this.props.buttonsVisibility.vidMute&&c.a.createElement(f,{state:!this.props.buttonsState.vidMuted,className:"mx_CallViewButtons_button_vid",onLabel:Object(v.a)("Stop the camera"),offLabel:Object(v.a)("Start the camera"),onClick:this.props.handlers.onVidMuteClick}),this.props.buttonsVisibility.screensharing&&c.a.createElement(f,{state:this.props.buttonsState.screensharing,className:"mx_CallViewButtons_button_screensharing",onLabel:Object(v.a)("Stop sharing your screen"),offLabel:Object(v.a)("Start sharing your screen"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&c.a.createElement(f,{state:this.props.buttonsState.sidebarShown,className:"mx_CallViewButtons_button_sidebar",onLabel:Object(v.a)("Hide sidebar"),offLabel:Object(v.a)("Show sidebar"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&c.a.createElement(g.c,{className:"mx_CallViewButtons_button mx_CallViewButtons_button_more",onClick:this.onMoreClick,inputRef:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:Object(v.a)("More"),alignment:p.a.Top,yOffset:-24}),c.a.createElement(h.a,{className:"mx_CallViewButtons_button mx_CallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:Object(v.a)("Hangup"),alignment:p.a.Top,yOffset:-24}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(110),h=s.n(d),u=s(84),m=s(105),p=s(151),g=s(416),v=s(90),f=s(85);let b=Object(f.a)("views.context_menus.CallContextMenu")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onHoldClick",()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()}),r()(this,"onUnholdClick",()=>{p.d.sharedInstance().setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()}),r()(this,"onTransferClick",()=>{v.a.createTrackedDialog("Transfer Call","",g.d,{kind:g.a,call:this.props.call},"mx_InviteDialog_transferWrapper",!1,!0),this.props.onFinished()})}render(){const e=this.props.call.isRemoteOnHold()?Object(u.a)("Resume"):Object(u.a)("Hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let s;return this.props.call.opponentCanBeTransferred()&&(s=l.a.createElement(m.e,{className:"mx_CallContextMenu_item",onClick:this.onTransferClick},Object(u.a)("Transfer"))),l.a.createElement(m.n,this.props,l.a.createElement(m.e,{className:"mx_CallContextMenu_item",onClick:t},e),s)}},r()(i,"propTypes",{user:h.a.object}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(83),a=s.n(i),o=s(82),r=s(88),c=s(105),l=s(101),d=s(390),h=s(85);let u=Object(h.a)("views.context_menus.DialpadContextMenu")(n=class extends o.Component{constructor(e){super(e),a()(this,"numberEntryFieldRef",Object(o.createRef)()),a()(this,"onDigitPress",(e,t)=>{var s;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(s=this.numberEntryFieldRef.current)||void 0===s||s.focus())}),a()(this,"onCancelClick",()=>{this.props.onFinished()}),a()(this,"onKeyDown",e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()}),a()(this,"onChange",e=>{this.setState({value:e.target.value})}),this.state={value:""}}render(){return o.createElement(c.n,this.props,o.createElement("div",{className:"mx_DialPadContextMenuWrapper"},o.createElement("div",null,o.createElement(r.a,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),o.createElement("div",{className:"mx_DialPadContextMenu_header"},o.createElement(l.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),o.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},o.createElement(d.a,{onDigitPress:this.onDigitPress,hasDial:!1}))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(132),l=s(310),d=s(152),h=s(86),u=s(85),m=s(276);let p=Object(u.a)("views.elements.PersistentApp")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"roomStoreToken",void 0),a()(this,"onRoomViewStoreUpdate",()=>{c.a.getRoomId()!==this.state.roomId&&this.setState({roomId:c.a.getRoomId()})}),a()(this,"onActiveWidgetStoreUpdate",()=>{this.setState({persistentWidgetId:l.b.instance.getPersistentWidgetId()})}),a()(this,"onMyMembership",async(e,t)=>{const s=l.b.instance.getRoomId(this.state.persistentWidgetId);"join"!==t&&e.roomId===s&&l.b.instance.destroyPersistentWidget(this.state.persistentWidgetId)}),this.state={roomId:c.a.getRoomId(),persistentWidgetId:l.b.instance.getPersistentWidgetId()}}componentDidMount(){this.roomStoreToken=c.a.addListener(this.onRoomViewStoreUpdate),l.b.instance.on(l.a.Update,this.onActiveWidgetStoreUpdate),h.a.get().on("Room.myMembership",this.onMyMembership)}componentWillUnmount(){this.roomStoreToken&&this.roomStoreToken.remove(),l.b.instance.removeListener(l.a.Update,this.onActiveWidgetStoreUpdate),h.a.get()&&h.a.get().removeListener("Room.myMembership",this.onMyMembership)}render(){if(this.state.persistentWidgetId){const e=l.b.instance.getRoomId(this.state.persistentWidgetId),t=h.a.get().getRoom(e);if(!t)return null;const s=t.getMyMembership();if(this.state.roomId!==e&&"join"===s){const s=d.a.getRoomWidgets(t).find(e=>e.getStateKey()===l.b.instance.getPersistentWidgetId()),n=d.a.makeAppConfig(s.getStateKey(),s.getContent(),s.getSender(),e,s.getId());return r.a.createElement(m.a,{key:n.id,app:n,fullWidth:!0,room:t,userId:h.a.get().credentials.userId,creatorUserId:n.creatorUserId,widgetPageTitle:d.a.getWidgetDataTitle(n),waitForIframeLoad:n.waitForIframeLoad,miniMode:!0,showMenubar:!1})}}return null}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(83),a=s.n(i),o=s(82),r=s(776),c=s(123),l=s(85);let d=Object(l.a)("structures.NonUrgentToastContainer")(n=class extends o.PureComponent{constructor(e,t){super(e,t),a()(this,"onUpdateToasts",()=>{this.setState({toasts:r.a.instance.components})}),this.state={toasts:r.a.instance.components},r.a.instance.on(c.b,this.onUpdateToasts)}componentWillUnmount(){r.a.instance.off(c.b,this.onUpdateToasts)}render(){const e=this.state.toasts.map((e,t)=>o.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:"toast-"+t},o.createElement(e,{})));return o.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(1037),o=s(557),r=s(135),c=s(123);t.a=()=>{const[e,t]=Object(n.useState)(o.a.instance.isHostSignupActive);return Object(r.a)(o.a.instance,c.b,()=>{t(o.a.instance.isHostSignupActive)}),i.a.createElement("div",{className:"mx_HostSignupContainer"},e&&i.a.createElement(a.a,null))}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(1575),d=s(91),h=s.n(d),u=s(84),m=s(105),p=s(300),g=s(1038),v=s(111),f=s(135),b=s(106),y=s(185),E=s(128),S=s(155),_=s(173),w=s(168),C=s(89),O=s(100),k=s(139),R=s(870),I=s(236);const x=["onFinished"],T=["selected","isPanelCollapsed"],j=e=>{let{onFinished:t}=e,s=o()(e,x);const n=Object(f.b)(b.a.instance,y.b,()=>b.a.instance.allRoomsInHome);return c.a.createElement(w.e,i()({},s,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),c.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},Object(u.a)("Home")),c.a.createElement(w.c,{first:!0},c.a.createElement(w.a,{iconClassName:"mx_SpacePanel_noIcon",label:Object(u.a)("Show all rooms"),active:n,onClick:()=>{C.b.setValue("Spaces.allRoomsInHome",null,O.a.ACCOUNT,!n)}})))},N=e=>{let{selected:t,isPanelCollapsed:s}=e,n=o()(e,T);return c.a.createElement("li",{className:h()("mx_SpaceItem",{collapsed:s}),role:"treeitem"},c.a.createElement(g.a,i()({},n,{selected:t,isNarrow:s})))},P=({isPanelCollapsed:e,setPanelCollapsed:t})=>{const[s,n,i,a]=Object(m.p)();Object(r.useEffect)(()=>{!e&&s&&a()},[e]);let o=null;s&&(o=c.a.createElement(p.d,{onFinished:a}));const l=s?a:()=>{localStorage.setItem("mx_seenSpaces","1"),e||t(!0),i()};let d;return localStorage.getItem("mx_seenSpaces")||b.a.instance.spacePanelSpaces.length||(d=c.a.createElement("div",{className:"mx_BetaDot"})),c.a.createElement("li",{className:h()("mx_SpaceItem mx_SpaceItem_new",{collapsed:e}),role:"treeitem"},c.a.createElement(g.a,{className:h()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:s}),label:s?Object(u.a)("Cancel"):Object(u.a)("Create a space"),onClick:l,isNarrow:e}),d,o)},D={[y.a.Home]:({selected:e,isPanelCollapsed:t})=>{const s=Object(f.b)(b.a.instance,y.b,()=>b.a.instance.allRoomsInHome);return c.a.createElement(N,{spaceKey:y.a.Home,className:"mx_SpaceButton_home",selected:e,isPanelCollapsed:t,label:s?Object(u.a)("All rooms"):Object(u.a)("Home"),notificationState:s?_.a.instance.globalState:b.a.instance.getNotificationState(y.a.Home),ContextMenuComponent:j,contextMenuTooltip:Object(u.a)("Options")})},[y.a.Favourites]:({selected:e,isPanelCollapsed:t})=>c.a.createElement(N,{spaceKey:y.a.Favourites,className:"mx_SpaceButton_favourites",selected:e,isPanelCollapsed:t,label:Object(u.a)("Favourites"),notificationState:b.a.instance.getNotificationState(y.a.Favourites)}),[y.a.People]:({selected:e,isPanelCollapsed:t})=>c.a.createElement(N,{spaceKey:y.a.People,className:"mx_SpaceButton_people",selected:e,isPanelCollapsed:t,label:Object(u.a)("People"),notificationState:b.a.instance.getNotificationState(y.a.People)}),[y.a.Orphans]:({selected:e,isPanelCollapsed:t})=>c.a.createElement(N,{spaceKey:y.a.Orphans,className:"mx_SpaceButton_orphans",selected:e,isPanelCollapsed:t,label:Object(u.a)("Other rooms"),notificationState:b.a.instance.getNotificationState(y.a.Orphans)})},M=c.a.memo(({children:e,isPanelCollapsed:t,setPanelCollapsed:s})=>{const[n,a,o,r]=(()=>{const e=Object(f.b)(b.a.instance,y.c,()=>b.a.instance.invitedSpaces),[t,s]=Object(f.b)(b.a.instance,y.f,()=>[b.a.instance.enabledMetaSpaces,b.a.instance.spacePanelSpaces]);return[e,t,s,Object(f.b)(b.a.instance,y.d,()=>b.a.instance.activeSpace)]})(),d=r?[r]:[],h=a.map(e=>{const s=D[e];return c.a.createElement(s,{key:e,selected:r===e,isPanelCollapsed:t})});return c.a.createElement("div",{className:"mx_SpaceTreeLevel"},h,n.map(e=>c.a.createElement(g.b,{key:e.roomId,space:e,activeSpaces:d,isPanelCollapsed:t,onExpand:()=>s(!1)})),o.map((e,n)=>c.a.createElement(l.Draggable,{key:e.roomId,draggableId:e.roomId,index:n},(n,a)=>c.a.createElement(g.b,i()({},n.draggableProps,{dragHandleProps:n.dragHandleProps,key:e.roomId,innerRef:n.innerRef,className:a.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:d,isPanelCollapsed:t,onExpand:()=>s(!1)})))),e,c.a.createElement(P,{isPanelCollapsed:t,setPanelCollapsed:s}))});t.a=()=>{const e=Object(I.b)("feature_spaces_metaspaces"),[t,s]=Object(r.useState)(!0),n=Object(r.useRef)();return Object(r.useLayoutEffect)(()=>(k.b.instance.trackElementDimensions("SpacePanel",n.current),()=>k.b.instance.stopTrackingElementDimensions("SpacePanel")),[]),c.a.createElement(l.DragDropContext,{onDragEnd:e=>{e.destination&&b.a.instance.moveRootSpace(e.source.index,e.destination.index)}},c.a.createElement(S.c,{handleHomeEnd:!0,handleUpDown:!0},({onKeyDownHandler:a})=>c.a.createElement("ul",{className:h()("mx_SpacePanel",{collapsed:t}),onKeyDown:a,role:"tree","aria-label":Object(u.a)("Spaces"),ref:n},c.a.createElement(l.Droppable,{droppableId:"top-level-spaces"},(e,n)=>c.a.createElement(E.a,i()({},e.droppableProps,{wrappedRef:e.innerRef,className:"mx_SpacePanel_spaceTreeWrapper",style:n.isDraggingOver?{pointerEvents:"none"}:void 0}),c.a.createElement(M,{isPanelCollapsed:t,setPanelCollapsed:s},e.placeholder))),c.a.createElement(v.a,{className:h()("mx_SpacePanel_toggleCollapse",{expanded:!t}),onClick:()=>s(!t),title:t?Object(u.a)("Expand space panel"):Object(u.a)("Collapse space panel"),forceHide:!t},t?null:Object(u.a)("Collapse")),e&&c.a.createElement(R.a,{isPanelCollapsed:t}))))}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(94),d=s(168),h=s(84),u=s(186),m=s(98),p=s(87),g=s(132),v=s(92),f=s(122),b=s(326),y=s(89);const E=["space","onFinished"];t.a=e=>{let{space:t,onFinished:s}=e,n=o()(e,E);const a=Object(r.useContext)(m.a).getUserId();let S,_,w,C;if("public"===t.getJoinRule()||t.canInvite(a)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(u.i)(t),s()};S=c.a.createElement(d.b,{className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:Object(h.a)("Invite people"),onClick:e})}if(Object(u.e)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(u.j)(t),s()};_=c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconSettings",label:Object(h.a)("Settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),Object(u.c)(t),s()};w=c.a.createElement(d.c,{red:!0,first:!0},c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconLeave",label:Object(h.a)("Leave space"),onClick:e}))}if(y.b.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:v.a.ViewRoom,room_id:t.roomId,forceTimeline:!0}),s()};C=c.a.createElement(d.c,{first:!0},c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconSettings",label:Object(h.a)("See room timeline (devtools)"),onClick:e}))}const O=t.currentState.maySendStateEvent(l.a.SpaceChild,a);let k;if(t.currentState.maySendStateEvent(l.a.SpaceChild,a)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(u.g)(t),s()},n=e=>{e.preventDefault(),e.stopPropagation(),Object(u.f)(t),s()},i=e=>{e.preventDefault(),e.stopPropagation(),Object(u.h)(t),s()};k=c.a.createElement(d.c,{first:!0},c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconPlus",label:Object(h.a)("Create new room"),onClick:e}),c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconHash",label:Object(h.a)("Add existing room"),onClick:n}),c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconPlus",label:Object(h.a)("Add space"),onClick:i},c.a.createElement(b.a,null)))}return c.a.createElement(d.e,i()({},n,{onFinished:s,className:"mx_SpacePanel_contextMenu",compact:!0}),c.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),c.a.createElement(d.c,{first:!0},S,c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconMembers",label:Object(h.a)("Members"),onClick:e=>{e.preventDefault(),e.stopPropagation(),g.a.getRoomId()||p.a.dispatch({action:"view_room",room_id:t.roomId},!0),p.a.dispatch({action:v.a.SetRightPanelPhase,phase:f.c.SpaceMemberList,refireParams:{space:t}}),s()}}),_,c.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconExplore",label:O?Object(h.a)("Manage & explore rooms"):Object(h.a)("Explore rooms"),onClick:e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_room",room_id:t.roomId}),s()}})),k,w,C)}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(111),l=s(105),d=s(88),h=s(137),u=s(185),m=s(236),p=s(561),g=s(87),v=s(92),f=s(158),b=s(309),y=s(229),E=s(562),S=s(89),_=s(100),w=s(91),C=s.n(w);t.a=({isPanelCollapsed:e=!1})=>{const t=Object(a.useMemo)(b.e,[]),[s,n,w,O]=Object(l.p)(),{[u.a.Favourites]:k,[u.a.People]:R}=Object(m.b)("Spaces.enabledMetaSpaces");let I;if(s){const e=E.a.calculateThemeState(),s=Object(b.c)(e.theme),a=s||e.theme;I=o.a.createElement(l.n,i()({},Object(l.l)(n.current.getBoundingClientRect(),l.a.None,16),{wrapperClassName:"mx_QuickSettingsButton_ContextMenuWrapper",onFinished:O,managed:!1,focusLock:!0}),o.a.createElement("h2",null,Object(r.a)("Quick settings")),o.a.createElement(d.a,{onClick:()=>{O(),g.a.dispatch({action:v.a.ViewUserSettings,initialTabId:f.a.Sidebar})},kind:"primary_outline"},Object(r.a)("All settings")),o.a.createElement("h4",{className:"mx_QuickSettingsButton_pinToSidebarHeading"},Object(r.a)("Pin to sidebar")),o.a.createElement(h.b,{className:"mx_QuickSettingsButton_favouritesCheckbox",checked:!!k,onChange:Object(p.b)(u.a.Favourites)},Object(r.a)("Favourites")),o.a.createElement(h.b,{className:"mx_QuickSettingsButton_peopleCheckbox",checked:!!R,onChange:Object(p.b)(u.a.People)},Object(r.a)("People")),o.a.createElement(d.a,{className:"mx_QuickSettingsButton_moreOptionsButton",onClick:()=>{O(),g.a.dispatch({action:v.a.ViewUserSettings,initialTabId:f.a.Sidebar})}},Object(r.a)("More options")),o.a.createElement("div",{className:"mx_QuickSettingsButton_themePicker"},o.a.createElement("h4",null,Object(r.a)("Theme")),o.a.createElement(y.a,{id:"mx_QuickSettingsButton_themePickerDropdown",onOptionChange:async e=>{S.b.setValue("theme",null,_.a.DEVICE,e).catch(()=>{g.a.dispatch({action:v.a.RecheckTheme})}),g.a.dispatch({action:v.a.RecheckTheme,forceTheme:e}),O()},value:a,label:Object(r.a)("Space selection")},t.map(e=>o.a.createElement("div",{key:e.id},e.name)))))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(c.a,{className:C()("mx_QuickSettingsButton",{expanded:!e}),onClick:w,title:Object(r.a)("Quick settings"),inputRef:n,forceHide:!e},e?null:Object(r.a)("Settings")),I)}},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(881),c=s(163);class l extends o.a.Component{constructor(e){super(e),i()(this,"onFeedsChanged",()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})}),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(c.c.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(c.c.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map((e,t)=>o.a.createElement(r.a,{feed:e,key:t}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(424),c=s(1),l=s(315);class d extends o.a.Component{constructor(e){super(e),i()(this,"element",Object(a.createRef)()),i()(this,"onAudioOutputChanged",e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){c.a.error("Couldn't set requested audio output device: using default",e),c.a.warn("Couldn't set requested audio output device: using default",e)}}),i()(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()}),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){l.c.instance.addListener(l.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(r.b.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){l.c.instance.removeListener(l.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(r.b.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(l.c.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){c.a.info("Failed to play media element with feed",this.props.feed,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.src=null)}render(){return this.state.audioMuted?null:o.a.createElement("audio",{ref:this.element})}}},function(e,t,s){"use strict";(function(e){var n=s(102),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(194),u=s(302),m=s(84),p=s(120),g=s(202),v=s(90),f=s(151),b=s(87),y=s(180),E=s(1599),S=s(330),_=s(331),w=s(132),C=s(1609),O=s(308),k=s(89),R=s(133),I=s(88),x=s(244),T=s(134),j=s(118),N=s(98),P=s(565),D=s(92),M=s(328),A=s(245),U=s(277),L=s(931),F=s(933),B=s(934),V=s(935),K=s(937),W=s(940),G=s(329),H=s(220),q=s(238),$=s(123),z=s(254),J=s(542),Y=s(173),Q=s(154),X=s(195),Z=s(144),ee=s(1040),te=s(85),se=s(927),ne=s(112),ie=s(104),ae=s(942),oe=s(96),re=s(576),ce=s(483),le=s(403),de=s(943),he=s(944),ue=s(106),me=s(371),pe=s(130),ge=s(1),ve=s(318),fe=s(167),be=s(575),ye=s(577),Ee=s(122);const Se=["upgradeRecommendation"],_e=["upgradeRecommendation"];var we,Ce,Oe;function ke(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function Re(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ke(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ke(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let Ie=function(e){};const xe="sandbox"in document.createElement("iframe");var Te;(function(e){e[e.Timeline=0]="Timeline",e[e.MaximisedWidget=1]="MaximisedWidget"})(Te||(Te={}));let je=Object(te.a)("structures.RoomView")((Oe=Ce=class extends c.a.Component{constructor(t,s){super(t,s),o()(this,"dispatcherRef",void 0),o()(this,"roomStoreToken",void 0),o()(this,"rightPanelStoreToken",void 0),o()(this,"settingWatchers",void 0),o()(this,"unmounted",!1),o()(this,"permalinkCreators",{}),o()(this,"searchId",void 0),o()(this,"roomView",Object(r.createRef)()),o()(this,"searchResultsPanel",Object(r.createRef)()),o()(this,"messagePanel",void 0),o()(this,"onWidgetStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),o()(this,"onWidgetEchoStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),o()(this,"onWidgetLayoutChange",()=>{this.state.room&&(Q.d.instance.hasMaximisedWidget(this.state.room)&&b.a.dispatch({action:D.a.SetRightPanelPhase,phase:Ee.c.Timeline}),this.checkWidgets(this.state.room),this.checkRightPanel(this.state.room))}),o()(this,"checkWidgets",e=>{this.setState({hasPinnedWidgets:Q.d.instance.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})}),o()(this,"getMainSplitContentType",e=>Q.d.instance.hasMaximisedWidget(e)?Te.MaximisedWidget:Te.Timeline),o()(this,"checkRightPanel",e=>{x.a.getSharedInstance().roomPanelPhase===Ee.c.Timeline&&this.state.showRightPanel&&!Q.d.instance.hasMaximisedWidget(this.state.room)&&b.a.dispatch({action:D.a.ToggleRightPanel,type:"room"})}),o()(this,"onReadReceiptsChange",()=>{this.setState({showReadReceipts:k.b.getValue("showReadReceipts",this.state.roomId)})}),o()(this,"onRoomViewStoreUpdate",async e=>{if(this.unmounted)return;if(!e&&this.state.roomId!==w.a.getRoomId())return;const t=w.a.getRoomId(),s={roomId:t,roomAlias:w.a.getRoomAlias(),roomLoading:w.a.isRoomLoading(),roomLoadError:w.a.getRoomLoadError(),joining:w.a.isJoining(),replyToEvent:w.a.getQuotingEvent(),shouldPeek:this.state.matrixClientIsReady&&w.a.shouldPeek(),showReadReceipts:k.b.getValue("showReadReceipts",t),showRedactions:k.b.getValue("showRedactions",t),showJoinLeaves:k.b.getValue("showJoinLeaves",t),showAvatarChanges:k.b.getValue("showAvatarChanges",t),showDisplaynameChanges:k.b.getValue("showDisplaynameChanges",t),wasContextSwitch:w.a.getWasContextSwitch()},n=w.a.getInitialEventId();if(n){var i,a;const e=this.context.getRoom(t);let r=null==e?void 0:e.findEventById(n);r||(r=await Object(fe.b)(this.context,t,n));const c=null===(i=r)||void 0===i?void 0:i.getThread();var o;if(!c||null!==(a=r)&&void 0!==a&&a.isThreadRoot)s.initialEventId=n,s.isInitialEventHighlighted=w.a.isInitialEventHighlighted(),c&&null!==(o=r)&&void 0!==o&&o.isThreadRoot&&Object(ve.a)(c.rootEvent,r,w.a.isInitialEventHighlighted());else Object(ve.a)(c.rootEvent,r,w.a.isInitialEventHighlighted())}if(this.settingWatchers=this.settingWatchers.concat([k.b.watchSetting("showReadReceipts",t,(...[,,,e])=>this.setState({showReadReceipts:e})),k.b.watchSetting("showRedactions",t,(...[,,,e])=>this.setState({showRedactions:e})),k.b.watchSetting("showJoinLeaves",t,(...[,,,e])=>this.setState({showJoinLeaves:e})),k.b.watchSetting("showAvatarChanges",t,(...[,,,e])=>this.setState({showAvatarChanges:e})),k.b.watchSetting("showDisplaynameChanges",t,(...[,,,e])=>this.setState({showDisplaynameChanges:e}))]),e||!this.state.shouldPeek||s.shouldPeek||this.context.stopPeeking(),ge.a.log("RVS update:",s.roomId,s.roomAlias,"loading?",s.roomLoading,"joining?",s.joining,"initial?",e,"shouldPeek?",s.shouldPeek),e&&(s.room=this.context.getRoom(s.roomId),s.room&&(s.showApps=this.shouldShowApps(s.room),this.onRoomLoaded(s.room))),null===this.state.roomId&&null!==s.roomId&&!s.initialEventId){const e=C.a.getScrollState(s.roomId);e&&(s.initialEventId=e.focussedEvent,s.initialEventPixelOffset=e.pixelOffset)}this.state.initialEventId!==s.initialEventId&&(s.searchResults=null),this.setState(s),e&&this.setupRoom(s.room,s.roomId,s.joining,s.shouldPeek)}),o()(this,"getRoomId",()=>this.state.room?this.state.room.roomId:this.state.roomId),o()(this,"onUserScroll",()=>{this.state.initialEventId&&this.state.isInitialEventHighlighted&&b.a.dispatch({action:D.a.ViewRoom,room_id:this.state.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent})}),o()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:x.a.getSharedInstance().isOpenForRoom})}),o()(this,"onPageUnload",e=>g.b.sharedInstance().getCurrentUploads().length>0?e.returnValue=Object(m.a)("You seem to be uploading files, are you sure you want to quit?"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=Object(m.a)("You seem to be in a call, are you sure you want to quit?"):void 0),o()(this,"onReactKeyDown",e=>{let t=!1;switch(Object(X.f)().getRoomAction(e)){case X.d.DismissReadMarker:this.messagePanel.forgetReadMarker(),this.jumpToLiveTimeline(),t=!0;break;case X.d.JumpToOldestUnread:this.jumpToReadMarker(),t=!0;break;case X.d.UploadFile:b.a.dispatch({action:"upload_file"},!0),t=!0}t&&(e.stopPropagation(),e.preventDefault())}),o()(this,"onAction",t=>{switch(t.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(t.data.content.url,t.data.content.info,t.data.description||t.data.name);break;case"picture_snapshot":g.b.sharedInstance().sendContentListToRoom([t.file],this.state.room.roomId,null,this.context);break;case"notifier_enabled":case D.a.UploadStarted:case D.a.UploadFinished:case D.a.UploadCanceled:this.forceUpdate();break;case"call_state":{if(!t.room_id)return;const e=this.getCallForRoom();this.setState({callState:e?e.state:null});break}case"appsDrawer":this.setState({showApps:t.show});break;case"reply_to_event":this.state.searchResults&&t.event.getRoomId()===this.state.roomId&&!this.unmounted&&t.context===j.a.Room&&this.onCancelSearchClick();break;case"quote":if(this.state.searchResults){const s=t.event.getRoomId();s===this.state.roomId&&this.onCancelSearchClick(),e(()=>{b.a.dispatch({action:D.a.ViewRoom,room_id:s,deferred_action:t})})}break;case"sync_state":this.state.matrixClientIsReady||this.setState({matrixClientIsReady:this.context&&this.context.isInitialSyncComplete()},()=>{this.onRoomViewStoreUpdate(!0)});break;case"focus_search":this.onSearchClick();break;case D.a.EditEvent:{if(t.timelineRenderingType!==this.state.timelineRenderingType)return;const e=t.event?new se.a(t.event):null;this.setState({editState:e},()=>{var e;t.event&&(null===(e=this.messagePanel)||void 0===e||e.scrollToEventIfNeeded(t.event.getId()))});break}case D.a.ComposerInsert:if(t.composerType)break;b.a.dispatch(Re(Re({},t),{},{composerType:this.state.editState?be.a.Edit:be.a.Send}));break;case D.a.FocusAComposer:b.a.fire(this.state.editState?D.a.FocusEditMessageComposer:D.a.FocusSendMessageComposer);break;case"scroll_to_bottom":var s;if(t.timelineRenderingType===this.context.timelineRenderingType)null===(s=this.messagePanel)||void 0===s||s.jumpToLiveTimeline()}}),o()(this,"onRoomTimeline",(e,t,s,n,i)=>{var a;this.unmounted||t&&t.roomId===(null===(a=this.state.room)||void 0===a?void 0:a.roomId)&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&this.updateE2EStatus(t),!s&&i&&i.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),e.getSender()!==this.context.credentials.userId&&(!this.state.searchResults&&this.state.atEndOfLiveTimeline||Object(u.a)(e,this.state)||this.setState((e,t)=>({numUnreadMessages:e.numUnreadMessages+1}))),"m.room.join_rules"===e.getType()&&this.recalculateUserNameColorMode())))}),o()(this,"onEventDecrypted",e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(e.isDecryptionFailure()||this.handleEffects(e))}),o()(this,"handleEffects",e=>{Y.a.instance.getRoomState(this.state.room).isUnread&&H.CHAT_EFFECTS.forEach(t=>{(Object(G.containsEmoji)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(k.b.getValue("feature_thread")&&e.isThreadRelation||b.a.dispatch({action:"effects."+t.command}))})}),o()(this,"recalculateUserNameColorMode",()=>{const e=this.state.room;if(!e)return;const t=e.currentState.getStateEvents("m.room.join_rules",""),s="public"===(t&&t.getContent().join_rule),n=!!pe.a.shared().getUserIdForRoomId(e.roomId);let i;s?(console.log("for public"),i=k.b.getValue("userNameColorModePublic")):n?(console.log("for DM"),i=k.b.getValue("userNameColorModeDM")):(console.log("for default"),i=k.b.getValue("userNameColorModeGroup")),i!==this.state.userNameColorMode&&this.setState({userNameColorMode:i})}),o()(this,"onRoomName",e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()}),o()(this,"onKeyBackupStatus",()=>{this.forceUpdate()}),o()(this,"canResetTimeline",()=>!this.messagePanel||this.messagePanel.canResetTimeline()),o()(this,"onRoomLoaded",e=>{this.unmounted||(Q.d.instance.on(Q.d.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e),this.checkRightPanel(e),this.setState({liveTimeline:e.getLiveTimeline()}))}),o()(this,"onRoom",e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&Q.d.instance.off(Q.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},()=>{this.onRoomLoaded(e)}))}),o()(this,"onDeviceVerificationChanged",(e,t)=>{const s=this.state.room;s.currentState.getMember(e)&&this.updateE2EStatus(s)}),o()(this,"onUserVerificationChanged",(e,t)=>{const s=this.state.room;s&&s.currentState.getMember(e)&&this.updateE2EStatus(s)}),o()(this,"onCrossSigningKeysChanged",()=>{const e=this.state.room;e&&this.updateE2EStatus(e)}),o()(this,"onAccountData",e=>{const t=e.getType();"org.matrix.preview_urls"!==t&&"im.vector.web.settings"!==t||!this.state.room||this.updatePreviewUrlVisibility(this.state.room),"m.direct"===t&&this.recalculateUserNameColorMode()}),o()(this,"onRoomAccountData",(e,t)=>{if(t.roomId==this.state.roomId){const s=e.getType();"org.matrix.room.preview_urls"!==s&&"im.vector.web.settings"!==s||this.updatePreviewUrlVisibility(t)}}),o()(this,"onRoomStateEvents",(e,t)=>{this.state.room&&this.state.room.roomId===t.roomId&&this.updatePermissions(this.state.room)}),o()(this,"onRoomStateMember",(e,t,s)=>{this.state.room&&s.roomId===this.state.room.roomId&&this.updateRoomMembers()}),o()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))}),o()(this,"updateRoomMembers",Object(ne.throttle)(()=>{this.updateDMState(),this.updateE2EStatus(this.state.room)},500,{leading:!0,trailing:!0})),o()(this,"onSearchResultsFillRequest",e=>{if(!e)return Promise.resolve(!1);if(this.state.searchResults.next_batch){Ie("requesting more search results");const e=Object(E.b)(this.state.searchResults);return this.handleSearchResult(e)}return Ie("no more search results"),Promise.resolve(!1)}),o()(this,"onInviteButtonClick",()=>{b.a.dispatch({action:"view_invite",roomId:this.state.room.roomId})}),o()(this,"onJoinButtonClicked",()=>{this.context&&this.context.isGuest()?(b.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:D.a.ViewRoom,room_id:this.getRoomId()}}),b.a.dispatch({action:"require_registration"})):Promise.resolve().then(()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl;return b.a.dispatch({action:D.a.JoinRoom,roomId:this.getRoomId(),opts:{inviteSignUrl:t},_type:"unknown"}),Promise.resolve()})}),o()(this,"onMessageListScroll",e=>{this.messagePanel.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()}),o()(this,"onDragEnter",e=>{e.stopPropagation(),e.preventDefault(),this.setState({dragCounter:this.state.dragCounter+1}),(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&this.setState({draggingFile:!0})}),o()(this,"onDragLeave",e=>{e.stopPropagation(),e.preventDefault(),this.setState({dragCounter:this.state.dragCounter-1}),0===this.state.dragCounter&&this.setState({draggingFile:!1})}),o()(this,"onDragOver",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy")}),o()(this,"onDrop",e=>{e.stopPropagation(),e.preventDefault(),g.b.sharedInstance().sendContentListToRoom(e.dataTransfer.files,this.state.room.roomId,null,this.context),b.a.fire(D.a.FocusSendMessageComposer),this.setState({draggingFile:!1,dragCounter:this.state.dragCounter-1})}),o()(this,"onSearch",(e,t)=>{let s;this.setState({searchTerm:e,searchScope:t,searchResults:{},searchHighlights:[]}),this.searchResultsPanel.current&&this.searchResultsPanel.current.resetScrollState(),this.searchId=(new Date).getTime(),t===F.a.Room&&(s=this.state.room.roomId),Ie("sending search request");const n=Object(E.a)(e,s);this.handleSearchResult(n)}),o()(this,"onCallPlaced",e=>{b.a.dispatch({action:"place_call",type:e,room_id:this.state.room.roomId})}),o()(this,"onAppsClick",()=>{b.a.dispatch({action:"appsDrawer",show:!this.state.showApps})}),o()(this,"onForgetClick",()=>{b.a.dispatch({action:"forget_room",room_id:this.state.room.roomId})}),o()(this,"onRejectButtonClicked",()=>{this.setState({rejecting:!0}),this.context.leave(this.state.roomId).then(()=>{b.a.dispatch({action:"view_home_page"}),this.setState({rejecting:!1})},e=>{ge.a.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e);v.a.createTrackedDialog("Failed to reject invite","",ie.a,{title:Object(m.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})})}),o()(this,"onRejectAndIgnoreClick",async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.getUserId()).events.member,t=this.context.getIgnoredUsers();t.push(e.getSender()),await this.context.setIgnoredUsers(t),await this.context.leave(this.state.roomId),b.a.dispatch({action:"view_home_page"}),this.setState({rejecting:!1})}catch(e){ge.a.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e);v.a.createTrackedDialog("Failed to reject invite","",ie.a,{title:Object(m.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}}),o()(this,"onRejectThreepidInviteButtonClicked",()=>{b.a.fire(D.a.ViewRoomDirectory)}),o()(this,"onSearchClick",()=>{this.setState({searching:!this.state.searching})}),o()(this,"onCancelSearchClick",()=>{this.setState({searching:!1,searchResults:null})}),o()(this,"jumpToLiveTimeline",()=>{this.state.initialEventId&&this.state.isInitialEventHighlighted?b.a.dispatch({action:D.a.ViewRoom,room_id:this.state.room.roomId}):(this.messagePanel.jumpToLiveTimeline(),b.a.fire(D.a.FocusSendMessageComposer))}),o()(this,"jumpToReadMarker",()=>{this.messagePanel.jumpToReadMarker()}),o()(this,"forgetReadMarker",e=>{e.stopPropagation(),this.messagePanel.forgetReadMarker()}),o()(this,"updateTopUnreadMessagesBar",()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})}),o()(this,"onResize",()=>{if(this.state.layout==R.a.Bubble&&this.state.adaptiveSideBubbles&&this.roomView.current){const e=this.roomView.current.getElementsByClassName("mx_RoomView_MessageList");let t=0;for(let s=0;s<e.length;s++){const n=e[s].getBoundingClientRect();n.width>t&&(t=n.width)}t<1280?this.setState({singleSideBubbles:!1}):this.setState({singleSideBubbles:!0})}}),o()(this,"onStatusBarVisible",()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})}),o()(this,"onStatusBarHidden",()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})}),o()(this,"handleScrollKey",e=>{let t;this.searchResultsPanel.current?t=this.searchResultsPanel.current:this.messagePanel&&(t=this.messagePanel),t&&t.handleScrollKey(e)}),o()(this,"gatherTimelinePanelRef",e=>{this.messagePanel=e}),o()(this,"onHiddenHighlightsClick",()=>{const e=this.getOldRoom();e&&b.a.dispatch({action:"view_room",room_id:e.roomId})});const n=this.context.hasLazyLoadMembersEnabled();this.state={roomId:null,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!n,numUnreadMessages:0,draggingFile:!1,searching:!1,searchResults:null,callState:null,guestsCanJoin:!1,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:x.a.getSharedInstance().isOpenForRoom,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,layout:k.b.getValue("layout"),singleSideBubbles:k.b.getValue("singleSideBubbles"),adaptiveSideBubbles:k.b.getValue("adaptiveSideBubbles"),userNameColorMode:me.a.Uniform,lowBandwidth:k.b.getValue("lowBandwidth"),alwaysShowTimestamps:k.b.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:k.b.getValue("showTwelveHourTimestamps"),readMarkerInViewThresholdMs:k.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:k.b.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEventsInTimeline:k.b.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:this.context&&this.context.isInitialSyncComplete(),mainSplitContentType:Te.Timeline,dragCounter:0,timelineRenderingType:j.a.Room,liveTimeline:void 0},this.dispatcherRef=b.a.register(this.onAction),this.context.on("Room",this.onRoom),this.context.on("Room.timeline",this.onRoomTimeline),this.context.on("Room.name",this.onRoomName),this.context.on("Room.accountData",this.onRoomAccountData),this.context.on("RoomState.events",this.onRoomStateEvents),this.context.on("RoomState.members",this.onRoomStateMember),this.context.on("Room.myMembership",this.onMyMembership),this.context.on("accountData",this.onAccountData),this.context.on("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.on("userTrustStatusChanged",this.onUserVerificationChanged),this.context.on("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.context.on("Event.decrypted",this.onEventDecrypted),this.roomStoreToken=w.a.addListener(this.onRoomViewStoreUpdate),this.rightPanelStoreToken=x.a.getSharedInstance().addListener(this.onRightPanelStoreUpdate),O.a.on($.b,this.onWidgetEchoStoreUpdate),q.a.instance.on($.b,this.onWidgetStoreUpdate),this.settingWatchers=[k.b.watchSetting("layout",null,(...[,,,e])=>this.setState({layout:e})),k.b.watchSetting("singleSideBubbles",null,(...[,,,e])=>this.setState({singleSideBubbles:e})),k.b.watchSetting("adaptiveSideBubbles",null,(...[,,,e])=>this.setState({adaptiveSideBubbles:e,singleSideBubbles:k.b.getValue("singleSideBubbles")})),k.b.watchSetting("userNameColorModeDM",null,(...[,,,e])=>this.recalculateUserNameColorMode()),k.b.watchSetting("userNameColorModeGroup",null,(...[,,,e])=>this.recalculateUserNameColorMode()),k.b.watchSetting("userNameColorModePublic",null,(...[,,,e])=>this.recalculateUserNameColorMode()),k.b.watchSetting("lowBandwidth",null,(...[,,,e])=>this.setState({lowBandwidth:e})),k.b.watchSetting("alwaysShowTimestamps",null,(...[,,,e])=>this.setState({alwaysShowTimestamps:e})),k.b.watchSetting("showTwelveHourTimestamps",null,(...[,,,e])=>this.setState({showTwelveHourTimestamps:e})),k.b.watchSetting("readMarkerInViewThresholdMs",null,(...[,,,e])=>this.setState({readMarkerInViewThresholdMs:e})),k.b.watchSetting("readMarkerOutOfViewThresholdMs",null,(...[,,,e])=>this.setState({readMarkerOutOfViewThresholdMs:e})),k.b.watchSetting("showHiddenEventsInTimeline",null,(...[,,,e])=>this.setState({showHiddenEventsInTimeline:e}))]}getPermalinkCreatorForRoom(e){return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new p.a(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,s,n){!s&&t&&(!e&&n?(ge.a.info("Attempting to peek into room %s",t),this.setState({peekLoading:!0,isPeeking:!0}),this.context.peekInRoom(t).then(e=>{this.unmounted||(this.setState({room:e,peekLoading:!1}),this.onRoomLoaded(e))}).catch(e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}})):e&&(this.context.stopPeeking(),this.setState({isPeeking:!1})))}shouldShowApps(e){if(!xe||!e)return!1;const t=e.roomId+"_hide_widget_drawer",s=localStorage.getItem(t),n=!s||"false"===s,i=Q.d.instance.getContainerWidgets(e,Q.a.Top);return n&&i.length>0}componentDidMount(){this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=e?e.state:null;this.setState({callState:t}),window.addEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResized",this.onResize),this.onResize(),this.recalculateUserNameColorMode()}shouldComponentUpdate(e,t){const s=Object(Z.d)(this.props,e),n=this.state,{upgradeRecommendation:a}=n,o=i()(n,Se),{upgradeRecommendation:r}=t,c=i()(t,_e),l=(null==r?void 0:r.needsUpgrade)!==(null==a?void 0:a.needsUpgrade)||Object(Z.d)(o,c);return s||l}componentDidUpdate(){if(this.roomView.current){const e=this.roomView.current;e.ondrop||(e.addEventListener("drop",this.onDrop),e.addEventListener("dragover",this.onDragOver),e.addEventListener("dragenter",this.onDragEnter),e.addEventListener("dragleave",this.onDragLeave))}this.messagePanel&&!this.state.atEndOfLiveTimelineInit&&this.setState({atEndOfLiveTimelineInit:!0,atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()}),this.onResize(),this.recalculateUserNameColorMode()}componentWillUnmount(){if(this.unmounted=!0,this.state.roomId&&C.a.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek&&this.context.stopPeeking(),this.stopAllPermalinkCreators(),this.roomView.current){const e=this.roomView.current;e.removeEventListener("drop",this.onDrop),e.removeEventListener("dragover",this.onDragOver),e.removeEventListener("dragenter",this.onDragEnter),e.removeEventListener("dragleave",this.onDragLeave)}b.a.unregister(this.dispatcherRef),this.context&&(this.context.removeListener("Room",this.onRoom),this.context.removeListener("Room.timeline",this.onRoomTimeline),this.context.removeListener("Room.name",this.onRoomName),this.context.removeListener("Room.accountData",this.onRoomAccountData),this.context.removeListener("RoomState.events",this.onRoomStateEvents),this.context.removeListener("Room.myMembership",this.onMyMembership),this.context.removeListener("RoomState.members",this.onRoomStateMember),this.context.removeListener("accountData",this.onAccountData),this.context.removeListener("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),this.context.removeListener("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.context.removeListener("Event.decrypted",this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResized",this.onResize),this.roomStoreToken&&this.roomStoreToken.remove(),this.rightPanelStoreToken&&this.rightPanelStoreToken.remove(),O.a.removeListener($.b,this.onWidgetEchoStoreUpdate),q.a.instance.removeListener($.b,this.onWidgetStoreUpdate),this.state.room&&Q.d.instance.off(Q.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)k.b.unwatchSetting(e)}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){if(this.context.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const s=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;ge.a.error(s),ge.a.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents("m.room.guest_access","");t&&"can_join"===t.getContent().guest_access&&this.setState({guestsCanJoin:!0});const s=e.currentState.getStateEvents("m.room.history_visibility","");s&&"world_readable"===s.getContent().history_visibility&&this.setState({canPeek:!0})}updatePreviewUrlVisibility({roomId:e}){const t=this.context.isRoomEncrypted(e)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:k.b.getValue(t,e)})}async updateE2EStatus(e){if(!this.context.isRoomEncrypted(e.roomId))return;let t=P.a.Warning;this.context.isCryptoEnabled()&&(t=await Object(P.b)(this.context,e)),this.unmounted||this.setState({e2eStatus:t})}updatePermissions(e){if(e){const t=this.context.getUserId(),s="join"===e.getMyMembership()&&e.currentState.maySendEvent("m.reaction",t),n=e.maySendMessage();this.setState({canReact:s,canReply:n})}}checkDesktopNotifications(){this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&z.default.shouldShowPrompt()&&Object(J.b)(!0)}updateDMState(){const e=this.state.room;if("join"!=e.getMyMembership())return;const t=e.getDMInviter();t&&y.g(e.roomId,t)}injectSticker(e,t,s){this.context.isGuest()?b.a.dispatch({action:"require_registration"}):g.b.sharedInstance().sendStickerContentToRoom(e,this.state.room.roomId,t,s,this.context).then(void 0,e=>{e.name})}handleSearchResult(e){const t=this.searchId;return this.setState({searchInProgress:!0}),e.then(e=>{if(Ie("search complete"),this.unmounted||!this.state.searching||this.searchId!=t)return ge.a.error("Discarding stale search results"),!1;let s=e.highlights;s.indexOf(this.state.searchTerm)<0&&(s=s.concat(this.state.searchTerm)),s=s.sort((function(e,t){return t.length-e.length})),this.setState({searchHighlights:s,searchResults:e})},e=>(ge.a.error("Search failed",e),v.a.createTrackedDialog("Search failed","",ie.a,{title:Object(m.a)("Search failed"),description:e&&e.message?e.message:Object(m.a)("Server may be unavailable, overloaded, or search timed out :(")}),!1)).finally(()=>{this.setState({searchInProgress:!1})})}getSearchResultTiles(){const e=[];var t,s;(this.state.searchInProgress&&e.push(c.a.createElement("li",{key:"search-spinner"},c.a.createElement(oe.a,null))),this.state.searchResults.next_batch)||(null!==(t=this.state.searchResults)&&void 0!==t&&null!==(s=t.results)&&void 0!==s&&s.length?e.push(c.a.createElement("li",{key:"search-top-marker"},c.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(m.a)("No more results")))):e.push(c.a.createElement("li",{key:"search-top-marker"},c.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(m.a)("No results")))));const n=()=>{const e=this.searchResultsPanel.current;e&&e.checkScroll()};let i;for(let t=((null===(a=this.state.searchResults)||void 0===a||null===(o=a.results)||void 0===o?void 0:o.length)||0)-1;t>=0;t--){var a,o;const s=this.state.searchResults.results[t],r=s.context.getEvent(),l=r.getRoomId(),d=this.context.getRoom(l);if(!d){ge.a.log("Hiding search result from an unknown room",l);continue}if(!Object(T.d)(r,this.state.showHiddenEventsInTimeline))continue;"All"===this.state.searchScope&&l!==i&&(e.push(c.a.createElement("li",{key:r.getId()+"-room"},c.a.createElement("h2",null,Object(m.a)("Room"),": ",d.name))),i=l);const h="#/room/"+l+"/"+r.getId();e.push(c.a.createElement(ae.a,{key:r.getId(),searchResult:s,searchHighlights:this.state.searchHighlights,resultLink:h,permalinkCreator:this.getPermalinkCreatorForRoom(d),onHeightChanged:n,layout:this.state.layout,singleSideBubbles:this.state.singleSideBubbles,userNameColorMode:this.state.userNameColorMode}))}return e}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?f.d.sharedInstance().getCallForRoom(this.state.room.roomId):null}getOldRoom(){const e=this.state.room.currentState.getStateEvents("m.room.create","");return e&&e.getContent().predecessor?this.context.getRoom(e.getContent().predecessor.room_id):null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount("highlight"):0}render(){var e;if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return c.a.createElement("div",{className:"mx_RoomView"},c.a.createElement(U.a,null,c.a.createElement(L.a,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData})))}{var t,n;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const s=null===(t=this.props.threepidInvite)||void 0===t?void 0:t.toEmail,i=this.state.roomAlias;return c.a.createElement("div",{className:"mx_RoomView"},c.a.createElement(U.a,null,c.a.createElement(L.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:i,joining:this.state.joining,inviterName:e,invitedEmail:s,oobData:this.props.oobData,signUrl:null===(n=this.props.threepidInvite)||void 0===n?void 0:n.signUrl,room:this.state.room})))}}const i=this.state.room.getMyMembership();if(!("invite"!==i||ue.a.spacesEnabled&&this.state.room.isSpaceRoom())){if(this.state.joining||this.state.rejecting)return c.a.createElement(U.a,null,c.a.createElement(L.a,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting}));{const e=this.context.credentials.userId,t=this.state.room.getMember(e),s=t?t.events.member:null;let n=Object(m.a)("Unknown");return s&&(n=s.sender?s.sender.name:s.getSender()),c.a.createElement("div",{className:"mx_RoomView"},c.a.createElement(U.a,null,c.a.createElement(L.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:n,canPreview:!1,joining:this.state.joining,room:this.state.room})))}}let a=null;this.state.draggingFile&&(a=c.a.createElement("div",{className:"mx_RoomView_fileDropTarget"},c.a.createElement("img",{src:s(1611),className:"mx_RoomView_fileDropTarget_image"}),Object(m.a)("Drop file here to upload")));let o=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(o=e)}const r=d()({mx_RoomView_scrollheader:!0});let l,u=!0;g.b.sharedInstance().getCurrentUploads().length>0?l=c.a.createElement(re.a,{room:this.state.room}):this.state.searchResults||(u=this.state.statusBarVisible,l=c.a.createElement(ce.a,{room:this.state.room,isPeeking:"join"!==i,onInviteClick:this.onInviteButtonClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const p=d()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:u}),v=l&&c.a.createElement("div",{className:p},c.a.createElement("div",{className:"mx_RoomView_statusAreaBox"},c.a.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),l)),f=this.state.upgradeRecommendation,b=f&&f.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.credentials.userId),y=this.getHiddenHighlightCount();let E,w=null;if(this.state.searching)w=c.a.createElement(F.b,{searchInProgress:this.state.searchInProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch,isRoomEncrypted:this.context.isRoomEncrypted(this.state.room.roomId)});else if(b)w=c.a.createElement(B.a,{room:this.state.room});else if("join"!==i){var C,O;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(C=this.props.threepidInvite)||void 0===C?void 0:C.toEmail;if(E=c.a.createElement(L.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room}),!(this.state.canPeek||ue.a.spacesEnabled&&null!==(O=this.state.room)&&void 0!==O&&O.isSpaceRoom()))return c.a.createElement("div",{className:"mx_RoomView"},E)}else y>0&&(w=c.a.createElement(I.a,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},Object(m.a)("You have %(count)s unread notifications in a prior version of this room.",{count:y})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return c.a.createElement(ee.a,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const x=c.a.createElement(V.a,{room:this.state.room,userId:this.context.credentials.userId,showApps:this.state.showApps,onResize:this.onResize,resizeNotifier:this.props.resizeNotifier},w);let T,N;"join"===i&&!this.state.searchResults&&(T=c.a.createElement(le.a,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),layout:this.state.layout,userNameColorMode:this.state.userNameColorMode})),this.state.searchResults&&(N={searchTerm:this.state.searchTerm,searchScope:this.state.searchScope,searchCount:this.state.searchResults.count});const P={mx_IRCLayout:this.state.layout==R.a.IRC,mx_GroupLayout:this.state.layout==R.a.Group,sc_BubbleLayout:this.state.layout==R.a.Bubble,sc_BubbleLayout_singleSide:this.state.layout==R.a.Bubble&&this.state.singleSideBubbles};let D,G=!1;if(this.state.searchResults){if(void 0===this.state.searchResults.count)D=c.a.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"});else{const e=d()("mx_RoomView_messagePanel","mx_RoomView_searchResultsPanel",P);D=c.a.createElement(M.a,{ref:this.searchResultsPanel,className:e,onFillRequest:this.onSearchResultsFillRequest,resizeNotifier:this.props.resizeNotifier},c.a.createElement("li",{className:r}),this.getSearchResultTiles())}G=!0}let H=null;this.state.isInitialEventHighlighted&&(H=this.state.initialEventId);const q=d()("mx_RoomView_messagePanel",P),$=c.a.createElement(A.a,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:G,highlightedEventId:H,eventId:this.state.initialEventId,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onUserScroll:this.onUserScroll,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:q,membersLoaded:this.state.membersLoaded,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,singleSideBubbles:this.state.singleSideBubbles,userNameColorMode:this.state.userNameColorMode,editState:this.state.editState});let z,J=null;this.state.showTopUnreadMessagesBar&&!this.state.searchResults&&(J=c.a.createElement(he.a,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),this.state.atEndOfLiveTimeline||this.state.searchResults||(z=c.a.createElement(de.a,{highlight:this.state.room.getUnreadNotificationCount(h.a.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const Y=this.state.room&&this.state.showRightPanel?c.a.createElement(_.a,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),userNameColorMode:this.state.userNameColorMode,e2eStatus:this.state.e2eStatus}):null,Q=d()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),X=d()("mx_RoomView",{mx_RoomView_inCall:Boolean(o)}),Z=k.b.getValue("showChatEffects");let te=c.a.createElement(c.a.Fragment,null,x,c.a.createElement("div",{className:Q},a,J,z,$,D),v,E,T);switch(this.state.mainSplitContentType){case Te.Timeline:break;case Te.MaximisedWidget:if(!k.b.getValue("feature_maximised_widgets"))break;te=c.a.createElement(ye.a,{room:this.state.room,userId:this.context.credentials.userId,resizeNotifier:this.props.resizeNotifier,showApps:!0})}let se=[Ee.c.Timeline],ne=this.onAppsClick,ie=this.onForgetClick,ae=this.onSearchClick;return this.state.mainSplitContentType===Te.MaximisedWidget&&(se=[Ee.c.ThreadPanel,Ee.c.PinnedMessages],ne=null,ie=null,ae=null),c.a.createElement(j.b.Provider,{value:this.state},c.a.createElement("main",{className:X,ref:this.roomView,onKeyDown:this.onReactKeyDown},Z&&this.roomView.current&&c.a.createElement(W.a,{roomWidth:this.roomView.current.offsetWidth}),c.a.createElement(U.a,null,c.a.createElement(K.a,{room:this.state.room,searchInfo:N,oobData:this.props.oobData,inRoom:"join"===i,onSearchClick:ae,onForgetClick:"leave"===i?ie:null,e2eStatus:this.state.e2eStatus,onAppsClick:this.state.hasPinnedWidgets?ne:null,appsShown:this.state.showApps,onCallPlaced:this.onCallPlaced,excludedRightPanelPhaseButtons:se}),c.a.createElement(S.a,{panel:Y,resizeNotifier:this.props.resizeNotifier},c.a.createElement("div",{className:"mx_RoomView_body"},te)))))}},o()(Ce,"contextType",N.a),we=Oe))||we;const Ne=Object(N.b)(je);t.a=Ne}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"c",(function(){return p})),s.d(t,"a",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"b",(function(){return f}));var n=s(86),i=s(87),a=s(90),o=s(122),r=s(141),c=s(188),l=s(347),d=s(92),h=s(884),u=s(885);async function m(){const e=n.a.get();if(!e.isCryptoEnabled())return!1;return!!e.getCrossSigningId("user_signing")||(await Object(c.b)(),!1)}async function p(e,t){const s=n.a.get();s.isGuest()?i.a.dispatch({action:"require_registration"}):s.getCryptoTrustCrossSignedDevices()&&!await m()||a.a.createTrackedDialog("Verification warning","unverified session",h.a,{user:e,device:t,onFinished:async n=>{if("sas"===n){const n=s.legacyDeviceVerification(e.userId,t.deviceId,l.d.SAS);i.a.dispatch({action:d.a.SetRightPanelPhase,phase:o.c.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:n}})}else"legacy"===n&&a.a.createTrackedDialog("Legacy verify session","legacy verify session",u.a,{userId:e.userId,device:t})}})}async function g(e){const t=n.a.get();if(t.isGuest())return void i.a.dispatch({action:"require_registration"});if(t.getCryptoTrustCrossSignedDevices()&&!await m())return;const s=t.requestVerification(e.userId);i.a.dispatch({action:d.a.SetRightPanelPhase,phase:o.c.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:s}})}async function v(e){if(n.a.get().isGuest())return void i.a.dispatch({action:"require_registration"});if(!await m())return;const t=f(e);i.a.dispatch({action:d.a.SetRightPanelPhase,phase:o.c.EncryptionPanel,refireParams:{member:e,verificationRequest:t}})}function f(e){const t=n.a.get(),s=Object(r.e)(t,e.userId);if(s)return t.findVerificationRequestDMInProgress(s.roomId)}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(86),r=s(215),c=s(88),l=s(97);t.a=({device:e,user:t,onFinished:s})=>{let n,d;return o.a.get().getUserId()===t.userId?(d=Object(a.a)("You signed in to a new session without verifying it:"),n=Object(a.a)("Verify your other session using one of the options below.")):(d=Object(a.a)("%(name)s (%(userId)s) signed in to a new session without verifying it:",{name:t.displayName,userId:t.userId}),n=Object(a.a)("Ask this user to verify their session, or manually verify it below.")),i.a.createElement(l.a,{onFinished:s,className:"mx_UntrustedDeviceDialog",title:i.a.createElement(i.a.Fragment,null,i.a.createElement(r.b,{status:r.a.Warning,size:24,hideTooltip:!0}),Object(a.a)("Not Trusted"))},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("p",null,d),i.a.createElement("p",null,e.getDisplayName()," (",e.deviceId,")"),i.a.createElement("p",null,n)),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement(c.a,{element:"button",kind:"secondary",onClick:()=>s("legacy")},Object(a.a)("Manually Verify by Text")),i.a.createElement(c.a,{element:"button",kind:"secondary",onClick:()=>s("sas")},Object(a.a)("Interactively verify by Emoji")),i.a.createElement(c.a,{kind:"primary",onClick:()=>s(!1)},Object(a.a)("Done"))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(161),d=s(84),h=s(85),u=s(113);let m=Object(h.a)("views.dialogs.ManualDeviceKeyVerificationDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onLegacyFinished",e=>{e&&c.a.get().setDeviceVerified(this.props.userId,this.props.device.deviceId,!0),this.props.onFinished(e)})}render(){let e;e=c.a.get().getUserId()===this.props.userId?Object(d.a)("Confirm by comparing the following with the User Settings in your other session:"):Object(d.a)("Confirm this user's session by comparing the following with their User Settings:");const t=l.e(this.props.device.getFingerprint()),s=r.a.createElement("div",null,r.a.createElement("p",null,e),r.a.createElement("div",{className:"mx_DeviceVerifyDialog_cryptoSection"},r.a.createElement("ul",null,r.a.createElement("li",null,r.a.createElement("label",null,Object(d.a)("Session name"),":")," ",r.a.createElement("span",null,this.props.device.getDisplayName())),r.a.createElement("li",null,r.a.createElement("label",null,Object(d.a)("Session ID"),":")," ",r.a.createElement("span",null,r.a.createElement("code",null,this.props.device.deviceId))),r.a.createElement("li",null,r.a.createElement("label",null,Object(d.a)("Session key"),":")," ",r.a.createElement("span",null,r.a.createElement("code",null,r.a.createElement("b",null,t)))))),r.a.createElement("p",null,Object(d.a)("If they don't match, the security of your communication may be compromised.")));return r.a.createElement(u.a,{title:Object(d.a)("Verify session"),description:s,button:Object(d.a)("Verify session"),onFinished:this.onLegacyFinished})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(82),i=s(135);function a(e,t){const[s,a]=Object(n.useState)(t?e.isRoomEncrypted(t.roomId):void 0),o=Object(n.useCallback)(s=>{t&&"m.room.encryption"===s.getType()&&a(e.isRoomEncrypted(t.roomId))},[e,t]);return Object(i.a)(t?t.currentState:void 0,"RoomState.events",o),s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return o})),s.d(t,"d",(function(){return r}));var n=s(84);let i,a;!function(e){e.Html="Html",e.PlainText="PlainText",e.Json="Json"}(i||(i={})),function(e){e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages"}(a||(a={}));const o=e=>{switch(e){case i.Html:return Object(n.a)("HTML");case i.Json:return Object(n.a)("JSON");case i.PlainText:return Object(n.a)("Plain Text");default:throw new Error("Unknown format")}},r=e=>{switch(e){case a.Beginning:return Object(n.a)("From the beginning");case a.LastNMessages:return Object(n.a)("Specify a number of messages");case a.Timeline:return Object(n.a)("Current Timeline");default:throw new Error("Unknown type: "+e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(89),l=s(889),d=s(100),h=s(85);let u=Object(h.a)("views.elements.IRCTimelineProfileResizer")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"dragFunc",(e,t)=>{const s=t.clientX-e.currentX,n=this.state.width+s;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})}),this.state={width:c.b.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},()=>this.updateCSSWidth(this.state.width))}updateCSSWidth(e){this.state.IRCLayoutRoot.style.setProperty("--name-width",e+"px")}onMoueUp(e){this.props.roomId&&c.b.setValue("ircDisplayNameWidth",this.props.roomId,d.a.ROOM_DEVICE,this.state.width)}render(){return r.a.createElement(l.a,{className:"mx_ProfileResizer",dragFunc:this.dragFunc.bind(this),onMouseUp:this.onMoueUp.bind(this)})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85);let l=Object(c.a)("views.elements.Draggable")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onMouseDown",e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)}),a()(this,"onMouseUp",e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)}),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return r.a.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown.bind(this)})}})||n},function(e,t,s){"use strict";(function(e){var n=s(82),i=s.n(n),a=s(94),o=s(98),r=s(118),c=s(130),l=s(84),d=s(88),h=s(555),u=s(126),m=s(87),p=s(92),g=s(106),v=s(186),f=s(141),b=s(241),y=s(325),E=s(86),S=s(221),_=s(115);t.a=()=>{const t=Object(n.useContext)(o.a),{room:s,roomId:w}=Object(n.useContext)(r.b),C=c.a.shared().getUserIdForRoomId(w);let O;if(C){let e;s.getJoinedMemberCount()+s.getInvitedMemberCount()===2&&(e=Object(l.a)("Only the two of you are in this conversation, unless either of you invites anyone to join."));const t=null==s?void 0:s.getMember(C),n=(null==t?void 0:t.rawDisplayName)||C;O=i.a.createElement(i.a.Fragment,null,i.a.createElement(u.a,{room:s,width:h.a,height:h.a,onClick:()=>{m.a.dispatch({action:p.a.ViewUser,member:t||{userId:C}})}}),i.a.createElement("h2",null,s.name),i.a.createElement("p",null,Object(l.a)("This is the beginning of your direct message history with <displayName/>.",{},{displayName:()=>i.a.createElement("b",null,n)})),e&&i.a.createElement("p",null,e))}else{var k,R,I,x,T,j,N;const n=s&&"join"===s.getMyMembership(),o=null===(k=s.currentState.getStateEvents(a.a.RoomTopic,""))||void 0===k||null===(R=k.getContent())||void 0===R?void 0:R.topic,r=n&&s.currentState.maySendStateEvent(a.a.RoomTopic,t.getUserId()),c=()=>{m.a.dispatch({action:"open_room_settings",room_id:w},!0),e(()=>{window.document.getElementById("profileTopic").focus()})};let p;r&&o?p=Object(l.a)("Topic: %(topic)s (<a>edit</a>)",{topic:o},{a:e=>i.a.createElement(d.a,{kind:"link",onClick:c},e)}):o?p=Object(l.a)("Topic: %(topic)s ",{topic:o}):r&&(p=Object(l.a)("<a>Add a topic</a> to help people know what it is about.",{},{a:e=>i.a.createElement(d.a,{kind:"link",element:"span",onClick:c},e)}));const f=null===(I=s.currentState.getStateEvents(a.a.RoomCreate,""))||void 0===I?void 0:I.getSender(),b=(null==s||null===(x=s.getMember(f))||void 0===x?void 0:x.rawDisplayName)||f;let y,E,C;y=f===t.getUserId()?Object(l.a)("You created this room."):Object(l.a)("%(displayName)s created this room.",{displayName:b}),null!==(T=g.a.instance.activeSpaceRoom)&&void 0!==T&&T.canInvite(t.getUserId())&&g.a.instance.getSpaceFilteredRoomIds(g.a.instance.activeSpace).has(s.roomId)&&(E=g.a.instance.activeSpaceRoom),E?C=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{Object(v.i)(E)}},Object(l.a)("Invite to %(spaceName)s",{spaceName:E.name})),s.canInvite(t.getUserId())&&i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{m.a.dispatch({action:"view_invite",roomId:w})}},Object(l.a)("Invite to just this room"))):s.canInvite(t.getUserId())&&Object(S.a)(_.a.InviteUsers)&&(C=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{m.a.dispatch({action:"view_invite",roomId:w})}},Object(l.a)("Invite to this room"))));const P=null===(j=s.currentState.getStateEvents(a.a.RoomAvatar,""))||void 0===j||null===(N=j.getContent())||void 0===N?void 0:N.url;O=i.a.createElement(i.a.Fragment,null,i.a.createElement(h.b,{hasAvatar:!!P,noAvatarLabel:Object(l.a)("Add a photo, so people can easily spot your room."),setAvatarUrl:e=>t.sendStateEvent(w,a.a.RoomAvatar,{url:e},"")},i.a.createElement(u.a,{room:s,width:h.a,height:h.a})),i.a.createElement("h2",null,s.name),i.a.createElement("p",null,y," ",Object(l.a)("This is the start of <roomName/>.",{},{roomName:()=>i.a.createElement("b",null,s.name)})),i.a.createElement("p",null,p),C)}const P=Object(l.a)("Your private messages are normally encrypted, but this room isn't. Usually this is due to an unsupported device or method being used, like email invites.");let D;s.currentState.mayClientSendStateEvent(a.a.RoomEncryption,E.a.get())&&(D=i.a.createElement("a",{onClick:function(e){e.preventDefault(),m.a.dispatch({action:"open_room_settings",initial_tab_id:y.b})},href:"#"}," ",Object(l.a)("Enable encryption in settings.")));const M=i.a.createElement("span",null," ",P," ",D," ");return i.a.createElement("div",{className:"mx_NewRoomIntro"},!function(e,t){const s=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!Object(f.f)()||s}(t,s)&&i.a.createElement(b.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:Object(l.a)("End-to-end encryption isn't enabled"),subtitle:M}),O)}}).call(this,s(175).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return p})),s.d(t,"c",(function(){return g}));var n=s(83),i=s.n(n),a=s(94),o=s(163),r=s(151),c=s(5),l=s(86),d=s(87);let h;!function(e){e.StateChanged="state_changed",e.SilencedChanged="silenced_changed",e.LengthChanged="length_changed"}(h||(h={}));const u=[o.e.Connecting,o.e.WaitLocalMedia,o.e.CreateOffer,o.e.CreateAnswer],m=[o.e.Connected,o.e.Ringing];let p;!function(e){e.Missed="missed"}(p||(p={}));class g extends c.EventEmitter{constructor(){super(),i()(this,"events",new Set),i()(this,"call",void 0),i()(this,"state",void 0),i()(this,"onSilencedCallsChanged",()=>{const e=r.d.sharedInstance().isCallSilenced(this.callId);this.emit(h.SilencedChanged,e)}),i()(this,"onLengthChanged",e=>{this.emit(h.LengthChanged,e)}),i()(this,"answerCall",()=>{d.a.dispatch({action:"answer",room_id:this.roomId})}),i()(this,"rejectCall",()=>{d.a.dispatch({action:"reject",room_id:this.roomId})}),i()(this,"callBack",()=>{d.a.dispatch({action:"place_call",type:this.isVoice?o.f.Voice:o.f.Video,room_id:this.roomId})}),i()(this,"toggleSilenced",()=>{r.d.sharedInstance().isCallSilenced(this.callId)?r.d.sharedInstance().unSilenceCall(this.callId):r.d.sharedInstance().silenceCall(this.callId)}),i()(this,"setState",()=>{var e,t;u.includes(null===(e=this.call)||void 0===e?void 0:e.state)?this.state=o.e.Connecting:m.includes(null===(t=this.call)||void 0===t?void 0:t.state)?this.state=this.call.state:this.callWasMissed?this.state=p.Missed:this.reject||this.hangup?this.state=o.e.Ended:this.invite&&this.call&&(this.state=o.e.Connecting),this.emit(h.StateChanged,this.state)}),i()(this,"setCall",()=>{this.call||(this.call=r.d.sharedInstance().getCallById(this.callId),this.setCallListeners(),this.setState())}),r.d.sharedInstance().addListener(r.a.CallsChanged,this.setCall),r.d.sharedInstance().addListener(r.a.SilencedCallsChanged,this.onSilencedCallsChanged)}get invite(){return[...this.events].find(e=>e.getType()===a.a.CallInvite)}get hangup(){return[...this.events].find(e=>e.getType()===a.a.CallHangup)}get reject(){return[...this.events].find(e=>e.getType()===a.a.CallReject)}get selectAnswer(){return[...this.events].find(e=>e.getType()===a.a.CallSelectAnswer)}get isVoice(){var e,t,s;const n=this.invite;if(n)return-1===(null===(e=n.getContent())||void 0===e||null===(t=e.offer)||void 0===t||null===(s=t.sdp)||void 0===s?void 0:s.indexOf("m=video"))}get hangupReason(){var e,t;return null===(e=this.hangup)||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.reason}get rejectParty(){var e;return null===(e=this.reject)||void 0===e?void 0:e.getSender()}get gotRejected(){return Boolean(this.reject)}get duration(){if(this.hangup&&this.selectAnswer)return new Date(this.hangup.getDate().getTime()-this.selectAnswer.getDate().getTime())}get callWasMissed(){return![...this.events].some(e=>{var t;return(null===(t=e.sender)||void 0===t?void 0:t.userId)===l.a.get().getUserId()})}get callId(){var e,t;return null===(e=[...this.events][0])||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.call_id}get roomId(){var e;return null===(e=[...this.events][0])||void 0===e?void 0:e.getRoomId()}setCallListeners(){this.call&&(this.call.addListener(o.c.State,this.setState),this.call.addListener(o.c.LengthChanged,this.onLengthChanged))}add(e){this.events.add(e),this.setCall()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(161),u=s(159),m=s(569),p=s(85),g=s(87),v=s(122),f=s(92),b=s(677),y=s(94),E=s(133);const S=()=>{g.a.dispatch({action:f.a.SetRightPanelPhase,phase:v.c.PinnedMessages,allowClose:!1})},_=[y.a.RoomServerAcl,y.a.RoomPinnedEvents];var w;!function(e){e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages"}(w||(w={}));let C=Object(p.a)("views.elements.MemberEventListSummary")((a=i=class e extends l.a.Component{shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold}generateSummary(t,s){const n=s.map(s=>{const n=t[s],i=this.renderNameList(n),a=s.split(","),o=e.getCanonicalTransitions(a),r=e.coalesceRepeatedTransitions(o).map(t=>e.getDescriptionForTransition(t.transitionType,n.length,t.repeats)),c=Object(h.b)(r);return Object(d.a)("%(nameList)s %(transitionList)s",{nameList:i,transitionList:c})});return n?Object(b.a)(n,", "):null}renderNameList(e){return Object(h.b)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[w.Joined]:{after:w.Left,newTransition:w.JoinedAndLeft},[w.Left]:{after:w.Joined,newTransition:w.LeftAndJoined}},s=[];for(let n=0;n<e.length;n++){const i=e[n],a=e[n+1];let o=i;n<e.length-1&&t[i]&&t[i].after===a&&(o=t[i].newTransition,n++),s.push(o)}return s}static coalesceRepeatedTransitions(e){const t=[];for(let s=0;s<e.length;s++)t.length>0&&t[t.length-1].transitionType===e[s]?t[t.length-1].repeats+=1:t.push({transitionType:e[s],repeats:1});return t}static getDescriptionForTransition(e,t,s){let n=null;switch(e){case"joined":n=t>1?Object(d.a)("%(severalUsers)sjoined %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)sjoined %(count)s times",{oneUser:"",count:s});break;case"left":n=t>1?Object(d.a)("%(severalUsers)sleft %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)sleft %(count)s times",{oneUser:"",count:s});break;case"joined_and_left":n=t>1?Object(d.a)("%(severalUsers)sjoined and left %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)sjoined and left %(count)s times",{oneUser:"",count:s});break;case"left_and_joined":n=t>1?Object(d.a)("%(severalUsers)sleft and rejoined %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)sleft and rejoined %(count)s times",{oneUser:"",count:s});break;case"invite_reject":n=t>1?Object(d.a)("%(severalUsers)srejected their invitations %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)srejected their invitation %(count)s times",{oneUser:"",count:s});break;case"invite_withdrawal":n=t>1?Object(d.a)("%(severalUsers)shad their invitations withdrawn %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)shad their invitation withdrawn %(count)s times",{oneUser:"",count:s});break;case"invited":n=t>1?Object(d.a)("were invited %(count)s times",{count:s}):Object(d.a)("was invited %(count)s times",{count:s});break;case"banned":n=t>1?Object(d.a)("were banned %(count)s times",{count:s}):Object(d.a)("was banned %(count)s times",{count:s});break;case"unbanned":n=t>1?Object(d.a)("were unbanned %(count)s times",{count:s}):Object(d.a)("was unbanned %(count)s times",{count:s});break;case"kicked":n=t>1?Object(d.a)("were kicked %(count)s times",{count:s}):Object(d.a)("was kicked %(count)s times",{count:s});break;case"changed_name":n=t>1?Object(d.a)("%(severalUsers)schanged their name %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)schanged their name %(count)s times",{oneUser:"",count:s});break;case"changed_avatar":n=t>1?Object(d.a)("%(severalUsers)schanged their avatar %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)schanged their avatar %(count)s times",{oneUser:"",count:s});break;case"no_change":n=t>1?Object(d.a)("%(severalUsers)smade no changes %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)smade no changes %(count)s times",{oneUser:"",count:s});break;case"server_acl":n=t>1?Object(d.a)("%(severalUsers)schanged the server ACLs %(count)s times",{severalUsers:"",count:s}):Object(d.a)("%(oneUser)schanged the server ACLs %(count)s times",{oneUser:"",count:s});break;case"pinned_messages":n=t>1?Object(d.a)("%(severalUsers)schanged the <a>pinned messages</a> for the room %(count)s times.",{severalUsers:"",count:s},{a:e=>l.a.createElement("a",{onClick:S}," ",e," ")}):Object(d.a)("%(oneUser)schanged the <a>pinned messages</a> for the room %(count)s times.",{oneUser:"",count:s},{a:e=>l.a.createElement("a",{onClick:S}," ",e," ")})}return n}static getTransitionSequence(t){return t.map(e.getTransition)}static getTransition(e){const t=e.mxEvent.getType();if(t===y.a.RoomThirdPartyInvite)return Object(u.c)(e.mxEvent)?w.Invited:w.InviteWithdrawal;if(t===y.a.RoomServerAcl)return w.ServerAcl;if(t===y.a.RoomPinnedEvents)return w.ChangedPins;switch(e.mxEvent.getContent().membership){case"invite":return w.Invited;case"ban":return w.Banned;case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?w.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?w.ChangedAvatar:w.NoChange:w.Joined;case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())switch(e.mxEvent.getPrevContent().membership){case"invite":return w.InviteReject;default:return w.Left}switch(e.mxEvent.getPrevContent().membership){case"invite":return w.InviteWithdrawal;case"ban":return w.Unbanned;default:return w.Kicked}default:return null}}getAggregate(t){const s={},n={};return Object.keys(t).forEach(i=>{const a=t[i][0],o=a.displayName,r=e.getTransitionSequence(t[i]).join(",");s[r]||(s[r]=[],n[r]=-1),s[r].push(o),(-1===n[r]||a.index<n[r])&&(n[r]=a.index)}),{names:s,indices:n}}render(){const e=this.props.events,t=new Map,s={};e.forEach((e,n)=>{const i=e.getType(),a=i===y.a.RoomServerAcl?e.getSender():e.getStateKey();s[a]||(s[a]=[]),_.includes(i)?t.set(a,e.sender):e.target&&t.set(a,e.target);let o=a;i===y.a.RoomThirdPartyInvite?o=e.getContent().display_name:_.includes(i)?o=e.sender.name:e.target&&(o=e.target.name),s[a].push({mxEvent:e,displayName:o,index:n})});const n=this.getAggregate(s),i=Object.keys(n.names).sort((e,t)=>n.indices[e]-n.indices[t]);return l.a.createElement(m.a,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],layout:this.props.layout,summaryText:this.generateSummary(n.names,i)})}},r()(i,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:E.a.Group}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(84),h=s(90),u=s(93),m=s(85),p=s(200);let g=Object(m.a)("views.messages.TileErrorBoundary")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onBugReport",()=>{h.a.createTrackedDialog("Bug Report Dialog","",p.a,{label:"react-soft-crash-tile",error:this.state.error})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let s;return u.a.get().bug_report_endpoint_url&&(s=r.a.createElement("a",{onClick:this.onBugReport,href:"#"},Object(d.a)("Submit logs"))),r.a.createElement("div",{className:l()(t)},r.a.createElement("div",{className:"mx_EventTile_line"},r.a.createElement("span",null,Object(d.a)("Can't load this message"),e&&` (${e.getType()})`,s)))}return this.props.children}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82);const i=(e,t)=>{const[s,i]=Object(n.useState)(e);return[s,e=>{i(e),t(e)}]}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(98),o=s(182),r=s(152),c=s(276),l=s(84),d=s(400),h=s(122),u=s(87),m=s(92),p=s(105),g=s(419),v=s(154),f=s(139);t.a=({room:e,widgetId:t,onClose:s})=>{const b=Object(n.useContext)(a.a),y=Object(d.d)(e).find(e=>e.id===t),E=y&&v.d.instance.isInContainer(e,y,v.a.Top),[S,_,w,C]=Object(p.p)();if(Object(n.useEffect)(()=>{y&&!E||u.a.dispatch({action:m.a.SetRightPanelPhase,phase:h.c.RoomSummary})},[y,E]),!y||E)return null;let O;if(S){const e=_.current.getBoundingClientRect();O=i.a.createElement(g.a,{chevronFace:p.a.None,right:f.b.instance.windowWidth-e.right-12,top:e.bottom+12,onFinished:C,app:y})}const k=i.a.createElement(i.a.Fragment,null,i.a.createElement("h2",null,r.a.getWidgetName(y)),i.a.createElement(p.b,{kind:"secondary",className:"mx_WidgetCard_optionsButton",inputRef:_,onClick:w,isExpanded:S,label:Object(l.a)("Options")}),O);return i.a.createElement(o.b,{header:k,className:"mx_WidgetCard",onClose:s,previousPhase:h.c.RoomSummary,withoutScrollContainer:!0},i.a.createElement(c.a,{app:y,fullWidth:!0,showMenubar:!1,room:e,userId:b.getUserId(),creatorUserId:y.creatorUserId,widgetPageTitle:r.a.getWidgetDataTitle(y),waitForIframeLoad:y.waitForIframeLoad}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return D}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(93),d=s(87),h=s(159),u=s(86),m=s(193),p=s(182),g=s(122),v=s(126),f=s(219),b=s(85),y=s(89),E=s(181),S=s(311),_=s(96),w=s(237),C=s(88),O=s(312),k=s(897),R=s(125),I=s(112),x=s(106),T=s(221),j=s(115),N=s(127);const P=/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+/g;let D=Object(b.a)("views.rooms.MemberList")(n=class extends r.a.Component{constructor(e){var t;super(e),a()(this,"showPresence",!0),a()(this,"mounted",!1),a()(this,"collator",void 0),a()(this,"sortNames",new Map),a()(this,"onUserPresenceChange",(e,t)=>{this.refs[t.userId]&&this.updateList()}),a()(this,"onRoom",e=>{e.roomId===this.props.roomId&&this.showMembersAccordingToMembershipWithLL()}),a()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.props.roomId&&"join"===t&&this.showMembersAccordingToMembershipWithLL()}),a()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.props.roomId&&this.updateList()}),a()(this,"onRoomMemberName",(e,t)=>{t.roomId===this.props.roomId&&this.updateList()}),a()(this,"onRoomStateEvent",(e,t)=>{e.getRoomId()===this.props.roomId&&"m.room.third_party_invite"===e.getType()&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})}),a()(this,"updateList",Object(I.throttle)(()=>{this.updateListNow()},500,{leading:!0,trailing:!0})),a()(this,"createOverflowTileJoined",(e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList)),a()(this,"createOverflowTileInvited",(e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList)),a()(this,"createOverflowTile",(e,t,n)=>{const i=Object(c.a)("and %(count)s others...",{count:e});return r.a.createElement(O.b,{className:"mx_EntityTile_ellipsis",avatarJsx:r.a.createElement(R.a,{url:s(313),name:"...",width:36,height:36}),name:i,presenceState:"online",suppressOnHover:!0,onClick:n})}),a()(this,"showMoreJoinedMemberList",()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})}),a()(this,"showMoreInvitedMemberList",()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})}),a()(this,"memberSort",(e,t)=>{const s=e.user,n=t.user;if(!s&&!n)return 0;if(s&&!n)return-1;if(!s&&n)return 1;const i=[100,50,0];let a=e.powerLevel,o=t.powerLevel;for(const e of i)if(a>=e){a=e;break}for(const e of i)if(o>=e){o=e;break}if(a!==o)return o-a;if(this.showPresence){const e=e=>"unavailable"===e?"online":e,t=t=>{const s=["active","online","offline"],n=s.indexOf(e(t));return-1===n?s.length:n},i=t(s.currentlyActive?"active":s.presence),a=t(n.currentlyActive?"active":n.presence);if(i!==a)return i-a}return this.showPresence&&s.getLastActiveTs()!==n.getLastActiveTs()?n.getLastActiveTs()-s.getLastActiveTs():this.collator.compare(this.sortNames.get(e),this.sortNames.get(t))}),a()(this,"onSearchQueryChanged",e=>{this.props.onSearchQueryChanged(e),this.setState({filteredJoinedMembers:this.filterMembers(this.state.members,"join",e),filteredInvitedMembers:this.filterMembers(this.state.members,"invite",e)})}),a()(this,"onPending3pidInviteClick",e=>{d.a.dispatch({action:"view_3pid_invite",event:e})}),a()(this,"getChildrenJoined",(e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t))),a()(this,"getChildCountJoined",()=>this.state.filteredJoinedMembers.length),a()(this,"getChildrenInvited",(e,t)=>{let s=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(s=s.concat(this.getPending3PidInvites())),this.makeMemberTiles(s.slice(e,t))}),a()(this,"getChildCountInvited",()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length),a()(this,"onInviteButtonClick",()=>{u.a.get().isGuest()?d.a.dispatch({action:"require_registration"}):d.a.dispatch({action:"view_invite",roomId:this.props.roomId})});const n=u.a.get();n.hasLazyLoadMembersEnabled()?this.state=this.getMembersState([]):this.state=this.getMembersState(this.roomMembers()),n.on("Room",this.onRoom);const i=l.a.get().enable_presence_by_hs_url,o=u.a.get().baseUrl;this.showPresence=null===(t=null==i?void 0:i[o])||void 0===t||t}UNSAFE_componentWillMount(){const e=u.a.get();this.mounted=!0,e.hasLazyLoadMembersEnabled()?(this.showMembersAccordingToMembershipWithLL(),e.on("Room.myMembership",this.onMyMembership)):this.listenForMembersChanges()}listenForMembersChanges(){const e=u.a.get();e.on("RoomState.members",this.onRoomStateMember),e.on("RoomMember.name",this.onRoomMemberName),e.on("RoomState.events",this.onRoomStateEvent),e.on("User.lastPresenceTs",this.onUserPresenceChange),e.on("User.presence",this.onUserPresenceChange),e.on("User.currentlyActive",this.onUserPresenceChange)}componentWillUnmount(){this.mounted=!1;const e=u.a.get();e&&(e.removeListener("RoomState.members",this.onRoomStateMember),e.removeListener("RoomMember.name",this.onRoomMemberName),e.removeListener("Room.myMembership",this.onMyMembership),e.removeListener("RoomState.events",this.onRoomStateEvent),e.removeListener("Room",this.onRoom),e.removeListener("User.lastPresenceTs",this.onUserPresenceChange),e.removeListener("User.presence",this.onUserPresenceChange),e.removeListener("User.currentlyActive",this.onUserPresenceChange)),this.updateList.cancel()}async showMembersAccordingToMembershipWithLL(){if(u.a.get().hasLazyLoadMembersEnabled()){const e=u.a.get().getRoom(this.props.roomId);if("join"===(e&&e.getMyMembership())){this.setState({loading:!0});try{await e.loadMembersIfNeeded()}catch(e){}this.mounted&&(this.setState(this.getMembersState(this.roomMembers())),this.listenForMembersChanges())}else this.setState(this.getMembersState(this.roomMembers()))}}get canInvite(){const e=u.a.get(),t=e.getRoom(this.props.roomId);return(null==t?void 0:t.canInvite(e.getUserId()))||(null==t?void 0:t.isSpaceRoom())&&t.getJoinRule()===N.c.Public}getMembersState(e){return{loading:!1,members:e,filteredJoinedMembers:this.filterMembers(e,"join",this.props.searchQuery),filteredInvitedMembers:this.filterMembers(e,"invite",this.props.searchQuery),canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5}}updateListNow(){const e=this.roomMembers();this.setState({loading:!1,members:e,filteredJoinedMembers:this.filterMembers(e,"join",this.props.searchQuery),filteredInvitedMembers:this.filterMembers(e,"invite",this.props.searchQuery)})}getMembersWithUser(){if(!this.props.roomId)return[];const e=u.a.get(),t=e.getRoom(this.props.roomId);if(!t)return[];const s=Object.values(t.currentState.members);return s.forEach(t=>{t.user||(t.user=e.getUser(t.userId)),this.sortNames.set(t,("@"===t.name[0]?t.name.substr(1):t.name).replace(P,""))}),s}roomMembers(){const e=this.getMembersWithUser().filter(e=>"join"===e.membership||"invite"===e.membership),t=y.b.getValue("language");return this.collator=new Intl.Collator(t,{sensitivity:"base",ignorePunctuation:!1}),e.sort(this.memberSort),e}memberString(e){if(e){const t=e.user;return"("+e.name+", "+e.powerLevel+", "+(t?t.lastActiveAgo:"<null>")+", "+(t?t.getLastActiveTs():"<null>")+", "+(t?t.currentlyActive:"<null>")+", "+(t?t.presence:"<null>")+")"}return"(null)"}filterMembers(e,t,s){return e.filter(e=>{if(s){s=s.toLowerCase();const t=-1!==e.name.toLowerCase().indexOf(s),n=-1!==e.userId.toLowerCase().indexOf(s);if(!t&&!n)return!1}return e.membership===t})}getPending3PidInvites(){const e=u.a.get().getRoom(this.props.roomId);if(e)return e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!Object(h.c)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())}))}makeMemberTiles(e){return e.map(e=>e instanceof E.a?r.a.createElement(k.a,{key:e.userId,member:e,ref:e.userId,showPresence:this.showPresence}):r.a.createElement(O.b,{key:e.getStateKey(),name:e.getContent().display_name,suppressOnHover:!0,onClick:()=>this.onPending3pidInviteClick(e)}))}render(){if(this.state.loading)return r.a.createElement(p.b,{className:"mx_MemberList",onClose:this.props.onClose,previousPhase:g.c.RoomSummary},r.a.createElement(_.a,null));const e=u.a.get().getRoom(this.props.roomId);let t,s,n;if("join"===(null==e?void 0:e.getMyMembership())&&Object(T.a)(j.a.InviteUsers)){let s=Object(c.a)("Invite to this room");const n=m.a.instance.getSelectedCommunityGeneralChat();n&&n.roomId===this.props.roomId?s=Object(c.a)("Invite to this community"):x.a.spacesEnabled&&e.isSpaceRoom()&&(s=Object(c.a)("Invite to this space")),t=r.a.createElement(C.a,{className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},r.a.createElement("span",null,s))}this.getChildCountInvited()>0&&(s=r.a.createElement("h2",null,Object(c.a)("Invited")),n=r.a.createElement(S.a,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const i=r.a.createElement(w.a,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Filter room members"),onSearch:this.onSearchQueryChanged,initialValue:this.props.searchQuery});let a,o=g.c.RoomSummary;return x.a.spacesEnabled&&null!=e&&e.isSpaceRoom()&&(o=void 0,a=r.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},r.a.createElement(v.a,{room:e,height:32,width:32}),r.a.createElement(f.a,{room:e}))),r.a.createElement(p.b,{className:"mx_MemberList",header:r.a.createElement(r.a.Fragment,null,a,t),footer:i,onClose:this.props.onClose,previousPhase:o},r.a.createElement("div",{className:"mx_MemberList_wrapper"},r.a.createElement(S.a,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),s,n))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,a,o=s(95),r=s.n(o),c=s(83),l=s.n(c),d=s(89),h=s(82),u=s.n(h),m=s(87),p=s(84),g=s(86),v=s(92),f=s(85),b=s(94),y=s(312),E=s(142);let S=Object(f.a)("views.rooms.MemberTile")((a=i=class extends u.a.Component{constructor(e){super(e),l()(this,"userLastModifiedTime",void 0),l()(this,"memberLastModifiedTime",void 0),l()(this,"onRoomStateEvents",e=>{if(e.getType()!==b.a.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;g.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()}),l()(this,"onUserTrustStatusChanged",(e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()}),l()(this,"onDeviceVerificationChanged",(e,t,s)=>{e===this.props.member.userId&&this.updateE2EStatus()}),l()(this,"onStatusMessageCommitted",()=>{this.setState({statusMessage:this.getStatusMessage()})}),l()(this,"onClick",()=>{m.a.dispatch({action:v.a.ViewUser,member:this.props.member})}),this.state={statusMessage:this.getStatusMessage(),isRoomEncrypted:!1,e2eStatus:null}}componentDidMount(){const e=g.a.get();if(d.b.getValue("feature_custom_status")){const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this.onStatusMessageCommitted)}const{roomId:t}=this.props.member;if(t){const s=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:s}),s?(e.on("userTrustStatusChanged",this.onUserTrustStatusChanged),e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on("RoomState.events",this.onRoomStateEvents)}}componentWillUnmount(){const e=g.a.get(),{user:t}=this.props.member;t&&t.removeListener("User._unstable_statusMessage",this.onStatusMessageCommitted),e&&(e.removeListener("RoomState.events",this.onRoomStateEvents),e.removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged),e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged))}async updateE2EStatus(){const e=g.a.get(),{userId:t}=this.props.member,s=t===e.getUserId(),n=e.checkUserTrust(t);if(!n.isCrossSigningVerified())return void this.setState({e2eStatus:n.wasCrossSigningVerified()?"warning":"normal"});const i=e.getStoredDevicesForUser(t).some(n=>{const{deviceId:i}=n,a=e.checkDeviceTrust(t,i);return s?!a.isCrossSigningVerified():!a.isVerified()});this.setState({e2eStatus:i?"warning":"verified"})}getStatusMessage(){const{user:e}=this.props.member;return e?e.unstable_statusMessage:""}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return Object(p.a)("%(userName)s (power %(powerLevelNumber)s)",{userName:this.props.member.userId,powerLevelNumber:this.props.member.powerLevel})}render(){const e=this.props.member,t=this.getDisplayName(),s=e.user?e.user.presence:null;let n=null;e.user&&d.b.getValue("feature_custom_status")&&(n=this.state.statusMessage);const i=u.a.createElement(E.a,{member:e,width:36,height:36,"aria-hidden":"true"});e.user&&(this.userLastModifiedTime=e.user.getLastModifiedTime()),this.memberLastModifiedTime=e.getLastModifiedTime();const a=new Map([[100,y.a.Admin],[50,y.a.Moderator]]);let o=this.props.member.powerLevel;for(const[e]of a)if(this.props.member.powerLevel>=e){o=e;break}const c=a.get(o);let l;return this.state.isRoomEncrypted&&(l=this.state.e2eStatus),u.a.createElement(y.b,r()({},this.props,{presenceState:s,presenceLastActiveAgo:e.user?e.user.lastActiveAgo:0,presenceLastTs:e.user?e.user.lastPresenceTs:0,presenceCurrentlyActive:!!e.user&&e.user.currentlyActive,avatarJsx:i,title:this.getPowerLabel(),name:t,powerStatus:c,showPresence:this.props.showPresence,subtextLabel:n,e2eStatus:l,onClick:this.onClick}))}},l()(i,"defaultProps",{showPresence:!0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(107),u=s(87),m=s(131),p=s(110),g=s.n(p),v=s(570),f=s(88),b=s(122),y=s(128),E=s(92),S=s(85);let _=Object(S.a)("views.groups.GroupMemberList")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{members:null,membersError:null,invitedMembers:null,invitedMembersError:null,truncateAt:30}),r()(this,"_createOverflowTile",(e,t)=>{const n=h.getComponent("rooms.EntityTile"),i=h.getComponent("avatars.BaseAvatar"),a=Object(d.a)("and %(count)s others...",{count:e});return l.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:l.a.createElement(i,{url:s(313),name:"...",width:36,height:36}),name:a,presenceState:"online",suppressOnHover:!0,onClick:this._showFullMemberList})}),r()(this,"_showFullMemberList",()=>{this.setState({truncateAt:-1})}),r()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),r()(this,"onInviteToGroupButtonClick",()=>{Object(v.b)(this.props.groupId).then(()=>{u.a.dispatch({action:E.a.SetRightPanelPhase,phase:b.c.GroupMemberList,refireParams:{groupId:this.props.groupId}})})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0}_initGroupStore(e){m.a.registerListener(e,()=>{this._fetchMembers()}),m.a.on("error",(t,s,n)=>{this._unmounted||e!==s||(n===m.a.STATE_KEY.GroupMembers&&this.setState({membersError:t}),n===m.a.STATE_KEY.GroupInvitedMembers&&this.setState({invitedMembersError:t}))})}_fetchMembers(){this._unmounted||this.setState({members:m.a.getGroupMembers(this.props.groupId),invitedMembers:m.a.getGroupInvitedMembers(this.props.groupId)})}makeGroupMemberTiles(e,t,s){if(s)return l.a.createElement("div",{className:"warning"},Object(d.a)("Failed to load group members"));const n=h.getComponent("groups.GroupMemberTile"),i=h.getComponent("elements.TruncatedList");(e=(e||"").toLowerCase())&&(t=t.filter(t=>{const s=(t.displayname||"").toLowerCase().includes(e),n=t.userId.toLowerCase().includes(e);return!(!s&&!n)}));const a={};t.forEach(e=>{a[e.userId]||(a[e.userId]=e)}),(t=Object.keys(a).map(e=>a[e])).sort((e,t)=>{if(e.isPrivileged===t.isPrivileged){const s=e.displayname||e.userId,n=t.displayname||t.userId;return s<n?-1:s>n?1:0}return e.isPrivileged?-1:1});const o=t.map(e=>l.a.createElement(n,{key:e.userId,groupId:this.props.groupId,member:e}));return l.a.createElement(i,{className:"mx_MemberList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},o)}render(){if(this.state.fetching||this.state.fetchingInvitedMembers){const e=h.getComponent("elements.Spinner");return l.a.createElement("div",{className:"mx_MemberList"},l.a.createElement(e,null))}const e=l.a.createElement("input",{className:"mx_GroupMemberList_query mx_textinput",id:"mx_GroupMemberList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(d.a)("Filter community members"),autoComplete:"off"}),t=this.state.members?l.a.createElement("div",{className:"mx_MemberList_joined"},this.makeGroupMemberTiles(this.state.searchQuery,this.state.members,this.state.membersError)):l.a.createElement("div",null),s=this.state.invitedMembers&&this.state.invitedMembers.length>0?l.a.createElement("div",{className:"mx_MemberList_invited"},l.a.createElement("h2",null,Object(d.a)("Invited")),this.makeGroupMemberTiles(this.state.searchQuery,this.state.invitedMembers,this.state.invitedMembersError)):l.a.createElement("div",null);let n;return m.a.isUserPrivileged(this.props.groupId)&&(n=l.a.createElement(f.a,{className:"mx_MemberList_invite mx_MemberList_inviteCommunity",onClick:this.onInviteToGroupButtonClick},l.a.createElement("span",null,Object(d.a)("Invite to this community")))),l.a.createElement("div",{className:"mx_MemberList",role:"tabpanel"},n,l.a.createElement(y.a,null,t,s),e)}},r()(i,"propTypes",{groupId:g.a.string.isRequired}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(107),u=s(131),m=s(110),p=s.n(m),g=s(570),v=s(88),f=s(128),b=s(85);let y=Object(b.a)("views.groups.GroupRoomList")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{rooms:null,truncateAt:30,searchQuery:""}),r()(this,"onGroupStoreUpdated",()=>{this._unmounted||this.setState({rooms:u.a.getGroupRooms(this.props.groupId)})}),r()(this,"_createOverflowTile",(e,t)=>{const n=h.getComponent("rooms.EntityTile"),i=h.getComponent("avatars.BaseAvatar"),a=Object(d.a)("and %(count)s others...",{count:e});return l.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:l.a.createElement(i,{url:s(313),name:"...",width:36,height:36}),name:a,presenceState:"online",suppressOnHover:!0,onClick:this._showFullRoomList})}),r()(this,"_showFullRoomList",()=>{this.setState({truncateAt:-1})}),r()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),r()(this,"onAddRoomToGroupButtonClick",()=>{Object(g.a)(this.props.groupId).then(()=>{this.forceUpdate()})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0,this._unregisterGroupStore()}_unregisterGroupStore(){u.a.unregisterListener(this.onGroupStoreUpdated)}_initGroupStore(e){u.a.registerListener(e,this.onGroupStoreUpdated),u.a.on("error",(t,s)=>{s===e&&this.setState({rooms:null})})}makeGroupRoomTiles(e){const t=h.getComponent("groups.GroupRoomTile");e=(e||"").toLowerCase();let s=this.state.rooms;return e&&(s=s.filter(t=>{const s=(t.name||"").toLowerCase().includes(e),n=(t.canonicalAlias||"").toLowerCase().includes(e);return s||n})),s=s.map((e,s)=>l.a.createElement(t,{key:s,groupId:this.props.groupId,groupRoom:e})),s}render(){if(null===this.state.rooms)return null;let e;u.a.isUserPrivileged(this.props.groupId)&&(e=l.a.createElement(v.a,{className:"mx_MemberList_invite mx_MemberList_addRoomToCommunity",onClick:this.onAddRoomToGroupButtonClick},l.a.createElement("span",null,Object(d.a)("Add rooms to this community"))));const t=l.a.createElement("input",{className:"mx_GroupRoomList_query mx_textinput",id:"mx_GroupRoomList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(d.a)("Filter community rooms"),autoComplete:"off"}),s=h.getComponent("elements.TruncatedList");return l.a.createElement("div",{className:"mx_GroupRoomList",role:"tabpanel"},e,l.a.createElement(f.a,{className:"mx_GroupRoomList_joined mx_GroupRoomList_outerWrapper"},l.a.createElement(s,{className:"mx_GroupRoomList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},this.makeGroupRoomTiles(this.state.searchQuery))),t)}},r()(i,"propTypes",{groupId:p.a.string.isRequired}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(110),h=s.n(d),u=s(87),m=s(90),p=s(107),g=s(84),v=s(131),f=s(98),b=s(128),y=s(85),E=s(103),S=s(1);let _=Object(y.a)("views.groups.GroupRoomInfo")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{isUserPrivilegedInGroup:null,groupRoom:null,groupRoomPublicityLoading:!1,groupRoomRemoveLoading:!1}),r()(this,"onGroupStoreUpdated",()=>{this.setState({isUserPrivilegedInGroup:v.a.isUserPrivileged(this.props.groupId)}),this._updateGroupRoom()}),r()(this,"_onRemove",e=>{const t=this.props.groupId,s=this.state.groupRoom.displayname;e.preventDefault(),e.stopPropagation();const n=p.getComponent("dialogs.QuestionDialog");m.a.createTrackedDialog("Confirm removal of group from room","",n,{title:Object(g.a)("Are you sure you want to remove '%(roomName)s' from %(groupId)s?",{roomName:s,groupId:t}),description:Object(g.a)("Removing a room from the community will also remove it from the community page."),button:Object(g.a)("Remove"),onFinished:e=>{if(!e)return;this.setState({groupRoomRemoveLoading:!0});const t=this.props.groupId,n=this.props.groupRoomId;v.a.removeRoomFromGroup(this.props.groupId,n).then(()=>{u.a.dispatch({action:"view_group_room_list"})}).catch(e=>{S.a.error(`Error whilst removing ${n} from ${t}`,e);const i=p.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to remove room from group","",i,{title:Object(g.a)("Failed to remove room from community"),description:Object(g.a)("Failed to remove '%(roomName)s' from %(groupId)s",{groupId:t,roomName:s})})}).finally(()=>{this.setState({groupRoomRemoveLoading:!1})})}})}),r()(this,"_onCancel",e=>{u.a.dispatch({action:"view_group_room_list"})}),r()(this,"_changeGroupRoomPublicity",e=>{const t="public"===e.target.value;this.setState({groupRoomPublicityLoading:!0});const s=this.props.groupId,n=this.props.groupRoomId,i=this.state.groupRoom.displayname;v.a.updateGroupRoomVisibility(this.props.groupId,n,t).catch(e=>{S.a.error(`Error whilst changing visibility of ${n} in ${s} to ${t}`,e);const a=p.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to remove room from group","",a,{title:Object(g.a)("Something went wrong!"),description:Object(g.a)("The visibility of '%(roomName)s' in %(groupId)s could not be updated.",{roomName:i,groupId:s})})}).finally(()=>{this.setState({groupRoomPublicityLoading:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this._unregisterGroupStore(this.props.groupId),this._initGroupStore(e.groupId))}componentWillUnmount(){this._unregisterGroupStore(this.props.groupId)}_initGroupStore(e){v.a.registerListener(e,this.onGroupStoreUpdated)}_unregisterGroupStore(e){v.a.unregisterListener(this.onGroupStoreUpdated)}_updateGroupRoom(){this.setState({groupRoom:v.a.getGroupRooms(this.props.groupId).find(e=>e.roomId===this.props.groupRoomId)})}render(){const e=p.getComponent("elements.AccessibleButton"),t=p.getComponent("elements.InlineSpinner");if(this.state.groupRoomRemoveLoading||!this.state.groupRoom){const e=p.getComponent("elements.Spinner");return l.a.createElement("div",{className:"mx_MemberInfo"},l.a.createElement(e,null))}let n;this.state.isUserPrivilegedInGroup&&(n=l.a.createElement("div",{className:"mx_MemberInfo_adminTools"},l.a.createElement("h3",null,Object(g.a)("Admin Tools")),l.a.createElement("div",{className:"mx_MemberInfo_buttons"},l.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this._onRemove},Object(g.a)("Remove from community"))),l.a.createElement("h3",null,Object(g.a)("Visibility in Room List"),this.state.groupRoomPublicityLoading?l.a.createElement(t,null):l.a.createElement("div",null)),l.a.createElement("div",null,l.a.createElement("label",null,l.a.createElement("input",{type:"radio",value:"public",checked:this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),l.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(g.a)("Visible to everyone")))),l.a.createElement("div",null,l.a.createElement("label",null,l.a.createElement("input",{type:"radio",value:"private",checked:!this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),l.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(g.a)("Only visible to community members"))))));const i=this.state.groupRoom.avatarUrl;let a;if(i){const e=Object(E.b)(i).getSquareThumbnailHttp(800);a=l.a.createElement("div",{className:"mx_MemberInfo_avatar"},l.a.createElement("img",{src:e}))}const o=this.state.groupRoom.displayname;return l.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},l.a.createElement(b.a,null,l.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this._onCancel},l.a.createElement("img",{src:s(402),width:"18",height:"18",className:"mx_filterFlipColor"})),a,l.a.createElement("h2",null,o),l.a.createElement("div",{className:"mx_MemberInfo_profile"},l.a.createElement("div",{className:"mx_MemberInfo_profileField"},this.state.groupRoom.canonicalAlias)),n))}},r()(i,"contextType",f.a),r()(i,"propTypes",{groupId:h.a.string,groupRoomId:h.a.string}),n=a))||n},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(91),d=s.n(l),h=s(181),u=s(157),m=s(87),p=s(90),g=s(84),v=s(141),f=s(130),b=s(88),y=s(93),E=s(89),S=s(132),_=s(366),w=s(131),C=s(86),O=s(215),k=s(135),R=s(448),I=s(98),x=s(122),T=s(394),j=s(259),N=s(883),P=s(92),D=s(158),M=s(886),A=s(182),U=s(565),L=s(283),F=s(96),B=s(538),V=s(142),K=s(494),W=s(384),G=s(104),H=s(113),q=s(571),$=s(166),z=s(94),J=s(126),Y=s(219),Q=s(103),X=s(139),Z=s(106),ee=s(902),te=s(186),se=s(1),ne=s(221),ie=s(115),ae=s(118);const oe=["user","groupId","room","onClose","phase"];function re({userId:e,device:t}){var s;const n=Object(r.useContext)(I.a),i=e===n.getUserId(),a=n.checkDeviceTrust(e,t.deviceId),o=n.checkUserTrust(e),l=i?a.isCrossSigningVerified():a.isVerified(),h=d()("mx_UserInfo_device",{mx_UserInfo_device_verified:l,mx_UserInfo_device_unverified:!l}),u=d()("mx_E2EIcon",{mx_E2EIcon_normal:!o.isVerified(),mx_E2EIcon_verified:l,mx_E2EIcon_warning:o.isVerified()&&!l}),m=()=>{Object(N.c)(n.getUser(e),t)};let p;p=null!==(s=t.getDisplayName())&&void 0!==s&&s.trim()?t.ambiguous?t.getDisplayName()+" ("+t.deviceId+")":t.getDisplayName():t.deviceId;let v=null;return o.isVerified()&&(v=l?Object(g.a)("Trusted"):Object(g.a)("Not trusted")),l?c.a.createElement("div",{className:h,title:t.deviceId},c.a.createElement("div",{className:u}),c.a.createElement("div",{className:"mx_UserInfo_device_name"},p),c.a.createElement("div",{className:"mx_UserInfo_device_trusted"},v)):c.a.createElement(b.a,{className:h,title:t.deviceId,onClick:m},c.a.createElement("div",{className:u}),c.a.createElement("div",{className:"mx_UserInfo_device_name"},p),c.a.createElement("div",{className:"mx_UserInfo_device_trusted"},v))}function ce({devices:e,userId:t,loading:s}){const n=Object(r.useContext)(I.a),i=n.checkUserTrust(t),[a,o]=Object(r.useState)(!1);if(s)return c.a.createElement(F.a,null);if(null===e)return c.a.createElement(c.a.Fragment,null,Object(g.a)("Unable to load session list"));const l=t===n.getUserId(),d=e.map(e=>n.checkDeviceTrust(t,e.deviceId));let h=[];const u=[];let m,p,v,f="mx_E2EIcon";if(i.isVerified()){for(let t=0;t<e.length;++t){const s=e[t],n=d[t];(l?n.isCrossSigningVerified():n.isVerified())?h.push(s):u.push(s)}m=Object(g.a)("%(count)s verified sessions",{count:h.length}),p=Object(g.a)("Hide verified sessions"),f+=" mx_E2EIcon_verified"}else h=e,m=Object(g.a)("%(count)s sessions",{count:e.length}),p=Object(g.a)("Hide sessions"),f+=" mx_E2EIcon_normal";h.length&&(v=a?c.a.createElement(b.a,{className:"mx_UserInfo_expand mx_linkButton",onClick:()=>o(!1)},c.a.createElement("div",null,p)):c.a.createElement(b.a,{className:"mx_UserInfo_expand mx_linkButton",onClick:()=>o(!0)},c.a.createElement("div",{className:f}),c.a.createElement("div",null,m)));let y=u.map((e,s)=>c.a.createElement(re,{key:s,userId:t,device:e}));if(a){const e=u.length;y=y.concat(h.map((s,n)=>c.a.createElement(re,{key:n+e,userId:t,device:s})))}return c.a.createElement("div",{className:"mx_UserInfo_devices"},c.a.createElement("div",null,y),c.a.createElement("div",null,v))}const le=({member:e,isIgnored:t,canInvite:s,isSpace:n})=>{const i=Object(r.useContext)(I.a);let a=null,o=null,l=null,h=null;const u=e.userId===i.getUserId();if(!u){var f;const r=()=>{const s=i.getIgnoredUsers();if(t){const t=s.indexOf(e.userId);-1!==t&&s.splice(t,1)}else s.push(e.userId);i.setIgnoredUsers(s)};if(a=c.a.createElement(b.a,{onClick:r,className:d()("mx_UserInfo_field",{mx_UserInfo_destructive:!t})},t?Object(g.a)("Unignore"):Object(g.a)("Ignore")),e.roomId&&!n){const t=function(){const t=i.getRoom(e.roomId);m.a.dispatch({action:P.a.ViewRoom,highlighted:!0,event_id:t.getEventReadUpTo(e.userId),room_id:e.roomId})},s=function(){m.a.dispatch({action:P.a.ComposerInsert,userId:e.userId,timelineRenderingType:ae.a.Room})},n=i.getRoom(e.roomId);null!=n&&n.getEventReadUpTo(e.userId)&&(h=c.a.createElement(b.a,{onClick:t,className:"mx_UserInfo_field"},Object(g.a)("Jump to read receipt"))),o=c.a.createElement(b.a,{onClick:s,className:"mx_UserInfo_field"},Object(g.a)("Mention"))}if(s&&"leave"===(null!==(f=null==e?void 0:e.membership)&&void 0!==f?f:"leave")&&Object(ne.a)(ie.a.InviteUsers)){const t=e&&e.roomId?e.roomId:S.a.getRoomId(),s=async()=>{try{const s=new _.a(t);await s.invite([e.userId]).then(()=>{if("invited"!==s.getCompletionState(e.userId))throw new Error(s.getErrorText(e.userId))})}catch(e){p.a.createTrackedDialog("Failed to invite","",G.a,{title:Object(g.a)("Failed to invite"),description:e&&e.message?e.message:Object(g.a)("Operation failed")})}};l=c.a.createElement(b.a,{onClick:s,className:"mx_UserInfo_field"},Object(g.a)("Invite"))}}const y=c.a.createElement(b.a,{onClick:()=>{p.a.createTrackedDialog("share room member dialog","",W.a,{target:e})},className:"mx_UserInfo_field"},Object(g.a)("Share Link to User"));let E;return u||(E=c.a.createElement(b.a,{onClick:()=>{!async function(e,t){const s=Object(v.e)(e,t);if(s)return void m.a.dispatch({action:P.a.ViewRoom,room_id:s.roomId});const n={dmUserId:t,encryption:void 0};if(Object(v.f)()){const s=await e.downloadKeys([t]);Object.values(s).every(e=>Object.keys(e).length>0)&&(n.encryption=!0)}Object(v.b)(n)}(i,e.userId)},className:"mx_UserInfo_field"},Object(g.a)("Message"))),c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Options")),c.a.createElement("div",null,E,h,y,o,l,a))},de=async e=>{const{finished:t}=p.a.createTrackedDialog("Demoting Self","",H.a,{title:Object(g.a)("Demote yourself?"),description:c.a.createElement("div",null,e?Object(g.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the space it will be impossible to regain privileges."):Object(g.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the room it will be impossible to regain privileges.")),button:Object(g.a)("Demote")}),[s]=await t;return s},he=({children:e})=>c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Admin Tools")),c.a.createElement("div",{className:"mx_UserInfo_buttons"},e)),ue=e=>{var t,s;return(null==e||null===(t=e.currentState)||void 0===t||null===(s=t.getStateEvents(z.a.RoomPowerLevels,""))||void 0===s?void 0:s.getContent())||{}},me=({room:e,member:t,startUpdating:s,stopUpdating:n})=>{const i=Object(r.useContext)(I.a);if("invite"!==t.membership&&"join"!==t.membership)return null;const a="invite"===t.membership?Object(g.a)("Disinvite"):Object(g.a)("Kick");return c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{finished:a}=p.a.createTrackedDialog("Confirm User Action Dialog","onKick",e.isSpaceRoom()?ee.a:q.a,{member:t,action:"invite"===t.membership?Object(g.a)("Disinvite"):Object(g.a)("Kick"),title:"invite"===t.membership?Object(g.a)("Disinvite from %(roomName)s",{roomName:e.name}):Object(g.a)("Kick from %(roomName)s",{roomName:e.name}),askReason:"join"===t.membership,danger:!0,space:e,spaceChildFilter:e=>{const s=e.getMember(i.credentials.userId),n=e.getMember(t.userId);return s&&n&&n.membership===t.membership&&s.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("kick",s.powerLevel)},allLabel:Object(g.a)("Kick them from everything I'm able to"),specificLabel:Object(g.a)("Kick them from specific things I'm able to"),warningMessage:Object(g.a)("They'll still be able to access whatever you're not an admin of.")},e.isSpaceRoom()?"mx_ConfirmSpaceUserActionDialog_wrapper":void 0),[o,r,c=[]]=await a;o&&(s(),Object(te.a)(e,c,e=>i.kick(e.roomId,t.userId,r||void 0)).then(()=>{se.a.log("Kick success")},(function(e){se.a.error("Kick error: "+e),p.a.createTrackedDialog("Failed to kick","",G.a,{title:Object(g.a)("Failed to kick"),description:e&&e.message?e.message:"Operation failed"})})).finally(()=>{n()}))}},a)},pe=({member:e})=>{const t=Object(r.useContext)(I.a);return c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{roomId:s,userId:n}=e,i=t.getRoom(s);if(!i)return;let a=i.getLiveTimeline(),o=[];for(;a;)o=a.getEvents().reduce((e,t)=>t.getSender()!==n||t.isRedacted()||t.isRedaction()||t.getType()===z.a.RoomCreate||t.getType()===z.a.RoomServerAcl?e:e.concat(t),o),a=a.getNeighbouringTimeline(u.b.BACKWARDS);const r=o.length,l=e.name;if(0===r)p.a.createTrackedDialog("No user messages found to remove","",$.a,{title:Object(g.a)("No recent messages by %(user)s found",{user:l}),description:c.a.createElement("div",null,c.a.createElement("p",null,Object(g.a)("Try scrolling up in the timeline to see if there are any earlier ones.")))});else{const{finished:e}=p.a.createTrackedDialog("Remove recent messages by user","",H.a,{title:Object(g.a)("Remove recent messages by %(user)s",{user:l}),description:c.a.createElement("div",null,c.a.createElement("p",null,Object(g.a)("You are about to remove %(count)s messages by %(user)s. This cannot be undone. Do you wish to continue?",{count:r,user:l})),c.a.createElement("p",null,Object(g.a)("For a large amount of messages, this might take some time. Please don't refresh your client in the meantime."))),button:Object(g.a)("Remove %(count)s messages",{count:r})}),[n]=await e;if(!n)return;await Promise.resolve(),se.a.info(`Started redacting recent ${r} messages for ${l} in ${s}`),await Promise.all(o.map(async e=>{try{await t.redactEvent(s,e.getId())}catch(t){se.a.error("Could not redact",e.getId()),se.a.error(t)}})),se.a.info(`Finished redacting recent ${r} messages for ${l} in ${s}`)}}},Object(g.a)("Remove recent messages"))},ge=({room:e,member:t,startUpdating:s,stopUpdating:n})=>{const i=Object(r.useContext)(I.a),a="ban"===t.membership;let o=Object(g.a)("Ban");a&&(o=Object(g.a)("Unban"));const l=d()("mx_UserInfo_field",{mx_UserInfo_destructive:!a});return c.a.createElement(b.a,{className:l,onClick:async()=>{const{finished:o}=p.a.createTrackedDialog("Confirm User Action Dialog","onBanOrUnban",e.isSpaceRoom()?ee.a:q.a,{member:t,action:a?Object(g.a)("Unban"):Object(g.a)("Ban"),title:a?Object(g.a)("Unban from %(roomName)s",{roomName:e.name}):Object(g.a)("Ban from %(roomName)s",{roomName:e.name}),askReason:!a,danger:!a,space:e,spaceChildFilter:a?e=>{const s=e.getMember(i.credentials.userId),n=e.getMember(t.userId);return s&&n&&"ban"===n.membership&&s.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("ban",s.powerLevel)}:e=>{const s=e.getMember(i.credentials.userId),n=e.getMember(t.userId);return s&&n&&"ban"!==n.membership&&s.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("ban",s.powerLevel)},allLabel:a?Object(g.a)("Unban them from everything I'm able to"):Object(g.a)("Ban them from everything I'm able to"),specificLabel:a?Object(g.a)("Unban them from specific things I'm able to"):Object(g.a)("Ban them from specific things I'm able to"),warningMessage:a?Object(g.a)("They won't be able to access whatever you're not an admin of."):Object(g.a)("They'll still be able to access whatever you're not an admin of.")},e.isSpaceRoom()?"mx_ConfirmSpaceUserActionDialog_wrapper":void 0),[r,c,l=[]]=await o;if(!r)return;s();Object(te.a)(e,l,e=>{return s=e.roomId,a?i.unban(s,t.userId):i.ban(s,t.userId,c||void 0);var s}).then(()=>{se.a.log("Ban success")},(function(e){se.a.error("Ban error: "+e),p.a.createTrackedDialog("Failed to ban user","",G.a,{title:Object(g.a)("Error"),description:Object(g.a)("Failed to ban user")})})).finally(()=>{n()})}},o)},ve=({member:e,room:t,powerLevels:s,startUpdating:n,stopUpdating:i})=>{const a=Object(r.useContext)(I.a);if("join"!==e.membership)return null;const o=((e,t)=>{if(!t||!e)return!1;const s=(t.events?t.events["m.room.message"]:null)||t.events_default;return e.powerLevel<s})(e,s),l=d()("mx_UserInfo_field",{mx_UserInfo_destructive:!o}),h=o?Object(g.a)("Unmute"):Object(g.a)("Mute");return c.a.createElement(b.a,{className:l,onClick:async()=>{const s=e.roomId,r=e.userId;if(r===a.getUserId())try{if(!await de(Z.a.spacesEnabled&&(null==t?void 0:t.isSpaceRoom())))return}catch(e){return void se.a.error("Failed to warn about self demotion: ",e)}const c=t.currentState.getStateEvents("m.room.power_levels","");if(!c)return;const l=c.getContent(),d=(l.events?l.events["m.room.message"]:null)||l.events_default;let h;h=o?d:d-1,h=parseInt(h),isNaN(h)||(n(),a.setPowerLevel(s,r,h,c).then(()=>{se.a.log("Mute toggle success")},(function(e){se.a.error("Mute error: "+e),p.a.createTrackedDialog("Failed to mute user","",G.a,{title:Object(g.a)("Error"),description:Object(g.a)("Failed to mute user")})})).finally(()=>{i()}))}},h)},fe=({room:e,children:t,member:s,startUpdating:n,stopUpdating:i,powerLevels:a})=>{const o=Object(r.useContext)(I.a);let l,d,h,u;const m=(a.events?a.events["m.room.power_levels"]:null)||a.state_default,{ban:p=50,kick:g=50,redact:v=50}=a,f=e.getMember(o.getUserId());if(!f)return c.a.createElement("div",null);const b=f.userId===s.userId,y=s.powerLevel<f.powerLevel||b;return!b&&y&&f.powerLevel>=g&&(l=c.a.createElement(me,{room:e,member:s,startUpdating:n,stopUpdating:i})),!(f.powerLevel>=v)||Z.a.spacesEnabled&&e.isSpaceRoom()||(u=c.a.createElement(pe,{member:s,startUpdating:n,stopUpdating:i})),!b&&y&&f.powerLevel>=p&&(d=c.a.createElement(ge,{room:e,member:s,startUpdating:n,stopUpdating:i})),!b&&y&&f.powerLevel>=m&&!e.isSpaceRoom()&&(h=c.a.createElement(ve,{member:s,room:e,powerLevels:a,startUpdating:n,stopUpdating:i})),l||d||h||u||t?c.a.createElement(he,null,h,l,d,u,t):c.a.createElement("div",null)},be=({children:e,groupId:t,groupMember:s,startUpdating:n,stopUpdating:i})=>{const a=Object(r.useContext)(I.a),[o,l]=Object(r.useState)(!1),[d,h]=Object(r.useState)(!1);if(Object(r.useEffect)(()=>{let e=!1;const n=()=>{e||(l(w.a.isUserPrivileged(t)),h(w.a.getGroupInvitedMembers(t).some(e=>e.userId===s.userId)))};return w.a.registerListener(t,n),n(),()=>{e=!0,w.a.unregisterListener(n)}},[t,s.userId]),o){const o=async()=>{const{finished:e}=p.a.createDialog(q.a,{matrixClient:a,groupMember:s,action:d?Object(g.a)("Disinvite"):Object(g.a)("Remove from community"),title:d?Object(g.a)("Disinvite this user from community?"):Object(g.a)("Remove this user from community?"),danger:!0}),[o]=await e;o&&(n(),a.removeUserFromGroup(t,s.userId).then(()=>{m.a.dispatch({action:P.a.ViewUser,member:null})}).catch(e=>{p.a.createTrackedDialog("Failed to remove user from group","",G.a,{title:Object(g.a)("Error"),description:d?Object(g.a)("Failed to withdraw invitation"):Object(g.a)("Failed to remove user from community")}),se.a.log(e)}).finally(()=>{i()}))},r=c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:o},d?Object(g.a)("Disinvite"):Object(g.a)("Remove from community"));return c.a.createElement(he,null,r,e)}return c.a.createElement("div",null)};const ye=({user:e,room:t,roomPermissions:s,powerLevels:n})=>{if(s.canEdit)return c.a.createElement(Ee,{user:e,room:t,roomPermissions:s});{const t=n.users_default||0,s=e.powerLevel,i=Object(R.b)(s,t);return c.a.createElement("div",{className:"mx_UserInfo_profileField"},c.a.createElement("div",{className:"mx_UserInfo_roleDescription"},i))}},Ee=({user:e,room:t,roomPermissions:s})=>{const n=Object(r.useContext)(I.a),[i,a]=Object(r.useState)(e.powerLevel);Object(r.useEffect)(()=>{a(e.powerLevel)},[e]);const o=Object(r.useCallback)(async s=>{a(s);const i=e.roomId,o=e.userId,r=t.currentState.getStateEvents("m.room.power_levels","");if(!r)return;const l=n.getUserId(),d=r.getContent().users[l];if(d&&parseInt(d)===s){const{finished:e}=p.a.createTrackedDialog("Promote to PL100 Warning","",H.a,{title:Object(g.a)("Warning!"),description:c.a.createElement("div",null,Object(g.a)("You will not be able to undo this change as you are promoting the user to have the same power level as yourself."),c.a.createElement("br",null),Object(g.a)("Are you sure?")),button:Object(g.a)("Continue")}),[t]=await e;if(!t)return}else if(l===o)try{if(!await de(Z.a.spacesEnabled&&(null==t?void 0:t.isSpaceRoom())))return}catch(e){se.a.error("Failed to warn about self demotion: ",e)}await((e,t,s,i)=>n.setPowerLevel(e,t,parseInt(s),i).then((function(){se.a.log("Power change success")}),(function(e){se.a.error("Failed to change power level "+e),p.a.createTrackedDialog("Failed to change power level","",G.a,{title:Object(g.a)("Error"),description:Object(g.a)("Failed to change power level")})})))(i,o,s,r)},[e.roomId,e.userId,n,t]),l=t.currentState.getStateEvents("m.room.power_levels",""),d=l?l.getContent().users_default:0;return c.a.createElement("div",{className:"mx_UserInfo_profileField"},c.a.createElement(B.a,{label:null,value:i,maxValue:s.modifyLevelMax,usersDefault:d,onChange:o}))},Se=e=>{const t=Object(r.useContext)(I.a),[s,n]=Object(r.useState)(void 0);return Object(r.useEffect)(()=>{n(void 0);let s=!1;return async function(){try{await t.downloadKeys([e],!0);const i=t.getStoredDevicesForUser(e);if(s)return;(e=>{const t=Object.create(null);for(let s=0;s<e.length;s++){const n=e[s].getDisplayName(),i=t[n]||[];i.push(s),t[n]=i}for(const s in t)t[s].length>1&&t[s].forEach(t=>{e[t].ambiguous=!0})})(i),n(i)}catch(e){n(null)}}(),()=>{s=!0}},[t,e]),Object(r.useEffect)(()=>{let s=!1;const i=async()=>{const i=t.getStoredDevicesForUser(e);s||n(i)},a=t=>{t.includes(e)&&i()},o=(t,s)=>{t===e&&i()},r=(t,s)=>{t===e&&i()};return t.on("crypto.devicesUpdated",a),t.on("deviceVerificationChanged",o),t.on("userTrustStatusChanged",r),()=>{s=!0,t.removeListener("crypto.devicesUpdated",a),t.removeListener("deviceVerificationChanged",o),t.removeListener("userTrustStatusChanged",r)}},[t,e]),s},_e=({room:e,member:t,groupId:s,devices:n,isRoomEncrypted:i})=>{const a=Object(r.useContext)(I.a),o=((e,t)=>{const[s,n]=Object(r.useState)(ue(t)),i=Object(r.useCallback)(e=>{t&&(e&&e.getType()!==z.a.RoomPowerLevels||n(ue(t)))},[t]);return Object(k.a)(e,"RoomState.events",i),Object(r.useEffect)(()=>(i(),()=>{n({})}),[i]),s})(a,e),l=(e=>{const[t,s]=Object(r.useState)(!1);return Object(r.useEffect)(()=>{e.isSynapseAdministrator().then(e=>{s(e)},()=>{s(!1)})},[e]),t})(a),[d,h]=Object(r.useState)(a.isUserIgnored(t.userId));Object(r.useEffect)(()=>{h(a.isUserIgnored(t.userId))},[a,t.userId]);const u=Object(r.useCallback)(e=>{"m.ignored_user_list"===e.getType()&&h(a.isUserIgnored(t.userId))},[a,t.userId]);Object(k.a)(a,"accountData",u);const[v,y]=Object(r.useState)(0),E=Object(r.useCallback)(()=>{y(v+1)},[v]),S=Object(r.useCallback)(()=>{y(v-1)},[v]),_=function(e,t,s){const[n,i]=Object(r.useState)({modifyLevelMax:-1,canEdit:!1,canInvite:!1}),a=Object(r.useCallback)(()=>{if(!t)return;const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return;const a=n.getContent();if(!a)return;const o=t.getMember(e.getUserId());if(!o)return;const r=s,c=o.userId===r.userId;let l=-1;if(r.powerLevel<o.powerLevel||c){const e=(a.events?a.events["m.room.power_levels"]:null)||a.state_default;o.powerLevel>=e&&(c||o.powerLevel>r.powerLevel)&&(l=o.powerLevel)}i({canInvite:o.powerLevel>=a.invite,canEdit:l>=0,modifyLevelMax:l})},[e,s,t]);return Object(k.a)(e,"RoomState.members",a),Object(r.useEffect)(()=>(a(),()=>{i({modifyLevelMax:-1,canEdit:!1,canInvite:!1})}),[a]),n}(a,e,t),w=Object(r.useCallback)(async()=>{const{finished:e}=p.a.createTrackedDialog("Synapse User Deactivation","",H.a,{title:Object(g.a)("Deactivate user?"),description:c.a.createElement("div",null,Object(g.a)("Deactivating this user will log them out and prevent them from logging back in. Additionally, they will leave all the rooms they are in. This action cannot be reversed. Are you sure you want to deactivate this user?")),button:Object(g.a)("Deactivate user"),danger:!0}),[s]=await e;if(s)try{await a.deactivateSynapseUser(t.userId)}catch(e){se.a.error("Failed to deactivate user"),se.a.error(e),p.a.createTrackedDialog("Failed to deactivate Synapse user","",G.a,{title:Object(g.a)("Failed to deactivate user"),description:e&&e.message?e.message:Object(g.a)("Operation failed")})}},[a,t.userId]);let O,R,x,T;l&&t.userId.endsWith(":"+C.a.getHomeserverName())&&(O=c.a.createElement(b.a,{onClick:w,className:"mx_UserInfo_field mx_UserInfo_destructive"},Object(g.a)("Deactivate user"))),e&&t.roomId?(f.a.shared().getUserIdForRoomId(t.roomId)||(x=c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Role in <RoomName/>",{},{RoomName:()=>c.a.createElement("b",null,e.name)})),c.a.createElement(ye,{powerLevels:o,user:t,room:e,roomPermissions:_}))),T=c.a.createElement(fe,{powerLevels:o,member:t,room:e,startUpdating:E,stopUpdating:S},O)):s?T=c.a.createElement(be,{groupId:s,groupMember:t,startUpdating:E,stopUpdating:S},O):O&&(T=c.a.createElement(he,null,O)),v>0&&(R=c.a.createElement(F.a,null));const M=a.isCryptoEnabled();let A,U;i?Z.a.spacesEnabled&&e.isSpaceRoom()||(A=Object(g.a)("Messages in this room are end-to-end encrypted.")):M?!e||Z.a.spacesEnabled&&e.isSpaceRoom()||(A=Object(g.a)("Messages in this room are not end-to-end encrypted.")):A=Object(g.a)("This client does not support end-to-end encryption.");const L=(e=>Object(j.a)(async()=>e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),[e],!1))(a),B=M&&a.checkUserTrust(t.userId),V=M&&B.isCrossSigningVerified(),K=t.userId===a.getUserId(),W=M&&L&&!V&&!K&&n&&n.length>0,q=function(e,t,s,n){return Object(j.a)(async()=>{if(s){n(!0);try{await e.downloadKeys([t.userId]);const s=e.getStoredCrossSigningForUser(t.userId);return!!(s&&s.getId())}finally{n(!1)}}},[e,t,s],void 0)}(a,t,W,e=>{y(t=>t+(e?1:-1))}),$=void 0===n;let J;W&&(void 0!==q?U=c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_verifyButton",onClick:()=>{q?Object(N.d)(t):Object(N.a)(t)}},Object(g.a)("Verify")):$||(U=c.a.createElement(F.a,null))),t.userId==a.getUserId()&&(J=c.a.createElement("p",null,c.a.createElement(b.a,{className:"mx_UserInfo_field",onClick:()=>{m.a.dispatch({action:P.a.ViewUserSettings,initialTabId:D.a.Security})}},Object(g.a)("Edit devices"))));const Y=c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Security")),c.a.createElement("p",null,A),U,M&&c.a.createElement(ce,{loading:$,devices:n,userId:t.userId}),J);return c.a.createElement(c.a.Fragment,null,x,Y,c.a.createElement(le,{canInvite:_.canInvite,isIgnored:d,member:t,isSpace:Z.a.spacesEnabled&&(null==e?void 0:e.isSpaceRoom())}),T,R)},we=({member:e,e2eStatus:t})=>{const s=Object(r.useContext)(I.a),n=Object(r.useCallback)(()=>{const t=e.getMxcAvatarUrl?e.getMxcAvatarUrl():e.avatarUrl;if(!t)return;const s={src:Object(Q.b)(t).srcHttp,name:e.name||e.displayName};p.a.createDialog(L.a,s,"mx_Dialog_lightbox",null,!0)},[e]),i=c.a.createElement("div",{className:"mx_UserInfo_avatar"},c.a.createElement("div",null,c.a.createElement("div",null,c.a.createElement(V.a,{key:e.userId,member:e,width:.6*X.b.instance.windowHeight,height:.6*X.b.instance.windowHeight,resizeMethod:"scale",fallbackUserId:e.userId,onClick:n,urls:e.avatarUrl?[e.avatarUrl]:void 0}))));let a,o,l,d;e instanceof h.a&&e.user&&(a=e.user.presence,o=e.user.lastActiveAgo,l=e.user.currentlyActive,E.b.getValue("feature_custom_status")&&(d=e.user?e.user.unstable_statusMessage:e.unstable_statusMessage));const u=y.a.get().enable_presence_by_hs_url;let m=!0;u&&void 0!==u[s.baseUrl]&&(m=u[s.baseUrl]);let g=null;m&&(g=c.a.createElement(K.a,{activeAgo:o,currentlyActive:l,presenceState:a}));let v,f=null;d&&(f=c.a.createElement("span",{className:"mx_UserInfo_statusMessage"},d)),t&&(v=c.a.createElement(O.b,{size:18,status:t,isUser:!0}));const b=e.rawDisplayName||e.displayname;return c.a.createElement(c.a.Fragment,null,i,c.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator"},c.a.createElement("div",{className:"mx_UserInfo_profile"},c.a.createElement("div",null,c.a.createElement("h2",null,v,c.a.createElement("span",{title:b,"aria-label":b},b))),c.a.createElement("div",null,e.userId),c.a.createElement("div",{className:"mx_UserInfo_profileStatus"},g,f))))};t.a=e=>{let{user:t,groupId:s,room:n,onClose:a,phase:l=x.c.RoomMemberInfo}=e,d=o()(e,oe);const h=Object(r.useContext)(I.a),u=Object(r.useMemo)(()=>n&&n.getMember(t.userId)||t,[n,t]),p=Object(M.a)(h,n),v=Se(t.userId);let f;p&&v&&(f=((e,t,s)=>{const n=t===e.getUserId(),i=e.checkUserTrust(t);if(!i.isCrossSigningVerified())return i.wasCrossSigningVerified()?U.a.Warning:U.a.Normal;return s.some(s=>{const{deviceId:i}=s,a=e.checkDeviceTrust(t,i);return n?!a.isCrossSigningVerified():!a.isVerified()})?U.a.Warning:U.a.Verified})(h,t.userId,v));const b=["mx_UserInfo"];let y,E;n&&l===x.c.EncryptionPanel?(E=x.c.RoomMemberInfo,y={member:u}):null!=n&&n.isSpaceRoom()&&Z.a.spacesEnabled?(E=E=x.c.SpaceMemberList,y={space:n}):n&&(E=x.c.RoomMemberList);const S=()=>{m.a.dispatch({action:P.a.SetRightPanelPhase,phase:E,refireParams:y})};let _;switch(l){case x.c.RoomMemberInfo:case x.c.GroupMemberInfo:case x.c.SpaceMemberInfo:_=c.a.createElement(_e,{room:n,member:u,groupId:s,devices:v,isRoomEncrypted:p});break;case x.c.EncryptionPanel:b.push("mx_UserInfo_smallAvatar"),_=c.a.createElement(T.a,i()({},d,{member:u,onClose:S,isRoomEncrypted:p}))}let w,C=void 0;if(l===x.c.EncryptionPanel){const e=d.verificationRequest;e&&e.pending&&(C=Object(g.a)("Cancel"))}Z.a.spacesEnabled&&null!=n&&n.isSpaceRoom()&&(w=c.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},c.a.createElement(J.a,{room:n,height:32,width:32}),c.a.createElement(Y.a,{room:n})));const O=c.a.createElement(c.a.Fragment,null,w,c.a.createElement(we,{member:u,e2eStatus:f}));return c.a.createElement(A.b,{className:b.join(" "),header:O,onClose:a,closeLabel:C,previousPhase:E,refireParams:y},_)}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(571),d=s(106),h=s(540);const u=["space","spaceChildFilter","allLabel","specificLabel","noneLabel","warningMessage","onFinished"];t.a=e=>{let{space:t,spaceChildFilter:s,allLabel:n,specificLabel:a,noneLabel:m,warningMessage:p,onFinished:g}=e,v=o()(e,u);const f=Object(r.useMemo)(()=>{const e=d.a.instance.getChildren(t.roomId);return s?e.filter(s):e},[t.roomId,s]),[b,y]=Object(r.useState)([]),E=Object(r.useMemo)(()=>new Set(b),[b]);let S;return p&&(S=c.a.createElement("div",{className:"mx_ConfirmSpaceUserActionDialog_warning"},p)),c.a.createElement(l.a,i()({},v,{onFinished:(e,t)=>{g(e,t,b)},className:"mx_ConfirmSpaceUserActionDialog"}),S,c.a.createElement(h.a,{space:t,spaceChildren:f,selected:E,allLabel:n,specificLabel:a,noneLabel:m,onChange:y}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(87),h=s(90),u=s(159),m=s(126),p=s(219),g=s(85),v=s(104),f=s(88),b=s(106),y=s(1);let E=Object(g.a)("views.rooms.ThirdPartyMemberInfo")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"room",void 0),a()(this,"onRoomStateEvents",e=>{if("m.room.third_party_invite"===e.getType()&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,s={invited:Object(u.c)(e)};t&&(s.displayName=t),this.setState(s)}}),a()(this,"onCancel",()=>{d.a.dispatch({action:"view_3pid_invite",event:null})}),a()(this,"onKickClick",()=>{c.a.get().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch(e=>{y.a.error(e),this.setState({invited:!0}),h.a.createTrackedDialog("Revoke 3pid invite failed","",v.a,{title:Object(l.a)("Failed to revoke invite"),description:Object(l.a)("Could not revoke the invite. The server may be experiencing a temporary problem or you do not have sufficient permissions to revoke the invite.")})}),this.setState({invited:!1})}),this.room=c.a.get().getRoom(this.props.event.getRoomId());const t=this.room.getMember(c.a.get().getUserId()),s=this.room.currentState.getStateEvents("m.room.power_levels","");let n=s?s.getContent().kick:50;"number"!=typeof n&&(n=50);const i=this.room.getMember(this.props.event.getSender());this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!t&&t.powerLevel>n,senderName:i?i.name:this.props.event.getSender()}}componentDidMount(){c.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=c.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}render(){let e,t=null;return this.state.canKick&&this.state.invited&&(t=r.a.createElement("div",{className:"mx_MemberInfo_container"},r.a.createElement("h3",null,Object(l.a)("Admin Tools")),r.a.createElement("div",{className:"mx_MemberInfo_buttons"},r.a.createElement(f.a,{className:"mx_MemberInfo_field",onClick:this.onKickClick},Object(l.a)("Revoke invite"))))),b.a.spacesEnabled&&this.room.isSpaceRoom()&&(e=r.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},r.a.createElement(m.a,{room:this.room,height:32,width:32}),r.a.createElement(p.a,{room:this.room}))),r.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},e,r.a.createElement("div",{className:"mx_MemberInfo_name"},r.a.createElement(f.a,{className:"mx_MemberInfo_cancel",onClick:this.onCancel,title:Object(l.a)("Close")}),r.a.createElement("h2",null,this.state.displayName)),r.a.createElement("div",{className:"mx_MemberInfo_container"},r.a.createElement("div",{className:"mx_MemberInfo_profile"},r.a.createElement("div",{className:"mx_MemberInfo_profileField"},Object(l.a)("Invited by %(sender)s",{sender:this.state.senderName})))),t)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return P}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(282),h=s(94),u=s(182),m=s(122),p=s(85),g=s(134),v=s(403),f=s(133),b=s(245),y=s(87),E=s(92),S=s(86),_=s(927),w=s(118),C=s(202),O=s(576),k=s(84),R=s(516),I=s(244),x=s(89),T=s(154);function j(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function N(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?j(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):j(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let P=Object(p.a)("structures.ThreadView")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"dispatcherRef",void 0),r()(this,"timelinePanelRef",l.a.createRef()),r()(this,"onAction",e=>{switch(e.phase==m.c.ThreadView&&e.event&&(this.teardownThread(),this.setupThread(e.event)),e.action){case E.a.EditEvent:if(e.timelineRenderingType!==w.a.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new _.a(e.event):null},()=>{var t;e.event&&(null===(t=this.timelinePanelRef.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))});break;case"reply_to_event":e.context===w.a.Thread&&this.setState({replyToEvent:e.event})}}),r()(this,"setupThread",e=>{let t=this.props.room.threads.get(e.getId());if(!t){const s=S.a.get();t=new d.a([e],this.props.room,s)}t.on(d.b.Update,this.updateThread),t.once(d.b.Ready,this.updateThread),this.updateThread(t)}),r()(this,"teardownThread",()=>{this.state.thread&&(this.state.thread.removeListener(d.b.Update,this.updateThread),this.state.thread.removeListener(d.b.Ready,this.updateThread))}),r()(this,"onNewThread",e=>{e.id===this.props.mxEvent.getId()&&(this.teardownThread(),this.setupThread(this.props.mxEvent))}),r()(this,"updateThread",e=>{var t;e&&this.setState({thread:e}),null===(t=this.timelinePanelRef.current)||void 0===t||t.refreshTimeline()}),r()(this,"onScroll",()=>{var e;this.props.initialEvent&&this.props.initialEventHighlighted&&y.a.dispatch({action:E.a.ViewRoom,room_id:this.props.room.roomId,event_id:null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId(),highlighted:!1,replyingToEvent:this.state.replyToEvent})}),r()(this,"renderThreadViewHeader",()=>l.a.createElement("div",{className:"mx_ThreadPanel__header"},l.a.createElement("span",null,Object(k.a)("Thread")),l.a.createElement(R.a,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}))),this.state={}}componentDidMount(){this.setupThread(this.props.mxEvent),this.dispatcherRef=y.a.register(this.onAction);S.a.get().getRoom(this.props.mxEvent.getRoomId()).on(d.b.New,this.onNewThread)}componentWillUnmount(){this.teardownThread(),y.a.unregister(this.dispatcherRef);S.a.get().getRoom(this.props.mxEvent.getRoomId()).removeListener(d.b.New,this.onNewThread)}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&(this.teardownThread(),this.setupThread(this.props.mxEvent)),e.room!==this.props.room&&y.a.dispatch({action:E.a.SetRightPanelPhase,phase:m.c.RoomSummary})}render(){var e,t,s,n,i,a,o,r,c,d;const p=this.props.initialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():null,y={rel_type:h.c.Thread,event_id:null===(t=this.state.thread)||void 0===t?void 0:t.id};let E=I.a.getSharedInstance().previousPhase;x.b.getValue("feature_maximised_widgets")||(E=m.c.ThreadPanel),T.d.instance.hasMaximisedWidget(this.props.room)||(E=m.c.ThreadPanel),[m.c.ThreadPanel,m.c.Timeline].includes(E)||(E=m.c.ThreadPanel);const S={};return S[m.c.ThreadPanel]=Object(k.a)("All threads"),S[m.c.Timeline]=Object(k.a)("Chat"),l.a.createElement(w.b.Provider,{value:N(N({},this.context),{},{timelineRenderingType:w.a.Thread,liveTimeline:null===(s=this.state)||void 0===s||null===(n=s.thread)||void 0===n||null===(i=n.timelineSet)||void 0===i?void 0:i.getLiveTimeline()})},l.a.createElement(u.b,{className:"mx_ThreadView mx_ThreadPanel",onClose:this.props.onClose,previousPhase:E,previousPhaseLabel:S[E],withoutScrollContainer:!0,header:this.renderThreadViewHeader()},this.state.thread&&l.a.createElement(b.a,{ref:this.timelinePanelRef,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:null===(a=this.state)||void 0===a||null===(o=a.thread)||void 0===o?void 0:o.timelineSet,showUrlPreview:!0,tileShape:g.a.Thread,layout:f.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel mx_GroupLayout",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(r=this.props.initialEvent)||void 0===r?void 0:r.getId(),highlightedEventId:p,onUserScroll:this.onScroll}),C.b.sharedInstance().getCurrentUploads(y).length>0&&l.a.createElement(O.a,{room:this.props.room,relation:y}),(null===(c=this.state)||void 0===c||null===(d=c.thread)||void 0===d?void 0:d.timelineSet)&&l.a.createElement(v.a,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:y,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0})))}},r()(i,"contextType",w.b),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return I}));var n,i,a,o=s(95),r=s.n(o),c=s(83),l=s.n(c),d=s(82),h=s.n(d),u=s(84),m=s(276),p=s(86),g=s(87),v=s(88),f=s(152),b=s(399),y=s(201),E=s(89),S=s(105),_=s(178),w=s(92),C=s(267),O=s(85),k=s(906),R=s(1);let I=Object(O.a)("views.rooms.Stickerpicker")((a=i=class e extends h.a.PureComponent{constructor(t){super(t),l()(this,"dispatcherRef",void 0),l()(this,"prevSentVisibility",void 0),l()(this,"popoverWidth",400),l()(this,"popoverHeight",450),l()(this,"scalarClient",null),l()(this,"removeStickerpickerWidgets",async()=>{const e=await this.acquireScalarClient();R.a.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(_.a.STICKERPICKER,this.state.widgetId).then(()=>{R.a.log("Assets disabled")}).catch(e=>{R.a.error("Failed to disable assets")}):R.a.error("Cannot disable assets: no scalar client"):R.a.warn("No widget ID specified, not disabling assets"),this.props.setShowStickers(!1),f.a.removeStickerpickerWidgets().then(()=>{this.forceUpdate()}).catch(e=>{R.a.error("Failed to remove sticker picker widget",e)})}),l()(this,"updateWidget",()=>{const t=f.a.getStickerpickerWidgets()[0];if(!t)return e.currentWidget=null,void this.setState({stickerpickerWidget:null,widgetId:null});const s=e.currentWidget;let n=null;s&&s.content&&s.content.url&&(n=s.content.url);let i=null;t&&t.content&&t.content.url&&(i=t.content.url),i!==n&&b.a.destroyElement("stickerPicker"),e.currentWidget=t,this.setState({stickerpickerWidget:t,widgetId:t?t.id:null})}),l()(this,"onWidgetAction",e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":this.props.setShowStickers(!1);break;case w.a.AfterRightPanelPhaseChange:case"show_left_panel":case"hide_left_panel":this.props.setShowStickers(!1)}}),l()(this,"onShowStickersClick",e=>{if(!E.b.getValue("integrationProvisioning"))return y.a.sharedInstance().showDisabledDialog();const t=e.currentTarget.getBoundingClientRect();let s=t.right+window.pageXOffset-41;s=Math.min(s,document.body.clientWidth-412);const n=Math.max(10,2+window.pageXOffset+t.left-s),i=t.top+t.height/2+window.pageYOffset-19;this.props.setShowStickers(!0),this.setState({stickerpickerX:s,stickerpickerY:i,stickerpickerChevronOffset:n})}),l()(this,"onResize",()=>{this.props.showStickers&&this.props.setShowStickers(!1)}),l()(this,"onFinished",()=>{this.props.showStickers&&this.props.setShowStickers(!1)}),l()(this,"launchManageIntegrations",()=>{E.b.getValue("feature_many_integration_managers")?y.a.sharedInstance().openAll(this.props.room,"type_"+_.a.STICKERPICKER.preferred,this.state.widgetId):y.a.sharedInstance().getPrimaryManager().open(this.props.room,"type_"+_.a.STICKERPICKER.preferred,this.state.widgetId)}),this.state={imError:null,stickerpickerX:null,stickerpickerY:null,stickerpickerWidget:null,widgetId:null}}acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):y.a.sharedInstance().hasManager()?(this.scalarClient=y.a.sharedInstance().getPrimaryManager().getScalarClient(),this.scalarClient.connect().then(()=>(this.forceUpdate(),this.scalarClient)).catch(e=>{this.imError(Object(u.b)("Failed to connect to integration manager"),e)})):void y.a.sharedInstance().openNoManagerDialog()}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=g.a.register(this.onWidgetAction),p.a.get().on("accountData",this.updateWidget),this.updateWidget()}componentWillUnmount(){const e=p.a.get();e&&e.removeListener("accountData",this.updateWidget),window.removeEventListener("resize",this.onResize),this.dispatcherRef&&g.a.unregister(this.dispatcherRef)}componentDidUpdate(e,t){this.sendVisibilityToWidget(this.props.showStickers)}imError(e,t){R.a.error(e,t),this.setState({imError:Object(u.a)(e)}),this.props.setShowStickers(!1)}defaultStickerpickerContent(){return h.a.createElement(v.a,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},h.a.createElement("p",null,Object(u.a)("You don't currently have any stickerpacks enabled")),h.a.createElement("p",{className:"mx_Stickers_addLink"},Object(u.a)("Add some now")),h.a.createElement("img",{src:s(1606),alt:""}))}errorStickerpickerContent(){return h.a.createElement("div",{style:{textAlign:"center"},className:"error"},h.a.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=C.a.instance.getMessagingForId(this.state.stickerpickerWidget.id);t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch(e=>{R.a.error("Error updating widget visibility: ",e)}),this.prevSentVisibility=e)}getStickerpickerContent(){if(this.state.imError)return this.errorStickerpickerContent();const e=this.state.stickerpickerWidget;let t;if(e&&e.content&&e.content.url){e.content.name=e.content.name||Object(u.a)("Stickerpack");const s={id:e.id,url:e.content.url,name:e.content.name,type:e.content.type,data:e.content.data,roomId:e.content.roomId,eventId:e.content.eventId,avatar_url:e.content.avatar_url,creatorUserId:e.content.creatorUserId};t=h.a.createElement("div",{className:"mx_Stickers_content_container"},h.a.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},h.a.createElement(b.a,{persistKey:"stickerPicker",zIndex:3500},h.a.createElement(m.a,{app:s,room:this.props.room,fullWidth:!0,userId:p.a.get().credentials.userId,creatorUserId:e.sender||p.a.get().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0}))))}else t=this.defaultStickerpickerContent();return t}render(){return this.props.showStickers?h.a.createElement(S.n,r()({chevronOffset:this.state.stickerpickerChevronOffset,chevronFace:S.a.Bottom,left:this.state.stickerpickerX,top:this.state.stickerpickerY,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},this.props.menuPosition),h.a.createElement(k.a,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}},l()(i,"currentWidget",void 0),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85);let l=Object(c.a)("views.context_menus.GenericElementContextMenu")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"resize",()=>{this.props.onResize&&this.props.onResize()})}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return r.a.createElement("div",null,this.props.element)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(87),h=s(84),u=s(85),m=s(476),p=s(118);let g=Object(u.a)("views.rooms.ReplyPreview")((a=i=class extends l.a.Component{render(){return this.props.replyToEvent?l.a.createElement("div",{className:"mx_ReplyPreview"},l.a.createElement("div",{className:"mx_ReplyPreview_section"},l.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_title"},Object(h.a)("Replying")),l.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_cancel"},l.a.createElement("img",{className:"mx_filterFlipColor",src:s(402),width:"18",height:"18",onClick:()=>{return e=this.context.timelineRenderingType,void d.a.dispatch({action:"reply_to_event",event:null,context:e});var e}})),l.a.createElement("div",{className:"mx_ReplyPreview_clear"}),l.a.createElement("div",{className:"mx_ReplyPreview_tile"},l.a.createElement(m.a,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator,userNameColorMode:this.props.userNameColorMode})))):null}},r()(i,"contextType",p.b),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return I}));var n,i=s(83),a=s.n(i),o=s(111),r=s(84),c=s(82),l=s.n(c),d=s(338),h=s(86),u=s(909),m=s(85),p=s(910),g=s(911),v=s(123),f=s(505),b=s(94),y=s(90),E=s(104),S=s(315),_=s(192),w=s(264),C=s(184),O=s(145),k=s(598),R=s(1);let I=Object(m.a)("views.rooms.VoiceRecordComposerTile")(n=class extends l.a.PureComponent{constructor(e){super(e),a()(this,"onCancel",async()=>{await this.disposeRecording()}),a()(this,"onRecordStartEndClick",async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{y.a.createTrackedDialog("Microphone Access Error","",E.a,{title:Object(r.a)("Unable to access your microphone"),description:l.a.createElement(l.a.Fragment,null,l.a.createElement("p",null,Object(r.a)("We were unable to access your microphone. Please check your browser settings and try again.")))})};try{var t;const e=await S.c.getDevices();if(null==e||null===(t=e[S.b.AudioInput])||void 0===t||!t.length)return void y.a.createTrackedDialog("No Microphone Error","",E.a,{title:Object(r.a)("No microphone found"),description:l.a.createElement(l.a.Fragment,null,l.a.createElement("p",null,Object(r.a)("We didn't find a microphone on your device. Please check your settings and try again.")))})}catch(t){return R.a.error("Error getting devices: ",t),void e()}try{await k.a.instance.pauseAllExcept(null);const e=g.a.instance.startRecording();await e.start(),e.on(v.b,e=>{e!==d.b.EndingSoon&&this.setState({recordingPhase:e})}),this.setState({recorder:e,recordingPhase:d.b.Started})}catch(t){R.a.error("Error starting recording: ",t),e(),g.a.instance.disposeRecording()}}),this.state={recorder:null}}async componentWillUnmount(){await g.a.instance.disposeRecording()}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");let e;await this.state.recorder.stop();try{e=await this.state.recorder.upload(this.props.room.roomId)}catch(e){return R.a.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{h.a.get().sendMessage(this.props.room.roomId,{body:"Voice message",msgtype:b.b.Audio,url:e.mxc,file:e.encrypted,info:{duration:Math.round(1e3*this.state.recorder.durationSeconds),mimetype:this.state.recorder.contentType,size:this.state.recorder.contentLength},"org.matrix.msc1767.text":"Voice message","org.matrix.msc1767.file":{url:e.mxc,file:e.encrypted,name:"Voice message.ogg",mimetype:this.state.recorder.contentType,size:this.state.recorder.contentLength},"org.matrix.msc1767.audio":{duration:Math.round(1e3*this.state.recorder.durationSeconds),waveform:this.state.recorder.getPlayback().thumbnailWaveform.map(e=>Math.round(1024*e))},"org.matrix.msc3245.voice":{}})}catch(e){R.a.error("Error sending voice message:",e)}await this.disposeRecording()}async disposeRecording(){await g.a.instance.disposeRecording(),this.setState({recorder:null,recordingPhase:null,didUploadFail:!1})}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==d.b.Started?l.a.createElement(f.a,{playback:this.state.recorder.getPlayback()}):l.a.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},l.a.createElement(p.a,{recorder:this.state.recorder}),l.a.createElement(u.a,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,s;if(this.state.recordingPhase===d.b.Started){var n;let t=Object(r.a)("Send voice message");this.state.recorder&&(t=Object(r.a)("Stop recording")),e=l.a.createElement(o.a,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(n=this.state.recorder)&&void 0!==n&&n.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==d.b.Uploading&&(t=l.a.createElement(o.a,{className:"mx_VoiceRecordComposerTile_delete",title:Object(r.a)("Delete"),onClick:this.onCancel})),this.state.recordingPhase===d.b.Uploading?s=l.a.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},l.a.createElement(O.a,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===d.b.Ended&&(s=l.a.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},l.a.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},l.a.createElement(_.a,{notification:w.a.forSymbol("!",C.a.Red)})),l.a.createElement("span",{className:"text-warning"},Object(r.a)("Failed to send")))),l.a.createElement(l.a.Fragment,null,s,t,e,this.renderWaveformArea())}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(338),h=s(85),u=s(116),m=s(508),p=s(317);let g=Object(h.a)("views.audio_messages.LiveRecordingWaveform")((a=i=class extends l.a.PureComponent{constructor(e){super(e),r()(this,"waveform",[]),r()(this,"scheduledUpdate",new p.a(()=>this.updateWaveform(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={waveform:Object(u.h)(0,d.a)}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.waveform=Object(u.c)(Array.from(e.waveform),d.a),this.scheduledUpdate.mark()})}updateWaveform(){this.setState({waveform:this.waveform})}render(){return l.a.createElement(m.a,{relHeights:this.state.waveform})}},r()(i,"defaultProps",{progress:1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(316),d=s(317);let h=Object(c.a)("views.audio_messages.LiveRecordingClock")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"seconds",0),a()(this,"scheduledUpdate",new d.a(()=>this.updateClock(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()})}updateClock(){this.setState({seconds:this.seconds})}render(){return r.a.createElement(l.a,{seconds:this.state.seconds})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(338);class c extends a.a{constructor(){super(o.a,{})}get activeRecording(){return this.state.recording}static get instance(){return c.internalInstance||(c.internalInstance=new c),c.internalInstance}async onAction(e){}startRecording(){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(this.state.recording)throw new Error("A recording is already in progress");const e=new r.d(this.matrixClient);return this.updateState({recording:e}),e}disposeRecording(){return this.state.recording&&this.state.recording.destroy(),this.updateState({recording:null})}}i()(c,"internalInstance",void 0),window.mxVoiceRecordingStore=c.instance},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(706),h=s.n(d),u=s(112),m=s(94),p=s(1),g=s(87),v=s(1047),f=s(915),b=s(594),y=s(222),E=s(234),S=s(167),_=s(922),w=s(333),C=s(90),O=s(84),k=s(202),R=s(98),I=s(92),x=s(329),T=s(220),j=s(124),N=s(86),P=s(195),D=s(85),M=s(89),A=s(104),U=s(113),L=s(716),F=s(118),B=s(913),V=s(575);function K(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function W(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?K(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):K(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function G(e,t,s){const n=E.a.makeReplyMixIn(t);Object.assign(e,n);const i=E.a.getNestedReplyText(t,s);i&&(e.formatted_body&&(e.formatted_body=i.html+e.formatted_body),e.body=i.body+e.body)}let H=Object(D.a)("views.rooms.SendMessageComposer")((a=i=class extends l.a.Component{constructor(e,t){super(e),r()(this,"context",void 0),r()(this,"prepareToEncrypt",void 0),r()(this,"editorRef",Object(c.createRef)()),r()(this,"model",null),r()(this,"currentlyComposedEditorState",null),r()(this,"dispatcherRef",void 0),r()(this,"sendHistoryManager",void 0),r()(this,"onKeyDown",e=>{var t,s,n,i;if(null!==(t=this.editorRef.current)&&void 0!==t&&t.isComposing(e))return;const a=(null===(s=this.props.relation)||void 0===s?void 0:s.key)===m.c.Thread,o=Object(P.f)().getMessageComposerAction(e);switch(o){case P.b.Send:this.sendMessage(),e.preventDefault();break;case P.b.SelectPrevSendHistory:case P.b.SelectNextSendHistory:this.selectSendHistory(o===P.b.SelectPrevSendHistory)&&e.preventDefault();break;case P.b.EditPrevMessage:if(null!==(n=this.editorRef.current)&&void 0!==n&&n.isSelectionCollapsed()&&null!==(i=this.editorRef.current)&&void 0!==i&&i.isCaretAtStart()){const t=this.context.liveTimeline.getEvents().concat(a?[]:this.props.room.getPendingEvents()),s=Object(S.c)({events:t,isForward:!1});s&&(e.preventDefault(),g.a.dispatch({action:I.a.EditEvent,event:s,timelineRenderingType:this.context.timelineRenderingType}))}break;case P.b.CancelEditing:g.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType});break;default:this.prepareToEncrypt&&this.prepareToEncrypt()}}),r()(this,"shouldSaveStoredEditorState",()=>!this.model.isEmpty||!!this.props.replyToEvent),r()(this,"saveStoredEditorState",()=>{if(this.shouldSaveStoredEditorState()){const e=_.a.createItem(this.model,this.props.replyToEvent);localStorage.setItem(this.editorStateKey,JSON.stringify(e))}else this.clearStoredEditorState()}),r()(this,"onAction",e=>{var t;if(!this.props.disabled)switch(e.action){case"reply_to_event":case I.a.FocusSendMessageComposer:var s;if((null!==(t=e.context)&&void 0!==t?t:F.a.Room)===this.context.timelineRenderingType)null===(s=this.editorRef.current)||void 0===s||s.focus();break;case I.a.ComposerInsert:if(e.timelineRenderingType!==this.context.timelineRenderingType)break;if(e.composerType!==V.a.Send)break;var n;if(e.userId)null===(n=this.editorRef.current)||void 0===n||n.insertMention(e.userId);else if(e.event){var i;null===(i=this.editorRef.current)||void 0===i||i.insertQuotedMessage(e.event)}else if(e.text){var a;null===(a=this.editorRef.current)||void 0===a||a.insertPlaintext(e.text)}}}),r()(this,"onPaste",e=>{const{clipboardData:t}=e;if(t.files.length&&!t.types.includes("text/rtf"))return k.b.sharedInstance().sendContentListToRoom(Array.from(t.files),this.props.room.roomId,this.props.relation,this.props.mxClient),!0}),r()(this,"onChange",()=>{this.props.onChange&&this.props.onChange(this.model)}),r()(this,"focusComposer",()=>{var e;null===(e=this.editorRef.current)||void 0===e||e.focus()}),this.props.mxClient.isCryptoEnabled()&&this.props.mxClient.isRoomEncrypted(this.props.room.roomId)&&(this.prepareToEncrypt=Object(u.throttle)(()=>{this.props.mxClient.prepareToEncrypt(this.props.room)},6e4,{leading:!0,trailing:!1})),window.addEventListener("beforeunload",this.saveStoredEditorState)}componentDidUpdate(e){var t,s,n;const i=(null===(t=this.props.relation)||void 0===t?void 0:t.key)===m.c.Thread,a=(null===(s=this.props.relation)||void 0===s?void 0:s.event_id)!==(null===(n=e.relation)||void 0===n?void 0:n.event_id);if(i&&a){var o;const e=new y.a(this.props.room,this.props.mxClient),t=this.restoreStoredEditorState(e)||[];this.model.reset(t),null===(o=this.editorRef.current)||void 0===o||o.focus()}}selectSendHistory(e){const t=e?-1:1;if(this.sendHistoryManager.currentIndex===this.sendHistoryManager.history.length){if(!e)return!1;this.currentlyComposedEditorState=this.model.serializeParts()}else if(this.sendHistoryManager.currentIndex+t===this.sendHistoryManager.history.length)return this.model.reset(this.currentlyComposedEditorState),this.sendHistoryManager.currentIndex=this.sendHistoryManager.history.length,!0;const{parts:s,replyEventId:n}=this.sendHistoryManager.getItem(t);var i;(g.a.dispatch({action:"reply_to_event",event:n?this.props.room.findEventById(n):null,context:this.context.timelineRenderingType}),s)&&(this.model.reset(s),null===(i=this.editorRef.current)||void 0===i||i.focus());return!0}isSlashCommand(){const e=this.model.parts[0];if(e){if(e.type===y.b.Command&&e.text.startsWith("/")&&!e.text.startsWith("//"))return!0;if(e.text.startsWith("/")&&!e.text.startsWith("//")&&(e.type===y.b.Plain||e.type===y.b.PillCandidate))return!0}return!1}sendQuickReaction(){const e=this.context.liveTimeline.getEvents(),t=this.model.parts[1].text;for(let s=e.length-1;s>=0;s--)if(e[s].getType()===m.a.RoomMessage){let n=!0;const i=e[s],a=N.a.get().getUserId(),o=this.props.room.getUnfilteredTimelineSet().getRelationsForEvent(i.getId(),m.c.Annotation,m.a.Reaction);if(o){n=![...o.getAnnotationsBySender()[a]||[]].filter(e=>!e.isRedacted()).map(e=>e.getRelation().key).includes(t)}n&&(N.a.get().sendEvent(i.getRoomId(),m.a.Reaction,{"m.relates_to":{rel_type:m.c.Annotation,event_id:i.getId(),key:t}}),g.a.dispatch({action:"message_sent"}));break}}getSlashCommand(){const e=this.model.parts.reduce((e,t)=>"user-pill"===t.type?e+t.resourceId:e+t.text,""),{cmd:t,args:s}=Object(w.d)(e);return[t,s,e]}async runSlashCommand(e,t){var s,n;const i=(null===(s=this.props.relation)||void 0===s?void 0:s.rel_type)===m.c.Thread?null===(n=this.props.relation)||void 0===n?void 0:n.event_id:null,a=e.run(this.props.room.roomId,i,t);let o,r=a.error;if(a.promise)try{e.category===w.a.messages?o=await a.promise:await a.promise}catch(e){r=e}if(r){p.a.error("Command failure: %s",r);const e=!!a.promise?Object(O.b)("Server error"):Object(O.b)("Command error");let t;t="string"==typeof r?r:r.message?r.message:Object(O.a)("Server unavailable, overloaded, or something else went wrong."),C.a.createTrackedDialog(e,"",A.a,{title:Object(O.a)(e),description:t})}else if(p.a.log("Command success."),o)return o}async sendMessage(){var e,t;const s=this.model;if(s.isEmpty)return;if(M.b.getValue("MessageComposerInput.autoReplaceEmoji")){var n;const e=s.parts.length-1,t=s.parts[e].text.length;null===(n=this.editorRef.current)||void 0===n||n.replaceEmoticon(new B.a(e,t),b.a)}const i=this.props.replyToEvent;let a,o=!0;if(!Object(f.a)(s)&&this.isSlashCommand()){const[e,t,s]=this.getSlashCommand();if(e)e.category===w.a.messages?(a=await this.runSlashCommand(e,t),i&&G(a,i,this.props.permalinkCreator),function(e,t){t&&(e["m.relates_to"]=W(W({},t),e["m.relates_to"]))}(a,this.props.relation)):(this.runSlashCommand(e,t),o=!1);else{const{finished:e}=C.a.createTrackedDialog("Unknown command","",U.a,{title:Object(O.a)("Unknown Command"),description:l.a.createElement("div",null,l.a.createElement("p",null,Object(O.a)("Unrecognised command: %(commandText)s",{commandText:s})),l.a.createElement("p",null,Object(O.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>l.a.createElement("code",null,e)})),l.a.createElement("p",null,Object(O.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>l.a.createElement("code",null,e)}))),button:Object(O.a)("Send as message")}),[t]=await e;if(!t)return}}if(function(e){const t=e.parts;if(0==t.length)return!1;const s=Object(f.f)(e);if(t.length<=2){const e=s.startsWith("+")||s.startsWith("+ "),t=s.match(h.a);if(e&&t&&1==t.length)return t[0]===s.substring(1)||t[0]===s.substring(2)}return!1}(s)&&(o=!1,this.sendQuickReaction()),o){var r;const e=j.a.getTimestamp(),{roomId:t}=this.props.room;if(a||(a=function(e,t,s,n){const i=Object(f.a)(e);i&&(e=Object(f.d)(e)),Object(f.c)(e,"//")&&(e=Object(f.e)(e,"/")),e=Object(f.g)(e);const a={msgtype:i?"m.emote":"m.text",body:Object(f.f)(e)},o=Object(f.b)(e,{forceHTML:!!t});return o&&(a.format="org.matrix.custom.html",a.formatted_body=o),t&&G(a,t,n),s&&(a["m.relates_to"]=W(W({},s),a["m.relates_to"])),a}(s,i,this.props.relation,this.props.permalinkCreator)),!a.body.trim())return;M.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(L.a)(a);const n=(null===(r=this.props.relation)||void 0===r?void 0:r.rel_type)===m.c.Thread?this.props.relation.event_id:null,o=this.props.mxClient.sendMessage(t,n,a);i&&g.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType}),g.a.dispatch({action:"message_sent"}),T.CHAT_EFFECTS.forEach(e=>{if(Object(x.containsEmoji)(a,e.emojis)){var t;const s=(null===(t=this.props.relation)||void 0===t?void 0:t.rel_type)!==m.c.Thread;M.b.getValue("feature_thread")&&!s||g.a.dispatch({action:"effects."+e.command})}}),M.b.getValue("Performance.addSendMessageTimingMetadata")&&o.then(e=>{Object(L.b)(this.props.mxClient,t,e.event_id)}),j.a.instance.trackSendMessage(e,o,t,!1,!!i,a)}this.sendHistoryManager.save(s,i),s.reset([]),null===(e=this.editorRef.current)||void 0===e||e.clearUndoHistory(),null===(t=this.editorRef.current)||void 0===t||t.focus(),this.clearStoredEditorState(),M.b.getValue("scrollToBottomOnMessageSent")&&g.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:this.context.timelineRenderingType})}componentWillUnmount(){g.a.unregister(this.dispatcherRef),window.removeEventListener("beforeunload",this.saveStoredEditorState),this.saveStoredEditorState()}UNSAFE_componentWillMount(){const e=new y.a(this.props.room,this.props.mxClient),t=this.restoreStoredEditorState(e)||[];this.model=new v.a(t,e),this.dispatcherRef=g.a.register(this.onAction),this.sendHistoryManager=new _.a(this.props.room.roomId,"mx_cider_history_")}get editorStateKey(){var e;let t="mx_cider_state_"+this.props.room.roomId;const s=null===(e=this.props.replyToEvent)||void 0===e?void 0:e.getThread();return s&&(t+="_"+s.id),t}clearStoredEditorState(){localStorage.removeItem(this.editorStateKey)}restoreStoredEditorState(e){var t;if((null===(t=this.props.relation)||void 0===t?void 0:t.key)===m.c.Thread)return null;const s=localStorage.getItem(this.editorStateKey);if(s)try{const{parts:t,replyEventId:n}=JSON.parse(s),i=t.map(t=>e.deserializePart(t));return n&&g.a.dispatch({action:"reply_to_event",event:this.props.room.findEventById(n),context:this.context.timelineRenderingType}),i}catch(e){p.a.error(e)}}render(){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===m.c.Thread?this.props.relation.event_id:null;return l.a.createElement("div",{className:"mx_SendMessageComposer",onClick:this.focusComposer,onKeyDown:this.onKeyDown},l.a.createElement(b.b,{onChange:this.onChange,ref:this.editorRef,model:this.model,room:this.props.room,threadId:t,label:this.props.placeholder,placeholder:this.props.placeholder,onPaste:this.onPaste,disabled:this.props.disabled}))}},r()(i,"contextType",F.b),n=a))||n;const q=Object(R.b)(H);t.a=q},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(914);class i{constructor(e,t){this.index=e,this.offset=t}compare(e){return this.index===e.index?this.offset-e.offset:this.index-e.index}iteratePartsBetween(e,t,s){if(-1===this.index||-1===e.index)return;const[n,i]=this.compare(e)<0?[this,e]:[e,this];if(n.index===i.index)s(t.parts[this.index],n.offset,i.offset);else{const e=t.parts[n.index];s(e,n.offset,e.text.length);for(let e=n.index+1;e<i.index;++e){const n=t.parts[e];s(n,0,n.text.length)}s(t.parts[i.index],0,i.offset)}}forwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const{parts:a}=e;for(;s<a.length;){const e=a[s];for(;n<e.text.length;){if(!t(s,n,e))return new i(s,n);n+=1}if(s===a.length-1)return new i(s,n);s+=1,n=0}}backwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const a=e.parts;for(;s>=0;){const e=a[s];for(;n>0;){if(!t(s,n-1,e))return new i(s,n);n-=1}if(0===s)return new i(s,n);s-=1,n=a[s].text.length}}asOffset(e){if(-1===this.index)return new n.a(0,!0);let t=0;for(let s=0;s<this.index;++s)t+=e.parts[s].text.length;t+=this.offset;const s=e.parts[this.index],i=!s||t>=s.text.length;return new n.a(t,i)}isAtEnd(e){if(0===e.parts.length)return!0;const t=e.parts.length-1,s=e.parts[t];return this.index===t&&this.offset===s.text.length}isAtStart(){return 0===this.index&&0===this.offset}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e,t){this.offset=e,this.atNodeEnd=t}asPosition(e){return e.positionForOffset(this.offset,this.atNodeEnd)}add(e,t=!1){return new n(this.offset+e,t)}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return h})),s.d(t,"f",(function(){return u})),s.d(t,"a",(function(){return m})),s.d(t,"c",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"e",(function(){return v})),s.d(t,"g",(function(){return f}));var n=s(739),i=s(120),a=s(474),o=s(89),r=s(93),c=s(678),l=s.n(c),d=s(222);function h(e,{forceHTML:t=!1}={}){let s=function(e){return e.parts.reduce((e,t)=>{switch(t.type){case d.b.Newline:return e+"\n";case d.b.Plain:case d.b.Command:case d.b.PillCandidate:case d.b.AtRoomPill:return e+t.text;case d.b.RoomPill:return e+`[${t.resourceId.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(i.e)(t.resourceId)})`;case d.b.UserPill:return e+`[${t.text.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(i.e)(t.resourceId)})`}},"")}(e);const c=s;if(o.b.getValue("feature_latex_maths")){const e=["display","inline"],t={tex:{display:"(^)\\$\\$(([^$]|\\\\\\$)+?)\\$\\$$",inline:"(^|\\s|[.,!?:;])(?!\\\\)\\$(?!\\s)(([^$\\n]|\\\\\\$)*([^\\\\\\s\\$]|\\\\\\$)(?:\\\\\\$)?)\\$"},latex:{display:"(^)\\\\\\[(?!\\\\\\])(.*?)\\\\\\]$",inline:"(^|[^\\\\])\\\\\\((?!\\\\\\))(.*?)\\\\\\)"}};["tex","latex"].forEach((function(n){e.forEach((function(e){const i=(((r.a.get().latex_maths_delims||{})[e]||{}).pattern||{})[n]||t[n][e];s=s.replace(RegExp(i,"gms"),(function(t,s,n){const i=a.AllHtmlEntities.encode(n);switch(e){case"display":return`${s}<div data-mx-maths="${i}">\n\n</div>\n\n`;case"inline":return`${s}<span data-mx-maths="${i}"></span>`}}))}))})),s=s.replace(/(.)<div/g,(function(e,t){return t+"\n<div"}))}const h=new n.a(s);if(!h.isPlainText()||t){const e=l.a.load(h.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});if(o.b.getValue("feature_latex_maths")){const t=new n.a(c),s=l.a.load(t.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});s("code").each((function(t){e("code").eq(t).text(s("code").eq(t).text())})),e("div, span").each((function(t,s){const n=e(s).attr("data-mx-maths");n&&e(s).html(`<code>${n}</code>`)}))}return e.html()}if(s.indexOf("\\")>-1)return h.toPlaintext()}function u(e){return e.parts.reduce((e,t)=>{switch(t.type){case d.b.Newline:return e+"\n";case d.b.Plain:case d.b.Command:case d.b.PillCandidate:case d.b.AtRoomPill:return e+t.text;case d.b.RoomPill:return e+""+t.resourceId;case d.b.UserPill:return e+""+t.text}},"")}function m(e){return p(e,"/me ",!1)}function p(e,t,s=!0){const n=e.parts[0];let i=(null==n?void 0:n.text)||"";return s||(t=t.toLowerCase(),i=i.toLowerCase()),n&&(n.type===d.b.Plain||n.type===d.b.Command)&&i.startsWith(t)}function g(e){return v(e,"/me ")}function v(e,t){return(e=e.clone()).removeText({index:0,offset:0},t.length),e}function f(e){const{parts:t}=e;if(t.length){const s=t[0];s.type===d.b.Plain&&s.text.startsWith("\\/")&&(e=e.clone()).removeText({index:0,offset:0},1)}return e}},function(e,t,s){"use strict";function n(e){const t=2*Math.PI/e.length;return Array.from(e).map((e,s)=>{if(" "===e)return e;const[n,o]=function(e,t){const s=127*t*Math.cos(e),n=127*t*Math.sin(e);return[s,n]}(s*t,1),[r,c,l]=function(e,t,s){let n=(e+16)/116;const o=.9505*i(n+t/500),r=1.089*i(n-s/200);n=i(n);const c=-.96924364*o+1.8759675*n+.04155506*r,l=.05563008*o-.20397696*n+1.05697151*r;return[a(3.24096994*o-1.53738318*n-.49861076*r),a(c),a(l)]}(75,n,o);return'<font color="#'+r.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+'">'+e+"</font>"}).join("")}function i(e){return e>.2069?Math.pow(e,3):.1284*e-.01771}function a(e){const t=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}(e),s=Math.min(Math.max(t,0),1);return Math.round(255*s)}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(306),u=s.n(h),m=s(85),p=s(721),g=s(97),v=s(109);let f=Object(m.a)("views.dialogs.UploadConfirmDialog")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"objectUrl",void 0),r()(this,"mimeType",void 0),r()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),r()(this,"onUploadClick",()=>{this.props.onFinished(!0)}),r()(this,"onUploadAllClick",()=>{this.props.onFinished(!0,!0)}),this.mimeType=Object(p.a)(e.file.type);const t=new Blob([e.file],{type:this.mimeType});this.objectUrl=URL.createObjectURL(t)}componentWillUnmount(){this.objectUrl&&URL.revokeObjectURL(this.objectUrl)}render(){let e,t,n;return e=this.props.totalFiles>1&&void 0!==this.props.currentIndex?Object(d.a)("Upload files (%(current)s of %(total)s)",{current:this.props.currentIndex+1,total:this.props.totalFiles}):Object(d.a)("Upload files"),t=this.mimeType.startsWith("image/")?l.a.createElement("div",{className:"mx_UploadConfirmDialog_previewOuter"},l.a.createElement("div",{className:"mx_UploadConfirmDialog_previewInner"},l.a.createElement("div",null,l.a.createElement("img",{className:"mx_UploadConfirmDialog_imagePreview",src:this.objectUrl})),l.a.createElement("div",null,this.props.file.name," (",u()(this.props.file.size),")"))):l.a.createElement("div",null,l.a.createElement("div",null,l.a.createElement("img",{className:"mx_UploadConfirmDialog_fileIcon",src:s(1607)}),this.props.file.name," (",u()(this.props.file.size),")")),this.props.currentIndex+1<this.props.totalFiles&&(n=l.a.createElement("button",{onClick:this.onUploadAllClick},Object(d.a)("Upload all"))),l.a.createElement(g.a,{className:"mx_UploadConfirmDialog",fixedWidth:!1,onFinished:this.onCancelClick,title:e,contentId:"mx_Dialog_content"},l.a.createElement("div",{id:"mx_Dialog_content"},t),l.a.createElement(v.a,{primaryButton:Object(d.a)("Upload"),hasCancel:!1,onPrimaryButtonClick:this.onUploadClick,focus:!0},n))}},r()(i,"defaultProps",{totalFiles:1}),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(333),r=s(166);t.a=({onFinished:e})=>{const t={};o.c.forEach(e=>{e.isEnabled()&&(t[e.category]||(t[e.category]=[]),t[e.category].push(e))});const s=Object.values(o.a).filter(e=>t[e]).map(e=>{const s=[i.a.createElement("tr",{key:"_category_"+e,className:"mx_SlashCommandHelpDialog_headerRow"},i.a.createElement("td",{colSpan:3},i.a.createElement("h2",null,Object(a.a)(e))))];return t[e].forEach(e=>{s.push(i.a.createElement("tr",{key:e.command},i.a.createElement("td",null,i.a.createElement("strong",null,e.getCommand())),i.a.createElement("td",null,e.args),i.a.createElement("td",null,e.description)))}),s});return i.a.createElement(r.a,{className:"mx_SlashCommandHelpDialog",title:Object(a.a)("Command Help"),description:i.a.createElement("table",null,i.a.createElement("tbody",null,s)),hasCloseButton:!0,onFinished:e})}},,function(e,t,s){"use strict";s.d(t,"b",(function(){return p})),s.d(t,"a",(function(){return g}));var n=s(574),i=s(138),a=s(120),o=s(222),r=s(93),c=s(916);function l(e,t){const s=[];return e.split("@room").forEach((e,n,i)=>{e.length&&s.push(t.plain(e));n===i.length-1||s.push(t.atRoomPill("@room"))}),s}function d(e,t,s,n){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return function(e,t){const s=parseInt(e.nodeName.substr(1),10);return t.plain("#".repeat(s)+" ")}(e,t);case"A":return function(e,t){const{href:s}=e,n=Object(a.c)(s);switch(n?n[0]:void 0){case"@":return t.userPill(e.textContent,n);case"#":return t.roomPill(n);default:return s===e.textContent?t.plain(e.textContent):t.plain(`[${e.textContent.replace(/[[\\\]]/g,e=>"\\"+e)}](${s})`)}}(e,t);case"IMG":return function(e,t){const{src:s}=e;return t.plain(`![${e.alt.replace(/[[\\\]]/g,e=>"\\"+e)}](${s})`)}(e,t);case"BR":return t.newline();case"EM":return t.plain(`_${e.textContent}_`);case"STRONG":return t.plain(`**${e.textContent}**`);case"PRE":return function(e,t){const s=[];let n="";if(e.firstChild&&"CODE"===e.firstChild.nodeName)for(const t of e.firstChild.classList)if(t.startsWith("language-")&&!t.startsWith("language-_")){n=t.substr("language-".length);break}const i=("```"+n+"\n"+e.textContent+"```").split("\n");return i.forEach((e,n)=>{s.push(t.plain(e)),n<i.length-1&&s.push(t.newline())}),s}(e,t);case"CODE":return t.plain(`\`${e.textContent}\``);case"DEL":return t.plain(`<del>${e.textContent}</del>`);case"SUB":return t.plain(`<sub>${e.textContent}</sub>`);case"SUP":return t.plain(`<sup>${e.textContent}</sup>`);case"U":return t.plain(`<u>${e.textContent}</u>`);case"LI":{const s="  ".repeat(n.listDepth-1);if("OL"===e.parentElement.nodeName){const e=n.listIndex[n.listIndex.length-1];return n.listIndex[n.listIndex.length-1]+=1,t.plain(`${s}${e}. `)}return t.plain(s+"- ")}case"P":if(s)return t.newline();break;case"DIV":case"SPAN":if(e.hasAttribute("data-mx-maths")){const s="SPAN"==e.nodeName?((r.a.get().latex_maths_delims||{}).inline||{}).left||"\\(":((r.a.get().latex_maths_delims||{}).display||{}).left||"\\[",n="SPAN"==e.nodeName?((r.a.get().latex_maths_delims||{}).inline||{}).right||"\\)":((r.a.get().latex_maths_delims||{}).display||{}).right||"\\]",i=e.getAttribute("data-mx-maths");return t.plain(s+i+n)}if(!h(e))return t.plain(e.textContent);break;case"OL":n.listIndex.push(e.start||1);case"UL":n.listDepth=(n.listDepth||0)+1;default:if(!h(e))return t.plain(e.textContent)}}function h(e){switch(e.nodeName){case"PRE":return!1;default:return Object(i.c)(e)}}function u(e){return e.nodeType===Node.TEXT_NODE?"\n"===e.nodeValue:e.nodeType!==Node.ELEMENT_NODE||"MX-REPLY"===e.nodeName}function m(e,t,s){const a=(new DOMParser).parseFromString(e,"text/html").body,r=[];let c,m=s;const p={listIndex:[]};return Object(n.c)(a,(function(e){if(u(e))return!1;"BLOCKQUOTE"===e.nodeName&&(m=!0);const s=[];if(c&&(Object(i.c)(c)||Object(i.c)(e))&&s.push(t.newline()),e.nodeType===Node.TEXT_NODE)s.push(...l(e.nodeValue,t));else if(e.nodeType===Node.ELEMENT_NODE){const n=d(e,t,c,p);n&&(Array.isArray(n)?s.push(...n):s.push(n))}if(s.length&&m){!function(e,t,s){e&&t.splice(0,0,s.plain("> "));for(let e=0;e<t.length;e+=1)t[e].type===o.b.Newline&&(t.splice(e+1,0,s.plain("> ")),e+=1)}(0===r.length,s,t)}r.push(...s);const n=h(e);return c=n?null:e,n}),(function(e){if(!u(e)){switch(e.nodeName){case"BLOCKQUOTE":m=!1;break;case"OL":p.listIndex.pop();case"UL":p.listDepth-=1}c=e}})),r}function p(e,t,s){const n=e.split(/\r\n|\r|\n/g);return n.reduce((e,i,a)=>{s&&e.push(t.plain("> ")),e.push(...l(i,t));return a===n.length-1||e.push(t.newline()),e},[])}function g(e,t,{isQuotedMessage:s=!1}={}){const n=e.getContent();let i;const a="m.emote"===n.msgtype;let o=!1;return"org.matrix.custom.html"===n.format?(i=m(n.formatted_body||"",t,s),n.body&&n.formatted_body&&Object(c.a)(n.body)===n.formatted_body&&(o=!0)):i=p(n.body||"",t,s),a&&o?i.unshift(t.plain("/rainbowme ")):o?i.unshift(t.plain("/rainbow ")):a&&i.unshift(t.plain("/me ")),i}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(84),h=s(111),u=s(85);let m;!function(e){e.Bold="bold",e.Italics="italics",e.Strikethrough="strikethrough",e.Code="code",e.Quote="quote",e.InsertLink="insert_link"}(m||(m={}));let p=Object(u.a)("views.rooms.MessageComposerFormatBar")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"formatBarRef",Object(o.createRef)()),this.state={visible:!1}}render(){const e=l()("mx_MessageComposerFormatBar",{mx_MessageComposerFormatBar_shown:this.state.visible});return r.a.createElement("div",{className:e,ref:this.formatBarRef},r.a.createElement(g,{label:Object(d.a)("Bold"),onClick:()=>this.props.onAction(m.Bold),icon:"Bold",shortcut:this.props.shortcuts.bold,visible:this.state.visible}),r.a.createElement(g,{label:Object(d.a)("Italics"),onClick:()=>this.props.onAction(m.Italics),icon:"Italic",shortcut:this.props.shortcuts.italics,visible:this.state.visible}),r.a.createElement(g,{label:Object(d.a)("Strikethrough"),onClick:()=>this.props.onAction(m.Strikethrough),icon:"Strikethrough",visible:this.state.visible}),r.a.createElement(g,{label:Object(d.a)("Code block"),onClick:()=>this.props.onAction(m.Code),icon:"Code",visible:this.state.visible}),r.a.createElement(g,{label:Object(d.a)("Quote"),onClick:()=>this.props.onAction(m.Quote),icon:"Quote",shortcut:this.props.shortcuts.quote,visible:this.state.visible}),r.a.createElement(g,{label:Object(d.a)("Insert link"),onClick:()=>this.props.onAction(m.InsertLink),icon:"InsertLink",visible:this.state.visible}))}showAt(e){if(!this.formatBarRef.current)return;this.setState({visible:!0});const t=this.formatBarRef.current.parentElement.getBoundingClientRect();let s;const n=this.formatBarRef.current.clientWidth;s=e.left+n+6<t.right?e.left-t.left:t.right-t.left-n-6,this.formatBarRef.current.style.left=s+"px",this.formatBarRef.current.style.top=e.top-t.top-20-16+"px"}hide(){this.setState({visible:!1})}})||n;class g extends r.a.PureComponent{render(){const e="mx_MessageComposerFormatBar_button mx_MessageComposerFormatBar_buttonIcon"+this.props.icon;let t;this.props.shortcut&&(t=r.a.createElement("div",{className:"mx_MessageComposerFormatBar_tooltipShortcut"},this.props.shortcut));const s=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Tooltip_title"},this.props.label),r.a.createElement("div",{className:"mx_Tooltip_sub"},t));return r.a.createElement(h.a,{onClick:this.props.onClick,title:this.props.label,tooltip:s,className:e})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(83),i=s.n(n),a=s(112),o=s(1);class r{constructor(e,t){i()(this,"history",[]),i()(this,"prefix",void 0),i()(this,"lastIndex",0),i()(this,"currentIndex",0),this.prefix=t+e;let s,n=0;for(;s=sessionStorage.getItem(`${this.prefix}[${n}]`);){try{this.history.push(JSON.parse(s))}catch(e){o.a.warn("Throwing away unserialisable history",e);break}++n}this.lastIndex=this.history.length-1,this.currentIndex=this.lastIndex+1}static createItem(e,t){return{parts:e.serializeParts(),replyEventId:t?t.getId():void 0}}save(e,t){const s=r.createItem(e,t);this.history.push(s),this.currentIndex=this.history.length,this.lastIndex+=1,sessionStorage.setItem(`${this.prefix}[${this.lastIndex}]`,JSON.stringify(s))}getItem(e){return this.currentIndex=Object(a.clamp)(this.currentIndex+e,0,this.history.length-1),this.history[this.currentIndex]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(86),h=s(84),u=s(142),m=s(91),p=s.n(m),g=s(924),v=s(89),f=s(105),b=s(85);let y=Object(b.a)("views.avatars.MemberStatusMessageAvatar")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"button",Object(c.createRef)()),r()(this,"onStatusMessageCommitted",()=>{this.setState({hasStatus:this.hasStatus})}),r()(this,"openMenu",()=>{this.setState({menuDisplayed:!0})}),r()(this,"closeMenu",()=>{this.setState({menuDisplayed:!1})}),this.state={hasStatus:this.hasStatus,menuDisplayed:!1}}componentDidMount(){if(this.props.member.userId!==d.a.get().getUserId())throw new Error("Cannot use MemberStatusMessageAvatar on anyone but the logged in user");if(!v.b.getValue("feature_custom_status"))return;const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this.onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props.member;e&&e.removeListener("User._unstable_statusMessage",this.onStatusMessageCommitted)}get hasStatus(){const{user:e}=this.props.member;return!!e&&!!e.unstable_statusMessage}render(){const e=l.a.createElement(u.a,{member:this.props.member,width:this.props.width,height:this.props.height,resizeMethod:this.props.resizeMethod});if(!v.b.getValue("feature_custom_status"))return e;const t=p()({mx_MemberStatusMessageAvatar:!0,mx_MemberStatusMessageAvatar_hasStatus:this.state.hasStatus});let s;if(this.state.menuDisplayed){const e=this.button.current.getBoundingClientRect(),t=16,n=1;s=l.a.createElement(f.n,{chevronOffset:(e.width-t)/2,chevronFace:f.a.Bottom,left:e.left+window.pageXOffset,top:e.top+window.pageYOffset-n,menuWidth:226,onFinished:this.closeMenu},l.a.createElement(g.a,{user:this.props.member.user}))}return l.a.createElement(l.a.Fragment,null,l.a.createElement(f.b,{className:t,inputRef:this.button,onClick:this.openMenu,isExpanded:this.state.menuDisplayed,label:Object(h.a)("User Status")},e),s)}},r()(i,"defaultProps",{width:40,height:40,resizeMethod:"crop"}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(88),h=s(85),u=s(96);let m=Object(h.a)("views.context_menus.StatusMessageContextMenu")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onStatusMessageCommitted",()=>{this.setState({message:this.comittedStatusMessage,waiting:!1})}),a()(this,"onClearClick",()=>{l.a.get()._unstable_setStatusMessage(""),this.setState({waiting:!0})}),a()(this,"onSubmit",e=>{e.preventDefault(),l.a.get()._unstable_setStatusMessage(this.state.message),this.setState({waiting:!0})}),a()(this,"onStatusChange",e=>{this.setState({message:e.target.value})}),this.state={message:this.comittedStatusMessage,waiting:!1}}componentDidMount(){const{user:e}=this.props;e&&e.on("User._unstable_statusMessage",this.onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props;e&&e.removeListener("User._unstable_statusMessage",this.onStatusMessageCommitted)}get comittedStatusMessage(){return this.props.user?this.props.user.unstable_statusMessage:""}render(){let e;e=this.comittedStatusMessage?this.state.message===this.comittedStatusMessage?r.a.createElement(d.a,{className:"mx_StatusMessageContextMenu_clear",onClick:this.onClearClick},r.a.createElement("span",null,Object(c.a)("Clear status"))):r.a.createElement(d.a,{className:"mx_StatusMessageContextMenu_submit",onClick:this.onSubmit},r.a.createElement("span",null,Object(c.a)("Update status"))):r.a.createElement(d.a,{className:"mx_StatusMessageContextMenu_submit",disabled:!this.state.message,onClick:this.onSubmit},r.a.createElement("span",null,Object(c.a)("Set status")));let t=null;this.state.waiting&&(t=r.a.createElement(u.a,{w:24,h:24}));const s=r.a.createElement("form",{className:"mx_StatusMessageContextMenu_form",autoComplete:"off",onSubmit:this.onSubmit},r.a.createElement("input",{type:"text",className:"mx_StatusMessageContextMenu_message",key:"message",placeholder:Object(c.a)("Set a new status..."),autoFocus:!0,maxLength:60,value:this.state.message,onChange:this.onStatusChange}),r.a.createElement("div",{className:"mx_StatusMessageContextMenu_actionContainer"},e,t));return r.a.createElement("div",{className:"mx_StatusMessageContextMenu"},s)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(83),i=s.n(n),a=s(926),o=s(113),r=s(82),c=s.n(r),l=s(90),d=s(84),h=s(116),u=s(101),m=s(88),p=s(263),g=s(96);class v extends a.a{constructor(e){super(e),i()(this,"addOptionRef",Object(r.createRef)()),i()(this,"onQuestionChange",e=>{this.setState({question:e.target.value},()=>this.checkCanSubmit())}),i()(this,"onOptionChange",(e,t)=>{const s=Object(h.b)(this.state.options);s[e]=t.target.value,this.setState({options:s},()=>this.checkCanSubmit())}),i()(this,"onOptionRemove",e=>{const t=Object(h.b)(this.state.options);t.splice(e,1),this.setState({options:t},()=>this.checkCanSubmit())}),i()(this,"onOptionAdd",()=>{const e=Object(h.b)(this.state.options);e.push(""),this.setState({options:e},()=>{var e,t;null===(e=this.addOptionRef.current)||void 0===e||null===(t=e.scrollIntoView)||void 0===t||t.call(e)})}),this.state={title:Object(d.a)("Create poll"),actionLabel:Object(d.a)("Create Poll"),canSubmit:!1,question:"",options:Object(h.h)("",2),busy:!1}}checkCanSubmit(){this.setState({canSubmit:!this.state.busy&&this.state.question.trim().length>0&&this.state.options.filter(e=>e.trim().length>0).length>=2})}submit(){this.setState({busy:!0,canSubmit:!1}),this.matrixClient.sendEvent(this.props.room.roomId,p.c.name,Object(p.d)(this.state.question,this.state.options,p.a.name)).then(()=>this.props.onFinished(!0)).catch(e=>{console.error("Failed to post poll:",e),l.a.createTrackedDialog("Failed to post poll","",o.a,{title:Object(d.a)("Failed to post poll"),description:Object(d.a)("Sorry, the poll you tried to create was not posted."),button:Object(d.a)("Try again"),cancelButton:Object(d.a)("Cancel"),onFinished:e=>{e?this.setState({busy:!1,canSubmit:!0}):this.cancel()}})})}cancel(){this.props.onFinished(!1)}renderContent(){return c.a.createElement("div",{className:"mx_PollCreateDialog"},c.a.createElement("h2",null,Object(d.a)("What is your poll question or topic?")),c.a.createElement(u.a,{value:this.state.question,maxLength:340,label:Object(d.a)("Question or topic"),placeholder:Object(d.a)("Write something..."),onChange:this.onQuestionChange,usePlaceholderAsHint:!0,disabled:this.state.busy}),c.a.createElement("h2",null,Object(d.a)("Create options")),this.state.options.map((e,t)=>c.a.createElement("div",{key:"option_"+t,className:"mx_PollCreateDialog_option"},c.a.createElement(u.a,{value:e,maxLength:340,label:Object(d.a)("Option %(number)s",{number:t+1}),placeholder:Object(d.a)("Write an option"),onChange:e=>this.onOptionChange(t,e),usePlaceholderAsHint:!0,disabled:this.state.busy}),c.a.createElement(m.a,{onClick:()=>this.onOptionRemove(t),className:"mx_PollCreateDialog_removeOption",disabled:this.state.busy}))),c.a.createElement(m.a,{onClick:this.onOptionAdd,disabled:this.state.busy||this.state.options.length>=20,kind:"secondary",className:"mx_PollCreateDialog_addOption",inputRef:this.addOptionRef},Object(d.a)("Add option")),this.state.busy&&c.a.createElement("div",{className:"mx_PollCreateDialog_busy"},c.a.createElement(g.a,null)))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(86),c=s(108),l=s(98),d=s(357),h=s.n(d),u=s(84),m=s(88);class p extends o.a.PureComponent{constructor(e){super(e),i()(this,"onKeyDown",e=>{e.key===c.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.cancel())}),i()(this,"onCancel",()=>{this.cancel()}),i()(this,"onSubmit",e=>{e.stopPropagation(),e.preventDefault(),this.state.canSubmit&&this.submit()})}get matrixClient(){return r.a.get()}render(){return o.a.createElement(l.a.Provider,{value:this.matrixClient},o.a.createElement(h.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog","aria-labelledby":"mx_CompoundDialog_title","aria-describedby":"mx_CompoundDialog_content"},className:"mx_CompoundDialog mx_ScrollableBaseDialog"},o.a.createElement("div",{className:"mx_CompoundDialog_header"},o.a.createElement("h1",null,this.state.title),o.a.createElement(m.a,{onClick:this.onCancel,className:"mx_CompoundDialog_cancelButton","aria-label":Object(u.a)("Close dialog")})),o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_CompoundDialog_content"},this.renderContent()),o.a.createElement("div",{className:"mx_CompoundDialog_footer"},o.a.createElement(m.a,{onClick:this.onCancel,kind:"primary_outline"},Object(u.a)("Cancel")),o.a.createElement(m.a,{onClick:this.onSubmit,kind:"primary",disabled:!this.state.canSubmit,type:"submit",element:"button",className:"mx_Dialog_nonDialogButton"},this.state.actionLabel)))))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(83),i=s.n(n);class a{constructor(e){this.event=e,i()(this,"serializedParts",null),i()(this,"caret",null)}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(282),c=s(281),l=s(182),d=s(98),h=s(84),u=s(431),m=s(105),p=s(118),g=s(245),v=s(133),f=s(135),b=s(134);function y(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?y(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):y(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let S;!function(e){e[e.My=0]="My",e[e.All=1]="All"}(S||(S={}));const _=({label:e,description:t,onClick:s,isSelected:n})=>o.a.createElement(m.g,{active:n,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:s},o.a.createElement("span",null,e),o.a.createElement("span",null,t)),w=({filterOption:e,setFilterOption:t})=>{const[s,n,i,a]=Object(m.p)(),r=[{label:Object(h.a)("My threads"),description:Object(h.a)("Shows all threads you've participated in"),key:S.My},{label:Object(h.a)("All threads"),description:Object(h.a)("Shows all threads from current room"),key:S.All}],c=r.find(t=>t.key===e),l=r.map(e=>o.a.createElement(_,{key:e.key,label:e.label,description:e.description,onClick:()=>{t(e.key),a()},isSelected:e===c})),d=s?o.a.createElement(m.n,{top:0,right:25,onFinished:a,chevronFace:m.a.Top,mountAsChild:!0},l):null;return o.a.createElement("div",{className:"mx_ThreadPanel__header"},o.a.createElement("span",null,Object(h.a)("Threads")),o.a.createElement(u.a,{className:"mx_ThreadPanel_dropdown",inputRef:n,isExpanded:s,onClick:()=>s?a():i()},`${Object(h.a)("Show:")} ${c.label}`),d)},C=({filterOption:e,showAllThreadsCallback:t})=>o.a.createElement("aside",{className:"mx_ThreadPanel_empty"},o.a.createElement("div",{className:"mx_ThreadPanel_largeIcon"}),o.a.createElement("h2",null,Object(h.a)("Keep discussions organised with threads")),o.a.createElement("p",null,Object(h.a)('Threads help you keep conversations on-topic and easily track them over time. Create the first one by using the "Reply in thread" button on a message.')),o.a.createElement("p",null,e===S.My?o.a.createElement("button",{onClick:t},Object(h.a)("Show all threads")):o.a.createElement(o.a.Fragment,null," ")));t.a=({roomId:e,onClose:t,permalinkCreator:s})=>{const n=Object(a.useContext)(d.a),i=Object(a.useContext)(p.b),h=n.getRoom(e),[u,m]=Object(a.useState)(S.All),y=Object(a.useRef)(),_=(({threads:e,room:t,filterOption:s,userId:n,updateTimeline:i})=>{const o=Object(a.useMemo)(()=>new c.b(null,{timelineSupport:!0,unstableClientRelationAggregation:!0,pendingEvents:!1}),[]),l=Object(a.useCallback)((function(t){t.resetLiveTimeline(""),Array.from(e).forEach(([,e])=>{(s!==S.My||e.hasCurrentUserParticipated)&&t.addLiveEvent(e.rootEvent)}),i()}),[s,e,i]);return Object(a.useEffect)(()=>{l(o)},[o,l]),Object(f.a)(t,r.b.Update,()=>{l(o)}),Object(f.a)(t,r.b.New,()=>{l(o)}),o})({threads:h.threads,room:h,filterOption:u,userId:n.getUserId(),updateTimeline:()=>{var e;return null===(e=y.current)||void 0===e?void 0:e.refreshTimeline()}});return o.a.createElement(p.b.Provider,{value:E(E({},i),{},{timelineRenderingType:p.a.ThreadsList,liveTimeline:_.getLiveTimeline(),showHiddenEventsInTimeline:!0})},o.a.createElement(l.b,{header:o.a.createElement(w,{filterOption:u,setFilterOption:m}),className:"mx_ThreadPanel",onClose:t,withoutScrollContainer:!0},o.a.createElement(g.a,{ref:y,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:_,showUrlPreview:!0,empty:o.a.createElement(C,{filterOption:u,showAllThreadsCallback:()=>m(S.All)}),alwaysShowTimestamps:!0,layout:v.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel mx_GroupLayout",membersLoaded:!0,permalinkCreator:s,tileShape:b.a.ThreadPanel,disableGrouping:!0})))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(86),u=s(182),m=s(85),p=s(245),g=s(96),v=s(134),f=s(133),b=s(118),y=s(1);function E(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function S(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?E(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):E(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let _=Object(m.a)("structures.NotificationPanel")((a=i=class extends l.a.PureComponent{render(){const e=l.a.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},l.a.createElement("h2",null,Object(d.a)("You're all caught up")),l.a.createElement("p",null,Object(d.a)("You have no visible notifications.")));let t;const s=h.a.get().getNotifTimelineSet();return s?t=l.a.createElement(p.a,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:s,showUrlPreview:!1,tileShape:v.a.Notif,empty:e,alwaysShowTimestamps:!0,layout:f.a.Group}):(y.a.error("No notifTimelineSet available!"),t=l.a.createElement(g.a,null)),l.a.createElement(b.b.Provider,{value:S(S({},this.context),{},{timelineRenderingType:b.a.Notification})},l.a.createElement(u.b,{className:"mx_NotificationPanel",onClose:this.props.onClose,withoutScrollContainer:!0},t))}},r()(i,"contextType",b.b),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(182),h=s(403),u=s(133),m=s(245),p=s(118),g=s(84),v=s(85);let f=Object(v.a)("structures.TimelineCard")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"renderTimelineCardHeader",()=>l.a.createElement("div",{className:"mx_TimelineCard__header"},l.a.createElement("span",null,Object(g.a)("Chat")))),this.state={}}render(){var e;return l.a.createElement(d.b,{className:"mx_ThreadPanel mx_TimelineCard",onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderTimelineCardHeader()},l.a.createElement(m.a,{showReadReceipts:!1,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.room.getUnfilteredTimelineSet(),showUrlPreview:!0,layout:u.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel mx_GroupLayout",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId(),resizeNotifier:this.props.resizeNotifier}),l.a.createElement(h.a,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0}))}},r()(i,"contextType",p.b),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return I}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(94),h=s(86),u=s(87),m=s(91),p=s.n(m),g=s(84),v=s(93),f=s(210),b=s(193),y=s(123),E=s(85),S=s(932),_=s(96),w=s(88),C=s(115),O=s(89),k=s(126);var R;!function(e){e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError"}(R||(R={}));let I=Object(E.a)("views.rooms.RoomPreviewBar")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onCommunityUpdate",e=>{this.props.room&&this.props.room.roomId!==e||this.forceUpdate()}),r()(this,"onLoginClick",()=>{u.a.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})}),r()(this,"onRegisterClick",()=>{u.a.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})}),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail(),b.a.instance.on(y.b,this.onCommunityUpdate)}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}componentWillUnmount(){b.a.instance.off(y.b,this.onCommunityUpdate)}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await h.a.get().getThreePids();if(this.setState({accountEmails:e.threepids.filter(e=>"email"===e.medium).map(e=>e.address)}),!h.a.get().getIdentityServerUrl())return void this.setState({busy:!1});const t=new f.a,s=await t.getAccessToken(),n=await h.a.get().lookupThreePid("email",this.props.invitedEmail,void 0,s);this.setState({invitedEmailMxid:n.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(h.a.get().isGuest())return R.NotLoggedIn;const e=this.getMyMember();if(e){if(e.isKicked())return R.Kicked;if("ban"===e.membership)return R.Banned}if(this.props.joining)return R.Joining;if(this.props.rejecting)return R.Rejecting;if(this.props.loading||this.state.busy)return R.Loading;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return R.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return R.InvitedEmailNotFoundInAccount;if(!h.a.get().getIdentityServerUrl())return R.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=h.a.get().getUserId())return R.InvitedEmailMismatch}return R.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?R.RoomNotFound:R.OtherError:R.ViewingRoom}getKickOrBanInfo(){const e=this.getMyMember();if(!e)return{};const t=this.props.room.currentState.getMember(e.events.member.getSender());return{memberName:t?t.name:e.events.member.getSender(),reason:e.events.member.getContent().reason}}joinRule(){var e,t;return null===(e=this.props.room)||void 0===e||null===(t=e.currentState.getStateEvents(d.a.RoomJoinRules,""))||void 0===t?void 0:t.getContent().join_rule}communityProfile(){return this.props.room?b.a.instance.getInviteProfile(this.props.room.roomId):{displayName:null,avatarMxc:null}}roomName(e=!1){let t=this.props.room?this.props.room.name:this.props.roomAlias;const s=this.communityProfile();return s.displayName&&(t=s.displayName),t||(e?Object(g.a)("This room"):Object(g.a)("this room"))}getMyMember(){var e;return null===(e=this.props.room)||void 0===e?void 0:e.getMember(h.a.get().getUserId())}getInviteMember(){const{room:e}=this.props;if(!e)return;const t=h.a.get().getUserId(),s=e.currentState.getMember(t);if(!s)return;const n=s.events.member.getSender();return e.currentState.getMember(n)}isDMInvite(){const e=this.getMyMember();if(!e)return!1;const t=e.events.member.getContent();return"invite"===t.membership&&t.is_direct}makeScreenAfterLogin(){return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:this.props.oobData?this.props.oobData.room_name:null,room_avatar_url:this.props.oobData?this.props.oobData.avatarUrl:null,inviter_name:this.props.oobData?this.props.oobData.inviterName:null}}}render(){const e=v.a.get().brand;let t,s,n,i,a,o,r,c,u=!1;const m=[],f=this.getMessageCase();switch(f){case R.Joining:var b;t=(null===(b=this.props.oobData)||void 0===b?void 0:b.roomType)===d.e.Space?Object(g.a)("Joining space …"):Object(g.a)("Joining room …"),u=!0;break;case R.Loading:t=Object(g.a)("Loading …"),u=!0;break;case R.Rejecting:t=Object(g.a)("Rejecting invite …"),u=!0;break;case R.NotLoggedIn:t=Object(g.a)("Join the conversation with an account"),O.b.getValue(C.b.Registration)&&(a=Object(g.a)("Sign Up"),i=this.onRegisterClick),r=Object(g.a)("Sign In"),o=this.onLoginClick,this.props.previewLoading&&(c=l.a.createElement("div",null,l.a.createElement(_.a,{w:20,h:20}),Object(g.a)("Loading room preview")));break;case R.Kicked:{const{memberName:e,reason:n}=this.getKickOrBanInfo();t=Object(g.a)("You were kicked from %(roomName)s by %(memberName)s",{memberName:e,roomName:this.roomName()}),s=n?Object(g.a)("Reason: %(reason)s",{reason:n}):null,"invite"===this.joinRule()?(a=Object(g.a)("Forget this room"),i=this.props.onForgetClick):(a=Object(g.a)("Re-join"),i=this.props.onJoinClick,r=Object(g.a)("Forget this room"),o=this.props.onForgetClick);break}case R.Banned:{const{memberName:e,reason:n}=this.getKickOrBanInfo();t=Object(g.a)("You were banned from %(roomName)s by %(memberName)s",{memberName:e,roomName:this.roomName()}),s=n?Object(g.a)("Reason: %(reason)s",{reason:n}):null,a=Object(g.a)("Forget this room"),i=this.props.onForgetClick;break}case R.OtherThreePIDError:{t=Object(g.a)("Something went wrong with your invite to %(roomName)s",{roomName:this.roomName()});const e=this.joinRule(),n=Object(g.a)("An error (%(errcode)s) was returned while trying to validate your invite. You could try to pass this information on to a room admin.",{errcode:this.state.threePidFetchError.errcode||Object(g.a)("unknown error code")});switch(e){case"invite":s=[Object(g.a)("You can only join it with a working invite."),n],a=Object(g.a)("Try to join anyway"),i=this.props.onJoinClick;break;case"public":s=Object(g.a)("You can still join it because this is a public room."),a=Object(g.a)("Join the discussion"),i=this.props.onJoinClick;break;default:s=n,a=Object(g.a)("Try to join anyway"),i=this.props.onJoinClick}break}case R.InvitedEmailNotFoundInAccount:t=Object(g.a)("This invite to %(roomName)s was sent to %(email)s which is not associated with your account",{roomName:this.roomName(),email:this.props.invitedEmail}),s=Object(g.a)("Link this email with your account in Settings to receive invites directly in %(brand)s.",{brand:e}),a=Object(g.a)("Join the discussion"),i=this.props.onJoinClick;break;case R.InvitedEmailNoIdentityServer:t=Object(g.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this.roomName(),email:this.props.invitedEmail}),s=Object(g.a)("Use an identity server in Settings to receive invites directly in %(brand)s.",{brand:e}),a=Object(g.a)("Join the discussion"),i=this.props.onJoinClick;break;case R.InvitedEmailMismatch:t=Object(g.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this.roomName(),email:this.props.invitedEmail}),s=Object(g.a)("Share this email in Settings to receive invites directly in %(brand)s.",{brand:e}),a=Object(g.a)("Join the discussion"),i=this.props.onJoinClick;break;case R.Invite:{const e=Object.assign({},this.props.oobData,{avatarUrl:this.communityProfile().avatarMxc}),c=l.a.createElement(k.a,{room:this.props.room,oobData:e}),d=this.getInviteMember();let u;u=d?l.a.createElement("span",null,l.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},d.rawDisplayName)," (",d.userId,")"):l.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName);this.isDMInvite()?(t=Object(g.a)("Do you want to chat with %(user)s?",{user:d.name}),s=[c,Object(g.a)("<userName/> wants to chat",{},{userName:()=>u})],a=Object(g.a)("Start chatting")):(t=Object(g.a)("Do you want to join %(roomName)s?",{roomName:this.roomName()}),s=[c,Object(g.a)("<userName/> invited you",{},{userName:()=>u})],a=Object(g.a)("Accept"));const p=h.a.get().getUserId(),v=this.props.room.currentState.getMember(p).events.member.getContent();v.reason&&(n=l.a.createElement(S.a,{reason:v.reason,htmlReason:v["io.element.html_reason"]})),i=this.props.onJoinClick,r=Object(g.a)("Reject"),o=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&m.push(l.a.createElement(w.a,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},Object(g.a)("Reject & Ignore user")));break}case R.ViewingRoom:t=this.props.canPreview?Object(g.a)("You're previewing %(roomName)s. Want to join it?",{roomName:this.roomName()}):Object(g.a)("%(roomName)s can't be previewed. Do you want to join it?",{roomName:this.roomName(!0)}),a=Object(g.a)("Join the discussion"),i=this.props.onJoinClick;break;case R.RoomNotFound:t=Object(g.a)("%(roomName)s does not exist.",{roomName:this.roomName(!0)}),s=Object(g.a)("This room doesn't exist. Are you sure you're at the right place?");break;case R.OtherError:t=Object(g.a)("%(roomName)s is not accessible at this time.",{roomName:this.roomName(!0)}),s=[Object(g.a)("Try again later, or ask a room admin to check if you have access."),Object(g.a)("%(errcode)s was returned while trying to access the room. If you think you're seeing this message in error, please <issueLink>submit a bug report</issueLink>.",{errcode:this.props.error.errcode},{issueLink:e=>l.a.createElement("a",{href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose",target:"_blank",rel:"noreferrer noopener"},e)})]}let y,E,I,x;s&&(Array.isArray(s)||(s=[s]),y=s.map((e,t)=>l.a.createElement("p",{key:"subTitle"+t},e))),E=u?l.a.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},l.a.createElement(_.a,null),t):l.a.createElement("h3",null,t),i&&(I=l.a.createElement(w.a,{kind:"primary",onClick:i},a)),o&&(x=l.a.createElement(w.a,{kind:"secondary",onClick:o},r));const T=p()("mx_RoomPreviewBar","dark-panel","mx_RoomPreviewBar_"+f,{mx_RoomPreviewBar_panel:this.props.canPreview,mx_RoomPreviewBar_dialog:!this.props.canPreview});return l.a.createElement("div",{className:T},l.a.createElement("div",{className:"mx_RoomPreviewBar_message"},E,y),n,l.a.createElement("div",{className:"mx_RoomPreviewBar_actions"},x,m,I),l.a.createElement("div",{className:"mx_RoomPreviewBar_footer"},c))}},r()(i,"defaultProps",{onJoinClick(){}}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(91),r=s.n(o),c=s(82),l=s.n(c),d=s(138),h=s(84),u=s(85);let m=Object(u.a)("views.elements.InviteReason")(n=class extends l.a.PureComponent{constructor(e){super(e),a()(this,"onViewClick",()=>{this.setState({hidden:!1})}),this.state={hidden:!0}}render(){const e=r()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return l.a.createElement("div",{className:e},l.a.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?Object(d.h)(this.props.htmlReason):this.props.reason),l.a.createElement("div",{className:"mx_InviteReason_view",onClick:this.onViewClick},Object(h.a)("View message")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(88),l=s(91),d=s.n(l),h=s(84),u=s(108),m=s(444),p=s(85);let g;!function(e){e.Room="Room",e.All="All"}(g||(g={}));let v=Object(p.a)("views.rooms.SearchBar")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"searchTerm",Object(o.createRef)()),a()(this,"onThisRoomClick",()=>{this.setState({scope:g.Room},()=>this.searchIfQuery())}),a()(this,"onAllRoomsClick",()=>{this.setState({scope:g.All},()=>this.searchIfQuery())}),a()(this,"onSearchChange",e=>{switch(e.key){case u.a.ENTER:this.onSearch();break;case u.a.ESCAPE:this.props.onCancelClick()}}),a()(this,"onSearch",()=>{this.props.onSearch(this.searchTerm.current.value,this.state.scope)}),this.state={scope:g.Room}}searchIfQuery(){this.searchTerm.current.value&&this.onSearch()}render(){const e=d()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=d()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==g.Room}),s=d()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==g.All});return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SearchBar"},r.a.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},r.a.createElement(c.a,{className:t,onClick:this.onThisRoomClick,"aria-checked":this.state.scope===g.Room,role:"radio"},Object(h.a)("This Room")),r.a.createElement(c.a,{className:s,onClick:this.onAllRoomsClick,"aria-checked":this.state.scope===g.All,role:"radio"},Object(h.a)("All Rooms"))),r.a.createElement("div",{className:"mx_SearchBar_input mx_textinput"},r.a.createElement("input",{ref:this.searchTerm,type:"text",autoFocus:!0,placeholder:Object(h.a)("Search…"),onKeyDown:this.onSearchChange}),r.a.createElement(c.a,{className:e,onClick:this.onSearch})),r.a.createElement(c.a,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick})),r.a.createElement(m.b,{isRoomEncrypted:this.props.isRoomEncrypted,kind:m.a.Search}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(90),h=s(84),u=s(85),m=s(536),p=s(88),g=s(98);let v=Object(u.a)("views.rooms.RoomUpgradeWarningBar")((a=i=class extends l.a.PureComponent{constructor(e,t){super(e,t),r()(this,"context",void 0),r()(this,"onStateEvents",(e,t)=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const s=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:s&&s.getContent().replacement_room})}),r()(this,"onUpgradeClick",()=>{d.a.createTrackedDialog("Upgrade Room Version","",m.a,{room:this.props.room})});const s=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==s?void 0:s.getContent().replacement_room}}componentDidMount(){this.context.on("RoomState.events",this.onStateEvents)}componentWillUnmount(){this.context.removeListener("RoomState.events",this.onStateEvents)}render(){let e=l.a.createElement("div",null,l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},l.a.createElement("p",null,Object(h.a)("Upgrading this room will shut down the current instance of the room and create an upgraded room with the same name.")),l.a.createElement("p",null,Object(h.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>l.a.createElement("b",null,e),i:e=>l.a.createElement("i",null,e)}))),l.a.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},l.a.createElement(p.a,{onClick:this.onUpgradeClick},Object(h.a)("Upgrade this room to the recommended room version"))));return this.state.upgraded&&(e=l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},l.a.createElement("p",null,Object(h.a)("This room has already been upgraded.")))),l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar"},l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},Object(h.a)("This room is running room version <roomVersion />, which this homeserver has marked as <i>unstable</i>.",{},{roomVersion:()=>l.a.createElement("code",null,this.props.room.getVersion()),i:e=>l.a.createElement("i",null,e)})),e,l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},Object(h.a)("Only room administrators will see this warning"))))}},r()(i,"contextType",g.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(4),h=s(86),u=s(577),m=s(89),p=s(128),g=s(115),v=s(936),f=s(144),b=s(85),y=s(112);let E=Object(b.a)("views.rooms.AuxPanel")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"rateLimitedUpdate",Object(y.throttle)(()=>{this.setState({counters:this.computeCounters()})},500,{leading:!0,trailing:!0})),this.state={counters:this.computeCounters()}}componentDidMount(){const e=h.a.get();m.b.getValue("feature_state_counters")&&e.on("RoomState.events",this.rateLimitedUpdate)}componentWillUnmount(){const e=h.a.get();e&&m.b.getValue("feature_state_counters")&&e.removeListener("RoomState.events",this.rateLimitedUpdate)}shouldComponentUpdate(e,t){return Object(f.d)(this.props,e)||Object(f.d)(this.state,t)}componentDidUpdate(e,t){this.props.onResize&&this.props.onResize()}computeCounters(){const e=[];if(this.props.room&&m.b.getValue("feature_state_counters")){const t=this.props.room.currentState.getStateEvents("re.jki.counter");t.sort((e,t)=>Object(d.x)(e.getStateKey(),t.getStateKey()));for(const s of t){const t=s.getContent().title,n=s.getContent().value,i=s.getContent().link,a=s.getContent().severity||"normal",o=s.getStateKey();t&&void 0!==n&&e.push({title:t,value:n,link:i,severity:a,stateKey:o})}}return e}render(){const e=l.a.createElement(v.a,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;m.b.getValue(g.b.Widgets)&&(t=l.a.createElement(u.a,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier}));let s=null;if(this.state.counters&&m.b.getValue("feature_state_counters")){const e=[];this.state.counters.forEach((t,s)=>{const n=t.title,i=t.value,a=t.link,o=t.severity,r=t.stateKey;let c=l.a.createElement("span",null,n,": ",i);a&&(c=l.a.createElement("a",{href:a,target:"_blank",rel:"noreferrer noopener"},c)),c=l.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_span","data-severity":o,key:"x-"+r},c),e.push(c),e.push(l.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_delim",key:"delim"+s}," ─ "))}),e.length>0&&(e.pop(),s=l.a.createElement("div",{className:"m_RoomView_auxPanel_stateViews"},e))}return l.a.createElement(p.a,{className:"mx_RoomView_auxPanel"},s,this.props.children,t,e)}},r()(i,"defaultProps",{showApps:!0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(163),r=s(82),c=s.n(r),l=s(151),d=s(559),h=s(87),u=s(319),m=s(85);let p=Object(m.a)("views.voip.CallViewForRoom")(n=class extends c.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"onAction",e=>{switch(e.action){case"call_state":this.updateCall()}}),a()(this,"updateCall",()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})}),a()(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),a()(this,"onResize",()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),a()(this,"onResizeStop",()=>{this.props.resizeNotifier.stopResizing()}),this.state={call:this.getCall()}}componentDidMount(){this.dispatcherRef=h.a.register(this.onAction),l.d.sharedInstance().addListener(l.a.CallChangeRoom,this.updateCall)}componentWillUnmount(){h.a.unregister(this.dispatcherRef),l.d.sharedInstance().removeListener(l.a.CallChangeRoom,this.updateCall)}getCall(){const e=l.d.sharedInstance().getCallForRoom(this.props.roomId);return e&&[o.e.Ended,o.e.Ringing].includes(e.state)?null:e}render(){return this.state.call?c.a.createElement("div",{className:"mx_CallViewForRoom"},c.a.createElement(u.Resizable,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_CallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_CallViewForRoom_ResizeHandle"}},c.a.createElement(d.a,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return P}));var n,i,a,o=s(95),r=s.n(o),c=s(83),l=s.n(c),d=s(82),h=s.n(d),u=s(91),m=s.n(u),p=s(84),g=s(86),v=s(89),f=s(938),b=s(215),y=s(284),E=s(111),S=s(386),_=s(219),w=s(151),C=s(85),O=s(90),k=s(166),R=s(112),I=s(105),x=s(939),T=s(519),j=s(173),N=s(213);let P=Object(C.a)("views.rooms.RoomHeader")((a=i=class extends h.a.Component{constructor(e,t){super(e,t),l()(this,"onRoomStateEvents",(e,t)=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this.rateLimitedUpdate()}),l()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),l()(this,"rateLimitedUpdate",Object(R.throttle)(()=>{this.forceUpdate()},500,{leading:!0,trailing:!0})),l()(this,"onContextMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),l()(this,"onContextMenuCloseClick",()=>{this.setState({contextMenuPosition:null})});j.a.instance.getRoomState(e.room).on(N.a,this.onNotificationUpdate),this.state={}}componentDidMount(){g.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=g.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents);j.a.instance.getRoomState(this.props.room).removeListener(N.a,this.onNotificationUpdate)}displayInfoDialogAboutScreensharing(){O.a.createDialog(k.a,{title:Object(p.a)("Screen sharing is here!"),description:Object(p.a)('You can now share your screen by pressing the "screen share" button during a call. You can even do this in audio calls if both sides support it!')})}render(){let e=null;this.props.searchInfo&&void 0!==this.props.searchInfo.searchCount&&null!==this.props.searchInfo.searchCount&&(e=h.a.createElement("div",{className:"mx_RoomHeader_searchStatus"}," ",Object(p.a)("(~%(count)s results)",{count:this.props.searchInfo.searchCount})));let t=!1;const s=this.props.room?this.props.room.getJoinedMembers():void 0;if(s&&1===s.length&&s[0].userId===g.a.get().credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(t=!0)}let n,i=Object(p.a)("Join Room");this.props.oobData&&this.props.oobData.name&&(i=this.props.oobData.name),this.state.contextMenuPosition&&this.props.room&&(n=h.a.createElement(x.a,r()({},Object(T.a)(this.state.contextMenuPosition),{room:this.props.room,onFinished:this.onContextMenuCloseClick})));const a=m()("mx_RoomHeader_nametext",{mx_RoomHeader_settingsHint:t}),o=h.a.createElement(I.c,{className:"mx_RoomHeader_name",onClick:this.onContextMenuOpenClick,isExpanded:!!this.state.contextMenuPosition,title:Object(p.a)("Room options")},h.a.createElement(_.a,{room:this.props.room},e=>{const t=e||i;return h.a.createElement("div",{dir:"auto",className:a,title:t},t)}),this.props.room&&h.a.createElement("div",{className:"mx_RoomHeader_chevron"}),n),c=h.a.createElement(S.a,{room:this.props.room},(e,t)=>h.a.createElement("div",{className:"mx_RoomHeader_topic",ref:t,title:e,dir:"auto"},e));let l;this.props.room&&(l=h.a.createElement(y.a,{room:this.props.room,avatarSize:24,oobData:this.props.oobData,viewAvatarOnClick:!0}));const d=[];if(this.props.inRoom&&v.b.getValue("showCallButtonsInComposer")){const e=h.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_voiceCallButton",onClick:()=>this.props.onCallPlaced(w.b.Voice),title:Object(p.a)("Voice call"),key:"voice"}),t=h.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_videoCallButton",onClick:e=>e.shiftKey?this.displayInfoDialogAboutScreensharing():this.props.onCallPlaced(w.b.Video),title:Object(p.a)("Video call"),key:"video"});d.push(e,t)}if(this.props.onForgetClick){const e=h.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_forgetButton",onClick:this.props.onForgetClick,title:Object(p.a)("Forget room"),key:"forget"});d.push(e)}if(this.props.onAppsClick){const e=h.a.createElement(E.a,{className:m()("mx_RoomHeader_button mx_RoomHeader_appsButton",{mx_RoomHeader_appsButton_highlight:this.props.appsShown}),onClick:this.props.onAppsClick,title:this.props.appsShown?Object(p.a)("Hide Widgets"):Object(p.a)("Show Widgets"),key:"apps"});d.push(e)}if(this.props.onSearchClick&&this.props.inRoom){const e=h.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_searchButton",onClick:this.props.onSearchClick,title:Object(p.a)("Search"),key:"search"});d.push(e)}const u=h.a.createElement("div",{className:"mx_RoomHeader_buttons"},d),C=this.props.e2eStatus?h.a.createElement(b.b,{status:this.props.e2eStatus}):void 0;return h.a.createElement("div",{className:"mx_RoomHeader light-panel"},h.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":"mx_RightPanel"},h.a.createElement("div",{className:"mx_RoomHeader_avatar"},l),h.a.createElement("div",{className:"mx_RoomHeader_e2eIcon"},C),o,e,c,u,h.a.createElement(f.a,{room:this.props.room,excludedRightPanelPhaseButtons:this.props.excludedRightPanelPhaseButtons})))}},l()(i,"defaultProps",{editing:!1,inRoom:!1,excludedRightPanelPhaseButtons:[]}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return I}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(578),u=s(579),m=s(122),p=s(92),g=s(244),v=s(85),f=s(236),b=s(417),y=s(318),E=s(89),S=s(87),_=s(173),w=s(184);const C=[m.c.RoomSummary,m.c.Widget,m.c.FilePanel,m.c.RoomMemberList,m.c.RoomMemberInfo,m.c.EncryptionPanel,m.c.Room3pidMemberInfo],O=({className:e})=>l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_RightPanel_headerButton_unreadIndicator_bg"}),l.a.createElement("div",{className:e})),k=({room:e,isHighlighted:t,onClick:s})=>{const n=Object(f.b)("feature_pinning"),i=Object(b.c)(n&&e),a=Object(b.d)(n&&e);if(!n)return null;let o;return i.some(e=>!a.has(e))&&(o=l.a.createElement(O,{className:"mx_RightPanel_headerButton_unreadIndicator"})),l.a.createElement(h.a,{name:"pinnedMessagesButton",title:Object(d.a)("Pinned messages"),isHighlighted:t,onClick:s,analytics:["Right Panel","Pinned Messages Button","click"]},o)},R=({room:e,isHighlighted:t,onClick:s})=>{if(!E.b.getValue("feature_maximised_widgets"))return null;let n;switch(_.a.instance.getRoomState(e).color){case w.a.Grey:n=l.a.createElement(O,{className:"mx_RightPanel_headerButton_unreadIndicator mx_Indicator_gray"});break;case w.a.Red:n=l.a.createElement(O,{className:"mx_RightPanel_headerButton_unreadIndicator"})}return l.a.createElement(h.a,{name:"timelineCardButton",title:Object(d.a)("Chat"),isHighlighted:t,onClick:s,analytics:["Right Panel","Timeline Panel Button","click"]},n)};let I=Object(v.a)("views.right_panel.RoomHeaderButtons")((a=i=class e extends u.b{constructor(t){super(t,u.a.Room),r()(this,"onRoomSummaryClicked",()=>{const e=g.a.getSharedInstance().roomPanelPhase;C.includes(e)?this.state.phase===e?this.setPhase(e):this.setPhase(e,g.a.getSharedInstance().roomPanelPhaseParams):this.setPhase(m.c.RoomSummary)}),r()(this,"onNotificationsClicked",()=>{this.setPhase(m.c.NotificationPanel)}),r()(this,"onPinnedMessagesClicked",()=>{this.setPhase(m.c.PinnedMessages)}),r()(this,"onTimelineCardClicked",()=>{this.setPhase(m.c.Timeline)}),r()(this,"onThreadsPanelClicked",()=>{e.THREAD_PHASES.includes(this.state.phase)?S.a.dispatch({action:p.a.ToggleRightPanel,type:"room"}):Object(y.b)()})}onAction(e){e.action===p.a.ViewUser?e.member?this.setPhase(m.c.RoomMemberInfo,{member:e.member}):this.setPhase(m.c.RoomMemberList):"view_3pid_invite"===e.action&&(e.event?this.setPhase(m.c.Room3pidMemberInfo,{event:e.event}):this.setPhase(m.c.RoomMemberList))}renderButtons(){const t=new Map;return t.set(m.c.PinnedMessages,l.a.createElement(k,{room:this.props.room,isHighlighted:this.isPhase(m.c.PinnedMessages),onClick:this.onPinnedMessagesClicked})),t.set(m.c.Timeline,l.a.createElement(R,{room:this.props.room,isHighlighted:this.isPhase(m.c.Timeline),onClick:this.onTimelineCardClicked})),t.set(m.c.ThreadPanel,E.b.getValue("feature_thread")?l.a.createElement(h.a,{name:"threadsButton",title:Object(d.a)("Threads"),onClick:this.onThreadsPanelClicked,isHighlighted:this.isPhase(e.THREAD_PHASES),analytics:["Right Panel","Threads List Button","click"]}):null),t.set(m.c.NotificationPanel,l.a.createElement(h.a,{name:"notifsButton",title:Object(d.a)("Notifications"),isHighlighted:this.isPhase(m.c.NotificationPanel),onClick:this.onNotificationsClicked,analytics:["Right Panel","Notification List Button","click"]})),t.set(m.c.RoomSummary,l.a.createElement(h.a,{name:"roomSummaryButton",title:Object(d.a)("Room Info"),isHighlighted:this.isPhase(C),onClick:this.onRoomSummaryClicked,analytics:["Right Panel","Room Summary Button","click"]})),l.a.createElement(l.a.Fragment,null,Array.from(t.keys()).map(e=>this.props.excludedRightPanelPhaseButtons.includes(e)?null:t.get(e)))}},r()(i,"THREAD_PHASES",[m.c.ThreadPanel,m.c.ThreadView]),n=a))||n},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(1),d=s(168),h=s(84),u=s(98),m=s(147),p=s(165),g=s(87),v=s(769),f=s(108),b=s(520),y=s(258),E=s(90),S=s(595),_=s(400),w=s(132),C=s(92),O=s(122),k=s(325),R=s(135);const I=["room","onFinished"];t.a=e=>{let{room:t,onFinished:s}=e,n=o()(e,I);const a=Object(r.useContext)(u.a),x=Object(R.b)(p.b.instance,p.a,()=>p.b.instance.getTagsForRoom(t));let T,j,N,P,D;if(x.includes(m.a.Archived)){const e=e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"forget_room",room_id:t.roomId}),s()};T=c.a.createElement(d.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(h.a)("Forget"),className:"mx_IconizedContextMenu_option_red",onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"leave_room",room_id:t.roomId}),s()};T=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Leave"),className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_RoomTile_iconSignOut"})}if(t.canInvite(a.getUserId())){const e=e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"view_invite",roomId:t.roomId}),s()};j=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Invite"),iconClassName:"mx_RoomTile_iconInvite"})}if("join"===t.getMyMembership()){const e=x.includes(m.a.Favourite);N=c.a.createElement(d.a,{onClick:e=>M(e,m.a.Favourite),active:e,label:e?Object(h.a)("Favourited"):Object(h.a)("Favourite"),iconClassName:"mx_RoomTile_iconStar"});const n=x.includes(m.a.LowPriority);P=c.a.createElement(d.a,{onClick:e=>M(e,m.a.LowPriority),active:n,label:Object(h.a)("Low priority"),iconClassName:"mx_RoomTile_iconArrowDown"});let i,a;switch(b.a.forRoom(t).notificationVolume){case y.a.AllMessages:i=Object(h.a)("Default"),a="mx_RoomTile_iconNotificationsDefault";break;case y.a.AllMessagesLoud:i=Object(h.a)("All messages"),a="mx_RoomTile_iconNotificationsAllMessages";break;case y.a.MentionsOnly:i=Object(h.a)("Mentions only"),a="mx_RoomTile_iconNotificationsMentionsKeywords";break;case y.a.Mute:i=Object(h.a)("Mute"),a="mx_RoomTile_iconNotificationsNone"}D=c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"open_room_settings",room_id:t.roomId,initial_tab_id:k.a}),s()},label:Object(h.a)("Notifications"),iconClassName:a},c.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},i))}const M=(e,n)=>{if(e.preventDefault(),e.stopPropagation(),n===m.a.Favourite||n===m.a.LowPriority){const e=n===m.a.Favourite?m.a.LowPriority:m.a.Favourite,s=p.b.instance.getTagsForRoom(t).includes(n),i=s?n:e,o=s?null:n;g.a.dispatch(v.a.tagRoom(a,t,i,o,void 0,0))}else l.a.warn(`Unexpected tag ${n} applied to ${t.roomId}`);e.key===f.a.ENTER&&s()},A=()=>{w.a.getRoomId()!==t.roomId&&g.a.dispatch({action:"view_room",room_id:t.roomId},!0)};return c.a.createElement(d.e,i()({},n,{onFinished:s,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(d.c,null,j,D,N,c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),A(),Object(_.c)(!1),s()},label:Object(h.a)("People"),iconClassName:"mx_RoomTile_iconPeople"},c.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},t.getJoinedMemberCount())),c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),A(),Object(_.b)(!1),s()},label:Object(h.a)("Files"),iconClassName:"mx_RoomTile_iconFiles"}),c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),A(),g.a.dispatch({action:C.a.SetRightPanelPhase,phase:O.c.RoomSummary,allowClose:!1}),s()},label:Object(h.a)("Widgets"),iconClassName:"mx_RoomTile_iconWidgets"}),P,c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"copy_room",room_id:t.roomId}),s()},label:Object(h.a)("Copy link"),iconClassName:"mx_RoomTile_iconCopyLink"}),c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"open_room_settings",room_id:t.roomId}),s()},label:Object(h.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"}),c.a.createElement(d.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),E.a.createTrackedDialog("Export room dialog","",S.a,{room:t}),s()},label:Object(h.a)("Export chat"),iconClassName:"mx_RoomTile_iconExport"}),T))}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(87),o=s(220),r=s(139),c=s(1);t.a=({roomWidth:e})=>{const t=Object(n.useRef)(null),l=Object(n.useRef)(new Map);return Object(n.useEffect)(()=>{const e=()=>{var e;t.current&&(null===(e=t.current)||void 0===e?void 0:e.height)!==r.b.instance.windowHeight&&(t.current.height=r.b.instance.windowHeight)},n=a.a.register(e=>{if(0===e.action.indexOf("effects.")){(async e=>{if(!e)return null;let t=l.current[e]||null;if(null===t){var n;const i=null===(n=o.CHAT_EFFECTS.find(t=>t.command===e))||void 0===n?void 0:n.options;try{const{default:n}=await s(1610)("./"+e);t=new n(i),l.current[e]=t}catch(t){c.a.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.substr("effects.".length)).then(e=>null==e?void 0:e.start(t.current))}});return t.current.height=r.b.instance.windowHeight,r.b.instance.on(r.a.Resize,e),()=>{a.a.unregister(n),r.b.instance.off(r.a.Resize,e);const t=l.current;for(const e in t){const s=t[e];s&&s.isRunning&&s.stop()}}},[]),i.a.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0}})}},function(e,t,s){"use strict";var n=s(95),i=s.n(n),a=s(102),o=s.n(a),r=s(82),c=s.n(r),l=s(112),d=s(142),h=s(84),u=s(130),m=s(177),p=s(566),g=s(98);const v=["room","onlyKnownUsers","numShown"],f=5,b=e=>{var t;return!(null===(t=u.a.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)};t.a=e=>{let{room:t,onlyKnownUsers:s=!0,numShown:n=f}=e,a=o()(e,v);const u=Object(r.useContext)(g.a);let y=Object(p.b)(t);const E=[e=>!!e.getMxcAvatarUrl()];s?y=y.filter(b):E.unshift(e=>b(e));const S=Object(l.sortBy)(y.filter(e=>e.userId!==u.getUserId()),E).slice(0,n);if(S.length<1)return null;const _=S.map(e=>e.rawDisplayName).reverse().join(", ");let w;return w=a.onClick?c.a.createElement("div",null,c.a.createElement("div",{className:"mx_Tooltip_title"},Object(h.a)("View all %(count)s members",{count:y.length})),c.a.createElement("div",{className:"mx_Tooltip_sub"},Object(h.a)("Including %(commaSeparatedMembers)s",{commaSeparatedMembers:_}))):Object(h.a)("%(count)s members including %(commaSeparatedMembers)s",{count:y.length,commaSeparatedMembers:_}),c.a.createElement("div",i()({},a,{className:"mx_FacePile"}),c.a.createElement(m.a,{class:"mx_FacePile_faces",tooltip:w,tooltipProps:{yOffset:32}},y.length>n?c.a.createElement("span",{className:"mx_FacePile_face mx_FacePile_more"}):null,S.map(e=>c.a.createElement(d.a,{key:e.userId,member:e,width:28,height:28,className:"mx_FacePile_face"}))),s&&c.a.createElement("span",{className:"mx_FacePile_summary"},Object(h.a)("%(count)s people you know have already joined",{count:y.length})))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(118),h=s(89),u=s(115),m=s(85),p=s(332),g=s(134);let v=Object(m.a)("views.rooms.SearchResultTile")((a=i=class extends l.a.Component{render(){const e=this.props.searchResult,t=e.context.getEvent(),s=t.getId(),n=t.getTs(),i=[l.a.createElement(p.a,{key:n+"-search",ts:n})],a=h.b.getValue("showTwelveHourTimestamps"),o=h.b.getValue("alwaysShowTimestamps"),r=h.b.getValue(u.b.Flair),c=e.context.getTimeline();for(let t=0;t<c.length;t++){var d;const n=c[t];let h;const u=t!=e.context.getOurEventIndex();u||(h=this.props.searchHighlights),Object(g.d)(n,null===(d=this.context)||void 0===d?void 0:d.showHiddenEventsInTimeline)&&i.push(l.a.createElement(g.b,{key:`${s}+${t}`,mxEvent:n,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,userNameColorMode:this.props.userNameColorMode,contextual:u,highlights:h,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:a,alwaysShowTimestamps:o,enableFlair:r}))}return l.a.createElement("li",{"data-scroll-tokens":s},i)}},r()(i,"contextType",d.b),n=a))||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(84),o=s(88),r=s(91),c=s.n(r);t.a=e=>{const t=c()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let s;return e.numUnreadMessages&&(s=i.a.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),i.a.createElement("div",{className:t},i.a.createElement(o.a,{className:"mx_JumpToBottomButton_scrollDown",title:Object(a.a)("Scroll to most recent messages"),onClick:e.onScrollToBottomClick}),s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(84),r=s(88),c=s(85);let l=Object(c.a)("views.rooms.TopUnreadMessagesBar")(n=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_TopUnreadMessagesBar"},a.a.createElement(r.a,{className:"mx_TopUnreadMessagesBar_scrollUp",title:Object(o.a)("Jump to first unread message."),onClick:this.props.onScrollUpClick}),a.a.createElement(r.a,{className:"mx_TopUnreadMessagesBar_markAsRead",title:Object(o.a)("Mark all as read"),onClick:this.props.onCloseClick}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(83),a=s.n(i),o=s(82),r=s(146),c=s(91),l=s.n(c),d=s(85);let h=Object(d.a)("structures.ToastContainer")(n=class extends o.Component{constructor(e,t){super(e,t),a()(this,"onToastStoreUpdate",()=>{this.setState({toasts:r.a.sharedInstance().getToasts(),countSeen:r.a.sharedInstance().getCountSeen()})}),this.state={toasts:r.a.sharedInstance().getToasts(),countSeen:r.a.sharedInstance().getCountSeen()},r.a.sharedInstance().on("update",this.onToastStoreUpdate)}componentWillUnmount(){r.a.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let s,n;if(0!==e){const i=this.state.toasts[0],{title:a,icon:r,key:c,component:d,className:h,bodyClassName:u,props:m}=i,p=l()("mx_Toast_body",u),g=l()("mx_Toast_toast",h,{mx_Toast_hasIcon:r,["mx_Toast_icon_"+r]:r}),v=Object.assign({},m,{key:c,toastKey:c}),f=o.createElement(d,v);let b,y;(a&&t||this.state.countSeen>0)&&(b=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),a&&(y=o.createElement("div",{className:"mx_Toast_title"},o.createElement("h2",null,a),o.createElement("span",null,b))),s=o.createElement("div",{className:g},y,o.createElement("div",{className:p},f)),n=l()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return s?o.createElement("div",{className:n,role:"alert"},s):null}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(107),h=s(84),u=s(93),m=s(87),p=s(88),g=s(98),v=s(128),f=s(85);let b=Object(f.a)("structures.MyGroups")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{groups:null,error:null}),r()(this,"_onCreateGroupClick",()=>{m.a.dispatch({action:"view_create_group"})})}componentDidMount(){this._fetch()}_fetch(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups,error:null})},e=>{"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode?this.setState({groups:null,error:e}):this.setState({groups:[],error:null})})}render(){const e=u.a.get().brand,t=d.getComponent("elements.Spinner"),n=d.getComponent("rooms.SimpleRoomHeader"),i=d.getComponent("groups.GroupTile");let a,o;if(this.state.groups){const t=[];this.state.groups.forEach(e=>{t.push(l.a.createElement(i,{key:e,groupId:e}))}),o=t.length>0?l.a.createElement("h3",null,Object(h.a)("Your Communities")):l.a.createElement("div",null),a=t.length>0?l.a.createElement(v.a,{className:"mx_MyGroups_scrollable"},l.a.createElement("div",{className:"mx_MyGroups_microcopy"},l.a.createElement("p",null,Object(h.a)("Did you know: you can use communities to filter your %(brand)s experience!",{brand:e})),l.a.createElement("p",null,Object(h.a)("You can click on an avatar in the filter panel at any time to see only the rooms and people associated with that community."))),l.a.createElement("div",{className:"mx_MyGroups_joinedGroups"},t)):l.a.createElement("div",{className:"mx_MyGroups_placeholder"},Object(h.a)("You're not currently a member of any communities."))}else a=this.state.error?l.a.createElement("div",{className:"mx_MyGroups_error"},Object(h.a)("Error whilst fetching joined communities")):l.a.createElement(t,null);return l.a.createElement("div",{className:"mx_MyGroups"},l.a.createElement(n,{title:Object(h.a)("Communities"),icon:s(1612)}),l.a.createElement("div",{className:"mx_MyGroups_header"},l.a.createElement("div",{className:"mx_MyGroups_headerCard"},l.a.createElement(p.a,{className:"mx_MyGroups_headerCard_button",onClick:this._onCreateGroupClick}),l.a.createElement("div",{className:"mx_MyGroups_headerCard_content"},l.a.createElement("div",{className:"mx_MyGroups_headerCard_header"},Object(h.a)("Create a new community")),Object(h.a)("Create a community to group together users and rooms! Build a custom homepage to mark out your space in the Matrix universe.")))),l.a.createElement("div",{className:"mx_MyGroups_content"},o,a))}},r()(i,"contextType",g.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(82),a=s.n(i),o=s(86),r=s(90),c=s(84),l=s(554),d=s(85),h=s(117),u=s(181),m=s(104),p=s(330),g=s(331),v=s(96);let f=Object(d.a)("structures.UserView")(n=class extends a.a.Component{constructor(e){super(e),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){const e=o.a.get();let t;this.setState({loading:!0});try{t=await e.getProfileInfo(this.props.userId)}catch(e){return r.a.createTrackedDialog(Object(c.a)("Could not load user profile"),"",m.a,{title:Object(c.a)("Could not load user profile"),description:e&&e.message?e.message:Object(c.a)("Operation failed")}),void this.setState({loading:!1})}const s=new h.b({type:"m.room.member",content:t}),n=new u.a(null,this.props.userId);n.setMembershipEvent(s),this.setState({member:n,loading:!1})}render(){if(this.state.loading)return a.a.createElement(v.a,null);if(this.state.member){const e=a.a.createElement(g.a,{member:this.state.member,resizeNotifier:this.props.resizeNotifier});return a.a.createElement(p.a,{panel:e,resizeNotifier:this.props.resizeNotifier},a.a.createElement(l.a,null))}return a.a.createElement("div",null)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return q}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(110),h=s.n(d),u=s(86),m=s(107),p=s(87),g=s(653),v=s(138),f=s(84),b=s(88),y=s(949),E=s(330),S=s(331),_=s(90),w=s(91),C=s.n(w),O=s(131),k=s(183),R=s(570),I=s(120),x=s(249),T=s(4),j=s(244),N=s(128),P=s(103),D=s(85),M=s(186),A=s(92),U=s(122),L=s(1);const F=Object(f.b)('<h1>HTML for your community\'s page</h1>\n<p>\n    Use the long description to introduce new members to the community, or distribute\n    some important <a href="foo">links</a>\n</p>\n<p>\n    You can even add images with Matrix URLs <img src="mxc://url" />\n</p>\n'),B=h.a.shape({room_id:h.a.string.isRequired,profile:h.a.shape({name:h.a.string,avatar_url:h.a.string,canonical_alias:h.a.string}).isRequired}),V=h.a.shape({summaryInfo:h.a.shape({user_id:h.a.string.isRequired,role_id:h.a.string,avatar_url:h.a.string,displayname:h.a.string}).isRequired});class K extends l.a.Component{constructor(...e){super(...e),r()(this,"onAddRoomsToSummaryClicked",e=>{e.preventDefault();const t=m.getComponent("dialogs.AddressPickerDialog");_.a.createTrackedDialog("Add Rooms to Group Summary","",t,{title:Object(f.a)("Add rooms to the community summary"),description:Object(f.a)("Which rooms would you like to add to this summary?"),placeholder:Object(f.a)("Room name or address"),button:Object(f.a)("Add to summary"),pickerType:"room",validAddressTypes:["mx-room-id"],groupId:this.props.groupId,onFinished:(e,t)=>{if(!e)return;const s=[];Promise.allSettled(t.map(e=>O.a.addRoomToGroupSummary(this.props.groupId,e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Failed to add the following room to the group summary","",e,{title:Object(f.a)("Failed to add the following rooms to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=this.props.editing?l.a.createElement(b.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddRoomsToSummaryClicked},l.a.createElement("img",{src:s(950),width:"64",height:"64"}),l.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(f.a)("Add a Room"))):l.a.createElement("div",null),t=this.props.rooms.map(e=>l.a.createElement(W,{key:e.room_id,groupId:this.props.groupId,editing:this.props.editing,summaryInfo:e}));let n=l.a.createElement("div",null);return this.props.category&&this.props.category.profile&&(n=l.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.category.profile.name)),l.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},n,t,e)}}r()(K,"propTypes",{rooms:h.a.arrayOf(B).isRequired,category:h.a.shape({profile:h.a.shape({name:h.a.string}).isRequired}),groupId:h.a.string.isRequired,editing:h.a.bool.isRequired});class W extends l.a.Component{constructor(...e){super(...e),r()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:A.a.ViewRoom,room_alias:this.props.summaryInfo.profile.canonical_alias,room_id:this.props.summaryInfo.room_id})}),r()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),O.a.removeRoomFromGroupSummary(this.props.groupId,this.props.summaryInfo.room_id).catch(e=>{L.a.error("Error whilst removing room from group summary",e);const t=this.props.summaryInfo.name||this.props.summaryInfo.canonical_alias||this.props.summaryInfo.room_id,s=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Failed to remove room from group summary","",s,{title:Object(f.a)("Failed to remove the room from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(f.a)("The room '%(roomName)s' could not be removed from the summary.",{roomName:t})})})})}render(){const e=m.getComponent("avatars.RoomAvatar"),t=this.props.summaryInfo.profile.name||this.props.summaryInfo.profile.canonical_alias||Object(f.a)("Unnamed Room"),n={roomId:this.props.summaryInfo.room_id,avatarUrl:this.props.summaryInfo.profile.avatar_url,name:t};let i=null;this.props.summaryInfo.profile&&this.props.summaryInfo.profile.canonical_alias&&(i=Object(I.f)(this.props.summaryInfo.profile.canonical_alias));let a=null;a=i?l.a.createElement("a",{href:i,onClick:this.onClick},t):l.a.createElement("span",null,t);const o=this.props.editing?l.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(951),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):l.a.createElement("div",null);return l.a.createElement(b.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},l.a.createElement(e,{oobData:n,width:64,height:64}),l.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},a),o)}}r()(W,"propTypes",{summaryInfo:B.isRequired,editing:h.a.bool.isRequired,groupId:h.a.string.isRequired});class G extends l.a.Component{constructor(...e){super(...e),r()(this,"onAddUsersClicked",e=>{e.preventDefault();const t=m.getComponent("dialogs.AddressPickerDialog");_.a.createTrackedDialog("Add Users to Group Summary","",t,{title:Object(f.a)("Add users to the community summary"),description:Object(f.a)("Who would you like to add to this summary?"),placeholder:Object(f.a)("Name or Matrix ID"),button:Object(f.a)("Add to summary"),validAddressTypes:["mx-user-id"],groupId:this.props.groupId,shouldOmitSelf:!1,onFinished:(e,t)=>{if(!e)return;const s=[];Promise.allSettled(t.map(e=>O.a.addUserToGroupSummary(e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Failed to add the following users to the community summary","",e,{title:Object(f.a)("Failed to add the following users to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=this.props.editing?l.a.createElement(b.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddUsersClicked},l.a.createElement("img",{src:s(950),width:"64",height:"64"}),l.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(f.a)("Add a User"))):l.a.createElement("div",null),t=this.props.users.map(e=>l.a.createElement(H,{key:e.user_id,summaryInfo:e,editing:this.props.editing,groupId:this.props.groupId}));let n=l.a.createElement("div",null);return this.props.role&&this.props.role.profile&&(n=l.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.role.profile.name)),l.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},n,t,e)}}r()(G,"propTypes",{users:h.a.arrayOf(V).isRequired,role:h.a.shape({profile:h.a.shape({name:h.a.string}).isRequired}),groupId:h.a.string.isRequired,editing:h.a.bool.isRequired});class H extends l.a.Component{constructor(...e){super(...e),r()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_start_chat_or_reuse",user_id:this.props.summaryInfo.user_id})}),r()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),O.a.removeUserFromGroupSummary(this.props.groupId,this.props.summaryInfo.user_id).catch(e=>{L.a.error("Error whilst removing user from group summary",e);const t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,s=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Failed to remove user from community summary","",s,{title:Object(f.a)("Failed to remove a user from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(f.a)("The user '%(displayName)s' could not be removed from the summary.",{displayName:t})})})})}render(){const e=m.getComponent("avatars.BaseAvatar"),t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,n=Object(I.h)(this.props.summaryInfo.user_id),i=l.a.createElement("a",{href:n,onClick:this.onClick},t),a=Object(P.b)(this.props.summaryInfo.avatar_url).getSquareThumbnailHttp(64),o=this.props.editing?l.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(951),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):l.a.createElement("div",null);return l.a.createElement(b.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},l.a.createElement(e,{name:t,url:a,width:64,height:64}),l.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},i),o)}}r()(H,"propTypes",{summaryInfo:V.isRequired,editing:h.a.bool.isRequired,groupId:h.a.string.isRequired});let q=Object(D.a)("structures.GroupView")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{summary:null,isGroupPublicised:null,isUserPrivileged:null,groupRooms:null,groupRoomsLoading:null,error:null,editing:!1,saving:!1,uploadingAvatar:!1,avatarChanged:!1,membershipBusy:!1,publicityBusy:!1,inviterProfile:null,showRightPanel:j.a.getSharedInstance().isOpenForGroup,showUpgradeNotice:!localStorage.getItem("mx_hide_community_upgrade_notice")}),r()(this,"_onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:j.a.getSharedInstance().isOpenForGroup})}),r()(this,"_onGroupMyMembership",e=>{this._unmounted||e.groupId!==this.props.groupId||("leave"===e.myMembership&&this._closeSettings(),this.setState({membershipBusy:!1}))}),r()(this,"onGroupStoreUpdated",e=>{if(this._unmounted)return;const t=O.a.getSummary(this.props.groupId);t.profile&&["avatar_url","long_description","name","short_description"].forEach(e=>{t.profile[e]=t.profile[e]||""}),this.setState({summary:t,summaryLoading:!O.a.isStateReady(this.props.groupId,O.a.STATE_KEY.Summary),isGroupPublicised:O.a.getGroupPublicity(this.props.groupId),isUserPrivileged:O.a.isUserPrivileged(this.props.groupId),groupRooms:O.a.getGroupRooms(this.props.groupId),groupRoomsLoading:!O.a.isStateReady(this.props.groupId,O.a.STATE_KEY.GroupRooms),isUserMember:O.a.getGroupMembers(this.props.groupId).some(e=>e.userId===this._matrixClient.credentials.userId)}),this.props.groupIsNew&&e&&this._onEditClick()}),r()(this,"_onEditClick",()=>{this.setState({editing:!0,profileForm:Object.assign({},this.state.summary.profile),joinableForm:{policyType:this.state.summary.profile.is_openly_joinable?"open":"invite"}})}),r()(this,"_onShareClick",()=>{const e=m.getComponent("dialogs.ShareDialog");_.a.createTrackedDialog("share community dialog","",e,{target:this._matrixClient.getGroup(this.props.groupId)||new x.a(this.props.groupId)})}),r()(this,"_onCancelClick",()=>{this._closeSettings()}),r()(this,"_onAction",e=>{switch(e.action){case"close_settings":this.setState({editing:!1,profileForm:null})}}),r()(this,"_closeSettings",()=>{p.a.dispatch({action:"close_settings"})}),r()(this,"_onNameChange",e=>{const t=Object.assign(this.state.profileForm,{name:e});this.setState({profileForm:t})}),r()(this,"_onShortDescChange",e=>{const t=Object.assign(this.state.profileForm,{short_description:e});this.setState({profileForm:t})}),r()(this,"_onLongDescChange",e=>{const t=Object.assign(this.state.profileForm,{long_description:e.target.value});this.setState({profileForm:t})}),r()(this,"_onAvatarSelected",e=>{const t=e.target.files[0];t&&(this.setState({uploadingAvatar:!0}),this._matrixClient.uploadContent(t).then(e=>{const t=Object.assign(this.state.profileForm,{avatar_url:e});this.setState({uploadingAvatar:!1,profileForm:t,avatarChanged:!0})}).catch(e=>{this.setState({uploadingAvatar:!1});const t=m.getComponent("dialogs.ErrorDialog");L.a.error("Failed to upload avatar image",e),_.a.createTrackedDialog("Failed to upload image","",t,{title:Object(f.a)("Error"),description:Object(f.a)("Failed to upload image")})}))}),r()(this,"_onJoinableChange",e=>{this.setState({joinableForm:{policyType:e.target.value}})}),r()(this,"_onSaveClick",()=>{this.setState({saving:!0});(this.state.isUserPrivileged?this._saveGroup():Promise.resolve()).then(e=>{this.setState({saving:!1,editing:!1,summary:null}),this._initGroupStore(this.props.groupId),this.state.avatarChanged&&k.a.refreshGroupProfile(this._matrixClient,this.props.groupId)}).catch(e=>{this.setState({saving:!1});const t=m.getComponent("dialogs.ErrorDialog");L.a.error("Failed to save community profile",e),_.a.createTrackedDialog("Failed to update group","",t,{title:Object(f.a)("Error"),description:Object(f.a)("Failed to update community")})}).finally(()=>{this.setState({avatarChanged:!1})})}),r()(this,"_onAcceptInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(T.I)(500),O.a.acceptGroupInvite(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Error accepting invite","",t,{title:Object(f.a)("Error"),description:Object(f.a)("Unable to accept invite")})})}),r()(this,"_onRejectInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(T.I)(500),O.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(f.a)("Error"),description:Object(f.a)("Unable to reject invite")})})}),r()(this,"_onJoinClick",async()=>{this._matrixClient.isGuest()?p.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+this.props.groupId}}):(this.setState({membershipBusy:!0}),await Object(T.I)(500),O.a.joinGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Error joining room","",t,{title:Object(f.a)("Error"),description:Object(f.a)("Unable to join community")})}))}),r()(this,"_onLeaveClick",()=>{const e=m.getComponent("dialogs.QuestionDialog"),t=this._leaveGroupWarnings();_.a.createTrackedDialog("Leave Group","",e,{title:Object(f.a)("Leave Community"),description:l.a.createElement("span",null,Object(f.a)("Leave %(groupName)s?",{groupName:this.props.groupId}),t),button:Object(f.a)("Leave"),danger:this.state.isUserPrivileged,onFinished:async e=>{e&&(this.setState({membershipBusy:!0}),await Object(T.I)(500),O.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=m.getComponent("dialogs.ErrorDialog");_.a.createTrackedDialog("Error leaving community","",t,{title:Object(f.a)("Error"),description:Object(f.a)("Unable to leave community")})}))}})}),r()(this,"_onAddRoomsClick",()=>{Object(R.a)(this.props.groupId)}),r()(this,"_dismissUpgradeNotice",()=>{localStorage.setItem("mx_hide_community_upgrade_notice","true"),this.setState({showUpgradeNotice:!1})}),r()(this,"_onCreateSpaceClick",()=>{Object(M.b)(this._matrixClient,this.props.groupId)}),r()(this,"_onAdminsLinkClick",()=>{p.a.dispatch({action:A.a.SetRightPanelPhase,phase:U.c.GroupMemberList})})}componentDidMount(){this._unmounted=!1,this._matrixClient=u.a.get(),this._matrixClient.on("Group.myMembership",this._onGroupMyMembership),this._initGroupStore(this.props.groupId,!0),this._dispatcherRef=p.a.register(this._onAction),this._rightPanelStoreToken=j.a.getSharedInstance().addListener(this._onRightPanelStoreUpdate)}componentWillUnmount(){this._unmounted=!0,this._matrixClient.removeListener("Group.myMembership",this._onGroupMyMembership),p.a.unregister(this._dispatcherRef),this._rightPanelStoreToken&&this._rightPanelStoreToken.remove()}UNSAFE_componentWillReceiveProps(e){this.props.groupId!==e.groupId&&this.setState({summary:null,error:null},()=>{this._initGroupStore(e.groupId)})}_initGroupStore(e,t){const s=this._matrixClient.getGroup(e);s&&s.inviter&&s.inviter.userId&&this._fetchInviterProfile(s.inviter.userId),O.a.registerListener(e,this.onGroupStoreUpdated.bind(this,t));let n=!1;O.a.on("error",(t,s,i)=>{this._unmounted||e!==s||("M_GUEST_ACCESS_FORBIDDEN"!==t.errcode||n||(p.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_group",group_id:e}}),p.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+e}}),n=!0),i===O.a.STATE_KEY.Summary&&this.setState({summary:null,error:t,editing:!1}))})}_fetchInviterProfile(e){this.setState({inviterProfileBusy:!0}),this._matrixClient.getProfileInfo(e).then(e=>{this._unmounted||this.setState({inviterProfile:{avatarUrl:e.avatar_url,displayName:e.displayname}})}).catch(e=>{L.a.error("Error getting group inviter profile",e)}).finally(()=>{this._unmounted||this.setState({inviterProfileBusy:!1})})}async _saveGroup(){await this._matrixClient.setGroupProfile(this.props.groupId,this.state.profileForm),await this._matrixClient.setGroupJoinPolicy(this.props.groupId,{type:this.state.joinableForm.policyType})}_leaveGroupWarnings(){const e=[];return this.state.isUserPrivileged&&e.push(l.a.createElement("span",{className:"warning"}," ",Object(f.a)("You are an administrator of this community. You will not be able to rejoin without an invite from another administrator."))),e}_getGroupSection(){const e=C()({mx_GroupView_group:this.state.editing,mx_GroupView_group_disabled:this.state.editing&&!this.state.isUserPrivileged}),t=this.state.editing?l.a.createElement("h2",null," ",Object(f.a)("Community Settings")," "):l.a.createElement("div",null),n=Object(g.a)("community-settings");let i=null;n&&this.state.isUserPrivileged&&(i=l.a.createElement("div",{className:"mx_GroupView_hostingSignup"},Object(f.a)("Want more than a community? <a>Get your own server</a>",{},{a:e=>l.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},e)}),l.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},l.a.createElement("img",{src:s(655),width:"11",height:"10",alt:""}))));const a=this.state.editing&&this.state.isUserPrivileged?l.a.createElement("div",{className:"mx_GroupView_changeDelayWarning"},Object(f.a)("Changes made to your community <bold1>name</bold1> and <bold2>avatar</bold2> might not be seen by other users for up to 30 minutes.",{},{bold1:e=>l.a.createElement("b",null," ",e," "),bold2:e=>l.a.createElement("b",null," ",e," ")})):l.a.createElement("div",null);let o;if(this.state.showUpgradeNotice){let e;e=this.state.isUserPrivileged?Object(f.a)("You can create a Space from this community <a>here</a>.",{},{a:e=>l.a.createElement(b.a,{onClick:this._onCreateSpaceClick,kind:"link"},e)}):Object(f.a)("Ask the <a>admins</a> of this community to make it into a Space and keep a look out for the invite.",{},{a:e=>l.a.createElement(b.a,{onClick:this._onAdminsLinkClick,kind:"link"},e)}),o=l.a.createElement("div",{className:"mx_GroupView_spaceUpgradePrompt"},l.a.createElement("h2",null,Object(f.a)("Communities can now be made into Spaces")),l.a.createElement("p",null,Object(f.a)("Spaces are a new way to make a community, with new features coming.")," ",e," ",Object(f.a)("Communities won't receive further updates.")),l.a.createElement(b.a,{className:"mx_GroupView_spaceUpgradePrompt_close",onClick:this._dismissUpgradeNotice}))}return l.a.createElement("div",{className:e},t,i,a,o,this._getJoinableNode(),this._getLongDescriptionNode(),this._getRoomsNode())}_getRoomsNode(){const e=m.getComponent("rooms.RoomDetailList"),t=m.getComponent("elements.AccessibleButton"),n=m.getComponent("elements.Spinner"),i=m.getComponent("elements.TooltipButton"),a=this.state.editing?l.a.createElement(i,{helpText:Object(f.a)("These rooms are displayed to community members on the community page. Community members can join the rooms by clicking on them.")}):l.a.createElement("div",null),o=this.state.editing?l.a.createElement(t,{className:"mx_GroupView_rooms_header_addRow",onClick:this._onAddRoomsClick},l.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_button"},l.a.createElement("img",{src:s(1613),width:"24",height:"24"})),l.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_label"},Object(f.a)("Add rooms to this community"))):l.a.createElement("div",null);return l.a.createElement("div",{className:"mx_GroupView_rooms"},l.a.createElement("div",{className:"mx_GroupView_rooms_header"},l.a.createElement("h3",null,Object(f.a)("Rooms"),a),o),this.state.groupRoomsLoading?l.a.createElement(n,null):l.a.createElement(e,{rooms:this.state.groupRooms}))}_getFeaturedRoomsNode(){const e=this.state.summary,t=[],s={};e.rooms_section.rooms.forEach(e=>{if(null===e.category_id)t.push(e);else{let t=s[e.category_id];void 0===t&&(t=[],s[e.category_id]=t),t.push(e)}});const n=l.a.createElement(K,{rooms:t,groupId:this.props.groupId,editing:this.state.editing}),i=Object.keys(s).map(t=>{const n=e.rooms_section.categories[t];return l.a.createElement(K,{key:t,rooms:s[t],category:n,groupId:this.props.groupId,editing:this.state.editing})});return l.a.createElement("div",{className:"mx_GroupView_featuredThings"},l.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(f.a)("Featured Rooms:")),n,i)}_getFeaturedUsersNode(){const e=this.state.summary,t=[],s={};e.users_section.users.forEach(e=>{if(null===e.role_id)t.push(e);else{let t=s[e.role_id];void 0===t&&(t=[],s[e.role_id]=t),t.push(e)}});const n=l.a.createElement(G,{users:t,groupId:this.props.groupId,editing:this.state.editing}),i=Object.keys(s).map(t=>{const n=e.users_section.roles[t];return l.a.createElement(G,{key:t,users:s[t],role:n,groupId:this.props.groupId,editing:this.state.editing})});return l.a.createElement("div",{className:"mx_GroupView_featuredThings"},l.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(f.a)("Featured Users:")),n,i)}_getMembershipSection(){const e=m.getComponent("elements.Spinner"),t=m.getComponent("avatars.BaseAvatar"),s=this._matrixClient.getGroup(this.props.groupId);if(s&&"invite"===s.myMembership){if(this.state.membershipBusy||this.state.inviterProfileBusy)return l.a.createElement("div",{className:"mx_GroupView_membershipSection"},l.a.createElement(e,null));const n=this.state.inviterProfile&&this.state.inviterProfile.avatarUrl?Object(P.b)(this.state.inviterProfile.avatarUrl).getSquareThumbnailHttp(36):null,i=s.inviter||{};let a=i.userId;return this.state.inviterProfile&&(a=this.state.inviterProfile.displayName||i.userId),l.a.createElement("div",{className:"mx_GroupView_membershipSection mx_GroupView_membershipSection_invited"},l.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},l.a.createElement("div",{className:"mx_GroupView_membershipSection_description"},l.a.createElement(t,{url:n,name:a,width:36,height:36}),Object(f.a)("%(inviter)s has invited you to join this community",{inviter:a||Object(f.a)("Someone")})),l.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},l.a.createElement(b.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onAcceptInviteClick},Object(f.a)("Accept")),l.a.createElement(b.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onRejectInviteClick},Object(f.a)("Decline")))))}let n,i,a,o,r;if((!s||"leave"===s.myMembership)&&this.state.summary&&this.state.summary.profile&&Boolean(this.state.summary.profile.is_openly_joinable))o=Object(f.a)("Join this community"),r=this._onJoinClick,i="mx_GroupView_joinButton",n="mx_GroupView_membershipSection_leave";else{if(!s||"join"!==s.myMembership||!this.state.editing)return null;o=Object(f.a)("Leave this community"),r=this._onLeaveClick,a=this.state.isUserPrivileged?Object(f.a)("You are an administrator of this community"):Object(f.a)("You are a member of this community"),i={mx_GroupView_leaveButton:!0,mx_RoomHeader_textButton_danger:this.state.isUserPrivileged},n="mx_GroupView_membershipSection_joined"}const c=C()(["mx_RoomHeader_textButton","mx_GroupView_textButton"],i),d=C()("mx_GroupView_membershipSection",n);return l.a.createElement("div",{className:d},l.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},this.state.membershipBusy?l.a.createElement(e,null):l.a.createElement("div",null),l.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},l.a.createElement(b.a,{className:c,onClick:r,title:a},o))))}_getJoinableNode(){const e=m.getComponent("elements.InlineSpinner");return this.state.editing?l.a.createElement("div",null,l.a.createElement("h3",null,Object(f.a)("Who can join this community?"),this.state.groupJoinableLoading?l.a.createElement(e,null):l.a.createElement("div",null)),l.a.createElement("div",null,l.a.createElement("label",null,l.a.createElement("input",{type:"radio",value:"invite",checked:"invite"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),l.a.createElement("div",{className:"mx_GroupView_label_text"},Object(f.a)("Only people who have been invited")))),l.a.createElement("div",null,l.a.createElement("label",null,l.a.createElement("input",{type:"radio",value:"open",checked:"open"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),l.a.createElement("div",{className:"mx_GroupView_label_text"},Object(f.a)("Everyone"))))):null}_getLongDescriptionNode(){const e=this.state.summary;let t=null;e.profile&&e.profile.long_description?t=Object(v.h)(e.profile.long_description):this.state.isUserPrivileged&&(t=l.a.createElement("div",{className:"mx_GroupView_groupDesc_placeholder",onClick:this._onEditClick},Object(f.a)("Your community hasn't got a Long Description, a HTML page to show to community members.<br />Click here to open settings and give it one!",{},{br:l.a.createElement("br",null)})));const s=C()({mx_GroupView_groupDesc:!0,mx_GroupView_groupDesc_disabled:!this.state.isUserPrivileged});return this.state.editing?l.a.createElement("div",{className:s},l.a.createElement("h3",null," ",Object(f.a)("Long Description (HTML)")," "),l.a.createElement("textarea",{value:this.state.profileForm.long_description,placeholder:Object(f.a)(F),onChange:this._onLongDescChange,tabIndex:"4",key:"editLongDesc"})):l.a.createElement("div",{className:"mx_GroupView_groupDesc"},t)}render(){const e=m.getComponent("avatars.GroupAvatar"),t=m.getComponent("elements.Spinner");if(this.state.summaryLoading&&null===this.state.error||this.state.saving)return l.a.createElement(t,null);if(this.state.summary&&!this.state.error){const n=this.state.summary;let i,a,o;const r=[];if(this.state.editing&&this.state.isUserPrivileged){let e;if(this.state.uploadingAvatar)e=l.a.createElement(t,null);else{const t=m.getComponent("avatars.GroupAvatar");e=l.a.createElement(t,{groupId:this.props.groupId,groupName:this.state.profileForm.name,groupAvatarUrl:this.state.profileForm.avatar_url,width:28,height:28,resizeMethod:"crop"})}i=l.a.createElement("div",{className:"mx_GroupView_avatarPicker"},l.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},e),l.a.createElement("div",{className:"mx_GroupView_avatarPicker_edit"},l.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},l.a.createElement("img",{src:s(1614),alt:Object(f.a)("Upload avatar"),title:Object(f.a)("Upload avatar"),width:"17",height:"15"})),l.a.createElement("input",{id:"avatarInput",className:"mx_GroupView_uploadInput",type:"file",onChange:this._onAvatarSelected})));const n=m.getComponent("elements.EditableText");a=l.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(f.a)("Community Name"),blurToCancel:!1,initialValue:this.state.profileForm.name,onValueChanged:this._onNameChange,tabIndex:"0",dir:"auto"}),o=l.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(f.a)("Description"),blurToCancel:!1,initialValue:this.state.profileForm.short_description,onValueChanged:this._onShortDescChange,tabIndex:"0",dir:"auto"})}else{const t=this.state.isUserMember?this._onEditClick:null,s=n.profile?n.profile.avatar_url:null,r=n.profile?n.profile.name:null;i=l.a.createElement(e,{groupId:this.props.groupId,groupAvatarUrl:s,groupName:r,onClick:t,width:28,height:28}),a=n.profile&&n.profile.name?l.a.createElement("div",{onClick:t},l.a.createElement("span",null,n.profile.name),l.a.createElement("span",{className:"mx_GroupView_header_groupid"},"(",this.props.groupId,")")):l.a.createElement("span",{onClick:t},this.props.groupId),n.profile&&n.profile.short_description&&(o=l.a.createElement("span",{onClick:t},n.profile.short_description))}this.state.editing?(r.push(l.a.createElement(b.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",key:"_saveButton",onClick:this._onSaveClick},Object(f.a)("Save"))),r.push(l.a.createElement(b.a,{className:"mx_RoomHeader_cancelButton",key:"_cancelButton",onClick:this._onCancelClick},l.a.createElement("img",{src:s(402),className:"mx_filterFlipColor",width:"18",height:"18",alt:Object(f.a)("Cancel")})))):(n.user&&"join"===n.user.membership&&r.push(l.a.createElement(b.a,{className:"mx_GroupHeader_button mx_GroupHeader_editButton",key:"_editButton",onClick:this._onEditClick,title:Object(f.a)("Community Settings")})),r.push(l.a.createElement(b.a,{className:"mx_GroupHeader_button mx_GroupHeader_shareButton",key:"_shareButton",onClick:this._onShareClick,title:Object(f.a)("Share Community")})));const c=this.state.showRightPanel?l.a.createElement(S.a,{groupId:this.props.groupId}):void 0,d={mx_GroupView_header:!0,"light-panel":!0,mx_GroupView_header_view:!this.state.editing,mx_GroupView_header_isUserMember:this.state.isUserMember};return l.a.createElement("main",{className:"mx_GroupView"},l.a.createElement("div",{className:C()(d)},l.a.createElement("div",{className:"mx_GroupView_header_leftCol"},l.a.createElement("div",{className:"mx_GroupView_header_avatar"},i),l.a.createElement("div",{className:"mx_GroupView_header_info"},l.a.createElement("div",{className:"mx_GroupView_header_name"},a),l.a.createElement("div",{className:"mx_GroupView_header_shortDesc"},o))),l.a.createElement("div",{className:"mx_GroupView_header_rightCol"},r),l.a.createElement(y.a,null)),l.a.createElement(E.a,{panel:c,resizeNotifier:this.props.resizeNotifier},l.a.createElement(N.a,{className:"mx_GroupView_body"},this._getMembershipSection(),this._getGroupSection())))}if(this.state.error){if(404===this.state.error.httpStatus)return l.a.createElement("div",{className:"mx_GroupView_error"},Object(f.a)("Community %(groupId)s not found",{groupId:this.props.groupId}));{let e;return"M_UNRECOGNIZED"===this.state.error.errcode&&(e=l.a.createElement("div",null,Object(f.a)("This homeserver does not support communities"))),l.a.createElement("div",{className:"mx_GroupView_error"},Object(f.a)("Failed to load %(groupId)s",{groupId:this.props.groupId}),e)}}return L.a.error("Invalid state for GroupView"),l.a.createElement("div",null)}},r()(i,"propTypes",{groupId:h.a.string.isRequired,groupIsNew:h.a.bool}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(578),d=s(579),h=s(122),u=s(92),m=s(85);const p=[h.c.GroupMemberInfo,h.c.GroupMemberList],g=[h.c.GroupRoomList,h.c.GroupRoomInfo];let v=Object(m.a)("views.right_panel.GroupHeaderButtons")(n=class extends d.b{constructor(e){super(e,d.a.Group),a()(this,"onMembersClicked",()=>{this.state.phase===h.c.GroupMemberInfo?this.setPhase(h.c.GroupMemberInfo):this.setPhase(h.c.GroupMemberList)}),a()(this,"onRoomsClicked",()=>{this.setPhase(h.c.GroupRoomList)})}onAction(e){e.action===u.a.ViewUser?e.member?this.setPhase(h.c.RoomMemberInfo,{member:e.member}):this.setPhase(h.c.GroupMemberList):"view_group"===e.action?this.setPhase(h.c.GroupMemberList):"view_group_room"===e.action?this.setPhase(h.c.GroupRoomInfo,{groupRoomId:e.groupRoomId,groupId:e.groupId}):"view_group_room_list"===e.action?this.setPhase(h.c.GroupRoomList):"view_group_member_list"===e.action?this.setPhase(h.c.GroupMemberList):"view_group_user"===e.action&&this.setPhase(h.c.GroupMemberInfo,{member:e.member})}renderButtons(){return r.a.createElement(r.a.Fragment,null,r.a.createElement(l.a,{name:"groupMembersButton",title:Object(c.a)("Members"),isHighlighted:this.isPhase(p),onClick:this.onMembersClicked,analytics:["Right Panel","Group Member List Button","click"]}),r.a.createElement(l.a,{name:"roomsButton",title:Object(c.a)("Rooms"),isHighlighted:this.isPhase(g),onClick:this.onRoomsClicked,analytics:["Right Panel","Group Room List Button","click"]}))}})||n},function(e,t){e.exports="img/icons-create-room.817ede2.svg"},function(e,t){e.exports="img/cancel-small.495f44c.svg"},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(190),h=s(953),u=s(87),m=s(84),p=s(91),g=s.n(p),v=s(98),f=s(128),b=s(89),y=s(954),E=s(85),S=s(139),_=s(955),w=s(957);let C=Object(E.a)("structures.GroupFilterPanel")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{orderedTags:[],selectedTags:[]}),r()(this,"ref",l.a.createRef()),r()(this,"unmounted",!1),r()(this,"groupFilterOrderStoreToken",void 0),r()(this,"onGroupMyMembership",()=>{this.unmounted||u.a.dispatch(h.a.fetchJoinedGroups(this.context))}),r()(this,"onClientSync",(e,t)=>{"ERROR"!==e&&t!==e&&u.a.dispatch(h.a.fetchJoinedGroups(this.context))}),r()(this,"onClick",e=>{this.state.selectedTags.length>0&&u.a.dispatch({action:"deselect_tags"})}),r()(this,"onClearFilterClick",e=>{u.a.dispatch({action:"deselect_tags"})})}componentDidMount(){this.unmounted=!1,this.context.on("Group.myMembership",this.onGroupMyMembership),this.context.on("sync",this.onClientSync),this.groupFilterOrderStoreToken=d.a.addListener(()=>{this.unmounted||this.setState({orderedTags:d.a.getOrderedTags()||[],selectedTags:d.a.getSelectedTags()})}),u.a.dispatch(h.a.fetchJoinedGroups(this.context)),S.b.instance.trackElementDimensions("GroupPanel",this.ref.current)}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("Group.myMembership",this.onGroupMyMembership),this.context.removeListener("sync",this.onClientSync),this.groupFilterOrderStoreToken&&this.groupFilterOrderStoreToken.remove(),S.b.instance.stopTrackingElementDimensions("GroupPanel")}renderGlobalIcon(){return b.b.getValue("feature_communities_v2_prototypes")?l.a.createElement("div",null,l.a.createElement(y.a,null),l.a.createElement("hr",{className:"mx_GroupFilterPanel_divider"})):null}render(){const e=this.state.orderedTags.map((e,t)=>l.a.createElement(_.a,{key:e,tag:e,index:t,selected:this.state.selectedTags.includes(e)})),t=this.state.selectedTags.length>0,s=g()("mx_GroupFilterPanel",{mx_GroupFilterPanel_items_selected:t});let n=l.a.createElement(w.a,{tooltip:!0,label:Object(m.a)("Communities"),action:"toggle_my_groups",className:"mx_TagTile mx_TagTile_plus"});return b.b.getValue("feature_communities_v2_prototypes")&&(n=l.a.createElement(w.a,{tooltip:!0,label:Object(m.a)("Create community"),action:"view_create_group",className:"mx_TagTile mx_TagTile_plus"})),l.a.createElement("div",{className:s,onClick:this.onClearFilterClick,ref:this.ref},l.a.createElement(f.a,{className:"mx_GroupFilterPanel_scroller",onClick:this.onClick},l.a.createElement("div",{className:"mx_GroupFilterPanel_tagTileContainer"},this.renderGlobalIcon(),e,l.a.createElement("div",null,n))))}},r()(i,"contextType",v.a),n=a))||n;t.a=C},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(457);class i{static fetchJoinedGroups(e){return Object(n.a)("GroupActions.fetchJoinedGroups",()=>e.getJoinedGroups(),null)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(87),l=s(190),d=s(111),h=s(91),u=s.n(h),m=s(84),p=s(85);let g=Object(p.a)("views.elements.UserTagTile")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"tagStoreRef",void 0),a()(this,"onTagStoreUpdate",()=>{const e=0===l.a.getSelectedTags().length;this.setState({selected:e})}),a()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),c.a.dispatch({action:"deselect_tags"})}),this.state={selected:0===l.a.getSelectedTags().length}}componentDidMount(){this.tagStoreRef=l.a.addListener(this.onTagStoreUpdate)}componentWillUnmount(){this.tagStoreRef.remove()}render(){const e=u()({mx_TagTile:!0,mx_TagTile_prototype:!0,mx_TagTile_selected_prototype:this.state.selected,mx_TagTile_home:!0});return r.a.createElement(d.a,{className:e,onClick:this.onTileClick,title:Object(m.a)("Home")},r.a.createElement("div",{className:"mx_TagTile_avatar"},r.a.createElement("div",{className:"mx_TagTile_homeIcon"})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(95),i=s.n(n),a=s(956),o=s(82),r=s.n(o),c=s(105),l=s(107);function d(e){const[t,s,n,o]=Object(c.p)();let d=null;if(t&&s.current){const t=s.current.getBoundingClientRect(),n=l.getComponent("context_menus.TagTileContextMenu");d=r.a.createElement(c.n,i()({},Object(c.o)(t),{onFinished:o}),r.a.createElement(n,{tag:e.tag,onFinished:o,index:e.index}))}return r.a.createElement(r.a.Fragment,null,r.a.createElement(a.a,i()({},e,{contextMenuButtonRef:s,menuDisplayed:t,openMenu:n})),d)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(110),h=s.n(d),u=s(91),m=s.n(u),p=s(107),g=s(87),v=s(108),f=s(161),b=s(183),y=s(131),E=s(190),S=s(98),_=s(88),w=s(89),C=s(103),O=s(85),k=s(1);let R=Object(O.a)("views.elements.TagTile")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{hover:!1,profile:null}),r()(this,"_onFlairStoreUpdated",()=>{this.unmounted||b.a.getGroupProfileCached(this.context,this.props.tag).then(e=>{this.unmounted||this.setState({profile:e})}).catch(e=>{k.a.warn("Could not fetch group profile for "+this.props.tag,e)})}),r()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"select_tag",tag:this.props.tag,ctrlOrCmdKey:Object(v.c)(e),shiftKey:e.shiftKey}),"+"===this.props.tag[0]&&this._refreshGroup(this.props.tag)}),r()(this,"onMouseOver",()=>{w.b.getValue("feature_communities_v2_prototypes")||this.setState({hover:!0})}),r()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),r()(this,"openMenu",e=>{e.stopPropagation(),e.preventDefault(),w.b.getValue("feature_communities_v2_prototypes")||(this.setState({hover:!1}),this.props.openMenu())})}componentDidMount(){this.unmounted=!1,"+"===this.props.tag[0]&&(b.a.addListener("updateGroupProfile",this._onFlairStoreUpdated),this._onFlairStoreUpdated(),this._refreshGroup(this.props.tag))}componentWillUnmount(){this.unmounted=!0,"+"===this.props.tag[0]&&b.a.removeListener("updateGroupProfile",this._onFlairStoreUpdated)}_refreshGroup(e){y.a.refreshGroupRooms(e),y.a.refreshGroupMembers(e)}render(){const e=p.getComponent("avatars.BaseAvatar"),t=this.state.profile||{},s=t.name||this.props.tag,n=t.avatarUrl?Object(C.b)(t.avatarUrl).getSquareThumbnailHttp(32):null,i=w.b.getValue("feature_communities_v2_prototypes"),a=m()({mx_TagTile:!0,mx_TagTile_prototype:i,mx_TagTile_selected:this.props.selected&&!i,mx_TagTile_selected_prototype:this.props.selected&&i}),o=E.a.getGroupBadge(this.props.tag);let r;if(o&&!this.state.hover&&!this.props.menuDisplayed){const e=m()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:o.highlight});r=l.a.createElement("div",{className:e},f.c(o.count))}const c=this.state.hover||this.props.menuDisplayed?l.a.createElement(_.a,{className:"mx_TagTile_context_button",onClick:this.openMenu,inputRef:this.props.contextMenuButtonRef},"···"):l.a.createElement("div",{ref:this.props.contextMenuButtonRef}),d=p.getComponent("elements.AccessibleTooltipButton");return l.a.createElement(d,{className:a,onClick:this.onClick,onContextMenu:this.openMenu,title:s},l.a.createElement("div",{className:"mx_TagTile_avatar",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},l.a.createElement(e,{name:s,idName:this.props.tag,url:n,width:32,height:32}),c,r))}},r()(i,"propTypes",{tag:h.a.string,contextMenuButtonRef:h.a.object,openMenu:h.a.func,menuDisplayed:h.a.bool,selected:h.a.bool}),r()(i,"contextType",S.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(88),h=s(87),u=s(140),m=s(85),p=s(150);let g=Object(m.a)("views.elements.ActionButton")((a=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onClick",e=>{e.stopPropagation(),u.a.trackEvent("Action Button","click",this.props.action),h.a.dispatch({action:this.props.action})}),r()(this,"onMouseEnter",()=>{this.props.tooltip&&this.setState({showTooltip:!0}),this.props.mouseOverAction&&h.a.dispatch({action:this.props.mouseOverAction})}),r()(this,"onMouseLeave",()=>{this.setState({showTooltip:!1})}),this.state={showTooltip:!1}}render(){let e;this.state.showTooltip&&(e=l.a.createElement(p.b,{className:"mx_RoleButton_tooltip",label:this.props.label}));const t=this.props.iconPath?l.a.createElement("img",{src:this.props.iconPath,width:this.props.size,height:this.props.size}):void 0,s=["mx_RoleButton"];return this.props.className&&s.push(this.props.className),l.a.createElement(d.a,{className:s.join(" "),onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,"aria-label":this.props.label},t,e,this.props.children)}},r()(i,"defaultProps",{size:"25",tooltip:!1}),n=a))||n},function(e,t,s){"use strict";var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(780),l=s(128),d=s(107),h=s(87),u=s(91),m=s.n(u),p=s(161),g=s(85);let v=Object(g.a)("structures.CustomRoomTagPanel")(n=class extends r.a.Component{constructor(e){super(e),this.state={tags:c.a.getSortedTags()}}componentDidMount(){this._tagStoreToken=c.a.addListener(()=>{this.setState({tags:c.a.getSortedTags()})})}componentWillUnmount(){this._tagStoreToken&&this._tagStoreToken.remove()}render(){const e=this.state.tags.map(e=>r.a.createElement(f,{tag:e,key:e.name})),t=m()("mx_CustomRoomTagPanel",{mx_CustomRoomTagPanel_empty:0===this.state.tags.length});return r.a.createElement("div",{className:t},r.a.createElement("div",{className:"mx_CustomRoomTagPanel_divider"}),r.a.createElement(l.a,{className:"mx_CustomRoomTagPanel_scroller"},e))}})||n;class f extends r.a.Component{constructor(...e){super(...e),a()(this,"onClick",()=>{h.a.dispatch({action:"select_custom_room_tag",tag:this.props.tag.name})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleTooltipButton"),s=this.props.tag,n=m()({CustomRoomTagPanel_tileSelected:s.selected}),i=s.name,a=s.badgeNotifState;let o;if(a){const e=m()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:a.hasMentions});o=r.a.createElement("div",{className:e},p.c(a.count))}return r.a.createElement(t,{className:n,onClick:this.onClick,title:i},r.a.createElement("div",{className:"mx_TagTile_avatar"},r.a.createElement(e,{name:s.avatarLetter,idName:i,width:40,height:40}),o))}}t.a=v},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(98),o=s(84),r=s(88),c=s(277),l=s(259),d=s(96),h=s(320),u=s(138),m=s(87),p=s(92),g=s(158);const v=()=>{m.a.dispatch({action:p.a.ViewUserSettings,initialTabId:g.a.Preferences})};t.a=({groupId:e})=>{var t;const s=Object(n.useContext)(a.a),m=Object(l.a)(()=>s.getGroupSummary(e),[s,e]);if(!m)return i.a.createElement("main",{className:"mx_SpaceRoomView"},i.a.createElement("div",{className:"mx_MainSplit"},i.a.createElement("div",{className:"mx_SpaceRoomView_preview"},i.a.createElement(d.a,null))));let p;return p=m.profile.is_public?i.a.createElement("span",{className:"mx_SpaceRoomView_info_public"},Object(o.a)("Public community")):i.a.createElement("span",{className:"mx_SpaceRoomView_info_private"},Object(o.a)("Private community")),i.a.createElement("main",{className:"mx_SpaceRoomView"},i.a.createElement(c.a,null,i.a.createElement("div",{className:"mx_MainSplit"},i.a.createElement("div",{className:"mx_SpaceRoomView_preview"},i.a.createElement(h.a,{groupId:e,groupName:m.profile.name,groupAvatarUrl:m.profile.avatar_url,height:80,width:80,resizeMethod:"crop"}),i.a.createElement("h1",{className:"mx_SpaceRoomView_preview_name"},m.profile.name),i.a.createElement("div",{className:"mx_SpaceRoomView_info"},p),i.a.createElement("div",{className:"mx_SpaceRoomView_preview_topic",ref:e=>e&&Object(u.g)(e)},m.profile.short_description),i.a.createElement("div",{className:"mx_SpaceRoomView_preview_spaceBetaPrompt"},"join"===(null===(t=m.user)||void 0===t?void 0:t.membership)?Object(o.a)("To view %(communityName)s, swap to communities in your <a>preferences</a>",{communityName:m.profile.name},{a:e=>i.a.createElement(r.a,{onClick:v,kind:"link"},e)}):Object(o.a)("To join %(communityName)s, swap to communities in your <a>preferences</a>",{communityName:m.profile.name},{a:e=>i.a.createElement(r.a,{onClick:v,kind:"link"},e)}))))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(82),a=s.n(i),o=s(91),r=s.n(o),c=s(107),l=s(93),d=s(218),h=s(84),u=s(89),m=s(115),p=s(124),g=s(85),v=s(580);Object(h.b)("Sign in with SSO");let f=Object(g.a)("views.auth.Welcome")(n=class extends a.a.PureComponent{constructor(e){super(e),p.a.instance.track("onboarding_welcome")}render(){const e=c.getComponent("structures.EmbeddedPage"),t=l.a.get().embeddedPages;let s=null;return t&&(s=t.welcomeUrl),s||(s="welcome.html"),a.a.createElement(d.a,null,a.a.createElement("div",{className:r()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!u.b.getValue(m.b.Registration)})},a.a.createElement(e,{className:"mx_WelcomePage",url:s,replaceMap:{"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas"}}),a.a.createElement(v.a,null)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(251),l=s(280),d=s(97),h=s(84),u=s(88),m=s(93),p=s(101),g=s(176),v=s(177),f=s(160),b=s(85),y=s(1);let E=Object(b.a)("views.dialogs.ServerPickerDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"defaultServer",void 0),a()(this,"fieldRef",Object(o.createRef)()),a()(this,"validatedConf",void 0),a()(this,"onDefaultChosen",()=>{this.setState({defaultChosen:!0})}),a()(this,"onOtherChosen",()=>{this.setState({defaultChosen:!1})}),a()(this,"onHomeserverChange",e=>{this.setState({otherHomeserver:e.target.value})}),a()(this,"validate",Object(f.a)({deriveData:async({value:e})=>{let t=e.trim();if(!t.includes("://"))try{const e=await c.a.findClientConfig(t);return this.validatedConf=l.a.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){y.a.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await l.a.validateServerConfigWithStaticUrls(t),{}}catch(e){y.a.error(e);if(l.a.authComponentStateForError(e).serverErrorIsFatal){let t=Object(h.a)("Unable to validate homeserver");return e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await l.a.validateServerConfigWithStaticUrls(t,null,!0),{}}catch(e){return y.a.error(e),{error:Object(h.a)("Invalid URL")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(h.a)("Specify a homeserver")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return e}}]})),a()(this,"onHomeserverValidate",e=>this.validate(e)),a()(this,"onSubmit",async e=>{e.preventDefault();if(!await this.fieldRef.current.validate({allowEmpty:!1})&&!this.state.defaultChosen)return this.fieldRef.current.focus(),void this.fieldRef.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(this.state.defaultChosen?this.defaultServer:this.validatedConf)});const t=m.a.get();this.defaultServer=t.validated_server_config;const{serverConfig:s}=this.props;let n="";s.isDefault||(n=s.isNameResolvable&&s.hsName?s.hsName:s.hsUrl),this.state={defaultChosen:s.isDefault,otherHomeserver:n}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=Object(h.a)("Matrix.org is the biggest public homeserver in the world, so it's a good place for many."));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=r.a.createElement(v.a,{class:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),r.a.createElement(d.a,{title:this.props.title||Object(h.a)("Sign into your homeserver"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},r.a.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},r.a.createElement("p",null,Object(h.a)("We call the places where you can host your account 'homeservers'.")," ",e),r.a.createElement(g.a,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),r.a.createElement(g.a,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1},r.a.createElement(p.a,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:Object(h.a)("Other homeserver"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,id:"mx_homeserverInput"})),r.a.createElement("p",null,Object(h.a)("Use your preferred Matrix homeserver if you have one, or host your own.")),r.a.createElement(u.a,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},Object(h.a)("Continue")),r.a.createElement("h4",null,Object(h.a)("Learn more")),r.a.createElement("a",{href:"https://matrix.org/faq/#what-is-a-homeserver%3F",target:"_blank",rel:"noreferrer noopener"},Object(h.a)("About homeservers"))))}})||n},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(84);const i=/^[0-9 -.]+$/;function a(e){return i.test(e)}const o=127462-"A".charCodeAt(0),r=/^[A-Z]{2}$/,c=e=>r.test(e)?String.fromCodePoint(...e.split("").map(e=>o+e.charCodeAt(0))):"",l=[{iso2:"GB",name:Object(n.b)("United Kingdom"),prefix:"44"},{iso2:"US",name:Object(n.b)("United States"),prefix:"1"},{iso2:"AF",name:Object(n.b)("Afghanistan"),prefix:"93"},{iso2:"AX",name:Object(n.b)("Åland Islands"),prefix:"358"},{iso2:"AL",name:Object(n.b)("Albania"),prefix:"355"},{iso2:"DZ",name:Object(n.b)("Algeria"),prefix:"213"},{iso2:"AS",name:Object(n.b)("American Samoa"),prefix:"1"},{iso2:"AD",name:Object(n.b)("Andorra"),prefix:"376"},{iso2:"AO",name:Object(n.b)("Angola"),prefix:"244"},{iso2:"AI",name:Object(n.b)("Anguilla"),prefix:"1"},{iso2:"AQ",name:Object(n.b)("Antarctica"),prefix:"672"},{iso2:"AG",name:Object(n.b)("Antigua & Barbuda"),prefix:"1"},{iso2:"AR",name:Object(n.b)("Argentina"),prefix:"54"},{iso2:"AM",name:Object(n.b)("Armenia"),prefix:"374"},{iso2:"AW",name:Object(n.b)("Aruba"),prefix:"297"},{iso2:"AU",name:Object(n.b)("Australia"),prefix:"61"},{iso2:"AT",name:Object(n.b)("Austria"),prefix:"43"},{iso2:"AZ",name:Object(n.b)("Azerbaijan"),prefix:"994"},{iso2:"BS",name:Object(n.b)("Bahamas"),prefix:"1"},{iso2:"BH",name:Object(n.b)("Bahrain"),prefix:"973"},{iso2:"BD",name:Object(n.b)("Bangladesh"),prefix:"880"},{iso2:"BB",name:Object(n.b)("Barbados"),prefix:"1"},{iso2:"BY",name:Object(n.b)("Belarus"),prefix:"375"},{iso2:"BE",name:Object(n.b)("Belgium"),prefix:"32"},{iso2:"BZ",name:Object(n.b)("Belize"),prefix:"501"},{iso2:"BJ",name:Object(n.b)("Benin"),prefix:"229"},{iso2:"BM",name:Object(n.b)("Bermuda"),prefix:"1"},{iso2:"BT",name:Object(n.b)("Bhutan"),prefix:"975"},{iso2:"BO",name:Object(n.b)("Bolivia"),prefix:"591"},{iso2:"BA",name:Object(n.b)("Bosnia"),prefix:"387"},{iso2:"BW",name:Object(n.b)("Botswana"),prefix:"267"},{iso2:"BV",name:Object(n.b)("Bouvet Island"),prefix:"47"},{iso2:"BR",name:Object(n.b)("Brazil"),prefix:"55"},{iso2:"IO",name:Object(n.b)("British Indian Ocean Territory"),prefix:"246"},{iso2:"VG",name:Object(n.b)("British Virgin Islands"),prefix:"1"},{iso2:"BN",name:Object(n.b)("Brunei"),prefix:"673"},{iso2:"BG",name:Object(n.b)("Bulgaria"),prefix:"359"},{iso2:"BF",name:Object(n.b)("Burkina Faso"),prefix:"226"},{iso2:"BI",name:Object(n.b)("Burundi"),prefix:"257"},{iso2:"KH",name:Object(n.b)("Cambodia"),prefix:"855"},{iso2:"CM",name:Object(n.b)("Cameroon"),prefix:"237"},{iso2:"CA",name:Object(n.b)("Canada"),prefix:"1"},{iso2:"CV",name:Object(n.b)("Cape Verde"),prefix:"238"},{iso2:"BQ",name:Object(n.b)("Caribbean Netherlands"),prefix:"599"},{iso2:"KY",name:Object(n.b)("Cayman Islands"),prefix:"1"},{iso2:"CF",name:Object(n.b)("Central African Republic"),prefix:"236"},{iso2:"TD",name:Object(n.b)("Chad"),prefix:"235"},{iso2:"CL",name:Object(n.b)("Chile"),prefix:"56"},{iso2:"CN",name:Object(n.b)("China"),prefix:"86"},{iso2:"CX",name:Object(n.b)("Christmas Island"),prefix:"61"},{iso2:"CC",name:Object(n.b)("Cocos (Keeling) Islands"),prefix:"61"},{iso2:"CO",name:Object(n.b)("Colombia"),prefix:"57"},{iso2:"KM",name:Object(n.b)("Comoros"),prefix:"269"},{iso2:"CG",name:Object(n.b)("Congo - Brazzaville"),prefix:"242"},{iso2:"CD",name:Object(n.b)("Congo - Kinshasa"),prefix:"243"},{iso2:"CK",name:Object(n.b)("Cook Islands"),prefix:"682"},{iso2:"CR",name:Object(n.b)("Costa Rica"),prefix:"506"},{iso2:"HR",name:Object(n.b)("Croatia"),prefix:"385"},{iso2:"CU",name:Object(n.b)("Cuba"),prefix:"53"},{iso2:"CW",name:Object(n.b)("Curaçao"),prefix:"599"},{iso2:"CY",name:Object(n.b)("Cyprus"),prefix:"357"},{iso2:"CZ",name:Object(n.b)("Czech Republic"),prefix:"420"},{iso2:"CI",name:Object(n.b)("Côte d’Ivoire"),prefix:"225"},{iso2:"DK",name:Object(n.b)("Denmark"),prefix:"45"},{iso2:"DJ",name:Object(n.b)("Djibouti"),prefix:"253"},{iso2:"DM",name:Object(n.b)("Dominica"),prefix:"1"},{iso2:"DO",name:Object(n.b)("Dominican Republic"),prefix:"1"},{iso2:"EC",name:Object(n.b)("Ecuador"),prefix:"593"},{iso2:"EG",name:Object(n.b)("Egypt"),prefix:"20"},{iso2:"SV",name:Object(n.b)("El Salvador"),prefix:"503"},{iso2:"GQ",name:Object(n.b)("Equatorial Guinea"),prefix:"240"},{iso2:"ER",name:Object(n.b)("Eritrea"),prefix:"291"},{iso2:"EE",name:Object(n.b)("Estonia"),prefix:"372"},{iso2:"ET",name:Object(n.b)("Ethiopia"),prefix:"251"},{iso2:"FK",name:Object(n.b)("Falkland Islands"),prefix:"500"},{iso2:"FO",name:Object(n.b)("Faroe Islands"),prefix:"298"},{iso2:"FJ",name:Object(n.b)("Fiji"),prefix:"679"},{iso2:"FI",name:Object(n.b)("Finland"),prefix:"358"},{iso2:"FR",name:Object(n.b)("France"),prefix:"33"},{iso2:"GF",name:Object(n.b)("French Guiana"),prefix:"594"},{iso2:"PF",name:Object(n.b)("French Polynesia"),prefix:"689"},{iso2:"TF",name:Object(n.b)("French Southern Territories"),prefix:"262"},{iso2:"GA",name:Object(n.b)("Gabon"),prefix:"241"},{iso2:"GM",name:Object(n.b)("Gambia"),prefix:"220"},{iso2:"GE",name:Object(n.b)("Georgia"),prefix:"995"},{iso2:"DE",name:Object(n.b)("Germany"),prefix:"49"},{iso2:"GH",name:Object(n.b)("Ghana"),prefix:"233"},{iso2:"GI",name:Object(n.b)("Gibraltar"),prefix:"350"},{iso2:"GR",name:Object(n.b)("Greece"),prefix:"30"},{iso2:"GL",name:Object(n.b)("Greenland"),prefix:"299"},{iso2:"GD",name:Object(n.b)("Grenada"),prefix:"1"},{iso2:"GP",name:Object(n.b)("Guadeloupe"),prefix:"590"},{iso2:"GU",name:Object(n.b)("Guam"),prefix:"1"},{iso2:"GT",name:Object(n.b)("Guatemala"),prefix:"502"},{iso2:"GG",name:Object(n.b)("Guernsey"),prefix:"44"},{iso2:"GN",name:Object(n.b)("Guinea"),prefix:"224"},{iso2:"GW",name:Object(n.b)("Guinea-Bissau"),prefix:"245"},{iso2:"GY",name:Object(n.b)("Guyana"),prefix:"592"},{iso2:"HT",name:Object(n.b)("Haiti"),prefix:"509"},{iso2:"HM",name:Object(n.b)("Heard & McDonald Islands"),prefix:"672"},{iso2:"HN",name:Object(n.b)("Honduras"),prefix:"504"},{iso2:"HK",name:Object(n.b)("Hong Kong"),prefix:"852"},{iso2:"HU",name:Object(n.b)("Hungary"),prefix:"36"},{iso2:"IS",name:Object(n.b)("Iceland"),prefix:"354"},{iso2:"IN",name:Object(n.b)("India"),prefix:"91"},{iso2:"ID",name:Object(n.b)("Indonesia"),prefix:"62"},{iso2:"IR",name:Object(n.b)("Iran"),prefix:"98"},{iso2:"IQ",name:Object(n.b)("Iraq"),prefix:"964"},{iso2:"IE",name:Object(n.b)("Ireland"),prefix:"353"},{iso2:"IM",name:Object(n.b)("Isle of Man"),prefix:"44"},{iso2:"IL",name:Object(n.b)("Israel"),prefix:"972"},{iso2:"IT",name:Object(n.b)("Italy"),prefix:"39"},{iso2:"JM",name:Object(n.b)("Jamaica"),prefix:"1"},{iso2:"JP",name:Object(n.b)("Japan"),prefix:"81"},{iso2:"JE",name:Object(n.b)("Jersey"),prefix:"44"},{iso2:"JO",name:Object(n.b)("Jordan"),prefix:"962"},{iso2:"KZ",name:Object(n.b)("Kazakhstan"),prefix:"7"},{iso2:"KE",name:Object(n.b)("Kenya"),prefix:"254"},{iso2:"KI",name:Object(n.b)("Kiribati"),prefix:"686"},{iso2:"XK",name:Object(n.b)("Kosovo"),prefix:"383"},{iso2:"KW",name:Object(n.b)("Kuwait"),prefix:"965"},{iso2:"KG",name:Object(n.b)("Kyrgyzstan"),prefix:"996"},{iso2:"LA",name:Object(n.b)("Laos"),prefix:"856"},{iso2:"LV",name:Object(n.b)("Latvia"),prefix:"371"},{iso2:"LB",name:Object(n.b)("Lebanon"),prefix:"961"},{iso2:"LS",name:Object(n.b)("Lesotho"),prefix:"266"},{iso2:"LR",name:Object(n.b)("Liberia"),prefix:"231"},{iso2:"LY",name:Object(n.b)("Libya"),prefix:"218"},{iso2:"LI",name:Object(n.b)("Liechtenstein"),prefix:"423"},{iso2:"LT",name:Object(n.b)("Lithuania"),prefix:"370"},{iso2:"LU",name:Object(n.b)("Luxembourg"),prefix:"352"},{iso2:"MO",name:Object(n.b)("Macau"),prefix:"853"},{iso2:"MK",name:Object(n.b)("Macedonia"),prefix:"389"},{iso2:"MG",name:Object(n.b)("Madagascar"),prefix:"261"},{iso2:"MW",name:Object(n.b)("Malawi"),prefix:"265"},{iso2:"MY",name:Object(n.b)("Malaysia"),prefix:"60"},{iso2:"MV",name:Object(n.b)("Maldives"),prefix:"960"},{iso2:"ML",name:Object(n.b)("Mali"),prefix:"223"},{iso2:"MT",name:Object(n.b)("Malta"),prefix:"356"},{iso2:"MH",name:Object(n.b)("Marshall Islands"),prefix:"692"},{iso2:"MQ",name:Object(n.b)("Martinique"),prefix:"596"},{iso2:"MR",name:Object(n.b)("Mauritania"),prefix:"222"},{iso2:"MU",name:Object(n.b)("Mauritius"),prefix:"230"},{iso2:"YT",name:Object(n.b)("Mayotte"),prefix:"262"},{iso2:"MX",name:Object(n.b)("Mexico"),prefix:"52"},{iso2:"FM",name:Object(n.b)("Micronesia"),prefix:"691"},{iso2:"MD",name:Object(n.b)("Moldova"),prefix:"373"},{iso2:"MC",name:Object(n.b)("Monaco"),prefix:"377"},{iso2:"MN",name:Object(n.b)("Mongolia"),prefix:"976"},{iso2:"ME",name:Object(n.b)("Montenegro"),prefix:"382"},{iso2:"MS",name:Object(n.b)("Montserrat"),prefix:"1"},{iso2:"MA",name:Object(n.b)("Morocco"),prefix:"212"},{iso2:"MZ",name:Object(n.b)("Mozambique"),prefix:"258"},{iso2:"MM",name:Object(n.b)("Myanmar"),prefix:"95"},{iso2:"NA",name:Object(n.b)("Namibia"),prefix:"264"},{iso2:"NR",name:Object(n.b)("Nauru"),prefix:"674"},{iso2:"NP",name:Object(n.b)("Nepal"),prefix:"977"},{iso2:"NL",name:Object(n.b)("Netherlands"),prefix:"31"},{iso2:"NC",name:Object(n.b)("New Caledonia"),prefix:"687"},{iso2:"NZ",name:Object(n.b)("New Zealand"),prefix:"64"},{iso2:"NI",name:Object(n.b)("Nicaragua"),prefix:"505"},{iso2:"NE",name:Object(n.b)("Niger"),prefix:"227"},{iso2:"NG",name:Object(n.b)("Nigeria"),prefix:"234"},{iso2:"NU",name:Object(n.b)("Niue"),prefix:"683"},{iso2:"NF",name:Object(n.b)("Norfolk Island"),prefix:"672"},{iso2:"KP",name:Object(n.b)("North Korea"),prefix:"850"},{iso2:"MP",name:Object(n.b)("Northern Mariana Islands"),prefix:"1"},{iso2:"NO",name:Object(n.b)("Norway"),prefix:"47"},{iso2:"OM",name:Object(n.b)("Oman"),prefix:"968"},{iso2:"PK",name:Object(n.b)("Pakistan"),prefix:"92"},{iso2:"PW",name:Object(n.b)("Palau"),prefix:"680"},{iso2:"PS",name:Object(n.b)("Palestine"),prefix:"970"},{iso2:"PA",name:Object(n.b)("Panama"),prefix:"507"},{iso2:"PG",name:Object(n.b)("Papua New Guinea"),prefix:"675"},{iso2:"PY",name:Object(n.b)("Paraguay"),prefix:"595"},{iso2:"PE",name:Object(n.b)("Peru"),prefix:"51"},{iso2:"PH",name:Object(n.b)("Philippines"),prefix:"63"},{iso2:"PN",name:Object(n.b)("Pitcairn Islands"),prefix:"870"},{iso2:"PL",name:Object(n.b)("Poland"),prefix:"48"},{iso2:"PT",name:Object(n.b)("Portugal"),prefix:"351"},{iso2:"PR",name:Object(n.b)("Puerto Rico"),prefix:"1"},{iso2:"QA",name:Object(n.b)("Qatar"),prefix:"974"},{iso2:"RO",name:Object(n.b)("Romania"),prefix:"40"},{iso2:"RU",name:Object(n.b)("Russia"),prefix:"7"},{iso2:"RW",name:Object(n.b)("Rwanda"),prefix:"250"},{iso2:"RE",name:Object(n.b)("Réunion"),prefix:"262"},{iso2:"WS",name:Object(n.b)("Samoa"),prefix:"685"},{iso2:"SM",name:Object(n.b)("San Marino"),prefix:"378"},{iso2:"SA",name:Object(n.b)("Saudi Arabia"),prefix:"966"},{iso2:"SN",name:Object(n.b)("Senegal"),prefix:"221"},{iso2:"RS",name:Object(n.b)("Serbia"),prefix:"381 p"},{iso2:"SC",name:Object(n.b)("Seychelles"),prefix:"248"},{iso2:"SL",name:Object(n.b)("Sierra Leone"),prefix:"232"},{iso2:"SG",name:Object(n.b)("Singapore"),prefix:"65"},{iso2:"SX",name:Object(n.b)("Sint Maarten"),prefix:"1"},{iso2:"SK",name:Object(n.b)("Slovakia"),prefix:"421"},{iso2:"SI",name:Object(n.b)("Slovenia"),prefix:"386"},{iso2:"SB",name:Object(n.b)("Solomon Islands"),prefix:"677"},{iso2:"SO",name:Object(n.b)("Somalia"),prefix:"252"},{iso2:"ZA",name:Object(n.b)("South Africa"),prefix:"27"},{iso2:"GS",name:Object(n.b)("South Georgia & South Sandwich Islands"),prefix:"500"},{iso2:"KR",name:Object(n.b)("South Korea"),prefix:"82"},{iso2:"SS",name:Object(n.b)("South Sudan"),prefix:"211"},{iso2:"ES",name:Object(n.b)("Spain"),prefix:"34"},{iso2:"LK",name:Object(n.b)("Sri Lanka"),prefix:"94"},{iso2:"BL",name:Object(n.b)("St. Barthélemy"),prefix:"590"},{iso2:"SH",name:Object(n.b)("St. Helena"),prefix:"290 n"},{iso2:"KN",name:Object(n.b)("St. Kitts & Nevis"),prefix:"1"},{iso2:"LC",name:Object(n.b)("St. Lucia"),prefix:"1"},{iso2:"MF",name:Object(n.b)("St. Martin"),prefix:"590"},{iso2:"PM",name:Object(n.b)("St. Pierre & Miquelon"),prefix:"508"},{iso2:"VC",name:Object(n.b)("St. Vincent & Grenadines"),prefix:"1"},{iso2:"SD",name:Object(n.b)("Sudan"),prefix:"249"},{iso2:"SR",name:Object(n.b)("Suriname"),prefix:"597"},{iso2:"SJ",name:Object(n.b)("Svalbard & Jan Mayen"),prefix:"47"},{iso2:"SZ",name:Object(n.b)("Swaziland"),prefix:"268"},{iso2:"SE",name:Object(n.b)("Sweden"),prefix:"46"},{iso2:"CH",name:Object(n.b)("Switzerland"),prefix:"41"},{iso2:"SY",name:Object(n.b)("Syria"),prefix:"963"},{iso2:"ST",name:Object(n.b)("São Tomé & Príncipe"),prefix:"239"},{iso2:"TW",name:Object(n.b)("Taiwan"),prefix:"886"},{iso2:"TJ",name:Object(n.b)("Tajikistan"),prefix:"992"},{iso2:"TZ",name:Object(n.b)("Tanzania"),prefix:"255"},{iso2:"TH",name:Object(n.b)("Thailand"),prefix:"66"},{iso2:"TL",name:Object(n.b)("Timor-Leste"),prefix:"670"},{iso2:"TG",name:Object(n.b)("Togo"),prefix:"228"},{iso2:"TK",name:Object(n.b)("Tokelau"),prefix:"690"},{iso2:"TO",name:Object(n.b)("Tonga"),prefix:"676"},{iso2:"TT",name:Object(n.b)("Trinidad & Tobago"),prefix:"1"},{iso2:"TN",name:Object(n.b)("Tunisia"),prefix:"216"},{iso2:"TR",name:Object(n.b)("Turkey"),prefix:"90"},{iso2:"TM",name:Object(n.b)("Turkmenistan"),prefix:"993"},{iso2:"TC",name:Object(n.b)("Turks & Caicos Islands"),prefix:"1"},{iso2:"TV",name:Object(n.b)("Tuvalu"),prefix:"688"},{iso2:"VI",name:Object(n.b)("U.S. Virgin Islands"),prefix:"1"},{iso2:"UG",name:Object(n.b)("Uganda"),prefix:"256"},{iso2:"UA",name:Object(n.b)("Ukraine"),prefix:"380"},{iso2:"AE",name:Object(n.b)("United Arab Emirates"),prefix:"971"},{iso2:"UY",name:Object(n.b)("Uruguay"),prefix:"598"},{iso2:"UZ",name:Object(n.b)("Uzbekistan"),prefix:"998"},{iso2:"VU",name:Object(n.b)("Vanuatu"),prefix:"678"},{iso2:"VA",name:Object(n.b)("Vatican City"),prefix:"39"},{iso2:"VE",name:Object(n.b)("Venezuela"),prefix:"58"},{iso2:"VN",name:Object(n.b)("Vietnam"),prefix:"84"},{iso2:"WF",name:Object(n.b)("Wallis & Futuna"),prefix:"681"},{iso2:"EH",name:Object(n.b)("Western Sahara"),prefix:"212"},{iso2:"YE",name:Object(n.b)("Yemen"),prefix:"967"},{iso2:"ZM",name:Object(n.b)("Zambia"),prefix:"260"},{iso2:"ZW",name:Object(n.b)("Zimbabwe"),prefix:"263"}]},function(e,t,s){"use strict";var n=s(82),i=s(84),a=s(124),o=s(97),r=s(109),c=s(334);t.a=({onFinished:e})=>{const[t,s]=Object(n.useState)(""),l=Object(n.useRef)(),d=async s=>{if(s.preventDefault(),t){if(!await l.current.validate({}))return l.current.focus(),void l.current.validate({focused:!0})}e(!0,t)};return n.createElement(o.a,{title:Object(i.a)("Continuing without email"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},n.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},n.createElement("p",null,Object(i.a)("Just a heads up, if you don't add an email and forget your password, you could <b>permanently lose access to your account</b>.",{},{b:e=>n.createElement("b",null,e)})),n.createElement("form",{onSubmit:d},n.createElement(c.a,{fieldRef:l,autoFocus:!0,label:Object(i.a)("Email (optional)"),value:t,onChange:e=>{const t=e.target;s(t.value)},onFocus:()=>a.a.instance.track("onboarding_registration_email2_focus"),onBlur:()=>a.a.instance.track("onboarding_registration_email2_blur")}))),n.createElement(r.a,{primaryButton:Object(i.a)("Continue"),onPrimaryButtonClick:d,hasCancel:!1}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n,i=s(82),a=s.n(i),o=s(85);let r=Object(o.a)("views.auth.AuthHeaderLogo")(n=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_AuthHeaderLogo"},"Matrix")}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(82),a=s.n(i),o=s(218),r=s(550),c=s(966),l=s(85);let d=Object(l.a)("structures.auth.E2eSetup")(n=class extends a.a.Component{render(){return a.a.createElement(o.a,null,a.a.createElement(r.a,null,a.a.createElement(c.a,{onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(90),h=s(217),u=s(109),m=s(97),p=s(96),g=s(242),v=s(85),f=s(1);let b=Object(v.a)("views.dialogs.security.CreateCrossSigningDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"doBootstrapUIAuth",async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)await e({type:"m.login.password",identifier:{type:"m.id.user",user:c.a.get().getUserId()},user:c.a.get().getUserId(),password:this.state.accountPassword});else if(this.props.tokenLogin)await e({});else{const t={[h.c.PHASE_PREAUTH]:{title:Object(l.a)("Use Single Sign On to continue"),body:Object(l.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(l.a)("Single Sign On"),continueKind:"primary"},[h.c.PHASE_POSTAUTH]:{title:Object(l.a)("Confirm encryption setup"),body:Object(l.a)("Click the button below to confirm setting up encryption."),continueText:Object(l.a)("Confirm"),continueKind:"primary"}},{finished:s}=d.a.createTrackedDialog("Cross-signing keys dialog","",g.a,{title:Object(l.a)("Setting up keys"),matrixClient:c.a.get(),makeRequest:e,aestheticsForStagePhases:{[h.c.LOGIN_TYPE]:t,[h.c.UNSTABLE_LOGIN_TYPE]:t}}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")}}),a()(this,"bootstrapCrossSigning",async()=>{this.setState({error:null});const e=c.a.get();try{await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this.doBootstrapUIAuth}),this.props.onFinished(!0)}catch(e){if(this.props.tokenLogin)return void this.props.onFinished(!1);this.setState({error:e}),f.a.error("Error bootstrapping cross-signing",e)}}),a()(this,"onCancel",()=>{this.props.onFinished(!1)}),this.state={error:null,canUploadKeysWithPasswordOnly:!!e.accountPassword||null,accountPassword:e.accountPassword||""},this.state.accountPassword||this.queryKeyUploadAuth()}componentDidMount(){this.bootstrapCrossSigning()}async queryKeyUploadAuth(){try{await c.a.get().uploadDeviceSigningKeys(null,{}),f.a.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!")}catch(e){if(!e.data||!e.data.flows)return void f.a.log("uploadDeviceSigningKeys advertised no flows!");const t=e.data.flows.some(e=>1===e.stages.length&&"m.login.password"===e.stages[0]);this.setState({canUploadKeysWithPasswordOnly:t})}}render(){let e;return e=this.state.error?r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("Unable to set up keys")),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement(u.a,{primaryButton:Object(l.a)("Retry"),onPrimaryButtonClick:this.bootstrapCrossSigning,onCancel:this.onCancel}))):r.a.createElement("div",null,r.a.createElement(p.a,null)),r.a.createElement(m.a,{className:"mx_CreateCrossSigningDialog",onFinished:this.props.onFinished,title:Object(l.a)("Setting up keys"),hasCancel:!1,fixedWidth:!1},r.a.createElement("div",null,e))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var n,i=s(83),a=s.n(i),o=s(156),r=s(82),c=s.n(r),l=s(84),d=s(307),h=s(280),u=s(91),m=s.n(u),p=s(294),g=s(86),v=s(218),f=s(327),b=s(87),y=s(407),E=s(404),S=s(85),_=s(405),w=s(88),C=s(336),O=s(335),k=s(395),R=s(96),I=s(1);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let T=Object(S.a)("structures.auth.Registration")(n=class extends c.a.Component{constructor(e){super(e),a()(this,"loginLogic",void 0),a()(this,"onFormSubmit",async e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})}),a()(this,"requestEmailToken",(e,t,s,n)=>this.state.matrixClient.requestRegisterEmailToken(e,t,s,this.props.makeRegistrationUrl({client_secret:t,hs_url:this.state.matrixClient.getHomeserverUrl(),is_url:this.state.matrixClient.getIdentityServerUrl(),session_id:n}))),a()(this,"onUIAuthFinished",async(e,t)=>{if(!e){let e=t.message||t.toString();if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const s=Object(d.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(l.b)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(l.b)("This homeserver has been blocked by it's administrator."),"":Object(l.b)("This homeserver has exceeded one of its resource limits.")}),n=Object(d.a)(t.data.limit_type,t.data.admin_contact,{"":Object(l.b)("Please <a>contact your service administrator</a> to continue using this service.")});e=c.a.createElement("div",null,c.a.createElement("p",null,s),c.a.createElement("p",null,n))}else if(t.required_stages&&t.required_stages.indexOf("m.login.msisdn")>-1){let s=!1;for(const e of t.available_flows)s=s||e.stages.includes("m.login.msisdn");s||(e=Object(l.a)("This server does not support authentication with a phone number."))}else"M_USER_IN_USE"===t.errcode?e=Object(l.a)("Someone already has that username, please try another."):"M_THREEPID_IN_USE"===t.errcode&&(e=Object(l.a)("That e-mail address is already in use."));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}g.a.setJustRegisteredUserId(t.user_id);const s={doingUIAuth:!1,registeredUsername:t.user_id,differentLoggedInUserId:null,completedNoSignin:!1,busy:!0},[n,i]=await p.b();n&&!i&&n!==t.userId&&(I.a.log(`Found a session for ${n} but ${t.userId} has just registered.`),s.differentLoggedInUserId=n),t.access_token?(await this.props.onLoggedIn({userId:t.user_id,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:t.access_token},this.state.formVals.password),this.setupPushers()):(s.busy=!1,s.completedNoSignin=!0),this.setState(s)}),a()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),a()(this,"onGoToFormClicked",e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})}),a()(this,"makeRegisterRequest",e=>{let t=Boolean(this.state.formVals.email);this.state.formVals.password||(t=null);const s={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(s.auth=e),null!=t&&(s.inhibit_login=t),this.state.matrixClient.registerRequest(s)}),a()(this,"onLoginClickWithCheck",async e=>{e.preventDefault();const t=await p.h({ignoreGuest:!0});return t||this.props.onLoginClick(),t}),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""};const{hsUrl:t,isUrl:s}=this.props.serverConfig;this.loginLogic=new f.b(t,s,null,{defaultDeviceDisplayName:"Element login check"})}componentDidMount(){this.replaceClient(this.props.serverConfig)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(e.serverConfig)}async replaceClient(e){this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{await h.a.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(e){if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({busy:!1},h.a.authComponentStateForError(e,"register"))),this.state.serverErrorIsFatal)return}const{hsUrl:t,isUrl:s}=e,n=Object(o.createClient)({baseUrl:t,idBaseUrl:s});let i;this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(s);try{i=(await this.loginLogic.getFlows()).find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type)}catch(e){I.a.error("Failed to get login flows to check for SSO support",e)}this.setState({matrixClient:n,ssoFlow:i,busy:!1});const r=e=>{this.setState({errorText:Object(l.a)("Unable to query for supported registration methods."),flows:[]})};try{this.state.doingUIAuth||(await this.makeRegisterRequest(null),I.a.log("Expecting 401 from register request but got success!"))}catch(e){401===e.httpStatus?this.setState({flows:e.data.flows}):403===e.httpStatus||"M_FORBIDDEN"===e.errcode?i?b.a.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:Object(l.a)("Registration has been disabled on this homeserver."),flows:[]}):(I.a.log("Unable to query for supported registration methods.",e),r())}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=g.a.get();return e.getPushers().then(t=>{const s=t.pushers;for(let t=0;t<s.length;++t)if("email"===s[t].kind){const n=s[t];n.data={brand:this.props.brand},e.setPusher(n).then(()=>{I.a.log("Set email branding to "+this.props.brand)},e=>{I.a.error("Couldn't set email branding: "+e)})}},e=>{I.a.error("Couldn't get pushers: "+e)})}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return c.a.createElement(k.b,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return c.a.createElement("div",{className:"mx_AuthBody_spinner"},c.a.createElement(R.a,null));if(this.state.flows.length){let e;if(this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=c.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(l.a)("Continue with %(ssoButtons)s",{ssoButtons:""}).trim())),e=c.a.createElement(c.a.Fragment,null,t,c.a.createElement(y.a,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin}),c.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(l.a)("%(ssoButtons)s Or %(usernamePassword)s",{ssoButtons:"",usernamePassword:""}).trim()))}return c.a.createElement(c.a.Fragment,null,e,c.a.createElement(_.b,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient}))}}render(){let e;const t=this.state.errorText;let s;if(t&&(e=c.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=m()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});s=c.a.createElement("div",{className:e},this.state.serverDeadError)}const n=c.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(l.a)("Already have an account? <a>Sign in here</a>",{},{a:e=>c.a.createElement("a",{onClick:this.onLoginClick,href:"#"},e)}));let i,a;if(this.state.doingUIAuth&&(i=c.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked,href:"#"},Object(l.a)("Go back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?c.a.createElement("div",null,c.a.createElement("p",null,Object(l.a)("Your new account (%(newAccountId)s) is registered, but you're already logged into a different account (%(loggedInUserId)s).",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),c.a.createElement("p",null,c.a.createElement(w.a,{element:"span",className:"mx_linkButton",onClick:async e=>{await this.onLoginClickWithCheck(e)&&b.a.dispatch({action:"view_welcome_page"})}},Object(l.a)("Continue with previous account")))):this.state.formVals.password?c.a.createElement("h3",null,Object(l.a)("<a>Log in</a> to your new account.",{},{a:e=>c.a.createElement("a",{href:"#/login",onClick:this.onLoginClickWithCheck},e)})):c.a.createElement("h3",null,Object(l.a)("You can now close this window or <a>log in</a> to your new account.",{},{a:e=>c.a.createElement("a",{href:"#/login",onClick:this.onLoginClickWithCheck},e)})),a=c.a.createElement("div",null,c.a.createElement("h2",null,Object(l.a)("Registration Successful")),e)}else a=c.a.createElement("div",null,c.a.createElement("h2",null,Object(l.a)("Create account")),e,s,c.a.createElement(E.a,{title:Object(l.a)("Host account on"),dialogTitle:Object(l.a)("Decide where your account is hosted"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange}),this.renderRegisterComponent(),i,n);return c.a.createElement(v.a,null,c.a.createElement(O.a,null),c.a.createElement(C.a,null,a))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(327),d=s(93),h=s(307),u=s(280),m=s(91),p=s.n(m),g=s(218),v=s(121),f=s(89),b=s(115),y=s(124),E=s(969),S=s(145),_=s(96),w=s(407),C=s(404),O=s(85),k=s(336),R=s(335),I=s(1);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function T(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}Object(c.b)("Invalid homeserver discovery response"),Object(c.b)("Failed to get autodiscovery configuration from server"),Object(c.b)("Invalid base_url for m.homeserver"),Object(c.b)("Homeserver URL does not appear to be a valid Matrix homeserver"),Object(c.b)("Invalid identity server discovery response"),Object(c.b)("Invalid base_url for m.identity_server"),Object(c.b)("Identity server URL does not appear to be a valid identity server"),Object(c.b)("General failure");let j=Object(O.a)("structures.auth.LoginComponent")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"unmounted",!1),a()(this,"loginLogic",void 0),a()(this,"stepRendererMap",void 0),a()(this,"isBusy",()=>this.state.busy||this.props.busy),a()(this,"onPasswordLogin",async(e,t,s,n)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await u.a.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const s=u.a.authComponentStateForError(t);this.setState(T({busy:!1,busyLoggingIn:!1},s)),e=!s.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,s,n).then(e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)},t=>{if(this.unmounted)return;let s;const n=e.indexOf("@")>0;if(400===t.httpStatus&&n)s=Object(c.a)("This homeserver does not support login using email address.");else if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const e=Object(h.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(c.b)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(c.b)("This homeserver has been blocked by it's administrator."),"":Object(c.b)("This homeserver has exceeded one of its resource limits.")}),n=Object(h.a)(t.data.limit_type,t.data.admin_contact,{"":Object(c.b)("Please <a>contact your service administrator</a> to continue using this service.")});s=r.a.createElement("div",null,r.a.createElement("div",null,e),r.a.createElement("div",{className:"mx_Login_smallError"},n))}else s=401===t.httpStatus||403===t.httpStatus?"M_USER_DEACTIVATED"===t.errcode?Object(c.a)("This account has been deactivated."):d.a.get().disable_custom_urls?r.a.createElement("div",null,r.a.createElement("div",null,Object(c.a)("Incorrect username and/or password.")),r.a.createElement("div",{className:"mx_Login_smallError"},Object(c.a)("Please note you are logging into the %(hs)s server, not matrix.org.",{hs:this.props.serverConfig.hsName}))):Object(c.a)("Incorrect username and/or password."):this.errorTextFromError(t);this.setState({busy:!1,busyLoggingIn:!1,errorText:s,loginIncorrect:401===t.httpStatus||403===t.httpStatus})})}),a()(this,"onUsernameChanged",e=>{this.setState({username:e})}),a()(this,"onUsernameBlur",async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await u.a.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){I.a.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=Object(c.a)("Failed to perform homeserver discovery");e.translatedMessage&&(t=e.translatedMessage);let s=t,n={};u.a.isLivelinessError(e)&&(s=this.state.errorText,n=u.a.authComponentStateForError(e)),this.setState(T({busy:!1,errorText:s},n))}}}),a()(this,"onPhoneCountryChanged",e=>{this.setState({phoneCountry:e})}),a()(this,"onPhoneNumberChanged",e=>{this.setState({phoneNumber:e})}),a()(this,"onRegisterClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()}),a()(this,"onTryRegisterClick",e=>{var t,s;const n=null===(t=this.state.flows)||void 0===t?void 0:t.find(e=>"m.login.password"===e.type),i=null===(s=this.state.flows)||void 0===s?void 0:s.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type);if(i&&!n){e.preventDefault(),e.stopPropagation();const t="m.login.sso"===i.type?"sso":"cas";v.a.get().startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin)}else this.onRegisterClick(e)}),a()(this,"isSupportedFlow",e=>!!this.stepRendererMap[e.type]||(I.a.log("Skipping flow",e,"due to unsupported login type",e.type),!1)),a()(this,"renderPasswordStep",()=>r.a.createElement(E.a,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn})),a()(this,"renderSsoStep",e=>{const t=this.state.flows.find(t=>t.type==="m.login."+e);return r.a.createElement(w.a,{matrixClient:this.loginLogic.createTemporaryClient(),flow:t,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)})}),this.state={busy:!1,busyLoggingIn:null,errorText:null,loginIncorrect:!1,canTryLogin:!0,flows:null,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:null,phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso")},y.a.instance.track("onboarding_login_begin")}UNSAFE_componentWillMount(){this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.initLoginLogic(e.serverConfig)}async initLoginLogic({hsUrl:e,isUrl:t}){let s=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(s=!0);const n=s?this.props.fallbackHsUrl:null,i=new l.b(e,t,n,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName});this.loginLogic=i,this.setState({busy:!0,loginIncorrect:!1});try{const{warning:s}=await u.a.validateServerConfigWithStaticUrls(e,t);s?this.setState(T(T({},u.a.authComponentStateForError(s)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(T({busy:!1},u.a.authComponentStateForError(e)))}i.getFlows().then(e=>{const t=e.filter(this.isSupportedFlow);t.length>0?this.setState({flows:t}):this.setState({errorText:Object(c.a)("This homeserver doesn't offer any login flows which are supported by this client.")})},e=>{this.setState({errorText:this.errorTextFromError(e),loginIncorrect:!1,canTryLogin:!1})}).finally(()=>{this.setState({busy:!1})})}errorTextFromError(e){let t=e.errcode;!t&&e.httpStatus&&(t="HTTP "+e.httpStatus);let s=Object(c.a)("There was a problem communicating with the homeserver, please try again later.")+(t?" ("+t+")":"");return"rejected"===e.cors&&(s="https:"!==window.location.protocol||!this.props.serverConfig.hsUrl.startsWith("http:")&&this.props.serverConfig.hsUrl.startsWith("http")?r.a.createElement("span",null,Object(c.a)("Can't connect to homeserver - please check your connectivity, ensure your <a>homeserver's SSL certificate</a> is trusted, and that a browser extension is not blocking requests.",{},{a:e=>r.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:this.props.serverConfig.hsUrl},e)})):r.a.createElement("span",null,Object(c.a)("Can't connect to homeserver via HTTP when an HTTPS URL is in your browser bar. Either use HTTPS or <a>enable unsafe scripts</a>.",{},{a:e=>r.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://www.google.com/search?&q=enable%20unsafe%20scripts"},e)}))),s}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=["m.login.password","m.login.sso"].map(e=>this.state.flows.find(t=>t.type===e)).filter(Boolean);return r.a.createElement(r.a.Fragment,null,e.map(e=>{const t=this.stepRendererMap[e.type];return r.a.createElement(r.a.Fragment,{key:e.type},t())}))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?r.a.createElement("div",{className:"mx_Login_loader"},r.a.createElement(_.a,null)):null,t=this.state.errorText;let s,n,i;if(t&&(s=r.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=p()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=r.a.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?i=r.a.createElement("div",{className:"mx_AuthBody_paddedFooter"},r.a.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},r.a.createElement(S.a,{w:20,h:20}),this.props.isSyncing?Object(c.a)("Syncing..."):Object(c.a)("Signing In...")),this.props.isSyncing&&r.a.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},Object(c.a)("If you've joined lots of rooms, this might take a while"))):f.b.getValue(b.b.Registration)&&(i=r.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(c.a)("New? <a>Create account</a>",{},{a:e=>r.a.createElement("a",{onClick:this.onTryRegisterClick,href:"#"},e)}))),r.a.createElement(g.a,null,r.a.createElement(R.a,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),r.a.createElement(k.a,null,r.a.createElement("h2",null,Object(c.a)("Sign in"),e),s,n,r.a.createElement(C.a,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),this.renderLoginComponentForFlows(),i))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(84),m=s(93),p=s(88),g=s(124),v=s(160),f=s(101),b=s(406),y=s(85),E=s(334);const S=/^[0-9()\-\s]*$/;var _;!function(e){e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_phone"}(_||(_={}));let w=Object(y.a)("views.auth.PasswordLogin")((a=i=class extends l.a.PureComponent{constructor(e){super(e),r()(this,"onForgotPasswordClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onForgotPasswordClick()}),r()(this,"onSubmitForm",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return void g.a.instance.track("onboarding_registration_submit_failed");let t="",s=null,n=null;switch(this.state.loginType){case _.Email:case _.MatrixId:t=this.props.username;break;case _.Phone:s=this.props.phoneCountry,n=this.props.phoneNumber}this.props.onSubmit(t,s,n,this.state.password)}),r()(this,"onUsernameChanged",e=>{this.props.onUsernameChanged(e.target.value)}),r()(this,"onUsernameFocus",()=>{this.state.loginType===_.MatrixId?g.a.instance.track("onboarding_login_mxid_focus"):g.a.instance.track("onboarding_login_email_focus")}),r()(this,"onUsernameBlur",e=>{this.state.loginType===_.MatrixId?g.a.instance.track("onboarding_login_mxid_blur"):g.a.instance.track("onboarding_login_email_blur"),this.props.onUsernameBlur(e.target.value)}),r()(this,"onLoginTypeChange",e=>{const t=e.target.value;this.setState({loginType:t}),this.props.onUsernameChanged(""),g.a.instance.track("onboarding_login_type_changed",{loginType:t})}),r()(this,"onPhoneCountryChanged",e=>{this.props.onPhoneCountryChanged(e.iso2)}),r()(this,"onPhoneNumberChanged",e=>{this.props.onPhoneNumberChanged(e.target.value)}),r()(this,"onPhoneNumberFocus",()=>{g.a.instance.track("onboarding_login_phone_number_focus")}),r()(this,"onPhoneNumberBlur",e=>{g.a.instance.track("onboarding_login_phone_number_blur")}),r()(this,"onPasswordChanged",e=>{this.setState({password:e.target.value})}),r()(this,"validateUsernameRules",Object(v.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(u.a)("Enter username")}]})),r()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(_.MatrixId,t.valid),t}),r()(this,"onEmailValidate",e=>{this.markFieldValid(_.Email,e.valid)}),r()(this,"validatePhoneNumberRules",Object(v.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(u.a)("Enter phone number")},{key:"number",test:({value:e})=>!e||S.test(e),invalid:()=>Object(u.a)("That phone number doesn't look quite right, please check and try again")}]})),r()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(_.Password,t.valid),t}),r()(this,"validatePasswordRules",Object(v.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(u.a)("Enter password")}]})),r()(this,"onPasswordValidate",async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(_.Password,t.valid),t}),this.state={fieldValid:{},loginType:_.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,_.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}renderLoginField(e,t){const s={error:!1};switch(e){case _.Email:return s.error=this.props.loginIncorrect&&!this.props.username,l.a.createElement(E.a,{className:h()(s),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onFocus:this.onUsernameFocus,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>this[_.Email]=e});case _.MatrixId:return s.error=this.props.loginIncorrect&&!this.props.username,l.a.createElement(f.a,{className:h()(s),name:"username",autoComplete:"username",key:"username_input",type:"text",label:Object(u.a)("Username"),placeholder:Object(u.a)("Username").toLocaleLowerCase(),value:this.props.username,onChange:this.onUsernameChanged,onFocus:this.onUsernameFocus,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>this[_.MatrixId]=e});case _.Phone:{s.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=l.a.createElement(b.a,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return l.a.createElement(f.a,{className:h()(s),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:Object(u.a)("Phone"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,onFocus:this.onPhoneNumberFocus,onBlur:this.onPhoneNumberBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>this[_.Password]=e})}}}isLoginEmpty(){switch(this.state.loginType){case _.Email:case _.MatrixId:return!this.props.username;case _.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=l.a.createElement(p.a,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},Object(u.a)("Forgot password?")));const t=h()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),s=!this.isLoginEmpty(),n=this.renderLoginField(this.state.loginType,!s);let i;return m.a.get().disable_3pid_login||(i=l.a.createElement("div",{className:"mx_Login_type_container"},l.a.createElement("label",{className:"mx_Login_type_label"},Object(u.a)("Sign in with")),l.a.createElement(f.a,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.disableSubmit},l.a.createElement("option",{key:_.MatrixId,value:_.MatrixId},Object(u.a)("Username")),l.a.createElement("option",{key:_.Email,value:_.Email},Object(u.a)("Email address")),l.a.createElement("option",{key:_.Password,value:_.Password},Object(u.a)("Phone"))))),l.a.createElement("div",null,l.a.createElement("form",{onSubmit:this.onSubmitForm},i,n,l.a.createElement(f.a,{className:t,autoComplete:"password",type:"password",name:"password",label:Object(u.a)("Password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.disableSubmit,autoFocus:s,onValidate:this.onPasswordValidate,ref:e=>this[_.Password]=e}),e,!this.props.busy&&l.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(u.a)("Sign in"),disabled:this.props.disableSubmit})))}},r()(i,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(122),h=s(515),u=s(87),m=s(146),p=s(90),g=s(179),v=s(92),f=s(85),b=s(393),y=s(1);let E=Object(f.a)("views.toasts.VerificationRequestToast")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"intervalHandle",void 0),a()(this,"checkRequestIsPending",()=>{const{request:e}=this.props;e.canAccept||m.a.sharedInstance().dismissToast(this.props.toastKey)}),a()(this,"cancel",()=>{m.a.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){y.a.error("Error while cancelling verification request",e)}}),a()(this,"accept",async()=>{m.a.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=l.a.get();try{e.channel.roomId?(u.a.dispatch({action:v.a.ViewRoom,room_id:e.channel.roomId,should_peek:!1}),u.a.dispatch({action:v.a.SetRightPanelPhase,phase:d.c.EncryptionPanel,refireParams:{verificationRequest:e,member:t.getUser(e.otherUserId)}})):p.a.createTrackedDialog("Incoming Verification","",b.a,{verificationRequest:e,onFinished:()=>{e.cancel()}},null,!1,!0),await e.accept()}catch(e){y.a.error(e.message)}}),this.state={counter:Math.ceil(e.request.timeout/1e3)}}async componentDidMount(){const{request:e}=this.props;if(e.timeout&&e.timeout>0&&(this.intervalHandle=setInterval(()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})},1e3)),e.on("change",this.checkRequestIsPending),this.checkRequestIsPending(),e.isSelfVerification){const t=l.a.get(),s=(await t.getDevice(e.channel.deviceId)).last_seen_ip;this.setState({device:t.getStoredDevice(t.getUserId(),e.channel.deviceId),ip:s})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off("change",this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,s;if(e.isSelfVerification)this.state.device&&(t=this.state.device.getDisplayName(),s=Object(c.a)("%(deviceId)s from %(ip)s",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const s=e.otherUserId,n=e.channel.roomId;if(t=n?Object(h.b)(s,n):s,t===s){const e=l.a.get().getUser(s);e&&e.displayName&&(t=Object(c.a)("%(name)s (%(userId)s)",{name:e.displayName,userId:s}))}}const n=0===this.state.counter?Object(c.a)("Decline"):Object(c.a)("Decline (%(counter)s)",{counter:this.state.counter});return r.a.createElement(g.a,{description:t,detail:s,acceptLabel:Object(c.a)("Accept"),onAccept:this.accept,rejectLabel:n,onReject:this.cancel})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(87),d=s(294),h=s(90),u=s(86),m=s(327),p=s(218),g=s(279),v=s(407),f=s(85),b=s(973),y=s(101),E=s(88),S=s(96),_=s(335),w=s(336),C=s(1);const O=1,k=2,R=3,I=4,x=5,T={"m.login.password":k,"m.login.cas":R,"m.login.sso":I};let j=Object(f.a)("structures.auth.SoftLogout")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onClearAll",()=>{h.a.createTrackedDialog("Clear Data","Soft Logout",b.a,{onFinished:e=>{e&&(C.a.log("Clearing data from soft-logged-out session"),d.i())}})}),a()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),a()(this,"onForgotPassword",()=>{l.a.dispatch({action:"start_password_recovery"})}),a()(this,"onPasswordLogin",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const t=u.a.get().getHomeserverUrl(),s=u.a.get().getIdentityServerUrl(),n={identifier:{type:"m.id.user",user:u.a.get().getUserId()},password:this.state.password,device_id:u.a.get().getDeviceId()};let i=null;try{i=await Object(m.c)(t,s,"m.login.password",n)}catch(e){let t=Object(c.a)("Failed to re-authenticate due to a homeserver problem");return"M_FORBIDDEN"!==e.errcode||401!==e.httpStatus&&403!==e.httpStatus||(t=Object(c.a)("Incorrect password")),void this.setState({busy:!1,errorText:t})}d.e(i).catch(e=>{C.a.error(e),this.setState({busy:!1,errorText:Object(c.a)("Failed to re-authenticate")})})}),this.state={loginView:O,keyBackupNeeded:!0,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){if(!d.g())return void l.a.dispatch({action:"start_login"});this.initLogin();const e=u.a.get();e.isCryptoEnabled()&&e.countSessionsNeedingBackup().then(e=>{this.setState({keyBackupNeeded:e>0})})}async initLogin(){const e=this.props.realQueryParams;if(e&&e.loginToken)return this.setState({loginView:O}),void this.trySsoLogin();const t=u.a.get(),s=(await t.loginFlows()).flows,n=s.map(e=>T[e.type]).filter(e=>!!e)[0]||x;this.setState({flows:s,loginView:n})}async trySsoLogin(){this.setState({busy:!0});const e=localStorage.getItem(g.a),t=localStorage.getItem(g.c)||u.a.get().getIdentityServerUrl(),s={token:this.props.realQueryParams.loginToken,device_id:u.a.get().getDeviceId()};let n=null;try{n=await Object(m.c)(e,t,"m.login.token",s)}catch(e){return C.a.error(e),void this.setState({busy:!1,loginView:x})}d.e(n).then(()=>{this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted()}).catch(e=>{C.a.error(e),this.setState({busy:!1,loginView:x})})}renderSignInSection(){if(this.state.loginView===O)return r.a.createElement(S.a,null);let e=null;if(this.state.keyBackupNeeded&&(e=Object(c.a)("Regain access to your account and recover encryption keys stored in this session. Without them, you won't be able to read all of your secure messages in any session.")),this.state.loginView===k){let t=null;return this.state.errorText&&(t=r.a.createElement("span",{className:"mx_Login_error"},this.state.errorText)),e||(e=Object(c.a)("Enter your password to sign in and regain access to your account.")),r.a.createElement("form",{onSubmit:this.onPasswordLogin},r.a.createElement("p",null,e),t,r.a.createElement(y.a,{type:"password",label:Object(c.a)("Password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),r.a.createElement(E.a,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},Object(c.a)("Sign In")),r.a.createElement(E.a,{onClick:this.onForgotPassword,kind:"link"},Object(c.a)("Forgotten your password?")))}if(this.state.loginView===I||this.state.loginView===R){e||(e=Object(c.a)("Sign in and regain access to your account."));const t=this.state.loginView===R?"cas":"sso",s=this.state.flows.find(e=>e.type==="m.login."+t);return r.a.createElement("div",null,r.a.createElement("p",null,e),r.a.createElement(v.a,{matrixClient:u.a.get(),flow:s,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)}))}return r.a.createElement("p",null,Object(c.a)("You cannot sign in to your account. Please contact your homeserver admin for more information."))}render(){return r.a.createElement(p.a,null,r.a.createElement(_.a,null),r.a.createElement(w.a,null,r.a.createElement("h2",null,Object(c.a)("You're signed out")),r.a.createElement("h3",null,Object(c.a)("Sign in")),r.a.createElement("div",null,this.renderSignInSection()),r.a.createElement("h3",null,Object(c.a)("Clear personal data")),r.a.createElement("p",null,Object(c.a)("Warning: Your personal data (including encryption keys) is still stored in this session. Clear it if you're finished using this session, or want to sign in to another account.")),r.a.createElement("div",null,r.a.createElement(E.a,{onClick:this.onClearAll,kind:"danger"},Object(c.a)("Clear all data")))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(82),i=s.n(n),a=s(340),o=s.n(a),r=s(84),c=s(113),l=s(96);const d=["vector-im/element-web","matrix-org/matrix-react-sdk","matrix-org/matrix-js-sdk"];class h extends i.a.Component{constructor(e){super(e),this.state={}}componentDidMount(){const e=this.props.newVersion.split("-"),t=this.props.version.split("-");if(null!=e&&null!=t)for(let s=0;s<d.length;s++){const n=t[2*s],i=e[2*s],a=`https://riot.im/github/repos/${d[s]}/compare/${n}...${i}`;o()(a,(e,t,n)=>{t.statusCode<200||t.statusCode>=300?this.setState({[d[s]]:t.statusText}):this.setState({[d[s]]:JSON.parse(n).commits})})}}elementsForCommit(e){return i.a.createElement("li",{key:e.sha,className:"mx_ChangelogDialog_li"},i.a.createElement("a",{href:e.html_url,target:"_blank",rel:"noreferrer noopener"},e.commit.message.split("\n")[0]))}render(){const e=d.map(e=>{let t;return t=null==this.state[e]?i.a.createElement(l.a,{key:e}):"string"==typeof this.state[e]?Object(r.a)("Unable to load commit detail: %(msg)s",{msg:this.state[e]}):this.state[e].map(this.elementsForCommit),i.a.createElement("div",{key:e},i.a.createElement("h2",null,e),i.a.createElement("ul",null,t))}),t=i.a.createElement("div",{className:"mx_ChangelogDialog_content"},null==this.props.version||null==this.props.newVersion?i.a.createElement("h2",null,Object(r.a)("Unavailable")):e);return i.a.createElement(c.a,{title:Object(r.a)("Changelog"),description:t,button:Object(r.a)("Update"),onFinished:this.props.onFinished})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(85),d=s(97),h=s(109);let u=Object(l.a)("views.dialogs.ConfirmWipeDeviceDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onConfirm",()=>{this.props.onFinished(!0)}),a()(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){return r.a.createElement(d.a,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Clear all data in this session?")},r.a.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},r.a.createElement("p",null,Object(c.a)("Clearing all data from this session is permanent. Encrypted messages will be lost unless their keys have been backed up."))),r.a.createElement(h.a,{primaryButton:Object(c.a)("Clear all data"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.onDecline}))}})||n},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(113),o=s(84),r=s(93);t.a=e=>{const t=r.a.get().brand,s=Object(o.a)("%(brand)s now uses 3-5x less memory, by only loading information about other users when needed. Please wait whilst we resynchronise with the server!",{brand:t});return i.a.createElement(a.a,{hasCancelButton:!1,title:Object(o.a)("Updating %(brand)s",{brand:t}),description:i.a.createElement("div",null,s),button:Object(o.a)("OK"),onFinished:e.onFinished})}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(113),o=s(84),r=s(93);t.a=e=>{const t=r.a.get().brand,s=Object(o.a)("You've previously used %(brand)s on %(host)s with lazy loading of members enabled. In this version lazy loading is disabled. As the local cache is not compatible between these two settings, %(brand)s needs to resync your account.",{brand:t,host:e.host}),n=Object(o.a)("If the other version of %(brand)s is still open in another tab, please close it as using %(brand)s on the same host with both lazy loading enabled and disabled simultaneously will cause issues.",{brand:t});return i.a.createElement(a.a,{hasCancelButton:!1,title:Object(o.a)("Incompatible local cache"),description:i.a.createElement("div",null,i.a.createElement("p",null,s),i.a.createElement("p",null,n)),button:Object(o.a)("Clear cache and resync"),onFinished:e.onFinished})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(93),l=s(90),d=s(84),h=s(85),u=s(113),m=s(200),p=s(97),g=s(109);let v=Object(h.a)("views.dialogs.SessionRestoreErrorDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"sendBugReport",()=>{l.a.createTrackedDialog("Session Restore Error","Send Bug Report Dialog",m.a,{error:this.props.error})}),a()(this,"onClearStorageClick",()=>{l.a.createTrackedDialog("Session Restore Confirm Logout","",u.a,{title:Object(d.a)("Sign out"),description:r.a.createElement("div",null,Object(d.a)("Sign out and remove encryption keys?")),button:Object(d.a)("Sign out"),danger:!0,onFinished:this.props.onFinished})}),a()(this,"onRefreshClick",()=>{window.location.reload()})}render(){const e=c.a.get().brand,t=r.a.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},Object(d.a)("Clear Storage and Sign Out"));let s;return s=c.a.get().bug_report_endpoint_url?r.a.createElement(g.a,{primaryButton:Object(d.a)("Send Logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):r.a.createElement(g.a,{primaryButton:Object(d.a)("Refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),r.a.createElement(p.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(d.a)("Unable to restore session"),contentId:"mx_Dialog_content",hasCancel:!1},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},r.a.createElement("p",null,Object(d.a)("We encountered an error trying to restore your previous session.")),r.a.createElement("p",null,Object(d.a)("If you have previously used a more recent version of %(brand)s, your session may be incompatible with this version. Close this window and return to the more recent version.",{brand:e})),r.a.createElement("p",null,Object(d.a)("Clearing your browser's storage may fix the problem, but will sign you out and cause any encrypted chat history to become unreadable."))),s)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(93),l=s(90),d=s(84),h=s(85),u=s(97),m=s(109),p=s(200);let g=Object(h.a)("views.dialogs.StorageEvictedDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"sendBugReport",e=>{e.preventDefault(),l.a.createTrackedDialog("Storage evicted","Send Bug Report Dialog",p.a,{})}),a()(this,"onSignOutClick",()=>{this.props.onFinished(!0)})}render(){let e;return c.a.get().bug_report_endpoint_url&&(e=Object(d.a)("To help us prevent this in future, please <a>send us logs</a>.",{},{a:e=>r.a.createElement("a",{href:"#",onClick:this.sendBugReport},e)})),r.a.createElement(u.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(d.a)("Missing session data"),contentId:"mx_Dialog_content",hasCancel:!1},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},r.a.createElement("p",null,Object(d.a)("Some session data, including encrypted message keys, is missing. Sign out and sign in to fix this, restoring keys from backup.")),r.a.createElement("p",null,Object(d.a)("Your browser likely removed this data when running low on disk space.")," ",e)),r.a.createElement(m.a,{primaryButton:Object(d.a)("Sign out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(210);async function i(e,t){const s=e.getUserId();let{threepids:i}=await e.getThreePids();if(t&&(i=i.filter(e=>e.medium===t)),i.length>0&&e.getIdentityServerUrl())try{const a=new n.a,o=await a.getAccessToken({check:!1}),r=i.map(({medium:e,address:t})=>[e,t]),c=await e.bulkLookupThreePids(r,o);for(const[e,n,a]of c.threepids){if(a!==s)continue;if(t&&e!==t)continue;const o=i.find(t=>t.medium===e&&t.address===n);o&&(o.bound=!0)}}catch(e){if("M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return i}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(101),h=s(88),u=s(337),m=s(406),p=s(90),g=s(85),v=s(583),f=s(104),b=s(1);class y extends r.a.Component{constructor(e){super(e),a()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),a()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),a()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),l.a.get().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then(()=>this.props.onRemoved(this.props.msisdn)).catch(e=>{b.a.error("Unable to remove contact information: "+e),p.a.createTrackedDialog("Remove 3pid failed","",f.a,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?r.a.createElement("div",{className:"mx_ExistingPhoneNumber"},r.a.createElement("span",{className:"mx_ExistingPhoneNumber_promptText"},Object(c.a)("Remove %(phone)s?",{phone:this.props.msisdn.address})),r.a.createElement(h.a,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Remove")),r.a.createElement(h.a,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Cancel"))):r.a.createElement("div",{className:"mx_ExistingPhoneNumber"},r.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",this.props.msisdn.address),r.a.createElement(h.a,{onClick:this.onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}let E=Object(g.a)("views.settings.account.PhoneNumbers")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onRemoved",e=>{const t=this.props.msisdns.filter(t=>t!==e);this.props.onMsisdnsChange(t)}),a()(this,"onChangeNewPhoneNumber",e=>{this.setState({newPhoneNumber:e.target.value})}),a()(this,"onChangeNewPhoneNumberCode",e=>{this.setState({newPhoneNumberCode:e.target.value})}),a()(this,"onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=this.state.newPhoneNumber,s=this.state.phoneCountry,n=new u.a;this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addMsisdn(s,t).then(e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})}).catch(e=>{b.a.error("Unable to add phone number "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),p.a.createTrackedDialog("Add Phone Number Error","",f.a,{title:Object(c.a)("Error"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),a()(this,"onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.newPhoneNumberCode,s=this.state.verifyMsisdn;this.state.addTask.haveMsisdnToken(t).then(([e])=>{let t=this.state.newPhoneNumber;if(e){const e=[...this.props.msisdns,{address:s,medium:v.a.Phone}];this.props.onMsisdnsChange(e),t=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:t,newPhoneNumberCode:""})}).catch(e=>{this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode?(b.a.error("Unable to verify phone number: "+e),p.a.createTrackedDialog("Unable to verify phone number","",f.a,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})):this.setState({verifyError:Object(c.a)("Incorrect verification code")})})}),a()(this,"onCountryChanged",e=>{this.setState({phoneCountry:e.iso2})}),this.state={verifying:!1,verifyError:null,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map(e=>r.a.createElement(y,{msisdn:e,onRemoved:this.onRemoved,key:e.address}));let t=r.a.createElement(h.a,{onClick:this.onAddClick,kind:"primary"},Object(c.a)("Add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=r.a.createElement("div",null,r.a.createElement("div",null,Object(c.a)("A text message has been sent to +%(msisdn)s. Please enter the verification code it contains.",{msisdn:e}),r.a.createElement("br",null),this.state.verifyError),r.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},r.a.createElement(d.a,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this.onChangeNewPhoneNumberCode}),r.a.createElement(h.a,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled||0===this.state.newPhoneNumberCode.length},Object(c.a)("Continue"))))}const s=r.a.createElement(m.a,{onOptionChange:this.onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return r.a.createElement("div",{className:"mx_PhoneNumbers"},e,r.a.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},r.a.createElement("div",{className:"mx_PhoneNumbers_input"},r.a.createElement(d.a,{type:"text",label:Object(c.a)("Phone Number"),autoComplete:"off",disabled:this.state.verifying,prefixComponent:s,value:this.state.newPhoneNumber,onChange:this.onChangeNewPhoneNumber}))),t)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(101),h=s(88),u=s(231),m=s(337),p=s(90),g=s(85),v=s(104),f=s(583),b=s(1);class y extends r.a.Component{constructor(e){super(e),a()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),a()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),a()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),l.a.get().deleteThreePid(this.props.email.medium,this.props.email.address).then(()=>this.props.onRemoved(this.props.email)).catch(e=>{b.a.error("Unable to remove contact information: "+e),p.a.createTrackedDialog("Remove 3pid failed","",v.a,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?r.a.createElement("div",{className:"mx_ExistingEmailAddress"},r.a.createElement("span",{className:"mx_ExistingEmailAddress_promptText"},Object(c.a)("Remove %(email)s?",{email:this.props.email.address})),r.a.createElement(h.a,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Remove")),r.a.createElement(h.a,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Cancel"))):r.a.createElement("div",{className:"mx_ExistingEmailAddress"},r.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},this.props.email.address),r.a.createElement(h.a,{onClick:this.onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}let E=Object(g.a)("views.settings.account.EmailAddresses")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onRemoved",e=>{const t=this.props.emails.filter(t=>t!==e);this.props.onEmailsChange(t)}),a()(this,"onChangeNewEmailAddress",e=>{this.setState({newEmailAddress:e.target.value})}),a()(this,"onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=this.state.newEmailAddress;if(!u.a(t))return void p.a.createTrackedDialog("Invalid email address","",v.a,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")});const s=new m.a;this.setState({verifying:!0,continueDisabled:!0,addTask:s}),s.addEmailAddress(t).then(()=>{this.setState({continueDisabled:!1})}).catch(e=>{b.a.error("Unable to add email address "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),p.a.createTrackedDialog("Unable to add email address","",v.a,{title:Object(c.a)("Unable to add email address"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),a()(this,"onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),this.state.addTask.checkEmailLinkClicked().then(([e])=>{let t=this.state.newEmailAddress;if(e){const e=this.state.newEmailAddress,s=[...this.props.emails,{address:e,medium:f.a.Email}];this.props.onEmailsChange(s),t=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:t})}).catch(e=>{this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"===e.errcode?p.a.createTrackedDialog("Email hasn't been verified yet","",v.a,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(b.a.error("Unable to verify email address: ",e),p.a.createTrackedDialog("Unable to verify email address","",v.a,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))})}),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map(e=>r.a.createElement(y,{email:e,onRemoved:this.onRemoved,key:e.address}));let t=r.a.createElement(h.a,{onClick:this.onAddClick,kind:"primary"},Object(c.a)("Add"));return this.state.verifying&&(t=r.a.createElement("div",null,r.a.createElement("div",null,Object(c.a)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")),r.a.createElement(h.a,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(c.a)("Continue")))),r.a.createElement("div",{className:"mx_EmailAddresses"},e,r.a.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_EmailAddresses_new"},r.a.createElement(d.a,{type:"text",label:Object(c.a)("Email Address"),autoComplete:"off",disabled:this.state.verifying,value:this.state.newEmailAddress,onChange:this.onChangeNewEmailAddress}),t))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(90),h=s(337),u=s(85),m=s(104),p=s(88),g=s(1);class v extends r.a.Component{constructor(e){super(e),a()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for email address")})}),a()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share email address")})}),a()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{await this.state.addTask.checkEmailLinkClicked(),this.setState({addTask:null,continueDisabled:!1,verifying:!1})}catch(e){this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"===e.errcode?d.a.createTrackedDialog("E-mail hasn't been verified yet","",m.a,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(g.a.error("Unable to verify email address: "+e),d.a.createTrackedDialog("Unable to verify email address","",m.a,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))}});const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.email;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await l.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const{medium:n,address:i}=this.props.email;try{if(e){const e=new h.a;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(i),this.setState({continueDisabled:!1})}else await l.a.get().unbindThreePid(n,i);this.setState({bound:e})}catch(e){g.a.error(`Unable to ${t} email address ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),d.a.createTrackedDialog(`Unable to ${t} email address`,"",m.a,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const{medium:n,address:i}=this.props.email,a=new h.a;this.setState({verifying:!0,continueDisabled:!0,addTask:a});try{await l.a.get().deleteThreePid(n,i),e?await a.bindEmailAddress(i):await a.addEmailAddress(i),this.setState({continueDisabled:!1,bound:e})}catch(e){g.a.error(`Unable to ${t} email address ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),d.a.createTrackedDialog(`Unable to ${t} email address`,"",m.a,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const{address:e}=this.props.email,{verifying:t,bound:s}=this.state;let n;return n=t?r.a.createElement("span",null,Object(c.a)("Verify the link in your inbox"),r.a.createElement(p.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onContinueClick,disabled:this.state.continueDisabled},Object(c.a)("Complete"))):s?r.a.createElement(p.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):r.a.createElement(p.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),r.a.createElement("div",{className:"mx_ExistingEmailAddress"},r.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},e),n)}}let f=Object(u.a)("views.settings.discovery.EmailAddresses")(n=class extends r.a.Component{render(){let e;return e=this.props.emails.length>0?this.props.emails.map(e=>r.a.createElement(v,{email:e,key:e.address})):r.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added an email above.")),r.a.createElement("div",{className:"mx_EmailAddresses"},e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(90),h=s(337),u=s(85),m=s(104),p=s(101),g=s(88),v=s(1);class f extends r.a.Component{constructor(e){super(e),a()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for phone number")})}),a()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share phone number")})}),a()(this,"onVerificationCodeChange",e=>{this.setState({verificationCode:e.target.value})}),a()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{await this.state.addTask.haveMsisdnToken(t),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode?(v.a.error("Unable to verify phone number: "+e),d.a.createTrackedDialog("Unable to verify phone number","",m.a,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})):this.setState({verifyError:Object(c.a)("Incorrect verification code")})}});const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t,verifyError:null}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.msisdn;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await l.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const{medium:n,address:i}=this.props.msisdn;try{if(e){const e=new h.a;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,"+"+i),this.setState({continueDisabled:!1})}else await l.a.get().unbindThreePid(n,i);this.setState({bound:e})}catch(e){v.a.error(`Unable to ${t} phone number ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),d.a.createTrackedDialog(`Unable to ${t} phone number`,"",m.a,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const{medium:n,address:i}=this.props.msisdn,a=new h.a;this.setState({verifying:!0,continueDisabled:!0,addTask:a});try{await l.a.get().deleteThreePid(n,i),e?await a.bindMsisdn(null,"+"+i):await a.addMsisdn(null,"+"+i),this.setState({continueDisabled:!1,bound:e})}catch(e){v.a.error(`Unable to ${t} phone number ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),d.a.createTrackedDialog(`Unable to ${t} phone number`,"",m.a,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const{address:e}=this.props.msisdn,{verifying:t,bound:s}=this.state;let n;return n=t?r.a.createElement("span",{className:"mx_ExistingPhoneNumber_verification"},r.a.createElement("span",null,Object(c.a)("Please enter verification code sent via text."),r.a.createElement("br",null),this.state.verifyError),r.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},r.a.createElement(p.a,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):s?r.a.createElement(g.a,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):r.a.createElement(g.a,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),r.a.createElement("div",{className:"mx_ExistingPhoneNumber"},r.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",e),n)}}let b=Object(u.a)("views.settings.discovery.PhoneNumbers")(n=class extends r.a.Component{render(){let e;return e=this.props.msisdns.length>0?this.props.msisdns.map(e=>r.a.createElement(f,{msisdn:e,key:e.address})):r.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added a phone number above.")),r.a.createElement("div",{className:"mx_PhoneNumbers"},e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i,a,o=s(83),r=s.n(o),c=s(101),l=s(82),d=s.n(l),h=s(86),u=s(88),m=s(96),p=s(160),g=s(84),v=s(90),f=s(278),b=s(124),y=s(85),E=s(405),S=s(984),_=s(113);var w;!function(e){e.Edit="edit",e.Uploading="uploading",e.Error="error"}(w||(w={}));let C=Object(y.a)("views.settings.ChangePassword")((a=i=class extends d.a.Component{constructor(e){super(e),r()(this,"onExportE2eKeysClicked",()=>{v.a.createTrackedDialogAsync("Export E2E Keys","Change Password",s.e(5).then(s.bind(null,589)),{matrixClient:h.a.get()})}),r()(this,"onChangeOldPassword",e=>{this.setState({oldPassword:e.target.value})}),r()(this,"onOldPasswordValidate",async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid("field_old_password",t.valid),t}),r()(this,"validateOldPasswordRules",Object(p.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(g.a)("Passwords can't be empty")}]})),r()(this,"onChangeNewPassword",e=>{this.setState({newPassword:e.target.value})}),r()(this,"onNewPasswordValidate",e=>{this.markFieldValid("field_new_password",e.valid)}),r()(this,"onChangeNewPasswordConfirm",e=>{this.setState({newPasswordConfirm:e.target.value})}),r()(this,"onNewPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid("field_new_password_confirm",t.valid),t}),r()(this,"validatePasswordConfirmRules",Object(p.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(g.a)("Confirm password")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>Object(g.a)("Passwords don't match")}]})),r()(this,"onClickChange",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return void b.a.instance.track("onboarding_registration_submit_failed");const t=this.state.oldPassword,s=this.state.newPassword,n=this.state.newPasswordConfirm,i=this.checkPassword(t,s,n);i?this.props.onError(i):this.onChangePassword(t,s)}),this.state={fieldValid:{},phase:w.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}onChangePassword(e,t){const s=h.a.get();this.props.confirm?v.a.createTrackedDialog("Change Password","",_.a,{title:Object(g.a)("Warning!"),description:d.a.createElement("div",null,Object(g.a)("Changing password will currently reset any end-to-end encryption keys on all sessions, making encrypted chat history unreadable, unless you first export your room keys and re-import them afterwards. In future this will be improved.")," ",d.a.createElement("a",{href:"https://github.com/vector-im/element-web/issues/2671",target:"_blank",rel:"noreferrer noopener"},"https://github.com/vector-im/element-web/issues/2671")),button:Object(g.a)("Continue"),extraButtons:[d.a.createElement("button",{key:"exportRoomKeys",className:"mx_Dialog_primary",onClick:this.onExportE2eKeysClicked},Object(g.a)("Export E2E room keys"))],onFinished:n=>{n&&this.changePassword(s,e,t)}}):this.changePassword(s,e,t)}changePassword(e,t,s){const n={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},user:e.credentials.userId,password:t};this.setState({phase:w.Uploading}),e.setPassword(n,s).then(()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then(e=>{this.props.onFinished({didSetEmail:e})});this.props.onFinished()},e=>{this.props.onError(e)}).finally(()=>{this.setState({phase:w.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})})}checkPassword(e,t,s){return t!==s?{error:Object(g.a)("New passwords don't match")}:t&&0!==t.length?void 0:{error:Object(g.a)("Passwords can't be empty")}}optionallySetEmail(){return v.a.createTrackedDialog("Do you want to set an email address?","",S.a,{title:Object(g.a)("Do you want to set an email address?")}).finished.then(([e])=>e)}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=["field_old_password","field_new_password","field_new_password_confirm"];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case w.Edit:return d.a.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},d.a.createElement("div",{className:e},d.a.createElement(c.a,{ref:e=>this.field_old_password=e,type:"password",label:Object(g.a)("Current password"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),d.a.createElement("div",{className:e},d.a.createElement(f.a,{fieldRef:e=>this.field_new_password=e,type:"password",label:"New Password",minScore:E.a,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),d.a.createElement("div",{className:e},d.a.createElement(c.a,{ref:e=>this.field_new_password_confirm=e,type:"password",label:Object(g.a)("Confirm password"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),d.a.createElement(u.a,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||Object(g.a)("Change Password")));case w.Uploading:return d.a.createElement("div",{className:"mx_Dialog_content"},d.a.createElement(m.a,null))}}},r()(i,"defaultProps",{onFinished(){},onError(){},confirm:!0}),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(231),l=s(337),d=s(84),h=s(90),u=s(85),m=s(96),p=s(104),g=s(113),v=s(97),f=s(584),b=s(1);let y=Object(u.a)("views.dialogs.SetEmailDialog")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"addThreepid",void 0),a()(this,"onEmailAddressChanged",e=>{this.setState({emailAddress:e})}),a()(this,"onSubmit",()=>{const e=this.state.emailAddress;c.a(e)?(this.addThreepid=new l.a,this.addThreepid.addEmailAddress(e).then(()=>{h.a.createTrackedDialog("Verification Pending","",g.a,{title:Object(d.a)("Verification Pending"),description:Object(d.a)("Please check your email and click on the link it contains. Once this is done, click continue."),button:Object(d.a)("Continue"),onFinished:this.onEmailDialogFinished})},t=>{this.setState({emailBusy:!1}),b.a.error("Unable to add email address "+e+" "+t),h.a.createTrackedDialog("Unable to add email address","",p.a,{title:Object(d.a)("Unable to add email address"),description:t&&t.message?t.message:Object(d.a)("Operation failed")})}),this.setState({emailBusy:!0})):h.a.createTrackedDialog("Invalid Email Address","",p.a,{title:Object(d.a)("Invalid Email Address"),description:Object(d.a)("This doesn't appear to be a valid email address")})}),a()(this,"onCancelled",()=>{this.props.onFinished(!1)}),a()(this,"onEmailDialogFinished",e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})}),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){this.addThreepid.checkEmailLinkClicked().then(()=>{this.props.onFinished(!0)},e=>{if(this.setState({emailBusy:!1}),"M_THREEPID_AUTH_FAILED"==e.errcode){const e=Object(d.a)("Unable to verify email address.")+" "+Object(d.a)("Please check your email and click on the link it contains. Once this is done, click continue.");h.a.createTrackedDialog("Verification Pending","3pid Auth Failed",g.a,{title:Object(d.a)("Verification Pending"),description:e,button:Object(d.a)("Continue"),onFinished:this.onEmailDialogFinished})}else b.a.error("Unable to verify email address: "+e),h.a.createTrackedDialog("Unable to verify email address","",p.a,{title:Object(d.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(d.a)("Operation failed")})})}render(){const e=this.state.emailBusy?r.a.createElement(m.a,null):r.a.createElement(f.a,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:Object(d.a)("Email address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return r.a.createElement(v.a,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("p",{id:"mx_Dialog_content"},Object(d.a)("This will allow you to reset your password and receive notifications.")),e),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(d.a)("Continue"),onClick:this.onSubmit}),r.a.createElement("input",{type:"submit",value:Object(d.a)("Skip"),onClick:this.onCancelled})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(144),d=s(137),h=s(85),u=s(88);let m=Object(h.a)("views.terms.InlineTermsAgreement")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"togglePolicy",e=>{const t=Object(l.a)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})}),a()(this,"onContinue",()=>{!!this.state.policies.some(e=>!e.checked)||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map(e=>e.url)))}),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const s=Object.values(t.policies);for(const t of s){const s=Object(c.i)(Object.keys(t).filter(e=>"version"!==e)),n={checked:!1,url:t[s].url,name:t[s].name};e.push(n)}}this.setState({policies:e})}renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const s=this.state.policies[t],n=Object(c.a)("Accept <policyLink /> to continue:",{},{policyLink:()=>r.a.createElement("a",{href:s.url,rel:"noreferrer noopener",target:"_blank"},s.name,r.a.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(r.a.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},r.a.createElement("div",null,n),r.a.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},r.a.createElement(d.b,{onChange:()=>this.togglePolicy(t),checked:s.checked},Object(c.a)("Accept")))))}return e}render(){const e=!!this.state.policies.some(e=>!e.checked);return r.a.createElement("div",null,this.props.introElement,this.renderCheckboxes(),r.a.createElement(u.a,{onClick:this.onContinue,disabled:e||this.state.busy,kind:"primary_sm"},Object(c.a)("Continue")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i=s(83),a=s.n(i),o=s(189),r=s.n(o),c=s(82),l=s.n(c),d=s(84),h=s(86),u=s(90),m=s(87),p=s(978),g=s(210),v=s(256),f=s(296),b=s(370),y=s(85),E=s(145),S=s(88),_=s(101),w=s(113),C=s(1);let O=Object(y.a)("views.settings.SetIdServer")(n=class extends l.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"onAction",e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:h.a.get().getIdentityServerUrl()})}),a()(this,"onIdentityServerChanged",e=>{const t=e.target.value;this.setState({idServer:t})}),a()(this,"getTooltip",()=>this.state.checking?l.a.createElement("div",null,l.a.createElement(E.a,null),Object(d.a)("Checking server")):this.state.error?l.a.createElement("span",{className:"warning"},this.state.error):null),a()(this,"idServerChangeEnabled",()=>!!this.state.idServer&&!this.state.busy),a()(this,"saveIdServer",e=>{h.a.get().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:null,currentClientIdServer:e,idServer:""})}),a()(this,"checkIdServer",async e=>{e.preventDefault();const{idServer:t,currentClientIdServer:s}=this.state;this.setState({busy:!0,checking:!0,error:null});const n=Object(v.b)(t);let i=await async function(e){if("https:"!==r.a.parse(e).protocol)return Object(d.a)("Identity server URL must be HTTPS");try{const t=await fetch(e+"/_matrix/identity/api/v1");return t.ok?null:t.status<200||t.status>=300?Object(d.a)("Not a valid identity server (status code %(code)s)",{code:t.status}):Object(d.a)("Could not connect to identity server")}catch(e){return Object(d.a)("Could not connect to identity server")}}(n);if(!i)try{this.setState({checking:!1});const e=new g.a(n);await e.getAccessToken();let i=!0;if(!await Object(f.b)(n)){const[e]=await this.showNoTermsWarning(n);i=e}if(i&&s&&n!==s){const[e]=await this.showServerChangeWarning({title:Object(d.a)("Change identity server"),unboundMessage:Object(d.a)("Disconnect from the identity server <current /> and connect to <new /> instead?",{},{current:e=>l.a.createElement("b",null,Object(v.a)(s)),new:e=>l.a.createElement("b",null,Object(v.a)(t))}),button:Object(d.a)("Continue")});i=e}i&&this.saveIdServer(n)}catch(e){C.a.error(e),i=Object(d.a)("Terms of service not accepted or the identity server is invalid.")}this.setState({busy:!1,checking:!1,error:i,currentClientIdServer:h.a.get().getIdentityServerUrl()})}),a()(this,"onDisconnectClicked",async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:Object(d.a)("Disconnect identity server"),unboundMessage:Object(d.a)("Disconnect from the identity server <idserver />?",{},{idserver:e=>l.a.createElement("b",null,Object(v.a)(this.state.currentClientIdServer))}),button:Object(d.a)("Disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}}),a()(this,"disconnectIdServer",()=>{h.a.get().setAccountData("m.identity_server",{base_url:null});let e="";Object(f.c)()&&(e=Object(v.a)(Object(f.c)())),this.setState({busy:!1,error:null,currentClientIdServer:h.a.get().getIdentityServerUrl(),idServer:e})});let t="";!h.a.get().getIdentityServerUrl()&&Object(f.c)()&&(t=Object(v.a)(Object(f.c)())),this.state={defaultIdServer:t,currentClientIdServer:h.a.get().getIdentityServerUrl(),idServer:"",error:null,busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}showNoTermsWarning(e){const{finished:t}=u.a.createTrackedDialog("No Terms Warning","",w.a,{title:Object(d.a)("Identity server has no terms of service"),description:l.a.createElement("div",null,l.a.createElement("span",{className:"warning"},Object(d.a)("The identity server you have chosen does not have any terms of service.")),l.a.createElement("span",null," ",Object(d.a)("Only continue if you trust the owner of the server."))),button:Object(d.a)("Continue")});return t}async showServerChangeWarning({title:e,unboundMessage:t,button:s}){const{currentClientIdServer:n}=this.state;let i=[],a=!0;try{i=await Object(b.b)(Object(p.a)(h.a.get()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){a=!1,C.a.warn(`Unable to reach identity server at ${n} to check for 3PIDs during IS change flow`),C.a.warn(e)}const o=i.filter(e=>e.bound);let r,c=!1;const m={idserver:e=>l.a.createElement("b",null,Object(v.a)(n)),b:e=>l.a.createElement("b",null,e)};a?o.length?(r=l.a.createElement("div",null,l.a.createElement("p",null,Object(d.a)("You are still <b>sharing your personal data</b> on the identity server <idserver />.",{},m)),l.a.createElement("p",null,Object(d.a)("We recommend that you remove your email addresses and phone numbers from the identity server before disconnecting."))),c=!0,s=Object(d.a)("Disconnect anyway")):r=t:(r=l.a.createElement("div",null,l.a.createElement("p",null,Object(d.a)("You should <b>remove your personal data</b> from identity server <idserver /> before disconnecting. Unfortunately, identity server <idserver /> is currently offline or cannot be reached.",{},m)),l.a.createElement("p",null,Object(d.a)("You should:")),l.a.createElement("ul",null,l.a.createElement("li",null,Object(d.a)("check your browser plugins for anything that might block the identity server (such as Privacy Badger)")),l.a.createElement("li",null,Object(d.a)("contact the administrators of identity server <idserver />",{},{idserver:m.idserver})),l.a.createElement("li",null,Object(d.a)("wait and try again later")))),c=!0,s=Object(d.a)("Disconnect anyway"));const{finished:g}=u.a.createTrackedDialog("Identity Server Bound Warning","",w.a,{title:e,description:r,button:s,cancelButton:Object(d.a)("Go back"),danger:c});return g}render(){const e=this.state.currentClientIdServer;let t,s,n;if(e?(t=Object(d.a)("Identity server (%(server)s)",{server:Object(v.a)(e)}),s=Object(d.a)("You are currently using <server></server> to discover and be discoverable by existing contacts you know. You can change your identity server below.",{},{server:t=>l.a.createElement("b",null,Object(v.a)(e))}),this.props.missingTerms&&(s=Object(d.a)("If you don't want to use <server /> to discover and be discoverable by existing contacts you know, enter another identity server below.",{},{server:t=>l.a.createElement("b",null,Object(v.a)(e))}))):(t=Object(d.a)("Identity server"),s=Object(d.a)("You are not currently using an identity server. To discover and be discoverable by existing contacts you know, add one below.")),e){let e=Object(d.a)("Disconnect"),t=Object(d.a)("Disconnecting from your identity server will mean you won't be discoverable by other users and you won't be able to invite others by email or phone.");this.props.missingTerms&&(t=Object(d.a)("Using an identity server is optional. If you choose not to use an identity server, you won't be discoverable by other users and you won't be able to invite others by email or phone."),e=Object(d.a)("Do not use an identity server")),this.state.disconnectBusy&&(e=l.a.createElement(E.a,null)),n=l.a.createElement("div",null,l.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},t),l.a.createElement(S.a,{onClick:this.onDisconnectClicked,kind:"danger_sm"},e))}return l.a.createElement("form",{className:"mx_SettingsTab_section mx_SetIdServer",onSubmit:this.checkIdServer},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},t),l.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},s),l.a.createElement(_.a,{label:Object(d.a)("Enter a new identity server"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this.onIdentityServerChanged,tooltipContent:this.getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&null}),l.a.createElement(S.a,{type:"submit",kind:"primary_sm",onClick:this.checkIdServer,disabled:!this.idServerChangeEnabled()},Object(d.a)("Change")),n)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(201),d=s(89),h=s(100),u=s(85),m=s(322),p=s(1);let g=Object(u.a)("views.settings.SetIntegrationManager")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onProvisioningToggled",()=>{const e=this.state.provisioningEnabled;d.b.setValue("integrationProvisioning",null,h.a.ACCOUNT,!e).catch(t=>{p.a.error("Error changing integration manager provisioning"),p.a.error(t),this.setState({provisioningEnabled:e})}),this.setState({provisioningEnabled:!e})});const t=l.a.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:d.b.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,s;return e?(t=`(${e.name})`,s=Object(c.a)("Use an integration manager <b>(%(serverName)s)</b> to manage bots, widgets, and sticker packs.",{serverName:e.name},{b:e=>r.a.createElement("b",null,e)})):s=Object(c.a)("Use an integration manager to manage bots, widgets, and sticker packs."),r.a.createElement("div",{className:"mx_SetIntegrationManager"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},r.a.createElement("span",null,Object(c.a)("Manage integrations")),r.a.createElement("span",{className:"mx_SettingsTab_subheading"},t),r.a.createElement(m.a,{checked:this.state.provisioningEnabled,disabled:!1,onChange:this.onProvisioningToggled})),r.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},s,r.a.createElement("br",null),r.a.createElement("br",null),Object(c.a)("Integration managers receive configuration data, and can modify widgets, send room invites, and set power levels on your behalf.")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(112),l=s(84),d=s(89),h=s(187),u=s(100),m=s(85),p=s(93),g=s(326),v=s(172),f=s(86),b=s(593),y=s(378);class E extends r.a.Component{constructor(...e){super(...e),a()(this,"onChange",async e=>{await d.b.setValue(this.props.featureId,null,u.a.DEVICE,e),this.forceUpdate()})}render(){const e=d.b.getDisplayName(this.props.featureId),t=d.b.getValue(this.props.featureId),s=d.b.canSetValue(this.props.featureId,null,u.a.DEVICE);return r.a.createElement(h.a,{value:t,label:e,onChange:this.onChange,disabled:!s})}}let S=Object(m.a)("views.settings.tabs.user.LabsUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),f.a.get().doesServerSupportUnstableFeature("org.matrix.msc2285").then(e=>{this.setState({showHiddenReadReceipts:e})}),this.state={showHiddenReadReceipts:!1}}render(){const e=d.b.getFeatureSettingNames(),[t,s]=e.reduce((e,t)=>(e[d.b.getBetaInfo(t)?1:0].push(t),e),[[],[]]);let n,i;if(s.length&&(n=r.a.createElement("div",{className:"mx_SettingsTab_section"},s.map(e=>r.a.createElement(g.b,{key:e,featureId:e})))),p.a.get().showLabsSettings){const e=new y.a;t.forEach(t=>{e.getOrCreate(d.b.getLabGroup(t),[]).push(r.a.createElement(E,{featureId:t,key:t}))}),e.get(b.a.Widgets).push(r.a.createElement(v.a,{name:"enableWidgetScreenshots",level:u.a.ACCOUNT})),e.get(b.a.Experimental).push(r.a.createElement(v.a,{name:"lowBandwidth",level:u.a.DEVICE})),e.getOrCreate(b.a.Developer,[]).push(r.a.createElement(v.a,{name:"developerMode",level:u.a.ACCOUNT}),r.a.createElement(v.a,{name:"showHiddenEventsInTimeline",level:u.a.DEVICE})),e.get(b.a.Analytics).push(r.a.createElement(v.a,{name:"automaticErrorReporting",level:u.a.DEVICE})),this.state.showHiddenReadReceipts&&e.get(b.a.Messaging).push(r.a.createElement(v.a,{name:"feature_hidden_read_receipts",level:u.a.DEVICE})),i=r.a.createElement("div",{className:"mx_SettingsTab_section"},Object(c.sortBy)(Array.from(e.entries()),"0").map(([e,t])=>r.a.createElement("div",{key:e},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)(b.c[e])),t)))}return r.a.createElement("div",{className:"mx_SettingsTab mx_LabsUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Labs")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Feeling experimental? Labs are the best way to get things early, test out new features and help shape them before they actually launch. <a>Learn more</a>.",{},{a:e=>r.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),n,i)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(93),d=s(86),h=s(89),u=s(172),m=s(100),p=s(85),g=s(990),v=s(176),f=s(381),b=s(992),y=s(562),E=s(994);let S=Object(p.a)("views.settings.tabs.user.AppearanceUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"MESSAGE_PREVIEW_TEXT",Object(c.a)("Hey you. You're the best!")),a()(this,"unmounted",!1),a()(this,"onRoomListStyleChange",e=>{const t=e.target.value;this.setState({roomListStyle:t}),h.b.setValue("roomListStyle",null,m.a.DEVICE,t)}),a()(this,"onLayoutChanged",e=>{this.setState({layout:e})}),this.state={lightTheme:h.b.getValue("light_theme"),darkTheme:h.b.getValue("dark_theme"),themeInUse:h.b.getValue("theme_in_use"),roomListStyle:h.b.getValue("roomListStyle"),layout:h.b.getValue("layout"),userId:null,displayName:null,avatarUrl:null}}async componentDidMount(){const e=d.a.get(),t=e.getUserId(),s=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:s.displayname,avatarUrl:s.avatar_url})}componentWillUnmount(){this.unmounted=!0}renderRoomListSection(){const e=r.a.createElement("div",{className:"mx_SettingsTab_multilineRadioSelectors"},r.a.createElement("label",null,r.a.createElement(v.a,{name:"room_list_style",value:f.a.Compact,checked:this.state.roomListStyle===f.a.Compact,onChange:this.onRoomListStyleChange},Object(c.a)("Compact: tiny avatar together with name and preview in one line"))),r.a.createElement("label",null,r.a.createElement(v.a,{name:"room_list_style",value:f.a.Intermediate,checked:this.state.roomListStyle===f.a.Intermediate,onChange:this.onRoomListStyleChange},Object(c.a)("Intermediate: medium sized avatar with single-line preview"))),r.a.createElement("label",null,r.a.createElement(v.a,{name:"room_list_style",value:f.a.Roomy,checked:this.state.roomListStyle===f.a.Roomy,onChange:this.onRoomListStyleChange},Object(c.a)("Roomy: big avatar with two-line preview"))));return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Room list")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_fontScaling"},r.a.createElement(u.a,{name:"unifiedRoomList",level:m.a.DEVICE,useCheckbox:!0})),r.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_RoomListStyleSection"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room list style")),e))}render(){const e=l.a.get().brand,t=r.a.createElement(g.a,{userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl,messagePreviewText:this.MESSAGE_PREVIEW_TEXT,onLayoutChanged:this.onLayoutChanged});return r.a.createElement("div",{className:"mx_SettingsTab mx_AppearanceUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Customise your appearance")),r.a.createElement("div",{className:"mx_SettingsTab_SubHeading"},Object(c.a)("Appearance Settings only affect this %(brand)s session.",{brand:e})),r.a.createElement(y.a,null),this.renderRoomListSection(),t,r.a.createElement(b.a,null),r.a.createElement(E.a,null))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(89),d=s(991),h=s(176),u=s(84),m=s(133),p=s(100),g=s(172);class v extends o.a.Component{constructor(e){super(e),i()(this,"onLayoutChange",e=>{const t=e.target.value;this.setState({layout:t}),l.b.setValue("layout",null,p.a.DEVICE,t),this.props.onLayoutChanged(t)}),this.state={layout:l.b.getValue("layout"),adaptiveSideBubbles:l.b.getValue("adaptiveSideBubbles")}}render(){const e=c()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==m.a.IRC}),t=c()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==m.a.Group}),s=c()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout===m.a.Bubble});return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(u.a)("Message layout")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_LayoutSwitcher"},o.a.createElement("div",{className:"mx_LayoutSwitcher_RadioButtons"},o.a.createElement("label",{className:e},o.a.createElement(d.a,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:m.a.IRC,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(h.a,{name:"layout",value:m.a.IRC,checked:this.state.layout===m.a.IRC,onChange:this.onLayoutChange},Object(u.a)("IRC"))),o.a.createElement("label",{className:t},o.a.createElement(d.a,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:m.a.Group,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(h.a,{name:"layout",value:m.a.Group,checked:this.state.layout==m.a.Group,onChange:this.onLayoutChange},Object(u.a)("Modern"))),o.a.createElement("label",{className:s},o.a.createElement(d.a,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:m.a.Bubble,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(h.a,{name:"layout",value:m.a.Bubble,checked:this.state.layout==m.a.Bubble,onChange:this.onLayoutChange},Object(u.a)("Message bubbles")))),o.a.createElement("div",{className:"mx_LayoutSwitcher_Checkboxes"},this.state.layout===m.a.Group?o.a.createElement(g.a,{name:"useCompactLayout",level:p.a.DEVICE,useCheckbox:!0}):null,this.state.layout===m.a.Bubble?o.a.createElement(g.a,{name:"singleSideBubbles",level:p.a.DEVICE,useCheckbox:!0,disabled:this.state.adaptiveSideBubbles}):null,this.state.layout===m.a.Bubble?o.a.createElement(g.a,{name:"adaptiveSideBubbles",level:p.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({adaptiveSideBubbles:e})}):null)))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(82),a=s.n(i),o=s(91),r=s.n(o),c=s(117),l=s(199),d=s(134),h=s(89),u=s(133),m=s(115),p=s(85),g=s(96);let v=Object(p.a)("views.elements.EventTilePreview")(n=class extends a.a.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent({message:e}){const t={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:"m.text",body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:"m.text",body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},s=new c.b(t);return s.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:(...e)=>l.c({avatarUrl:this.props.avatarUrl},32,32,"crop"),getMxcAvatarUrl:()=>this.props.avatarUrl},s}render(){const e=r()(this.props.className,{mx_IRCLayout:this.props.layout==u.a.IRC,mx_GroupLayout:this.props.layout==u.a.Group,sc_BubbleLayout:this.props.layout==u.a.Bubble,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return a.a.createElement("div",{className:e},a.a.createElement(g.a,null));const t=this.fakeEvent(this.state);return a.a.createElement("div",{className:e},a.a.createElement(d.b,{mxEvent:t,layout:this.props.layout,enableFlair:h.b.getValue(m.b.Flair),as:"div"}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(83),a=s.n(i),o=s(101),r=s(82),c=s.n(r),l=s(172),d=s(89),h=s(993),u=s(823),m=s(86),p=s(100),g=s(84),v=s(85),f=s(93);let b=Object(v.a)("views.settings.tabs.user.FontScalingPanel")(n=class extends c.a.Component{constructor(e){super(e),a()(this,"MESSAGE_PREVIEW_TEXT",Object(g.a)("Hey you. You're the best!")),a()(this,"unmounted",!1),a()(this,"onFontSizeChanged",e=>{this.setState({fontSize:e.toString()}),d.b.setValue("baseFontSize",null,p.a.DEVICE,e-u.a.SIZE_DIFF)}),a()(this,"onValidateFontSize",async({value:e})=>{const t=parseFloat(e),s=u.a.MIN_SIZE+u.a.SIZE_DIFF,n=u.a.MAX_SIZE+u.a.SIZE_DIFF;return isNaN(t)?{valid:!1,feedback:Object(g.a)("Size must be a number")}:s<=t&&t<=n?(d.b.setValue("baseFontSize",null,p.a.DEVICE,parseInt(e,10)-u.a.SIZE_DIFF),{valid:!0,feedback:Object(g.a)("Use between %(min)s pt and %(max)s pt",{min:s,max:n})}):{valid:!1,feedback:Object(g.a)("Custom font size can only be between %(min)s pt and %(max)s pt",{min:s,max:n})}}),this.state={fontSize:(d.b.getValue("baseFontSize",null)+u.a.SIZE_DIFF).toString(),useCustomFontSize:d.b.getValue("useCustomFontSize"),layout:d.b.getValue("layout"),userId:null,displayName:null,avatarUrl:null,useSystemFont:d.b.getValue("useSystemFont"),systemFont:d.b.getValue("systemFont")}}async componentDidMount(){const e=m.a.get(),t=e.getUserId(),s=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:s.displayname,avatarUrl:s.avatar_url})}componentWillUnmount(){this.unmounted=!0}render(){const e=f.a.get().brand,t=Object(g.a)("Set the name of a font installed on your system & %(brand)s will attempt to use it.",{brand:e});return c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(g.a)("Font size and typeface")),c.a.createElement("div",{className:"mx_SettingsTab_section mx_FontScalingPanel_fontScaling"},c.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider"},c.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider_smallText"},"Aa"),c.a.createElement(h.a,{values:[13,14,15,16,18],value:parseInt(this.state.fontSize,10),onSelectionChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize}),c.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider_largeText"},"Aa")),c.a.createElement("div",{className:"mx_FontScalingPanel_inlineCustomValues"},c.a.createElement("div",null,c.a.createElement(l.a,{name:"useCustomFontSize",level:p.a.ACCOUNT,onChange:e=>this.setState({useCustomFontSize:e}),useCheckbox:!0}),c.a.createElement(o.a,{type:"number",label:Object(g.a)("Font size"),autoComplete:"off",placeholder:this.state.fontSize.toString(),value:this.state.fontSize.toString(),id:"font_size_field",onValidate:this.onValidateFontSize,onChange:e=>this.setState({fontSize:e.target.value}),disabled:!this.state.useCustomFontSize,className:"mx_FontScalingPanel_customFontSizeField"})),c.a.createElement("div",null,c.a.createElement(l.a,{name:"useSystemFont",level:p.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),c.a.createElement(o.a,{className:"mx_FontScalingPanel_systemFont",label:d.b.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),d.b.setValue("systemFont",null,p.a.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont})))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n,i=s(82),a=s(85);let o=Object(a.a)("views.elements.Slider")(n=class extends i.Component{offset(e,t){const s=e.reduce((e,s)=>t>s?e+1:e,0);if(0===s)return 0;if(s===e.length)return 100;const n=e[s-1],i=e[s],a=1/(e.length-1);return 100*(s-1+(t-n)/(i-n))*a}render(){const e=this.props.values.map(e=>i.createElement(r,{active:e<=this.props.value,label:this.props.displayFunc(e),onClick:this.props.disabled?()=>{}:()=>this.props.onSelectionChange(e),key:e,disabled:this.props.disabled}));let t=null;if(!this.props.disabled){const e=this.offset(this.props.values,this.props.value);t=i.createElement("div",{className:"mx_Slider_selection"},i.createElement("div",{className:"mx_Slider_selectionDot",style:{left:"calc(-1.195em + "+e+"%)"}},i.createElement("div",{className:"mx_Slider_selectionText"},this.props.value)),i.createElement("hr",{style:{width:e+"%"}}))}return i.createElement("div",{className:"mx_Slider"},i.createElement("div",null,i.createElement("div",{className:"mx_Slider_bar"},i.createElement("hr",{onClick:this.props.disabled?()=>{}:this.onClick.bind(this)}),t),i.createElement("div",{className:"mx_Slider_dotContainer"},e)))}onClick(e){const t=e.target.clientWidth,s=e.nativeEvent.offsetX/t,n=this.props.values[Math.round(s*(this.props.values.length-1))];this.props.onSelectionChange(n)}})||n;class r extends i.PureComponent{render(){let e="mx_Slider_dot";return!this.props.disabled&&this.props.active&&(e+=" mx_Slider_dotActive"),i.createElement("span",{onClick:this.props.onClick,className:"mx_Slider_dotValue"},i.createElement("div",{className:e}),i.createElement("div",{className:"mx_Slider_labelContainer"},i.createElement("div",{className:"mx_Slider_label"},this.props.label)))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(89),c=s(176),l=s(84),d=s(100),h=s(382);class u extends o.a.Component{constructor(e){super(e),i()(this,"onSizeChange",e=>{const t=e.target.value;this.setState({size:t}),r.b.setValue("Images.size",null,d.a.ACCOUNT,t)}),this.state={size:r.b.getValue("Images.size")}}render(){return o.a.createElement("div",{className:"mx_SettingsTab_section mx_ImageSizePanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Image size in the timeline")),o.a.createElement("div",{className:"mx_ImageSizePanel_radios"},o.a.createElement("label",null,o.a.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),o.a.createElement(c.a,{name:"image_size",value:h.a.Normal,checked:this.state.size===h.a.Normal,onChange:this.onSizeChange},Object(l.a)("Default"))),o.a.createElement("label",null,o.a.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),o.a.createElement(c.a,{name:"image_size",value:h.a.Large,checked:this.state.size===h.a.Large,onChange:this.onSizeChange},Object(l.a)("Large")))))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return N}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(4),l=s(84),d=s(93),h=s(86),u=s(88),m=s(140),p=s(87),g=s(141),v=s(100),f=s(996),b=s(89),y=s(115),E=s(997),S=s(124),_=s(85),w=s(380),C=s(998),O=s(999),k=s(172),R=s(1001),I=s(1003),x=s(145),T=s(1);class j extends r.a.Component{constructor(...e){super(...e),a()(this,"onUnignoreClicked",()=>{this.props.onUnignored(this.props.userId)})}render(){const e="mx_SecurityUserSettingsTab_ignoredUser_"+this.props.userId;return r.a.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},r.a.createElement(u.a,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},Object(l.a)("Unignore")),r.a.createElement("span",{id:e},this.props.userId))}}let N=Object(_.a)("views.settings.tabs.user.SecurityUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"onAction",({action:e})=>{if("ignore_state_changed"===e){const e=h.a.get().getIgnoredUsers(),t=this.state.waitingUnignored.filter(t=>e.includes(t));this.setState({ignoredUserIds:e,waitingUnignored:t})}}),a()(this,"updateAnalytics",e=>{e?m.a.enable():m.a.disable(),S.a.instance.enable(!e),w.a.instance.updateAnonymityFromSettings(h.a.get().getUserId())}),a()(this,"onMyMembership",(e,t)=>{e.isSpaceRoom()||("invite"===t?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))}),a()(this,"addInvitedRoom",e=>{this.setState(({invitedRoomIds:t})=>({invitedRoomIds:new Set(t).add(e.roomId)}))}),a()(this,"removeInvitedRoom",e=>{this.setState(({invitedRoomIds:t})=>{const s=new Set(t);return s.delete(e),{invitedRoomIds:s}})}),a()(this,"onGoToUserProfileClick",()=>{p.a.dispatch({action:"view_user_info",userId:h.a.get().getUserId()}),this.props.closeSettingsFn()}),a()(this,"onUserUnignored",async e=>{const{ignoredUserIds:t,waitingUnignored:s}=this.state,n=t.filter(e=>!s.includes(e)),i=n.indexOf(e);-1!==i&&(n.splice(i,1),this.setState(({waitingUnignored:t})=>({waitingUnignored:[...t,e]})),h.a.get().setIgnoredUsers(n))}),a()(this,"getInvitedRooms",()=>h.a.get().getRooms().filter(e=>e.hasMembershipState(h.a.get().getUserId(),"invite"))),a()(this,"manageInvites",async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),s=h.a.get(),n=e?s.joinRoom.bind(s):s.leave.bind(s);for(let e=0;e<t.length;e++){const s=t[e];await n(s).then(()=>{this.removeInvitedRoom(s)},async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await Object(c.I)(t.retry_after_ms||2500),e--):T.a.warn(t)})}this.setState({managingInvites:!1})}),a()(this,"onAcceptAllInvitesClicked",()=>{this.manageInvites(!0)}),a()(this,"onRejectAllInvitesClicked",()=>{this.manageInvites(!1)});const t=new Set(this.getInvitedRooms().map(e=>e.roomId));this.state={ignoredUserIds:h.a.get().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t}}componentDidMount(){this.dispatcherRef=p.a.register(this.onAction),h.a.get().on("Room.myMembership",this.onMyMembership)}componentWillUnmount(){p.a.unregister(this.dispatcherRef),h.a.get().removeListener("Room.myMembership",this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,s=null!=t&&t.length?t.map(t=>r.a.createElement(j,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)})):Object(l.a)("You have no ignored users.");return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Ignored users")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},s))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:r.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityUserSettingsTab_bulkOptions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Bulk options")),r.a.createElement(u.a,{onClick:this.onAcceptAllInvitesClicked,kind:"primary",disabled:this.state.managingInvites},Object(l.a)("Accept all %(invitedRooms)s invites",{invitedRooms:e.size})),r.a.createElement(u.a,{onClick:this.onRejectAllInvitesClicked,kind:"danger",disabled:this.state.managingInvites},Object(l.a)("Reject all %(invitedRooms)s invites",{invitedRooms:e.size})),this.state.managingInvites?r.a.createElement(x.a,null):r.a.createElement("div",null))}render(){const e=d.a.get().brand,t=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Secure Backup")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement(f.a,null))),s=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Message search")),r.a.createElement(I.a,null)),n=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Cross-signing")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement(R.a,null)));let i,a,o;if(Object(g.f)()||(i=r.a.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},Object(l.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."))),(m.a.canEnable()||S.a.instance.canEnable())&&(a=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Privacy")),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Analytics")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("%(brand)s collects anonymous analytics to allow us to improve the application.",{brand:e})," ",Object(l.a)("Privacy is important to us, so we don't collect any personal or identifiable data for our analytics."),r.a.createElement(u.a,{className:"mx_SettingsTab_linkBtn",onClick:m.a.showDetailsModal},Object(l.a)("Learn more about how we use analytics."))),r.a.createElement(k.a,{name:"analyticsOptIn",level:v.a.DEVICE,onChange:this.updateAnalytics})))),b.b.getValue(y.b.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites(),s=Object(E.b)()?r.a.createElement(E.a,null):null;(e||t||s)&&(o=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,s)))}return r.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},i,r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Where you're signed in")),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",null,Object(l.a)("Manage your signed-in devices below. A device's name is visible to people you communicate with.")),r.a.createElement(O.a,null)),r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Encryption")),r.a.createElement("div",{className:"mx_SettingsTab_section"},t,s,n,r.a.createElement(C.a,null)),a,o)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(90),h=s(268),u=s(96),m=s(88),p=s(113),g=s(275),v=s(188),f=s(85),b=s(1);let y=Object(f.a)("views.settings.SecureBackupPanel")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"unmounted",!1),a()(this,"onKeyBackupSessionsRemaining",e=>{this.setState({sessionsRemaining:e})}),a()(this,"onKeyBackupStatus",()=>{this.loadBackupStatus()}),a()(this,"startNewBackup",()=>{d.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(6).then(s.bind(null,591)),{onFinished:()=>{this.loadBackupStatus()}},null,!1,!0)}),a()(this,"deleteBackup",()=>{d.a.createTrackedDialog("Delete Backup","",p.a,{title:Object(l.a)("Delete Backup"),description:Object(l.a)("Are you sure? You will lose your encrypted messages if your keys are not backed up properly."),button:Object(l.a)("Delete Backup"),danger:!0,onFinished:e=>{e&&(this.setState({loading:!0}),c.a.get().deleteKeyBackupVersion(this.state.backupInfo.version).then(()=>{this.loadBackupStatus()}))}})}),a()(this,"restoreBackup",async()=>{d.a.createTrackedDialog("Restore Backup","",g.a,null,null,!1,!0)}),a()(this,"resetSecretStorage",async()=>{this.setState({error:null});try{await Object(v.b)(async()=>{},!0)}catch(e){if(b.a.error("Error resetting secret storage",e),this.unmounted)return;this.setState({error:e})}this.unmounted||this.loadBackupStatus()}),this.state={loading:!0,error:null,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupSigStatus:null,sessionsRemaining:0}}componentDidMount(){this.checkKeyBackupStatus(),c.a.get().on("crypto.keyBackupStatus",this.onKeyBackupStatus),c.a.get().on("crypto.keyBackupSessionsRemaining",this.onKeyBackupSessionsRemaining)}componentWillUnmount(){this.unmounted=!0,c.a.get()&&(c.a.get().removeListener("crypto.keyBackupStatus",this.onKeyBackupStatus),c.a.get().removeListener("crypto.keyBackupSessionsRemaining",this.onKeyBackupSessionsRemaining))}async checkKeyBackupStatus(){this.getUpdatedDiagnostics();try{const{backupInfo:e,trustInfo:t}=await c.a.get().checkKeyBackup();this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(b.a.log("Unable to fetch check backup status",e),this.unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async loadBackupStatus(){this.setState({loading:!0}),this.getUpdatedDiagnostics();try{const e=await c.a.get().getKeyBackupVersion(),t=await c.a.get().isKeyBackupTrusted(e);if(this.unmounted)return;this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(b.a.log("Unable to fetch key backup status",e),this.unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async getUpdatedDiagnostics(){const e=c.a.get(),t=e.crypto.secretStorage,s=!!await e.isKeyBackupKeyStored(),n=await e.crypto.getSessionBackupPrivateKey(),i=!!n,a=n instanceof Uint8Array,o=await t.hasKey(),r=await e.isSecretStorageReady();this.unmounted||this.setState({backupKeyStored:s,backupKeyCached:i,backupKeyWellFormed:a,secretStorageKeyInAccount:o,secretStorageReady:r})}render(){const{loading:e,error:t,backupKeyStored:s,backupKeyCached:n,backupKeyWellFormed:i,secretStorageKeyInAccount:a,secretStorageReady:o,backupInfo:d,backupSigStatus:p,sessionsRemaining:g}=this.state;let v,f,b;const y=[];if(t)v=r.a.createElement("div",{className:"error"},Object(l.a)("Unable to load key backup status"));else if(e)v=r.a.createElement(u.a,null);else if(d){let e,t=Object(l.a)("Restore from Backup");c.a.get().getKeyBackupEnabled()?v=r.a.createElement("p",null,"✅ ",Object(l.a)("This session is backing up your keys. ")):(v=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("This session is <b>not backing up your keys</b>, but you do have an existing backup you can restore from and add to going forward.",{},{b:e=>r.a.createElement("b",null,e)})),r.a.createElement("p",null,Object(l.a)("Connect this session to key backup before signing out to avoid losing any keys that may only be on this session."))),t=Object(l.a)("Connect this session to Key Backup")),e=c.a.get().getKeyBackupEnabled()?g>0?r.a.createElement("div",null,Object(l.a)("Backing up %(sessionsRemaining)s keys...",{sessionsRemaining:g})," ",r.a.createElement("br",null)):r.a.createElement("div",null,Object(l.a)("All keys backed up")," ",r.a.createElement("br",null)):"";let s,n=p.sigs.map((e,t)=>{const s=e.device?e.device.getDisplayName()||e.device.deviceId:null,n=t=>r.a.createElement("span",{className:e.valid?"mx_SecureBackupPanel_sigValid":"mx_SecureBackupPanel_sigInvalid"},t),i=t=>r.a.createElement("span",{className:e.device&&e.deviceTrust.isVerified()?"mx_SecureBackupPanel_deviceVerified":"mx_SecureBackupPanel_deviceNotVerified"},t),a=e=>r.a.createElement("span",{className:"mx_SecureBackupPanel_deviceName"},s),o=e.device&&e.device.getFingerprint()===c.a.get().getDeviceEd25519Key(),d=e.crossSigningId&&e.deviceId===c.a.get().getCrossSigningId();let h;return e.valid&&d?h=Object(l.a)("Backup has a <validity>valid</validity> signature from this user",{},{validity:n}):!e.valid&&d?h=Object(l.a)("Backup has a <validity>invalid</validity> signature from this user",{},{validity:n}):e.crossSigningId?h=Object(l.a)("Backup has a signature from <verify>unknown</verify> user with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}):e.device?e.valid&&o?h=Object(l.a)("Backup has a <validity>valid</validity> signature from this session",{},{validity:n}):!e.valid&&o?h=Object(l.a)("Backup has an <validity>invalid</validity> signature from this session",{},{validity:n}):e.valid&&e.deviceTrust.isVerified()?h=Object(l.a)("Backup has a <validity>valid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:a}):e.valid&&!e.deviceTrust.isVerified()?h=Object(l.a)("Backup has a <validity>valid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:a}):!e.valid&&e.deviceTrust.isVerified()?h=Object(l.a)("Backup has an <validity>invalid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:a}):e.valid||e.deviceTrust.isVerified()||(h=Object(l.a)("Backup has an <validity>invalid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:a})):h=Object(l.a)("Backup has a signature from <verify>unknown</verify> session with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}),r.a.createElement("div",{key:t},h)});0===p.sigs.length&&(n=Object(l.a)("Backup is not signed by any of your sessions")),p.trusted_locally&&(s=Object(l.a)("This backup is trusted because it has been restored on this session")),f=r.a.createElement(r.a.Fragment,null,r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Backup version:")),r.a.createElement("td",null,d.version)),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Algorithm:")),r.a.createElement("td",null,d.algorithm))),b=r.a.createElement(r.a.Fragment,null,e,r.a.createElement("div",null,n),r.a.createElement("div",null,s)),y.push(r.a.createElement(m.a,{key:"restore",kind:"primary",onClick:this.restoreBackup},t)),Object(h.e)()||y.push(r.a.createElement(m.a,{key:"delete",kind:"danger",onClick:this.deleteBackup},Object(l.a)("Delete Backup")))}else v=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("Your keys are <b>not being backed up from this session</b>.",{},{b:e=>r.a.createElement("b",null,e)})),r.a.createElement("p",null,Object(l.a)("Back up your keys before signing out to avoid losing them."))),y.push(r.a.createElement(m.a,{key:"setup",kind:"primary",onClick:this.startNewBackup},Object(l.a)("Set up")));a&&y.push(r.a.createElement(m.a,{key:"reset",kind:"danger",onClick:this.resetSecretStorage},Object(l.a)("Reset")));let E,S="";return n&&(S=", ",S+=i?Object(l.a)("well formed"):Object(l.a)("unexpected type")),y.length&&(E=r.a.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},y)),r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("Back up your encryption keys with your account data in case you lose access to your sessions. Your keys will be secured with a unique Security Key.")),v,r.a.createElement("details",null,r.a.createElement("summary",null,Object(l.a)("Advanced")),r.a.createElement("table",{className:"mx_SecureBackupPanel_statusList"},r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Backup key stored:")),r.a.createElement("td",null,!0===s?Object(l.a)("in secret storage"):Object(l.a)("not stored"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Backup key cached:")),r.a.createElement("td",null,n?Object(l.a)("cached locally"):Object(l.a)("not found locally"),S)),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Secret storage public key:")),r.a.createElement("td",null,a?Object(l.a)("in account data"):Object(l.a)("not found"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Secret storage:")),r.a.createElement("td",null,o?Object(l.a)("ready"):Object(l.a)("not ready"))),f)),b),E)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return l}));var n=s(82),i=s.n(n),a=s(84),o=s(100),r=s(89),c=s(172);function l(){return r.b.isEnabled("e2ee.manuallyVerifyAllSessions")}t.a=e=>i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(a.a)("Encryption")),i.a.createElement(c.a,{name:"e2ee.manuallyVerifyAllSessions",level:o.a.DEVICE}),i.a.createElement("div",{className:"mx_E2eAdvancedPanel_settingLongDescription"},Object(a.a)("Individually verify each session used by a user to mark it as trusted, not trusting cross-signed devices.")))},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(90),h=s(85),u=s(88),m=s(161),p=s(89),g=s(172),v=s(100);let f=Object(h.a)("views.settings.CryptographyPanel")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onExportE2eKeysClicked",()=>{d.a.createTrackedDialogAsync("Export E2E Keys","",s.e(5).then(s.bind(null,589)),{matrixClient:c.a.get()})}),a()(this,"onImportE2eKeysClicked",()=>{d.a.createTrackedDialogAsync("Import E2E Keys","",s.e(28).then(s.bind(null,1653)),{matrixClient:c.a.get()})}),a()(this,"updateBlacklistDevicesFlag",e=>{c.a.get().setGlobalBlacklistUnverifiedDevices(e)})}render(){const e=c.a.get(),t=e.deviceId;let s=e.getDeviceEd25519Key();s=s?m.e(s):Object(l.a)("<not supported>");let n,i=null;return e.isCryptoEnabled()&&(i=r.a.createElement("div",{className:"mx_CryptographyPanel_importExportButtons"},r.a.createElement(u.a,{kind:"primary",onClick:this.onExportE2eKeysClicked},Object(l.a)("Export E2E room keys")),r.a.createElement(u.a,{kind:"primary",onClick:this.onImportE2eKeysClicked},Object(l.a)("Import E2E room keys")))),p.b.isEnabled("blacklistUnverifiedDevices")&&(n=r.a.createElement(g.a,{name:"blacklistUnverifiedDevices",level:v.a.DEVICE,onChange:this.updateBlacklistDevicesFlag})),r.a.createElement("div",{className:"mx_SettingsTab_section mx_CryptographyPanel"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Cryptography")),r.a.createElement("table",{className:"mx_SettingsTab_subsectionText mx_CryptographyPanel_sessionInfo"},r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Session ID:")),r.a.createElement("td",null,r.a.createElement("code",null,t))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Session key:")),r.a.createElement("td",null,r.a.createElement("code",null,r.a.createElement("b",null,s))))),i,n)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(91),l=s.n(c),d=s(86),h=s(84),u=s(90),m=s(217),p=s(85),g=s(242),v=s(1e3),f=s(96),b=s(88),y=s(1);let E=Object(p.a)("views.settings.DevicesPanel")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"unmounted",!1),a()(this,"onDeviceSelectionToggled",e=>{if(this.unmounted)return;const t=e.device_id;this.setState((e,s)=>{const n=e.selectedDevices.slice(),i=n.indexOf(t);return-1===i?n.push(t):n.splice(i,1),{selectedDevices:n}})}),a()(this,"selectAll",e=>{this.setState((t,s)=>{const n=t.selectedDevices.slice();for(const t of e){const e=t.device_id;n.includes(e)||n.push(e)}return{selectedDevices:n}})}),a()(this,"deselectAll",e=>{this.setState((t,s)=>{const n=t.selectedDevices.slice();for(const t of e){const e=t.device_id,s=n.indexOf(e);-1!==s&&n.splice(s,1)}return{selectedDevices:n}})}),a()(this,"onDeleteClick",()=>{0!==this.state.selectedDevices.length&&(this.setState({deleting:!0}),this.makeDeleteRequest(null).catch(e=>{if(this.unmounted)return;if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=this.state.selectedDevices.length,s={[m.c.PHASE_PREAUTH]:{title:Object(h.a)("Use Single Sign On to continue"),body:Object(h.a)("Confirm logging out these devices by using Single Sign On to prove your identity.",{count:t}),continueText:Object(h.a)("Single Sign On"),continueKind:"primary"},[m.c.PHASE_POSTAUTH]:{title:Object(h.a)("Confirm signing out these devices"),body:Object(h.a)("Click the button below to confirm signing out these devices.",{count:t}),continueText:Object(h.a)("Sign out devices",{count:t}),continueKind:"danger"}};u.a.createTrackedDialog("Delete Device Dialog","",g.a,{title:Object(h.a)("Authentication"),matrixClient:d.a.get(),authData:e.data,makeRequest:this.makeDeleteRequest.bind(this),aestheticsForStagePhases:{[m.c.LOGIN_TYPE]:s,[m.c.UNSTABLE_LOGIN_TYPE]:s}})}).catch(e=>{y.a.error("Error deleting sessions",e),this.unmounted}).finally(()=>{this.setState({deleting:!1})}))}),a()(this,"renderDevice",e=>{const t=d.a.get().getDeviceId(),s=this.state.devices.find(e=>e.device_id===t),n=e.device_id===t,i=s&&this.isDeviceVerified(s)||n;return r.a.createElement(v.a,{key:e.device_id,device:e,selected:this.state.selectedDevices.includes(e.device_id),isOwnDevice:n,verified:this.isDeviceVerified(e),canBeVerified:i,onDeviceChange:this.loadDevices,onDeviceToggled:this.onDeviceSelectionToggled})}),this.state={devices:[],selectedDevices:[]},this.loadDevices=this.loadDevices.bind(this)}componentDidMount(){this.loadDevices()}componentWillUnmount(){this.unmounted=!0}loadDevices(){const e=d.a.get();e.getDevices().then(t=>{if(this.unmounted)return;const s=e.getStoredCrossSigningForUser(e.getUserId());this.setState((e,n)=>{const i=t.devices.map(e=>e.device_id),a=e.selectedDevices.filter(e=>i.includes(e));return{devices:t.devices||[],selectedDevices:a,crossSigningInfo:s}}),console.log(this.state)},e=>{if(this.unmounted)return;let t;404==e.httpStatus?t=Object(h.a)("Your homeserver does not support device management."):(y.a.error("Error loading sessions:",e),t=Object(h.a)("Unable to load device list")),this.setState({deviceLoadError:t})})}deviceCompare(e,t){const s=(t.last_seen_ts||0)-(e.last_seen_ts||0);if(0!==s)return s;const n=e.device_id,i=t.device_id;return n<i?-1:n>i?1:0}isDeviceVerified(e){try{const t=d.a.get(),s=t.getStoredDevice(t.getUserId(),e.device_id);return this.state.crossSigningInfo.checkDeviceTrust(this.state.crossSigningInfo,s,!1,!0).isCrossSigningVerified()}catch(e){return console.error("Error getting device cross-signing info",e),null}}makeDeleteRequest(e){return d.a.get().deleteMultipleDevices(this.state.selectedDevices,e).then(()=>{this.setState({selectedDevices:[]}),this.loadDevices()})}render(){const e=r.a.createElement("div",{className:l()(this.props.className,"error")},this.state.deviceLoadError);if(void 0!==this.state.deviceLoadError)return e;const t=this.state.devices;if(void 0===t)return r.a.createElement(f.a,null);const s=d.a.get().getDeviceId(),n=t.find(e=>e.device_id===s);if(!n)return e;const i=t.filter(e=>e.device_id!==s);i.sort(this.deviceCompare);const a=[],o=[],c=[];for(const e of i){const t=this.isDeviceVerified(e);!0===t?a.push(e):!1===t?o.push(e):c.push(e)}const u=(e,t,s)=>{if(0===s.length)return r.a.createElement(r.a.Fragment,null);let n;if(s.length>1){const e=s.some(e=>this.state.selectedDevices.includes(e.device_id)),t=e?()=>{this.deselectAll(s)}:()=>{this.selectAll(s)},i=e?Object(h.a)("Deselect all"):Object(h.a)("Select all");n=r.a.createElement("div",{className:"mx_DevicesPanel_header_button"},r.a.createElement(b.a,{className:"mx_DevicesPanel_selectButton",kind:"secondary",onClick:t},i))}return r.a.createElement(r.a.Fragment,null,r.a.createElement("hr",null),r.a.createElement("div",{className:"mx_DevicesPanel_header"},r.a.createElement("div",{className:"mx_DevicesPanel_header_trust"},e),r.a.createElement("div",{className:"mx_DevicesPanel_header_title"},t),n),s.map(this.renderDevice))},m=u(r.a.createElement("span",{className:"mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_verified"}),Object(h.a)("Verified devices"),a),p=u(r.a.createElement("span",{className:"mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_warning"}),Object(h.a)("Unverified devices"),o),g=u(r.a.createElement(r.a.Fragment,null),Object(h.a)("Devices without encryption support"),c),v=this.state.deleting?r.a.createElement(f.a,{w:22,h:22}):r.a.createElement(b.a,{className:"mx_DevicesPanel_deleteButton",onClick:this.onDeleteClick,kind:"danger_outline",disabled:0===this.state.selectedDevices.length},Object(h.a)("Sign out %(count)s selected devices",{count:this.state.selectedDevices.length})),y=i.length>0?r.a.createElement(r.a.Fragment,null,m,p,g,v):r.a.createElement(r.a.Fragment,null,r.a.createElement("hr",null),r.a.createElement("div",{className:"mx_DevicesPanel_noOtherDevices"},Object(h.a)("You aren't signed into any other devices."))),E=l()(this.props.className,"mx_DevicesPanel");return r.a.createElement("div",{className:E},r.a.createElement("div",{className:"mx_DevicesPanel_header"},r.a.createElement("div",{className:"mx_DevicesPanel_header_title"},Object(h.a)("This device"))),this.renderDevice(n),y)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(86),d=s(136),h=s(137),u=s(85),m=s(88),p=s(101),g=s(177),v=s(90),f=s(392),b=s(393),y=s(556),E=s(1);let S=Object(u.a)("views.settings.DevicesPanelEntry")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onDeviceToggled",()=>{this.props.onDeviceToggled(this.props.device)}),a()(this,"onRename",()=>{this.setState({renaming:!0})}),a()(this,"onChangeDisplayName",e=>{this.setState({displayName:e.target.value})}),a()(this,"onRenameSubmit",async()=>{this.setState({renaming:!1}),await l.a.get().setDeviceDetails(this.props.device.device_id,{display_name:this.state.displayName}).catch(e=>{throw E.a.error("Error setting session display name",e),new Error(Object(c.a)("Failed to set display name"))}),this.props.onDeviceChange()}),a()(this,"onRenameCancel",()=>{this.setState({renaming:!1})}),a()(this,"onOwnDeviceSignOut",()=>{v.a.createTrackedDialog("Logout from device list","",y.a,{},null,!1,!0)}),a()(this,"verify",async()=>{if(this.props.isOwnDevice)v.a.createTrackedDialog("Verify session","Verify session",f.a,{onFinished:this.props.onDeviceChange});else{const e=l.a.get(),t=e.getUserId(),s=e.requestVerification(t,[this.props.device.device_id]);v.a.createTrackedDialog("New Session Verification","Starting dialog",b.a,{verificationRequestPromise:s,member:e.getUser(t),onFinished:async()=>{(await s).cancel(),this.props.onDeviceChange()}})}}),this.state={renaming:!1,displayName:e.device.display_name}}render(){const e=this.props.device;let t="";if(e.last_seen_ts){const s=new Date(e.last_seen_ts);t=Object(c.a)("Last seen %(date)s at %(ip)s",{date:Object(d.b)(s),ip:e.last_seen_ip})}const s=this.props.isOwnDevice?" mx_DevicesPanel_myDevice":"";let n,i,a="";null!==this.props.verified&&(a=this.props.verified?"mx_E2EIcon_verified":"mx_E2EIcon_warning",!this.props.verified&&this.props.canBeVerified&&(n=r.a.createElement(m.a,{kind:"primary",onClick:this.verify},Object(c.a)("Verify")))),this.props.isOwnDevice&&(i=r.a.createElement(m.a,{kind:"danger_outline",onClick:this.onOwnDeviceSignOut},Object(c.a)("Sign Out")));const o=this.props.isOwnDevice?r.a.createElement("div",{className:"mx_DevicesPanel_deviceTrust"},r.a.createElement("span",{className:"mx_DevicesPanel_icon mx_E2EIcon "+a})):r.a.createElement("div",{className:"mx_DevicesPanel_checkbox"},r.a.createElement(h.b,{kind:h.a.Outline,onChange:this.onDeviceToggled,checked:this.props.selected})),l=e.display_name?r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{tooltip:e.display_name+" ("+e.device_id+")"},e.display_name)):r.a.createElement(r.a.Fragment,null,e.device_id),u=this.state.renaming?r.a.createElement("form",{className:"mx_DevicesPanel_renameForm",onSubmit:this.onRenameSubmit},r.a.createElement(p.a,{label:Object(c.a)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onChangeDisplayName}),r.a.createElement(m.a,{onClick:this.onRenameSubmit,kind:"confirm_sm"}),r.a.createElement(m.a,{onClick:this.onRenameCancel,kind:"cancel_sm"})):r.a.createElement(r.a.Fragment,null,i,n,r.a.createElement(m.a,{kind:"primary_outline",onClick:this.onRename},Object(c.a)("Rename")));return r.a.createElement("div",{className:"mx_DevicesPanel_device"+s},o,r.a.createElement("div",{className:"mx_DevicesPanel_deviceInfo"},r.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},l),r.a.createElement("div",{className:"mx_DevicesPanel_lastSeen"},t)),r.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},u))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(90),h=s(96),u=s(242),m=s(1002),p=s(85),g=s(392),v=s(188),f=s(1),b=s(88);let y=Object(p.a)("views.settings.CrossSigningPanel")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"unmounted",!1),a()(this,"onAccountData",e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this.getUpdatedStatus()}),a()(this,"onBootstrapClick",()=>{this.state.crossSigningPrivateKeysInStorage?d.a.createTrackedDialog("Verify session","Verify session",g.a,{},null,!1,!0):Object(v.b)()}),a()(this,"onStatusChanged",()=>{this.getUpdatedStatus()}),a()(this,"bootstrapCrossSigning",async({forceReset:e=!1})=>{this.setState({error:void 0});try{const t=c.a.get();await t.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const{finished:s}=d.a.createTrackedDialog("Cross-signing keys dialog","",u.a,{title:Object(l.a)("Setting up keys"),matrixClient:t,makeRequest:e}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:e})}catch(e){this.setState({error:e}),f.a.error("Error bootstrapping cross-signing",e)}this.unmounted||this.getUpdatedStatus()}),a()(this,"resetCrossSigning",()=>{d.a.createDialog(m.a,{onFinished:e=>{e&&this.bootstrapCrossSigning({forceReset:!0})}})}),this.state={}}componentDidMount(){const e=c.a.get();e.on("accountData",this.onAccountData),e.on("userTrustStatusChanged",this.onStatusChanged),e.on("crossSigning.keysChanged",this.onStatusChanged),this.getUpdatedStatus()}componentWillUnmount(){this.unmounted=!0;const e=c.a.get();e&&(e.removeListener("accountData",this.onAccountData),e.removeListener("userTrustStatusChanged",this.onStatusChanged),e.removeListener("crossSigning.keysChanged",this.onStatusChanged))}async getUpdatedStatus(){const e=c.a.get(),t=e.getCrossSigningCacheCallbacks(),s=e.crypto.crossSigningInfo,n=e.crypto.secretStorage,i=Boolean(s.getId()),a=Boolean(await s.isStoredInSecretStorage(n)),o=!(!t||!await t.getCrossSigningKeyCache("master")),r=!(!t||!await t.getCrossSigningKeyCache("self_signing")),l=!(!t||!await t.getCrossSigningKeyCache("user_signing")),d=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),h=await e.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:i,crossSigningPrivateKeysInStorage:a,masterPrivateKeyCached:o,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:l,homeserverSupportsCrossSigning:d,crossSigningReady:h})}render(){const{error:e,crossSigningPublicKeysOnDevice:t,crossSigningPrivateKeysInStorage:s,masterPrivateKeyCached:n,selfSigningPrivateKeyCached:i,userSigningPrivateKeyCached:a,homeserverSupportsCrossSigning:o,crossSigningReady:c}=this.state;let d,u;e&&(d=r.a.createElement("div",{className:"error"},e.toString())),u=void 0===o?r.a.createElement(h.a,null):o?c&&s?r.a.createElement("p",null,"✅ ",Object(l.a)("Cross-signing is ready for use.")):c&&!s?r.a.createElement("p",null,"⚠️ ",Object(l.a)("Cross-signing is ready but keys are not backed up.")):s?r.a.createElement("p",null,Object(l.a)("Your account has a cross-signing identity in secret storage, but it is not yet trusted by this session.")):r.a.createElement("p",null,Object(l.a)("Cross-signing is not set up.")):r.a.createElement("p",null,Object(l.a)("Your homeserver does not support cross-signing."));const m=t||s||n||i||a,p=[];if(!(t&&s&&n&&i&&a)&&o){let e=Object(l.a)("Set up Secure Backup");s&&(e=Object(l.a)("Verify this session")),p.push(r.a.createElement(b.a,{key:"setup",kind:"primary",onClick:this.onBootstrapClick},e))}let g;return m&&p.push(r.a.createElement(b.a,{key:"reset",kind:"danger",onClick:this.resetCrossSigning},Object(l.a)("Reset"))),p.length&&(g=r.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},p)),r.a.createElement("div",null,u,r.a.createElement("details",null,r.a.createElement("summary",null,Object(l.a)("Advanced")),r.a.createElement("table",{className:"mx_CrossSigningPanel_statusList"},r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Cross-signing public keys:")),r.a.createElement("td",null,t?Object(l.a)("in memory"):Object(l.a)("not found"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Cross-signing private keys:")),r.a.createElement("td",null,s?Object(l.a)("in secret storage"):Object(l.a)("not found in storage"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Master private key:")),r.a.createElement("td",null,n?Object(l.a)("cached locally"):Object(l.a)("not found locally"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Self signing private key:")),r.a.createElement("td",null,i?Object(l.a)("cached locally"):Object(l.a)("not found locally"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("User signing private key:")),r.a.createElement("td",null,a?Object(l.a)("cached locally"):Object(l.a)("not found locally"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Homeserver feature support:")),r.a.createElement("td",null,o?Object(l.a)("exists"):Object(l.a)("not found")))))),d,g)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(85),d=s(97),h=s(109);let u=Object(l.a)("views.dialogs.security.ConfirmDestroyCrossSigningDialog")(n=class extends r.a.Component{constructor(...e){super(...e),a()(this,"onConfirm",()=>{this.props.onFinished(!0)}),a()(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){return r.a.createElement(d.a,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Destroy cross-signing keys?")},r.a.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},r.a.createElement("p",null,Object(c.a)("Deleting cross-signing keys is permanent. Anyone you have verified with will see security alerts. You almost certainly don't want to do this, unless you've lost every device you can cross-sign from."))),r.a.createElement(h.a,{primaryButton:Object(c.a)("Clear cross-signing keys"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.onDecline}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(93),d=s(90),h=s(89),u=s(88),m=s(161),p=s(247),g=s(100),v=s(85),f=s(1004),b=s(145);let y=Object(v.a)("views.settings.EventIndexPanel")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"updateCurrentRoom",async e=>{const t=p.a.get();let s;try{s=await t.getStats()}catch{return}this.setState({eventIndexSize:s.size,roomCount:s.roomCount})}),a()(this,"onManage",async()=>{d.a.createTrackedDialogAsync("Message search","Message search",s.e(30).then(s.bind(null,1654)),{onFinished:()=>{}},null,!1,!0)}),a()(this,"onEnable",async()=>{this.setState({enabling:!0}),await p.a.initEventIndex(),await p.a.get().addInitialCheckpoints(),await p.a.get().startCrawler(),await h.b.setValue("enableEventIndexing",null,g.a.DEVICE,!0),await this.updateState()}),a()(this,"confirmEventStoreReset",()=>{const{close:e}=d.a.createDialog(f.a,{onFinished:async t=>{t&&(await h.b.setValue("enableEventIndexing",null,g.a.DEVICE,!1),await p.a.deleteEventIndex(),await this.onEnable(),e())}})}),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:h.b.getValueAt(g.a.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=p.a.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=p.a.get(),t=h.b.getValueAt(g.a.DEVICE,"enableEventIndexing");let s=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);try{const t=await e.getStats();s=t.size,n=t.roomCount}catch{}}this.setState({enabling:!1,eventIndexSize:s,roomCount:n,eventIndexingEnabled:t})}render(){let e=null;const t=l.a.get().brand;if(null!==p.a.get())e=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results, using %(size)s to store messages from %(rooms)s rooms.",{size:Object(m.a)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:Object(m.d)(this.state.roomCount)})),r.a.createElement("div",null,r.a.createElement(u.a,{kind:"primary",onClick:this.onManage},Object(c.a)("Manage"))));else if(!this.state.eventIndexingEnabled&&p.a.supportIsInstalled())e=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results.")),r.a.createElement("div",null,r.a.createElement(u.a,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},Object(c.a)("Enable")),this.state.enabling?r.a.createElement(b.a,null):r.a.createElement("div",null)));else if(p.a.platformHasSupport()&&!p.a.supportIsInstalled()){const s="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s is missing some components required for securely caching encrypted messages locally. If you'd like to experiment with this feature, build a custom %(brand)s Desktop with <nativeLink>search components added</nativeLink>.",{brand:t},{nativeLink:e=>r.a.createElement("a",{href:s,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=p.a.platformHasSupport()?r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("p",null,this.state.enabling?r.a.createElement(b.a,null):Object(c.a)("Message search initialisation failed")),p.a.error&&r.a.createElement("details",null,r.a.createElement("summary",null,Object(c.a)("Advanced")),r.a.createElement("code",null,p.a.error.message),r.a.createElement("p",null,r.a.createElement(u.a,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},Object(c.a)("Reset"))))):r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s can't securely cache encrypted messages locally while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> for encrypted messages to appear in search results.",{brand:t},{desktopLink:e=>r.a.createElement("a",{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(82),a=s.n(i),o=s(84),r=s(85),c=s(97),l=s(109);let d=Object(r.a)("views.dialogs.SeshatResetDialog")(n=class extends a.a.PureComponent{render(){return a.a.createElement(c.a,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:Object(o.a)("Reset event store?")},a.a.createElement("div",null,a.a.createElement("p",null,Object(o.a)("You most likely do not want to reset your event index store"),a.a.createElement("br",null),Object(o.a)("If you do, please note that none of your messages will be deleted, but the search experience might be degraded for a few moments whilst the index is recreated"))),a.a.createElement(l.a,{primaryButton:Object(o.a)("Reset event store"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:Object(o.a)("Cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(84),r=s(85),c=s(1028);let l=Object(r.a)("views.settings.tabs.user.NotificationUserSettingsTab")(n=class extends a.a.Component{render(){return a.a.createElement("div",{className:"mx_SettingsTab mx_NotificationUserSettingsTab"},a.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(o.a)("Notifications")),a.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},a.a.createElement(c.a,null)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85),l=s(101),d=s(84),h=s(88);let u=Object(c.a)("views.elements.TagComposer")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onInputChange",e=>{this.setState({newTag:e.target.value})}),a()(this,"onAdd",e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))}),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return r.a.createElement("div",{className:"mx_TagComposer"},r.a.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},r.a.createElement(l.a,{value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||Object(d.a)("Keyword"),placeholder:this.props.placeholder||Object(d.a)("New keyword"),disabled:this.props.disabled,autoComplete:"off"}),r.a.createElement(h.a,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},Object(d.a)("Add"))),r.a.createElement("div",{className:"mx_TagComposer_tags"},this.props.tags.map((e,t)=>r.a.createElement("div",{className:"mx_TagComposer_tag",key:t},r.a.createElement("span",null,e),r.a.createElement(h.a,{onClick:this.onRemove.bind(this,e),disabled:this.props.disabled})))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return N}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(94),h=s(84),u=s(187),m=s(89),p=s(101),g=s(121),v=s(100),f=s(85),b=s(172),y=s(398),E=s(88),S=s(320),_=s(87),w=s(953),C=s(98),O=s(321),k=s(299),R=s(186),I=s(96);function x(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function T(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?x(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const j=({onFinished:e})=>{const t=Object(c.useContext)(C.a),[s,n]=Object(c.useState)(null);return Object(c.useEffect)(()=>{_.a.dispatch(w.a.fetchJoinedGroups(t))},[t]),Object(O.a)(_.a,async e=>{if("GroupActions.fetchJoinedGroups.success"===e.action){const s=[],i=new Map(t.getRooms().map(e=>{var t;const s=null===(t=e.currentState.getStateEvents(d.a.RoomCreate,""))||void 0===t?void 0:t.getContent();if(null!=s&&s[k.a])return[s[k.a],e.roomId]}).filter(Boolean));for(const n of e.result.groups){const e=await t.getGroupSummary(n);e.user.is_privileged&&s.push(T(T({},e),{},{groupId:n,spaceId:i.get(n)}))}n(s)}}),s?l.a.createElement("div",{className:"mx_PreferencesUserSettingsTab_CommunityMigrator"},s.map(i=>l.a.createElement("div",{key:i.groupId},l.a.createElement(S.a,{groupId:i.groupId,groupAvatarUrl:i.profile.avatar_url,groupName:i.profile.name,width:32,height:32}),i.profile.name,l.a.createElement(E.a,{kind:"primary_outline",onClick:()=>{i.spaceId?(_.a.dispatch({action:"view_room",room_id:i.spaceId}),e()):Object(R.b)(t,i.groupId).then(([e])=>{e&&(i.spaceId=e,n([...s]))})}},i.spaceId?Object(h.a)("Open Space"):Object(h.a)("Create Space"))))):l.a.createElement(I.a,null)};let N=Object(f.a)("views.settings.tabs.user.PreferencesUserSettingsTab")((a=i=class e extends l.a.Component{constructor(e){super(e),r()(this,"onAutoLaunchChange",e=>{g.a.get().setAutoLaunchEnabled(e).then(()=>this.setState({autoLaunch:e}))}),r()(this,"onWarnBeforeExitChange",e=>{g.a.get().setWarnBeforeExit(e).then(()=>this.setState({warnBeforeExit:e}))}),r()(this,"onAlwaysShowMenuBarChange",e=>{g.a.get().setAutoHideMenuBarEnabled(!e).then(()=>this.setState({alwaysShowMenuBar:e}))}),r()(this,"onMinimizeToTrayChange",e=>{g.a.get().setMinimizeToTrayEnabled(e).then(()=>this.setState({minimizeToTray:e}))}),r()(this,"onAutocompleteDelayChange",e=>{this.setState({autocompleteDelay:e.target.value}),m.b.setValue("autocompleteDelay",null,v.a.DEVICE,e.target.value)}),r()(this,"onReadMarkerInViewThresholdMs",e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),m.b.setValue("readMarkerInViewThresholdMs",null,v.a.DEVICE,e.target.value)}),r()(this,"onReadMarkerOutOfViewThresholdMs",e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),m.b.setValue("readMarkerOutOfViewThresholdMs",null,v.a.DEVICE,e.target.value)}),this.state={autoLaunch:!1,autoLaunchSupported:!1,warnBeforeExit:!0,warnBeforeExitSupported:!1,alwaysShowMenuBar:!0,alwaysShowMenuBarSupported:!1,minimizeToTray:!0,minimizeToTraySupported:!1,autocompleteDelay:m.b.getValueAt(v.a.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:m.b.getValueAt(v.a.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:m.b.getValueAt(v.a.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}async componentDidMount(){const e=g.a.get(),t=await e.supportsAutoLaunch();let s=!1;t&&(s=await e.getAutoLaunchEnabled());const n=await e.supportsWarnBeforeExit();let i=!1;n&&(i=await e.shouldWarnBeforeExit());const a=await e.supportsAutoHideMenuBar();let o=!0;a&&(o=!await e.getAutoHideMenuBarEnabled());const r=await e.supportsMinimizeToTray();let c=!0;r&&(c=await e.getMinimizeToTrayEnabled()),this.setState({autoLaunch:s,autoLaunchSupported:t,warnBeforeExit:i,warnBeforeExitSupported:n,alwaysShowMenuBarSupported:a,alwaysShowMenuBar:o,minimizeToTraySupported:r,minimizeToTray:c})}renderGroup(e,t=v.a.ACCOUNT){return e.map(e=>{const s=!m.b.isEnabled(e);return l.a.createElement(b.a,{key:e,name:e,level:t,disabled:s})})}render(){let t=null;this.state.autoLaunchSupported&&(t=l.a.createElement(u.a,{value:this.state.autoLaunch,onChange:this.onAutoLaunchChange,label:Object(h.a)("Start automatically after system login")}));let s=null;this.state.warnBeforeExitSupported&&(s=l.a.createElement(u.a,{value:this.state.warnBeforeExit,onChange:this.onWarnBeforeExitChange,label:Object(h.a)("Warn before quitting")}));let n=null;this.state.alwaysShowMenuBarSupported&&(n=l.a.createElement(u.a,{value:this.state.alwaysShowMenuBar,onChange:this.onAlwaysShowMenuBarChange,label:Object(h.a)("Always show the window menu bar")}));let i=null;return this.state.minimizeToTraySupported&&(i=l.a.createElement(u.a,{value:this.state.minimizeToTray,onChange:this.onMinimizeToTrayChange,label:Object(h.a)("Show tray icon and minimise window to it on close")})),l.a.createElement("div",{className:"mx_SettingsTab mx_PreferencesUserSettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Preferences")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Room list")),this.renderGroup(e.ROOM_LIST_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Spaces")),this.renderGroup(e.SPACES_SETTINGS,v.a.ACCOUNT)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Communities")),l.a.createElement("p",null,Object(h.a)("Communities have been archived to make way for Spaces but you can convert your communities into Spaces below. Converting will ensure your conversations get the latest features.")),l.a.createElement("details",null,l.a.createElement("summary",null,Object(h.a)("Show my Communities")),l.a.createElement("p",null,Object(h.a)("If a community isn't shown you may not have permission to convert it.")),l.a.createElement(j,{onFinished:this.props.closeSettingsFn})),this.renderGroup(e.COMMUNITIES_SETTINGS,v.a.DEVICE)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Keyboard shortcuts")),l.a.createElement(E.a,{className:"mx_SettingsFlag",onClick:y.f},Object(h.a)("To view all keyboard shortcuts, click here.")),this.renderGroup(e.KEYBINDINGS_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Displaying time")),this.renderGroup(e.TIME_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Composer")),this.renderGroup(e.COMPOSER_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Code blocks")),this.renderGroup(e.CODE_BLOCKS_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Images, GIFs and videos")),this.renderGroup(e.IMAGES_AND_VIDEOS_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Timeline")),this.renderGroup(e.TIMELINE_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("General")),this.renderGroup(e.GENERAL_SETTINGS),i,n,t,s,l.a.createElement(p.a,{label:Object(h.a)("Autocomplete delay (ms)"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),l.a.createElement(p.a,{label:Object(h.a)("Read Marker lifetime (ms)"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),l.a.createElement(p.a,{label:Object(h.a)("Read Marker off-screen lifetime (ms)"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs})))}},r()(i,"ROOM_LIST_SETTINGS",["breadcrumbs"]),r()(i,"SPACES_SETTINGS",["Spaces.allRoomsInHome","Spaces.showSpaceMemberDMs","Spaces.showSpaceDMBadges","Spaces.returnToPreviouslyOpenedRoom"]),r()(i,"COMMUNITIES_SETTINGS",["showCommunitiesInsteadOfSpaces"]),r()(i,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),r()(i,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.suggestEmoji","sendTypingNotifications","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton"]),r()(i,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),r()(i,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),r()(i,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","autoplayGifs","autoplayVideo","showImages"]),r()(i,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent"]),r()(i,"GENERAL_SETTINGS",["TagPanel.enableTagPanel","promptBeforeInviteUnknownUsers"]),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(93),d=s(315),h=s(101),u=s(88),m=s(86),p=s(90),g=s(100),v=s(85),f=s(172),b=s(104),y=s(1);let E=Object(v.a)("views.settings.tabs.user.VoiceUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"refreshMediaDevices",async e=>{this.setState({mediaDevices:await d.c.getDevices(),[d.b.AudioOutput]:d.c.getAudioOutput(),[d.b.AudioInput]:d.c.getAudioInput(),[d.b.VideoInput]:d.c.getVideoInput()}),e&&e.getTracks().forEach(e=>e.stop())}),a()(this,"requestMediaPermissions",async()=>{let e,t,s;try{e={video:!0,audio:!0},t=await navigator.mediaDevices.getUserMedia(e)}catch(n){if("NotFoundError"===n.name){e={audio:!0};try{t=await navigator.mediaDevices.getUserMedia(e)}catch(e){s=e}}else s=n}if(s){y.a.log("Failed to list userMedia devices",s);const e=l.a.get().brand;p.a.createTrackedDialog("No media permissions","",b.a,{title:Object(c.a)("No media permissions"),description:Object(c.a)("You may need to manually permit %(brand)s to access your microphone/webcam",{brand:e})})}else this.refreshMediaDevices(t)}),a()(this,"setDevice",(e,t)=>{d.c.instance.setDevice(e,t),this.setState({[t]:e})}),a()(this,"changeWebRtcMethod",e=>{m.a.get().setForceTURN(!e)}),a()(this,"changeFallbackICEServerAllowed",e=>{m.a.get().setFallbackICEServerAllowed(e)}),this.state={mediaDevices:null,[d.b.AudioOutput]:null,[d.b.AudioInput]:null,[d.b.VideoInput]:null}}async componentDidMount(){await d.c.hasAnyLabeledDevices()&&this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map(e=>r.a.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label))}renderDropdown(e,t){const s=this.state.mediaDevices[e].slice(0);if(0===s.length)return null;const n=(e=>e.some(e=>"default"===e.deviceId)?"default":(e.unshift({deviceId:"",label:Object(c.a)("Default Device")}),""))(s);return r.a.createElement(h.a,{element:"select",label:t,value:this.state[e]||n,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(s,e))}render(){let e=null,t=null,s=null,n=null;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(d.b.AudioOutput,Object(c.a)("Audio Output"))||r.a.createElement("p",null,Object(c.a)("No Audio Outputs detected")),s=this.renderDropdown(d.b.AudioInput,Object(c.a)("Microphone"))||r.a.createElement("p",null,Object(c.a)("No Microphones detected")),n=this.renderDropdown(d.b.VideoInput,Object(c.a)("Camera"))||r.a.createElement("p",null,Object(c.a)("No Webcams detected"))):e=r.a.createElement("div",{className:"mx_VoiceUserSettingsTab_missingMediaPermissions"},r.a.createElement("p",null,Object(c.a)("Missing media permissions, click the button below to request.")),r.a.createElement(u.a,{onClick:this.requestMediaPermissions,kind:"primary"},Object(c.a)("Request media permissions"))),r.a.createElement("div",{className:"mx_SettingsTab mx_VoiceUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Voice & Video")),r.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,s,n,r.a.createElement(f.a,{name:"VideoView.flipVideoHorizontally",level:g.a.ACCOUNT}),r.a.createElement(f.a,{name:"webRtcAllowPeerToPeer",level:g.a.DEVICE,onChange:this.changeWebRtcMethod}),r.a.createElement(f.a,{name:"fallbackICEServerAllowed",level:g.a.DEVICE,onChange:this.changeFallbackICEServerAllowed})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return k}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(88),l=s(84),d=s(86),h=s(111),u=s(93),m=s(141),p=s(90),g=s(121),v=s(398),f=s(1010),b=s(85),y=s(143),E=s(105),S=s(200),_=s(314),w=s(1);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function O(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let k=Object(b.a)("views.settings.tabs.user.HelpUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"closeCopiedTooltip",void 0),a()(this,"onClearCacheAndReload",e=>{g.a.get()&&(w.a.log("Clear cache & reload clicked"),d.a.get().stopClient(),d.a.get().store.deleteAllData().then(()=>{g.a.get().reload()}))}),a()(this,"onBugReport",e=>{p.a.createTrackedDialog("Bug Report Dialog","",S.a,{})}),a()(this,"onStartBotChat",e=>{this.props.closeSettingsFn(),Object(m.b)({dmUserId:u.a.get().welcomeUserId,andView:!0})}),a()(this,"showSpoiler",e=>{const t=e.target;t.innerHTML=t.getAttribute("data-spoiler");const s=document.createRange();s.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(s)}),a()(this,"onAccessTokenCopyClick",e=>{this.copy(d.a.get().getAccessToken(),e)}),a()(this,"onCopyVersionClicked",e=>{const{appVersion:t,olmVersion:s}=this.getVersionInfo();this.copy(`${t}\n${s}`,e)}),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){g.a.get().getAppVersion().then(e=>this.setState({appVersion:e})).catch(e=>{w.a.error("Error getting vector version: ",e)}),g.a.get().canSelfUpdate().then(e=>this.setState({canUpdate:e})).catch(e=>{w.a.error("Error getting self updatability: ",e)})}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}getVersionInfo(){const e=u.a.get().brand,t=this.state.appVersion||"unknown",s=d.a.get().olmVersion,n=s?`${s[0]}.${s[1]}.${s[2]}`:"<not-enabled>";return{appVersion:`${Object(l.a)("%(brand)s version:",{brand:e})} ${t}`,olmVersion:`${Object(l.a)("Olm version:")} ${n}`}}renderLegal(){if(!u.a.get().terms_and_conditions_links)return null;const e=[];for(const t of u.a.get().terms_and_conditions_links)e.push(r.a.createElement("div",{key:t.url},r.a.createElement("a",{href:t.url,rel:"noreferrer noopener",target:"_blank"},t.text)));return r.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Legal")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},e))}renderCredits(){return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Credits")),r.a.createElement("ul",null,r.a.createElement("li",null,"The ",r.a.createElement("a",{href:"themes/element/img/backgrounds/ocean.jpg",rel:"noreferrer noopener",target:"_blank"}," default cover photo")," is from ",r.a.createElement("a",{href:"https://pixabay.com/de/photos/unterwasser-blau-ozean-meer-802092/",rel:"noreferrer noopener",target:"_blank"},"here")," ","used under the terms of the ",r.a.createElement("a",{href:"https://pixabay.com/de/service/license/",rel:"noreferrer noopener",target:"_blank"},"Pixabay License"),"."),r.a.createElement("li",null,"The ",r.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},"twemoji-colr")," font is © ",r.a.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," used under the terms of ",r.a.createElement("a",{href:"http://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),r.a.createElement("li",null,"The ",r.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," emoji art is © ",r.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," used under the terms of ",r.a.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),".")))}async copy(e,t){t.preventDefault();const s=t.target,n=await Object(y.c)(e),i=s.getBoundingClientRect(),{close:a}=E.m(_.a,O(O({},Object(E.o)(i,2)),{},{message:n?Object(l.a)("Copied!"):Object(l.a)("Failed to copy")}));this.closeCopiedTooltip=s.onmouseleave=a}render(){const e=u.a.get().brand;let t=Object(l.a)("For help with using %(brand)s, click <a>here</a>.",{brand:e},{a:e=>r.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)});u.a.get().welcomeUserId&&Object(l.d)().startsWith("en")&&(t=r.a.createElement("div",null,Object(l.a)("For help with using %(brand)s, click <a>here</a> or start a chat with our bot using the button below.",{brand:e},{a:e=>r.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)}),r.a.createElement("div",null,r.a.createElement(c.a,{onClick:this.onStartBotChat,kind:"primary"},Object(l.a)("Chat with %(brand)s Bot",{brand:e})))));let s,n=null;this.state.canUpdate&&(n=r.a.createElement(f.a,null)),u.a.get().bug_report_endpoint_url&&(s=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Bug reporting")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages."),r.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},r.a.createElement(c.a,{onClick:this.onBugReport,kind:"primary"},Object(l.a)("Submit debug logs"))),Object(l.a)("To report a Matrix-related security issue, please read the Matrix.org <a>Security Disclosure Policy</a>.",{},{a:e=>r.a.createElement("a",{href:"https://matrix.org/security-disclosure-policy/",rel:"noreferrer noopener",target:"_blank"},e)}))));const{appVersion:i,olmVersion:a}=this.getVersionInfo();return r.a.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Help & About")),s,r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("FAQ")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t),r.a.createElement(c.a,{kind:"primary",onClick:v.f},Object(l.a)("Keyboard Shortcuts"))),r.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Versions")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_HelpUserSettingsTab_copy"},i,r.a.createElement("br",null),a,r.a.createElement("br",null),r.a.createElement(h.a,{title:Object(l.a)("Copy"),onClick:this.onCopyVersionClicked,className:"mx_HelpUserSettingsTab_copyButton"})),n)),this.renderLegal(),this.renderCredits(),r.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Homeserver is")," ",r.a.createElement("code",null,d.a.get().getHomeserverUrl()),r.a.createElement("br",null),Object(l.a)("Identity server is")," ",r.a.createElement("code",null,d.a.get().getIdentityServerUrl()),r.a.createElement("br",null),r.a.createElement("br",null),r.a.createElement("details",null,r.a.createElement("summary",null,Object(l.a)("Access Token")),r.a.createElement("br",null),r.a.createElement("b",null,Object(l.a)("Your access token gives full access to your account. Do not share it with anyone.")),r.a.createElement("div",{className:"mx_HelpUserSettingsTab_copy"},r.a.createElement("code",null,d.a.get().getAccessToken()),r.a.createElement(h.a,{title:Object(l.a)("Copy"),onClick:this.onAccessTokenCopyClick,className:"mx_HelpUserSettingsTab_copyButton"}))),r.a.createElement("br",null),r.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},r.a.createElement(c.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(l.a)("Clear cache and reload"))))))}})||n},function(e,t,s){"use strict";var n=s(102),i=s.n(n),a=s(82),o=s.n(a),r=s(279),c=s(121),l=s(321),d=s(87),h=s(92),u=s(84),m=s(145),p=s(88);const g=["action"];function v(){c.a.get().installUpdate()}const f=[r.d.Ready,r.d.Error,r.d.NotAvailable];t.a=()=>{const[e,t]=Object(a.useState)(null);Object(l.a)(d.a,e=>{let{action:s}=e,n=i()(e,g);s===h.a.CheckUpdates&&t(n)});const s=e&&!f.includes(e.status);let n;return e&&(n=o.a.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case r.d.Error:return Object(u.a)("Error encountered (%(errorDetail)s).",{errorDetail:t});case r.d.Checking:return Object(u.a)("Checking for an update...");case r.d.NotAvailable:return Object(u.a)("No update available.");case r.d.Downloading:return Object(u.a)("Downloading update...");case r.d.Ready:return Object(u.a)("New version available. <a>Update now.</a>",{},{a:e=>o.a.createElement(p.a,{kind:"link",onClick:v},e)})}}(e.status,e.detail),s&&o.a.createElement(m.a,null))),o.a.createElement(o.a.Fragment,null,o.a.createElement(p.a,{onClick:()=>{t(null),c.a.get().startUpdateCheck()},kind:"primary",disabled:s},Object(u.a)("Check for update")),n)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(82),a=s.n(i),o=s(84),r=s(1012),c=s(85);let l=Object(c.a)("views.settings.tabs.user.FlairUserSettingsTab")(n=class extends a.a.Component{render(){return a.a.createElement("div",{className:"mx_SettingsTab"},a.a.createElement("span",{className:"mx_SettingsTab_heading"},Object(o.a)("Flair")),a.a.createElement("div",{className:"mx_SettingsTab_section"},a.a.createElement(r.a,null)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(107),h=s(84),u=s(98),m=s(85),p=s(1);let g=Object(m.a)("views.groups.GroupUserSettings")((a=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{error:null,groups:null})}componentDidMount(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups||[],error:null})},e=>{p.a.error(e),this.setState({groups:null,error:e})})}render(){let e="",t=null;const s=this.state.groups;if(this.state.error)e=Object(h.a)("Something went wrong when trying to get your communities.");else if(null===s)e=Object(h.a)("Loading...");else if(s.length>0){const n=d.getComponent("groups.GroupPublicityToggle");t=s.map((e,t)=>l.a.createElement(n,{key:t,groupId:e})),e=Object(h.a)("Display your community flair in rooms configured to show it.")}else e=Object(h.a)("You're not currently a member of any communities.");return l.a.createElement("div",null,l.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},e),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}},r()(i,"contextType",u.a),n=a))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(93),d=s(480),h=s(415),u=s(90),m=s(86),p=s(85),g=s(104),v=s(113),f=s(88),b=s(101),y=s(1);let E=Object(p.a)("views.settings.tabs.user.MjolnirUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"onPersonalRuleChanged",e=>{this.setState({newPersonalRule:e.target.value})}),a()(this,"onNewListChanged",e=>{this.setState({newList:e.target.value})}),a()(this,"onAddPersonalRule",async e=>{e.preventDefault(),e.stopPropagation();let t=h.d;this.state.newPersonalRule.startsWith("@")&&(t=h.e),this.setState({busy:!0});try{const e=await d.a.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,Object(c.a)("Ignored/Blocked")),this.setState({newPersonalRule:""})}catch(e){y.a.error(e),u.a.createTrackedDialog("Failed to add Mjolnir rule","",g.a,{title:Object(c.a)("Error adding ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}),a()(this,"onSubscribeList",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await m.a.get().joinRoom(this.state.newList);await d.a.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){y.a.error(e),u.a.createTrackedDialog("Failed to subscribe to Mjolnir list","",g.a,{title:Object(c.a)("Error subscribing to list"),description:Object(c.a)("Please verify the room ID or address and try again.")})}finally{this.setState({busy:!1})}}),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=d.a.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){y.a.error(e),u.a.createTrackedDialog("Failed to remove Mjolnir rule","",g.a,{title:Object(c.a)("Error removing ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await d.a.sharedInstance().unsubscribeFromList(e.roomId),await m.a.get().leave(e.roomId)}catch(e){y.a.error(e),u.a.createTrackedDialog("Failed to unsubscribe from Mjolnir list","",g.a,{title:Object(c.a)("Error unsubscribing from list"),description:Object(c.a)("Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=m.a.get().getRoom(e.roomId),s=t?t.name:e.roomId,n=e=>{if(0===e.length)return r.a.createElement("i",null,Object(c.a)("None"));const t=[];for(const s of e)t.push(r.a.createElement("li",{key:s.kind+s.entity},r.a.createElement("code",null,s.entity)));return r.a.createElement("ul",null,t)};u.a.createTrackedDialog("View Mjolnir list rules","",v.a,{title:Object(c.a)("Ban list rules - %(roomName)s",{roomName:s}),description:r.a.createElement("div",null,r.a.createElement("h3",null,Object(c.a)("Server rules")),n(e.serverRules),r.a.createElement("h3",null,Object(c.a)("User rules")),n(e.userRules)),button:Object(c.a)("Close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=d.a.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return r.a.createElement("i",null,Object(c.a)("You have not ignored anyone."));const s=[];for(const e of t)s.push(r.a.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},r.a.createElement(f.a,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},Object(c.a)("Remove"))," ",r.a.createElement("code",null,e.entity)));return r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("You are currently ignoring:")),r.a.createElement("ul",null,s))}renderSubscribedBanLists(){const e=d.a.sharedInstance().getPersonalList(),t=d.a.sharedInstance().lists.filter(t=>!e||e.roomId!==t.roomId);if(!t||t.length<=0)return r.a.createElement("i",null,Object(c.a)("You are not subscribed to any lists"));const s=[];for(const e of t){const t=m.a.get().getRoom(e.roomId),n=t?r.a.createElement("span",null,t.name," (",r.a.createElement("code",null,e.roomId),")"):r.a.createElement("code",null,"list.roomId");s.push(r.a.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},r.a.createElement(f.a,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},Object(c.a)("Unsubscribe"))," ",r.a.createElement(f.a,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},Object(c.a)("View rules"))," ",n))}return r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("You are currently subscribed to:")),r.a.createElement("ul",null,s))}render(){const e=l.a.get().brand;return r.a.createElement("div",{className:"mx_SettingsTab mx_MjolnirUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Ignored users")),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"warning"},Object(c.a)("⚠ These settings are meant for advanced users.")),r.a.createElement("br",null),r.a.createElement("br",null),Object(c.a)("Add users and servers you want to ignore here. Use asterisks to have %(brand)s match any characters. For example, <code>@bot:*</code> would ignore all users that have the name 'bot' on any server.",{brand:e},{code:e=>r.a.createElement("code",null,e)}),r.a.createElement("br",null),r.a.createElement("br",null),Object(c.a)("Ignoring people is done through ban lists which contain rules for who to ban. Subscribing to a ban list means the users/servers blocked by that list will be hidden from you."))),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Personal ban list")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Your personal ban list holds all the users/servers you personally don't want to see messages from. After ignoring your first user/server, a new room will show up in your room list named 'My Ban List' - stay in this room to keep the ban list in effect.")),r.a.createElement("div",null,this.renderPersonalBanListRules()),r.a.createElement("div",null,r.a.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},r.a.createElement(b.a,{type:"text",label:Object(c.a)("Server or user ID to ignore"),placeholder:Object(c.a)("eg: @bot:* or example.org"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),r.a.createElement(f.a,{type:"submit",kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},Object(c.a)("Ignore"))))),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Subscribed lists")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"warning"},Object(c.a)("Subscribing to a ban list will cause you to join it!"))," ",r.a.createElement("span",null,Object(c.a)("If this isn't what you want, please use a different tool to ignore users."))),r.a.createElement("div",null,this.renderSubscribedBanLists()),r.a.createElement("div",null,r.a.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},r.a.createElement(b.a,{type:"text",label:Object(c.a)("Room ID or address of ban list"),value:this.state.newList,onChange:this.onNewListChanged}),r.a.createElement(f.a,{type:"submit",kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},Object(c.a)("Subscribe"))))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(84),l=s(85),d=s(383),h=s(104),u=s(97),m=s(96);let p=Object(l.a)("views.dialogs.ConfirmAndWaitRedactDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"onParentFinished",async e=>{if(e){this.setState({isRedacting:!0});try{await this.props.redact(),this.props.onFinished(!0)}catch(e){const t=e.errcode||e.statusCode;void 0!==t?this.setState({redactionErrorCode:t}):this.props.onFinished(!0)}}else this.props.onFinished(!1)}),this.state={isRedacting:!1,redactionErrorCode:null}}render(){if(this.state.isRedacting){if(this.state.redactionErrorCode){const e=this.state.redactionErrorCode;return r.a.createElement(h.a,{onFinished:this.props.onFinished,title:Object(c.a)("Error"),description:Object(c.a)("You cannot delete this message. (%(code)s)",{code:e})})}return r.a.createElement(u.a,{onFinished:this.props.onFinished,hasCancel:!1,title:Object(c.a)("Removing…")},r.a.createElement(m.a,null))}return r.a.createElement(d.b,{onFinished:this.onParentFinished})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(86),l=s(84),d=s(136),h=s(89),u=s(85),m=s(97),p=s(328),g=s(96),v=s(1043),f=s(332),b=s(94),y=s(4),E=s(1);let S=Object(u.a)("views.dialogs.MessageEditHistoryDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),a()(this,"loadMoreEdits",async e=>{if(e||!this.state.nextBatch&&!this.state.isLoading)return!1;const t={from:this.state.nextBatch},s=this.props.mxEvent.getRoomId(),n=this.props.mxEvent.getId(),i=c.a.get(),{resolve:a,reject:o,promise:r}=Object(y.l)();let l;try{l=await i.relations(s,n,b.c.Replace,b.a.RoomMessage,t)}catch(e){return e.errcode&&E.a.error("fetching /relations failed with error",e),this.setState({error:e},()=>o(e)),r}const d=l.events;return this.locallyRedactEventsIfNeeded(d),this.setState({originalEvent:this.state.originalEvent||l.originalEvent,events:this.state.events.concat(d),nextBatch:l.nextBatch,isLoading:!1},()=>{const e=!!this.state.nextBatch;a(e)}),r}),this.state={originalEvent:null,error:null,events:[],nextBatch:null,isLoading:!0,isTwelveHour:h.b.getValue("showTwelveHourTimestamps")}}locallyRedactEventsIfNeeded(e){const t=this.props.mxEvent.getRoomId(),s=c.a.get().getRoom(t).getPendingEvents();for(const t of e){const e=s.find(e=>"m.room.redaction"===e.getType()&&e.getAssociatedId()===t.getId());e&&t.markLocallyRedacted(e)}}componentDidMount(){this.loadMoreEdits()}renderEdits(){const e=[];let t,s=this.state.events;this.state.originalEvent&&!this.state.nextBatch&&(s=s.concat(this.state.originalEvent));const n=this.props.mxEvent.getId();return s.forEach((i,a)=>{t&&!Object(d.k)(t.getDate(),i.getDate())||e.push(r.a.createElement("li",{key:i.getTs()+"~"},r.a.createElement(f.a,{ts:i.getTs()})));const o=i.getId()===n;e.push(r.a.createElement(v.a,{key:i.getId(),previousEdit:o?null:s[a+1],isBaseEvent:o,mxEvent:i,isTwelveHour:this.state.isTwelveHour})),t=i}),e}render(){let e;if(this.state.error){const{error:t}=this.state;e="M_UNRECOGNIZED"===t.errcode?r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(l.a)("Your homeserver doesn't seem to support this feature.")):t.errcode?r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(l.a)("Something went wrong!")):r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(l.a)("Cannot reach homeserver"),r.a.createElement("br",null),Object(l.a)("Ensure you have a stable internet connection, or get in touch with the server admin"))}else e=this.state.isLoading?r.a.createElement(g.a,null):r.a.createElement(p.a,{className:"mx_MessageEditHistoryDialog_scrollPanel",onFillRequest:this.loadMoreEdits,stickyBottom:!1,startAtBottom:!1},r.a.createElement("ul",{className:"mx_MessageEditHistoryDialog_edits"},this.renderEdits()));return r.a.createElement(m.a,{className:"mx_MessageEditHistoryDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Message edits")},e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return m}));var n=s(82),i=s.n(n),a=s(148),o=s.n(a),r=s(250),c=s(86),l=s(89),d=s(385),h=s(120);function u(e,t,s){const n=c.a.get().getRoom(t.getRoomId()),a=l.b.getValue("Pill.shouldShowPillAvatar");let m=e[0];for(;m;){let e=!1;if("A"===m.tagName&&m.getAttribute("href")){const t=m.getAttribute("href"),r=Object(h.i)(t);if(r&&!r.eventId){const r=document.createElement("span"),c=i.a.createElement(d.a,{url:t,inMessage:!0,room:n,shouldShowPillAvatar:a});o.a.render(c,r),m.parentNode.replaceChild(r,m),s.push(r),e=!0,m=r}}else if(m.nodeType===Node.TEXT_NODE&&!m.parentElement.classList.contains("mx_AtRoomPill")){let e=m;const l=[];for(;null!==e;){const t=d.a.roomNotifPos(e.textContent);let s=null;if(t>-1){let n=e;t>0&&(n=n.splitText(t)),n.textContent.length>d.a.roomNotifLen()&&(s=n.splitText(d.a.roomNotifLen())),l.push(n)}e=s}if(l.length>0){const e=new r.a(c.a.get()),h=e.getPushRuleById(".m.rule.roomnotif");if(h&&e.ruleMatchesEvent(h,t)){for(const e of l){m=e.nextSibling;const t=document.createElement("span"),r=i.a.createElement(d.a,{type:d.a.TYPE_AT_ROOM_MENTION,inMessage:!0,room:n,shouldShowPillAvatar:a});o.a.render(r,t),e.parentNode.replaceChild(t,e),s.push(t)}continue}}}m.childNodes&&m.childNodes.length&&!e&&u(m.childNodes,t,s),m=m.nextSibling}}function m(e){for(const t of e)o.a.unmountComponentAtNode(t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(83),a=s.n(i),o=s(82),r=s.n(o),c=s(85);let l=Object(c.a)("views.elements.Spoiler")(n=class extends r.a.Component{constructor(e){super(e),a()(this,"toggleVisible",e=>{this.state.visible||(e.preventDefault(),e.stopPropagation()),this.setState({visible:!this.state.visible})}),this.state={visible:!1}}render(){const e=this.props.reason?r.a.createElement("span",{className:"mx_EventTile_spoiler_reason"},"("+this.props.reason+")"):null;return r.a.createElement("span",{className:"mx_EventTile_spoiler"+(this.state.visible?" visible":""),onClick:this.toggleVisible},e," ",r.a.createElement("span",{className:"mx_EventTile_spoiler_content",dangerouslySetInnerHTML:{__html:this.props.contentHtml}}))}})||n},function(e,t,s){"use strict";var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(91),h=s.n(d),u=s(117),m=s(84),p=s(87),g=s(1047),v=s(574),f=s(915),b=s(167),y=s(920),E=s(222),S=s(594),_=s(333),w=s(92),C=s(124),O=s(195),k=s(85),R=s(922),I=s(90),x=s(94),T=s(104),j=s(113),N=s(88),P=s(383),D=s(89),M=s(1),A=s(98),U=s(118),L=s(575);function F(e,t){const s=Object(f.a)(e);s&&(e=Object(f.d)(e));const n=!!t.replyEventId;let i="",a="";n&&(i=function(e){const t=e.getContent().body.split("\n").map(e=>e.trim());return t.length>2&&t[0].startsWith("> ")&&0===t[1].length?t[0]+"\n\n":""}(t),a=function(e){const t=e.getContent().formatted_body;if(!t)return"";const s=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return s&&s.outerHTML||""}(t));const o=Object(f.f)(e),r={msgtype:s?x.b.Emote:x.b.Text,body:o},c={msgtype:r.msgtype,body:`${i} * ${o}`},l=Object(f.b)(e,{forceHTML:n});l&&(r.format="org.matrix.custom.html",r.formatted_body=l,c.format=r.format,c.formatted_body=`${a} * ${l}`);const d={"m.new_content":r,"m.relates_to":{rel_type:"m.replace",event_id:t.getId()}};return Object.assign(d,c)}let B=Object(k.a)("views.rooms.EditMessageComposer")((a=i=class extends l.a.Component{constructor(e,t){super(e),r()(this,"context",void 0),r()(this,"editorRef",Object(c.createRef)()),r()(this,"dispatcherRef",void 0),r()(this,"model",null),r()(this,"onKeyDown",e=>{var t;if(null!==(t=this.editorRef.current)&&void 0!==t&&t.isComposing(e))return;switch(Object(O.f)().getMessageComposerAction(e)){case O.b.Send:this.sendEdit(),e.preventDefault();break;case O.b.CancelEditing:this.cancelEdit();break;case O.b.EditPrevMessage:{var s,n;if(null!==(s=this.editorRef.current)&&void 0!==s&&s.isModified()||null===(n=this.editorRef.current)||void 0===n||!n.isCaretAtStart())return;const t=Object(b.c)({events:this.events,isForward:!1,fromEventId:this.props.editState.getEvent().getId()});t&&(p.a.dispatch({action:w.a.EditEvent,event:t,timelineRenderingType:this.context.timelineRenderingType}),e.preventDefault());break}case O.b.EditNextMessage:{var i,a;if(null!==(i=this.editorRef.current)&&void 0!==i&&i.isModified()||null===(a=this.editorRef.current)||void 0===a||!a.isCaretAtEnd())return;const t=Object(b.c)({events:this.events,isForward:!0,fromEventId:this.props.editState.getEvent().getId()});t?p.a.dispatch({action:w.a.EditEvent,event:t,timelineRenderingType:this.context.timelineRenderingType}):(this.clearStoredEditorState(),p.a.dispatch({action:w.a.EditEvent,event:null,timelineRenderingType:this.context.timelineRenderingType}),p.a.dispatch({action:w.a.FocusSendMessageComposer,context:this.context.timelineRenderingType})),e.preventDefault();break}}}),r()(this,"cancelEdit",()=>{this.clearStoredEditorState(),p.a.dispatch({action:w.a.EditEvent,event:null,timelineRenderingType:this.context.timelineRenderingType}),p.a.dispatch({action:w.a.FocusSendMessageComposer,context:this.context.timelineRenderingType})}),r()(this,"saveStoredEditorState",()=>{const e=R.a.createItem(this.model);this.clearPreviousEdit(),localStorage.setItem(this.editorRoomKey,this.props.editState.getEvent().getId()),localStorage.setItem(this.editorStateKey,JSON.stringify(e))}),r()(this,"sendEdit",async()=>{const e=C.a.getTimestamp(),t=this.props.editState.getEvent();if(D.b.getValue("MessageComposerInput.autoReplaceEmoji")){var s,n;const e=null===(s=this.editorRef.current)||void 0===s?void 0:s.getCaret(),t=this.model.positionForOffset(e.offset,e.atNodeEnd);null===(n=this.editorRef.current)||void 0===n||n.replaceEmoticon(t,S.a)}const i=F(this.model,t),a=i["m.new_content"];let o=!0;if(""===(null==a?void 0:a.body))return this.cancelPreviousPendingEdit(),void Object(P.a)({mxEvent:t});if(this.isContentModified(a)){const s=t.getRoomId();if(!Object(f.a)(this.model)&&this.isSlashCommand()){const[e,t,n]=this.getSlashCommand();if(e)e.category===_.a.messages?i["m.new_content"]=await this.runSlashCommand(e,t,s):(this.runSlashCommand(e,t,s),o=!1);else{const{finished:e}=I.a.createTrackedDialog("Unknown command","",j.a,{title:Object(m.a)("Unknown Command"),description:l.a.createElement("div",null,l.a.createElement("p",null,Object(m.a)("Unrecognised command: %(commandText)s",{commandText:n})),l.a.createElement("p",null,Object(m.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>l.a.createElement("code",null,e)})),l.a.createElement("p",null,Object(m.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>l.a.createElement("code",null,e)}))),button:Object(m.a)("Send as message")}),[t]=await e;if(!t)return}}if(o){this.cancelPreviousPendingEdit();const t=this.props.editState.getEvent().threadRootId||null,n=this.props.mxClient.sendMessage(s,t,i);this.clearStoredEditorState(),p.a.dispatch({action:"message_sent"}),C.a.instance.trackSendMessage(e,n,s,!0,!1,i)}}p.a.dispatch({action:w.a.EditEvent,event:null,timelineRenderingType:this.context.timelineRenderingType}),p.a.dispatch({action:w.a.FocusSendMessageComposer,context:this.context.timelineRenderingType})}),r()(this,"onChange",()=>{var e;this.state.saveDisabled&&null!==(e=this.editorRef.current)&&void 0!==e&&e.isModified()&&this.setState({saveDisabled:!1})}),r()(this,"onAction",e=>{if(this.editorRef.current)if(e.action===w.a.ComposerInsert){if(e.timelineRenderingType!==this.context.timelineRenderingType)return;if(e.composerType!==L.a.Edit)return;var t;if(e.userId)null===(t=this.editorRef.current)||void 0===t||t.insertMention(e.userId);else if(e.event){var s;null===(s=this.editorRef.current)||void 0===s||s.insertQuotedMessage(e.event)}else if(e.text){var n;null===(n=this.editorRef.current)||void 0===n||n.insertPlaintext(e.text)}}else e.action===w.a.FocusEditMessageComposer&&this.editorRef.current.focus()}),this.context=t;const s=this.createEditorModel(),n=this.props.editState.getEvent(),i=F(this.model,n);this.state={saveDisabled:!s||!this.isContentModified(i["m.new_content"])},window.addEventListener("beforeunload",this.saveStoredEditorState),this.dispatcherRef=p.a.register(this.onAction)}getRoom(){return this.props.mxClient.getRoom(this.props.editState.getEvent().getRoomId())}get editorRoomKey(){return`mx_edit_room_${this.getRoom().roomId}_${this.context.timelineRenderingType}`}get editorStateKey(){return"mx_edit_state_"+this.props.editState.getEvent().getId()}get events(){const e=this.context.liveTimeline.getEvents(),t=this.getRoom().getPendingEvents(),s=Boolean(this.props.editState.getEvent().getThread());return e.concat(s?[]:t)}get shouldSaveStoredEditorState(){return null!==localStorage.getItem(this.editorRoomKey)}restoreStoredEditorState(e){const t=localStorage.getItem(this.editorStateKey);if(t)try{const{parts:s}=JSON.parse(t);return s.map(t=>e.deserializePart(t))}catch(e){M.a.error("Error parsing editing state: ",e)}}clearStoredEditorState(){localStorage.removeItem(this.editorRoomKey),localStorage.removeItem(this.editorStateKey)}clearPreviousEdit(){localStorage.getItem(this.editorRoomKey)&&localStorage.removeItem("mx_edit_state_"+localStorage.getItem(this.editorRoomKey))}isSlashCommand(){const e=this.model.parts[0];if(e){if(e.type===E.b.Command&&e.text.startsWith("/")&&!e.text.startsWith("//"))return!0;if(e.text.startsWith("/")&&!e.text.startsWith("//")&&(e.type===E.b.Plain||e.type===E.b.PillCandidate))return!0}return!1}isContentModified(e){const t=this.props.editState.getEvent().getContent();return t.msgtype!==e.msgtype||t.body!==e.body||t.format!==e.format||t.formatted_body!==e.formatted_body}getSlashCommand(){const e=this.model.parts.reduce((e,t)=>t.type===E.b.UserPill?e+t.resourceId:e+t.text,""),{cmd:t,args:s}=Object(_.d)(e);return[t,s,e]}async runSlashCommand(e,t,s){var n,i,a;const o=(null===(n=this.props.editState)||void 0===n||null===(i=n.getEvent())||void 0===i||null===(a=i.getThread())||void 0===a?void 0:a.id)||null,r=e.run(s,o,t);let c,l=r.error;if(r.promise)try{e.category===_.a.messages?c=await r.promise:await r.promise}catch(e){l=e}if(l){M.a.error("Command failure: %s",l);const e=!!r.promise?Object(m.b)("Server error"):Object(m.b)("Command error");let t;t="string"==typeof l?l:l.message?l.message:Object(m.a)("Server unavailable, overloaded, or something else went wrong."),I.a.createTrackedDialog(e,"",T.a,{title:Object(m.a)(e),description:t})}else if(M.a.log("Command success."),c)return c}cancelPreviousPendingEdit(){const e=this.props.editState.getEvent().replacingEvent();!e||e.status!==u.a.QUEUED&&e.status!==u.a.NOT_SENT||this.props.mxClient.cancelPendingEvent(e)}componentWillUnmount(){const e=document.getSelection();let t;var s;e.focusNode&&(t=Object(v.a)(null===(s=this.editorRef.current)||void 0===s?void 0:s.editorRef.current,e).caret);const n=this.model.serializeParts();this.props.editState.setEditorState(t,n),window.removeEventListener("beforeunload",this.saveStoredEditorState),this.shouldSaveStoredEditorState&&this.saveStoredEditorState(),p.a.unregister(this.dispatcherRef)}createEditorModel(){const{editState:e}=this.props,t=this.getRoom(),s=new E.a(t,this.props.mxClient);let n,i=!1;if(e.hasEditorState())n=e.getSerializedParts().map(e=>s.deserializePart(e));else{const t=this.restoreStoredEditorState(s);n=t||Object(y.a)(e.getEvent(),s),i=!!t}return this.model=new g.a(n,s),this.saveStoredEditorState(),i}render(){var e,t,s;return l.a.createElement("div",{className:h()("mx_EditMessageComposer",this.props.className),onKeyDown:this.onKeyDown},l.a.createElement(S.b,{ref:this.editorRef,model:this.model,room:this.getRoom(),threadId:null===(e=this.props.editState)||void 0===e||null===(t=e.getEvent())||void 0===t||null===(s=t.getThread())||void 0===s?void 0:s.id,initialCaret:this.props.editState.getCaret(),label:Object(m.a)("Edit message"),onChange:this.onChange}),l.a.createElement("div",{className:"mx_EditMessageComposer_buttons"},l.a.createElement(N.a,{kind:"secondary",onClick:this.cancelEdit},Object(m.a)("Cancel")),l.a.createElement(N.a,{kind:"primary",onClick:this.sendEdit,disabled:this.state.saveDisabled},Object(m.a)("Save"))))}},r()(i,"contextType",U.b),n=a))||n;const V=Object(A.b)(B);t.a=V},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(387),o=s(1044),r=s(88),c=s(84),l=s(98),d=s(259),h=s(1);const u=(e,t,s)=>Promise.all(t.map(async t=>{try{const n=await e.getUrlPreview(t,s);if(n&&Object.keys(n).length>0)return[t,n]}catch(e){h.a.error("Failed to get URL preview: "+e)}})).then(e=>e.filter(Boolean));t.a=({links:e,mxEvent:t,onCancelClick:h,onHeightChanged:m})=>{const p=Object(n.useContext)(l.a),[g,v]=Object(a.a)(),f=t.getTs(),b=Object(d.a)(async()=>u(p,e,f),[e,f],[]);Object(n.useEffect)(()=>{m()},[m,g,b]);const y=g?b:b.slice(0,2);let E;return b.length>2&&(E=i.a.createElement(r.a,{onClick:v},g?Object(c.a)("Collapse"):Object(c.a)("Show %(count)s other previews",{count:b.length-y.length}))),i.a.createElement("div",{className:"mx_LinkPreviewGroup"},y.map(([e,n],a)=>i.a.createElement(o.a,{key:e,link:e,preview:n,mxEvent:t},0===a?i.a.createElement(r.a,{className:"mx_LinkPreviewGroup_hide",onClick:h,"aria-label":Object(c.a)("Close preview")},i.a.createElement("img",{className:"mx_filterFlipColor",alt:"",role:"presentation",src:s(402),width:"18",height:"18"})):void 0)),E)}},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(146),o=s(179),r=s(839);t.a=({description:e,acceptLabel:t,dismissLabel:s,onAccept:n,onDismiss:c,toastKey:l,numSeconds:d})=>{const h=()=>{c&&c(),a.a.sharedInstance().dismissToast(l)},u=Object(r.a)(h,1e3,d);let m=s;return u>0&&(m+=` (${u})`),i.a.createElement(o.a,{description:e,acceptLabel:t,onAccept:n,rejectLabel:m,onReject:h})}},,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return ee})),s.d(t,"a",(function(){return te}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(91),c=s.n(r),l=s(112),d=s(89),h=s(84),u=s(118);class m{constructor({commandRegex:e,forcedCommandRegex:t,renderingType:s}){if(i()(this,"commandRegex",void 0),i()(this,"forcedCommandRegex",void 0),i()(this,"renderingType",u.a.Room),e){if(!e.global)throw new Error("commandRegex must have global flag set");this.commandRegex=e}if(t){if(!t.global)throw new Error("forcedCommandRegex must have global flag set");this.forcedCommandRegex=t}s&&(this.renderingType=s)}destroy(){}getCurrentCommand(e,t,s=!1){let n,i=this.commandRegex;if(s&&this.shouldForceComplete()&&(i=this.forcedCommandRegex||/\S+/g),!i)return null;for(i.lastIndex=0;null!==(n=i.exec(e));){const e=n.index,s=e+n[0].length;if(t.start<=s&&t.end>=e)return{command:n,range:{start:e,end:s}}}return{command:null,range:{start:-1,end:-1}}}shouldForceComplete(){return!1}}var p=s(214),g=s(95),v=s.n(g),f=s(102),b=s.n(f);const y=["title","subtitle","description","className"],E=["title","subtitle","description","className","children"],S=Object(a.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:i,className:a}=e,r=b()(e,y);return o.a.createElement("div",v()({},r,{className:c()("mx_Autocomplete_Completion_block",a),role:"option",ref:t}),o.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),o.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),o.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},i))}),_=Object(a.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:i,className:a,children:r}=e,l=b()(e,E);return o.a.createElement("div",v()({},l,{className:c()("mx_Autocomplete_Completion_pill",a),role:"option",ref:t}),r,o.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),o.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),o.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},i))});var w=s(333);const C=/(^\/\w*)(?: .*)?/g;var O=s(86),k=s(120),R=s(183),I=s(103),x=s(125);const T=/\B\+\S*/g;class j extends m{constructor(e,t){super({commandRegex:T,renderingType:t}),i()(this,"matcher",void 0),this.matcher=new p.a([],{keys:["groupId","name","shortDescription"]})}async getCompletions(e,t,s=!1,n=-1){if(/^(\/join|\/leave)/.test(e))return[];const i=O.a.get();let a=[];const{command:r,range:c}=this.getCurrentCommand(e,t,s);if(r){const e=i.getGroups().filter(({myMembership:e})=>"join"===e),t=await Promise.all(e.map(async({groupId:e})=>{try{return R.a.getGroupProfileCached(i,e)}catch(t){return Promise.resolve({name:"",groupId:e,avatarUrl:"",shortDescription:""})}}));this.matcher.setObjects(t);const s=r[0];a=this.matcher.match(s,n),a=Object(l.sortBy)(a,[e=>function(e,t){const s=t.indexOf(e);return-1===s?1/0:s}(s,e.groupId),e=>e.groupId.length]).map(({avatarUrl:e,groupId:t,name:s})=>({completion:t,suffix:" ",type:"community",href:Object(k.f)(t),component:o.a.createElement(_,{title:s,description:t},o.a.createElement(x.a,{name:s||t,width:24,height:24,url:e?Object(I.b)(e).getSquareThumbnailHttp(24):null})),range:c})).slice(0,4)}return a}getName(){return"💬 "+Object(h.a)("Communities")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(h.a)("Community Autocomplete")},e)}}var N=s(126),P=s(106);const D=/\B#\S*/g;function M(e,t,s=""){return{room:e,matchName:s,displayedAlias:t}}class A extends m{constructor(e,t){super({commandRegex:D,renderingType:t}),i()(this,"matcher",void 0),this.matcher=new p.a([],{keys:["displayedAlias","matchName"]})}getRooms(){let e=O.a.get().getVisibleRooms();return P.a.spacesEnabled&&(e=e.filter(e=>!e.isSpaceRoom())),e}async getCompletions(e,t,s=!1,n=-1){let i=[];const{command:a,range:r}=this.getCurrentCommand(e,t,s);if(a){let e=this.getRooms().reduce((e,t)=>{if(t.getCanonicalAlias()&&(e=e.concat(M(t,t.getCanonicalAlias(),t.name))),t.getAltAliases().length){const s=t.getAltAliases().map(e=>M(t,e));e=e.concat(s)}return e},[]);e=e.filter(t=>{const s=t.room.currentState.getStateEvents("m.room.tombstone","");if(s&&s.getContent()&&s.getContent().replacement_room){return!e.some(e=>e.room.roomId===s.getContent().replacement_room)}return!0}),this.matcher.setObjects(e);const t=a[0];i=this.matcher.match(t,n),i=Object(l.sortBy)(i,[e=>{return t=e.displayedAlias,s=e.room,t===s.getCanonicalAlias()?0:1;var t,s},e=>e.displayedAlias.length]),i=Object(l.uniqBy)(i,e=>e.room),i=i.map(e=>({completion:e.displayedAlias,completionId:e.room.roomId,type:"room",suffix:" ",href:Object(k.g)(e.displayedAlias),component:o.a.createElement(_,{title:e.room.name,description:e.displayedAlias},o.a.createElement(N.a,{width:24,height:24,room:e.room})),range:r})).filter(e=>!!e.completion&&e.completion.length>0)}return i}getName(){return Object(h.a)("Rooms")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(h.a)("Room Autocomplete")},e)}}var U=s(142);const L=/\B@\S*/g,F=/[^/,:; \t\n]\S*/g;var B=s(305),V=s(919);const K=new RegExp("("+s.n(V).a.source+"|(?:^|\\s):[+-\\w]*:?)$","g"),W=B.b.sort((e,t)=>e.group===t.group?e.order-t.order:e.group-t.group).map((e,t)=>({emoji:e,_orderBy:t}));function G(e,t){const s=t.indexOf(e);return-1===s?1/0:s}const H=/@\S*/g;var q=s(370);class $ extends A{getRooms(){return O.a.get().getVisibleRooms().filter(e=>e.isSpaceRoom())}getName(){return Object(h.a)("Spaces")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(h.a)("Space Autocomplete")},e)}}const z=[class extends m{constructor(e,t){super({commandRegex:L,forcedCommandRegex:F,renderingType:t}),i()(this,"matcher",void 0),i()(this,"users",void 0),i()(this,"room",void 0),i()(this,"onRoomTimeline",(e,t,s,n,i)=>{t&&(n||t.roomId===this.room.roomId&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&!s&&i&&i.liveEvent&&this.onUserSpoke(e.sender))}),i()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.room.roomId&&(this.users=null)}),this.room=e,this.matcher=new p.a([],{keys:["name"],funcs:[e=>e.userId.slice(1)],shouldMatchWordsOnly:!1}),O.a.get().on("Room.timeline",this.onRoomTimeline),O.a.get().on("RoomState.members",this.onRoomStateMember)}destroy(){O.a.get()&&(O.a.get().removeListener("Room.timeline",this.onRoomTimeline),O.a.get().removeListener("RoomState.members",this.onRoomStateMember))}async getCompletions(e,t,s=!1,n=-1){this.users||this.makeUsers();let i=[];const{command:a,range:r}=this.getCurrentCommand(e,t,s);if(!a)return i;const c=a[0];if(c&&"@"!==c){const e=c.startsWith("@")?c.substring(1):c;i=this.matcher.match(e,n).map(e=>{const s=e.name||e.userId||"";return{completion:e.rawDisplayName,completionId:e.userId,type:"user",suffix:t.beginning&&0===r.start?": ":" ",href:Object(k.h)(e.userId),component:o.a.createElement(_,{title:s,description:e.userId},o.a.createElement(U.a,{member:e,width:24,height:24})),range:r}})}return i}getName(){return Object(h.a)("Users")}makeUsers(){const e=this.room.getLiveTimeline().getEvents(),t={};for(const s of e)t[s.getSender()]=s.getTs();const s=O.a.get().credentials.userId;this.users=this.room.getJoinedMembers().filter(({userId:e})=>e!==s),this.users=this.users.concat(this.room.getMembersWithMembership("invite")),this.users=Object(l.sortBy)(this.users,e=>1e20-t[e.userId]||1e20),this.matcher.setObjects(this.users)}onUserSpoke(e){this.users&&e&&e.userId!==O.a.get().credentials.userId&&(this.users.splice(this.users.findIndex(t=>t.userId===e.userId),1),this.users=[e,...this.users],this.matcher.setObjects(this.users))}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(h.a)("User Autocomplete")},e)}shouldForceComplete(){return!0}},A,class extends m{constructor(e,t){super({commandRegex:K,renderingType:t}),i()(this,"matcher",void 0),i()(this,"nameMatcher",void 0),this.matcher=new p.a(W,{keys:[],funcs:[e=>e.emoji.shortcodes.map(e=>`:${e}:`)],shouldMatchWordsOnly:!1}),this.nameMatcher=new p.a(W,{keys:["emoji.annotation"],shouldMatchWordsOnly:!0})}async getCompletions(e,t,s,n=-1){if(!d.b.getValue("MessageComposerInput.suggestEmoji"))return[];let i=[];const{command:a,range:r}=this.getCurrentCommand(e,t);if(a&&a[0].length>2){const e=a[0];i=this.matcher.match(e,n),i=i.concat(this.nameMatcher.match(e));const t=[];t.push(t=>G(e,t.emoji.emoticon||"")),t.push(t=>G(e,t.emoji.shortcodes[0])),t.push(t=>Math.min(...t.emoji.shortcodes.map(t=>G(e.substring(1),t)))),e.length>1&&t.push(e=>e.emoji.shortcodes[0].length),t.push(e=>e._orderBy),i=Object(l.sortBy)(Object(l.uniq)(i),t),i=i.map(e=>({completion:e.emoji.unicode,component:o.a.createElement(_,{title:`:${e.emoji.shortcodes[0]}:`,"aria-label":e.emoji.unicode},o.a.createElement("span",null,e.emoji.unicode)),range:r})).slice(0,20)}return i}getName(){return"😃 "+Object(h.a)("Emoji")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(h.a)("Emoji Autocomplete")},e)}},class extends m{constructor(e,t){super({commandRegex:H,renderingType:t}),this.room=e}async getCompletions(e,t,s=!1,n=-1){const i=O.a.get();if(!this.room.currentState.mayTriggerNotifOfType("room",i.credentials.userId))return[];const{command:a,range:r}=this.getCurrentCommand(e,t,s);return a&&a[0]&&"@room".startsWith(a[0])&&a[0].length>1?[{completion:"@room",completionId:"@room",type:"at-room",suffix:" ",component:o.a.createElement(_,{title:"@room",description:Object(h.a)("Notify the whole room")},o.a.createElement(N.a,{width:24,height:24,room:this.room})),range:r}]:[]}getName(){return"❗️ "+Object(h.a)("Room Notification")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(h.a)("Notification Autocomplete")},e)}},class extends m{constructor(e,t){super({commandRegex:C,renderingType:t}),i()(this,"matcher",void 0),this.matcher=new p.a(w.c,{keys:["command","args","description"],funcs:[({aliases:e})=>e.join(" ")],context:t})}async getCompletions(e,t,s,n=-1){const{command:i,range:a}=this.getCurrentCommand(e,t);if(!i)return[];let r=[];if(i[0]!==i[1]){const e=i[1].substr(1);if(w.b.has(e)&&w.b.get(e).isEnabled()){if(w.b.get(e).hideCompletionAfterSpace)return[];r=[w.b.get(e)]}}else r="/"===e?w.c:this.matcher.match(i[1],n);return r.filter(e=>{const t=!e.renderingTypes||e.renderingTypes.includes(this.renderingType);return e.isEnabled()&&t}).map(e=>{let t=e.getCommand()+" ";const s=e.aliases.find(e=>"/"+e===i[1]);return(s||e.getCommand()===i[1])&&(t=i[0]),{completion:t,type:"command",component:o.a.createElement(S,{title:"/"+(s||e.command),subtitle:e.args,description:Object(h.a)(e.description)}),range:a}})}getName(){return"*️⃣ "+Object(h.a)("Commands")}renderCompletions(e){return o.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(h.a)("Command Autocomplete")},e)}}];P.a.spacesEnabled?z.push($):z.push(j);class J{constructor(e,t=u.a.Room){i()(this,"room",void 0),i()(this,"providers",void 0),this.room=e,this.providers=z.map(s=>new s(e,t))}destroy(){this.providers.forEach(e=>{e.destroy()})}async getCompletions(e,t,s=!1,n=-1){return(await Promise.all(this.providers.map(async i=>await Object(q.b)(i.getCompletions(e,t,s,n),null,3e3)))).map((n,i)=>{if(n&&n.length)return{completions:n,provider:this.providers[i],command:this.providers[i].getCurrentCommand(e,t,s)}}).filter(Boolean)}}var Y,Q,X,Z=s(85);const ee=e=>"mx_Autocomplete_Completion_"+e;let te=Object(Z.a)("views.rooms.Autocomplete")((X=Q=class extends o.a.PureComponent{constructor(e){super(e),i()(this,"autocompleter",void 0),i()(this,"queryRequested",void 0),i()(this,"debounceCompletionsRequest",void 0),i()(this,"containerRef",Object(a.createRef)()),i()(this,"hide",()=>{this.setState({hide:!0,selectionOffset:1,completions:[],completionList:[]})}),i()(this,"onConfirmCompletion",()=>{this.onCompletionClicked(this.state.selectionOffset)}),i()(this,"onCompletionClicked",e=>{const t=this.countCompletions();return!(0===t||e<1||e>t)&&(this.props.onConfirm(this.state.completionList[e-1]),this.hide(),!0)}),this.state={completions:[],completionList:[],selectionOffset:1,shouldShowCompletions:!0,hide:!1,forceComplete:!1}}componentDidMount(){this.autocompleter=new J(this.props.room,this.context.timelineRenderingType),this.applyNewProps()}applyNewProps(e,t){t&&this.props.room.roomId!==t.roomId&&(this.autocompleter.destroy(),this.autocompleter=new J(this.props.room)),e!==this.props.query&&this.complete(this.props.query,this.props.selection)}componentWillUnmount(){this.autocompleter.destroy()}complete(e,t){if(this.queryRequested=e,this.debounceCompletionsRequest&&clearTimeout(this.debounceCompletionsRequest),""===e)return this.setState({completions:[],completionList:[],selectionOffset:1,hide:!0}),Promise.resolve(null);let s=d.b.getValue("autocompleteDelay");return(this.state.completions.length>0||this.state.forceComplete)&&(s=0),new Promise(n=>{this.debounceCompletionsRequest=setTimeout(()=>{n(this.processQuery(e,t))},s)})}processQuery(e,t){return this.autocompleter.getCompletions(e,t,this.state.forceComplete,20).then(t=>{e===this.queryRequested&&this.processCompletions(t)})}processCompletions(e){const t=Object(l.flatMap)(e,e=>e.completions);let s=1;if(t.length>0){const e=this.state.selectionOffset<=1?null:this.state.completionList[this.state.selectionOffset-1].completion;s=t.findIndex(t=>t.completion===e),-1===s?s=1:s++}let n=!0;e.some(e=>!!e.command.command)&&(n=!1,this.props.onSelectionChange&&this.props.onSelectionChange(s-1)),this.setState({completions:e,completionList:t,selectionOffset:s,hide:n,forceComplete:!1})}hasSelection(){return this.countCompletions()>0&&0!==this.state.selectionOffset}countCompletions(){return this.state.completionList.length}moveSelection(e){const t=this.countCompletions();if(0===t)return;const s=(this.state.selectionOffset+e+t-1)%t;this.setSelection(1+s)}onEscape(e){0!==this.countCompletions()&&(e.preventDefault(),this.hide())}forceComplete(){return new Promise(e=>{this.setState({forceComplete:!0,hide:!1},()=>{this.complete(this.props.query,this.props.selection).then(()=>{e(this.countCompletions())})})})}setSelection(e){this.setState({selectionOffset:e,hide:!1}),this.props.onSelectionChange&&this.props.onSelectionChange(e-1)}componentDidUpdate(e){this.applyNewProps(e.query,e.room);const t=this.refs["completion"+this.state.selectionOffset];t?t.scrollIntoView({behavior:"auto",block:"nearest"}):this.containerRef.current&&this.containerRef.current.scrollTo({top:0})}render(){let e=1;const t=this.state.completions.map((t,s)=>{const n=t.completions.map((t,s)=>{const n=e===this.state.selectionOffset,i=c()("mx_Autocomplete_Completion",{selected:n}),a=e;e++;return o.a.cloneElement(t.component,{key:s,ref:"completion"+a,id:ee(a-1),className:i,onClick:()=>{this.onCompletionClicked(a)},"aria-selected":n})});return n.length>0?o.a.createElement("div",{key:s,className:"mx_Autocomplete_ProviderSection",role:"presentation"},o.a.createElement("div",{className:"mx_Autocomplete_provider_name"},t.provider.getName()),t.provider.renderCompletions(n)):null}).filter(e=>!!e);return!this.state.hide&&t.length>0?o.a.createElement("div",{id:"mx_Autocomplete",className:"mx_Autocomplete",ref:this.containerRef,role:"listbox"},t):null}},i()(Q,"contextType",u.b),Y=X))||Y},function(e,t,s){"use strict";s.d(t,"a",(function(){return at})),s.d(t,"b",(function(){return ot}));var n=s(95),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(156),d=s(224),h=s(181),u=s(4),m=(s(1567),s(1568),s(140)),p=s(124);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class f{constructor(e,t){this.failedEventId=e,this.errorCode=t,o()(this,"ts",void 0),this.ts=Date.now()}}class b{constructor(e,t){if(this.fn=e,this.errorCodeMapFn=t,o()(this,"failures",[]),o()(this,"failureCounts",{}),o()(this,"trackedEventHashMap",{}),o()(this,"checkInterval",null),o()(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if(t&&"function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}eventDecrypted(e,t){t?this.addDecryptionFailure(new f(e.getId(),t.code)):this.removeDecryptionFailuresForEvent(e)}addDecryptionFailure(e){this.failures.push(e)}removeDecryptionFailuresForEvent(e){this.failures=this.failures.filter(t=>t.failedEventId!==e.getId())}start(){this.checkInterval=setInterval(()=>this.checkFailures(Date.now()),b.CHECK_INTERVAL_MS),this.trackInterval=setInterval(()=>this.trackFailures(),b.TRACK_INTERVAL_MS)}stop(){clearInterval(this.checkInterval),clearInterval(this.trackInterval),this.failures=[],this.failureCounts={}}checkFailures(e){const t=[],s=[];for(;this.failures.length>0;){const n=this.failures.shift();e>n.ts+b.GRACE_PERIOD_MS?t.push(n):s.push(n)}this.failures=s;const n=t.reduce((e,t)=>this.trackedEventHashMap[t.failedEventId]?e:e.set(t.failedEventId,t),new Map),i=[...n.keys()];this.trackedEventHashMap=i.reduce((e,t)=>v(v({},e),{},{[t]:!0}),this.trackedEventHashMap);const a=n.values();this.aggregateFailures(a)}aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this.errorCodeMapFn?this.errorCodeMapFn(e):e;this.fn(this.failureCounts[e],t),this.failureCounts[e]=0}}}o()(b,"TRACK_INTERVAL_MS",6e4),o()(b,"CHECK_INTERVAL_MS",5e3),o()(b,"GRACE_PERIOD_MS",6e4);var y=s(86),E=s(121),S=s(93),_=s(87),w=s(254),C=s(90),O=s(159),k=s(180),R=s(450),I=s(294),x=s(367);const T={deferredAction:null};class j extends x.Store{constructor(){super(_.a),o()(this,"state",T)}setState(e){this.state=Object.assign(this.state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"do_after_sync_prepared":this.setState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.setState({deferredAction:null});break;case"sync_state":{if("PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.setState({deferredAction:null}),_.a.dispatch(t);break}case"on_client_not_viable":case"on_logged_out":this.reset()}}reset(){this.state=Object.assign({},T)}}let N=null;N||(N=new j);var P=s(821),D=s(141),M=s(84),A=s(89),U=s(491),L=s(822),F=s(307),B=s(5),V=s(112);class K extends B.EventEmitter{constructor(...e){super(...e),o()(this,"_isResizing",!1),o()(this,"throttledMiddlePanel",Object(V.throttle)(()=>this.emit("middlePanelResized"),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}var W=s(280),G=s(130),H=s(265),q=s(823),$=s(675),z=s(146),J=s(391),Y=s(92),Q=s(88),X=s(179);const Z=()=>{_.a.dispatch({action:"accept_cookies"})},ee=()=>{_.a.dispatch({action:"reject_cookies"})},te=()=>{m.a.showDetailsModal()},se=()=>{z.a.sharedInstance().dismissToast("analytics")};var ne=s(100);const ie=()=>{const e=S.a.get().sc_update_announcement_room,t={action:"view_room",auto_join:!0};"!"===e.room_id_or_alias[0]?t.room_id=e.room_id_or_alias:"#"===e.room_id_or_alias[0]&&(t.room_alias=e.room_id_or_alias),e.via_servers&&(t.opts={viaServers:e.via_servers},t.via_servers=e.via_servers),_.a.dispatch(t),A.b.setValue("scShowUpdateAnnouncementRoomToast",null,ne.a.DEVICE,!1),oe()},ae=()=>{A.b.setValue("scShowUpdateAnnouncementRoomToast",null,ne.a.DEVICE,!1),oe()},oe=()=>{z.a.sharedInstance().dismissToast("scupdateannouncementroom")};var re=s(542),ce=s(104),le=s(173),de=s(191),he=s(824),ue=s(825),me=s(115),pe=s(193),ge=s(826);const ve=()=>{window.location.href="mobile_guide/"},fe=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",be()},be=()=>{z.a.sharedInstance().dismissToast("mobileguide")};var ye=s(548),Ee=s(106),Se=s(85),_e=s(165),we=s(147),Ce=s(230),Oe=s(96),ke=s(113),Re=s(158),Ie=s(827),xe=s(389),Te=s(549),je=s(831),Ne=s(832),Pe=s(835),De=s(1029),Me=s(960),Ae=s(1042),Ue=s(965),Le=s(967),Fe=s(968),Be=s(277),Ve=s(970);let Ke;!function(e){e.APP_STARTUP="mx_AppStartup",e.PAGE_CHANGE="mx_PageChange",e.RESEND_EVENT="mx_ResendEvent",e.SEND_E2EE_EVENT="mx_SendE2EEEvent",e.SEND_ATTACHMENT="mx_SendAttachment",e.SWITCH_ROOM="mx_SwithRoom",e.JUMP_TO_ROOM="mx_JumpToRoom",e.JOIN_ROOM="mx_JoinRoom",e.CREATE_DM="mx_CreateDM",e.PEEK_ROOM="mx_PeekRoom",e.VERIFY_E2EE_USER="mx_VerifyE2EEUser",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e.SETUP_VOIP_CALL="mx_SetupVoIPCall"}(Ke||(Ke={}));var We=s(1);class Ge{constructor(){o()(this,"START_PREFIX","start:"),o()(this,"STOP_PREFIX","stop:"),o()(this,"listeners",[]),o()(this,"entries",[])}static get instance(){return Ge._instance||(Ge._instance=new Ge),Ge._instance}start(e,t){if(!this.supportsPerformanceApi())return;const s=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+s).length>0?We.a.warn("Recording already started for: "+e):performance.mark(this.START_PREFIX+s)}stop(e,t){if(!this.supportsPerformanceApi())return;const s=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+s).length)return void We.a.warn("No recording started for: "+e);performance.mark(this.STOP_PREFIX+s),performance.measure(s,this.START_PREFIX+s,this.STOP_PREFIX+s),this.clear(e,t);const n=performance.getEntriesByName(s).pop();return this.entries.push(n),this.listeners.forEach(e=>{this.shouldEmit(e,n)&&e.callback([n])}),n}clear(e,t){if(!this.supportsPerformanceApi())return;const s=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+s),performance.clearMarks(this.STOP_PREFIX+s)}getEntries({name:e,type:t}={}){return this.entries.filter(s=>{const n=!e||s.name===e,i=!t||s.entryType===t;return n&&i})}addPerformanceDataCallback(e,t=!1){if(this.listeners.push(e),t){const t=this.entries.filter(t=>this.shouldEmit(e,t));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex(t=>t.callback===e),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?":"+t:""}`}}o()(Ge,"_instance",void 0),window.mxPerformanceMonitor=Ge.instance,window.mxPerformanceEntryNames=Ke;var He,qe,$e,ze=s(139),Je=s(971),Ye=s(120),Qe=s(143),Xe=s(380),Ze=s(525),et=s(186);function tt(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let st;!function(e){e[e.LOADING=0]="LOADING",e[e.WELCOME=1]="WELCOME",e[e.LOGIN=2]="LOGIN",e[e.REGISTER=3]="REGISTER",e[e.FORGOT_PASSWORD=4]="FORGOT_PASSWORD",e[e.COMPLETE_SECURITY=5]="COMPLETE_SECURITY",e[e.E2E_SETUP=6]="E2E_SETUP",e[e.LOGGED_IN=7]="LOGGED_IN",e[e.SOFT_LOGOUT=8]="SOFT_LOGOUT"}(st||(st={}));const nt=["register","login","forgot_password","start_sso","start_cas","welcome"],it=[Y.a.ViewUserSettings,"view_create_chat","view_create_room","view_create_group"];let at=Object(Se.a)("structures.MatrixChat")(($e=qe=class extends c.a.PureComponent{constructor(e,t){if(super(e,t),o()(this,"firstSyncComplete",void 0),o()(this,"firstSyncPromise",void 0),o()(this,"screenAfterLogin",void 0),o()(this,"pageChanging",void 0),o()(this,"tokenLogin",void 0),o()(this,"accountPassword",void 0),o()(this,"accountPasswordTimer",void 0),o()(this,"focusComposer",void 0),o()(this,"subTitleStatus",void 0),o()(this,"prevWindowWidth",void 0),o()(this,"loggedInView",void 0),o()(this,"dispatcherRef",void 0),o()(this,"themeWatcher",void 0),o()(this,"fontWatcher",void 0),o()(this,"onAction",e=>{if(y.a.get()&&y.a.get().isGuest()&&it.includes(e.action))return _.a.dispatch({action:"do_after_sync_prepared",deferred_action:e}),void _.a.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(y.a.get().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(y.a.get().setIdentityServerUrl(null),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),_.a.dispatch({action:"id_server_changed"})}break;case"logout":_.a.dispatch({action:"hangup_all"}),I.i();break;case"require_registration":Object(L.b)(e);break;case"start_registration":if(I.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(I.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:st.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":Object(D.b)({dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"reject_invite":C.a.createTrackedDialog("Reject invitation","",ke.a,{title:Object(M.a)("Reject invitation"),description:Object(M.a)("Are you sure you want to reject the invitation?"),onFinished:t=>{if(t){const t=C.a.createDialog(Oe.a,null,"mx_Dialog_spinner");y.a.get().leave(e.room_id).then(()=>{t.close(),this.state.currentRoomId===e.room_id&&_.a.dispatch({action:"view_home_page"})},e=>{t.close(),C.a.createTrackedDialog("Failed to reject invitation","",ce.a,{title:Object(M.a)("Failed to reject invitation"),description:e.toString()})})}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case Y.a.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then(()=>{_.a.dispatch(e.deferred_action)});break}case Y.a.ViewUserSettings:{const t=e;C.a.createTrackedDialog("User settings","",Re.b,{initialTabId:t.initialTabId},null,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName);break;case"view_create_group":{const e=A.b.getValue("feature_communities_v2_prototypes");C.a.createTrackedDialog("Create Community","",e?he.a:Ie.a);break}case Y.a.ViewRoomDirectory:"!"===Ee.a.instance.activeSpace[0]?_.a.dispatch({action:"view_room",room_id:Ee.a.instance.activeSpace}):C.a.createTrackedDialog("Room directory","",Te.a,{initialText:e.initialText},"mx_RoomDirectory_dialogWrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_my_groups":this.setPage(P.a.MyGroups),this.notifyNewScreen("groups");break;case"view_group":this.viewGroup(e);break;case"view_welcome_page":this.viewWelcome();break;case"view_home_page":this.viewHome(e.justRegistered);break;case"view_start_chat_or_reuse":this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":Object(O.h)(e.initialText||"");break;case"view_invite":{const t=y.a.get().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?Object(et.i)(t):Object(O.g)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"toggle_my_groups":localStorage.setItem("mx_seenSpacesBeta","1"),this.state.page_type===P.a.MyGroups?_.a.dispatch({action:"view_last_screen"}):_.a.dispatch({action:"view_my_groups"});break;case"hide_left_panel":this.setState({collapseLhs:!0},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"focus_room_filter":case"show_left_panel":this.setState({collapseLhs:!1},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case Y.a.OpenDialPad:C.a.createTrackedDialog("Dial pad","",ge.a,{},"mx_Dialog_dialPadWrapper");break;case"on_logged_in":this.tokenLogin||I.g()||this.state.view===st.LOGIN||this.state.view===st.REGISTER||this.state.view===st.COMPLETE_SECURITY||this.state.view===st.E2E_SETUP||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case"on_logged_out":this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},()=>{this.onWillStartClient()});break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case"accept_cookies":A.b.setValue("analyticsOptIn",null,ne.a.DEVICE,!0),A.b.setValue("showCookieBar",null,ne.a.DEVICE,!1),se(),m.a.canEnable()&&m.a.enable(),p.a.instance.canEnable()&&p.a.instance.enable(!1);break;case"reject_cookies":A.b.setValue("analyticsOptIn",null,ne.a.DEVICE,!1),A.b.setValue("showCookieBar",null,ne.a.DEVICE,!1),se()}}),o()(this,"handleResize",()=>{const e=ze.b.instance.windowWidth;this.prevWindowWidth<1e3&&e>=1e3&&_.a.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=1e3&&e<1e3&&_.a.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=e,this.state.resizeNotifier.notifyWindowResized()}),o()(this,"onRegisterClick",()=>{this.showScreen("register")}),o()(this,"onLoginClick",()=>{this.showScreen("login")}),o()(this,"onForgotPasswordClick",()=>{this.showScreen("forgot_password")}),o()(this,"onRegisterFlowComplete",(e,t)=>this.onUserCompletedLoginFlow(e,t)),o()(this,"onServerConfigChange",e=>{this.setState({serverConfig:e})}),o()(this,"makeRegistrationUrl",e=>(this.props.startingFragmentQueryParams.referrer&&(e.referrer=this.props.startingFragmentQueryParams.referrer),this.props.makeRegistrationUrl(e))),o()(this,"onUserCompletedLoginFlow",async(e,t)=>{this.accountPassword=t,null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer),this.accountPasswordTimer=setTimeout(()=>{this.accountPassword=null,this.accountPasswordTimer=null},3e5),await I.l(e),await this.postLoginSetup(),Ge.instance.stop(Ke.LOGIN),Ge.instance.stop(Ke.REGISTER)}),o()(this,"onCompleteSecurityE2eSetupFinished",()=>{this.onLoggedIn()}),this.state={view:st.LOADING,collapseLhs:!1,hideToSRUsers:!1,syncError:null,resizeNotifier:new K,ready:!1},this.loggedInView=Object(r.createRef)(),S.a.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Object(u.l)(),this.props.config.sync_timeline_limit&&(y.a.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring("room/".length);ue.a.instance.storeInvite(t,e)}}this.prevWindowWidth=ze.b.instance.windowWidth||1e3,ze.b.instance.on(ze.a.Resize,this.handleResize),this.pageChanging=!1,this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),I.g()&&I.h(),this.accountPassword=null,this.accountPasswordTimer=null,this.dispatcherRef=_.a.register(this.onAction),this.themeWatcher=new H.a,this.fontWatcher=new q.a,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",this.onAliasClick&&(R.a.onAliasClick=this.onAliasClick),this.onUserClick&&(R.a.onUserClick=this.onUserClick),this.onGroupClick&&(R.a.onGroupClick=this.onGroupClick),I.g()||I.a(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin()).then(async e=>{var t;if(null!==(t=this.props.realQueryParams)&&void 0!==t&&t.loginToken&&this.props.onTokenLoginCompleted(),e)return this.tokenLogin=!0,await I.k({ignoreGuest:!0}),this.postLoginSetup();const s=this.screenAfterLogin?this.screenAfterLogin.screen:null;if("login"!==s&&"register"!==s&&"forgot_password"!==s)return this.loadSession();this.showScreenAfterLogin()}),A.b.getValue("analyticsOptIn")&&m.a.enable(),Xe.a.instance.updateAnonymityFromSettings(),Xe.a.instance.updatePlatformSuperProperties(),p.a.instance.enable(!0),Object(Ze.a)(S.a.get().sentry)}async postLoginSetup(){const e=y.a.get(),t=e.isCryptoEnabled();t||this.onLoggedIn();const s=[this.firstSyncPromise.promise];if(t&&s.push(e.downloadKeys([e.getUserId()])),this.setState({pendingInitialSync:!0}),await Promise.all(s),!t)return void this.setState({pendingInitialSync:!1});e.getStoredCrossSigningForUser(e.getUserId())?!1===Ce.a.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:st.COMPLETE_SECURITY}):await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")?this.setStateForNewView({view:st.E2E_SETUP}):this.onLoggedIn(),this.setState({pendingInitialSync:!1})}UNSAFE_componentWillUpdate(e,t){this.shouldTrackPageChange(this.state,t)&&this.startPageChangeTimer()}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();m.a.trackPageChange(e),p.a.instance.trackPageChange(e),Xe.a.instance.trackPageView(e)}this.focusComposer&&(_.a.fire(Y.a.FocusSendMessageComposer),this.focusComposer=!1)}componentWillUnmount(){I.n(),_.a.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),ze.b.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer)}getFallbackHsUrl(){return this.props.serverConfig&&this.props.serverConfig.isDefault?this.props.config.fallback_hs_url:null}getServerProperties(){let e=this.state.serverConfig;return e||(e=this.props.serverConfig),e||(e=S.a.get().validated_server_config),{serverConfig:e}}loadSession(){return Promise.resolve().then(()=>I.h({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName})).then(e=>{e?A.b.getValue("analyticsOptIn")&&p.a.instance.enable(!1):ue.a.instance.pickBestInvite()?_.a.dispatch({action:"start_registration"}):_.a.dispatch({action:"view_welcome_page"})})}startPageChangeTimer(){Ge.instance.start(Ke.PAGE_CHANGE)}stopPageChangeTimer(){const e=Ge.instance;e.stop(Ke.PAGE_CHANGE);const t=e.getEntries({name:Ke.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");const t={currentUserId:null,justRegistered:!1};Object.assign(t,e),this.setState(t)}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:st.REGISTER};if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){t.serverConfig=await W.a.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const s=S.a.get().validated_server_config;s&&s.hsUrl===t.serverConfig.hsUrl&&(t.serverConfig.hsName=s.hsName,t.serverConfig.hsNameIsDifferent=s.hsNameIsDifferent,t.serverConfig.isDefault=s.isDefault,t.serverConfig.isNameResolvable=s.isNameResolvable),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid}this.setStateForNewView(t),U.a.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}viewRoom(e){this.focusComposer=!0,e.room_alias?We.a.log(`Switching to room alias ${e.room_alias} at event `+e.event_id):We.a.log(`Switching to room id ${e.room_id} at event `+e.event_id);let t=Promise.resolve(null);if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void We.a.warn("Cannot view a room before first sync. room_id:",e.room_id);t=this.firstSyncPromise.promise}return t.then(()=>{let t=e.room_alias||e.room_id;const s=y.a.get().getRoom(e.room_id);if(s){s.decryptAllEvents();const e=k.c(s);e&&(t=e,Object($.b)(e,s.roomId)),localStorage&&localStorage.setItem("mx_last_room_id",s.roomId)}const n="#"===t[0]&&e.room_id===this.state.currentRoomId;e.event_id&&e.highlighted&&(t+="/"+e.event_id),this.setState({view:st.LOGGED_IN,currentRoomId:e.room_id||null,page_type:P.a.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},()=>{this.notifyNewScreen("room/"+t,n)})})}async viewGroup(e){const t=e.group_id;if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void We.a.warn("Cannot view a group before first sync. group_id:",t);await this.firstSyncPromise.promise}this.setState({view:st.LOGGED_IN,currentGroupId:t,currentGroupIsNew:e.group_is_new}),this.setPage(P.a.GroupView),this.notifyNewScreen("group/"+t)}viewSomethingBehindModal(){this.state.view===st.LOGGED_IN?this.state.currentGroupId||this.state.currentRoomId||this.viewHome():this.viewWelcome()}viewWelcome(){if(Object(ye.b)(S.a.get()))return this.viewLogin();this.setStateForNewView({view:st.WELCOME}),this.notifyNewScreen("welcome"),U.a.isLogin=!0,this.themeWatcher.recheck()}viewLogin(e){this.setStateForNewView(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?tt(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):tt(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({view:st.LOGIN},e)),this.notifyNewScreen("login"),U.a.isLogin=!0,this.themeWatcher.recheck()}viewHome(e=!1){this.setStateForNewView({view:st.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(P.a.HomePage),this.notifyNewScreen("home"),U.a.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then(()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(P.a.UserView)):this.chatCreateOrReuse(e)})}async createRoom(e=!1,t){const s=pe.a.instance.getSelectedCommunityId();if(s&&!pe.a.instance.isAdminOf(s))return void C.a.createTrackedDialog("Pre-failure to create room","",ce.a,{title:Object(M.a)("Cannot create rooms in this community"),description:Object(M.a)("You do not have permission to create rooms in this community.")});const n=C.a.createTrackedDialog("Create Room","",xe.a,{defaultPublic:e,defaultName:t}),[i,a]=await n.finished;i&&Object(D.b)(a)}chatCreateOrReuse(e){if(y.a.get().isGuest())return e!==this.props.config.welcomeUserId&&_.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_start_chat_or_reuse",user_id:e}}),void _.a.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:"user/"+this.props.config.welcomeUserId,params:{action:"chat"}}});const t=y.a.get(),s=new G.a(t).getDMRoomsForUserId(e);s.length>0?_.a.dispatch({action:Y.a.ViewRoom,room_id:s[0]}):_.a.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=y.a.get().getRoom(e),s=Ee.a.spacesEnabled&&(null==t?void 0:t.isSpaceRoom()),n=[];if(1===t.currentState.getJoinedMemberCount())return n.push(c.a.createElement("span",{className:"warning",key:"only_member_warning"}," ",Object(M.a)("You are the only person here. If you leave, no one will be able to join in the future, including you."))),n;const i=t.currentState.getStateEvents("m.room.join_rules","");if(i){"public"!==i.getContent().join_rule&&n.push(c.a.createElement("span",{className:"warning",key:"non_public_warning"}," ",s?Object(M.a)("This space is not public. You will not be able to rejoin without an invite."):Object(M.a)("This room is not public. You will not be able to rejoin without an invite.")))}return n}leaveRoom(e){const t=y.a.get().getRoom(e),s=this.leaveRoomWarnings(e),n=Ee.a.spacesEnabled&&(null==t?void 0:t.isSpaceRoom());C.a.createTrackedDialog(n?"Leave space":"Leave room","",ke.a,{title:n?Object(M.a)("Leave space"):Object(M.a)("Leave room"),description:c.a.createElement("span",null,n?Object(M.a)("Are you sure you want to leave the space '%(spaceName)s'?",{spaceName:t.name}):Object(M.a)("Are you sure you want to leave the room '%(roomName)s'?",{roomName:t.name}),s),button:Object(M.a)("Leave"),onFinished:t=>{if(t){const t=Object(de.d)(e),s=C.a.createDialog(Oe.a,null,"mx_Dialog_spinner");t.finally(()=>s.close()),_.a.dispatch({action:"after_leave_room",room_id:e})}}})}forgetRoom(e){const t=y.a.get().getRoom(e);y.a.get().forget(e).then(()=>{this.state.currentRoomId===e&&_.a.dispatch({action:"view_home_page"}),_e.b.instance.manualRoomUpdate(t,we.c.RoomRemoved)}).catch(e=>{const t=e.errcode||Object(M.b)("unknown error code");C.a.createTrackedDialog("Failed to forget room","",ce.a,{title:Object(M.a)("Failed to forget room %(errCode)s",{errCode:t}),description:e&&e.message?e.message:Object(M.a)("Operation failed")})})}async copyRoom(e){const t=Object(Ye.g)(e);await Object(Qe.c)(t)||C.a.createTrackedDialog("Unable to copy room link","",ce.a,{title:Object(M.a)("Unable to copy room link"),description:Object(M.a)("Unable to copy a link to the room to the clipboard.")})}async startWelcomeUserChat(){let e;e=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await e;if(0===G.a.shared().getDMRoomsForUserId(this.props.config.welcomeUserId).length){const e=await Object(D.b)({dmUserId:this.props.config.welcomeUserId,andView:!this.state.currentRoomId,spinner:!1}),t=e=>{"m.direct"===e.getType()&&e.getContent()&&e.getContent()[this.props.config.welcomeUserId]&&(y.a.get().store.save(!0),y.a.get().removeListener("accountData",t))};return y.a.get().on("accountData",t),e}return null}async onLoggedIn(){if(U.a.isLogin=!1,this.themeWatcher.recheck(),this.setStateForNewView({view:st.LOGGED_IN}),this.screenAfterLogin&&this.screenAfterLogin.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null;else if(y.a.currentUserIsJustRegistered())if(y.a.setJustRegisteredUserId(null),this.props.config.welcomeUserId&&Object(M.d)().startsWith("en")){null===await this.startWelcomeUserChat()&&_.a.dispatch({action:"view_home_page",justRegistered:!0})}else if(ue.a.instance.pickBestInvite()){const e=ue.a.instance.pickBestInvite(),t=ue.a.instance.translateToWireFormat(e);this.showScreen("room/"+e.roomId,t)}else _.a.dispatch({action:"view_home_page",justRegistered:!0});else this.showScreenAfterLogin();var e;(J.g(),await Object(u.I)(30),A.b.getValue("showCookieBar")&&(m.a.canEnable()||p.a.instance.canEnable()))&&(e=>{const t=S.a.get().brand;z.a.sharedInstance().addOrReplaceToast({key:"analytics",title:Object(M.a)("Help us improve %(brand)s",{brand:t}),props:{description:Object(M.a)("Send <UsageDataLink>anonymous usage data</UsageDataLink> which helps us improve %(brand)s. This will use a <PolicyLink>cookie</PolicyLink>.",{brand:t},{UsageDataLink:e=>c.a.createElement(Q.a,{kind:"link",onClick:te},e),PolicyLink:t=>e?c.a.createElement("a",{target:"_blank",href:e},t):t}),acceptLabel:Object(M.a)("Yes"),onAccept:Z,rejectLabel:Object(M.a)("No"),onReject:ee},component:X.a,className:"mx_AnalyticsToast",priority:10})})(null===(e=this.props.config.piwik)||void 0===e?void 0:e.policyUrl);S.a.get().mobileGuideToast&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent);(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||z.a.sharedInstance().addOrReplaceToast({key:"mobileguide",title:Object(M.a)("Use app for a better experience"),props:{description:Object(M.a)("Element Web is experimental on mobile. For a better experience and the latest features, use our free native app."),acceptLabel:Object(M.a)("Use app"),onAccept:ve,rejectLabel:Object(M.a)("Dismiss"),onReject:fe},component:X.a,priority:99}))})(),A.b.getValue("scShowUpdateAnnouncementRoomToast")&&E.a.get().canSelfUpdate().then(e=>{e||S.a.get().sc_update_announcement_room&&z.a.sharedInstance().addOrReplaceToast({key:"scupdateannouncementroom",title:Object(M.a)("Update notifications"),props:{description:Object(M.a)("Do you want to join a room notifying you about new releases? This is especially useful if your platform doesn't support automatic updates for SchildiChat (e.g. Windows and macOS)."),acceptLabel:Object(M.a)("Join"),onAccept:ie,rejectLabel:Object(M.a)("Don't ask again"),onReject:ae},component:X.a,priority:20})}).catch(e=>{console.error("Error getting vector version: ",e)})}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null):y.a.get().isGuest()?_.a.dispatch({action:"view_welcome_page"}):_.a.dispatch({action:"view_home_page"})}viewLastRoom(){_.a.dispatch({action:Y.a.ViewRoom,room_id:localStorage.getItem("mx_last_room_id")})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:st.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=Object(u.l)();const e=y.a.get();e.setCanResetTimelineCallback(e=>(We.a.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e)))),e.on("sync",(e,t,s)=>{_.a.dispatch({action:"sync_state",prevState:t,state:e}),"ERROR"===e||"RECONNECTING"===e?(s.error instanceof d.b&&I.d(s.error),this.setState({syncError:s.error||!0})):this.state.syncError&&this.setState({syncError:null}),this.updateStatusIndicator(e,t),"SYNCING"===e&&"SYNCING"===t||(We.a.info("MatrixClient sync state => %s",e),"PREPARED"===e&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),w.default.shouldShowPrompt()&&!y.a.userRegisteredWithinLastHours(24)&&Object(re.b)(!1),_.a.fire(Y.a.FocusSendMessageComposer),this.setState({ready:!0})))}),e.on("Session.logged_out",(function(e){if(!I.f()){if(C.a.closeCurrentModal("Session.logged_out"),401===e.httpStatus&&e.data&&e.data.soft_logout)return We.a.warn("Soft logout issued by server - avoiding data deletion"),void I.m();C.a.createTrackedDialog("Signed out","",ce.a,{title:Object(M.a)("Signed Out"),description:Object(M.a)("For security, this session has been signed out. Please sign in again.")}),_.a.dispatch({action:"logout"})}})),e.on("no_consent",(function(t,s){C.a.createTrackedDialog("No Consent Dialog","",ke.a,{title:Object(M.a)("Terms and Conditions"),description:c.a.createElement("div",null,c.a.createElement("p",null," ",Object(M.a)("To continue using the %(homeserverDomain)s homeserver you must review and agree to our terms and conditions.",{homeserverDomain:e.getDomain()}))),button:Object(M.a)("Review terms and conditions"),cancelButton:Object(M.a)("Dismiss"),onFinished:e=>{if(e){window.open(s,"_blank").opener=null}}},null,!0)}));const t=new b((e,t)=>{m.a.trackEvent("E2E","Decryption failure",t,String(e)),p.a.instance.track("decryption_failure",{errorCode:t},null,{sum:e})},e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"olm_keys_not_sent_error";case"OLM_UNKNOWN_MESSAGE_INDEX":return"olm_index_error";case void 0:return"unexpected_error";default:return"unspecified_error"}});t.start(),e.on("Session.logged_out",()=>t.stop()),e.on("Event.decrypted",(e,s)=>t.eventDecrypted(e,s)),e.on("Room",e=>{if(y.a.get().isCryptoEnabled()){const t=A.b.getValueAt(ne.a.ROOM_DEVICE,"blacklistUnverifiedDevices",e.roomId,!0);e.setBlacklistUnverifiedDevices(t)}}),e.on("crypto.warning",e=>{switch(e){case"CRYPTO_WARNING_OLD_VERSION_DETECTED":C.a.createTrackedDialog("Crypto migrated","",ce.a,{title:Object(M.a)("Old cryptography data detected"),description:Object(M.a)("Data from an older version of %(brand)s has been detected. This will have caused end-to-end cryptography to malfunction in the older version. End-to-end encrypted messages exchanged recently whilst using the older version may not be decryptable in this version. This may also cause messages exchanged with this version to fail. If you experience problems, log out and back in again. To retain message history, export and re-import your keys.",{brand:S.a.get().brand})})}}),e.on("crypto.keyBackupFailed",async e=>{let t,n;if(y.a.get().getKeyBackupEnabled())t=!0;else try{n=await y.a.get().getKeyBackupVersion(),null!==n&&(t=!0)}catch(e){return void We.a.error("Saw key backup error but failed to check backup version!",e)}t?C.a.createTrackedDialogAsync("New Recovery Method","New Recovery Method",s.e(32).then(s.bind(null,1665)),{newVersionInfo:n}):C.a.createTrackedDialogAsync("Recovery Method Removed","Recovery Method Removed",s.e(33).then(s.bind(null,1666)))}),e.on("crypto.keySignatureUploadFailure",(e,t,s)=>{C.a.createTrackedDialog("Failed to upload key signatures","Failed to upload key signatures",je.a,{failures:e,source:t,continuation:s})}),e.on("crypto.verification.request",e=>{e.verifier?C.a.createTrackedDialog("Incoming Verification","",Ne.a,{verifier:e.verifier},null,!1,!0):e.pending&&z.a.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.channel.transactionId,title:Object(M.a)("Verification requested"),icon:"verification",props:{request:e},component:Ve.a,priority:90})})}onClientStarted(){const e=y.a.get();if(e.isCryptoEnabled()){const t=A.b.getValueAt(ne.a.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}}showScreen(e,t){const s=y.a.get();if(!s||s.isGuest()||!nt.includes(e))if("register"===e)_.a.dispatch({action:"start_registration",params:t}),Ge.instance.start(Ke.REGISTER);else if("login"===e)_.a.dispatch({action:"start_login",params:t}),Ge.instance.start(Ke.LOGIN);else if("forgot_password"===e)_.a.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)s.getUserId()&&!I.g()?this.viewLastRoom():_.a.dispatch({action:"start_login",params:t});else if("new"===e)_.a.dispatch({action:"view_create_room"});else if("settings"===e)_.a.fire(Y.a.ViewUserSettings);else if("welcome"===e)_.a.dispatch({action:"view_welcome_page"});else if("home"===e)_.a.dispatch({action:"view_home_page"});else if("start"===e)this.showScreen("home"),_.a.dispatch({action:"require_registration"});else if("directory"===e)this.state.view===st.WELCOME&&p.a.instance.track("onboarding_room_directory"),_.a.fire(Y.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){let t=y.a.get();if(!t){const{hsUrl:e,isUrl:s}=this.props.serverConfig;t=Object(l.createClient)({baseUrl:e,idBaseUrl:s})}const s="start_sso"===e?"sso":"cas";E.a.get().startSingleSignOn(t,s,this.getFragmentAfterLogin())}else if("groups"===e){if(Ee.a.spacesEnabled)return void _.a.dispatch({action:"view_home_page"});_.a.dispatch({action:"view_my_groups"})}else if(0===e.indexOf("room/")){var n,i,a;const s=e.substring(5),o=s.indexOf(":")+1;let r=s.length;s.substring(o).indexOf("/")>-1&&(r=o+s.substring(o).indexOf("/"));const c=s.substring(0,r);let l,d=s.substring(r+1);if(d||(d=void 0),t.signurl&&t.email&&(l=ue.a.instance.storeInvite(c,t)),!l){l=ue.a.instance.getInvites().find(e=>e.roomId===c)}let h=[];t.via&&(h="string"==typeof t.via?[t.via]:t.via);const u={action:Y.a.ViewRoom,event_id:d,via_servers:h,highlighted:Boolean(d),threepid_invite:l,oob_data:{name:null===(n=l)||void 0===n?void 0:n.roomName,avatarUrl:null===(i=l)||void 0===i?void 0:i.roomAvatarUrl,inviterName:null===(a=l)||void 0===a?void 0:a.inviterName},room_alias:void 0,room_id:void 0};"#"===c[0]?u.room_alias=c:u.room_id=c,_.a.dispatch(u)}else if(0===e.indexOf("user/")){const s=e.substring(5);_.a.dispatch({action:"view_user_info",userId:s,subAction:t.action})}else if(0===e.indexOf("group/")){const t=e.substring(6);_.a.dispatch({action:"view_group",group_id:t})}else We.a.info("Ignoring showScreen for '%s'",e);else _.a.dispatch({action:"view_home_page"})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onAliasClick(e,t){e.preventDefault(),_.a.dispatch({action:Y.a.ViewRoom,room_alias:t})}onUserClick(e,t){e.preventDefault();const s=new h.a(null,t);s&&_.a.dispatch({action:Y.a.ViewUser,member:s})}onGroupClick(e,t){e.preventDefault(),_.a.dispatch({action:"view_group",group_id:t})}onLogoutClick(e){_.a.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){_.a.dispatch({action:"timeline_resize"})}onRegistered(e){return I.l(e)}onSendEvent(e,t){const s=y.a.get();s&&s.sendEvent(e,t.getType(),t.getContent()).then(()=>{_.a.dispatch({action:"message_sent"})})}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=y.a.get(),s=t&&t.getRoom(this.state.currentRoomId);s&&(e=`${this.subTitleStatus} | ${s.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${S.a.get().brand} ${e}`;document.title!==t&&(document.title=t)}updateStatusIndicator(e,t){const s=le.a.instance.globalState.numUnreadStates;E.a.get()&&(E.a.get().setErrorStatus("ERROR"===e),E.a.get().setNotificationCount(s)),this.subTitleStatus="","ERROR"===e&&(this.subTitleStatus+=`[${Object(M.a)("Offline")}] `),s>0&&(this.subTitleStatus+=`[${s}]`),this.setPageSubtitle()}onCloseAllSettings(){_.a.dispatch({action:"close_settings"})}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e="/"+t.screen),e}render(){const e=this.getFragmentAfterLogin();let t=null;if(this.state.view===st.LOADING)t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},c.a.createElement(Oe.a,null));else if(this.state.view===st.COMPLETE_SECURITY)t=c.a.createElement(Pe.a,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===st.E2E_SETUP)t=c.a.createElement(Ue.a,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.accountPassword,tokenLogin:!!this.tokenLogin});else if(this.state.view===st.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof d.b;if(this.state.ready&&this.state.page_type&&!e)t=c.a.createElement(De.a,i()({},this.props,this.state,{ref:this.loggedInView,matrixClient:y.a.get(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}));else{let s;this.state.syncError&&!e&&(s=c.a.createElement("div",{className:"mx_MatrixChat_syncError"},Object(F.b)(this.state.syncError))),t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},s,c.a.createElement(Oe.a,null),c.a.createElement("a",{href:"#",className:"mx_MatrixChat_splashButtons",onClick:this.onLogoutClick},Object(M.a)("Logout")))}}else if(this.state.view===st.WELCOME)t=c.a.createElement(Me.a,null);else if(this.state.view===st.REGISTER&&A.b.getValue(me.b.Registration)){var s;const n=null===(s=ue.a.instance.pickBestInvite())||void 0===s?void 0:s.toEmail;t=c.a.createElement(Le.a,i()({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:n,brand:this.props.config.brand,makeRegistrationUrl:this.makeRegistrationUrl,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===st.FORGOT_PASSWORD&&A.b.getValue(me.b.PasswordReset))t=c.a.createElement(Ae.a,i()({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange},this.getServerProperties()));else if(this.state.view===st.LOGIN){const s=A.b.getValue(me.b.PasswordReset);t=c.a.createElement(Fe.a,i()({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:s?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:this.props.startingFragmentQueryParams.defaultUsername},this.getServerProperties()))}else this.state.view===st.SOFT_LOGOUT?t=c.a.createElement(Je.a,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e}):We.a.error("Unknown view "+this.state.view);return c.a.createElement(Be.a,null,t)}},o()(qe,"displayName","MatrixChat"),o()(qe,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}}),He=$e))||He;function ot(){const e=window.matrixChat;return e&&e.state.view===st.LOGGED_IN}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(83),i=s.n(n),a=s(164),o=s(87),r=s(84),c=s(86),l=s(147);function d(e){const t=c.a.get().getUserId();return"m.room.member"===e.getType()?e.getStateKey()===t:e.getSender()===t}function h(e,t){if(t!==l.a.DM)return!0;const s=c.a.get().getRoom(e);return!s||2!==s.currentState.getJoinedMemberCount()}function u(e){return e.sender?e.sender.name:e.getSender()}var m=s(234),p=s(138);var g=s(4);var v=s(89),f=s(130);var b=s(123);const y={"m.room.message":{isState:!1,previewer:new class{getTextFor(e,t,s){let n=e.getContent();if(e.isRelation("m.replace")&&(n=e.getContent()["m.new_content"]),!n||!n.body)return null;let i=(n.body||"").trim();const a=n.msgtype;if(!i||!a)return null;const o="org.matrix.custom.html"===n.format&&n.formatted_body;o&&(i=n.formatted_body);const c=e.getWireContent()["m.relates_to"];if(c&&c["m.in_reply_to"]&&(i=o?(m.a.stripHTMLReply(i)||"").trim():(m.a.stripPlainReply(i)||"").trim(),!i))return null;if(o){const e=Object(p.d)(i.replace(/<br\/?>/gi,"\n"));i=(new DOMParser).parseFromString(e,"text/html").documentElement.textContent}return i=Object(r.j)(i),"m.emote"===a?Object(r.a)("* %(senderName)s %(emote)s",{senderName:u(e),emote:i}):s||d(e)||!h(e.getRoomId(),t)?i:Object(r.a)("%(senderName)s: %(message)s",{senderName:u(e),message:"⁨"+i})}}},"m.call.invite":{isState:!1,previewer:new class{getTextFor(e,t){return h(e.getRoomId(),t)?d(e)?Object(r.a)("You started a call"):Object(r.a)("%(senderName)s started a call",{senderName:u(e)}):d(e)?Object(r.a)("Waiting for answer"):Object(r.a)("%(senderName)s is calling",{senderName:u(e)})}}},"m.call.answer":{isState:!1,previewer:new class{getTextFor(e,t){return h(e.getRoomId(),t)?d(e)?Object(r.a)("You joined the call"):Object(r.a)("%(senderName)s joined the call",{senderName:u(e)}):Object(r.a)("Call in progress")}}},"m.call.hangup":{isState:!1,previewer:new class{getTextFor(e,t){return h(e.getRoomId(),t)?d(e)?Object(r.a)("You ended the call"):Object(r.a)("%(senderName)s ended the call",{senderName:u(e)}):Object(r.a)("Call ended")}}},"m.sticker":{isState:!1,previewer:new class{getTextFor(e,t,s){const n=e.getContent().body;return n?s||d(e)||!h(e.getRoomId(),t)?n:Object(r.a)("%(senderName)s: %(stickerName)s",{senderName:u(e),stickerName:n}):null}}},"m.reaction":{isState:!1,previewer:new class{getTextFor(e,t,s){const n=v.b.getValue("feature_roomlist_preview_reactions_dms");if(!(v.b.getValue("feature_roomlist_preview_reactions_all")||n&&f.a.shared().getUserIdForRoomId(e.getRoomId())))return null;const i=e.getRelation();if(!i)return null;const a=i.key;return a?s||d(e)||!h(e.getRoomId(),t)?a:Object(r.a)("%(senderName)s: %(reaction)s",{senderName:u(e),reaction:a}):null}}}},E="im.vector.any";class S extends a.a{constructor(){super(o.a,{}),i()(this,"previews",new Map)}static get instance(){return S.internalInstance}static getPreviewChangedEventName(e){return"room_preview_changed:"+(null==e?void 0:e.roomId)}async getPreviewForRoom(e,t){if(!e)return null;this.previews.has(e.roomId)||await this.generatePreview(e,t);const s=this.previews.get(e.roomId);return s?s.has(t)?s.get(t):s.get(E):null}generatePreviewForEvent(e){const t=y[e.getType()];if(!t)return"";const s=t.previewer.getTextFor(e,null,!0);return null!=s?s:""}async generatePreview(e,t){const s=e.timeline;if(!s)return;let n=this.previews.get(e.roomId);n||(n=new Map,this.previews.set(e.roomId,n)),n.has(E)||n.set(E,null),t&&!n.has(t)&&n.set(t,null);let i=!1;for(let t=s.length-1;t>=0&&t!==s.length-50;t--){const a=s[t];await this.matrixClient.decryptEventIfNeeded(a);const o=y[a.getType()];if(!o)continue;if(o.isState&&Object(g.v)(a.getStateKey()))continue;const r=o.previewer.getTextFor(a,null);if(!r)continue;i=i||r!==n.get(E),n.set(E,r);const c=Array.from(n.keys()).filter(e=>e!==E);for(const e of c){const t=e===E?null:e,s=o.previewer.getTextFor(a,t);s===r?(i=i||r!==n.get(e),n.delete(e)):(i=i||s!==n.get(e),n.set(e,s))}return void(i&&(this.previews.set(e.roomId,n),this.emit(b.b,this),this.emit(S.getPreviewChangedEventName(e),e)))}this.previews.set(e.roomId,new Map),this.emit(b.b,this),this.emit(S.getPreviewChangedEventName(e),e)}async onAction(e){if(this.matrixClient&&("MatrixActions.Room.timeline"===e.action||"MatrixActions.Event.decrypted"===e.action)){const t=e.event,s=e.hasOwnProperty("isLiveEvent")&&!e.isLiveEvent;if(!this.previews.has(t.getRoomId())||s)return;await this.generatePreview(this.matrixClient.getRoom(t.getRoomId()),E)}}}i()(S,"internalInstance",new S)},function(e,t,s){"use strict";s.d(t,"a",(function(){return L}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(96),c=s(86),l=s(196);class d{static encodeActions(e){const t=e.notify,s=e.sound,n=e.highlight;if(t){const e=[l.b.Notify];return s&&e.push({set_tweak:"sound",value:s}),n?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[l.b.DontNotify]}static decodeActions(e){let t=!1,s=null,n=!1;for(let i=0;i<e.length;++i){const a=e[i];if(a===l.b.Notify)t=!0;else if(a===l.b.DontNotify)t=!1;else{if("object"!=typeof a)return null;if("sound"===a.set_tweak)s=a.value;else{if("highlight"!==a.set_tweak)return null;n=a.value}}}void 0===n&&(n=!0);const i={notify:t,highlight:n};return null!==s&&(i.sound=s),i}}const h=d.encodeActions;class u{}let m;i()(u,"ACTION_NOTIFY",h({notify:!0})),i()(u,"ACTION_NOTIFY_DEFAULT_SOUND",h({notify:!0,sound:"default"})),i()(u,"ACTION_NOTIFY_RING_SOUND",h({notify:!0,sound:"ring"})),i()(u,"ACTION_HIGHLIGHT",h({notify:!0,highlight:!0})),i()(u,"ACTION_HIGHLIGHT_DEFAULT_SOUND",h({notify:!0,sound:"default",highlight:!0})),i()(u,"ACTION_DONT_NOTIFY",h({notify:!1})),i()(u,"ACTION_DISABLED",null),function(e){e.Off="off",e.On="on",e.Loud="loud"}(m||(m={}));class p{static actionsFor(e){return e===m.On?u.ACTION_NOTIFY:e===m.Loud?u.ACTION_HIGHLIGHT_DEFAULT_SOUND:void 0}static contentRuleVectorStateKind(e){const t=d.decodeActions(e.actions);if(!t)return null;let s=0;t.sound&&s++,t.highlight&&s++;let n=null;switch(s){case 0:n=m.On;break;case 2:n=m.Loud}return n}}i()(p,"OFF",m.Off),i()(p,"ON",m.On),i()(p,"LOUD",m.Loud),i()(p,"states",m);var g=s(84),v=s(1);class f{constructor(e){i()(this,"kind",void 0),i()(this,"description",void 0),i()(this,"vectorStateToActions",void 0),this.kind=e.kind,this.description=e.description,this.vectorStateToActions=e.vectorStateToActions}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const s in p.states){const n=p.states[s],i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(d.decodeActions(e.actions))===JSON.stringify(d.decodeActions(i)))return n}else if(!t)return n}v.a.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: `+JSON.stringify(this.vectorStateToActions))}}const b={".m.rule.contains_display_name":new f({kind:l.c.Override,description:Object(g.b)("Messages containing my display name"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_HIGHLIGHT_DEFAULT_SOUND,[m.Off]:u.ACTION_DISABLED}}),".m.rule.contains_user_name":new f({kind:l.c.Override,description:Object(g.b)("Messages containing my username"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_HIGHLIGHT_DEFAULT_SOUND,[m.Off]:u.ACTION_DISABLED}}),".m.rule.roomnotif":new f({kind:l.c.Override,description:Object(g.b)("Messages containing @room"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_HIGHLIGHT,[m.Off]:u.ACTION_DISABLED}}),".m.rule.room_one_to_one":new f({kind:l.c.Underride,description:Object(g.b)("Messages in one-to-one chats"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_NOTIFY_DEFAULT_SOUND,[m.Off]:u.ACTION_DONT_NOTIFY}}),".m.rule.encrypted_room_one_to_one":new f({kind:l.c.Underride,description:Object(g.b)("Encrypted messages in one-to-one chats"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_NOTIFY_DEFAULT_SOUND,[m.Off]:u.ACTION_DONT_NOTIFY}}),".m.rule.message":new f({kind:l.c.Underride,description:Object(g.b)("Messages in group chats"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_NOTIFY_DEFAULT_SOUND,[m.Off]:u.ACTION_DONT_NOTIFY}}),".m.rule.encrypted":new f({kind:l.c.Underride,description:Object(g.b)("Encrypted messages in group chats"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_NOTIFY_DEFAULT_SOUND,[m.Off]:u.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new f({kind:l.c.Underride,description:Object(g.b)("When I'm invited to a room"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_NOTIFY_DEFAULT_SOUND,[m.Off]:u.ACTION_DISABLED}}),".m.rule.call":new f({kind:l.c.Underride,description:Object(g.b)("Call invitation"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_NOTIFY_RING_SOUND,[m.Off]:u.ACTION_DISABLED}}),".m.rule.suppress_notices":new f({kind:l.c.Override,description:Object(g.b)("Messages sent by bot"),vectorStateToActions:{[m.On]:u.ACTION_DISABLED,[m.Loud]:u.ACTION_NOTIFY_DEFAULT_SOUND,[m.Off]:u.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new f({kind:l.c.Override,description:Object(g.b)("When rooms are upgraded"),vectorStateToActions:{[m.On]:u.ACTION_NOTIFY,[m.Loud]:u.ACTION_HIGHLIGHT,[m.Off]:u.ACTION_DISABLED}})};class y{static parseContentRules(e){const t=y.categoriseContentRules(e);return t.loud.length?{vectorState:m.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:m.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:m.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:m.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:m.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const s in e.global)for(let n=0;n<Object.keys(e.global[s]).length;++n){const i=e.global[s][n];if("."!==i.rule_id[0]&&s===l.c.ContentSpecific)switch(i.kind=s,p.contentRuleVectorStateKind(i)){case m.On:i.enabled?t.on.push(i):t.on_but_disabled.push(i);break;case m.Loud:i.enabled?t.loud.push(i):t.loud_but_disabled.push(i);break;default:t.other.push(i)}}return t}}var E,S,_=s(583),w=s(187),C=s(89),O=s(176),k=s(100),R=s(90),I=s(104),x=s(93),T=s(88),j=s(1006),N=s(144),P=s(116);function D(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function M(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?D(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):D(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}!function(e){e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error"}(E||(E={})),function(e){e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other"}(S||(S={}));const A=S.VectorMentions,U=[l.d.DM,l.d.EncryptedDM,l.d.Message,l.d.EncryptedMessage,l.d.ContainsDisplayName,l.d.ContainsUserName,l.d.AtRoomNotification,l.d.InviteToSelf,l.d.IncomingCall,l.d.SuppressNotices,l.d.Tombstone];class L extends o.a.PureComponent{constructor(e){super(e),i()(this,"onMasterRuleChanged",async e=>{this.setState({phase:E.Persisting});try{const t=this.state.masterPushRule;await c.a.get().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:E.Error}),v.a.error("Error updating master push rule:",e),this.showSaveError()}}),i()(this,"onEmailNotificationsChanged",async(e,t)=>{this.setState({phase:E.Persisting});try{if(t)await c.a.get().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:x.a.get().brand},append:!0});else{const t=this.state.pushers.find(t=>"email"===t.kind&&t.pushkey===e);t.kind=null,await c.a.get().setPusher(t)}await this.refreshFromServer()}catch(e){this.setState({phase:E.Error}),v.a.error("Error updating email pusher:",e),this.showSaveError()}}),i()(this,"onDesktopNotificationsChanged",async e=>{await C.b.setValue("notificationsEnabled",null,k.a.DEVICE,e),this.forceUpdate()}),i()(this,"onDesktopShowBodyChanged",async e=>{await C.b.setValue("notificationBodyEnabled",null,k.a.DEVICE,e),this.forceUpdate()}),i()(this,"onAudioNotificationsChanged",async e=>{await C.b.setValue("audioNotificationsEnabled",null,k.a.DEVICE,e),this.forceUpdate()}),i()(this,"onRadioChecked",async(e,t)=>{this.setState({phase:E.Persisting});try{const s=c.a.get();if("_keywords"===e.ruleId)for(const e of this.state.vectorKeywordRuleInfo.rules){let n,i;t===m.On?(1!==e.actions.length&&(i=p.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===m.Off&&(n=!0)):t===m.Loud?(3!==e.actions.length&&(i=p.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===m.Off&&(n=!0)):n=!1,i&&await s.setPushRuleActions("global",e.kind,e.rule_id,i),void 0!==n&&await s.setPushRuleEnabled("global",e.kind,e.rule_id,n)}else{const n=b[e.ruleId].vectorStateToActions[t];n?(await s.setPushRuleActions("global",e.rule.kind,e.rule.rule_id,n),await s.setPushRuleEnabled("global",e.rule.kind,e.rule.rule_id,!0)):await s.setPushRuleEnabled("global",e.rule.kind,e.rule.rule_id,!1)}await this.refreshFromServer()}catch(e){this.setState({phase:E.Error}),v.a.error("Error updating push rule:",e),this.showSaveError()}}),i()(this,"onClearNotificationsClicked",()=>{c.a.get().getRooms().forEach(e=>{if(e.getUnreadNotificationCount()>0){const t=e.getLiveTimeline().getEvents();t.length&&c.a.get().sendReadReceipt(t[t.length-1])}})}),i()(this,"onKeywordAdd",e=>{const t=Object(N.a)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:E.Persisting,vectorKeywordRuleInfo:M(M({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map(e=>e.pattern),t)})}),i()(this,"onKeywordRemove",e=>{const t=Object(N.a)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:E.Persisting,vectorKeywordRuleInfo:M(M({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter(t=>t.pattern!==e)})},async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map(e=>e.pattern),t)})}),this.state={phase:E.Loading}}get isInhibited(){var e;return null===(e=this.state.masterPushRule)||void 0===e?void 0:e.enabled}componentDidMount(){this.refreshFromServer()}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce((e,t)=>Object.assign(t,e),{});this.setState(M(M({},e),{},{phase:E.Ready}))}catch(e){v.a.error("Error setting up notifications for settings: ",e),this.setState({phase:E.Error})}}async refreshRules(){const e=await c.a.get().getPushRules(),t={[l.d.Master]:S.Master,[l.d.DM]:S.VectorGlobal,[l.d.EncryptedDM]:S.VectorGlobal,[l.d.Message]:S.VectorGlobal,[l.d.EncryptedMessage]:S.VectorGlobal,[l.d.ContainsDisplayName]:S.VectorMentions,[l.d.ContainsUserName]:S.VectorMentions,[l.d.AtRoomNotification]:S.VectorMentions,[l.d.InviteToSelf]:S.VectorOther,[l.d.IncomingCall]:S.VectorOther,[l.d.SuppressNotices]:S.VectorOther,[l.d.Tombstone]:S.VectorOther},s={[S.Master]:[],[S.VectorGlobal]:[],[S.VectorMentions]:[],[S.VectorOther]:[],[S.Other]:[]};for(const i in e.global){const a=i;for(const i of e.global[a]){var n;const e=Object.assign(i,{kind:a}),o=null!==(n=t[e.rule_id])&&void 0!==n?n:S.Other;"."===e.rule_id[0]&&s[o].push(e)}}const i={};if(!(s.master.length>0))throw new Error("Failed to locate a master push rule");i.masterPushRule=s.master[0],i.vectorKeywordRuleInfo=y.parseContentRules(e),i.vectorPushRules={};const a=[S.VectorGlobal,S.VectorMentions,S.VectorOther];for(const e of a){i.vectorPushRules[e]=[];for(const t of s[e]){const s=b[t.rule_id],n=s.ruleToVectorState(t);i.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:n,description:Object(g.a)(s.description)})}i.vectorPushRules[e].sort((e,t)=>{let s=U.indexOf(e.ruleId),n=U.indexOf(t.ruleId);return s<0&&(s=U.length),n<0&&(n=U.length),s-n}),e===A&&i.vectorPushRules[e].push({ruleId:"_keywords",description:Object(g.a)("Messages containing keywords"),vectorState:i.vectorKeywordRuleInfo.vectorState})}return i}refreshPushers(){return c.a.get().getPushers()}refreshThreepids(){return c.a.get().getThreePids()}showSaveError(){R.a.createTrackedDialog("Error saving notification preferences","",I.a,{title:Object(g.a)("Error saving notification preferences"),description:Object(g.a)("An error occurred whilst saving your notification preferences.")})}async setKeywords(e,t){try{e=Array.from(new Set(e)).filter(e=>!!e);const s=Array.from(new Set(t.map(e=>e.pattern))).filter(e=>!!e),n=Object(P.a)(s,e);for(const e of n.removed)for(const s of t.filter(t=>t.pattern===e))await c.a.get().deletePushRule("global",s.kind,s.rule_id);let i=this.state.vectorKeywordRuleInfo.vectorState;i===m.Off&&(i=t.length?p.contentRuleVectorStateKind(t[0]):m.On);const a=l.c.ContentSpecific;for(const e of n.added)await c.a.get().addPushRule("global",a,e,{actions:p.actionsFor(i),pattern:e}),i===m.Off&&await c.a.get().setPushRuleEnabled("global",a,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:E.Error}),v.a.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=o.a.createElement(w.a,{value:!this.isInhibited,label:Object(g.a)("Enable for this account"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===E.Persisting});if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter(e=>e.medium===_.a.Email).map(e=>o.a.createElement(w.a,{key:e.address,value:this.state.pushers.some(t=>"email"===t.kind&&t.pushkey===e.address),label:Object(g.a)("Enable email notifications for %(email)s",{email:e.address}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===E.Persisting}));return o.a.createElement(o.a.Fragment,null,e,o.a.createElement(w.a,{value:C.b.getValue("notificationsEnabled"),onChange:this.onDesktopNotificationsChanged,label:Object(g.a)("Enable desktop notifications for this session"),disabled:this.state.phase===E.Persisting}),o.a.createElement(w.a,{value:C.b.getValue("notificationBodyEnabled"),onChange:this.onDesktopShowBodyChanged,label:Object(g.a)("Show message in desktop notification"),disabled:this.state.phase===E.Persisting}),o.a.createElement(w.a,{value:C.b.getValue("audioNotificationsEnabled"),onChange:this.onAudioNotificationsChanged,label:Object(g.a)("Enable audible notifications for this session"),disabled:this.state.phase===E.Persisting}),t)}renderCategory(e){if(e!==S.VectorOther&&this.isInhibited)return null;let t,s;if(e===S.VectorOther&&c.a.get().getRooms().some(e=>e.getUnreadNotificationCount()>0)&&(t=o.a.createElement(T.a,{onClick:this.onClearNotificationsClicked,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton"},Object(g.a)("Clear notifications"))),e===S.VectorOther&&this.isInhibited)return t?o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",null,Object(g.a)("Other")),t):null;var n;e===S.VectorMentions&&(s=o.a.createElement(j.a,{tags:null===(n=this.state.vectorKeywordRuleInfo)||void 0===n?void 0:n.rules.map(e=>e.pattern),onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===E.Persisting,label:Object(g.a)("Keyword"),placeholder:Object(g.a)("New keyword")}));const i=(e,t)=>o.a.createElement(O.a,{key:e.ruleId,name:e.ruleId,checked:e.vectorState===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===E.Persisting}),a=this.state.vectorPushRules[e].map(t=>o.a.createElement("tr",{key:e+t.ruleId},o.a.createElement("td",null,t.description),o.a.createElement("td",null,i(t,m.Off)),o.a.createElement("td",null,i(t,m.On)),o.a.createElement("td",null,i(t,m.Loud))));let r;switch(e){case S.VectorGlobal:r=Object(g.a)("Global");break;case S.VectorMentions:r=Object(g.a)("Mentions & keywords");break;case S.VectorOther:r=Object(g.a)("Other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return o.a.createElement(o.a.Fragment,null,o.a.createElement("table",{className:"mx_UserNotifSettings_pushRulesTable"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,r),o.a.createElement("th",null,Object(g.a)("Off")),o.a.createElement("th",null,Object(g.a)("On")),o.a.createElement("th",null,Object(g.a)("Noisy")))),o.a.createElement("tbody",null,a)),t,s)}renderTargets(){if(this.isInhibited)return null;const e=this.state.pushers.map(e=>o.a.createElement("tr",{key:e.kind+e.pushkey},o.a.createElement("td",null,e.app_display_name),o.a.createElement("td",null,e.device_display_name)));return e.length?o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",null,Object(g.a)("Notification targets")),o.a.createElement("table",null,o.a.createElement("tbody",null,e))):null}render(){return this.state.phase===E.Loading?o.a.createElement(r.a,null):this.state.phase===E.Error?o.a.createElement("p",null,Object(g.a)("There was an error loading your notification settings.")):o.a.createElement("div",{className:"mx_UserNotifSettings"},this.renderTopSection(),this.renderCategory(S.VectorGlobal),this.renderCategory(S.VectorMentions),this.renderCategory(S.VectorOther),this.renderTargets())}}},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(108),c=s(821),l=s(315),d=s(817),h=s(87),u=s(89),m=s(551),p=s(397),g=(s(552),s(837));class v extends g.a{notifyCollapsed(e){const t=this.resizer.config.onCollapsed;t&&t(e,this.id,this.domNode)}get isCollapsed(){return(0,this.resizer.config.isItemCollapsed)(this.domNode)}}class f extends p.a{static createItem(e,t,s,n){return new v(e,t,s,n)}constructor(e){var t,s;super(e),i()(this,"toggleSize",void 0),i()(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(s=t.config)||void 0===s?void 0:s.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}var b=s(553),y=s(98),E=s(398),S=s(554),_=s(121),w=s(147),C=s(84),O=s(179),k=s(146),R=s(307);const I=()=>{k.a.sharedInstance().dismissToast("serverlimit")};var x,T,j,N=s(92),P=s(840),D=s(857),M=s(165),A=s(866),U=s(90),L=s(867),F=s(195),B=s(868),V=s(85),K=s(151),W=s(880),G=s(228),H=s(123),q=s(882),$=s(945),z=s(946),J=s(947),Y=s(948),Q=s(610),X=s(106),Z=s(91),ee=s.n(Z),te=s(952),se=s(958),ne=s(103),ie=s(959),ae=s(133);function oe(e){return e.closest("input, textarea, select, [contenteditable=true]")}let re=Object(V.a)("structures.LoggedInView")((j=T=class extends o.a.Component{constructor(e,t){super(e,t),i()(this,"dispatcherRef",void 0),i()(this,"_matrixClient",void 0),i()(this,"_roomView",void 0),i()(this,"_resizeContainer",void 0),i()(this,"resizeHandler",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"compactLayoutWatcherRef",void 0),i()(this,"backgroundImageWatcherRef",void 0),i()(this,"resizer",void 0),i()(this,"refreshBackgroundImage",async()=>{let e=u.b.getValue("RoomList.backgroundImage");e=e?Object(ne.b)(e).srcHttp:G.a.instance.getHttpAvatarUrl(),this.setState({backgroundImage:e})}),i()(this,"onAction",e=>{switch(e.action){case"call_state":{const e=K.d.sharedInstance().getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e});break}}}),i()(this,"canResetTimelineInRoom",e=>!this._roomView.current||this._roomView.current.canResetTimeline()),i()(this,"onAccountData",e=>{"m.ignored_user_list"===e.getType()&&h.a.dispatch({action:"ignore_state_changed"})}),i()(this,"onLayoutChanged",(e,t,s,n,i)=>{this.setState({layout:n})}),i()(this,"onCompactLayoutChanged",(e,t,s,n,i)=>{this.setState({useCompactLayout:n})}),i()(this,"onSync",(e,t,s)=>{const n=this.state.syncErrorData&&this.state.syncErrorData.error&&this.state.syncErrorData.error.errcode,i=s&&s.error&&s.error.errcode;e===t&&n===i||("ERROR"===e?this.setState({syncErrorData:s}):this.setState({syncErrorData:null}),"PREPARED"===t&&"SYNCING"===e?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))}),i()(this,"onRoomStateEvents",(e,t)=>{const s=M.b.instance.orderedLists[w.a.ServerNotice];s&&s.some(t=>t.roomId===e.getRoomId())&&this.updateServerNoticeEvents()}),i()(this,"onUsageLimitDismissed",()=>{this.setState({usageLimitDismissed:!0})}),i()(this,"updateServerNoticeEvents",async()=>{const e=M.b.instance.orderedLists[w.a.ServerNotice];if(!e)return[];const t=[];let s=0;for(const n of e){const e=n.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;s=e.getTs();const i=e.getContent().pinned.slice(0,2);for(const e of i){const s=(await this._matrixClient.getEventTimeline(n.getUnfilteredTimelineSet(),e)).getEvents().find(t=>t.getId()===e);s&&t.push(s)}}if(s&&this.state.usageLimitEventTs>s)return;const n=t.find(e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type),i=n&&n.getContent();this.calculateServerLimitToast(this.state.syncErrorData,i),this.setState({usageLimitEventContent:i,usageLimitEventTs:s,usageLimitDismissed:!1})}),i()(this,"onPaste",e=>{const t=oe(e.target);t?t.focus():h.a.fire(N.a.FocusSendMessageComposer,!0)}),i()(this,"onReactKeyDown",e=>{this.onKeyDown(e)}),i()(this,"onNativeKeyDown",e=>{e.target===document.body&&this.onKeyDown(e)}),i()(this,"onKeyDown",e=>{let t=!1;switch(Object(F.f)().getRoomAction(e)){case F.d.ScrollUp:case F.d.RoomScrollDown:case F.d.JumpToFirstMessage:case F.d.JumpToLatestMessage:this.onScrollKeyPressed(e),t=!0;break;case F.d.FocusSearch:h.a.dispatch({action:"focus_search"}),t=!0}if(t)return e.stopPropagation(),void e.preventDefault();switch(Object(F.f)().getNavigationAction(e)){case F.c.FocusRoomSearch:h.a.dispatch({action:"focus_room_filter"}),t=!0;break;case F.c.ToggleUserMenu:h.a.fire(N.a.ToggleUserMenu),t=!0;break;case F.c.ToggleShortCutDialog:E.f(),t=!0;break;case F.c.GoToHome:h.a.dispatch({action:"view_home_page"}),U.a.closeCurrentModal("homeKeyboardShortcut"),t=!0;break;case F.c.ToggleRoomSidePanel:"room_view"!==this.props.page_type&&"group_view"!==this.props.page_type||(h.a.dispatch({action:N.a.ToggleRightPanel,type:"room_view"===this.props.page_type?"room":"group"}),t=!0);break;case F.c.SelectPrevRoom:h.a.dispatch({action:N.a.ViewRoomDelta,delta:-1,unread:!1}),t=!0;break;case F.c.SelectNextRoom:h.a.dispatch({action:N.a.ViewRoomDelta,delta:1,unread:!1}),t=!0;break;case F.c.SelectPrevUnreadRoom:h.a.dispatch({action:N.a.ViewRoomDelta,delta:-1,unread:!0});break;case F.c.SelectNextUnreadRoom:h.a.dispatch({action:N.a.ViewRoomDelta,delta:1,unread:!0});break;default:t=_.a.get().onKeyDown(e)}if(t)return e.stopPropagation(),void e.preventDefault();if(!(e.key===r.a.ALT||e.key===r.a.CONTROL||e.key===r.a.META||e.key===r.a.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===r.a.SPACE||e.key===r.a.ENTER),s=1===e.key.length||"Dead"===e.key;t||!s||oe(e.target)||(h.a.fire(N.a.FocusSendMessageComposer,!0),e.stopPropagation())}}),i()(this,"onScrollKeyPressed",e=>{this._roomView.current&&this._roomView.current.handleScrollKey(e)}),this.state={syncErrorData:void 0,layout:u.b.getValue("layout"),useCompactLayout:u.b.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:K.d.sharedInstance().getAllActiveCalls()},h.a.dispatch({action:N.a.RecheckTheme}),this._matrixClient=this.props.matrixClient,l.c.loadDevices(),Object(d.a)(),this._roomView=o.a.createRef(),this._resizeContainer=o.a.createRef(),this.resizeHandler=o.a.createRef()}componentDidMount(){document.addEventListener("keydown",this.onNativeKeyDown,!1),this.dispatcherRef=h.a.register(this.onAction),this.updateServerNoticeEvents(),this._matrixClient.on("accountData",this.onAccountData),this._matrixClient.on("sync",this.onSync),this.onSync(this._matrixClient.getSyncState(),null,this._matrixClient.getSyncStateData()),this._matrixClient.on("RoomState.events",this.onRoomStateEvents),this.layoutWatcherRef=u.b.watchSetting("layout",null,this.onLayoutChanged),this.compactLayoutWatcherRef=u.b.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.backgroundImageWatcherRef=u.b.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.resizer=this.createResizer(),this.resizer.attach(),G.a.instance.on(H.b,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage()}componentWillUnmount(){document.removeEventListener("keydown",this.onNativeKeyDown,!1),h.a.unregister(this.dispatcherRef),this._matrixClient.removeListener("accountData",this.onAccountData),this._matrixClient.removeListener("sync",this.onSync),this._matrixClient.removeListener("RoomState.events",this.onRoomStateEvents),G.a.instance.off(H.b,this.refreshBackgroundImage),u.b.unwatchSetting(this.layoutWatcherRef),u.b.unwatchSetting(this.compactLayoutWatcherRef),u.b.unwatchSetting(this.backgroundImageWatcherRef),this.resizer.detach()}createResizer(){let e,t;const s={toggleSize:156,onCollapsed:e=>{t=e,e?(h.a.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):h.a.dispatch({action:"show_left_panel"})},onResized:t=>{e=t,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{t||window.localStorage.setItem("mx_lhs_size",""+e),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized"),handler:this.resizeHandler.current},n=new b.a(this._resizeContainer.current,f,s);return n.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),n}loadResizerPreferences(){let e=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(e)&&(e=350),this.resizer.forHandleWithId("lp-resizer").resize(e)}calculateServerLimitToast(e,t){const s=e&&e.error&&"M_RESOURCE_LIMIT_EXCEEDED"===e.error.errcode;s&&(t=e.error.data),t&&this.state.usageLimitDismissed?((e,t,s,n)=>{const i=Object(R.a)(e,s,{monthly_active_user:Object(C.b)("Your homeserver has exceeded its user limit."),hs_blocked:Object(C.b)("This homeserver has been blocked by it's administrator."),"":Object(C.b)("Your homeserver has exceeded one of its resource limits.")}),a=Object(R.a)(e,s,{"":Object(C.b)("Contact your <a>server admin</a>.")});k.a.sharedInstance().addOrReplaceToast({key:"serverlimit",title:Object(C.a)("Warning"),props:{description:o.a.createElement(o.a.Fragment,null,i," ",a),acceptLabel:Object(C.a)("Ok"),onAccept:()=>{I(),t&&t()}},component:O.a,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):I()}render(){let e;switch(this.props.page_type){case c.a.RoomView:e=o.a.createElement(q.a,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case c.a.MyGroups:e=o.a.createElement(z.a,null);break;case c.a.RoomDirectory:break;case c.a.HomePage:e=o.a.createElement(S.a,{justRegistered:this.props.justRegistered});break;case c.a.UserView:e=o.a.createElement(J.a,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier});break;case c.a.GroupView:e=X.a.spacesEnabled?o.a.createElement(ie.a,{groupId:this.props.currentGroupId}):o.a.createElement(Y.a,{groupId:this.props.currentGroupId,isNew:this.props.currentGroupIsNew,resizeNotifier:this.props.resizeNotifier})}const t=ee()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.layout===ae.a.Group&&this.state.useCompactLayout}),s=ee()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),n=this.state.activeCalls.map(e=>o.a.createElement(W.a,{call:e,key:e.callId}));return o.a.createElement(y.a.Provider,{value:this._matrixClient},o.a.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},o.a.createElement($.a,null),o.a.createElement("div",{className:s},o.a.createElement("div",{className:"mx_LeftPanel_wrapper"},u.b.getValue("TagPanel.enableTagPanel")&&o.a.createElement("div",{className:"mx_GroupFilterPanelContainer"},o.a.createElement(Q.a,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),o.a.createElement(te.a,null),u.b.getValue("feature_custom_tags")?o.a.createElement(se.a,null):null),X.a.spacesEnabled?o.a.createElement(o.a.Fragment,null,o.a.createElement(Q.a,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),o.a.createElement(B.a,null)):null,o.a.createElement(Q.a,{backgroundImage:this.state.backgroundImage}),o.a.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!this.props.collapseLhs||void 0},o.a.createElement(P.a,{isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier}))),o.a.createElement(m.a,{passRef:this.resizeHandler,id:"lp-resizer"}),o.a.createElement("div",{className:"mx_RoomView_wrapper"},e))),o.a.createElement(D.a,null),o.a.createElement(A.a,null),o.a.createElement(L.a,null),n)}},i()(T,"displayName","LoggedInView"),x=j))||x;t.a=re},function(e,t,s){"use strict";var n=s(82),i=s.n(n),a=s(319),o=s(91),r=s.n(o),c=s(88),l=s(155),d=s(108);const h=(e,t)=>{try{const s=window.localStorage.getItem(e);return s?JSON.parse(s):t}catch(e){return t}},u=(e,t)=>{const s="mx_"+e,[i,a]=Object(n.useState)(h(s,t));Object(n.useEffect)(()=>{a(h(s,t))},[s,t]);return[i,Object(n.useCallback)(e=>{window.localStorage.setItem(s,JSON.stringify(e)),a(e)},[s])]};var m=s(98),p=s(152),g=s(135);const v=e=>e?e.getContent():void 0;var f=s(276),b=s(236),y=s(139);t.a=()=>{const e=Object(n.useContext)(m.a),t=((e,t)=>{const[s,i]=Object(n.useState)(()=>v(e.getAccountData(t))),a=Object(n.useCallback)(e=>{e.getType()===t&&i(e.getContent())},[t]);return Object(g.a)(e,"accountData",a),s||{}})(e,"m.widgets"),s=Object(b.b)("Widgets.leftPanel"),o=Object(n.useMemo)(()=>{if(!t||!s)return null;const e=Object.values(t).find(e=>e.id===s);return e?p.a.makeAppConfig(e.state_key,e.content,e.sender,null,e.id):null},[t,s]),[h,E]=u("left-panel-widget-height",280),[S,_]=u("left-panel-widget-expanded",!0),[w,C,O]=Object(l.f)(),k=C?0:-1;if(!o)return null;let R;return S&&(R=i.a.createElement(a.Resizable,{size:{height:h},minHeight:100,maxHeight:Math.min(y.b.instance.windowHeight/2,500),onResizeStop:(e,t,s,n)=>{E(h+n.height)},handleWrapperClass:"mx_LeftPanelWidget_resizerHandles",handleClasses:{top:"mx_LeftPanelWidget_resizerHandle"},className:"mx_LeftPanelWidget_resizeBox",enable:{top:!0}},i.a.createElement(f.a,{app:o,fullWidth:!0,showMenubar:!1,userWidget:!0,userId:e.getUserId(),creatorUserId:o.creatorUserId,widgetPageTitle:p.a.getWidgetDataTitle(o),waitForIframeLoad:o.waitForIframeLoad}))),i.a.createElement("div",{className:"mx_LeftPanelWidget"},i.a.createElement("div",{onFocus:w,className:"mx_LeftPanelWidget_headerContainer",onKeyDown:e=>{switch(e.key){case d.a.ARROW_LEFT:e.stopPropagation(),_(!1);break;case d.a.ARROW_RIGHT:e.stopPropagation(),_(!0)}}},i.a.createElement("div",{className:"mx_LeftPanelWidget_stickable"},i.a.createElement(c.a,{onFocus:w,inputRef:O,tabIndex:k,className:"mx_LeftPanelWidget_headerText",role:"treeitem","aria-expanded":S,"aria-level":1,onClick:()=>{_(!S)}},i.a.createElement("span",{className:r()({mx_LeftPanelWidget_collapseBtn:!0,mx_LeftPanelWidget_collapseBtn_collapsed:!S})}),i.a.createElement("span",null,p.a.getWidgetName(o))))),R)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return U})),s.d(t,"b",(function(){return L}));var n=s(83),i=s.n(n),a=s(153),o=s(1032),r=s(5),c=s(267),l=s(132),d=s(86),h=s(228),u=s(152),m=s(201),p=s(89),g=s(178),v=s(310),f=s(144),b=s(87),y=s(92),E=s(3),S=s(164),_=s(90),w=s(855),C=s(1);function O(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function k(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?O(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):O(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class R extends S.a{constructor(){super(b.a,{}),i()(this,"modalInstance",null),i()(this,"openSourceWidgetId",null),i()(this,"canOpenModalWidget",()=>!this.modalInstance),i()(this,"openModalWidget",(e,t,s)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.modalInstance=_.a.createTrackedDialog("Modal Widget","",w.a,{widgetDefinition:k({},e),widgetRoomId:s,sourceWidgetId:t.id,onFinished:(e,s)=>{e?this.closeModalWidget(t,s):this.closeModalWidget(t,{"m.exited":!0}),this.openSourceWidgetId=null,this.modalInstance=null}},null,!1,!0))}),i()(this,"closeModalWidget",(e,t)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id){this.openSourceWidgetId=null,this.modalInstance.close(),this.modalInstance=null;const s=c.a.instance.getMessaging(e);if(!s)return void C.a.error("No source widget messaging for modal widget");s.notifyModalWidgetClose(t)}})}static get instance(){return R.internalInstance}async onAction(e){}}i()(R,"internalInstance",new R),window.mxModalWidgetStore=R.instance;var I=s(265),x=s(124),T=s(854),j=s(856),N=s(84);const P={};var D=s(116);function M(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function A(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?M(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):M(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class U extends a.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return g.a.JITSI.matches(this.type)?u.a.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return g.a.JITSI.matches(this.type)?u.a.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="jitsi.riot.im");const s=I.a.getCurrentThemeSimplified();return A(A({},super.rawData),{},{theme:s,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return Object(a.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,A(A({},this.rawDefinition),{},{data:this.rawData}),e)}}class L extends r.EventEmitter{constructor(e){var t;super(),this.appTileProps=e,i()(this,"messaging",void 0),i()(this,"mockWidget",void 0),i()(this,"scalarToken",void 0),i()(this,"roomId",void 0),i()(this,"kind",void 0),i()(this,"readUpToMap",{}),i()(this,"onOpenModal",async e=>{e.preventDefault(),R.instance.canOpenModalWidget()?(R.instance.openModalWidget(e.detail.data,this.mockWidget),this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})}),i()(this,"onEvent",e=>{d.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()||this.feedEvent(e)}),i()(this,"onEventDecrypted",e=>{e.isDecryptionFailure()||this.feedEvent(e)});let s=e.app;s.creatorUserId||(s=Object(f.f)(s),s.creatorUserId=d.a.get().getUserId()),this.mockWidget=new U(s),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?a.WidgetKind.Account:a.WidgetKind.Room}get eventListenerRoomId(){return this.roomId?this.roomId:l.a.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){var t,s;const n=null!==(t=null==P||null===(s=P.provideVariables)||void 0===s?void 0:s.call(P))&&void 0!==t?t:{},i={widgetRoomId:this.roomId,currentUserId:d.a.get().getUserId(),userDisplayName:h.a.instance.displayName,userHttpAvatarUrl:h.a.instance.getHttpAvatarUrl(),clientId:j.a,clientTheme:I.a.getCurrentTheme(),clientLanguage:Object(N.g)()},a=this.mockWidget.getCompleteUrl(Object.assign(i,n),null==e?void 0:e.asPopout),o=new URL(a);return null!=e&&e.asPopout||(o.searchParams.set("widgetId",this.mockWidget.id),o.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&o.searchParams.set("scalar_token",this.scalarToken)),o.toString().replace(/%24/g,"$")}get isManagedByManager(){return!!this.scalarToken}get started(){return!!this.messaging}get widgetId(){return this.messaging.widget.id}start(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],s=new o.a(t,this.mockWidget,this.kind,this.roomId);this.messaging=new a.ClientWidgetApi(this.mockWidget,e,s),this.messaging.on("preparing",()=>this.emit("preparing")),this.messaging.on("ready",()=>this.emit("ready")),this.messaging.on("capabilitiesNotified",()=>this.emit("capabilitiesNotified")),this.messaging.on("action:"+a.WidgetApiFromWidgetAction.OpenModalWidget,this.onOpenModal),c.a.instance.storeMessaging(this.mockWidget,this.messaging),!this.appTileProps.userWidget&&this.appTileProps.room&&v.b.instance.setRoomId(this.mockWidget.id,this.appTileProps.room.roomId),this.messaging.on("action:"+E.a.ViewRoom,e=>{e.preventDefault();const t=(e.detail.data||{}).room_id;return t?this.messaging.hasCapability(T.a.CanChangeViewedRoom)?(b.a.dispatch({action:y.a.ViewRoom,room_id:t}),void this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):this.messaging.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})});for(const e of d.a.get().getRooms()){var n;const t=(null===(n=e.getLiveTimeline())||void 0===n?void 0:n.getEvents())||[],s=t[t.length-1];s&&(this.readUpToMap[e.roomId]=s.getId())}d.a.get().on("event",this.onEvent),d.a.get().on("Event.decrypted",this.onEventDecrypted),this.messaging.on("action:"+a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,e=>{this.messaging.hasCapability(a.MatrixCapabilities.AlwaysOnScreen)&&(g.a.JITSI.matches(this.mockWidget.type)&&x.a.instance.trackJoinCall(this.appTileProps.room.roomId,!0,!0),v.b.instance.setWidgetPersistence(this.mockWidget.id,e.detail.data.value),e.preventDefault(),this.messaging.transport.reply(e.detail,{}))}),this.messaging.on("action:"+a.WidgetApiFromWidgetAction.SendSticker,e=>{this.messaging.hasCapability(a.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))}),g.a.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on("action:"+E.a.OpenIntegrationManager,e=>{e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"stickerpicker_close"});const t=e.detail.data,s=null==t?void 0:t.integType,n=null==t?void 0:t.integId;p.b.getValue("feature_many_integration_managers")?m.a.sharedInstance().openAll(d.a.get().getRoom(l.a.getRoomId()),"type_"+s,n):m.a.sharedInstance().getPrimaryManager().open(d.a.get().getRoom(l.a.getRoomId()),"type_"+s,n)})}async prepare(){var e,t;if(await(null!==(e=null==P||null===(t=P.isReady)||void 0===t?void 0:t.call(P))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const s=c.a.instance.getMessaging(this.mockWidget);s&&(this.messaging=s);try{if(u.a.isScalarUrl(this.mockWidget.templateUrl)){const e=m.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(u.a.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){C.a.error("Error preparing widget communications: ",e)}}stop(e={forceDestroy:!1}){null!=e&&e.forceDestroy||v.b.instance.getPersistentWidgetId()!==this.mockWidget.id?this.started&&(c.a.instance.stopMessaging(this.mockWidget),v.b.instance.delRoomId(this.mockWidget.id),d.a.get()&&(d.a.get().off("event",this.onEvent),d.a.get().off("Event.decrypted",this.onEventDecrypted))):C.a.log("Skipping destroy - persistent widget")}feedEvent(e){if(!this.messaging)return;const t=this.readUpToMap[e.getRoomId()];if(t){if(t===e.getId())return;let s=!0;const n=d.a.get().getRoom(e.getRoomId()).getLiveTimeline(),i=Object(D.b)(n.getEvents()).reverse().slice(0,100);for(const n of i){if(n.getId()===t)break;if(n.getId()===e.getId()){s=!1;break}}if(s)return}this.readUpToMap[e.getRoomId()]=e.getId();const s=e.getEffectiveEvent();this.messaging.feedEvent(s,this.eventListenerRoomId).catch(e=>{C.a.error("Error sending event to widget: ",e)})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(83),i=s.n(n),a=s(153),o=s(116);var r=s(86),c=s(768),l=s(90),d=s(852),h=s(1035);const u={};var m=s(853),p=s(178),g=s(94),v=s(220),f=s(329),b=s(87),y=s(120),E=s(1),S=s(89);class _ extends a.WidgetDriver{constructor(e,t,s,n){if(super(),this.forWidget=t,this.forWidgetKind=s,this.inRoomId=n,i()(this,"allowedCapabilities",void 0),this.allowedCapabilities=new Set([...e,a.MatrixCapabilities.Screenshots,a.MatrixCapabilities.RequiresClient]),p.a.JITSI.matches(this.forWidget.type)&&s===a.WidgetKind.Room)this.allowedCapabilities.add(a.MatrixCapabilities.AlwaysOnScreen);else if(p.a.STICKERPICKER.matches(this.forWidget.type)&&s===a.WidgetKind.Account){const e=a.WidgetEventCapability.forRoomEvent(a.EventDirection.Send,g.a.Sticker).raw;this.allowedCapabilities.add(a.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}}async validateCapabilities(e){const t=(s=e,n=this.allowedCapabilities,Object(o.a)(Array.from(s),Array.from(n)));var s,n;const i=new Set(t.removed),a=new Set(this.allowedCapabilities);var r;if((r=this.forWidget,JSON.parse(localStorage.getItem(`widget_${r.id}_approved_caps`)||"[]")).forEach(e=>{a.add(e),i.delete(e)}),u.preapproveCapabilities){const t=await u.preapproveCapabilities(this.forWidget,e);t&&t.forEach(e=>{a.add(e),i.delete(e)})}let c=!1;if(i.size>0)try{const[e]=await l.a.createTrackedDialog("Approve Widget Caps","",h.a,{requestedCapabilities:i,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;(e.approved||[]).forEach(e=>a.add(e)),c=e.remember}catch(e){E.a.error("Non-fatal error getting capabilities: ",e)}const d=new Set(function(e,t){return Object(o.k)(Array.from(e),Array.from(t))}(a,e));return c&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(d)),d}async sendEvent(e,t,s=null,n=null){const i=r.a.get(),a=n||c.a.activeRoomId;if(!i||!a)throw new Error("Not in a room or not attached to a client");let o=null;return null!==s?o=await i.sendStateEvent(a,e,t,s):e===g.a.RoomRedaction?o=await i.redactEvent(a,t.redacts):(o=await i.sendEvent(a,e,t),e===g.a.RoomMessage&&v.CHAT_EFFECTS.forEach(e=>{if(Object(f.containsEmoji)(t,e.emojis)){const s=t["m.relates_to"].rel_type!==g.c.Thread;S.b.getValue("feature_thread")&&!s||b.a.dispatch({action:"effects."+e.command})}})),{roomId:a,eventId:o.event_id}}pickRooms(e=null){const t=r.a.get();if(!t)throw new Error("Not attached to a client");return(e?e.includes(a.Symbols.AnyRoom)?t.getVisibleRooms():e.map(e=>t.getRoom(e)):[t.getRoom(c.a.activeRoomId)]).filter(e=>!!e)}async readRoomEvents(e,t,s,n=null){s=s>0?Math.min(s,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const i=this.pickRooms(n),a=[];for(const n of i){const i=[],o=n.getLiveTimeline().getEvents();for(let n=o.length-1;n>0&&!(i.length>=s);n--){const s=o[n];s.getType()!==e||s.isState()||e===g.a.RoomMessage&&t&&t!==s.getContent().msgtype||i.push(s)}i.forEach(e=>a.push(e.getEffectiveEvent()))}return a}async readStateEvents(e,t,s,n=null){s=s>0?Math.min(s,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const i=this.pickRooms(n),a=[];for(const n of i){const i=[],o=n.currentState.events.get(e);if(o)if(""===t||t){const e=o.get(t);e&&i.push(e)}else i.push(...Array.from(o.values()));i.slice(0,s).forEach(e=>a.push(e.getEffectiveEvent()))}return a}async askOpenID(e){const t=m.b.instance.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),s=()=>r.a.get().getOpenIdToken();return t===m.a.Denied?e.update({state:a.OpenIDRequestState.Blocked}):t===m.a.Allowed?e.update({state:a.OpenIDRequestState.Allowed,token:await s()}):(e.update({state:a.OpenIDRequestState.PendingUserConfirmation}),void l.a.createTrackedDialog("OpenID widget permissions","",d.a,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:a.OpenIDRequestState.Allowed,token:await s()}):e.update({state:a.OpenIDRequestState.Blocked})}))}async navigate(e){const t=Object(y.l)(e);if(!t||t===e)throw new Error("Failed to transform URI");window.location.hash=t}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(136),l=s(148),d=s.n(l);class h extends o.a.Component{constructor(e){super(e),i()(this,"nodes",{}),i()(this,"children",void 0),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){Object.entries(t).forEach(([t,s])=>{e.style[t]=s})}updateChildren(e){const t=this.children||{};this.children={},o.a.Children.toArray(e).forEach(e=>{if(t[e.key]){const s=t[e.key],n=d.a.findDOMNode(this.nodes[s.key]);n&&n.style.left!==e.props.style.left&&this.applyStyles(n,{left:e.props.style.left}),this.children[e.key]=o.a.cloneElement(s,e.props,e.props.children)}else{const t={},s=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,s),this.children[e.key]=o.a.cloneElement(e,t)}})}collectNode(e,t,s){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,n=d.a.findDOMNode(t);for(let t=1;t<e.length;++t)this.applyStyles(n,e[t]);setTimeout(()=>{this.applyStyles(n,s)},0)}this.nodes[e]=t}render(){return o.a.createElement(o.a.Fragment,null,Object.values(this.children))}}i()(h,"defaultProps",{startStyles:[]});var u,m,p,g=s(376),v=s(85),f=s(142),b=s(1);let y=Object(v.a)("views.rooms.ReadReceiptMarker")((p=m=class extends o.a.PureComponent{constructor(e){super(e),i()(this,"avatar",Object(a.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;if(!e)return;if(this.props.checkUnmounting&&this.props.checkUnmounting())return;const t=this.avatar.current;e.top=t.offsetTop,e.left=t.offsetLeft,e.parent=t.offsetParent}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.leftOffset!==this.props.leftOffset,s=e.hidden!==this.props.hidden;(t||s)&&this.animateMarker()}animateMarker(){let e=-15;const t=this.props.readReceiptInfo;t&&t.parent&&(e=t.top+t.parent.getBoundingClientRect().top);const s=this.avatar.current;let n;s.offsetParent?n=e-s.offsetParent.getBoundingClientRect().top:(b.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} in has no offsetParent`),n=0);const i=[];t&&t.left&&i.push({top:n+"px",left:Object(g.a)(t.left)}),i.push({top:n+"px",left:"0"}),this.setState({suppressDisplay:!1,startStyles:i})}render(){if(this.state.suppressDisplay)return o.a.createElement("div",{ref:this.avatar});const e={left:Object(g.a)(this.props.leftOffset),top:"0px"};let t;if(this.props.timestamp){const e=Object(c.b)(new Date(this.props.timestamp),this.props.showTwelveHour);t=this.props.member&&this.props.fallbackUserId!==this.props.member.rawDisplayName?Object(r.a)("Seen by %(displayName)s (%(userName)s) at %(dateTime)s",{displayName:this.props.member.rawDisplayName,userName:this.props.fallbackUserId,dateTime:e}):Object(r.a)("Seen by %(userName)s at %(dateTime)s",{userName:this.props.fallbackUserId,dateTime:e})}return o.a.createElement(h,{startStyles:this.state.startStyles},o.a.createElement(f.a,{member:this.props.member,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",width:14,height:14,resizeMethod:"crop",style:e,title:t,onClick:this.props.onClick,inputRef:this.avatar}))}},i()(m,"defaultProps",{leftOffset:0}),u=p))||u},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(127),c=s(187),l=s(84),d=s(86),h=s(85);var u,m={};let p=Object(h.a)("views.room_settings.RoomPublishSetting")(u=class extends o.a.PureComponent{constructor(e,t){super(e,t),i()(this,"onRoomPublishChange",e=>{const t=this.state.isRoomPublished,s=!t;this.setState({isRoomPublished:s});d.a.get().setRoomDirectoryVisibility(this.props.roomId,s?r.f.Public:r.f.Private).catch(()=>{this.setState({isRoomPublished:t})})}),this.state={isRoomPublished:!1}}componentDidMount(){d.a.get().getRoomDirectoryVisibility(this.props.roomId).then(e=>{this.setState({isRoomPublished:"public"===e.visibility})})}render(){var e;const t=d.a.get();!1===(null===(e=m.requireCanonicalAliasAccessToPublish)||void 0===e?void 0:e.call(m))||this.props.canSetCanonicalAlias;return o.a.createElement(c.a,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,label:Object(l.a)("Publish this room to the public in %(domain)s's room directory?",{domain:t.getDomain()})})}})||u},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(97),c=s(84),l=s(153),d=s(144),h=s(137),u=s(109),m=s(187),p=s(94),g=s(854),v=s(86),f=s(177);class b{static bylineFor(e){return e.isState?e.keyStr?Object(c.a)("with state key %(stateKey)s",{stateKey:e.keyStr}):Object(c.a)("with an empty state key"):null}static for(e,t){if(b.simpleCaps[e]){const s=b.simpleCaps[e];if(s[t])return{primary:Object(c.a)(s[t])};if(s.generic)return{primary:Object(c.a)(s.generic)}}if(Object(l.isTimelineCapability)(e)){if(Object(l.isTimelineCapabilityFor)(e,l.Symbols.AnyRoom))return{primary:Object(c.a)("The above, but in any room you are joined or invited to as well")};{const t=Object(l.getTimelineRoomIDFromCapability)(e),s=v.a.get().getRoom(t);return{primary:Object(c.a)("The above, but in <Room /> as well",{},{Room:()=>{var e;return s?o.a.createElement(f.a,{tooltip:null!==(e=s.getCanonicalAlias())&&void 0!==e?e:t},o.a.createElement("b",null,s.name)):o.a.createElement("b",null,o.a.createElement("code",null,t))}})}}}const[s]=l.WidgetEventCapability.findEventCapabilities([e]);if(s){if(!s.isState&&s.eventType===p.a.RoomMessage)return b.forRoomMessageCap(s,t);const e=s.isState?b.stateSendRecvCaps:b.nonStateSendRecvCaps;if(e[s.eventType]){const n=e[s.eventType],i=n[t]||n.generic;if(i&&i[s.direction])return{primary:Object(c.a)(i[s.direction])}}return t===l.WidgetKind.Room?s.direction===l.EventDirection.Send?{primary:Object(c.a)("Send <b>%(eventType)s</b> events as you in this room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:b.bylineFor(s)}:{primary:Object(c.a)("See <b>%(eventType)s</b> events posted to this room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:b.bylineFor(s)}:s.direction===l.EventDirection.Send?{primary:Object(c.a)("Send <b>%(eventType)s</b> events as you in your active room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:b.bylineFor(s)}:{primary:Object(c.a)("See <b>%(eventType)s</b> events posted to your active room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:b.bylineFor(s)}}return{primary:Object(c.a)("The <b>%(capability)s</b> capability",{capability:e},{b:e=>o.a.createElement("b",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send messages as you in this room"):Object(c.a)("Send messages as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See messages posted to this room"):Object(c.a)("See messages posted to your active room")};switch(e.keyStr){case p.b.Text:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send text messages as you in this room"):Object(c.a)("Send text messages as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See text messages posted to this room"):Object(c.a)("See text messages posted to your active room")};case p.b.Emote:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send emotes as you in this room"):Object(c.a)("Send emotes as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See emotes posted to this room"):Object(c.a)("See emotes posted to your active room")};case p.b.Image:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send images as you in this room"):Object(c.a)("Send images as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See images posted to this room"):Object(c.a)("See images posted to your active room")};case p.b.Video:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send videos as you in this room"):Object(c.a)("Send videos as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See videos posted to this room"):Object(c.a)("See videos posted to your active room")};case p.b.File:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send general files as you in this room"):Object(c.a)("Send general files as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See general files posted to this room"):Object(c.a)("See general files posted to your active room")};default:{let s;return s=e.direction===l.EventDirection.Send?t===l.WidgetKind.Room?Object(c.a)("Send <b>%(msgtype)s</b> messages as you in this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(c.a)("Send <b>%(msgtype)s</b> messages as you in your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):t===l.WidgetKind.Room?Object(c.a)("See <b>%(msgtype)s</b> messages posted to this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(c.a)("See <b>%(msgtype)s</b> messages posted to your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}),{primary:s}}}}}i()(b,"simpleCaps",{[l.MatrixCapabilities.AlwaysOnScreen]:{[l.WidgetKind.Room]:Object(c.b)("Remain on your screen when viewing another room, when running"),generic:Object(c.b)("Remain on your screen while running")},[l.MatrixCapabilities.StickerSending]:{[l.WidgetKind.Room]:Object(c.b)("Send stickers into this room"),generic:Object(c.b)("Send stickers into your active room")},[g.a.CanChangeViewedRoom]:{generic:Object(c.b)("Change which room you're viewing")},[l.MatrixCapabilities.MSC2931Navigate]:{generic:Object(c.b)("Change which room, message, or user you're viewing")}}),i()(b,"stateSendRecvCaps",{[p.a.RoomTopic]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Change the topic of this room"),[l.EventDirection.Receive]:Object(c.b)("See when the topic changes in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Change the topic of your active room"),[l.EventDirection.Receive]:Object(c.b)("See when the topic changes in your active room")}},[p.a.RoomName]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Change the name of this room"),[l.EventDirection.Receive]:Object(c.b)("See when the name changes in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Change the name of your active room"),[l.EventDirection.Receive]:Object(c.b)("See when the name changes in your active room")}},[p.a.RoomAvatar]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Change the avatar of this room"),[l.EventDirection.Receive]:Object(c.b)("See when the avatar changes in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Change the avatar of your active room"),[l.EventDirection.Receive]:Object(c.b)("See when the avatar changes in your active room")}},[p.a.RoomMember]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Kick, ban, or invite people to this room, and make you leave"),[l.EventDirection.Receive]:Object(c.b)("See when people join, leave, or are invited to this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Kick, ban, or invite people to your active room, and make you leave"),[l.EventDirection.Receive]:Object(c.b)("See when people join, leave, or are invited to your active room")}}}),i()(b,"nonStateSendRecvCaps",{[p.a.Sticker]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Send stickers to this room as you"),[l.EventDirection.Receive]:Object(c.b)("See when a sticker is posted in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Send stickers to your active room as you"),[l.EventDirection.Receive]:Object(c.b)("See when anyone posts a sticker to your active room")}}});var y,E=s(85),S=s(4);let _=Object(E.a)("views.dialogs.WidgetCapabilitiesPromptDialog")(y=class extends o.a.PureComponent{constructor(e){super(e),i()(this,"eventPermissionsMap",new Map),i()(this,"onToggle",e=>{const t=Object(d.f)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})}),i()(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),i()(this,"onSubmit",async e=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter(([e,t])=>t).map(([e])=>e))}),i()(this,"onReject",async e=>{this.closeAndTryRemember([])});l.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach(e=>this.eventPermissionsMap.set(e.raw,e));const t={};this.props.requestedCapabilities.forEach(e=>t[e]=!0),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort(([e],[t])=>{const s=Object(l.isTimelineCapability)(e),n=Object(l.isTimelineCapability)(t);return s||n?s&&!n?1:!s&&n?-1:s&&n?Object(S.x)(e,t):0:Object(S.x)(e,t)}).map(([e,t],s)=>{const n=b.for(e,this.props.widgetKind),i=n.byline?o.a.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},n.byline):null;return o.a.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+s},o.a.createElement(h.b,{checked:t,onChange:()=>this.onToggle(e)},n.primary),i)});return o.a.createElement(r.a,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:Object(c.a)("Approve widget permissions")},o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"text-muted"},Object(c.a)("This widget would like to:")),e,o.a.createElement(u.a,{primaryButton:Object(c.a)("Approve"),cancelButton:Object(c.a)("Decline All"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:o.a.createElement(m.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(c.a)("Remember my selection for this widget")})}))))}})||y},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(139),c=s(112);function l(e,t,s){return(1-(s=Object(c.clamp)(s,0,1)))*e+s*t}var d,h=s(317),u=s(85);const m=58,p=58,g=76,v=8;let f=Object(u.a)("views.voip.PictureInPictureDragger")(d=class extends o.a.Component{constructor(e){super(e),i()(this,"callViewWrapper",Object(a.createRef)()),i()(this,"initX",0),i()(this,"initY",0),i()(this,"desiredTranslationX",r.b.instance.windowWidth-v-336),i()(this,"desiredTranslationY",r.b.instance.windowHeight-p-232),i()(this,"moving",!1),i()(this,"scheduledUpdate",new h.a(()=>this.animationCallback(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),i()(this,"animationCallback",()=>{if(!this.moving&&Math.abs(this.state.translationX-this.desiredTranslationX)<=1&&Math.abs(this.state.translationY-this.desiredTranslationY)<=1)return;const e=this.moving?.2:.1;this.setState({translationX:l(this.state.translationX,this.desiredTranslationX,e),translationY:l(this.state.translationY,this.desiredTranslationY,e)}),this.scheduledUpdate.mark()}),i()(this,"onResize",()=>{this.snap(!1)}),i()(this,"snap",(e=!1)=>{var t,s;const n=this.desiredTranslationX,i=this.desiredTranslationY,a=r.b.instance.windowWidth-((null===(t=this.callViewWrapper.current)||void 0===t?void 0:t.clientWidth)||336),o=r.b.instance.windowHeight-((null===(s=this.callViewWrapper.current)||void 0===s?void 0:s.clientHeight)||232);n>=a/2&&i>=o/2?(this.desiredTranslationX=a-v,this.desiredTranslationY=o-p):n>=a/2&&i<=o/2?(this.desiredTranslationX=a-v,this.desiredTranslationY=m):n<=a/2&&i>=o/2?(this.desiredTranslationX=g,this.desiredTranslationY=o-p):(this.desiredTranslationX=g,this.desiredTranslationY=m),this.scheduledUpdate.mark(),e?this.scheduledUpdate.mark():this.setState({translationX:this.desiredTranslationX,translationY:this.desiredTranslationY})}),i()(this,"onStartMoving",e=>{e.preventDefault(),e.stopPropagation(),this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()}),i()(this,"onMoving",e=>{this.moving&&(e.preventDefault(),e.stopPropagation(),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY))}),i()(this,"onEndMoving",()=>{this.moving=!1,this.snap(!0)}),this.state={translationX:r.b.instance.windowWidth-v-336,translationY:r.b.instance.windowHeight-p-232}}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),window.addEventListener("resize",this.onResize)}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),window.removeEventListener("resize",this.onResize)}setTranslation(e,t){var s,n;const i=(null===(s=this.callViewWrapper.current)||void 0===s?void 0:s.clientWidth)||336,a=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232;e+i>=r.b.instance.windowWidth?this.desiredTranslationX=r.b.instance.windowWidth-i:this.desiredTranslationX=e<=0?0:e,t+a>=r.b.instance.windowHeight?this.desiredTranslationY=r.b.instance.windowHeight-a:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.state.translationX+"px"})\n                        translateY(${this.state.translationY+"px"})`};return o.a.createElement("div",{className:this.props.className,style:this.props.draggable?e:void 0,ref:this.callViewWrapper,onDoubleClick:this.props.onDoubleClick},o.a.createElement(o.a.Fragment,null,this.props.children({onStartMoving:this.onStartMoving,onResize:this.onResize})))}})||d},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(88),c=s(90),l=s(399),d=s(113),h=s(93),u=s(91),m=s.n(u),p=s(84),g=s(86),v=s(557),f=s(228);let b;!function(e){e.CloseDialog="close_dialog",e.HostSignupAccountDetails="host_signup_account_details",e.HostSignupAccountDetailsRequest="host_signup_account_details_request",e.Minimize="host_signup_minimize",e.Maximize="host_signup_maximize",e.SetupComplete="setup_complete"}(b||(b={}));var y,E=s(85),S=s(1);let _=Object(E.a)("views.dialogs.HostSignupDialog")(y=class extends o.a.PureComponent{constructor(e){super(e),i()(this,"iframeRef",o.a.createRef()),i()(this,"config",void 0),i()(this,"messageHandler",async e=>{if(this.config.url.startsWith(e.origin))switch(e.data.action){case b.HostSignupAccountDetailsRequest:this.onAccountDetailsRequest();break;case b.Maximize:this.setState({minimized:!1});break;case b.Minimize:this.setState({minimized:!0});break;case b.SetupComplete:this.setState({completed:!0});break;case b.CloseDialog:return this.closeDialog()}}),i()(this,"maximizeDialog",()=>{this.setState({minimized:!1}),this.sendMessage({action:b.Maximize})}),i()(this,"minimizeDialog",()=>{this.setState({minimized:!0}),this.sendMessage({action:b.Minimize})}),i()(this,"closeDialog",async()=>(window.removeEventListener("message",this.messageHandler),l.a.destroyElement("host_signup"),v.a.instance.setHostSignupActive(!1))),i()(this,"onCloseClick",async()=>{if(this.state.completed)return this.closeDialog();c.a.createDialog(d.a,{title:Object(p.a)("Confirm abort of host creation"),description:Object(p.a)("Are you sure you wish to abort creation of the host? The process cannot be continued."),button:Object(p.a)("Abort"),onFinished:e=>{if(e)return this.closeDialog()}})}),i()(this,"sendMessage",e=>{this.iframeRef.current.contentWindow.postMessage(e,this.config.url)}),i()(this,"onAccountDetailsDialogFinished",async e=>e?this.sendAccountDetails():this.closeDialog()),i()(this,"onAccountDetailsRequest",()=>{const e=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(p.a)("Continuing temporarily allows the %(hostSignupBrand)s setup process to access your account to fetch verified email addresses. This data is not stored.",{hostSignupBrand:this.config.brand})),o.a.createElement("p",null,Object(p.a)("Learn more in our <privacyPolicyLink />, <termsOfServiceLink /> and <cookiePolicyLink />.",{},{cookiePolicyLink:()=>o.a.createElement("a",{href:this.config.cookiePolicyUrl,target:"_blank",rel:"noreferrer noopener"},Object(p.a)("Cookie Policy")),privacyPolicyLink:()=>o.a.createElement("a",{href:this.config.privacyPolicyUrl,target:"_blank",rel:"noreferrer noopener"},Object(p.a)("Privacy Policy")),termsOfServiceLink:()=>o.a.createElement("a",{href:this.config.termsOfServiceUrl,target:"_blank",rel:"noreferrer noopener"},Object(p.a)("Terms of Service"))})));c.a.createDialog(d.a,{title:Object(p.a)("You should know"),description:e,button:Object(p.a)("Continue"),onFinished:this.onAccountDetailsDialogFinished})}),this.state={completed:!1,error:null,minimized:!1},this.config=h.a.get().hostSignup}async sendAccountDetails(){const e=await g.a.get().getOpenIdToken();if(!e||!e.access_token)return S.a.warn("Failed to connect to homeserver for OpenID token."),void this.setState({completed:!0,error:Object(p.a)("Failed to connect to your homeserver. Please close this dialog and try again.")});this.sendMessage({action:b.HostSignupAccountDetails,account:{accessToken:await g.a.get().getAccessToken(),name:f.a.instance.displayName,openIdToken:e.access_token,serverName:await g.a.get().getDomain(),userLocalpart:await g.a.get().getUserIdLocalpart(),termsAccepted:!0}})}componentDidMount(){window.addEventListener("message",this.messageHandler)}componentWillUnmount(){if(v.a.instance.isHostSignupActive)return this.closeDialog()}render(){return o.a.createElement("div",{className:"mx_HostSignup_persisted"},o.a.createElement(l.a,{key:"host_signup",persistKey:"host_signup"},o.a.createElement("div",{className:m()({mx_Dialog_wrapper:!this.state.minimized})},o.a.createElement("div",{className:m()("mx_Dialog",{mx_HostSignupDialog_minimized:this.state.minimized,mx_HostSignupDialog:!this.state.minimized})},this.state.minimized&&o.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithButton"},o.a.createElement("div",{className:"mx_Dialog_title"},Object(p.a)("%(hostSignupBrand)s Setup",{hostSignupBrand:this.config.brand})),o.a.createElement(r.a,{className:"mx_HostSignup_maximize_button",onClick:this.maximizeDialog,"aria-label":Object(p.a)("Maximise dialog"),title:Object(p.a)("Maximise dialog")})),!this.state.minimized&&o.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithCancel"},o.a.createElement(r.a,{onClick:this.minimizeDialog,className:"mx_HostSignup_minimize_button","aria-label":Object(p.a)("Minimise dialog"),title:Object(p.a)("Minimise dialog")}),o.a.createElement(r.a,{onClick:this.onCloseClick,className:"mx_Dialog_cancelButton","aria-label":Object(p.a)("Close dialog"),title:Object(p.a)("Close dialog")})),this.state.error&&o.a.createElement("div",null,this.state.error),!this.state.error&&o.a.createElement("iframe",{src:this.config.url,ref:this.iframeRef,sandbox:"allow-forms allow-scripts allow-same-origin allow-popups"})))))}})||y},function(e,t,s){"use strict";s.d(t,"a",(function(){return N})),s.d(t,"b",(function(){return P}));var n=s(83),i=s.n(n),a=s(95),o=s.n(a),r=s(102),c=s.n(r),l=s(82),d=s.n(l),h=s(91),u=s.n(h),m=s(126),p=s(106);const g=(e,t)=>{let s="";if(t)for(const e of t.entries())s+=e+"/";return"mx_space_collapsed_"+(s+e)};class v{static get instance(){return v.internalInstance||(v.internalInstance=new v),v.internalInstance}setSpaceCollapsedState(e,t,s){localStorage.setItem(g(e,t),s.toString())}getSpaceCollapsedState(e,t,s){const n=localStorage.getItem(g(e,t));return n?"true"===n:s}}i()(v,"internalInstance",void 0);var f=s(192),b=s(84),y=s(291),E=s(105),S=s(98),_=s(88),w=s(264),C=s(184),O=s(195),k=s(869),R=s(111),I=s(155);const x=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","avatarSize","isNarrow","children","ContextMenuComponent"],T=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],j=["tabIndex"],N=e=>{let{space:t,spaceKey:s,className:n,selected:i,label:a,contextMenuTooltip:r,notificationState:l,avatarSize:h,isNarrow:g,children:v,ContextMenuComponent:S}=e,_=c()(e,x);const[w,C,O,k]=Object(E.p)(),[T,j,N]=Object(I.f)(C),P=j?0:-1;let D,M,A=d.a.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},d.a.createElement("div",{className:"mx_SpaceButton_icon"}));if(t&&(A=d.a.createElement(m.a,{width:h,height:h,room:t})),l){let e=Object(b.a)("Jump to first unread room.");"invite"===(null==t?void 0:t.getMyMembership())&&(e=Object(b.a)("Jump to first invite.")),D=d.a.createElement("div",{className:"mx_SpacePanel_badgeContainer"},d.a.createElement(f.a,{onClick:()=>p.a.instance.setActiveRoomInSpace(null!=s?s:t.roomId),forceCount:!1,notification:l,"aria-label":e,tabIndex:P,showUnsentTooltip:!0}))}var U;w&&S&&(M=d.a.createElement(S,o()({},Object(E.o)(null===(U=N.current)||void 0===U?void 0:U.getBoundingClientRect(),0),{space:t,onFinished:k})));return d.a.createElement(R.a,o()({},_,{className:u()("mx_SpaceButton",n,{mx_SpaceButton_active:i,mx_SpaceButton_hasMenuOpen:w,mx_SpaceButton_narrow:g}),title:a,onClick:s?()=>p.a.instance.setActiveSpace(s):_.onClick,onContextMenu:O,forceHide:!g||w,inputRef:N,tabIndex:P,onFocus:T}),v,d.a.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},d.a.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},A,D),!g&&d.a.createElement("span",{className:"mx_SpaceButton_name"},a),S&&d.a.createElement(y.a,{className:"mx_SpaceButton_menuButton",onClick:O,title:r,isExpanded:w}),M))};class P extends d.a.PureComponent{constructor(e){super(e),i()(this,"buttonRef",Object(l.createRef)()),i()(this,"onSpaceUpdate",()=>{this.setState({childSpaces:this.childSpaces})}),i()(this,"toggleCollapse",e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;v.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()}),i()(this,"onKeyDown",e=>{var t;let s=!0;const n=Object(O.f)().getRoomListAction(e),i=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(n){case O.e.CollapseSection:if(i&&!this.isCollapsed)this.toggleCollapse(e);else{var a,o,r;const e=null===(a=this.buttonRef)||void 0===a||null===(o=a.current)||void 0===o||null===(r=o.parentElement)||void 0===r?void 0:r.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case O.e.ExpandSection:if(i)if(this.isCollapsed)this.toggleCollapse(e);else{var c,l,d;const e=null===(c=this.buttonRef)||void 0===c||null===(l=c.current)||void 0===l?void 0:l.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(d=t.querySelector(".mx_SpaceButton"))||void 0===d||d.focus()}break;default:s=!1}s&&(e.stopPropagation(),e.preventDefault())}),i()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.instance.setActiveSpace(this.props.space.roomId)});const t=v.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={collapsed:t,childSpaces:this.childSpaces},p.a.instance.on(this.props.space.roomId,this.onSpaceUpdate)}componentWillUnmount(){p.a.instance.off(this.props.space.roomId,this.onSpaceUpdate)}get childSpaces(){return p.a.instance.getChildSpaces(this.props.space.roomId).filter(e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))})}get isCollapsed(){return this.state.collapsed||this.props.isPanelCollapsed}render(){var e,t;const s=this.props,{space:n,activeSpaces:i,isNested:a,isPanelCollapsed:r,onExpand:l,parents:h,innerRef:m,dragHandleProps:g}=s,v=c()(s,T),f=this.isCollapsed,y=u()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:r,collapsed:f,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),E="invite"===n.getMyMembership(),S=E?w.a.forSymbol("!",C.a.Red):p.a.instance.getNotificationState(n.roomId),O=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let R;O&&!f&&(R=d.a.createElement(D,{spaces:this.state.childSpaces,activeSpaces:i,isNested:!0,parents:new Set(h).add(n.roomId)}));const I=O?d.a.createElement(_.a,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":f?Object(b.a)("Expand"):Object(b.a)("Collapse")}):null,x=g||{},{tabIndex:P}=x,M=c()(x,j);return d.a.createElement("li",o()({},v,{className:y,ref:m,"aria-expanded":O?!f:void 0,role:"treeitem"}),d.a.createElement(N,o()({},M,{space:n,className:E?"mx_SpaceButton_invite":void 0,selected:i.includes(n.roomId),label:n.name,contextMenuTooltip:Object(b.a)("Space options"),notificationState:S,isNarrow:r,avatarSize:a?24:32,onClick:this.onClick,onKeyDown:this.onKeyDown,ContextMenuComponent:"join"===this.props.space.getMyMembership()?k.a:void 0}),I),R)}}i()(P,"contextType",S.a);const D=({spaces:e,activeSpaces:t,isNested:s,parents:n})=>d.a.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},e.map(e=>d.a.createElement(P,{key:e.roomId,activeSpaces:t,space:e,isNested:s,parents:n})));t.c=D},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(86),c=s(84);function l(e,t=[]){const s=[],n=Object.keys(e.currentState.members);for(let i=0;i<n.length;++i){const a=n[i];e.currentState.members[a].typing&&-1===t.indexOf(a)&&s.push(e.currentState.members[a])}return s}var d,h,u,m=s(274),p=s(142),g=s(85),v=s(143);let f=Object(g.a)("views.rooms.WhoIsTypingTile")((u=h=class e extends o.a.Component{constructor(...t){var s;super(...t),i()(this,"state",{usersTyping:(s=this.props.room,l(s,[r.a.get().getUserId()])),delayedStopTypingTimers:{}}),i()(this,"isVisible",()=>e.isVisible(this.state)),i()(this,"onRoomTimeline",(e,t)=>{var s;if((null==t?void 0:t.roomId)===(null===(s=this.props.room)||void 0===s?void 0:s.roomId)){const t=e.getSender(),s=this.state.usersTyping.filter(e=>e.userId!==t);s.length!==this.state.usersTyping.length&&this.setState({usersTyping:s}),this.abortUserTimer(t)}}),i()(this,"onRoomMemberTyping",()=>{const e=function(e){return l(e,[r.a.get().getUserId()].concat(r.a.get().getIgnoredUsers()))}(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})})}componentDidMount(){r.a.get().on("RoomMember.typing",this.onRoomMemberTyping),r.a.get().on("Room.timeline",this.onRoomTimeline)}componentDidUpdate(t,s){const n=e.isVisible(s),i=e.isVisible(this.state);this.props.onShown&&!n&&i?this.props.onShown():this.props.onHidden&&n&&!i&&this.props.onHidden()}componentWillUnmount(){const e=r.a.get();e&&(e.removeListener("RoomMember.typing",this.onRoomMemberTyping),e.removeListener("Room.timeline",this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach(e=>e.abort())}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter(t=>!e.some(e=>t.userId===e.userId)),s=e.filter(e=>!this.state.usersTyping.some(t=>e.userId===t.userId));s.forEach(e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()});let n=Object.assign({},this.state.delayedStopTypingTimers);return n=s.reduce((e,t)=>(delete e[t.userId],e),n),n=t.reduce((e,t)=>{if(!e[t.userId]){const s=new m.a(5e3);e[t.userId]=s,s.start(),s.finished().then(()=>this.removeUserTimer(t.userId),()=>{})}return e},n),n}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let s=0;e.length>t&&(s=e.length-t+1,e=e.slice(0,t-1));const n=e.map(e=>o.a.createElement(p.a,{key:e.userId,member:e,width:24,height:24,resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"}));return s>0&&n.push(o.a.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",s)),n}render(){let e=this.state.usersTyping;const t=Object.keys(this.state.delayedStopTypingTimers).map(e=>this.props.room.getMember(e));e=e.concat(t),e.sort((e,t)=>Object(v.a)(e.name,t.name));const s=function(e,t){let s=0;if(e.length>t&&(s=e.length-t+1),0===e.length)return"";if(1===e.length)return Object(c.a)("%(displayName)s is typing …",{displayName:e[0].name});const n=e.map(e=>e.name);if(s>=1)return Object(c.a)("%(names)s and %(count)s others are typing …",{names:n.slice(0,t-1).join(", "),count:s});{const e=n.pop();return Object(c.a)("%(names)s and %(lastPerson)s are typing …",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return s?o.a.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},o.a.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),o.a.createElement("div",{className:"mx_WhoIsTypingTile_label"},s)):null}},i()(h,"defaultProps",{whoIsTypingLimit:3}),d=u))||d},function(e,t,s){"use strict";s.d(t,"a",(function(){return ge}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(94),c=s(127),l=s(98),d=s(126),h=s(84),u=s(88),m=s(219),p=s(386),g=s(145),v=s(159),f=s(566),b=s(141),y=s(101),E=s(135),S=s(160),_=s(231),w=s(87),C=s(92),O=s(330),k=s(277),R=s(331),I=s(244),x=s(122);const T=(e,t)=>{const[s,n]=Object(a.useState)(()=>Array.isArray(t)?t:new Array(e).fill(t));return[s,(e,t)=>n(s=>{const n=[...s];return n[e]=t,n})]};var j,N=s(539),P=s(186),D=s(1041),M=s(142),A=s(106),U=s(941),L=s(273),F=s(105),B=s(168),V=s(111),K=s(326),W=s(158),G=s(191),H=s(300),q=s(299),$=s(259),z=s(96),J=s(320),Y=s(321),Q=s(482),X=s(1),Z=s(221),ee=s(115);!function(e){e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms"}(j||(j={}));const te=({room:e,children:t})=>{const s=Object(f.b)(e).length;return t?t(s):s},se=e=>{const[t,s]=Object(a.useState)(e.getMyMembership());return Object(E.a)(e,"Room.myMembership",()=>{s(e.getMyMembership())}),t},ne=({space:e})=>{const t=Object($.a)(async()=>{if("invite"===e.getMyMembership())try{return e.client.getRoomSummary(e.roomId)}catch(e){return null}},[e]),s=Object(Q.a)(e,e=>e.getJoinRule()),n=se(e);let i,a;return i="public"===s?o.a.createElement("span",{className:"mx_SpaceRoomView_info_public"},Object(h.a)("Public space")):o.a.createElement("span",{className:"mx_SpaceRoomView_info_private"},Object(h.a)("Private space")),"invite"===n&&t?a=o.a.createElement("span",{className:"mx_SpaceRoomView_info_memberCount"},Object(h.a)("%(count)s members",{count:t.num_joined_members})):void 0!==t&&(a=o.a.createElement(te,{room:e},t=>t>0?o.a.createElement(u.a,{kind:"link",className:"mx_SpaceRoomView_info_memberCount",onClick:()=>{w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.RoomMemberList,refireParams:{space:e}})}},Object(h.a)("%(count)s members",{count:t})):null)),o.a.createElement("div",{className:"mx_SpaceRoomView_info"},i,a)},ie=()=>{w.a.dispatch({action:C.a.ViewUserSettings,initialTabId:W.a.Preferences})},ae=({groupId:e})=>{const t=Object(a.useContext)(l.a),s=Object($.a)(()=>t.getGroupSummary(e),[t,e]);return s?o.a.createElement(o.a.Fragment,null,o.a.createElement(J.a,{groupId:e,groupName:s.profile.name,groupAvatarUrl:s.profile.avatar_url,width:16,height:16,resizeMethod:"crop"}),s.profile.name):o.a.createElement(z.a,null)},oe=({space:e,onJoinButtonClicked:t,onRejectButtonClicked:s})=>{var n;const i=Object(a.useContext)(l.a),v=se(e);Object(Y.a)(w.a,t=>{t.action===C.a.JoinRoomError&&t.roomId===e.roomId&&b(!1)});const[f,b]=Object(a.useState)(!1),y=A.a.spacesEnabled,E=Object(Q.a)(e,e=>e.getJoinRule()),S=Object(G.b)(v)===G.a.Leave&&E!==c.c.Public;let _,O,k,R;if("join"===v)O=o.a.createElement(u.a,{kind:"danger_outline",onClick:()=>{w.a.dispatch({action:"leave_room",room_id:e.roomId})}},Object(h.a)("Leave"));else if("invite"===v){var I,x;const n=null===(I=e.getMember(i.getUserId()))||void 0===I||null===(x=I.events.member)||void 0===x?void 0:x.getSender(),a=n&&e.getMember(n);n&&(_=o.a.createElement("div",{className:"mx_SpaceRoomView_preview_inviter"},o.a.createElement(M.a,{member:a,fallbackUserId:n,width:32,height:32}),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SpaceRoomView_preview_inviter_name"},Object(h.a)("<inviter/> invites you",{},{inviter:()=>o.a.createElement("b",null,(null==a?void 0:a.name)||n)})),a?o.a.createElement("div",{className:"mx_SpaceRoomView_preview_inviter_mxid"},n):null))),O=o.a.createElement(o.a.Fragment,null,o.a.createElement(u.a,{kind:"secondary",onClick:()=>{b(!0),s()}},Object(h.a)("Reject")),o.a.createElement(u.a,{kind:"primary",onClick:()=>{b(!0),t()},disabled:!y},Object(h.a)("Accept")))}else O=o.a.createElement(u.a,{kind:"primary",onClick:()=>{t(),i.isGuest()||b(!0)},disabled:!y||S},Object(h.a)("Join"));f&&(O=o.a.createElement(g.a,null)),y?S&&(k=o.a.createElement("div",{className:"mx_SpaceRoomView_preview_spaceBetaPrompt"},Object(h.a)("To view %(spaceName)s, you need an invite",{spaceName:e.name}))):k=o.a.createElement("div",{className:"mx_SpaceRoomView_preview_spaceBetaPrompt"},"join"===v?Object(h.a)("To view this Space, hide communities in your <a>preferences</a>",{},{a:e=>o.a.createElement(u.a,{onClick:ie,kind:"link"},e)}):Object(h.a)("To join this Space, hide communities in your <a>preferences</a>",{},{a:e=>o.a.createElement(u.a,{onClick:ie,kind:"link"},e)}));const T=null===(n=e.currentState.getStateEvents(r.a.RoomCreate,""))||void 0===n?void 0:n.getContent();return T[q.a]&&(R=o.a.createElement("div",{className:"mx_SpaceRoomView_preview_migratedCommunity"},Object(h.a)("Created from <Community />",{},{Community:()=>o.a.createElement(ae,{groupId:T[q.a]})}))),o.a.createElement("div",{className:"mx_SpaceRoomView_preview"},R,_,o.a.createElement(d.a,{room:e,height:80,width:80,viewAvatarOnClick:!0}),o.a.createElement("h1",{className:"mx_SpaceRoomView_preview_name"},o.a.createElement(m.a,{room:e})),o.a.createElement(ne,{space:e}),o.a.createElement(p.a,{room:e},(e,t)=>o.a.createElement("div",{className:"mx_SpaceRoomView_preview_topic",ref:t},e)),"public"===e.getJoinRule()&&o.a.createElement(U.a,{room:e}),o.a.createElement("div",{className:"mx_SpaceRoomView_preview_joinButtons"},O),k)},re=({space:e})=>{const[t,s,n,i]=Object(F.p)();let a;if(t){const t=s.current.getBoundingClientRect();a=o.a.createElement(B.e,{left:t.left+window.pageXOffset+0,top:t.bottom+window.pageYOffset+8,chevronFace:F.a.None,onFinished:i,className:"mx_RoomTile_contextMenu",compact:!0},o.a.createElement(B.c,{first:!0},o.a.createElement(B.b,{label:Object(h.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:async t=>{t.preventDefault(),t.stopPropagation(),i(),await Object(P.g)(e)&&w.a.fire(C.a.UpdateSpaceHierarchy)}}),o.a.createElement(B.b,{label:Object(h.a)("Add existing room"),iconClassName:"mx_RoomList_iconHash",onClick:t=>{t.preventDefault(),t.stopPropagation(),i(),Object(P.f)(e)}}),o.a.createElement(B.b,{label:Object(h.a)("Add space"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),i(),Object(P.h)(e)}},o.a.createElement(K.a,null))))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(F.b,{kind:"primary",inputRef:s,onClick:n,isExpanded:t,label:Object(h.a)("Add")},Object(h.a)("Add")),a)},ce=({space:e})=>{const t=Object(a.useContext)(l.a),s=se(e),n=t.getUserId();let i;("join"===s&&e.canInvite(n)||e.getJoinRule()===c.c.Public)&&Object(Z.a)(ee.a.InviteUsers)&&(i=o.a.createElement(u.a,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{Object(P.i)(e)}},Object(h.a)("Invite")));let g,v;"join"===s&&e.currentState.maySendStateEvent(r.a.SpaceChild,n)&&(g=o.a.createElement(re,{space:e})),Object(P.e)(e)&&(v=o.a.createElement(V.a,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{Object(P.j)(e)},title:Object(h.a)("Settings")}));return o.a.createElement("div",{className:"mx_SpaceRoomView_landing"},o.a.createElement(H.b,null),o.a.createElement(d.a,{room:e,height:80,width:80,viewAvatarOnClick:!0}),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_name"},o.a.createElement(m.a,{room:e},e=>{const t={name:()=>o.a.createElement("div",{className:"mx_SpaceRoomView_landing_nameRow"},o.a.createElement("h1",null,e))};return Object(h.a)("Welcome to <name/>",{},t)})),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_info"},o.a.createElement(ne,{space:e}),o.a.createElement(U.a,{room:e,onlyKnownUsers:!1,numShown:7,onClick:()=>{w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.RoomMemberList,refireParams:{space:e}})}}),i,v),o.a.createElement(p.a,{room:e},(e,t)=>o.a.createElement("div",{className:"mx_SpaceRoomView_landing_topic",ref:t},e)),o.a.createElement(D.a,{space:e,showRoom:D.b,additionalButtons:g}))},le=({space:e,title:t,description:s,onFinished:n})=>{const[i,r]=Object(a.useState)(!1),[l,d]=Object(a.useState)(""),m=[Object(h.a)("General"),Object(h.a)("Random"),Object(h.a)("Support")],[p,g]=T(3,[Object(h.a)("General"),Object(h.a)("Random"),""]),v=new Array(3).fill(0).map((e,t)=>{const s="roomName"+t;return o.a.createElement(y.a,{key:s,name:s,type:"text",label:Object(h.a)("Room name"),placeholder:m[t],value:p[t],onChange:e=>g(t,e.target.value),autoFocus:2===t,disabled:i,autoComplete:"off"})}),f=async t=>{if(t.preventDefault(),!i){d(""),r(!0);try{const t=e.getJoinRule()===c.c.Public,s=p.map(e=>e.trim()).filter(Boolean),i=await Promise.all(s.map(s=>Object(b.b)({createOpts:{preset:t?c.d.PublicChat:c.d.PrivateChat,name:s},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:e,joinRule:t?void 0:c.c.Restricted,suggested:!0})));n(i[0])}catch(e){X.a.error("Failed to create initial space rooms",e),d(Object(h.a)("Failed to create initial space rooms"))}r(!1)}};let E=e=>{e.preventDefault(),n()},S=Object(h.a)("Skip for now");return p.some(e=>e.trim())&&(E=f,S=i?Object(h.a)("Creating rooms..."):Object(h.a)("Continue")),o.a.createElement("div",null,o.a.createElement("h1",null,t),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},s),l&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},l),o.a.createElement("form",{onSubmit:E,id:"mx_SpaceSetupFirstRooms"},v),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(u.a,{kind:"primary",disabled:i,onClick:E,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:S})))},de=({space:e,onFinished:t})=>o.a.createElement("div",null,o.a.createElement("h1",null,Object(h.a)("What do you want to organise?")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(h.a)("Pick rooms or conversations to add. This is just a space for you, no one will be informed. You can add more later.")),o.a.createElement(L.a,{space:e,emptySelectionButton:o.a.createElement(u.a,{kind:"primary",onClick:t},Object(h.a)("Skip for now")),filterPlaceholder:Object(h.a)("Search for rooms or spaces"),onFinished:t,roomsRenderer:L.f,spacesRenderer:L.g,dmsRenderer:L.e})),he=({justCreatedOpts:e,space:t,onFinished:s,firstRoomId:n})=>{var i;return o.a.createElement("div",{className:"mx_SpaceRoomView_publicShare"},o.a.createElement("h1",null,Object(h.a)("Share %(name)s",{name:(null==e||null===(i=e.createOpts)||void 0===i?void 0:i.name)||t.name})),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(h.a)("It's just you at the moment, it will be even better with others.")),o.a.createElement(N.a,{space:t}),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(u.a,{kind:"primary",onClick:s},n?Object(h.a)("Go to my first room"):Object(h.a)("Go to my space"))))},ue=({space:e,justCreatedOpts:t,onFinished:s})=>{var n;return o.a.createElement("div",{className:"mx_SpaceRoomView_privateScope"},o.a.createElement("h1",null,Object(h.a)("Who are you working with?")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(h.a)("Make sure the right people have access to %(name)s",{name:(null==t||null===(n=t.createOpts)||void 0===n?void 0:n.name)||e.name})),o.a.createElement(u.a,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{s(!1)}},o.a.createElement("h3",null,Object(h.a)("Just me")),o.a.createElement("div",null,Object(h.a)("A private space to organise your rooms"))),o.a.createElement(u.a,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{s(!0)}},o.a.createElement("h3",null,Object(h.a)("Me and my teammates")),o.a.createElement("div",null,Object(h.a)("A private space for you and your teammates"))))},me=Object(S.a)({rules:[{key:"email",test:({value:e})=>!e||_.a(e),invalid:()=>Object(h.a)("Doesn't look like a valid email address")}]}),pe=({space:e,onFinished:t})=>{const[s,n]=Object(a.useState)(!1),[i,r]=Object(a.useState)(""),c=[Object(a.useRef)(),Object(a.useRef)(),Object(a.useRef)()],[l,d]=T(3,""),m=new Array(3).fill(0).map((e,t)=>{const n="emailAddress"+t;return o.a.createElement(y.a,{key:n,name:n,type:"text",label:Object(h.a)("Email address"),placeholder:Object(h.a)("Email"),value:l[t],onChange:e=>d(t,e.target.value),ref:c[t],onValidate:me,autoFocus:0===t,disabled:s})}),p=async i=>{if(i.preventDefault(),s)return;r("");for(let e=0;e<c.length;e++){const t=c[e];if(!1===await t.current.validate({allowEmpty:!0}))return t.current.focus(),void t.current.validate({allowEmpty:!0,focused:!0})}n(!0);const a=l.map(e=>e.trim()).filter(Boolean);try{const s=await Object(v.a)(e.roomId,a),n=Object.keys(s.states).filter(e=>"error"===s.states[e]);n.length>0?(X.a.log("Failed to invite users to space: ",s),r(Object(h.a)("Failed to invite the following users to your space: %(csvUsers)s",{csvUsers:n.join(", ")}))):t()}catch(e){X.a.error("Failed to invite users to space: ",e),r(Object(h.a)("We couldn't invite those users. Please check the users you want to invite and try again."))}n(!1)};let g=e=>{e.preventDefault(),t()},f=Object(h.a)("Skip for now");return l.some(e=>e.trim())&&(g=p,f=s?Object(h.a)("Inviting..."):Object(h.a)("Continue")),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},o.a.createElement("h1",null,Object(h.a)("Invite your teammates")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(h.a)("Make sure the right people have access. You can invite more later.")),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_betaDisclaimer"},Object(h.a)("<b>This is an experimental feature.</b> For now, new users receiving an invite will have to open the invite on <link/> to actually join.",{},{b:e=>o.a.createElement("b",null,e),link:()=>o.a.createElement("a",{href:"https://app.element.io/",rel:"noreferrer noopener",target:"_blank"},"app.element.io")})),i&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},i),o.a.createElement("form",{onSubmit:g,id:"mx_SpaceSetupPrivateInvite"},m),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},o.a.createElement(u.a,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>Object(v.g)(e.roomId)},Object(h.a)("Invite by username"))),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(u.a,{kind:"primary",disabled:s,onClick:g,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:f})))};class ge extends o.a.PureComponent{constructor(e,t){var s;super(e,t),i()(this,"creator",void 0),i()(this,"dispatcherRef",void 0),i()(this,"rightPanelStoreToken",void 0),i()(this,"onMyMembership",(e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})}),i()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:I.a.getSharedInstance().isOpenForRoom})}),i()(this,"onAction",e=>{"view_room"!==e.action||e.room_id!==this.props.space.roomId?e.action!==C.a.ViewUser&&"view_3pid_invite"!==e.action||(e.action===C.a.ViewUser&&e.member?w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.SpaceMemberInfo,refireParams:{space:this.props.space,member:e.member}}):"view_3pid_invite"===e.action&&e.event?w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.Space3pidMemberInfo,refireParams:{space:this.props.space,event:e.event}}):w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.SpaceMemberList,refireParams:{space:this.props.space}})):this.setState({phase:j.Landing})}),i()(this,"goToFirstRoom",async()=>{this.state.firstRoomId?w.a.dispatch({action:"view_room",room_id:this.state.firstRoomId}):this.setState({phase:j.Landing})});let n=j.Landing;this.creator=null===(s=this.props.space.currentState.getStateEvents(r.a.RoomCreate,""))||void 0===s?void 0:s.getSender();this.props.justCreatedOpts&&this.context.getUserId()===this.creator&&(n=this.props.justCreatedOpts.createOpts.preset===c.d.PublicChat?j.PublicCreateRooms:j.PrivateScope),this.state={phase:n,showRightPanel:I.a.getSharedInstance().isOpenForRoom,myMembership:this.props.space.getMyMembership()},this.dispatcherRef=w.a.register(this.onAction),this.rightPanelStoreToken=I.a.getSharedInstance().addListener(this.onRightPanelStoreUpdate),this.context.on("Room.myMembership",this.onMyMembership)}componentWillUnmount(){w.a.unregister(this.dispatcherRef),this.rightPanelStoreToken.remove(),this.context.off("Room.myMembership",this.onMyMembership)}renderBody(){var e,t;switch(this.state.phase){case j.Landing:return"join"===this.state.myMembership&&A.a.spacesEnabled?o.a.createElement(ce,{space:this.props.space}):o.a.createElement(oe,{space:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case j.PublicCreateRooms:return o.a.createElement(le,{space:this.props.space,title:Object(h.a)("What are some things you want to discuss in %(spaceName)s?",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(t=e.createOpts)||void 0===t?void 0:t.name)||this.props.space.name}),description:Object(h.a)("Let's create a room for each of them.")+"\n"+Object(h.a)("You can add more later too, including already existing ones."),onFinished:e=>this.setState({phase:j.PublicShare,firstRoomId:e})});case j.PublicShare:return o.a.createElement(he,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case j.PrivateScope:return o.a.createElement(ue,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?j.PrivateCreateRooms:j.PrivateExistingRooms})}});case j.PrivateInvite:return o.a.createElement(pe,{space:this.props.space,onFinished:()=>this.setState({phase:j.Landing})});case j.PrivateCreateRooms:return o.a.createElement(le,{space:this.props.space,title:Object(h.a)("What projects are your team working on?"),description:Object(h.a)("We'll create rooms for each of them. You can add more later too, including already existing ones."),onFinished:e=>this.setState({phase:j.PrivateInvite,firstRoomId:e})});case j.PrivateExistingRooms:return o.a.createElement(de,{space:this.props.space,onFinished:()=>this.setState({phase:j.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===j.Landing?o.a.createElement(R.a,{room:this.props.space,resizeNotifier:this.props.resizeNotifier}):null;return o.a.createElement("main",{className:"mx_SpaceRoomView"},o.a.createElement(k.a,null,o.a.createElement(O.a,{panel:e,resizeNotifier:this.props.resizeNotifier},this.renderBody())))}}i()(ge,"contextType",l.a)},function(e,t,s){"use strict";s.d(t,"b",(function(){return G}));var n=s(95),i=s.n(n),a=s(83),o=s.n(a),r=s(82),c=s.n(r),l=s(99),d=s.n(l),h=s(94);class u{constructor(e,t,s,n=!1){this.root=e,this.pageSize=t,this.maxDepth=s,this.suggestedOnly=n,d()(this,"viaMap",new Map),d()(this,"backRefs",new Map),d()(this,"roomMap",new Map),d()(this,"loadRequest",void 0),d()(this,"nextBatch",void 0),d()(this,"_rooms",void 0),d()(this,"serverSupportError",void 0)}get noSupport(){return!!this.serverSupportError}get canLoadMore(){return!!this.serverSupportError||!!this.nextBatch||!this._rooms}get loading(){return!!this.loadRequest}get rooms(){return this._rooms}async load(e=this.pageSize){if(this.loadRequest)return this.loadRequest.then(e=>e.rooms);let t;this.loadRequest=this.root.client.getRoomHierarchy(this.root.roomId,e,this.maxDepth,this.suggestedOnly,this.nextBatch);try{({rooms:t,next_batch:this.nextBatch}=await this.loadRequest)}catch(e){if("M_UNRECOGNIZED"!==e.errcode)throw e;return this.serverSupportError=e,[]}finally{this.loadRequest=null}return this._rooms?this._rooms=this._rooms.concat(t):this._rooms=t,t.forEach(e=>{this.roomMap.set(e.room_id,e),e.children_state.forEach(e=>{if(e.type!==h.a.SpaceChild)return;const t=e.state_key;if(this.backRefs.has(t)||this.backRefs.set(t,[]),this.backRefs.get(t).push(e.room_id),Array.isArray(e.content.via)){this.viaMap.has(t)||this.viaMap.set(t,new Set);const s=this.viaMap.get(t);e.content.via.forEach(e=>s.add(e))}})}),t}getRelation(e,t){var s;return null===(s=this.roomMap.get(e))||void 0===s?void 0:s.children_state.find(e=>e.state_key===t)}isSuggested(e,t){var s;return null===(s=this.getRelation(e,t))||void 0===s?void 0:s.content.suggested}removeRelation(e,t){const s=this.backRefs.get(t);1===(null==s?void 0:s.length)?this.backRefs.delete(t):null!=s&&s.length&&this.backRefs.set(t,s.filter(t=>t!==e));const n=this.roomMap.get(e);n&&(n.children_state=n.children_state.filter(e=>e.state_key!==t))}}var m=s(91),p=s.n(m),g=s(112),v=s(127),f=s(87),b=s(84),y=s(88),E=s(96),S=s(237),_=s(126),w=s(137),C=s(125),O=s(103),k=s(396),R=s(177),I=s(387),x=s(106),T=s(111),j=s(138),N=s(321),P=s(92),D=s(108),M=s(155),A=s(549),U=s(98),L=s(135),F=s(388),B=s(132);function V(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function K(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?V(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):V(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const W=({room:e,suggested:t,selected:s,hasPermissions:n,onToggleClick:i,onViewRoomClick:a,onJoinRoomClick:o,numChildRooms:l,children:d})=>{var u,m,g,v;const f=Object(r.useContext)(U.a),[S,x]=Object(r.useState)(()=>{const t=f.getRoom(e.room_id);return"join"===(null==t?void 0:t.getMyMembership())?t:null}),N=Object(L.b)(S,"Room.name",e=>null==e?void 0:e.name)||e.name||e.canonical_alias||(null===(u=e.aliases)||void 0===u?void 0:u[0])||(e.room_type===h.e.Space?Object(b.a)("Unnamed Space"):Object(b.a)("Unnamed Room")),[P,A]=Object(I.a)(!0),[B,V,K]=Object(M.f)(),[W,G]=Object(r.useState)(!1),H=e=>{e.preventDefault(),e.stopPropagation(),a()},q=async t=>{G(!0),t.preventDefault(),t.stopPropagation(),o().then(()=>Object(F.a)(f,e.room_id)).then(x).finally(()=>{G(!1)})};let $,z,J;$=W?c.a.createElement(T.a,{disabled:!0,onClick:q,kind:"primary_outline",onFocus:B,tabIndex:V?0:-1,title:Object(b.a)("Joining")},c.a.createElement(E.a,{w:24,h:24})):S?c.a.createElement(y.a,{onClick:H,kind:"primary_outline",onFocus:B,tabIndex:V?0:-1},Object(b.a)("View")):c.a.createElement(y.a,{onClick:q,kind:"primary",onFocus:B,tabIndex:V?0:-1},Object(b.a)("Join")),i&&(z=n?c.a.createElement(w.b,{checked:!!s,onChange:i,tabIndex:V?0:-1}):c.a.createElement(R.a,{tooltip:Object(b.a)("You don't have permission"),onClick:e=>{e.stopPropagation()}},c.a.createElement(w.b,{disabled:!0,tabIndex:V?0:-1}))),J=S?c.a.createElement(_.a,{room:S,width:20,height:20}):c.a.createElement(C.a,{name:N,idName:e.room_id,url:e.avatar_url?Object(O.b)(e.avatar_url).getSquareThumbnailHttp(20):null,width:20,height:20});let Y=Object(b.a)("%(count)s members",{count:e.num_joined_members});void 0!==l&&(Y+=" · "+Object(b.a)("%(count)s rooms",{count:l}));const Q=(null==S||null===(m=S.currentState)||void 0===m||null===(g=m.getStateEvents(h.a.RoomTopic,""))||void 0===g||null===(v=g.getContent())||void 0===v?void 0:v.topic)||e.topic;let X,Z;Q&&(Y+=" · "+Q),S&&(X=c.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},Object(b.a)("Joined"))),!t||S&&!n||(Z=c.a.createElement(k.b,{tooltip:Object(b.a)("This room is suggested as a good one to join")},Object(b.a)("Suggested")));const ee=c.a.createElement(c.a.Fragment,null,J,c.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},N,X,Z),c.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info",ref:e=>e&&Object(j.g)(e),onClick:e=>{"A"===e.target.tagName&&e.stopPropagation()}},Y),c.a.createElement("div",{className:"mx_SpaceHierarchy_actions"},$,z));let te,se,ne;if(d){if(te=c.a.createElement("div",{className:p()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:P}),onClick:e=>{e.stopPropagation(),A()}}),P){const e=e=>{var t;e.key===D.a.ARROW_LEFT&&(e.preventDefault(),e.stopPropagation(),null===(t=K.current)||void 0===t||t.focus())};se=c.a.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},d)}ne=e=>{let t=!1;switch(e.key){case D.a.ARROW_LEFT:P&&(t=!0,A());break;case D.a.ARROW_RIGHT:if(t=!0,P){var s,n;const e=null===(s=K.current)||void 0===s?void 0:s.nextElementSibling;null==e||null===(n=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===n||n.focus()}else A()}t&&(e.preventDefault(),e.stopPropagation())}}return c.a.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-expanded":d?P:void 0},c.a.createElement(y.a,{className:p()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:e.room_type===h.e.Space,mx_SpaceHierarchy_joining:W}),onClick:n&&i?i:H,onKeyDown:ne,inputRef:K,onFocus:B,tabIndex:V?0:-1},ee,te),se)},G=(e,t,s,n)=>{const i=t.roomMap.get(s);if(e.isGuest()&&!i.world_readable&&!i.guest_can_join)return void f.a.dispatch({action:"require_registration"});const a=Object(A.b)(i)||void 0;f.a.dispatch({action:"view_room",should_peek:!0,_type:"room_directory",room_alias:a,room_id:i.room_id,via_servers:Array.from(t.viaMap.get(s)||[]),oob_data:{avatarUrl:i.avatar_url,name:i.name||a||Object(b.a)("Unnamed room"),roomType:n}})},H=({root:e,roomSet:t,hierarchy:s,parents:n,selectedMap:i,onViewRoomClick:a,onJoinRoomClick:o,onToggleClick:l})=>{const d=Object(r.useContext)(U.a),u=d.getRoom(e.room_id),m=null==u?void 0:u.currentState.maySendStateEvent(h.a.SpaceChild,d.getUserId()),p=Object(g.sortBy)(e.children_state,e=>Object(x.b)(e.content.order,e.origin_server_ts,e.state_key)),[f,b]=p.reduce((e,n)=>{const i=s.roomMap.get(n.state_key);return i&&t.has(i)&&e[i.room_type===h.e.Space?0:1].push(((e,t)=>{const s=e.getRoomUpgradeHistory(t.room_id,!0),n=s[s.length-1];var i,a,o;return n?K(K({},t),{},{room_id:n.roomId,room_type:n.getType(),name:n.name,topic:null===(i=n.currentState.getStateEvents(h.a.RoomTopic,""))||void 0===i?void 0:i.getContent().topic,avatar_url:n.getMxcAvatarUrl(),canonical_alias:n.getCanonicalAlias(),aliases:n.getAltAliases(),world_readable:(null===(a=n.currentState.getStateEvents(h.a.RoomHistoryVisibility,""))||void 0===a?void 0:a.getContent().history_visibility)===v.b.WorldReadable,guest_can_join:(null===(o=n.currentState.getStateEvents(h.a.RoomGuestAccess,""))||void 0===o?void 0:o.getContent().guest_access)===v.a.CanJoin,num_joined_members:n.getJoinedMemberCount()}):t})(d,i)),e},[[],[]]),y=new Set(n).add(e.room_id);return c.a.createElement(c.a.Fragment,null,Object(g.uniqBy)(b,"room_id").map(t=>{var n;return c.a.createElement(W,{key:t.room_id,room:t,suggested:s.isSuggested(e.room_id,t.room_id),selected:null==i||null===(n=i.get(e.room_id))||void 0===n?void 0:n.has(t.room_id),onViewRoomClick:()=>a(t.room_id,t.room_type),onJoinRoomClick:()=>o(t.room_id),hasPermissions:m,onToggleClick:l?()=>l(e.room_id,t.room_id):void 0})}),f.filter(e=>!y.has(e.room_id)).map(n=>{var r;return c.a.createElement(W,{key:n.room_id,room:n,numChildRooms:n.children_state.filter(e=>{const n=s.roomMap.get(e.state_key);return n&&t.has(n)&&!n.room_type}).length,suggested:s.isSuggested(e.room_id,n.room_id),selected:null==i||null===(r=i.get(e.room_id))||void 0===r?void 0:r.has(n.room_id),onViewRoomClick:()=>a(n.room_id,h.e.Space),onJoinRoomClick:()=>o(n.room_id),hasPermissions:m,onToggleClick:l?()=>l(e.room_id,n.room_id):void 0},c.a.createElement(H,{root:n,roomSet:t,hierarchy:s,parents:y,selectedMap:i,onViewRoomClick:a,onJoinRoomClick:o,onToggleClick:l}))}))},q=({hierarchy:e,selected:t,setSelected:s,setError:n})=>{const a=Object(r.useContext)(U.a),[o,l]=Object(r.useState)(!1),[d,u]=Object(r.useState)(!1),m=Array.from(t.keys()).flatMap(e=>[...t.get(e).values()].map(t=>[e,t])),p=m.every(([t,s])=>e.isSuggested(t,s)),g=!m.length||o||d;let v=y.a,f={};return m.length||(v=T.a,f={tooltip:Object(b.a)("Select a room below first"),yOffset:-40}),c.a.createElement(c.a.Fragment,null,c.a.createElement(v,i()({},f,{onClick:async()=>{l(!0);try{const t=a.getUserId();for(const[s,n]of m){await a.sendStateEvent(s,h.a.SpaceChild,{},n);const i=a.getRoom(n),o=null==i?void 0:i.currentState.getStateEvents(h.a.SpaceParent,s);null!=i&&i.currentState.maySendStateEvent(h.a.SpaceParent,t)&&Array.isArray(null==o?void 0:o.getContent().via)&&await a.sendStateEvent(n,h.a.SpaceParent,{},s),e.removeRelation(s,n)}}catch(e){n(Object(b.a)("Failed to remove some rooms. Try again later"))}l(!1),s(new Map)},kind:"danger_outline",disabled:g}),o?Object(b.a)("Removing..."):Object(b.a)("Remove")),c.a.createElement(v,i()({},f,{onClick:async()=>{u(!0);try{for(const[s,n]of m){var t;const i=!p,o=null===(t=e.getRelation(s,n))||void 0===t?void 0:t.content;if(!o||o.suggested===i)continue;const r=K(K({},o),{},{suggested:!p});await a.sendStateEvent(s,h.a.SpaceChild,r,n),o.suggested=r.suggested}}catch(e){n("Failed to update some suggestions. Try again later")}u(!1),s(new Map)},kind:"primary_outline",disabled:g}),d?Object(b.a)("Saving..."):p?Object(b.a)("Mark as not suggested"):Object(b.a)("Mark as suggested")))};t.a=({space:e,initialText:t="",showRoom:s,additionalButtons:n})=>{const i=Object(r.useContext)(U.a),[a,o]=Object(r.useState)(t),[l,d]=Object(r.useState)(new Map),{loading:m,rooms:p,hierarchy:g,loadMore:v}=(e=>{var t;const[s,n]=Object(r.useState)([]),[i,a]=Object(r.useState)(),o=Object(r.useCallback)(()=>{const t=new u(e,20);t.load().then(()=>{e===t.root&&n(t.rooms)}),a(t)},[e]);Object(r.useEffect)(o,[o]),Object(N.a)(f.a,e=>{e.action===P.a.UpdateSpaceHierarchy&&(n([]),o())});const c=Object(r.useCallback)(async e=>{i.loading||!i.canLoadMore||i.noSupport||(await i.load(e),n(i.rooms))},[i]);return{loading:null===(t=null==i?void 0:i.loading)||void 0===t||t,rooms:s,hierarchy:i,loadMore:c}})(e),y=Object(r.useMemo)(()=>{if(null==p||!p.length)return new Set;const e=a.toLowerCase().trim();if(!e)return new Set(p);const t=p.filter(t=>{var s,n;return(null===(s=t.name)||void 0===s?void 0:s.toLowerCase().includes(e))||(null===(n=t.topic)||void 0===n?void 0:n.toLowerCase().includes(e))}),s=new Set,n=[...t.map(e=>e.room_id)];for(;n.length;){var i;const e=n.pop();s.add(e),null===(i=g.backRefs.get(e))||void 0===i||i.forEach(e=>{s.has(e)||n.push(e)})}return new Set(p.filter(e=>s.has(e.room_id)))},[p,g,a]),[_,w]=Object(r.useState)(""),C=(e=>{const t=t=>{t[0].isIntersecting&&e()},s=Object(r.useRef)();return e=>{s.current?s.current.disconnect():e&&(s.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),s.current&&e&&s.current.observe(e)}})(v);if(!m&&g.noSupport)return c.a.createElement("p",null,Object(b.a)("Your server does not support showing space hierarchies."));const O=(e,t)=>{if(w(""),!l.has(e))return void d(new Map(l.set(e,new Set([t]))));const s=l.get(e);s.has(t)?(s.delete(t),d(new Map(l.set(e,new Set(s))))):d(new Map(l.set(e,new Set([...s,t]))))};return c.a.createElement(M.c,{onKeyDown:(e,t)=>{var s,n;e.key===D.a.ARROW_DOWN&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(s=t.refs[0])||void 0===s||null===(n=s.current)||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},({onKeyDownHandler:r})=>{let u;if(m&&!p.length)u=c.a.createElement(E.a,null);else{const t="join"===(null==e?void 0:e.getMyMembership())&&e.currentState.maySendStateEvent(h.a.SpaceChild,i.getUserId());let o,m;y.size?o=c.a.createElement(c.a.Fragment,null,c.a.createElement(H,{root:g.roomMap.get(e.roomId),roomSet:y,hierarchy:g,parents:new Set,selectedMap:l,onToggleClick:t?O:void 0,onViewRoomClick:(e,t)=>s(i,g,e,t),onJoinRoomClick:e=>((e,t,s)=>{if(e.isGuest())return void f.a.dispatch({action:"require_registration"});const n=e.joinRoom(s,{viaServers:Array.from(t.viaMap.get(s)||[])});return n.catch(e=>{B.a.showJoinRoomError(e,s)}),n})(i,g,e)})):g.canLoadMore||(o=c.a.createElement("div",{className:"mx_SpaceHierarchy_noResults"},c.a.createElement("h3",null,Object(b.a)("No results found")),c.a.createElement("div",null,Object(b.a)("You may want to try a different search or check for typos.")))),g.canLoadMore&&(m=c.a.createElement("div",{ref:C},c.a.createElement(E.a,null))),u=c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},c.a.createElement("h4",null,a.trim()?Object(b.a)("Results"):Object(b.a)("Rooms and spaces")),c.a.createElement("span",null,n,t&&c.a.createElement(q,{hierarchy:g,selected:l,setSelected:d,setError:w}))),_&&c.a.createElement("div",{className:"mx_SpaceHierarchy_error"},_),c.a.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:r,role:"tree","aria-label":Object(b.a)("Space")},o),m)}return c.a.createElement(c.a.Fragment,null,c.a.createElement(S.a,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:Object(b.a)("Search names and descriptions"),onSearch:o,autoFocus:!0,initialValue:t,onKeyDown:r}),u)})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return N}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(84),c=s(90),l=s(156);class d{constructor(e,t){i()(this,"client",void 0),i()(this,"clientSecret",void 0),i()(this,"identityServerDomain",void 0),i()(this,"password",void 0),i()(this,"sessionId",void 0),this.client=Object(l.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret(),this.identityServerDomain=t?t.split("://")[1]:null}resetPassword(e,t){return this.password=t,this.client.requestPasswordEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(r.a)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password)}catch(e){throw 401===e.httpStatus?e.message=Object(r.a)("Failed to verify email address: make sure you clicked the link in the email"):404===e.httpStatus?e.message=Object(r.a)("Your email address does not appear to be associated with a Matrix ID on this Homeserver."):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}var h,u,m,p=s(280),g=s(91),v=s.n(g),f=s(218),b=s(124),y=s(404),E=s(334),S=s(278),_=s(85),w=s(405),C=s(145),O=s(1),k=s(96),R=s(113),I=s(104),x=s(335),T=s(336),j=s(581);!function(e){e[e.Forgot=1]="Forgot",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.Done=4]="Done"}(u||(u={})),function(e){e.Email="field_email",e.Password="field_password",e.PasswordConfirm="field_password_confirm"}(m||(m={}));let N=Object(_.a)("structures.auth.ForgotPassword")(h=class extends o.a.Component{constructor(e){super(e),i()(this,"reset",void 0),i()(this,"state",{phase:u.Forgot,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""}),i()(this,"onVerify",async e=>{if(e.preventDefault(),this.reset){if(!this.state.currentHttpRequest)try{await this.handleHttpRequest(this.reset.checkEmailLinkClicked()),this.setState({phase:u.Done})}catch(e){this.showErrorDialog(e.message)}}else O.a.error("onVerify called before submitPasswordReset!")}),i()(this,"onSubmitForm",async e=>{if(e.preventDefault(),this.state.currentHttpRequest)return;await this.handleHttpRequest(this.checkServerLiveliness(this.props.serverConfig));await this.verifyFieldsBeforeSubmit()&&c.a.createTrackedDialog("Forgot Password Warning","",R.a,{title:Object(r.a)("Warning!"),description:o.a.createElement("div",null,Object(r.a)("Changing your password will reset any end-to-end encryption keys on all of your sessions, making encrypted chat history unreadable. Set up Key Backup or export your room keys from another session before resetting your password.")),button:Object(r.a)("Continue"),onFinished:e=>{e&&this.submitPasswordReset(this.state.email,this.state.password)}})}),i()(this,"onInputChanged",(e,t)=>{this.setState({[e]:t.currentTarget.value})}),i()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),b.a.instance.track("onboarding_forgot_password_begin")}componentDidMount(){this.reset=null,this.checkServerLiveliness(this.props.serverConfig)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.checkServerLiveliness(e.serverConfig)}async checkServerLiveliness(e){try{await p.a.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0})}catch(e){this.setState(p.a.authComponentStateForError(e,"forgot_password"))}}submitPasswordReset(e,t){this.setState({phase:u.SendingEmail}),this.reset=new d(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.reset.resetPassword(e,t).then(()=>{this.setState({phase:u.EmailSent})},e=>{this.showErrorDialog(Object(r.a)("Failed to send email")+": "+e.message),this.setState({phase:u.Forgot})})}async verifyFieldsBeforeSubmit(){const e=[m.Email,m.Password,m.PasswordConfirm],t=[];for(const s of e){await this[s].validate({allowEmpty:!1})||t.push(this[s])}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}showErrorDialog(e,t){c.a.createTrackedDialog("Forgot Password Error","",I.a,{title:t,description:e})}handleHttpRequest(e){return this.setState({currentHttpRequest:e}),e.finally(()=>{this.setState({currentHttpRequest:void 0})})}renderForgot(){let e=null;const t=this.state.errorText;let s;if(t&&(e=o.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=v()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});s=o.a.createElement("div",{className:e},this.state.serverDeadError)}return o.a.createElement("div",null,e,s,o.a.createElement(y.a,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),o.a.createElement("form",{onSubmit:this.onSubmitForm},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(E.a,{name:"reset_email",labelRequired:Object(r.a)("The email address linked to your account must be entered."),labelInvalid:Object(r.a)("The email address doesn't appear to be valid."),value:this.state.email,fieldRef:e=>this[m.Email]=e,autoFocus:!0,onChange:this.onInputChanged.bind(this,"email"),onFocus:()=>b.a.instance.track("onboarding_forgot_password_email_focus"),onBlur:()=>b.a.instance.track("onboarding_forgot_password_email_blur")})),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(S.a,{name:"reset_password",type:"password",label:Object(r.b)("New Password"),value:this.state.password,minScore:w.a,fieldRef:e=>this[m.Password]=e,onChange:this.onInputChanged.bind(this,"password"),onFocus:()=>b.a.instance.track("onboarding_forgot_password_newPassword_focus"),onBlur:()=>b.a.instance.track("onboarding_forgot_password_newPassword_blur"),autoComplete:"new-password"}),o.a.createElement(j.a,{name:"reset_password_confirm",label:Object(r.a)("Confirm"),labelRequired:Object(r.a)("A new password must be entered."),labelInvalid:Object(r.a)("New passwords must match each other."),value:this.state.password2,password:this.state.password,fieldRef:e=>this[m.PasswordConfirm]=e,onChange:this.onInputChanged.bind(this,"password2"),onFocus:()=>b.a.instance.track("onboarding_forgot_password_newPassword2_focus"),onBlur:()=>b.a.instance.track("onboarding_forgot_password_newPassword2_blur"),autoComplete:"new-password"})),o.a.createElement("span",null,Object(r.a)("A verification email will be sent to your inbox to confirm setting your new password.")),o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(r.a)("Send Reset Email")})),o.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick,href:"#"},Object(r.a)("Sign in instead")))}renderSendingEmail(){return o.a.createElement(k.a,null)}renderEmailSent(){return o.a.createElement("div",null,Object(r.a)("An email has been sent to %(emailAddress)s. Once you've followed the link it contains, click below.",{emailAddress:this.state.email}),o.a.createElement("br",null),o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.onVerify,value:Object(r.a)("I have verified my email address")}),this.state.currentHttpRequest&&o.a.createElement("div",{className:"mx_Login_spinner"},o.a.createElement(C.a,{w:64,h:64})))}renderDone(){return o.a.createElement("div",null,o.a.createElement("p",null,Object(r.a)("Your password has been reset.")),o.a.createElement("p",null,Object(r.a)("You have been logged out of all sessions and will no longer receive push notifications. To re-enable notifications, sign in again on each device.")),o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:Object(r.a)("Return to login screen")}))}render(){let e;switch(this.state.phase){case u.Forgot:e=this.renderForgot();break;case u.SendingEmail:e=this.renderSendingEmail();break;case u.EmailSent:e=this.renderEmailSent();break;case u.Done:e=this.renderDone();break;default:e=o.a.createElement("div",{className:"mx_Login_spinner"},o.a.createElement(C.a,{w:64,h:64}))}return o.a.createElement(f.a,null,o.a.createElement(x.a,null),o.a.createElement(T.a,null,o.a.createElement("h2",null," ",Object(r.a)("Set a new password")," "),e))}})||h},function(e,t,s){"use strict";s.d(t,"a",(function(){return U}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(138),c=s(91),l=s.n(c),d=s(1624),h=s(1625),u=s(1);const m=function(){let e=null;return function(t){return e||(e=document.createElement("textarea")),e.innerHTML=t,e.value}}();function p(e){const t={stripReplyFallback:!0,returnString:!0};return"org.matrix.custom.html"===e.format?Object(r.b)(e,null,t):function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(Object(r.b)(e,null,t))}function g(e){const t=document.createElement(Object(r.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_insertion",t.appendChild(e),t}function v(e){const t=document.createElement(Object(r.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_deletion",t.appendChild(e),t}function f(e){if("#text"===e.nodeName)return S(e.data);{const t=document.createElement(e.nodeName);if(e.attributes)for(const[s,n]of Object.entries(e.attributes))t.setAttribute(s,n);if(e.childNodes)for(const s of e.childNodes)t.appendChild(f(s));return t}}function b(e,t,s){t?e.insertBefore(s,t):e.appendChild(s)}function y(e,t){for(let s=0;s<e.length-1;++s)if(e[s]!==t[s])return!1;const s=e.length-1;return t[s]>=e[s]}function E(e,t){if("removeTextElement"===e.action||"removeElement"===e.action){const s=1;for(const n of t)y(e.route,n.route)&&(n.route[e.route.length-1]+=s)}}function S(e){return document.createTextNode(m(e))}function _(e,t,s){const{refNode:n,refParentNode:i}=function(e,t,s=!1){let n,i=e;const a=s?t.length-1:t.length;for(let e=0;e<a;++e)n=i,i=i.childNodes[t[e]];return{refNode:i,refParentNode:n}}(e,t.route);switch(t.action){case"replaceElement":{const e=document.createElement("span"),s=v(f(t.oldValue)),i=g(f(t.newValue));e.appendChild(s),e.appendChild(i),n.parentNode.replaceChild(e,n);break}case"removeTextElement":{const e=v(S(t.value));n.parentNode.replaceChild(e,n);break}case"removeElement":{const e=v(f(t.element));n.parentNode.replaceChild(e,n);break}case"modifyTextElement":{const e=s.diff_main(t.oldValue,t.newValue);s.diff_cleanupSemantic(e);const i=document.createElement("span");for(const[t,s]of e){let e=S(s);t<0?e=v(e):t>0&&(e=g(e)),i.appendChild(e)}n.parentNode.replaceChild(i,n);break}case"addElement":b(i,n,g(f(t.element)));break;case"addTextElement":b(i,n,g(S("\n"!==t.value?t.value:"")));break;case"removeAttribute":case"addAttribute":case"modifyAttribute":{const e=v(n.cloneNode(!0)),s=n.cloneNode(!0);"addAttribute"===t.action||"modifyAttribute"===t.action?s.setAttribute(t.name,t.newValue):s.removeAttribute(t.name);const i=g(s),a=document.createElement(Object(r.c)(n)?"div":"span");a.appendChild(e),a.appendChild(i),n.parentNode.replaceChild(a,n);break}default:u.a.warn("MessageDiffUtils::editBodyDiffToHtml: diff action not supported atm",t)}}function w(e,t){return e.length===t.length&&!e.some((e,s)=>e!==t[s])}function C(e,t){const s=`<div>${p(e)}</div>`,n=`<div>${p(t)}</div>`,i=function(e){const t=e.slice();for(let e=0;e<t.length;++e){const s=t[e];if("removeTextElement"===s.action){const n=t[e+1];n&&"addTextElement"===n.action&&n.text===s.text&&w(n.route,s.route)&&t.splice(e,2)}}return t}((new h.DiffDOM).diff(s,n)),a=new d.diff_match_patch,r=(new DOMParser).parseFromString(s,"text/html").body.children[0];for(let e=0;e<i.length;++e){const t=i[e];_(r,t,a),E(t,i.slice(e+1))}const c=r.innerHTML,u=l()({mx_EventTile_body:!0,"markdown-body":!0});return o.a.createElement("span",{key:"body",className:u,dangerouslySetInnerHTML:{__html:c}})}var O,k=s(136),R=s(1016),I=s(84),x=s(86),T=s(90),j=s(481),N=s(85),P=s(88),D=s(1014),M=s(495);function A(e){const t=e.getOriginalContent();return t["m.new_content"]||t}let U=Object(N.a)("views.messages.EditHistoryMessage")(O=class extends o.a.PureComponent{constructor(e){super(e),i()(this,"content",Object(a.createRef)()),i()(this,"pills",[]),i()(this,"onAssociatedStatusChanged",()=>{this.setState({sendStatus:this.props.mxEvent.getAssociatedStatus()})}),i()(this,"onRedactClick",async()=>{const e=this.props.mxEvent,t=x.a.get();T.a.createTrackedDialog("Confirm Redact Dialog","Edit history",D.a,{redact:()=>t.redactEvent(e.getRoomId(),e.getId())},"mx_Dialog_confirmredact")}),i()(this,"onViewSourceClick",()=>{T.a.createTrackedDialog("View Event Source","Edit history",M.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")});const t=x.a.get(),{userId:s}=t.credentials,n=this.props.mxEvent,o=t.getRoom(n.getRoomId());n.localRedactionEvent()&&n.localRedactionEvent().on("status",this.onAssociatedStatusChanged);const r=o.currentState.maySendRedactionForEvent(n,s);this.state={canRedact:r,sendStatus:n.getAssociatedStatus()}}pillifyLinks(){this.content.current&&Object(R.a)(this.content.current.children,this.props.mxEvent,this.pills)}componentDidMount(){this.pillifyLinks()}componentWillUnmount(){Object(R.b)(this.pills);const e=this.props.mxEvent;e.localRedactionEvent()&&e.localRedactionEvent().off("status",this.onAssociatedStatusChanged)}componentDidUpdate(){this.pillifyLinks()}renderActionBar(){let e;this.props.mxEvent.isRedacted()||this.props.isBaseEvent||!this.state.canRedact||(e=o.a.createElement(P.a,{onClick:this.onRedactClick},Object(I.a)("Remove")));const t=o.a.createElement(P.a,{onClick:this.onViewSourceClick},Object(I.a)("View Source"));return o.a.createElement("div",{className:"mx_MessageActionBar"},e,t)}render(){const{mxEvent:e}=this.props,t=A(e);let s;if(e.isRedacted())s=o.a.createElement(j.a,{mxEvent:this.props.mxEvent});else{let n;if(n=this.props.previousEdit?C(A(this.props.previousEdit),t):r.b(t,null,{stripReplyFallback:!0,returnString:!1}),"m.emote"===e.getContent().msgtype){const t=e.sender?e.sender.name:e.getSender();s=o.a.createElement("div",{className:"mx_EventTile_content",ref:this.content},"* ",o.a.createElement("span",{className:"mx_MEmoteBody_sender"},t)," ",n)}else s=o.a.createElement("div",{className:"mx_EventTile_content",ref:this.content},n)}const n=Object(k.j)(new Date(e.getTs()),this.props.isTwelveHour),i=-1!==["sending","queued","encrypting"].indexOf(this.state.sendStatus),a=l()({mx_EventTile:!0,mx_EventTile_sending:i});return o.a.createElement("li",null,o.a.createElement("div",{className:a},o.a.createElement("div",{className:"mx_EventTile_line"},o.a.createElement("span",{className:"mx_MessageTimestamp"},n),s,this.renderActionBar())))}})||O},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(474),c=s(138),l=s(89),d=s(90);var h,u=s(85),m=s(103),p=s(283);let g=Object(u.a)("views.rooms.LinkPreviewWidget")(h=class extends o.a.Component{constructor(...e){super(...e),i()(this,"description",Object(a.createRef)()),i()(this,"image",Object(a.createRef)()),i()(this,"onImageClick",e=>{const t=this.props.preview;if(0!=e.button||e.metaKey)return;e.preventDefault();let s=t["og:image"];s&&s.startsWith("mxc://")&&(s=Object(m.b)(s).srcHttp);const n={src:s,width:t["og:image:width"],height:t["og:image:height"],name:t["og:title"]||t["og:description"]||this.props.link,fileSize:t["matrix:image:size"],link:this.props.link};if(this.image.current){const e=this.image.current.getBoundingClientRect();n.thumbnailInfo={width:e.width,height:e.height,positionX:e.x,positionY:e.y}}d.a.createDialog(p.a,n,"mx_Dialog_lightbox",null,!0)})}componentDidMount(){this.description.current&&Object(c.g)(this.description.current)}componentDidUpdate(){this.description.current&&Object(c.g)(this.description.current)}render(){const e=this.props.preview;if(!e||0===Object.keys(e).length)return o.a.createElement("div",null);let t=e["og:image"];l.b.getValue("showImages")||(t=null);t&&t.startsWith("mxc://")&&(t=Object(m.b)(t).getThumbnailOfSourceHttp(100,100,"scale"));let s,n=100;e["og:image:width"]&&e["og:image:height"]&&(n=function(e,t,s,n){if(!e||!t)return null;if(e<s&&t<n)return t;const i=s/e,a=n/t;return i<a?Math.floor(i*t):Math.floor(a*t)}(e["og:image:width"],e["og:image:height"],100,100)),t&&(s=o.a.createElement("div",{className:"mx_LinkPreviewWidget_image",style:{height:n}},o.a.createElement("img",{ref:this.image,style:{maxWidth:100,maxHeight:100},src:t,onClick:this.onImageClick})));const i=r.AllHtmlEntities.decode(e["og:description"]||"");return o.a.createElement("div",{className:"mx_LinkPreviewWidget",dir:"auto"},s,o.a.createElement("div",{className:"mx_LinkPreviewWidget_caption"},o.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},o.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e["og:title"]),e["og:site_name"]&&o.a.createElement("span",{className:"mx_LinkPreviewWidget_siteName"}," - "+e["og:site_name"])),o.a.createElement("div",{className:"mx_LinkPreviewWidget_description",ref:this.description},i)),this.props.children)}})||h},function(e,t,s){"use strict";s.d(t,"c",(function(){return c.d})),s.d(t,"a",(function(){return c.a})),s.d(t,"b",(function(){return c.c}));var n=s(99),i=s.n(n),a=s(1),o=s(149),r=s(348),c=s(349);const l=r.a.DeviceVerification;class d extends c.e{constructor(...e){super(...e),i()(this,"sessionPrepared",!1),i()(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then(t=>this.crypto.ensureOlmSessionsForUsers(e)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}async encryptMessage(e,t,s){const n=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));await this.ensureSession(n);const i={room_id:e.roomId,type:t,content:s},a={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},r=[];for(let e=0;e<n.length;++e){const t=n[e],s=this.crypto.getStoredDevicesForUser(t);for(let e=0;e<s.length;++e){const n=s[e];n.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(n.verified!=l.BLOCKED&&r.push(o.encryptMessageForDevice(a.ciphertext,this.userId,this.deviceId,this.olmDevice,t,n,i)))}}return await Promise.all(r).then(()=>a)}}class h extends c.b{async decryptEvent(e){const t=e.getWireContent(),s=t.sender_key,n=t.ciphertext;if(!n)throw new c.c("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in n))throw new c.c("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const i=n[this.olmDevice.deviceCurve25519Key];let a;try{a=await this.decryptMessage(s,i)}catch(e){throw new c.c("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:s,err:e})}const o=JSON.parse(a);if(o.recipient!=this.userId)throw new c.c("OLM_BAD_RECIPIENT","Message was intented for "+o.recipient);if(o.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new c.c("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:o.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});if(o.sender!=e.getSender())throw new c.c("OLM_FORWARDED_MESSAGE","Message forwarded from "+o.sender,{reported_sender:e.getSender()});if(o.room_id!==e.getRoomId())throw new c.c("OLM_BAD_ROOM","Message intended for room "+o.room_id,{reported_room:e.getRoomId()});return{clearEvent:o,senderCurve25519Key:s,claimedEd25519Key:(o.keys||{}).ed25519||null}}async decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const s=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(e,t));return this.olmDevice.olmPrekeyPromise=s.catch(()=>{}),await s}}async reallyDecryptMessage(e,t){const s=await this.olmDevice.getSessionIdsForDevice(e),n={};for(let i=0;i<s.length;i++){const o=s[i];try{const s=await this.olmDevice.decryptMessage(e,o,t.type,t.body);return a.a.log("Decrypted Olm message from "+e+" with session "+o),s}catch(s){if(await this.olmDevice.matchesSession(e,o,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+o+": "+s.message);n[o]=s.message}}if(0!==t.type){if(0===s.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(n))}let i;try{i=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw n["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(n))}return a.a.log("created new inbound Olm session ID "+i.session_id+" with "+e),i.payload}}Object(c.g)(o.OLM_ALGORITHM,d,h);s(606)},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(83),i=s.n(n),a=s(381),o=s(89);class r{constructor(e){this.tagId=e,i()(this,"_n",0),i()(this,"_previews",!0),i()(this,"_collapsed",!1);const t=localStorage.getItem(this.key);if(t){const e=JSON.parse(t);this._n=e.numTiles,this._previews=e.showPreviews,this._collapsed=e.collapsed}}get isCollapsed(){return this._collapsed}set isCollapsed(e){this._collapsed=e,this.save()}get showPreviews(){return this._previews}set showPreviews(e){this._previews=e,this.save()}get tileHeight(){const e=o.b.getValue("roomListStyle");return e==a.a.Compact?30:e==a.a.Intermediate?44:60}get key(){return`mx_sublist_layout_${this.tagId}_boxed`}get visibleTiles(){return 0===this._n?this.defaultVisibleTiles:Math.max(this._n,this.minVisibleTiles)}set visibleTiles(e){this._n=e,this.save()}get minVisibleTiles(){return 1}get defaultVisibleTiles(){return 50}tilesWithPadding(e,t){return this.pixelsToTiles(this.tilesToPixelsWithPadding(e,t))}tilesToPixelsWithPadding(e,t){return this.tilesToPixels(e)+t}tilesToPixels(e){return e*this.tileHeight}pixelsToTiles(e){return e/this.tileHeight}reset(){localStorage.removeItem(this.key)}save(){localStorage.setItem(this.key,JSON.stringify(this.serialize()))}serialize(){return{numTiles:this.visibleTiles,showPreviews:this.showPreviews,collapsed:this.isCollapsed}}}var c=s(164),l=s(87),d=s(1);class h extends c.a{constructor(){super(l.a),i()(this,"layoutMap",new Map)}static get instance(){return h.internalInstance||(h.internalInstance=new h),h.internalInstance}ensureLayoutExists(e){this.layoutMap.has(e)||this.layoutMap.set(e,new r(e))}getLayoutFor(e){return this.layoutMap.has(e)||this.layoutMap.set(e,new r(e)),this.layoutMap.get(e)}async resetLayouts(){d.a.warn("Resetting layouts for room list");for(const e of this.layoutMap.values())e.reset()}async onNotReady(){this.layoutMap.clear()}async onAction(e){return Promise.resolve()}}i()(h,"internalInstance",void 0),window.mxRoomListLayoutStore=h.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(83),i=s.n(n);function a(e,t){const s=Math.min(e.length,t.length);for(let n=0;n<s;++n)if(e[n]!==t[n])return n;return s}function o(e,t,s){const n=s-(t.length-e.length);return function(e,t){const s=Math.min(e.length,t.length),n=e.substr(0,s)===t.substr(0,s);if(n&&e.length>t.length)return{removed:e.substr(s),at:s};if(n&&e.length<t.length)return{added:t.substr(s),at:s};{const s=a(e,t);return{removed:e.substr(s),added:t.substr(s),at:s}}}(e.substr(0,n),t.substr(0,s))}var r=s(913),c=s(572);class l{constructor(e,t,s=null){this.updateCallback=s,i()(this,"_parts",void 0),i()(this,"_partCreator",void 0),i()(this,"activePartIdx",null),i()(this,"_autoComplete",null),i()(this,"autoCompletePartIdx",null),i()(this,"autoCompletePartCount",0),i()(this,"transformCallback",null),i()(this,"onAutoComplete",({replaceParts:e,close:t})=>{let s;if(e){this._parts.splice(this.autoCompletePartIdx,this.autoCompletePartCount,...e),this.autoCompletePartCount=e.length;const t=e[e.length-1],n=this.autoCompletePartIdx+e.length-1;s=new r.a(n,t.text.length)}t&&(this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0),this.updateCallback(s)}),this._parts=e,this._partCreator=t,this.transformCallback=null}setTransformCallback(e){this.transformCallback=e}setUpdateCallback(e){this.updateCallback=e}get partCreator(){return this._partCreator}get isEmpty(){return 0===this._parts.reduce((e,t)=>e+t.text.length,0)}clone(){const e=this.parts.map(e=>this.partCreator.deserializePart(e.serialize()));return new l(e,this._partCreator,this.updateCallback)}insertPart(e,t){this._parts.splice(e,0,t),this.activePartIdx>=e&&++this.activePartIdx,this.autoCompletePartIdx>=e&&++this.autoCompletePartIdx}removePart(e){this._parts.splice(e,1),e===this.activePartIdx?this.activePartIdx=null:this.activePartIdx>e&&--this.activePartIdx,e===this.autoCompletePartIdx?this.autoCompletePartIdx=null:this.autoCompletePartIdx>e&&--this.autoCompletePartIdx}replacePart(e,t){this._parts.splice(e,1,t)}get parts(){return this._parts}get autoComplete(){return this.activePartIdx===this.autoCompletePartIdx?this._autoComplete:null}getPositionAtEnd(){if(this._parts.length){const e=this._parts.length-1,t=this._parts[e];return new r.a(e,t.text.length)}return new r.a(-1,0)}serializeParts(){return this._parts.map(e=>e.serialize())}diff(e,t,s){const n=this.parts.reduce((e,t)=>e+t.text,"");return"deleteByDrag"===t?function(e,t){if(e===t)return{};const s=a(e,t),n=e.length-t.length;return{at:s,removed:e.substr(s,n)}}(n,e):o(n,e,s.offset)}reset(e,t,s){this._parts=e.map(e=>this._partCreator.deserializePart(e)),t||(t=this.getPositionAtEnd()),this._autoComplete&&(this._autoComplete=null,this.autoCompletePartIdx=null),this.updateCallback(t,s)}insert(e,t){const s=this.splitAt(t);let n=0;for(let t=0;t<e.length;++t){const i=e[t];n+=i.text.length,this.insertPart(s+t,i)}return n}update(e,t,s){const n=this.diff(e,t,s),i=this.positionForOffset(n.at,s.atNodeEnd);let a=0;n.removed&&(a=this.removeText(i,n.removed.length));let o=0;n.added&&(o=this.addText(i,n.added,t)),this.mergeAdjacentParts();const r=n.at-a+o;let c=this.positionForOffset(r,!0);const l="insertFromPaste"!==t&&"insertFromDrop"!==t,d=this.setActivePart(c,l);if(this.transformCallback){const e=this.getTransformAddedLen(c,t,n);c=this.positionForOffset(r+e,!0)}return this.updateCallback(c,t,n),d}getTransformAddedLen(e,t,s){const n=this.transformCallback(e,t,s);return Number.isFinite(n)?n:0}setActivePart(e,t){const{index:s}=e,n=this._parts[s];if(n){if(s!==this.activePartIdx&&(this.activePartIdx=s,t&&this.activePartIdx!==this.autoCompletePartIdx)){const e=n.createAutoComplete(this.onAutoComplete);e&&(this._autoComplete=e,this.autoCompletePartIdx=s,this.autoCompletePartCount=1)}if(this.autoComplete)return this.autoComplete.onPartUpdate(n,e)}else this.activePartIdx=null,this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0;return Promise.resolve()}mergeAdjacentParts(){let e;for(let t=0;t<this._parts.length;++t){let s=this._parts[t];const n=!s.text.length,i=!n&&e&&e.merge(s);(n||i)&&(s=e,this.removePart(t),--t),e=s}}removeText(e,t){let{index:s,offset:n}=e,i=0;for(;t>0;){let e=this._parts[s];const a=Math.min(t,e.text.length-n);if(a)if(e.canEdit){const t=e.remove(n,a);"string"==typeof t&&this.replacePart(s,this._partCreator.createDefaultPart(t)),e=this._parts[s],e.text.length?s+=1:this.removePart(s)}else i+=n,this.removePart(s);else s+=1;t-=a,n=0}return i}splitAt(e){if(-1===e.index)return 0;if(0===e.offset)return e.index;const t=this._parts[e.index];if(e.offset>=t.text.length)return e.index+1;const s=t.split(e.offset);return this.insertPart(e.index+1,s),e.index+1}addText(e,t,s){let{index:n}=e;const{offset:i}=e;let a=t.length;const o=this._parts[n];if(o)if(o.canEdit)if(o.validateAndInsert(i,t,s))t=null;else{const e=o.split(i);n+=1,this.insertPart(n,e)}else 0!==i&&(a+=o.text.length-i,n+=1);else n<0&&(n=0);for(;t;){const e=this._partCreator.createPartForInput(t,n,s);t=e.appendUntilRejected(t,s),this.insertPart(n,e),n+=1}return a}positionForOffset(e,t=!1){let s=0;const n=this._parts.findIndex(n=>{const i=n.text.length;return!!(t&&s+i>=e||!t&&s+i>e)||(s+=i,!1)});return-1===n?this.getPositionAtEnd():new r.a(n,e-s)}startRange(e,t=e){return new c.a(this,e,t)}replaceRange(e,t,s){const n=t.asOffset(this),i=this.splitAt(e);t=n.asPosition(this);for(let e=this.splitAt(t)-1;e>=i;--e)this.removePart(e);let a=i;for(const e of s)this.insertPart(a,e),a+=1;this.mergeAdjacentParts()}transform(e){const t=e();let s=null;return s=t instanceof c.a?Promise.resolve():this.setActivePart(t,!0),this.updateCallback(t),s}}},,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return E}));var n=s(99),i=s.n(n),a=s(223),o=s(194),r=s(249),c=s(4),l=s(339),d=s(157),h=s(250),u=s(1),m=s(224),p=s(204),g=s(602),v=s(344),f=s(94);function b(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function y(...e){u.a.log(...e)}class E{constructor(e,t={}){var s;this.client=e,this.opts=t,i()(this,"_peekRoom",null),i()(this,"currentSyncRequest",null),i()(this,"syncState",null),i()(this,"syncStateData",null),i()(this,"catchingUp",!1),i()(this,"running",!1),i()(this,"keepAliveTimer",null),i()(this,"connectionReturnedDefer",null),i()(this,"notifEvents",[]),i()(this,"failedSyncCount",0),i()(this,"storeIsInvalid",!1),i()(this,"onOnline",()=>{y("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts.initialSyncLimit=null!==(s=this.opts.initialSyncLimit)&&void 0!==s?s:8,this.opts.resolveInvitesToProfiles=this.opts.resolveInvitesToProfiles||!1,this.opts.pollTimeout=this.opts.pollTimeout||3e4,this.opts.pendingEventOrdering=this.opts.pendingEventOrdering||p.c.Chronological,this.opts.experimentalThreadSupport=!0===this.opts.experimentalThreadSupport,t.canResetEntireTimeline||(t.canResetEntireTimeline=e=>!1),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}createRoom(e){const t=this.client,{timelineSupport:s,unstableClientRelationAggregation:n}=t,i=new o.b(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:s,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(i,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this.registerStateListeners(i),i}createGroup(e){const t=this.client,s=new r.a(e);return t.reEmitter.reEmit(s,["Group.profile","Group.myMembership"]),t.store.storeGroup(s),s}registerStateListeners(e){const t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,s,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))}deregisterStateListeners(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")}syncLeftRooms(){const e=this.client,t=new l.a(this.client.credentials.userId);t.setTimelineLimit(1),t.setIncludeLeaveRooms(!0);const s=this.opts.pollTimeout+8e4,n={timeout:0};return e.getOrCreateFilter(b(e.credentials.userId,"LEFT_ROOMS"),t).then((function(t){return n.filter=t,e.http.authedRequest(void 0,"GET","/sync",n,void 0,s)})).then(t=>{let s=[];t.rooms&&t.rooms.leave&&(s=this.mapSyncResponseToRoomArray(t.rooms.leave));const n=[];return s.forEach(t=>{const s=t.room;if(n.push(s),!t.isBrandNewRoom)return;t.timeline=t.timeline||{};const i=this.mapSyncEventsFormat(t.timeline,s),[a,o]=this.client.partitionThreadedEvents(i),r=this.mapSyncEventsFormat(t.state,s);s.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,d.b.BACKWARDS),this.processRoomEvents(s,r,a),this.processThreadEvents(s,o),s.recalculate(),e.store.storeRoom(s),e.emit("Room",s),this.processEventsForNotifs(s,i)}),n})}peek(e){if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then(e=>{e.messages=e.messages||{chunk:[]},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const s=c.j(e.state).map(t.getEventMapper()),n=e.state.map(t.getEventMapper()),i=e.messages.chunk.map(t.getEventMapper());return e.presence&&Array.isArray(e.presence)&&e.presence.map(t.getEventMapper()).forEach((function(e){let s=t.store.getUser(e.getContent().user_id);s?s.setPresenceEvent(e):(s=S(t,e.getContent().user_id),s.setPresenceEvent(e),t.store.storeUser(s)),t.emit("event",e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(s),this._peekRoom.currentState.setStateEvents(n),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(i.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),t.store.storeRoom(this._peekRoom),t.emit("Room",this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){this._peekRoom===e?this.client.http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then(t=>{if(this._peekRoom!==e)return void y("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach(e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=S(this.client,e.getContent().user_id),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit("event",e)});const s=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());e.addLiveEvents(s),this.peekPoll(e,t.end)},s=>{u.a.error("[%s] Peek poll failed: %s",e.roomId,s),setTimeout(()=>{this.peekPoll(e,t)},3e4)}):y("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData}async recoverFromSyncStartupError(e,t){await e;const s=this.startKeepAlives();this.updateSyncState(g.a.Error,{error:t}),await s}async wasLazyLoadingToggled(e=!1){let t=!1;if(!await this.client.store.isNewlyCreated()){const s=await this.client.store.getClientOptions();return s&&(t=!!s.lazyLoadMembers),t!==e}return!1}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(u.a.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(g.a.Error,{error:e}),!0)}sync(){const t=this.client;this.running=!0,e.window&&e.window.addEventListener&&e.window.addEventListener("online",this.onOnline,!1);let s=Promise.resolve(),n=null;const i=async()=>{try{y("Getting push rules...");const e=await t.getPushRules();y("Got push rules"),t.pushRules=e}catch(e){if(u.a.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return y("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(s,e),void i()}o()},a=()=>{const e=new l.a(t.credentials.userId);return e.setTimelineLimit(this.opts.initialSyncLimit),e},o=async()=>{if(y("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){y("Checking server lazy load support...");await t.doesServerSupportLazyLoading()?(y("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=a()),this.opts.filter.setLazyLoadMembers(!0)):(y("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}y("Checking whether lazy loading has changed in store...");if(await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this.storeIsInvalid=!0;const e=m.b.TOGGLED_LAZY_LOADING,t=new m.b(e,!!this.opts.lazyLoadMembers);return this.updateSyncState(g.a.Error,{error:t}),void u.a.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{y("Storing client options..."),await this.client.storeClientOptions(),y("Stored client options")}catch(e){throw u.a.error("Storing client options failed",e),e}r()},r=async()=>{let e,i;y("Getting filter..."),e=this.opts.filter?this.opts.filter:a();try{i=await t.getOrCreateFilter(b(t.credentials.userId),e)}catch(e){if(u.a.error("Getting filter failed",e),this.shouldAbortSync(e))return;return y("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(s,e),void r()}t.resetNotifTimelineSet(),null===this.currentSyncRequest&&(y("Sending first sync request..."),this.currentSyncRequest=this.doSyncRequest({filterId:i},n)),y("Waiting for saved sync before starting sync processing..."),await s,this.doSync({filterId:i})};t.isGuest()?this.doSync({}):(y("Getting saved sync token..."),s=t.store.getSavedSyncToken().then(e=>(y("Got saved sync token"),n=e,y("Getting saved sync..."),t.store.getSavedSync())).then(e=>{if(y("Got reply from saved sync, exists? "+!!e),e)return this.syncFromCache(e)}).catch(e=>{u.a.error("Getting saved sync failed",e)}),i())}stop(){y("SyncApi.stop"),e.window&&e.window.removeEventListener&&e.window.removeEventListener("online",this.onOnline,!1),this.running=!1,this.currentSyncRequest&&this.currentSyncRequest.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=null)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){y("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const s={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(s,n)}catch(e){u.a.error("Error processing cached sync",e.stack||e)}this.storeIsInvalid||this.updateSyncState(g.a.Prepared,s)}async doSync(e){const t=this.client;if(!this.running)return y("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),void this.updateSyncState(g.a.Stopped);const s=t.store.getSyncToken();let n;try{null===this.currentSyncRequest&&(this.currentSyncRequest=this.doSyncRequest(e,s)),n=await this.currentSyncRequest}catch(t){return void this.onSyncError(t,e)}finally{this.currentSyncRequest=null}t.store.setSyncToken(n.next_batch),this.failedSyncCount=0,await t.store.setSyncData(n);const i={oldSyncToken:s,nextSyncToken:n.next_batch,catchingUp:this.catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(i);try{await this.processSyncResponse(i,n)}catch(e){u.a.error("Caught /sync error",e.stack||e),this.client.emit("sync.unexpectedError",e)}i.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(g.a.Prepared,i),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(i),this.updateSyncState(g.a.Syncing,i),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this.doSync(e)}doSyncRequest(e,t){const s=this.getSyncParams(e,t);return this.client.http.authedRequest(void 0,"GET","/sync",s,void 0,s.timeout+8e4)}getSyncParams(e,t){let s=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this.catchingUp)&&(this.catchingUp=!0,s=0);let n=e.filterId;this.client.isGuest()&&!n&&(n=this.getGuestFilter());const i={filter:n,timeout:s};return this.opts.disablePresence&&(i.set_presence="offline"),t?i.since=t:i._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(i.timeout=0),i}onSyncError(e,t){if(!this.running)return y("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=null),void this.updateSyncState(g.a.Stopped);u.a.error("/sync error %s",e),u.a.error(e),this.shouldAbortSync(e)||(this.failedSyncCount++,u.a.log("Number of consecutive failed sync requests:",this.failedSyncCount),y("Starting keep-alive"),this.startKeepAlives().then(e=>{e&&this.getSyncState()===g.a.Error&&this.updateSyncState(g.a.Catchup,{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this.doSync(t)}),this.currentSyncRequest=null,this.updateSyncState(this.failedSyncCount>=3?g.a.Error:g.a.Reconnecting,{error:e}))}async processSyncResponse(e,t){const s=this.client;if(t.presence&&Array.isArray(t.presence.events)&&t.presence.events.map(s.getEventMapper()).forEach((function(e){let t=s.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=S(s,e.getSender()),t.setPresenceEvent(e),s.store.storeUser(t)),s.emit("event",e)})),t.account_data&&Array.isArray(t.account_data.events)){const e=t.account_data.events.map(s.getEventMapper()),n=e.reduce((e,t)=>(e[t.getId()]=s.store.getAccountData(t.getType()),e),{});s.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===f.a.PushRules){const t=e.getContent();s.pushRules=h.a.rewriteDefaultRules(t)}const t=n[e.getId()];return s.emit("accountData",e,t),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(s.getEventMapper()).map(t=>{if("m.key.verification.cancel"===t.getType()){const s=t.getContent().transaction_id;s&&e.push(s)}return t}).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const s=n.transaction_id;e.includes(s)&&t.flagCancelled()}s.emit("toDeviceEvent",t)}else u.a.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this.catchingUp=!1;t.groups&&(t.groups.invite&&this.processGroupSyncEntry(t.groups.invite,v.a.Invite),t.groups.join&&this.processGroupSyncEntry(t.groups.join,v.a.Join),t.groups.leave&&this.processGroupSyncEntry(t.groups.leave,v.a.Leave));let n=[],i=[],a=[];if(t.rooms&&(t.rooms.invite&&(n=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(i=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(a=this.mapSyncResponseToRoomArray(t.rooms.leave))),this.notifEvents=[],n.forEach(e=>{const t=e.room,n=this.mapSyncEventsFormat(e.invite_state,t);this.processRoomEvents(t,n),e.isBrandNewRoom&&(t.recalculate(),s.store.storeRoom(t),s.emit("Room",t)),n.forEach((function(e){s.emit("event",e)})),t.updateMyMembership("invite")}),await c.B(i,async t=>{const n=t.room,i=this.mapSyncEventsFormat(t.state,n),a=this.mapSyncEventsFormat(t.timeline,n,!1),r=this.mapSyncEventsFormat(t.ephemeral),l=this.mapSyncEventsFormat(t.account_data),h=s.isRoomEncrypted(n.roomId);if(t.unread_notifications&&(n.setUnreadNotificationCount(o.a.Total,t.unread_notifications.notification_count),(!h||h&&n.getUnreadNotificationCount(o.a.Highlight)<=0)&&n.setUnreadNotificationCount(o.a.Highlight,t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},t.isBrandNewRoom)n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,d.b.BACKWARDS);else if(t.timeline.limited){let i=!0;for(let e=a.length-1;e>=0;e--){const t=a[e].getId();if(n.getTimelineForEvent(t)){y("Already have event "+t+" in limited sync - not resetting"),i=!1,a.splice(0,e);break}}i&&(this.deregisterStateListeners(n),n.resetLiveTimeline(t.timeline.prev_batch,this.opts.canResetEntireTimeline(n.roomId)?null:e.oldSyncToken),s.resetNotifTimelineSet(),this.registerStateListeners(n))}const[u,m]=this.client.partitionThreadedEvents(a);this.processRoomEvents(n,i,u,e.fromCache),this.processThreadEvents(n,m),t.summary&&n.setSummary(t.summary),n.addEphemeralEvents(r),n.addAccountData(l),n.recalculate(),t.isBrandNewRoom&&(s.store.storeRoom(n),s.emit("Room",n)),this.processEventsForNotifs(n,a);const p=async e=>{if(s.emit("event",e),e.isState()&&"m.room.encryption"==e.getType()&&this.opts.crypto&&await this.opts.crypto.onCryptoEvent(e),e.isState()&&"im.vector.user_status"===e.getType()){let t=s.store.getUser(e.getStateKey());t?t.unstable_updateStatusMessage(e):(t=S(s,e.getStateKey()),t.unstable_updateStatusMessage(e),s.store.storeUser(t))}};await c.B(i,p),await c.B(u,p),await c.B(m,p),r.forEach((function(e){s.emit("event",e)})),l.forEach((function(e){s.emit("event",e)})),n.updateMyMembership("join"),n.decryptCriticalEvents()}),a.forEach(e=>{const t=e.room,n=this.mapSyncEventsFormat(e.state,t),i=this.mapSyncEventsFormat(e.timeline,t),a=this.mapSyncEventsFormat(e.account_data),[o,r]=this.client.partitionThreadedEvents(i);this.processRoomEvents(t,n,o),this.processThreadEvents(t,r),t.addAccountData(a),t.recalculate(),e.isBrandNewRoom&&(s.store.storeRoom(t),s.emit("Room",t)),this.processEventsForNotifs(t,i),n.forEach((function(e){s.emit("event",e)})),o.forEach((function(e){s.emit("event",e)})),r.forEach((function(e){s.emit("event",e)})),a.forEach((function(e){s.emit("event",e)})),t.updateMyMembership("leave")}),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){s.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}if(this.opts.crypto&&t["org.matrix.msc2732.device_unused_fallback_key_types"]){const e=t["org.matrix.msc2732.device_unused_fallback_key_types"];this.opts.crypto.setNeedsNewFallback(e instanceof Array&&!e.includes("signed_curve25519"))}}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=c.l()),this.connectionReturnedDefer.promise}pokeKeepAlive(e=!1){const t=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=null)};this.client.http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then(()=>{t()},s=>{400==s.httpStatus||404==s.httpStatus?this.keepAliveTimer=setTimeout(t,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(g.a.Error,{error:s}))})}processGroupSyncEntry(e,t){for(const s of Object.keys(e)){const n=e[s];let i=this.client.store.getGroup(s);const a=null===i;null===i&&(i=this.createGroup(s)),n.profile&&i.setProfile(n.profile.name,n.profile.avatar_url),n.inviter&&i.setInviter({userId:n.inviter}),i.setMyMembership(t),a&&this.client.emit("Group",i)}}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).map(s=>{const n=e[s];let i=t.store.getRoom(s),a=!1;return i||(i=this.createRoom(s),a=!0),n.room=i,n.isBrandNewRoom=a,n})}mapSyncEventsFormat(e,t,s=!0){if(!e||!Array.isArray(e.events))return[];const n=this.client.getEventMapper({decrypt:s});return e.events.map((function(e){return t&&(e.room_id=t.roomId),n(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(s){if(s._requestedProfileInfo)return;s._requestedProfileInfo=!0;const n=t.getUser(s.userId);let i;i=n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(s.userId),i.then((function(t){const n=s.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,s.setMembershipEvent(n,e.currentState))}),(function(e){}))}))}processRoomEvents(e,t,s,n=!1){const i=e.getLiveTimeline(),a=0==i.getEvents().length;if(a){for(const e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t)}this.resolveInvites(e),e.recalculate(),a||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(s||[],null,n)}processThreadEvents(e,t){return this.client.processThreadEvents(e,t)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const s=this.client.getPushActionsForEvent(t[e]);s&&s.notify&&s.tweaks&&s.tweaks.highlight&&this.notifEvents.push(t[e])}}getGuestFilter(){return"{}"}updateSyncState(e,t){const s=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit("sync",this.syncState,s,t)}}function S(e,t){const s=new a.a(t);return e.reEmitter.reEmit(s,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),s}}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(99),i=s.n(n);class a{constructor(){i()(this,"accountData",{}),i()(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeGroup(e){}getGroup(e){return null}getGroups(){return[]}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}storeEvents(e,t,s,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve({})}storeClientOptions(e){return Promise.resolve()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(99),i=s.n(n),a=s(1),o=s(163),r=s(94);class c{constructor(e){i()(this,"client",void 0),i()(this,"calls",void 0),i()(this,"callEventBuffer",void 0),i()(this,"candidateEventsByCall",void 0),i()(this,"evaluateEventBuffer",async()=>{if("SYNCING"===this.client.getSyncState()){await Promise.all(this.callEventBuffer.map(e=>{this.client.decryptEventIfNeeded(e)}));const e=new Set;for(const t of this.callEventBuffer)t.getType()!==r.a.CallAnswer&&t.getType()!==r.a.CallHangup||e.add(t.getContent().call_id);for(const t of this.callEventBuffer)if(t.getType()!==r.a.CallInvite||!e.has(t.getContent().call_id))try{await this.handleCallEvent(t)}catch(e){a.a.error("Caught exception handling call event",e)}this.callEventBuffer=[]}}),i()(this,"onRoomTimeline",e=>{this.client.decryptEventIfNeeded(e),(this.eventIsACall(e)||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",async()=>{if(this.eventIsACall(e))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{await this.handleCallEvent(e)}catch(e){a.a.error("Caught exception handling call event",e)}})}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on("sync",this.evaluateEventBuffer),this.client.on("Room.timeline",this.onRoomTimeline)}stop(){this.client.removeListener("sync",this.evaluateEventBuffer),this.client.removeListener("Room.timeline",this.onRoomTimeline)}eventIsACall(e){const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}async handleCallEvent(e){const t=e.getContent(),s=e.getType(),n=e.getSender()===this.client.credentials.userId;let i=t.call_id?this.calls.get(t.call_id):void 0;if(s!==r.a.CallInvite)if(s!==r.a.CallCandidates)if([r.a.CallHangup,r.a.CallReject].includes(s))i?i.state!==o.e.Ended&&(s===r.a.CallHangup?i.onHangupReceived(t):i.onRejectReceived(t),this.calls.delete(t.call_id)):(i=Object(o.g)(this.client,e.getRoomId()),i&&(i.callId=t.call_id,i.initWithHangup(e),this.calls.set(t.call_id,i)));else if(i&&i.hasPeerConnection){if(e.getContent().party_id!==i.ourPartyId)switch(s){case r.a.CallAnswer:n?i.state===o.e.Ringing&&i.onAnsweredElsewhere(t):i.onAnswerReceived(e);break;case r.a.CallSelectAnswer:i.onSelectAnswerReceived(e);break;case r.a.CallNegotiate:i.onNegotiateReceived(e);break;case r.a.CallAssertedIdentity:case r.a.CallAssertedIdentityPrefix:i.onAssertedIdentityReceived(e);break;case r.a.CallSDPStreamMetadataChanged:case r.a.CallSDPStreamMetadataChangedPrefix:i.onSDPStreamMetadataChangedReceived(e)}}else a.a.warn("Discarding an event, we don't have a call/peerConn",s);else{if(n)return;i?i.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else{if(n)return;if(e.getLocalAge()>t.lifetime-3e3)return;if(i&&i.state===o.e.Ended)return;i&&a.a.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const s=this.client.getTurnServersExpiry()-Date.now();if(a.a.info("Current turn creds expire in "+s+" ms"),i=Object(o.g)(this.client,e.getRoomId(),{forceTURN:this.client.forceTURN}),!i)return void a.a.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(i.callId=t.call_id,await i.initWithInvite(e),this.calls.set(i.callId,i),this.candidateEventsByCall.get(i.callId))for(const e of this.candidateEventsByCall.get(i.callId))i.onRemoteIceCandidatesReceived(e);let r;for(const e of this.calls.values()){const t=[o.e.WaitLocalMedia,o.e.CreateOffer,o.e.InviteSent].includes(e.state);if(i.roomId===e.roomId&&e.direction===o.a.Outbound&&t){r=e;break}}r?r.state===o.e.WaitLocalMedia||r.state===o.e.CreateOffer||r.callId>i.callId?(a.a.log("Glare detected: answering incoming call "+i.callId+" and canceling outgoing call "+r.callId),r.replacedBy(i),i.answer()):(a.a.log("Glare detected: rejecting incoming call "+i.callId+" and keeping outgoing call "+r.callId),i.hangup(o.b.Replaced,!0)):this.client.emit("Call.incoming",i)}}}},,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(99),i=s.n(n),a=s(174);class o{constructor(e){this.cryptoStore=e,i()(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[a.a.STORE_ROOMS],e=>{this.cryptoStore.getEndToEndRooms(e,e=>{this.roomEncryption=e})})}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[a.a.STORE_ROOMS],s=>{this.cryptoStore.storeEndToEndRoom(e,t,s)})}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c})),s.d(t,"c",(function(){return l}));var n=s(99),i=s.n(n),a=s(1),o=s(4);const r=10;class c{constructor(e){this.db=e,i()(this,"nextTxnId",0),e.onversionchange=()=>{a.a.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((s,n)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=n,this._getOutgoingRoomKeyRequest(i,t,n=>{if(n)return a.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void s(n);a.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),i.oncomplete=()=>{s(e)};i.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,s)=>{const n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=s,this._getOutgoingRoomKeyRequest(n,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,s){const n=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);n.onsuccess=()=>{const e=n.result;if(!e)return void s(null);const i=e.value;o.i(i.requestBody,t)?s(i):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,s=0;const n=this.db.transaction("outgoingRoomKeyRequests","readonly"),i=n.objectStore("outgoingRoomKeyRequests"),a=e[s];return i.index("state").openCursor(a).onsuccess=function n(i){const a=i.target.result;if(a)return void(t=a.value);if(s++,s>=e.length)return;const o=e[s];i.target.source.openCursor(o).onsuccess=n},h(n).then(()=>t)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,s)=>{const n=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);n.onsuccess=()=>t(n.result),n.onerror=()=>s(n.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,s){let n=0;const i=[];const a=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=a.objectStore("outgoingRoomKeyRequests"),r=s[n];return o.index("state").openCursor(r).onsuccess=function a(o){const r=o.target.result;if(r){const s=r.value;s.recipients.includes({userId:e,deviceId:t})&&i.push(s),r.continue()}else{if(n++,n>=s.length)return;const e=s[n];o.target.source.openCursor(e).onsuccess=a}},h(a).then(()=>i)}updateOutgoingRoomKeyRequest(e,t,s){let n=null;const i=this.db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){const i=e.target.result;if(!i)return;const o=i.value;o.state==t?(Object.assign(o,s),i.update(o),n=o):a.a.warn(`Cannot update room key request from ${t} as it was already updated to `+o.state)},h(i).then(()=>n)}deleteOutgoingRoomKeyRequest(e,t){const s=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=s.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{const e=n.result;if(!e)return;const s=e.value;s.state==t?e.delete():a.a.warn(`Cannot delete room key request in state ${s.state} (expected ${t})`)},h(s)}getAccount(e,t){const s=e.objectStore("account").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){d(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const s=e.objectStore("account").get("crossSigningKeys");s.onsuccess=function(){try{t(s.result||null)}catch(t){d(e,t)}}}getSecretStorePrivateKey(e,t,s){const n=e.objectStore("account").get("ssss_cache:"+s);n.onsuccess=function(){try{t(n.result||null)}catch(t){d(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,s){e.objectStore("account").put(s,"ssss_cache:"+t)}countEndToEndSessions(e,t){const s=e.objectStore("sessions").count();s.onsuccess=function(){try{t(s.result)}catch(t){d(e,t)}}}getEndToEndSessions(e,t,s){const n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){const e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{s(i)}catch(e){d(t,e)}}}getEndToEndSession(e,t,s,n){const i=s.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){d(s,e)}}}getAllEndToEndSessions(e,t){const s=e.objectStore("sessions").openCursor();s.onsuccess=function(){try{const e=s.result;e?(t(e.value),e.continue()):t(null)}catch(t){d(e,t)}}}storeEndToEndSession(e,t,s,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:s.session,lastReceivedMessageTs:s.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,s){const n=this.db.transaction("session_problems","readwrite");return n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:s,time:Date.now()}),h(n)}async getEndToEndSessionProblem(e,t){let s;const n=this.db.transaction("session_problems","readwrite"),i=n.objectStore("session_problems").index("deviceKey").getAll(e);return i.onsuccess=()=>{const e=i.result;if(!e.length)return void(s=null);e.sort((e,t)=>e.time-t.time);const n=e[e.length-1];for(const i of e)if(i.time>t)return void(s=Object.assign({},i,{fixed:n.fixed}));s=n.fixed?null:n},await h(n),s}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),s=[];return await Promise.all(e.map(e=>new Promise(n=>{const{userId:i,deviceInfo:a}=e,o=t.get([i,a.deviceId]);o.onsuccess=function(){o.result||(t.put({userId:i,deviceId:a.deviceId}),s.push(e)),n()}}))),s}getEndToEndInboundGroupSession(e,t,s,n){let i=!1,a=!1;const o=s.objectStore("inbound_group_sessions").get([e,t]);o.onsuccess=function(){try{i=o.result?o.result.session:null,!1!==a&&n(i,a)}catch(e){d(s,e)}};const r=s.objectStore("inbound_group_sessions_withheld").get([e,t]);r.onsuccess=function(){try{a=r.result?r.result.session:null,!1!==i&&n(i,a)}catch(e){d(s,e)}}}getAllEndToEndInboundGroupSessions(e,t){const s=e.objectStore("inbound_group_sessions").openCursor();s.onsuccess=function(){const n=s.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){d(e,t)}n.continue()}else try{t(null)}catch(t){d(e,t)}}}addEndToEndInboundGroupSession(e,t,s,n){const i=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:s});i.onerror=s=>{"ConstraintError"===i.error.name?(s.stopPropagation(),s.preventDefault(),a.a.log("Ignoring duplicate inbound group session: "+e+" / "+t)):d(n,new Error("Failed to add inbound group session: "+i.error))}}storeEndToEndInboundGroupSession(e,t,s,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:s})}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:s})}getEndToEndDeviceData(e,t){const s=e.objectStore("device_data").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){d(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,s){s.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const s={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){const i=n.result;if(i)s[i.key]=i.value,i.continue();else try{t(s)}catch(t){d(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,s)=>{const n=[],i=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=s,i.oncomplete=function(){t(n)};const a=i.objectStore("sessions_needing_backup"),o=i.objectStore("inbound_group_sessions"),r=a.openCursor();r.onsuccess=function(){const t=r.result;if(t){const s=o.get(t.key);s.onsuccess=function(){n.push({senderKey:s.result.senderCurve25519Key,sessionId:s.result.sessionId,sessionData:s.result.session})},(!e||n.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((e,s)=>{const n=t.count();n.onerror=s,n.onsuccess=()=>e(n.result)})}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");await Promise.all(e.map(e=>new Promise((t,n)=>{const i=s.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=n})))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");await Promise.all(e.map(e=>new Promise((t,n)=>{const i=s.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n})))}addSharedHistoryInboundGroupSession(e,t,s,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const i=n.objectStore("shared_history_inbound_group_sessions"),a=i.get([e]);a.onsuccess=()=>{const{sessions:n}=a.result||{sessions:[]};n.push([t,s]),i.put({roomId:e,sessions:n})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const s=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise((e,t)=>{s.onsuccess=()=>{const{sessions:t}=s.result||{sessions:[]};e(t)},s.onerror=t})}doTxn(e,t,s,n=a.a){const i=this.db.transaction(t,e),o=h(i),r=s(i);return o.then(()=>r)}}function l(e,t){if(a.a.log("Upgrading IndexedDBCryptoStore from version "+t+" to "+r),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e),t<2&&e.createObjectStore("account"),t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}if(t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]}),t<5&&e.createObjectStore("device_data"),t<6&&e.createObjectStore("rooms"),t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]}),t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]}),t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}t<10&&e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})}function d(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function h(e){return new Promise((t,s)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&s(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(a.a.log("Error performing indexeddb txn",t),s(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(a.a.log("Error performing indexeddb txn",t),s(e.error))}})}},,function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(1);let i,a=0;const o=[];let r=Date.now;function c(e,t,...s){(t=t||0)<0&&(t=0);const n=r()+t,i=a++,c={runAt:n,func:e,params:s,key:i},l=function(e,t){let s=0,n=e.length;for(;s<n;){const i=s+n>>1;t(e[i])>0?n=i:s=i+1}return s}(o,(function(e){return e.runAt-n}));return o.splice(l,0,c),d(),i}function l(e){if(0===o.length)return;let t;for(t=0;t<o.length;t++){if(o[t].key==e){o.splice(t,1);break}}0===t&&d()}function d(){i&&e.clearTimeout(i);const t=o[0];if(!t)return;const s=r(),n=Math.min(t.runAt-s,1e3);i=e.setTimeout(h,n)}function h(){let t;const s=r(),i=[];for(;;){const e=o[0];if(!e||e.runAt>s)break;t=o.shift(),t.key,i.push(t)}d();for(let s=0;s<i.length;s++){t=i[s];try{t.func.apply(e,t.params)}catch(e){n.a.error("Uncaught exception in callback function",e.stack||e)}}}}).call(this,s(26))},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(99),i=s.n(n),a=s(5),o=s(1),r=s(348),c=s(350),l=s(149),d=s(174),h=s(4);let u;!function(e){e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate"}(u||(u={}));class m extends a.EventEmitter{constructor(e,t,s,n=250){super(),this.cryptoStore=t,this.keyDownloadChunkSize=n,i()(this,"devices",{}),i()(this,"crossSigningInfo",{}),i()(this,"userByIdentityKey",{}),i()(this,"deviceTrackingStatus",{}),i()(this,"syncToken",null),i()(this,"keyDownloadsInProgressByUser",{}),i()(this,"dirty",!1),i()(this,"savePromise",null),i()(this,"resolveSavePromise",null),i()(this,"savePromiseTime",null),i()(this,"saveTimer",null),i()(this,"hasFetched",null),i()(this,"serialiser",void 0),this.serialiser=new p(e,s,this)}async load(){await this.cryptoStore.doTxn("readonly",[d.a.STORE_DEVICE_DATA],e=>{this.cryptoStore.getEndToEndDeviceData(e,e=>{this.hasFetched=Boolean(e&&e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=e?e.syncToken:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const s of Object.keys(t)){const n=t[s].keys["curve25519:"+s];void 0!==n&&(this.userByIdentityKey[n]=e)}}})});for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==u.DownloadInProgress&&(this.deviceTrackingStatus[e]=u.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let s=this.savePromise;if(null===s&&(s=new Promise((e,t)=>{this.resolveSavePromise=e}),this.savePromise=s),null===this.saveTimer){const s=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout(()=>{o.a.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[d.a.STORE_DEVICE_DATA],e=>{this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:this.syncToken},e)}).then(()=>{this.dirty=!1,s(!0)},e=>{o.a.error("Failed to save device tracking data",this.syncToken),o.a.error(e)})},e)}return s}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const s=[],n=[];if(e.forEach(e=>{const i=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser[e]?(o.a.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),n.push(this.keyDownloadsInProgressByUser[e])):(t||i!=u.UpToDate)&&s.push(e)}),0!=s.length){o.a.log("downloadKeys: downloading for",s);const e=this.doKeyDownload(s);n.push(e)}return 0===n.length&&o.a.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){const t={};return e.map(e=>{t[e]={};(this.getStoredDevicesForUser(e)||[]).map((function(s){t[e][s.deviceId]=s}))}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const s=[];for(const e in t)t.hasOwnProperty(e)&&s.push(r.a.fromStorage(t[e],e));return s}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?c.a.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const s=this.devices[e];if(s&&s[t])return r.a.fromStorage(s[t],t)}getUserByIdentityKey(e,t){return e!==l.OLM_ALGORITHM&&e!==l.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const s=this.getUserByIdentityKey(e,t);if(!s)return null;const n=this.devices[s];if(!n)return null;for(const e in n){if(!n.hasOwnProperty(e))continue;const s=n[e];for(const n in s.keys){if(!s.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;if(s.keys[n]==t)return r.a.fromStorage(s,e)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(o.a.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=u.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(o.a.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=u.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=u.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(o.a.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=u.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){this.deviceTrackingStatus[t]==u.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,s]of Object.entries(this.devices[e])){const e=s.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[s,n]of Object.entries(t)){const t=n.keys["curve25519:"+s];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{s(!0)},t=>{throw o.a.error("Error downloading keys for "+e+":",t),s(!1),t});e.forEach(e=>{this.keyDownloadsInProgressByUser[e]=t;this.deviceTrackingStatus[e]==u.PendingDownload&&(this.deviceTrackingStatus[e]=u.DownloadInProgress)});const s=s=>{this.emit("crypto.willUpdateDevices",e,!this.hasFetched),e.forEach(e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser[e]!==t)return void o.a.log("Another update in the queue for",e,"- not marking up-to-date");delete this.keyDownloadsInProgressByUser[e];this.deviceTrackingStatus[e]==u.DownloadInProgress&&(s?(this.deviceTrackingStatus[e]=u.UpToDate,o.a.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=u.PendingDownload)}),this.saveIfDirty(),this.emit("crypto.devicesUpdated",e,!this.hasFetched),this.hasFetched=!0};return t}}class p{constructor(e,t,s){this.baseApis=e,this.olmDevice=t,this.deviceList=s,i()(this,"downloadInProgress",!1),i()(this,"keyDownloadsQueuedByUser",{}),i()(this,"queuedQueryDeferred",null),i()(this,"syncToken",null)}updateDevicesForUsers(e,t){return e.forEach(e=>{this.keyDownloadsQueuedByUser[e]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=Object(h.l)()),this.syncToken=t,this.downloadInProgress?(o.a.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=null,o.a.log("Starting key download for",e),this.downloadInProgress=!0;const s={};this.syncToken&&(s.token=this.syncToken);const n=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const i=e.slice(t,t+this.deviceList.keyDownloadChunkSize);n.push(()=>this.baseApis.downloadKeysForUsers(i,s))}return Object(h.f)(n,3).then(async t=>{const s=Object.assign({},...t.map(e=>e.device_keys||{})),n=Object.assign({},...t.map(e=>e.master_keys||{})),i=Object.assign({},...t.map(e=>e.self_signing_keys||{})),a=Object.assign({},...t.map(e=>e.user_signing_keys||{}));for(const t of e){await Object(h.I)(5);try{await this.processQueryResponseForUser(t,s[t],{master:n[t],self_signing:i[t],user_signing:a[t]})}catch(e){o.a.error(`Error processing keys for ${t}:`,e)}}}).then(()=>{o.a.log("Completed key download for "+e),this.downloadInProgress=!1,t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},s=>{o.a.warn("Error downloading keys for "+e+":",s),this.downloadInProgress=!1,t.reject(s)}),t.promise}async processQueryResponseForUser(e,t,s){o.a.log("got device keys for "+e+":",t),o.a.log("got cross-signing keys for "+e+":",s);{const s={},n=this.deviceList.getRawStoredDevicesForUser(e);n&&Object.keys(n).forEach(e=>{const t=r.a.fromStorage(n[e],e);s[e]=t}),await async function(e,t,s,n,i,a){let r=!1;for(const e in s)if(s.hasOwnProperty(e)&&!(e in n)){if(t===i&&e===a){o.a.warn(`Local device ${e} missing from sync, skipping removal`);continue}o.a.log("Device "+t+":"+e+" has been removed"),delete s[e],r=!0}for(const i in n){if(!n.hasOwnProperty(i))continue;const a=n[i];a.user_id===t?a.device_id===i?await g(e,s,a)&&(r=!0):o.a.warn("Mismatched device_id "+a.device_id+" in keys from "+t+":"+i):o.a.warn("Mismatched user_id "+a.user_id+" in keys from "+t+":"+i)}return r}(this.olmDevice,e,s,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const i={};Object.keys(s).forEach(e=>{i[e]=s[e].toStorage()}),this.deviceList.setRawStoredDevicesForUser(e,i)}if(s&&(s.master||s.self_signing||s.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new c.a(e);t.setKeys(s),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit("userCrossSigningUpdated",e)}}}async function g(e,t,s){if(!s.keys)return!1;const n=s.device_id,i=s.user_id,a="ed25519:"+n,c=s.keys[a];if(!c)return o.a.warn("Device "+i+":"+n+" has no ed25519 key"),!1;const d=s.unsigned||{},h=s.signatures||{};try{await l.verifySignature(e,s,i,n,c)}catch(e){return o.a.warn("Unable to verify signature on device "+i+":"+n+":"+e),!1}let u;if(n in t){if(u=t[n],u.getFingerprint()!=c)return o.a.warn("Ed25519 key for device "+i+":"+n+" has changed"),!1}else t[n]=u=new r.a(n);return u.keys=s.keys||{},u.algorithms=s.algorithms||[],u.unsigned=d,u.signatures=h,!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(99),i=s.n(n),a=s(1),o=s(117),r=s(5),c=s(350),l=s(174),d=s(288);class h{constructor(e,t){i()(this,"accountDataClientAdapter",void 0),i()(this,"crossSigningCallbacks",void 0),i()(this,"ssssCryptoCallbacks",void 0),i()(this,"crossSigningKeys",null),i()(this,"keySignatures",null),i()(this,"keyBackupInfo",null),i()(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new m(e),this.crossSigningCallbacks=new p,this.ssssCryptoCallbacks=new g(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,s){this.keySignatures||(this.keySignatures={});const n=this.keySignatures[e]||{};this.keySignatures[e]=n,n[t]=s}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new u(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const t=Object(c.d)(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){a.a.log(`Cache ${e} cross-signing private key locally`);const s=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,s)}await e.cryptoStore.doTxn("readwrite",[l.a.STORE_ACCOUNT],t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)})}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}class u{constructor(e,t,s,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=s,this.keySignatures=n}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){const s={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))s[e+"_key"]=t;await this.crossSigningKeys.authUpload(e=>t.uploadDeviceSigningKeys(e,s)),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[e,s]of this.accountData)await t.setAccountData(e,s);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(void 0,"PUT","/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:d.i}):await t.http.authedRequest(void 0,"POST","/room_keys/version",void 0,this.keyBackupInfo,{prefix:d.i}))}}class m extends r.EventEmitter{constructor(e){super(),this.existingValues=e,i()(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const s=this.existingValues[e];return s?s.getContent():null}setAccountData(e,t){const s=this.values.get(e);return this.values.set(e,t),Promise.resolve().then(()=>{const n=new o.b({type:e,content:t});return this.emit("accountData",n,s),{}})}}class p{constructor(){i()(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,s]of Object.entries(e))this.privateKeys.set(t,s)}}class g{constructor(e){this.delegateCryptoCallbacks=e,i()(this,"privateKeys",new Map)}async getSecretStorageKey({keys:e},t){var s;for(const t of Object.keys(e)){const e=this.privateKeys.get(t);if(e)return[t,e]}if(null!=this&&null!==(s=this.delegateCryptoCallbacks)&&void 0!==s&&s.getSecretStorageKey){const s=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(s){const[e,t]=s;this.privateKeys.set(e,t)}return s}return null}addPrivateKey(e,t,s){var n,i;this.privateKeys.set(e,s),null===(n=this.delegateCryptoCallbacks)||void 0===n||null===(i=n.cacheSecretStorageKey)||void 0===i||i.call(n,e,t,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(99),i=s.n(n),a=s(1),o=s(149),r=s(197),c=s(252);const l="m.secret_storage.v1.aes-hmac-sha2";class d{constructor(e,t,s){this.accountDataAdapter=e,this.cryptoCallbacks=t,this.baseApis=s,i()(this,"requests",new Map)}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise((t,s)=>{const n=s=>{"m.secret_storage.default_key"===s.getType()&&s.getContent().key===e&&(this.accountDataAdapter.removeListener("accountData",n),t())};this.accountDataAdapter.on("accountData",n),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch(e=>{this.accountDataAdapter.removeListener("accountData",n),s(e)})})}async addKey(e,t,s){const n={algorithm:e};if(t||(t={}),t.name&&(n.name=t.name),e!==l)throw new Error("Unknown key algorithm "+e);if(t.passphrase&&(n.passphrase=t.passphrase),t.key){const{iv:e,mac:s}=await Object(c.a)(t.key);n.iv=e,n.mac=s}if(!s)do{s=Object(r.b)(32)}while(await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s));return await this.accountDataAdapter.setAccountData("m.secret_storage.key."+s,n),{keyId:s,keyInfo:n}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return Boolean(await this.getKey(e))}async checkKey(e,t){if(t.algorithm===l){if(t.mac){const{mac:s}=await Object(c.a)(e,t.iv);return t.mac.replace(/=+$/g,"")===s.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}async store(e,t,s){const n={};if(!s){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");s=[e]}if(0===s.length)throw new Error("Zero keys given to encrypt with!");for(const i of s){const s=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+i);if(!s)throw new Error("Unknown key: "+i);if(s.algorithm===l){const a={[i]:s},[,o]=await this.getSecretStorageKey(a,e);n[i]=await o.encrypt(t)}else a.a.warn("unknown algorithm for secret storage key "+i+": "+s.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:n})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const s={};for(const e of Object.keys(t.encrypted)){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),i=t.encrypted[e];n.algorithm===l&&i.iv&&i.ciphertext&&i.mac&&(s[e]=n)}if(0===Object.keys(s).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let n,i;try{[n,i]=await this.getSecretStorageKey(s,e);const a=t.encrypted[n];return a.passthrough?Object(o.encodeBase64)(i.get_private_key()):await i.decrypt(a)}finally{i&&i.free&&i.free()}}async isStored(e,t){const s=await this.accountDataAdapter.getAccountDataFromServer(e);if(!s)return null;if(!s.encrypted)return null;void 0===t&&(t=!0);const n={};for(const e of Object.keys(s.encrypted)){const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!t)continue;const i=s.encrypted[e];t.algorithm===l&&i.iv&&i.ciphertext&&i.mac&&(n[e]=t)}return Object.keys(n).length?n:null}request(e,t){const s=this.baseApis.makeTxnId();let n,i;const o=new Promise((e,t)=>{n=e,i=t});this.requests.set(s,{name:e,devices:t,resolve:n,reject:i});const r={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:s},c={};for(const e of t)c[e]=r;return a.a.info(`Request secret ${e} from ${t}, id ${s}`),this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:c}),{requestId:s,promise:o,cancel:e=>{const n={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:s},a={};for(const e of t)a[e]=n;this.baseApis.sendToDevice("m.secret.request",{[this.baseApis.getUserId()]:a}),i(new Error(e||"Cancelled"))}}}async onRequestReceived(e){const t=e.getSender(),s=e.getContent();if(t!==this.baseApis.getUserId()||!(s.name&&s.action&&s.requesting_device_id&&s.request_id))return;const n=s.requesting_device_id;if("request_cancellation"===s.action);else if("request"===s.action){if(n===this.baseApis.deviceId)return;if(a.a.info("received request for secret ("+t+", "+n+", "+s.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,n,s.request_id,s.name,this.baseApis.checkDeviceTrust(t,n));if(e){a.a.info(`Preparing ${s.name} secret for ${n}`);const i={type:"m.secret.send",content:{request_id:s.request_id,secret:e}},r={algorithm:o.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,{[t]:[this.baseApis.getStoredDevice(t,n)]}),await o.encryptMessageForDevice(r.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,n),i);const c={[t]:{[n]:r}};a.a.info(`Sending ${s.name} secret for ${n}`),this.baseApis.sendToDevice("m.room.encrypted",c)}else a.a.info(`Request denied for ${s.name} secret for ${n}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;const t=e.getContent();a.a.log("got secret share for request",t.request_id);const s=this.requests.get(t.request_id);if(s){const n=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,e.getSenderKey());if(!n)return void a.a.log("secret share from unknown device with key",e.getSenderKey());if(!s.devices.includes(n.deviceId))return void a.a.log("unsolicited secret share from device",n.deviceId);a.a.log(`Successfully received secret ${s.name} from `+n.deviceId),s.resolve(t.secret)}}async getSecretStorageKey(e,t){if(!this.cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const s=await this.cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!s)throw new Error("getSecretStorageKey callback returned falsey");if(s.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[n,i]=s;if(!e[n])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[n].algorithm===l){return[n,{encrypt:async function(e){return await Object(c.c)(e,i,t)},decrypt:async function(e){return await Object(c.b)(e,i,t)}}]}throw new Error("Unknown key type: "+e[n].algorithm)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(99),i=s.n(n),a=s(1),o=s(94);let r;!function(e){e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend"}(r||(r={}));class c{constructor(e,t,s){this.baseApis=e,this.deviceId=t,this.cryptoStore=s,i()(this,"sendOutgoingRoomKeyRequestsTimer",null),i()(this,"sendOutgoingRoomKeyRequestsRunning",!1),i()(this,"clientRunning",!1)}start(){this.clientRunning=!0}stop(){a.a.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t,s=!1){const n=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(n)switch(n.state){case r.CancellationPendingAndWillResend:case r.Unsent:return;case r.CancellationPending:{const e=s?r.CancellationPendingAndWillResend:r.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,r.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case r.Sent:if(s){const i=r.CancellationPendingAndWillResend,o=await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,r.Sent,{state:i,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return await this.queueRoomKeyRequest(e,t,s);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(e){a.a.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+n.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:r.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case r.CancellationPending:case r.CancellationPendingAndWillResend:return;case r.Unsent:return a.a.log("deleting unnecessary room key request for "+l(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,r.Unsent);case r.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,r.Sent,{state:r.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{a.a.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()}):a.a.log("Tried to cancel room key request for "+l(e)+" but it was already cancelled in another tab")});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[r.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(r.Sent);return Promise.all(e.map(({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0)))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;this.sendOutgoingRoomKeyRequestsTimer=setTimeout(()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{a.a.warn("error in OutgoingRoomKeyRequestManager: "+e)})},500)}sendOutgoingRoomKeyRequests(){return this.clientRunning?this.cryptoStore.getOutgoingRoomKeyRequestByState([r.CancellationPending,r.CancellationPendingAndWillResend,r.Unsent]).then(e=>{if(!e)return void(this.sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case r.Unsent:t=this.sendOutgoingRoomKeyRequest(e);break;case r.CancellationPending:t=this.sendOutgoingRoomKeyRequestCancellation(e);break;case r.CancellationPendingAndWillResend:t=this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then(()=>this.sendOutgoingRoomKeyRequests()).catch(e=>{a.a.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=null})}):(this.sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}sendOutgoingRoomKeyRequest(e){a.a.log("Requesting keys for "+l(e.requestBody)+" from "+d(e.recipients)+`(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,r.Unsent,{state:r.Sent}))}sendOutgoingRoomKeyRequestCancellation(e,t=!1){a.a.log("Sending cancellation for key request for "+l(e.requestBody)+" to "+d(e.recipients)+" "+`(cancellation id ${e.cancellationTxnId})`);const s={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(s,e.recipients,e.cancellationTxnId).then(()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,r.CancellationPendingAndWillResend,{state:r.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,r.CancellationPending))}sendMessageToDevices(e,t,s){const n={};for(const s of t)n[s.userId]||(n[s.userId]={}),n[s.userId][s.deviceId]=e;return this.baseApis.sendToDevice(o.a.RoomKeyRequest,n,s)}}function l(e){return e.room_id+" / "+e.session_id}function d(e){return"["+e.map(e=>`${e.userId}:${e.deviceId}`).join(",")+"]"}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return T}));var n=s(99),i=s.n(n),a=s(425),o=s(346),r=s.n(o),c=s(289),l=s(1);const d="m.key.verification.start",h=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let u;const m=Object(c.a)("m.mismatched_sas","Mismatched short authentication string"),p=Object(c.a)("m.mismatched_commitment","Mismatched commitment");const g=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["🙂","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓️","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];const v={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>g[e])}};function f(e,t){const s={};for(const n of t)n in v&&(s[n]=v[n](e));return s}const b={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function y(e,t){return function(...s){const n=e[b[t]].apply(e,s);return l.a.log("SAS calculateMAC:",t,s,n),n}}const E={"curve25519-hkdf-sha256":function(e,t,s){const n=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|`+e.ourSASPubKey+"|",i=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,a="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+i:i+n)+e.channel.transactionId;return t.generate_bytes(a,s)},curve25519:function(e,t,s){const n=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,i=`${e.userId}${e.deviceId}`,a="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+i:i+n)+e.channel.transactionId;return t.generate_bytes(a,s)}},S=["curve25519-hkdf-sha256","curve25519"],_=["sha256"],w=["hkdf-hmac-sha256","hmac-sha256"],C=Object.keys(v),O=new Set(S),k=new Set(_),R=new Set(w),I=new Set(C);function x(e,t){return e instanceof Array?e.filter(e=>t.has(e)):[]}class T extends a.b{constructor(...t){super(...t),i()(this,"waitingForAccept",void 0),i()(this,"ourSASPubKey",void 0),i()(this,"theirSASPubKey",void 0),i()(this,"sasEvent",void 0),i()(this,"doVerification",async()=>{await e.Olm.init(),u=u||new e.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(e){if(!(e instanceof a.a))throw e;this.startEvent=e.startEvent,t=!0}}while(t)})}static get NAME(){return"m.sas.v1"}get events(){return h}canSwitchStartEvent(e){if(e.getType()!==d)return!1;const t=e.getContent();return t&&t.method===T.NAME&&this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(d,{method:T.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:S,hashes:_,message_authentication_codes:w,short_authentication_string:C});return await this.channel.sendCompleted(d,e),e}async doSendVerification(){let t,s;if(this.waitingForAccept=!0,t=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new a.a(this.startEvent);try{s=await this.waitForEvent("m.key.verification.accept")}finally{this.waitingForAccept=!1}let n=s.getContent();const i=x(n.short_authentication_string,I);if(!(O.has(n.key_agreement_protocol)&&k.has(n.hash)&&R.has(n.message_authentication_code)&&i.length))throw Object(c.g)();if("string"!=typeof n.commitment)throw Object(c.c)();const o=n.key_agreement_protocol,l=n.message_authentication_code,d=n.commitment,h=new e.Olm.SAS;try{this.ourSASPubKey=h.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey}),s=await this.waitForEvent("m.key.verification.key"),n=s.getContent();const e=n.key+r.a.stringify(t);if(u.sha256(e)!==d)throw p();this.theirSASPubKey=n.key,h.set_their_key(n.key);const a=E[o](this,h,6),g=new Promise((e,t)=>{this.sasEvent={sas:f(a,i),confirm:async()=>{try{await this.sendMAC(h,l),e()}catch(e){t(e)}},cancel:()=>t(Object(c.h)()),mismatch:()=>t(m())},this.emit("show_sas",this.sasEvent)});[s]=await Promise.all([this.waitForEvent("m.key.verification.mac").then(e=>(this.expectedEvent="m.key.verification.done",e)),g]),n=s.getContent(),await this.checkMAC(h,n,l)}finally{h.free()}}async doRespondVerification(){let t=this.channel.completedContentFromEvent(this.startEvent);const s=x(S,new Set(t.key_agreement_protocols))[0],n=x(_,new Set(t.hashes))[0],i=x(w,new Set(t.message_authentication_codes))[0],a=x(t.short_authentication_string,I);if(void 0===s||void 0===n||void 0===i||!a.length)throw Object(c.g)();const o=new e.Olm.SAS;try{const e=o.get_pubkey()+r.a.stringify(t);await this.send("m.key.verification.accept",{key_agreement_protocol:s,hash:n,message_authentication_code:i,short_authentication_string:a,commitment:u.sha256(e)});let l=await this.waitForEvent("m.key.verification.key");t=l.getContent(),this.theirSASPubKey=t.key,o.set_their_key(t.key),this.ourSASPubKey=o.get_pubkey(),await this.send("m.key.verification.key",{key:this.ourSASPubKey});const d=E[s](this,o,6),h=new Promise((e,t)=>{this.sasEvent={sas:f(d,a),confirm:async()=>{try{await this.sendMAC(o,i),e()}catch(e){t(e)}},cancel:()=>t(Object(c.h)()),mismatch:()=>t(m())},this.emit("show_sas",this.sasEvent)});[l]=await Promise.all([this.waitForEvent("m.key.verification.mac").then(e=>(this.expectedEvent="m.key.verification.done",e)),h]),t=l.getContent(),await this.checkMAC(o,t,i)}finally{o.free()}}sendMAC(e,t){const s={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,a="ed25519:"+this.baseApis.deviceId;s[a]=y(e,t)(this.baseApis.getDeviceEd25519Key(),i+a),n.push(a);const o=this.baseApis.getCrossSigningId();if(o){const a="ed25519:"+o;s[a]=y(e,t)(o,i+a),n.push(a)}const r=y(e,t)(n.sort().join(","),i+"KEY_IDS");return this.send("m.key.verification.mac",{mac:s,keys:r})}async checkMAC(e,t,s){const n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==y(e,s)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw Object(c.d)();await this.verifyKeys(this.userId,t.mac,(t,i,a)=>{if(a!==y(e,s)(i.keys[t],n+t))throw Object(c.d)()})}}}).call(this,s(26))},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(99),i=s.n(n),a=s(225),o=s(1);const r=s(94).a.RoomMessage;class c{constructor(e,t,s=null){this.client=e,this.roomId=t,this.userId=s,i()(this,"requestEventId",null)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(c.getEventType(e)!==a.j)return;const s=t.getUserId(),n=e.getSender(),i=e.getContent().to;return n===s?i:i===s?n:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===a.j}canCreateRequest(e){return c.canCreateRequest(e)}static getTransactionId(e){if(c.getEventType(e)===a.j)return e.getId();{const t=e.getRelation();if(t&&"m.reference"===t.rel_type)return t.event_id}}static validateEvent(e,t){const s=c.getTransactionId(e);if("string"!=typeof s||0===s.length)return!1;const n=c.getEventType(e),i=e.getContent();if(n===a.j){if(!i||"string"!=typeof i.to||!i.to.length)return o.a.log("InRoomChannel: validateEvent: no valid to "+(i&&i.to)),!1;if(!c.getOtherPartyUserId(e,t))return o.a.log("InRoomChannel: validateEvent: not directed to or sent by me: "+e.getSender()+", "+(i&&i.to)),!1}return a.l.validateEvent(n,e,t)}static getEventType(e){const t=e.getType();if(t===r){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===a.j)return a.j}}return t&&t!==a.j?t:""}async handleEvent(e,t,s=!1){if(t.hasEventId(e.getId()))return;const n=c.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(null===this.userId){const t=c.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const i=this.client.getUserId(),a=e.getSender();if(null!==this.userId&&a!==i&&a!==this.userId)return void o.a.log("InRoomChannel: ignoring verification event from non-participating sender "+a);null===this.requestEventId&&(this.requestEventId=c.getTransactionId(e));const r=!!e.getUnsigned().transaction_id,l=e.getSender()===this.client.getUserId();return await t.handleEvent(n,e,s,r,l)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==a.j&&e!==a.i&&e!==a.k||(t.from_device=this.client.getDeviceId()),e===a.j?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:a.j,to:this.userId,from_device:t.from_device,methods:t.methods}:t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId},t}send(e,t){const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s=e;e===a.j&&(s=r);const n=await this.client.sendEvent(this.roomId,s,t);e===a.j&&(this.requestEventId=n.event_id)}}class l{constructor(){i()(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),s=c.getTransactionId(e);return this.getRequestByTxnId(t,s)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const s=this.requestsByRoomId.get(e);if(s)return s.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,s){let n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,s)}removeRequest(e){const t=e.getRoomId(),s=this.requestsByRoomId.get(t);s&&(s.delete(c.getTransactionId(e)),0===s.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this.requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return h}));var n=s(99),i=s.n(n),a=s(197),o=s(1),r=s(225),c=s(289),l=s(117);class d{constructor(e,t,s,n=null,a=null){this.client=e,this.userId=t,this.devices=s,this.transactionId=n,this.deviceId=a,i()(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===r.j||e===r.k}canCreateRequest(e){return d.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return o.a.warn("Ignoring flagged verification request from "+e.getSender()),!1;const s=e.getContent();if(!s)return o.a.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!s.transaction_id)return o.a.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const n=e.getType();if(n===r.j){if(!Number.isFinite(s.timestamp))return o.a.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&s.from_device==t.getDeviceId())return o.a.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return r.l.validateEvent(n,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,s=!1){const n=e.getType(),i=e.getContent();if(n===r.j||n===r.i||n===r.k){this.transactionId||(this.transactionId=i.transaction_id);const e=i.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent(r.a,Object(c.b)(Object(c.f)()));return this.sendToDevices(r.a,t,[e])}}const a=t.phase===r.f||t.phase===r.d;await t.handleEvent(e.getType(),e,s,!1,!1);const o=t.phase===r.f||t.phase===r.d;if((n===r.k||n===r.i)&&!a&&o&&this.deviceId){const e=this.devices.filter(e=>e!==this.deviceId&&e!==this.client.getDeviceId());if(e.length){const t=this.completeContent(r.a,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(r.a,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==r.j&&e!==r.i&&e!==r.k||(t.from_device=this.client.getDeviceId()),e===r.j&&(t.timestamp=Date.now()),t}send(e,t={}){e!==r.j&&e!==r.k||this.transactionId||(this.transactionId=d.makeTransactionId());const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s;s=e===r.j||e===r.a&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const n=new l.b({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,n,!0,!0,!0),s}async sendToDevices(e,t,s){if(s.length){const n={};for(const e of s)n[e]=t;await this.client.sendToDevice(e,{[this.userId]:n})}}static makeTransactionId(){return Object(a.b)(32)}}class h{constructor(){i()(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const s=this.requestsByUserId.get(e);if(s)return s.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,s){let n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,s)}removeRequest(e){const t=e.getSender(),s=this.requestsByUserId.get(t);s&&(s.delete(d.getTransactionId(e)),0===s.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const s=this.requestsByUserId.get(e);if(s)for(const e of s.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter(e=>e.pending):[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(99),i=s.n(n),a=s(425);class o extends a.b{constructor(...e){super(...e),i()(this,"doVerification",async()=>{throw new Error("Verification is not possible with this method")})}static factory(e,t,s,n,i,a){return new o(e,t,s,n,i,a)}static get NAME(){return"org.matrix.illegal_method"}}},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(117);function i(e,t){const s=Boolean(t.preventReEmit),i=!1!==t.decrypt;return function(t){const a=new n.b(t);return a.isEncrypted()&&(s||e.reEmitter.reEmit(a,["Event.decrypted"]),i&&e.decryptEventIfNeeded(a)),s||e.reEmitter.reEmit(a,["Event.replaced"]),a}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(99),i=s.n(n),a=s(1);class o{constructor(){i()(this,"audioInput",void 0),i()(this,"videoInput",void 0),i()(this,"userMediaStreams",[]),i()(this,"screensharingStreams",[])}setAudioInput(e){this.audioInput=e}setVideoInput(e){this.videoInput=e}async hasAudioDevice(){return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind).length>0}async hasVideoDevice(){return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind).length>0}async getUserMediaStream(e,t){const s=e&&await this.hasAudioDevice(),n=t&&await this.hasVideoDevice();let i;const o=this.userMediaStreams.find(e=>s===e.getAudioTracks().length>0&&n===e.getVideoTracks().length>0);if(o)a.a.log("Cloning user media stream",o.id),i=o.clone();else{const e=this.getUserMediaContraints(s,n);a.a.log("Getting user media with constraints",e),i=await navigator.mediaDevices.getUserMedia(e)}return this.userMediaStreams.push(i),i}stopUserMediaStream(e){a.a.debug("Stopping usermedia stream",e.id);for(const t of e.getTracks())t.stop();const t=this.userMediaStreams.indexOf(e);-1!==t&&(a.a.debug("Splicing usermedia stream out stream array",e.id),this.userMediaStreams.splice(t,1))}async getScreensharingStream(e){let t;if(0===this.screensharingStreams.length){const s=this.getScreenshareContraints(e);if(!s)return null;e?(a.a.debug("Getting screensharing stream using getUserMedia()",e),t=await navigator.mediaDevices.getUserMedia(s)):(a.a.debug("Getting screensharing stream using getDisplayMedia()"),t=await navigator.mediaDevices.getDisplayMedia(s))}else{const e=this.screensharingStreams[this.screensharingStreams.length-1];a.a.log("Cloning screensharing stream",e.id),t=e.clone()}return this.screensharingStreams.push(t),t}stopScreensharingStream(e){a.a.debug("Stopping screensharing stream",e.id);for(const t of e.getTracks())t.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(a.a.debug("Splicing screensharing stream out stream array",e.id),this.screensharingStreams.splice(t,1))}stopAllStreams(){for(const e of this.userMediaStreams)for(const t of e.getTracks())t.stop();for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[]}getUserMediaContraints(e,t){const s=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:s?{exact:640}:{ideal:640},height:s?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){return e?(a.a.debug("Using desktop capturer source",e),{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}}}):(a.a.debug("Not using desktop capturer source"),{audio:!1,video:!0})}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,function(e,t){e.exports="img/element-desktop-logo.7bf805d.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(107),c=s(84),l=s(1);class d extends o.a.Component{constructor(...e){super(...e),i()(this,"unmounted",!1),i()(this,"state",{component:null,error:null}),i()(this,"onWrapperCancelClick",()=>{this.props.onFinished(!1)})}componentDidMount(){l.a.log("Starting load of AsyncWrapper for modal"),this.props.prom.then(e=>{if(this.unmounted)return;const t=e.default?e.default:e;this.setState({component:t})}).catch(e=>{l.a.warn("AsyncWrapper promise failed",e),this.setState({error:e})})}componentWillUnmount(){this.unmounted=!0}render(){if(this.state.component){const e=this.state.component;return o.a.createElement(e,this.props)}if(this.state.error){const e=r.getComponent("views.dialogs.BaseDialog"),t=r.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{onFinished:this.props.onFinished,title:Object(c.a)("Error")},Object(c.a)("Unable to load! Check your network connectivity and try again."),o.a.createElement(t,{primaryButton:Object(c.a)("Dismiss"),onPrimaryButtonClick:this.onWrapperCancelClick,hasCancel:!1}))}{const e=r.getComponent("elements.Spinner");return o.a.createElement(e,null)}}}},function(e,t,s){e.exports=function(){return new Worker(s.p+"05696921702f00f07648.worker.js")}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/download.dc05f15.svg"},,,function(e,t,s){e.exports=function(){return new Worker(s.p+"df68b9f4f43f094f5acf.worker.js")}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return m}));var n=s(86),i=s(268),a=s(152),o=s(154),r=s(308),c=s(238),l=s(93),d=s(1);function h(){var e;return l.a.get().widget_build_url?l.a.get().widget_build_url:null===(e=Object(i.b)())||void 0===e?void 0:e.widget_build_url}function u(){return!!h()}async function m(e){const t=n.a.get().getRoom(e);if(!t)return;if(!a.a.canUserModifyWidgets(e))return void d.a.error("User not allowed to modify widgets in "+e);const s=h();if(!s)return;let i;try{const t=await fetch(`${s}?roomId=${e}`);i=await t.json()}catch(t){return void d.a.error("Managed hybrid widget builder failed for room "+e,t)}if(!i)return;const{widget_id:l,widget:u,layout:m}=i;let p=c.a.instance.getApps(e);if(p.some(e=>e.id===l)||r.a.roomHasPendingWidgets(e,[]))return void d.a.error("Managed hybrid widget already present in room "+e);try{await a.a.setRoomWidgetContent(e,l,u)}catch(t){return void d.a.error("Unable to add managed hybrid widget in room "+e,t)}if(!o.d.instance.canCopyLayoutToRoom(t))return;p=c.a.instance.getApps(e);const g=p.find(e=>e.id===l);g&&(o.d.instance.moveToContainer(t,g,m.container),o.d.instance.setContainerHeight(t,m.container,m.height),o.d.instance.copyLayoutToRoom(t))}},function(e,t){e.exports="img/plus.53bc1d6.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/social/facebook.d547f79.png"},function(e,t){e.exports="img/social/twitter-2.6517b36.png"},function(e,t){e.exports="img/social/linkedin.ab157f6.png"},function(e,t){e.exports="img/social/reddit.eeab8e6.png"},function(e,t){e.exports="img/social/email-1.1134895.png"},,,,,,,,,,function(e,t,s){e.exports=s.p+"recorder-worklet.7602083.js"},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(83),i=s.n(n),a=s(1520),o=s(106),r=s(185);class c{constructor(e){this.store=e,i()(this,"filter",new a.a),i()(this,"activeSpace",o.a.instance.activeSpace),i()(this,"allRoomsInHome",o.a.instance.allRoomsInHome),i()(this,"onSelectedSpaceUpdated",(e,t=this.allRoomsInHome)=>{if(e===this.activeSpace&&t===this.allRoomsInHome)return;const s=c.needsFilter(this.activeSpace,this.allRoomsInHome),n=c.needsFilter(e,t);this.activeSpace=e,this.allRoomsInHome=t,n&&this.updateFilter(),!s&&n?this.store.addFilter(this.filter):s&&!n&&this.store.removeFilter(this.filter)}),i()(this,"onHomeBehaviourUpdated",e=>{this.onSelectedSpaceUpdated(this.activeSpace,e)}),i()(this,"updateFilter",()=>{"!"===this.activeSpace[0]&&o.a.instance.traverseSpace(this.activeSpace,e=>{var t,s;null===(t=this.store.matrixClient)||void 0===t||null===(s=t.getRoom(e))||void 0===s||s.loadMembersIfNeeded()}),this.filter.updateSpace(this.activeSpace)}),c.needsFilter(this.activeSpace,this.allRoomsInHome)&&(this.updateFilter(),e.addFilter(this.filter)),o.a.instance.on(r.d,this.onSelectedSpaceUpdated),o.a.instance.on(r.b,this.onHomeBehaviourUpdated)}static needsFilter(e,t){return!(e===r.a.Home&&t)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return d}));var n=s(83),i=s.n(n),a=s(5),o=s(298),r=s(106),c=s(185),l=s(459);class d extends a.EventEmitter{constructor(...t){super(...t),i()(this,"roomIds",new Set),i()(this,"space",c.a.Home),i()(this,"onStoreUpdate",async()=>{const t=this.roomIds;this.roomIds=new Set(r.a.instance.getSpaceFilteredRoomIds(this.space)),Object(l.a)(t,this.roomIds)&&(this.emit(o.a),e(()=>{this.emit(o.a)}))})}get kind(){return o.b.Prefilter}isVisible(e){return this.roomIds.has(e.roomId)}updateSpace(e){r.a.instance.off(this.space,this.onStoreUpdate),r.a.instance.on(this.space=e,this.onStoreUpdate),this.onStoreUpdate()}destroy(){r.a.instance.off(this.space,this.onStoreUpdate)}}}).call(this,s(175).setImmediate)},,function(e,t,s){"use strict";function n(){window.TouchEvent||(window.TouchEvent=class extends UIEvent{get altKey(){return!1}get changedTouches(){return[]}get ctrlKey(){return!1}get metaKey(){return!1}get shiftKey(){return!1}get targetTouches(){return[]}get touches(){return[]}get rotation(){return 0}get scale(){return 0}constructor(e,t){super(e,t)}})}s.d(t,"a",(function(){return n}))},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/icon-pill-remove.caaa0c9.svg"},function(e,t){e.exports="img/element-icons/info.dc07e19.svg"},function(e,t,s){"use strict";var n=s(83),i=s.n(n),a=s(86),o=s(87),r=s(274),c=s(1);var l;!function(e){e.Online="online",e.Offline="offline",e.Unavailable="unavailable"}(l||(l={}));t.a=new class{constructor(){i()(this,"unavailableTimer",null),i()(this,"dispatcherRef",null),i()(this,"state",null),i()(this,"onAction",e=>{"user_activity"===e.action&&(this.setState(l.Online),this.unavailableTimer.restart())})}async start(){for(this.unavailableTimer=new r.a(18e4),this.dispatcherRef=o.a.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(l.Unavailable)}catch(e){}}stop(){this.dispatcherRef&&(o.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.unavailableTimer&&(this.unavailableTimer.abort(),this.unavailableTimer=null)}getState(){return this.state}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!a.a.get().isGuest())try{await a.a.get().setPresence({presence:this.state}),c.a.info("Presence:",e)}catch(e){c.a.error("Failed to set presence:",e),this.state=t}}}},function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-colr.8aee240.woff2"},function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.293e5ba.woff2"},function(e,t){e.exports="img/e2e/verified.5be6c9f.svg"},,,function(e,t){e.exports="img/element-icons/roomlist/dark-light-mode.f72b785.svg"},function(e,t){e.exports="img/element-icons/room/default_app.2034d23.svg"},function(e,t){e.exports="img/element-icons/room/default_video.66250a4.svg"},function(e,t){e.exports="img/element-icons/room/default_cal.13af0ea.svg"},function(e,t){e.exports="img/element-icons/room/default_doc.02ee63f.svg"},function(e,t){e.exports="img/element-icons/room/default_clock.e9b2247.svg"},,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return f})),s.d(t,"a",(function(){return b}));var n=s(609),i=s(94),a=s(247),o=s(86);async function r(e,t){const s=o.a.get(),i={limit:10};void 0!==t&&(i.rooms=[t]);const a={search_categories:{room_events:{search_term:e,filter:i,order_by:n.a.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await s.search({body:a}),query:a}}async function c(e,t){const s=o.a.get(),n=await r(e,t),i={_query:n.query,results:[],highlights:[]};return s.processRoomEventsSearch(i,n.response)}function l(e,t){const s=e.result,n=t.result;return s.origin_server_ts>n.origin_server_ts?-1:s.origin_server_ts<n.origin_server_ts?1:0}async function d(e,t,s=!0){const n=a.a.get(),i={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(i.room_id=t);const o=await n.search(i);i.next_batch=o.next_batch;return{response:o,query:i}}function h(e,t){try{const s=e[e.length-1].result,n=t[t.length-1].result;return s.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function u(e,t,s,n){const i=s.concat(n).sort(l);t.results=i.slice(0,10),e.cachedEvents=i.slice(10)}function m(e,t,s){const n=function(e,t,s){const n={},i=e.cachedEvents;let a=e.oldestEventFrom;return n.highlights=e.highlights,t&&s&&s.results?(h(t.results,s.results)<0&&(a="local"),u(e,n,t.results,s.results),n.highlights=t.highlights.concat(s.highlights)):t?(h(t.results,i)<0&&(a="local"),u(e,n,t.results,i)):s&&s.results?(h(s.results,i)<0&&(a="server"),u(e,n,s.results,i)):(n.results=i,e.cachedEvents=[]),e.oldestEventFrom=a,n}(e,t,s);return e.count?n.count=e.count:n.count=t.count+s.count,t&&(e.seshatQuery.next_batch=t.next_batch),s&&(e.serverSideNextBatch=s.next_batch),e.seshatQuery.next_batch?n.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(n.next_batch=e.serverSideNextBatch),!n.next_batch&&e.cachedEvents.length>0&&(n.next_batch="cached"),n}function p(e=[]){for(let t=0;t<e.length;t++){const s=e[t].context.getTimeline();for(let e=0;e<s.length;e++){const t=s[e],n=t.event;n.curve25519Key&&(t.makeEncrypted(i.a.RoomMessageEncrypted,{algorithm:n.algorithm},n.curve25519Key,n.ed25519Key),t.forwardingCurve25519KeyChain=n.forwardingCurve25519KeyChain,delete n.curve25519Key,delete n.ed25519Key,delete n.algorithm,delete n.forwardingCurve25519KeyChain)}}}function g(e,t){let s;return s=void 0!==t?o.a.get().isRoomEncrypted(t)?async function(e,t){const s={results:[],highlights:[]};if(""===e)return s;const n=await d(e,t);s.seshatQuery=n.query;const i={search_categories:{room_events:n.response}},a=o.a.get().processRoomEventsSearch(s,i);return p(a.results),a}(e,t):c(e,t):async function(e){const t=o.a.get(),s=r(e),n=d(e);await Promise.all([s,n]);const i=await n,a=await s,c=a.query,l=a.response,h=i.query,u=i.response,g={seshatQuery:h,_query:c,serverSideNextBatch:l.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},v={search_categories:{room_events:m(g,u,l.search_categories.room_events)}},f=t.processRoomEventsSearch(g,v);return p(f.results),f}(e),s}function v(e){const t=o.a.get(),s=e.seshatQuery,n=e._query;if(s){if(n){const t=async function(e){const t=a.a.get(),s=o.a.get(),n=e.seshatQuery,i=e.oldestEventFrom;let r,c,l;if(!n.next_batch||e.serverSideNextBatch&&"server"!==i||(r=await t.search(n)),e.serverSideNextBatch&&("local"===i||!n.next_batch)){const t={body:e._query,next_batch:e.serverSideNextBatch};c=await s.search(t)}c&&(l=c.search_categories.room_events);const d={search_categories:{room_events:m(e,r,l)}},h=e.results?e.results.length:0,u=s.processRoomEventsSearch(e,d),g=u.results.length-h;return p(u.results.slice(Math.max(u.results.length-g,0))),e.pendingRequest=null,u}(e);return e.pendingRequest=t,t}{const t=async function(e){const t=a.a.get(),s=e.seshatQuery,n=await t.search(s);e.seshatQuery.next_batch=n.next_batch;const i=n.results.length,r={search_categories:{room_events:n}},c=o.a.get().processRoomEventsSearch(e,r);return p(c.results.slice(Math.max(c.results.length-i,0))),e.pendingRequest=null,c}(e);return e.pendingRequest=t,t}}return t.backPaginateRoomEventsSearch(e)}function f(e){const t=a.a.get(),s=o.a.get();return e.pendingRequest?e.pendingRequest:null===t?s.backPaginateRoomEventsSearch(e):v(e)}function b(e,t){return null===a.a.get()?c(e,t):g(e,t)}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return I}));var n=s(83),i=s.n(n),a=s(82),o=s.n(a),r=s(148),c=s.n(r),l=s(567),d=s(103),h=s(117),u=s(1601),m=s(133),p=s(568),g=s(136),v=s(120),f=s(84),b=s(94),y=s(199),E=s(134),S=s(332),_=s(125),w=s(1603),C=s(98),O=s(1604),k=s(255),R=s(1);class I extends l.a{constructor(e,t,s,n){super(e,t,s,n),i()(this,"avatars",void 0),i()(this,"permalinkCreator",void 0),i()(this,"totalSize",void 0),i()(this,"mediaOmitText",void 0),this.avatars=new Map,this.permalinkCreator=new v.a(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?Object(f.a)("Media omitted - file size limit exceeded"):Object(f.a)("Media omitted")}async getRoomAvatar(){let e;const t=y.b(this.room,32,32,"crop");if(t)try{const s=await fetch(t);e=await s.blob(),this.totalSize+=e.size,this.addFile("room.png",e)}catch(e){R.a.log("Failed to fetch room's avatar"+e)}const s=o.a.createElement(_.a,{width:32,height:32,name:this.room.name,title:this.room.name,url:e?"room.png":null,resizeMethod:"crop"});return Object(u.renderToStaticMarkup)(s)}async wrapHTML(e){var t,s,n,i,a,r,c;const l=await this.getRoomAvatar(),d=Object(g.e)(new Date),h=null===(t=this.room.currentState.getStateEvents(b.a.RoomCreate,""))||void 0===t?void 0:t.getSender(),m=(null===(s=this.room)||void 0===s||null===(n=s.getMember(h))||void 0===n?void 0:n.rawDisplayName)||h,p=this.client.getUserId(),v=null===(i=this.room)||void 0===i||null===(a=i.getMember(p))||void 0===a?void 0:a.rawDisplayName,y=(null===(r=this.room.currentState.getStateEvents(b.a.RoomTopic,""))||void 0===r||null===(c=r.getContent())||void 0===c?void 0:c.topic)||"",E=Object(f.a)("%(creatorName)s created this room.",{creatorName:m}),S=Object(u.renderToStaticMarkup)(o.a.createElement("p",null,Object(f.a)("This is the start of export of <roomName/>. Exported by <exporterDetails/> at %(exportDate)s.",{exportDate:d},{roomName:()=>o.a.createElement("b",null,this.room.name),exporterDetails:()=>o.a.createElement("a",{href:"https://matrix.to/#/"+p,target:"_blank",rel:"noopener noreferrer"},v?o.a.createElement(o.a.Fragment,null,o.a.createElement("b",null,v)," ("+p+")"):o.a.createElement("b",null,p))}))),_=y?Object(f.a)("Topic: %(topic)s",{topic:y}):"";return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>Exported Data</title>\n            </head>\n            <body style="height: 100vh;">\n                <section\n                id="matrixchat"\n                style="height: 100%; overflow: auto"\n                class="notranslate"\n                >\n                <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                    <div class="mx_MatrixChat">\n                    <main class="mx_RoomView">\n                        <div class="mx_RoomHeader light-panel">\n                        <div class="mx_RoomHeader_wrapper" aria-owns="mx_RightPanel">\n                            <div class="mx_RoomHeader_avatar">\n                            <div class="mx_DecoratedRoomAvatar">\n                               ${l}\n                            </div>\n                            </div>\n                            <div class="mx_RoomHeader_name">\n                            <div\n                                dir="auto"\n                                class="mx_RoomHeader_nametext"\n                                title="${this.room.name}"\n                            >\n                                ${this.room.name}\n                            </div>\n                            </div>\n                            <div class="mx_RoomHeader_topic" dir="auto"> ${y} </div>\n                        </div>\n                        </div>\n                        <div class="mx_MainSplit">\n                        <div class="mx_RoomView_body">\n                            <div\n                            class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                            >\n                            <div\n                                class="\n                                mx_AutoHideScrollbar\n                                mx_ScrollPanel\n                                mx_RoomView_messagePanel\n                                mx_GroupLayout\n                                "\n                            >\n                                <div class="mx_RoomView_messageListWrapper">\n                                <ol\n                                    class="mx_RoomView_MessageList"\n                                    aria-live="polite"\n                                    role="list"\n                                >\n                                <div class="mx_NewRoomIntro">\n                                    ${l}\n                                    <h2> ${this.room.name} </h2>\n                                    <p> ${E} <br/><br/> ${S} </p>\n                                    <br/>\n                                    <p> ${_} </p>\n                                </div>\n                                ${e}\n                                </ol>\n                                </div>\n                            </div>\n                            </div>\n                            <div class="mx_RoomView_statusArea">\n                            <div class="mx_RoomView_statusAreaBox">\n                                <div class="mx_RoomView_statusAreaBox_line"></div>\n                            </div>\n                            </div>\n                        </div>\n                        </div>\n                    </main>\n                    </div>\n                </div>\n                </section>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender;return t.getMxcAvatarUrl()&&Object(d.b)(t.getMxcAvatarUrl()).getThumbnailOfSourceHttp(30,30,"crop")}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const s=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const n=await fetch(s),i=await n.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,i)}catch(e){R.a.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),s=o.a.createElement("li",{key:t},o.a.createElement(S.a,{forExport:!0,key:t,ts:t}));return Object(u.renderToStaticMarkup)(s)}needsDateSeparator(e,t){return null==t||Object(g.k)(t.getDate(),e.getDate())}getEventTile(e,t){return o.a.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},o.a.createElement(C.a.Provider,{value:this.client},o.a.createElement(E.b,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,readReceipts:null,alwaysShowTimestamps:!0,readReceiptMap:null,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,getRelationsForEvent:null,showReactions:!1,layout:m.a.Group,enableFlair:!1,showReadReceipts:!1})))}async getEventTileMarkup(e,t,s){const n=!!this.getAvatarURL(e);n&&await this.saveAvatarIfNeeded(e);const i=this.getEventTile(e,t);let a;if(e.getContent().msgtype==b.b.Emote||e.getContent().msgtype==b.b.Notice||e.getContent().msgtype===b.b.Text){const e=document.createElement("div");c.a.render(i,e),a=e.innerHTML}else a=Object(u.renderToStaticMarkup)(i);if(s){var o;const t=e.getContent().url||(null===(o=e.getContent().file)||void 0===o?void 0:o.url);a=a.split(t).join(s)}return a=a.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),n&&(a=a.replace(encodeURI(this.getAvatarURL(e)).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),a}createModifiedEvent(e,t,s=!0){const n={msgtype:"m.text",body:""+e,format:"org.matrix.custom.html",formatted_body:""+e};s&&(n.formatted_body="<em>"+n.formatted_body+"</em>",n.body="*"+n.body+"*");const i=new h.b;return i.event=t.event,i.sender=t.sender,i.event.type="m.room.message",i.event.content=n,i}async createMessageBody(e,t=!1){let s;try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const n=await this.getMediaBlob(e);if(this.totalSize+n.size>this.exportOptions.maxSize)s=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else{this.totalSize+=n.size;const i=this.getFilePath(e);s=await this.getEventTileMarkup(e,t,i),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(i,n)}}catch(n){R.a.log("Error while fetching file"+n),s=await this.getEventTileMarkup(this.createModifiedEvent(Object(f.a)("Error fetching file"),e),t)}else s=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),t);else s=await this.getEventTileMarkup(e,t)}catch(n){R.a.error(n),s=await this.getEventTileMarkup(this.createModifiedEvent(Object(k.b)(e),e,!1),t)}return s}async createHTML(t,s){let n="",i=null;for(let a=s;a<Math.min(s+1e3,t.length);a++){const s=t[a];if(this.updateProgress(`Processing event ${a+1} out of ${t.length}`,!1,!0),this.cancelled)return this.cleanUp();if(!Object(E.d)(s))continue;n+=this.needsDateSeparator(s,i)?this.getDateSeparator(s):"";const o=!this.needsDateSeparator(s,i)&&Object(p.b)(i,s,!1),r=await this.createMessageBody(s,o);this.totalSize+=e.byteLength(r),n+=r,i=s}return await this.wrapHTML(n)}async export(){this.updateProgress("Starting export...");const e=performance.now(),t=await this.getRequiredEvents(),s=performance.now();this.updateProgress(`Fetched ${t.length} events in ${(s-e)/1e3}s`,!0,!1),this.updateProgress("Creating HTML...");for(let e=0;e<t.length/1e3;e++){const s=await this.createHTML(t,1e3*e);this.addFile(`messages${e?e+1:""}.html`,new Blob([s]))}const n=await Object(O.a)();this.addFile("css/style.css",new Blob([n])),this.addFile("js/script.js",new Blob([w.a])),await this.downloadZIP();const i=performance.now();this.cancelled?R.a.info("Export cancelled successfully"):(this.updateProgress("Export successful!"),this.updateProgress(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}}).call(this,s(27).Buffer)},,,function(e,t,s){"use strict";t.a='/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the "License");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\nfunction showToastIfNeeded(replyId) {\n    const el = document.getElementById(replyId);\n    if (!el) {\n        showToast("The message you\'re looking for wasn\'t exported");\n        return;\n    }\n}\n\nfunction showToast(text) {\n    const el = document.getElementById("snackbar");\n    el.innerHTML = text;\n    el.className = "mx_show";\n    setTimeout(() => {\n        el.className = el.className.replace("mx_show", "");\n    }, 2000);\n}\n\nwindow.onload = () => {\n    document.querySelectorAll(\'.mx_reply_anchor\').forEach(element => {\n        element.addEventListener(\'click\', event => {\n            showToastIfNeeded(event.target.getAttribute("scroll-to"));\n        });\n    });\n};\n\n'},function(e,t,s){"use strict";var n=s(1605);t.a=async()=>{const e=[];document.querySelectorAll('link[rel="stylesheet"]').forEach(t=>{(t.href.endsWith("bundle.css")||t.href.endsWith("theme-light.css"))&&e.push(t.href)});let t="";for(const s of e){const e=await fetch(s);t+=await e.text()}return t=t.replace(/@font-face {.*?}/gs,""),t=t.replace(/font-family: (Inter|'Inter')/g,"font-family: -apple-system, BlinkMacSystemFont, avenir next, \n        avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif"),t=t.replace(/font-family: Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace"),t+n.a}},,function(e,t){e.exports="img/stickerpack-placeholder.9c54c13.png"},function(e,t){e.exports="img/feather-customised/files.d6a33b8.svg"},function(e,t){e.exports="img/room_replaced.87c2568.svg"},function(e,t,s){"use strict";var n=s(83),i=s.n(n);class a{constructor(){i()(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new a),t.a=window.mxRoomScrollStateStore},function(e,t,s){var n={"./":[220,9],"./ICanvasEffect":[1022,7,7],"./ICanvasEffect.ts":[1022,7,7],"./confetti":[409,9,0],"./confetti/":[409,9,0],"./confetti/index":[409,9,0],"./confetti/index.ts":[409,9,0],"./effect":[1023,9,8],"./effect.ts":[1023,9,8],"./fireworks":[410,9,1],"./fireworks/":[410,9,1],"./fireworks/index":[410,9,1],"./fireworks/index.ts":[410,9,1],"./index":[220,9],"./index.ts":[220,9],"./rainfall":[411,9,2],"./rainfall/":[411,9,2],"./rainfall/index":[411,9,2],"./rainfall/index.ts":[411,9,2],"./snowfall":[412,9,3],"./snowfall/":[412,9,3],"./snowfall/index":[412,9,3],"./snowfall/index.ts":[412,9,3],"./spaceinvaders":[413,9,4],"./spaceinvaders/":[413,9,4],"./spaceinvaders/index":[413,9,4],"./spaceinvaders/index.ts":[413,9,4],"./utils":[329,9],"./utils.ts":[329,9]};function i(e){if(!s.o(n,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],i=t[0];return Promise.all(t.slice(2).map(s.e)).then((function(){return s.t(i,t[1])}))}i.keys=function(){return Object.keys(n)},i.id=1610,e.exports=i},function(e,t){e.exports="img/upload-big.f4f6b61.svg"},function(e,t){e.exports="img/icons-groups.2e501f9.svg"},function(e,t){e.exports="img/icons-room-add.bd36e26.svg"},function(e,t){e.exports="img/camera.6a0fced.svg"},function(e,t){e.exports="img/element-icons/brands/apple.51cd154.svg"},function(e,t){e.exports="img/element-icons/brands/facebook.c3243cf.svg"},function(e,t){e.exports="img/element-icons/brands/github.bf60283.svg"},function(e,t){e.exports="img/element-icons/brands/gitlab.d4ee177.svg"},function(e,t){e.exports="img/element-icons/brands/google.04f5e48.svg"},function(e,t){e.exports="img/element-icons/brands/twitter.892d1c7.svg"},function(e,t,s){"use strict";t.a={}},function(e,t){e.exports="img/icon-email-user.af133ff.svg"},function(e,t){e.exports="img/icon-address-delete.40c8a04.svg"},,,function(e,t){e.exports="img/icons-show-stickers.72da54e.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return B}));var n,i,a,o=s(83),r=s.n(o),c=s(82),l=s.n(c),d=s(148),h=s.n(d),u=s(740),m=s.n(u),p=s(94),g=s(138),v=s(136),f=s(90),b=s(87),y=s(84),E=s(105),S=s(89),_=s(234),w=s(1016),C=s(201),O=s(120),k=s(143),R=s(111),I=s(85),x=s(139),T=s(92),j=s(314),N=s(1017),P=s(113),D=s(1015),M=s(1018),A=s(1019),U=s(118);function L(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function F(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?L(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):L(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let B=Object(I.a)("views.messages.TextualBody")((a=i=class extends l.a.Component{constructor(t){super(t),r()(this,"contentRef",Object(c.createRef)()),r()(this,"unmounted",!1),r()(this,"pills",[]),r()(this,"context",void 0),r()(this,"onCancelClick",()=>{this.setState({widgetHidden:!0}),e.localStorage&&e.localStorage.setItem("hide_preview_"+this.props.mxEvent.getId(),"1"),this.forceUpdate()}),r()(this,"onEmoteSenderClick",()=>{const e=this.props.mxEvent;b.a.dispatch({action:T.a.ComposerInsert,userId:e.getSender(),timelineRenderingType:this.context.timelineRenderingType})}),r()(this,"getEventTileOps",()=>({isWidgetHidden:()=>this.state.widgetHidden,unhideWidget:()=>{this.setState({widgetHidden:!1}),e.localStorage&&e.localStorage.removeItem("hide_preview_"+this.props.mxEvent.getId())}})),r()(this,"onStarterLinkClick",(e,t)=>{t.preventDefault();const s=C.a.sharedInstance();if(!s.hasManager())return void s.openNoManagerDialog();const n=s.getPrimaryManager(),i=n.getScalarClient();i.connect().then(()=>{const t=i.getStarterLink(e),s=n.uiUrl;f.a.createTrackedDialog("Add an integration","",P.a,{title:Object(y.a)("Add an Integration"),description:l.a.createElement("div",null,Object(y.a)("You are about to be taken to a third-party site so you can authenticate your account for use with %(integrationsUrl)s. Do you wish to continue?",{integrationsUrl:s})),button:Object(y.a)("Continue"),onFinished(e){if(!e)return;const s=window.screen.width>1024?1024:window.screen.width,n=window.screen.height>800?800:window.screen.height,i=(window.screen.width-s)/2,a=`height=${n}, width=${s}, top=${(window.screen.height-n)/2}, left=${i},`;window.open(t,"_blank",a).opener=null}})})}),r()(this,"openHistoryDialog",async()=>{f.a.createDialog(D.a,{mxEvent:this.props.mxEvent})}),this.state={links:[],widgetHidden:!1}}componentDidMount(){this.props.editState||this.applyFormatting()}applyFormatting(){const e=S.b.getValue("showCodeLineNumbers");if(this.activateSpoilers([this.contentRef.current]),Object(w.a)([this.contentRef.current],this.props.mxEvent,this.pills),g.g(this.contentRef.current),this.calculateUrlPreview(),"org.matrix.custom.html"===this.props.mxEvent.getContent().format){const t=h.a.findDOMNode(this).getElementsByTagName("pre");if(t.length>0)for(let s=0;s<t.length;s++){if("mx_EventTile_pre_container"==t[s].parentElement.className)continue;0==t[s].getElementsByTagName("code").length&&this.addCodeElement(t[s]);const n=this.wrapInDiv(t[s]);this.handleCodeBlockExpansion(t[s]),this.addCodeExpansionButton(n,t[s]),this.addCodeCopyButton(n),e&&this.addLineNumbers(t[s])}const s=h.a.findDOMNode(this).getElementsByTagName("code");s.length>0&&setTimeout(()=>{if(!this.unmounted)for(let e=0;e<s.length;e++)this.highlightCode(s[e])},10)}}addCodeElement(e){const t=document.createElement("code");t.append(...e.childNodes),e.appendChild(t)}addCodeExpansionButton(e,t){if(Math.round(t.offsetHeight/x.b.instance.windowHeight*100)<30)return;const s=document.createElement("span");s.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?s.className+="mx_EventTile_expandButton":s.className+="mx_EventTile_collapseButton",s.onclick=async()=>{s.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?(t.className="",s.className+="mx_EventTile_collapseButton"):(t.className="mx_EventTile_collapsedCodeBlock",s.className+="mx_EventTile_expandButton"),this.props.onHeightChanged()},e.appendChild(s)}addCodeCopyButton(e){const t=document.createElement("span");t.className="mx_EventTile_button mx_EventTile_copyButton ";e.getElementsByClassName("mx_EventTile_button").length>0&&(t.className+="mx_EventTile_buttonBottom"),t.onclick=async()=>{const e=t.parentElement.getElementsByTagName("code")[0],s=await Object(k.c)(e.textContent),n=t.getBoundingClientRect(),{close:i}=E.m(j.a,F(F({},Object(E.o)(n,2)),{},{message:s?Object(y.a)("Copied!"):Object(y.a)("Failed to copy")}));t.onmouseleave=i},e.appendChild(t)}wrapInDiv(e){const t=document.createElement("div");return t.className="mx_EventTile_pre_container",t.dir="auto",e.parentNode.replaceChild(t,e),t.appendChild(e),t}handleCodeBlockExpansion(e){S.b.getValue("expandCodeByDefault")||(e.className="mx_EventTile_collapsedCodeBlock")}addLineNumbers(e){const t=e.innerHTML.replace(/\n(<\/code>)?$/,"").split(/\n/).length,s=document.createElement("span");s.className="mx_EventTile_lineNumbers";for(let e=1;e<=t;e++){const t=document.createElement("span");t.textContent=e.toString(),s.appendChild(t)}e.prepend(s),e.append(document.createElement("span"))}highlightCode(e){if(e.textContent.length>4096)return void console.log("Code block is bigger than highlight limit ("+e.textContent.length+" > 4096): not highlighting");let t;for(const s of e.className.split(/\s+/))if(s.startsWith("language-")){const e=s.split("-",2)[1];if(m.a.getLanguage(e)){t=e;break}}t?e.innerHTML=m.a.highlight(t,e.textContent).value:S.b.getValue("enableSyntaxHighlightLanguageDetection")&&e.parentElement instanceof HTMLPreElement&&(e.innerHTML=m.a.highlightAuto(e.textContent).value)}componentDidUpdate(e){if(!this.props.editState){const t=e.editState&&!this.props.editState;(e.replacingEventId!==this.props.replacingEventId||t)&&this.applyFormatting()}}componentWillUnmount(){this.unmounted=!0,Object(w.b)(this.pills)}shouldComponentUpdate(e,t){return e.mxEvent.getId()!==this.props.mxEvent.getId()||e.highlights!==this.props.highlights||e.replacingEventId!==this.props.replacingEventId||e.highlightLink!==this.props.highlightLink||e.showUrlPreview!==this.props.showUrlPreview||e.editState!==this.props.editState||t.links!==this.state.links||t.widgetHidden!==this.state.widgetHidden}calculateUrlPreview(){if(this.props.showUrlPreview){let e=this.findLinks([this.contentRef.current]);if(e.length){if(e=Array.from(new Set(e)),this.setState({links:e}),window.localStorage){const e=!!window.localStorage.getItem("hide_preview_"+this.props.mxEvent.getId());this.setState({widgetHidden:e})}}else this.state.links.length&&this.setState({links:[]})}}activateSpoilers(e){let t=e[0];for(;t;){if("SPAN"===t.tagName&&"string"==typeof t.getAttribute("data-mx-spoiler")){const e=document.createElement("span"),s=t.getAttribute("data-mx-spoiler");t.removeAttribute("data-mx-spoiler");const n=l.a.createElement(N.a,{reason:s,contentHtml:t.outerHTML});h.a.render(n,e),t.parentNode.replaceChild(e,t),t=e}t.childNodes&&t.childNodes.length&&this.activateSpoilers(t.childNodes),t=t.nextSibling}}findLinks(e){let t=[];for(let s=0;s<e.length;s++){const n=e[s];if("A"===n.tagName&&n.getAttribute("href"))this.isLinkPreviewable(n)&&t.push(n.getAttribute("href"));else{if("PRE"===n.tagName||"CODE"===n.tagName||"BLOCKQUOTE"===n.tagName)continue;n.children&&n.children.length&&(t=t.concat(this.findLinks(n.children)))}}return t}isLinkPreviewable(e){if(!e.getAttribute("href").startsWith("http://")&&!e.getAttribute("href").startsWith("https://"))return!1;if(e.textContent.indexOf("/")>-1)return!0;{const t=e.getAttribute("href").match(/^https?:\/\/(.*?)(\/|$)/)[1];return!Object(O.d)(t)&&!e.textContent.toLowerCase().trim().startsWith(t.toLowerCase())}}renderEditedMarker(){const e=this.props.mxEvent.replacingEventDate(),t=e&&Object(v.b)(e),s=l.a.createElement("div",null,l.a.createElement("div",{className:"mx_Tooltip_title"},Object(y.a)("Edited at %(date)s",{date:t})),l.a.createElement("div",{className:"mx_Tooltip_sub"},Object(y.a)("Click to view edits")));return l.a.createElement(R.a,{className:"mx_EventTile_edited",onClick:this.openHistoryDialog,title:Object(y.a)("Edited at %(date)s. Click to view edits.",{date:t}),tooltip:s},l.a.createElement("span",null,`(${Object(y.a)("edited")})`))}render(){if(this.props.editState)return l.a.createElement(M.a,{editState:this.props.editState,className:"mx_EventTile_content"});const e=this.props.mxEvent,t=e.getContent(),s=!e.replacingEvent()&&!!_.a.getParentEventId(e);let n,i=g.b(t,this.props.highlights,{disableBigEmoji:t.msgtype===p.b.Emote||!S.b.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this.contentRef,returnString:!1});switch(this.props.replacingEventId&&(i=l.a.createElement(l.a.Fragment,null,i,this.renderEditedMarker())),this.props.highlightLink?i=l.a.createElement("a",{href:this.props.highlightLink},i):t.data&&"string"==typeof t.data["org.matrix.neb.starter_link"]&&(i=l.a.createElement("a",{href:"#",onClick:this.onStarterLinkClick.bind(this,t.data["org.matrix.neb.starter_link"])},i)),this.state.links.length&&!this.state.widgetHidden&&this.props.showUrlPreview&&(n=l.a.createElement(A.a,{links:this.state.links,mxEvent:this.props.mxEvent,onCancelClick:this.onCancelClick,onHeightChanged:this.props.onHeightChanged})),t.msgtype){case p.b.Emote:return l.a.createElement("div",{className:"mx_MEmoteBody mx_EventTile_content",dir:"auto"},"* ",l.a.createElement("span",{className:"mx_MEmoteBody_sender",onClick:this.onEmoteSenderClick},e.sender?e.sender.name:e.getSender())," ",i,n,this.props.scBubbleGroupTimestamp);case p.b.Notice:return l.a.createElement("div",{className:"mx_MNoticeBody mx_EventTile_content",dir:"auto"},i,n,this.props.scBubbleGroupTimestamp);default:return l.a.createElement("div",{className:"mx_MTextBody mx_EventTile_content",dir:"auto"},i,n,this.props.scBubbleGroupTimestamp)}}},r()(i,"contextType",U.b),n=a))||n}).call(this,s(26))},function(e,t){e.exports="img/icon_context_delete.f02c798.svg"},function(e,t,s){"use strict";(function(e){var t=s(156),n=s(1630),i=s.n(n),a=s(1631),o=s.n(a);let r;t.request((function(e,t){return e.qs=o.a.stringify(e.qs||{},e.qsStringifyOptions),i()(e,t)}));try{r=e.indexedDB}catch(e){}r&&t.setCryptoStoreFactory((function(){return new t.IndexedDBCryptoStore(r,"matrix-js-sdk:crypto")}));e.matrixcs=t}).call(this,s(26))},,,,,,,,,,,,function(e,t){},,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return c}));var n=s(246),i=s.n(n);function a(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function o(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?a(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):a(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const r={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontWeight:"bold",isUp:!1,isLeft:!1};class c{constructor(e={}){i()(this,"browser",{ff:void 0!==window.InstallTrigger,opera:!!window.opera||navigator.userAgent.includes("Opera")}),i()(this,"params",void 0),i()(this,"canvas",void 0),i()(this,"baseImage",void 0),i()(this,"context",void 0),i()(this,"icons",void 0),i()(this,"isReady",!1),i()(this,"readyCb",()=>{}),this.params=o(o({},r),e),this.icons=c.getIcons(),this.canvas=document.createElement("canvas"),this.baseImage=document.createElement("img");const t=this.icons[this.icons.length-1];t.hasAttribute("href")?(this.baseImage.setAttribute("crossOrigin","anonymous"),this.baseImage.onload=()=>{this.canvas.height=this.baseImage.height>0?this.baseImage.height:32,this.canvas.width=this.baseImage.width>0?this.baseImage.width:32,this.context=this.canvas.getContext("2d"),this.ready()},this.baseImage.setAttribute("src",t.getAttribute("href"))):(this.canvas.height=this.baseImage.height=32,this.canvas.width=this.baseImage.width=32,this.context=this.canvas.getContext("2d"),this.ready())}reset(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height)}options(e,t){const s={n:"number"==typeof e?Math.abs(e):e,len:(""+e).length,x:.4,y:.4,w:.6,h:.6};return t.isUp&&(s.y<.6?s.y=s.y-.4:s.y=s.y-2*s.y+(1-s.w)),t.isLeft&&(s.x<.6?s.x=s.x-.4:s.x=s.x-2*s.x+(1-s.h)),s.x=this.canvas.width*s.x,s.y=this.canvas.height*s.y,s.w=this.canvas.width*s.w,s.h=this.canvas.height*s.h,s}circle(e,t){const s=o(o({},this.params),t),n=this.options(e,s);let i=!1;2===n.len?(n.x=n.x-.4*n.w,n.w=1.4*n.w,i=!0):n.len>=3&&(n.x=n.x-.65*n.w,n.w=1.65*n.w,i=!0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height),this.context.beginPath();const a=Math.floor(n.h*(n.n>99?.85:1))+"px";if(this.context.font=`${s.fontWeight} ${a} ${s.fontFamily}`,this.context.textAlign="center",i?(this.context.moveTo(n.x+n.w/2,n.y),this.context.lineTo(n.x+n.w-n.h/2,n.y),this.context.quadraticCurveTo(n.x+n.w,n.y,n.x+n.w,n.y+n.h/2),this.context.lineTo(n.x+n.w,n.y+n.h-n.h/2),this.context.quadraticCurveTo(n.x+n.w,n.y+n.h,n.x+n.w-n.h/2,n.y+n.h),this.context.lineTo(n.x+n.h/2,n.y+n.h),this.context.quadraticCurveTo(n.x,n.y+n.h,n.x,n.y+n.h-n.h/2),this.context.lineTo(n.x,n.y+n.h/2),this.context.quadraticCurveTo(n.x,n.y,n.x+n.h/2,n.y)):this.context.arc(n.x+n.w/2,n.y+n.h/2,n.h/2,0,2*Math.PI),this.context.fillStyle=s.bgColor,this.context.fill(),this.context.closePath(),this.context.beginPath(),this.context.stroke(),this.context.fillStyle=s.textColor,"number"==typeof n.n&&n.n>999){const e=(n.n>9999?9:Math.floor(n.n/1e3))+"k+";this.context.fillText(e,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.2*n.h))}else this.context.fillText(""+n.n,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.15*n.h));this.context.closePath()}ready(){this.isReady||(this.isReady=!0,this.readyCb())}setIcon(t){e(()=>{this.setIconSrc(t.toDataURL("image/png"))})}setIconSrc(e){if(this.browser.ff||this.browser.opera){const t=this.icons[this.icons.length-1],s=window.document.createElement("link");this.icons=[s],s.setAttribute("rel","icon"),s.setAttribute("type","image/png"),window.document.getElementsByTagName("head")[0].appendChild(s),s.setAttribute("href",e),t.parentNode&&t.parentNode.removeChild(t)}else this.icons.forEach(t=>{t.setAttribute("href",e)})}badge(e,t){this.isReady?("string"==typeof e||e>0?this.circle(e,t):this.reset(),this.setIcon(this.canvas)):this.readyCb=()=>{this.badge(e,t)}}static getLinks(){const e=[],t=window.document.getElementsByTagName("head")[0].getElementsByTagName("link");for(let s=0;s<t.length;s++)/(^|\s)icon(\s|$)/i.test(t[s].getAttribute("rel"))&&e.push(t[s]);return e}static getIcons(){let e=c.getLinks();return 0===e.length&&(e=[window.document.createElement("link")],e[0].setAttribute("rel","icon"),window.document.getElementsByTagName("head")[0].appendChild(e[0])),e.forEach(e=>{e.setAttribute("type","image/png")}),e}}}).call(this,s(175).setImmediate)},,,,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"components",(function(){return Ol}));var n,i=s(128),a=s(610),o=s(105),r=s(628),c=s(650),l=s(82),d=s.n(l),h=s(85);let u=Object(h.a)("structures.GenericErrorPage")(n=class extends d.a.PureComponent{render(){return d.a.createElement("div",{className:"mx_GenericErrorPage"},d.a.createElement("div",{className:"mx_GenericErrorPage_box"},d.a.createElement("h1",null,this.props.title),d.a.createElement("p",null,this.props.message)))}})||n;var m,p,g,v=s(952),f=s(554),b=s(844),y=s(848),E=s(395),S=s(840),_=s(1030),w=s(959),C=s(1029),O=s(330),k=s(1026),R=s(568),I=s(866),x=s(929),T=s(331),j=s(549),N=s(845),P=s(483),D=s(882),M=s(328),A=s(237),U=s(1041),L=s(1040),F=s(253),B=s(928),V=s(904),K=s(245),W=s(945),G=s(576),H=s(841),q=s(947),$=s(495),z=s(835),J=s(965),Y=s(1042),Q=s(968),X=s(967),Z=s(544),ee=s(971),te=s(752),se=s(509),ne=s(316),ie=s(753),ae=s(910),oe=s(909),re=s(506),ce=s(507),le=s(751),de=s(505),he=s(754),ue=s(508),me=s(336),pe=s(836),ge=s(335),ve=s(964),fe=s(218),be=s(820),ye=s(550),Ee=s(406),Se=s(334),_e=s(217),we=s(580),Ce=s(581),Oe=s(278),ke=s(969),Re=s(405),Ie=s(960),xe=s(125),Te=s(284),je=s(320),Ne=s(142),Pe=s(923),De=s(126),Me=s(558),Ae=s(326),Ue=s(863),Le=s(864),Fe=s(906),Be=s(314),Ve=s(168),Ke=s(377),We=s(939),Ge=s(869),He=s(924),qe=s(516),$e=s(419),ze=s(810),Je=s(273),Ye=s(83),Qe=s.n(Ye),Xe=s(4),Ze=s(84),et=s(86),tt=s(87),st=s(295),nt=s(131),it=s(231),at=s(210),ot=s(296),rt=s(256),ct=s(108),lt=s(92),dt=s(91),ht=s.n(dt),ut=s(103),mt=s(1622),pt=s.n(mt);let gt=Object(h.a)("views.elements.AddressTile")((g=p=class extends d.a.Component{render(){const e=this.props.address,t=e.displayName||e.address,n=[],i=["mx-user-id","mx-room-id"].includes(e.addressType);i&&e.avatarMxc?n.push(Object(ut.b)(e.avatarMxc).getSquareThumbnailHttp(25)):"email"===e.addressType&&n.push(pt.a);const a=ht()({mx_AddressTile_name:!0,mx_AddressTile_justified:this.props.justified});let o,r=!1;if(i&&e.isKnown){const s=ht()({mx_AddressTile_id:!0,mx_AddressTile_justified:this.props.justified});o=d.a.createElement("div",{className:"mx_AddressTile_mx"},d.a.createElement("div",{className:a},t),this.props.showAddress?d.a.createElement("div",{className:s},e.address):d.a.createElement("div",null))}else if(i){const e=ht()({mx_AddressTile_unknownMx:!0,mx_AddressTile_justified:this.props.justified});o=d.a.createElement("div",{className:e},this.props.address.address)}else if("email"===e.addressType){const t=ht()({mx_AddressTile_email:!0,mx_AddressTile_justified:this.props.justified});let s=null;e.displayName&&(s=d.a.createElement("div",{className:a},e.displayName)),o=d.a.createElement("div",{className:"mx_AddressTile_mx"},d.a.createElement("div",{className:t},e.address),s)}else{r=!0;const e=ht()({mx_AddressTile_unknown:!0,mx_AddressTile_justified:this.props.justified});o=d.a.createElement("div",{className:e},Object(Ze.a)("Unknown Address"))}const c=ht()({mx_AddressTile:!0,mx_AddressTile_error:r});let l;return this.props.canDismiss&&(l=d.a.createElement("div",{className:"mx_AddressTile_dismiss",onClick:this.props.onDismissed},d.a.createElement("img",{src:s(1623),width:"9",height:"9"}))),d.a.createElement("div",{className:c},d.a.createElement("div",{className:"mx_AddressTile_avatar"},d.a.createElement(xe.a,{defaultToInitialLetter:!0,width:25,height:25,name:t,title:t,urls:n})),o,l)}},Qe()(p,"defaultProps",{canDismiss:!1,onDismissed:function(){},justified:!1}),m=g))||m;var vt;let ft=Object(h.a)("views.elements.AddressSelector")(vt=class extends d.a.Component{constructor(e){super(e),Qe()(this,"scrollElement",Object(l.createRef)()),Qe()(this,"addressListElement",Object(l.createRef)()),Qe()(this,"moveSelectionTop",()=>{this.state.selected>0&&this.setState({selected:0,hover:!1})}),Qe()(this,"moveSelectionUp",()=>{this.state.selected>0&&this.setState({selected:this.state.selected-1,hover:!1})}),Qe()(this,"moveSelectionDown",()=>{this.state.selected<this.maxSelected(this.props.addressList)&&this.setState({selected:this.state.selected+1,hover:!1})}),Qe()(this,"chooseSelection",()=>{this.selectAddress(this.state.selected)}),Qe()(this,"onClick",e=>{this.selectAddress(e)}),Qe()(this,"onMouseEnter",e=>{this.setState({selected:e,hover:!0})}),Qe()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),Qe()(this,"selectAddress",e=>{0!==this.props.addressList.length&&(this.props.onSelected(e),this.setState({hover:!1}))}),this.state={selected:void 0===this.props.selected?0:this.props.selected,hover:!1}}UNSAFE_componentWillReceiveProps(e){const t=this.state.selected,s=this.maxSelected(e.addressList);t>s&&this.setState({selected:s})}componentDidUpdate(){if(this.scrollElement.current&&this.props.addressList.length>0&&!this.state.hover){const e=this.addressListElement.current.getBoundingClientRect().height;this.scrollElement.current.scrollTop=this.state.selected*e-e}}createAddressListTiles(){const e=this.maxSelected(this.props.addressList),t=[];if(this.props.addressList.length>0)for(let s=0;s<=e;s++){const e=ht()({mx_AddressSelector_addressListElement:!0,mx_AddressSelector_selected:this.state.selected===s});t.push(d.a.createElement("div",{className:e,onClick:this.onClick.bind(this,s),onMouseEnter:this.onMouseEnter.bind(this,s),onMouseLeave:this.onMouseLeave,key:this.props.addressList[s].addressType+"/"+this.props.addressList[s].address,ref:this.addressListElement},d.a.createElement(gt,{address:this.props.addressList[s],showAddress:this.props.showAddress,justified:!0})))}return t}maxSelected(e){const t=0===e.length?0:e.length-1;return t>this.props.truncateAt-1?this.props.truncateAt-1:t}render(){const e=ht()({mx_AddressSelector:!0,mx_AddressSelector_empty:0===this.props.addressList.length});return d.a.createElement("div",{className:e,ref:this.scrollElement},this.props.header,this.createAddressListTiles())}})||vt;var bt,yt,Et,St=s(97),_t=s(109),wt=s(1);const Ct={"mx-user-id":Object(Ze.b)("Matrix ID"),"mx-room-id":Object(Ze.b)("Matrix Room ID"),email:Object(Ze.b)("email address")};let Ot=Object(h.a)("views.dialogs.AddressPickerDialog")((Et=yt=class extends d.a.Component{constructor(e){super(e),Qe()(this,"textinput",Object(l.createRef)()),Qe()(this,"addressSelector",Object(l.createRef)()),Qe()(this,"queryChangedDebouncer",void 0),Qe()(this,"cancelThreepidLookup",void 0),Qe()(this,"onButtonClick",()=>{let e=this.state.selectedList.slice();""!==this.textinput.current.value&&(e=this.addAddressesToList([this.textinput.current.value]),null===e)||this.props.onFinished(!0,e)}),Qe()(this,"onCancel",()=>{this.props.onFinished(!1)}),Qe()(this,"onKeyDown",e=>{const t=this.textinput.current?this.textinput.current.value:void 0;e.key===ct.a.ESCAPE?(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1)):e.key===ct.a.ARROW_UP?(e.stopPropagation(),e.preventDefault(),this.addressSelector.current&&this.addressSelector.current.moveSelectionUp()):e.key===ct.a.ARROW_DOWN?(e.stopPropagation(),e.preventDefault(),this.addressSelector.current&&this.addressSelector.current.moveSelectionDown()):this.state.suggestedList.length>0&&[ct.a.COMMA,ct.a.ENTER,ct.a.TAB].includes(e.key)?(e.stopPropagation(),e.preventDefault(),this.addressSelector.current&&this.addressSelector.current.chooseSelection()):0===t.length&&this.state.selectedList.length&&e.key===ct.a.BACKSPACE?(e.stopPropagation(),e.preventDefault(),this.onDismissed(this.state.selectedList.length-1)()):e.key===ct.a.ENTER?(e.stopPropagation(),e.preventDefault(),""===t?this.onButtonClick():this.addAddressesToList([t])):!t||e.key!==ct.a.COMMA&&e.key!==ct.a.TAB||(e.stopPropagation(),e.preventDefault(),this.addAddressesToList([t]))}),Qe()(this,"onQueryChanged",e=>{const t=e.target.value;this.queryChangedDebouncer&&clearTimeout(this.queryChangedDebouncer),t.length>0&&"@"!==t&&t.length>=2?this.queryChangedDebouncer=setTimeout(()=>{"user"===this.props.pickerType?this.props.groupId?this.doNaiveGroupSearch(t):this.state.serverSupportsUserDirectory?this.doUserDirectorySearch(t):this.doLocalSearch(t):"room"===this.props.pickerType?this.props.groupId?this.doNaiveGroupRoomSearch(t):this.doRoomSearch(t):wt.a.error("Unknown pickerType",this.props.pickerType)},200):this.setState({suggestedList:[],query:"",searchError:null})}),Qe()(this,"onDismissed",e=>()=>{const t=this.state.selectedList.slice();t.splice(e,1),this.setState({selectedList:t,suggestedList:[],query:""}),this.cancelThreepidLookup&&this.cancelThreepidLookup()}),Qe()(this,"onSelected",e=>{const t=this.state.selectedList.slice();t.push(this.getFilteredSuggestions()[e]),this.setState({selectedList:t,suggestedList:[],query:""}),this.cancelThreepidLookup&&this.cancelThreepidLookup()}),Qe()(this,"onPaste",e=>{e.preventDefault();const t=e.clipboardData.getData("text");this.addAddressesToList(t.split(/[\s,]+/))}),Qe()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(ot.d)();const{validAddressTypes:t}=this.state;t.push(st.a.Email),this.setState({validAddressTypes:t})}),Qe()(this,"onManageSettingsClick",e=>{e.preventDefault(),tt.a.fire(lt.a.ViewUserSettings),this.onCancel()});let t=this.props.validAddressTypes;!et.a.get().getIdentityServerUrl()&&t.includes(st.a.Email)&&(t=t.filter(e=>e!==st.a.Email)),this.state={invalidAddressError:!1,selectedList:[],busy:!1,searchError:null,serverSupportsUserDirectory:!0,query:"",suggestedList:[],validAddressTypes:t}}componentDidMount(){this.props.focus&&(this.textinput.current.value=this.props.value)}getPlaceholder(){const{placeholder:e}=this.props;return"string"==typeof e?e:e(this.state.validAddressTypes)}doNaiveGroupSearch(e){const t=e.toLowerCase();this.setState({busy:!0,query:e,searchError:null}),et.a.get().getGroupUsers(this.props.groupId).then(s=>{const n=[];s.chunk.forEach(e=>{const s=e.user_id.toLowerCase().includes(t),i=(e.displayname||"").toLowerCase().includes(t);(s||i)&&n.push({user_id:e.user_id,avatar_url:e.avatar_url,display_name:e.displayname})}),this.processResults(n,e)}).catch(e=>{wt.a.error("Error whilst searching group rooms: ",e),this.setState({searchError:e.errcode?e.message:Object(Ze.a)("Something went wrong!")})}).then(()=>{this.setState({busy:!1})})}doNaiveGroupRoomSearch(e){const t=e.toLowerCase(),s=[];nt.a.getGroupRooms(this.props.groupId).forEach(e=>{const n=(e.name||"").toLowerCase().includes(t),i=(e.topic||"").toLowerCase().includes(t),a=(e.canonical_alias||"").toLowerCase().includes(t);(n||i||a)&&s.push({room_id:e.room_id,avatar_url:e.avatar_url,name:e.name||e.canonical_alias})}),this.processResults(s,e),this.setState({busy:!1})}doRoomSearch(e){const t=e.toLowerCase(),s=et.a.get().getRooms(),n=[];s.forEach(e=>{let s=1/0;const i=e.currentState.getStateEvents("m.room.name",""),a=i?i.getContent().name:"",o=e.getCanonicalAlias(),r=e.currentState.getStateEvents("m.room.aliases").map(e=>e.getContent().aliases).reduce((e,t)=>e.concat(t),[]),c=(a||"").toLowerCase().includes(t);let l=!1,d=1/0;if(r.forEach(e=>{(e||"").toLowerCase().includes(t)&&(l=!0,d>e.length&&(d=e.length))}),!c&&!l)return;l&&(s=d);const h=e.currentState.getStateEvents("m.room.avatar",""),u=h?h.getContent().url:void 0;n.push({rank:s,room_id:e.roomId,avatar_url:u,name:a||o||r[0]||Object(Ze.a)("Unnamed Room")})});const i=n.sort((e,t)=>e.rank-t.rank);this.processResults(i,e),this.setState({busy:!1})}doUserDirectorySearch(e){this.setState({busy:!0,query:e,searchError:null}),et.a.get().searchUserDirectory({term:e}).then(t=>{this.state.query===e&&this.processResults(t.results,e)}).catch(t=>{wt.a.error("Error whilst searching user directory: ",t),this.setState({searchError:t.errcode?t.message:Object(Ze.a)("Something went wrong!")}),"M_UNRECOGNIZED"===t.errcode&&(this.setState({serverSupportsUserDirectory:!1}),this.doLocalSearch(e))}).then(()=>{this.setState({busy:!1})})}doLocalSearch(e){this.setState({query:e,searchError:null});const t=e.toLowerCase(),s=[];et.a.get().getUsers().forEach(e=>{-1===e.userId.toLowerCase().indexOf(t)&&-1===e.displayName.toLowerCase().indexOf(t)||s.push({user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl})}),this.processResults(s,e)}processResults(e,t){const s=[];e.forEach(e=>{if(e.room_id){const t=et.a.get(),n=t.getRoom(e.room_id);if(n){const e=n.currentState.getStateEvents("m.room.tombstone","");if(e&&e.getContent()&&e.getContent().replacement_room){if(t.getRoom(e.getContent().replacement_room))return}}s.push({addressType:"mx-room-id",address:e.room_id,displayName:e.name,avatarMxc:e.avatar_url,isKnown:!0})}else(this.props.includeSelf||e.user_id!==et.a.get().credentials.userId)&&s.push({addressType:"mx-user-id",address:e.user_id,displayName:e.display_name,avatarMxc:e.avatar_url,isKnown:!0})});const n=Object(st.c)(t);if(this.state.validAddressTypes.includes(n)){if("email"===n&&!it.a(t))return void this.setState({searchError:Object(Ze.a)("That doesn't look like a valid email address")});s.unshift({addressType:n,address:t,isKnown:!1}),this.cancelThreepidLookup&&this.cancelThreepidLookup(),"email"===n&&this.lookupThreepid(n,t)}this.setState({suggestedList:s,invalidAddressError:!1},()=>{this.addressSelector.current&&this.addressSelector.current.moveSelectionTop()})}addAddressesToList(e){const t=this.state.selectedList.slice();let s=!1;return e.forEach(e=>{e=e.trim();const n=Object(st.c)(e),i={addressType:n,address:e,isKnown:!1};if(this.state.validAddressTypes.includes(n)){if("mx-user-id"===n){const e=et.a.get().getUser(i.address);e&&(i.displayName=e.displayName,i.avatarMxc=e.avatarUrl,i.isKnown=!0)}else if("mx-room-id"===n){const e=et.a.get().getRoom(i.address);e&&(i.displayName=e.name,i.isKnown=!0)}}else s=!0;t.push(i)}),this.setState({selectedList:t,suggestedList:[],query:"",invalidAddressError:!!s||this.state.invalidAddressError}),this.cancelThreepidLookup&&this.cancelThreepidLookup(),s?null:t}async lookupThreepid(e,t){let s=!1;if(this.cancelThreepidLookup=function(){s=!0},await Object(Xe.I)(500),s)return null;try{const n=new at.a,i=await n.getAccessToken();if(s)return null;const a=await et.a.get().lookupThreePid(e,t,void 0,i);if(s||null===a||!a.mxid)return null;const o=await et.a.get().getProfileInfo(a.mxid);if(s||null===o)return null;this.setState({suggestedList:[{addressType:e,address:t,displayName:o.displayname,avatarMxc:o.avatar_url,isKnown:!0}]})}catch(e){wt.a.error(e),this.setState({searchError:Object(Ze.a)("Something went wrong!")})}}getFilteredSuggestions(){const e={};return this.state.selectedList.forEach(({address:t,addressType:s})=>{e[s]||(e[s]=new Set),e[s].add(t)}),this.state.suggestedList.filter(({address:t,addressType:s})=>!(e[s]&&e[s].has(t)))}render(){let e;this.props.description&&(e=d.a.createElement("div",{className:"mx_AddressPickerDialog_label"},d.a.createElement("label",{htmlFor:"textinput"},this.props.description)));const t=[];if(this.state.selectedList.length>0)for(let e=0;e<this.state.selectedList.length;e++)t.push(d.a.createElement(gt,{key:e,address:this.state.selectedList[e],canDismiss:!0,onDismissed:this.onDismissed(e),showAddress:"user"===this.props.pickerType}));t.push(d.a.createElement("textarea",{key:this.state.selectedList.length,onPaste:this.onPaste,rows:1,id:"textinput",ref:this.textinput,className:"mx_AddressPickerDialog_input",onChange:this.onQueryChanged,placeholder:this.getPlaceholder(),defaultValue:this.props.value,autoFocus:this.props.focus}));const s=this.getFilteredSuggestions();let n,i,a;if(this.state.invalidAddressError){const e=this.state.validAddressTypes.map(e=>Object(Ze.a)(Ct[e]));n=d.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(Ze.a)("You have entered an invalid address."),d.a.createElement("br",null),Object(Ze.a)("Try using one of the following valid address types: %(validTypesList)s.",{validTypesList:e.join(", ")}))}else this.state.searchError?n=d.a.createElement("div",{className:"mx_AddressPickerDialog_error"},this.state.searchError):this.state.query.length>0&&0===s.length&&!this.state.busy?n=d.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(Ze.a)("No results")):i=d.a.createElement(ft,{ref:this.addressSelector,addressList:s,showAddress:"user"===this.props.pickerType,onSelected:this.onSelected,truncateAt:40});if("user"===this.props.pickerType&&!this.state.validAddressTypes.includes(st.a.Email)&&this.props.validAddressTypes.includes(st.a.Email)){const e=Object(ot.c)();a=e?d.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(Ze.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(rt.a)(e)},{default:e=>d.a.createElement("a",{href:"#",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>d.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)})):d.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(Ze.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>d.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)}))}return d.a.createElement(St.a,{className:"mx_AddressPickerDialog",onKeyDown:this.onKeyDown,onFinished:this.props.onFinished,title:this.props.title},e,d.a.createElement("div",{className:"mx_Dialog_content"},d.a.createElement("div",{className:"mx_AddressPickerDialog_inputContainer"},t),n,i,this.props.extraNode,a),d.a.createElement(_t.a,{primaryButton:this.props.button,onPrimaryButtonClick:this.onButtonClick,onCancel:this.onCancel}))}},Qe()(yt,"defaultProps",{value:"",focus:!0,validAddressTypes:st.b,pickerType:"user",includeSelf:!1}),bt=Et))||bt;var kt=s(660),Rt=s(809),It=s(200),xt=s(972),Tt=s(813),jt=s(1014),Nt=s(383),Pt=s(902),Dt=s(571),Mt=s(973),At=s(824),Ut=s(827),Lt=s(389),Ft=s(299),Bt=s(808),Vt=s(93),Kt=s(90),Wt=s(113);var Gt,Ht=e=>{const t=Vt.a.get().brand,s=Object(Ze.a)("You've previously used a newer version of %(brand)s with this session. To use this version again with end to end encryption, you will need to sign out and back in again.",{brand:t});return d.a.createElement(St.a,{className:"mx_CryptoStoreTooNewDialog",contentId:"mx_Dialog_content",title:Object(Ze.a)("Incompatible Database"),hasCancel:!1,onFinished:e.onFinished},d.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},s),d.a.createElement(_t.a,{primaryButton:Object(Ze.a)("Continue With Encryption Disabled"),hasCancel:!1,onPrimaryButtonClick:e.onFinished},d.a.createElement("button",{onClick:()=>{Kt.a.createTrackedDialog("Logout e2e db too new","",Wt.a,{title:Object(Ze.a)("Sign out"),description:Object(Ze.a)("To avoid losing your chat history, you must export your room keys before logging out. You will need to go back to the newer version of %(brand)s to do this",{brand:t}),button:Object(Ze.a)("Sign out"),focus:!1,onFinished:t=>{t&&(tt.a.dispatch({action:"logout"}),e.onFinished(!0))}})}},Object(Ze.a)("Sign out"))))},qt=s(658),$t=s(379),zt=s(843),Jt=s(104),Yt=s(595),Qt=s(842),Xt=s(722),Zt=s(452),es=s(1037),ts=s(832),ss=s(166),ns=s(734),is=s(731),as=s(242),os=s(416),rs=s(831),cs=s(975),ls=s(974),ds=s(811),hs=s(556),us=s(786),ms=s(885),ps=s(1015),gs=s(855),vs=s(963),fs=s(738),bs=s(325),ys=s(536),Es=s(524),Ss=s(926),_s=s(778),ws=s(961),Cs=s(1004),Os=s(976),ks=s(984),Rs=s(384),Is=s(918),xs=s(781),Ts=s(977),js=s(732),Ns=s(189),Ps=s.n(Ns),Ds=s(205);class Ms extends d.a.PureComponent{constructor(...e){super(...e),Qe()(this,"onChange",e=>{this.props.onChange(this.props.url,e.currentTarget.checked)})}render(){return d.a.createElement("input",{type:"checkbox",onChange:this.onChange,checked:this.props.checked})}}let As=Object(h.a)("views.dialogs.TermsDialog")(Gt=class extends d.a.PureComponent{constructor(e){super(e),Qe()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),Qe()(this,"onNextClick",()=>{this.props.onFinished(!0,Object.keys(this.state.agreedUrls).filter(e=>this.state.agreedUrls[e]))}),Qe()(this,"onTermsCheckboxChange",(e,t)=>{this.setState({agreedUrls:Object.assign({},this.state.agreedUrls,{[e]:t})})}),this.state={agreedUrls:{}};for(const t of e.agreedUrls)this.state.agreedUrls[t]=!0}nameForServiceType(e,t){switch(e){case Ds.a.IS:return d.a.createElement("div",null,Object(Ze.a)("Identity server"),d.a.createElement("br",null),"(",t,")");case Ds.a.IM:return d.a.createElement("div",null,Object(Ze.a)("Integration manager"),d.a.createElement("br",null),"(",t,")")}}summaryForServiceType(e){switch(e){case Ds.a.IS:return d.a.createElement("div",null,Object(Ze.a)("Find others by phone or email"),d.a.createElement("br",null),Object(Ze.a)("Be found by phone or email"));case Ds.a.IM:return d.a.createElement("div",null,Object(Ze.a)("Use bots, bridges, widgets and sticker packs"))}}render(){const e=[];for(const t of this.props.policiesAndServicePairs){const s=Ps.a.parse(t.service.baseUrl),n=Object.values(t.policies);for(let i=0;i<n.length;++i){const a=n[i],o=Object(Ze.i)(Object.keys(a).filter(e=>"version"!==e));let r,c;0===i&&(r=this.nameForServiceType(t.service.serviceType,s.host),c=this.summaryForServiceType(t.service.serviceType)),e.push(d.a.createElement("tr",{key:a[o].url},d.a.createElement("td",{className:"mx_TermsDialog_service"},r),d.a.createElement("td",{className:"mx_TermsDialog_summary"},c),d.a.createElement("td",null,a[o].name,d.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:a[o].url},d.a.createElement("span",{className:"mx_TermsDialog_link"}))),d.a.createElement("td",null,d.a.createElement(Ms,{url:a[o].url,onChange:this.onTermsCheckboxChange,checked:Boolean(this.state.agreedUrls[a[o].url])}))))}}let t=!1;for(const e of this.props.policiesAndServicePairs){let s=0;for(const t of Object.values(e.policies)){let e=!1;for(const s of Object.keys(t))if("version"!==s&&this.state.agreedUrls[t[s].url]){e=!0;break}e&&++s}if(s===Object.keys(e.policies).length){t=!0;break}}return d.a.createElement(St.a,{fixedWidth:!1,onFinished:this.onCancelClick,title:Object(Ze.a)("Terms of Service"),contentId:"mx_Dialog_content",hasCancel:!1},d.a.createElement("div",{id:"mx_Dialog_content"},d.a.createElement("p",null,Object(Ze.a)("To continue you need to accept the terms of this service.")),d.a.createElement("table",{className:"mx_TermsDialog_termsTable"},d.a.createElement("tbody",null,d.a.createElement("tr",{className:"mx_TermsDialog_termsTableHeader"},d.a.createElement("th",null,Object(Ze.a)("Service")),d.a.createElement("th",null,Object(Ze.a)("Summary")),d.a.createElement("th",null,Object(Ze.a)("Document")),d.a.createElement("th",null,Object(Ze.a)("Accept"))),e))),d.a.createElement(_t.a,{primaryButton:Object(Ze.a)("Next"),hasCancel:!0,onCancel:this.onCancelClick,onPrimaryButtonClick:this.onNextClick,primaryDisabled:!t}))}})||Gt;var Us,Ls=s(497),Fs=s(884),Bs=s(917),Vs=s(306),Ks=s.n(Vs);let Ws=Object(h.a)("views.dialogs.UploadFailureDialog")(Us=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),Qe()(this,"onUploadClick",()=>{this.props.onFinished(!0)})}render(){let e,t;if(1===this.props.totalFiles&&1===this.props.badFiles.length)e=Object(Ze.a)("This file is <b>too large</b> to upload. The file size limit is %(limit)s but this file is %(sizeOfThisFile)s.",{limit:Ks()(this.props.contentMessages.getUploadLimit()),sizeOfThisFile:Ks()(this.props.badFiles[0].size)},{b:e=>d.a.createElement("b",null,e)}),t=d.a.createElement(_t.a,{primaryButton:Object(Ze.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.onCancelClick,focus:!0});else if(this.props.totalFiles===this.props.badFiles.length)e=Object(Ze.a)("These files are <b>too large</b> to upload. The file size limit is %(limit)s.",{limit:Ks()(this.props.contentMessages.getUploadLimit())},{b:e=>d.a.createElement("b",null,e)}),t=d.a.createElement(_t.a,{primaryButton:Object(Ze.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.onCancelClick,focus:!0});else{e=Object(Ze.a)("Some files are <b>too large</b> to be uploaded. The file size limit is %(limit)s.",{limit:Ks()(this.props.contentMessages.getUploadLimit())},{b:e=>d.a.createElement("b",null,e)});const s=this.props.totalFiles-this.props.badFiles.length;t=d.a.createElement(_t.a,{primaryButton:Object(Ze.a)("Upload %(count)s other files",{count:s}),onPrimaryButtonClick:this.onUploadClick,hasCancel:!0,cancelButton:Object(Ze.a)("Cancel All"),onCancel:this.onCancelClick,focus:!0})}return d.a.createElement(St.a,{className:"mx_UploadFailureDialog",onFinished:this.onCancelClick,title:Object(Ze.a)("Upload Error"),contentId:"mx_Dialog_content"},d.a.createElement("div",{id:"mx_Dialog_content"},e,void 0),t)}})||Us;var Gs,Hs,qs,$s=s(158),zs=s(393),Js=s(1035),Ys=s(852),Qs=s(819),Xs=s(1002),Zs=s(966),en=s(275),tn=s(392),sn=s(829),nn=s(88),an=s(111),on=s(957),rn=s(850),cn=s(276),ln=s(851),dn=s(444),hn=s(859),un=s(541),mn=s(830),pn=s(889),gn=s(229),vn=s(784),fn=s(584),bn=s(96);let yn=Object(h.a)("views.elements.EditableTextContainer")((qs=Hs=class extends d.a.Component{constructor(e){super(e),Qe()(this,"unmounted",!1),Qe()(this,"onValueChanged",(e,t)=>{t&&(this.setState({busy:!0,errorString:null}),this.props.onSubmit(e).then(()=>{this.unmounted||this.setState({busy:!1,value:e})},e=>{this.unmounted||this.setState({errorString:e.toString(),busy:!1})}))}),this.state={busy:!1,errorString:null,value:e.initialValue}}async componentDidMount(){if(void 0!==this.props.getInitialValue){this.setState({busy:!0});try{const e=await this.props.getInitialValue();if(this.unmounted)return;this.setState({busy:!1,value:e})}catch(e){if(this.unmounted)return;this.setState({errorString:e.toString(),busy:!1})}}}componentWillUnmount(){this.unmounted=!0}render(){return this.state.busy?d.a.createElement(bn.a,null):this.state.errorString?d.a.createElement("div",{className:"error"},this.state.errorString):d.a.createElement(fn.a,{initialValue:this.state.value,placeholder:this.props.placeholder,onValueChanged:this.onValueChanged,blurToSubmit:this.props.blurToSubmit})}},Qe()(Hs,"defaultProps",{initialValue:"",placeholder:"",blurToSubmit:!1,onSubmit:()=>Promise.resolve()}),Gs=qs))||Gs;var En=s(940),Sn=s(277),_n=s(569),wn=s(991),Cn=s(941),On=s(101),kn=s(888),Rn=s(283),In=s(396),xn=s(145),Tn=s(932),jn=s(369),Nn=s(187),Pn=s(446),Dn=s(762),Mn=s(892),An=s(555),Un=s(399),Ln=s(865),Fn=s(925),Bn=s(538),Vn=s(301),Kn=s(498),Wn=s(234),Gn=s(551),Hn=s(368),qn=s(219),$n=s(386),zn=s(407),Jn=s(404),Yn=s(172),Qn=s(993),Xn=s(657),Zn=s(1017),ei=s(137),ti=s(176),si=s(216),ni=s(447),ii=s(496),ai=s(1006),oi=s(177),ri=s(322),ci=s(150),li=s(510),di=s(311),hi=s(954),ui=s(160),mi=s(816),pi=s(761),gi=s(514),vi=s(418),fi=s(757),bi=s(759),yi=s(760),Ei=s(513),Si=s(758),_i=s(867),wi=s(891),Ci=s(163),Oi=s(136),ki=s(133);class Ri extends d.a.PureComponent{constructor(e){super(e),Qe()(this,"wrapperElement",Object(l.createRef)()),Qe()(this,"resizeObserver",void 0),Qe()(this,"onLengthChanged",e=>{this.setState({length:e})}),Qe()(this,"resizeObserverCallback",e=>{const t=e.find(e=>e.target===this.wrapperElement.current);t&&this.setState({narrow:t.contentRect.width<450/70*100})}),Qe()(this,"onSilencedChanged",e=>{this.setState({silenced:e})}),Qe()(this,"onStateChanged",e=>{this.setState({callState:e})}),this.state={callState:this.props.callEventGrouper.state,silenced:!1,narrow:!1,length:0}}componentDidMount(){this.props.callEventGrouper.addListener(wi.a.StateChanged,this.onStateChanged),this.props.callEventGrouper.addListener(wi.a.SilencedChanged,this.onSilencedChanged),this.props.callEventGrouper.addListener(wi.a.LengthChanged,this.onLengthChanged),this.resizeObserver=new ResizeObserver(this.resizeObserverCallback),this.resizeObserver.observe(this.wrapperElement.current)}componentWillUnmount(){this.props.callEventGrouper.removeListener(wi.a.StateChanged,this.onStateChanged),this.props.callEventGrouper.removeListener(wi.a.SilencedChanged,this.onSilencedChanged),this.props.callEventGrouper.removeListener(wi.a.LengthChanged,this.onLengthChanged),this.resizeObserver.disconnect()}renderCallBackButton(e){return d.a.createElement(nn.a,{className:"mx_CallEvent_content_button mx_CallEvent_content_button_callBack",onClick:this.props.callEventGrouper.callBack,kind:"primary"},d.a.createElement("span",null," ",e," "))}renderSilenceIcon(){const e=ht()({mx_CallEvent_iconButton:!0,mx_CallEvent_unSilence:this.state.silenced,mx_CallEvent_silence:!this.state.silenced});return d.a.createElement(an.a,{className:e,onClick:this.props.callEventGrouper.toggleSilenced,title:this.state.silenced?Object(Ze.a)("Sound on"):Object(Ze.a)("Silence call")})}renderContent(e){if(e===Ci.e.Ringing){let e;return this.state.narrow||(e=this.renderSilenceIcon()),d.a.createElement("div",{className:"mx_CallEvent_content"},e,d.a.createElement(nn.a,{className:"mx_CallEvent_content_button mx_CallEvent_content_button_reject",onClick:this.props.callEventGrouper.rejectCall,kind:"danger"},d.a.createElement("span",null," ",Object(Ze.a)("Decline")," ")),d.a.createElement(nn.a,{className:"mx_CallEvent_content_button mx_CallEvent_content_button_answer",onClick:this.props.callEventGrouper.answerCall,kind:"primary"},d.a.createElement("span",null," ",Object(Ze.a)("Accept")," ")))}if(e===Ci.e.Ended){const e=this.props.callEventGrouper.hangupReason;if(this.props.callEventGrouper.gotRejected)return d.a.createElement("div",{className:"mx_CallEvent_content"},Object(Ze.a)("Call declined"),this.renderCallBackButton(Object(Ze.a)("Call back")));if([Ci.b.UserHangup,"user hangup"].includes(e)||!e){const e=this.props.callEventGrouper.duration;let t=Object(Ze.a)("Call ended");return e&&(t+=" • "+Object(Oi.a)(e)),d.a.createElement("div",{className:"mx_CallEvent_content"},t)}if(e===Ci.b.InviteTimeout)return d.a.createElement("div",{className:"mx_CallEvent_content"},Object(Ze.a)("No answer"),this.renderCallBackButton(Object(Ze.a)("Call back")));let t;return t=e===Ci.b.IceFailed?Object(Ze.a)("Could not connect media"):"ice_timeout"===e?Object(Ze.a)("Connection failed"):e===Ci.b.NoUserMedia?Object(Ze.a)("Their device couldn't start the camera or microphone"):"unknown_error"===e?Object(Ze.a)("An unknown error occurred"):e===Ci.b.UserBusy?Object(Ze.a)("The user you called is busy."):Object(Ze.a)("Unknown failure: %(reason)s",{reason:e}),d.a.createElement("div",{className:"mx_CallEvent_content"},d.a.createElement(In.b,{tooltip:t,className:"mx_CallEvent_content_tooltip",kind:In.a.Warning}),Object(Ze.a)("Connection failed"),this.renderCallBackButton(Object(Ze.a)("Retry")))}return e===Ci.e.Connected?d.a.createElement("div",{className:"mx_CallEvent_content"},d.a.createElement(ne.a,{seconds:this.state.length})):e===Ci.e.Connecting?d.a.createElement("div",{className:"mx_CallEvent_content"},Object(Ze.a)("Connecting")):e===wi.b.Missed?d.a.createElement("div",{className:"mx_CallEvent_content"},Object(Ze.a)("Missed call"),this.renderCallBackButton(Object(Ze.a)("Call back"))):d.a.createElement("div",{className:"mx_CallEvent_content"},Object(Ze.a)("The call is in an unknown state!"))}render(){const e=this.props.mxEvent,t=e.sender?e.sender.name:e.getSender(),s=this.props.callEventGrouper.isVoice,n=s?Object(Ze.a)("Voice call"):Object(Ze.a)("Video call"),i=this.state.callState,a=this.props.callEventGrouper.hangupReason,o=this.renderContent(i),r=ht()("mx_CallEvent",{mx_CallEvent_voice:s,mx_CallEvent_video:!s,mx_CallEvent_narrow:this.state.narrow&&this.props.layout!==ki.a.Bubble,mx_CallEvent_missed:i===wi.b.Missed,mx_CallEvent_noAnswer:i===Ci.e.Ended&&a===Ci.b.InviteTimeout,mx_CallEvent_rejected:i===Ci.e.Ended&&this.props.callEventGrouper.gotRejected});let c;return this.state.narrow&&this.state.callState===Ci.e.Ringing&&(c=this.renderSilenceIcon()),d.a.createElement("div",{className:"mx_CallEvent_wrapper",ref:this.wrapperElement},d.a.createElement("div",{className:r},c,d.a.createElement("div",{className:"mx_CallEvent_info"},d.a.createElement(Ne.a,{member:e.sender,width:32,height:32}),d.a.createElement("div",{className:"mx_CallEvent_info_basic"},d.a.createElement("div",{className:"mx_CallEvent_sender"},t),d.a.createElement("div",{className:"mx_CallEvent_type"},d.a.createElement("div",{className:"mx_CallEvent_type_icon"}),n))),o))}}var Ii=s(332),xi=s(756),Ti=s(1043),ji=s(241),Ni=s(98),Pi=s(130),Di=s(144);var Mi,Ai=Object(l.forwardRef)(({mxEvent:e},t)=>{const s=Object(l.useContext)(Ni.a),n=e.getRoomId(),i=et.a.get().isRoomEncrypted(n),a=e.getPrevContent(),o=e.getContent();if(!Object(Di.d)(a,o))return null;if("m.megolm.v1.aes-sha2"===o.algorithm&&i){let e;const t=Pi.a.shared().getUserIdForRoomId(n);if("m.megolm.v1.aes-sha2"===a.algorithm)e=Object(Ze.a)("Some encryption parameters have been changed.");else if(t){var r,c;const i=(null==s||null===(r=s.getRoom(n))||void 0===r||null===(c=r.getMember(t))||void 0===c?void 0:c.rawDisplayName)||t;e=Object(Ze.a)("Messages here are end-to-end encrypted. Verify %(displayName)s in their profile - tap on their avatar.",{displayName:i})}else e=Object(Ze.a)("Messages in this room are end-to-end encrypted. When people join, you can verify them in their profile, just tap on their avatar.");return d.a.createElement(ji.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(Ze.a)("Encryption enabled"),subtitle:e})}return i?d.a.createElement(ji.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(Ze.a)("Encryption enabled"),subtitle:Object(Ze.a)("Ignored attempt to disable encryption")}):d.a.createElement(ji.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon mx_cryptoEvent_icon_warning",title:Object(Ze.a)("Encryption not enabled"),subtitle:Object(Ze.a)("The encryption used by this room isn't supported."),ref:t})}),Ui=s(596),Li=s(262),Fi=s(477),Bi=s(708),Vi=s(238),Ki=s(154);let Wi=Object(h.a)("views.messages.MJitsiWidgetEvent")(Mi=class extends d.a.PureComponent{constructor(e){super(e)}render(){var e;const t=this.props.mxEvent.getContent().url,s=this.props.mxEvent.getPrevContent().url,n=(null===(e=this.props.mxEvent.sender)||void 0===e?void 0:e.name)||this.props.mxEvent.getSender(),i=et.a.get().getRoom(this.props.mxEvent.getRoomId()),a=this.props.mxEvent.getStateKey(),o=Vi.a.instance.getRoom(i.roomId,!0).widgets.find(e=>e.id===a);let r=Object(Ze.a)("Join the conference at the top of this room");return o&&Ki.d.instance.isInContainer(i,o,Ki.a.Right)?r=Object(Ze.a)("Join the conference from the room information card on the right"):o||(r=null),t?s?d.a.createElement(ji.a,{className:"mx_MJitsiWidgetEvent",title:Object(Ze.a)("Video conference updated by %(senderName)s",{senderName:n}),subtitle:r}):d.a.createElement(ji.a,{className:"mx_MJitsiWidgetEvent",title:Object(Ze.a)("Video conference started by %(senderName)s",{senderName:n}),subtitle:r}):d.a.createElement(ji.a,{className:"mx_MJitsiWidgetEvent",title:Object(Ze.a)("Video conference ended by %(senderName)s",{senderName:n})})}})||Mi;var Gi,Hi=s(766),qi=s(515),$i=s(122);let zi=Object(h.a)("views.messages.MKeyVerificationRequest")(Gi=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"openRequest",()=>{const{verificationRequest:e}=this.props.mxEvent,t=et.a.get().getUser(e.otherUserId);tt.a.dispatch({action:lt.a.SetRightPanelPhase,phase:$i.c.EncryptionPanel,refireParams:{verificationRequest:e,member:t}})}),Qe()(this,"onRequestChanged",()=>{this.forceUpdate()}),Qe()(this,"onAcceptClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{this.openRequest(),await e.accept()}catch(e){wt.a.error(e.message)}}),Qe()(this,"onRejectClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{await e.cancel()}catch(e){wt.a.error(e.message)}})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this.onRequestChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this.onRequestChanged)}acceptedLabel(e){return e===et.a.get().getUserId()?Object(Ze.a)("You accepted"):Object(Ze.a)("%(name)s accepted",{name:Object(qi.a)(e,this.props.mxEvent.getRoomId())})}cancelledLabel(e){const t=et.a.get().getUserId(),{cancellationCode:s}=this.props.mxEvent.verificationRequest,n="m.user"===s;return e===t?n?Object(Ze.a)("You declined"):Object(Ze.a)("You cancelled"):n?Object(Ze.a)("%(name)s declined",{name:Object(qi.a)(e,this.props.mxEvent.getRoomId())}):Object(Ze.a)("%(name)s cancelled",{name:Object(qi.a)(e,this.props.mxEvent.getRoomId())})}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!t||t.invalid)return null;let s,n,i;if(!t.canAccept){let e;t.ready||t.started||t.done?e=d.a.createElement(nn.a,{onClick:this.openRequest},this.acceptedLabel(t.receivingUserId)):t.cancelled?e=this.cancelledLabel(t.cancellingUserId):t.accepting?e=Object(Ze.a)("Accepting …"):t.declining&&(e=Object(Ze.a)("Declining …")),i=d.a.createElement("div",{className:"mx_cryptoEvent_state"},e)}if(t.initiatedByMe)s=Object(Ze.a)("You sent a verification request"),n=Object(qi.b)(t.receivingUserId,e.getRoomId());else{const a=Object(qi.a)(t.requestingUserId,e.getRoomId());s=Object(Ze.a)("%(name)s wants to verify",{name:a}),n=Object(qi.b)(t.requestingUserId,e.getRoomId()),t.canAccept&&(i=d.a.createElement("div",{className:"mx_cryptoEvent_buttons"},d.a.createElement(nn.a,{kind:"danger",onClick:this.onRejectClicked},Object(Ze.a)("Decline")),d.a.createElement(nn.a,{kind:"primary",onClick:this.onAcceptClicked},Object(Ze.a)("Accept"))))}return s?d.a.createElement(ji.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:s,subtitle:n},i):null}})||Gi;var Ji,Yi,Qi,Xi=s(263);let Zi=Object(h.a)("views.messages.MPollBody")((Qi=Yi=class extends d.a.Component{constructor(e){super(e),Qe()(this,"context",void 0),Qe()(this,"onPollRelationsCreated",(e,t)=>{if("m.reference"===e&&Xi.b.matches(t)){this.props.mxEvent.removeListener("Event.relationsCreated",this.onPollRelationsCreated);const e=this.fetchPollRelations();this.addListeners(e),this.removeListeners(this.state.pollRelations),this.setState({pollRelations:e})}}),Qe()(this,"onRelationsChange",()=>{this.forceUpdate()}),Qe()(this,"onOptionSelected",e=>{this.selectOption(e.currentTarget.value)}),this.state={selected:null,pollRelations:this.fetchPollRelations()},this.addListeners(this.state.pollRelations),this.props.mxEvent.on("Event.relationsCreated",this.onPollRelationsCreated)}componentWillUnmount(){this.props.mxEvent.off("Event.relationsCreated",this.onPollRelationsCreated),this.removeListeners(this.state.pollRelations)}addListeners(e){e&&(e.on("Relations.add",this.onRelationsChange),e.on("Relations.remove",this.onRelationsChange),e.on("Relations.redaction",this.onRelationsChange))}removeListeners(e){e&&(e.off("Relations.add",this.onRelationsChange),e.off("Relations.remove",this.onRelationsChange),e.off("Relations.redaction",this.onRelationsChange))}selectOption(e){if(e===this.state.selected)return;const t={[Xi.b.name]:{answers:[e]},"m.relates_to":{event_id:this.props.mxEvent.getId(),rel_type:"m.reference"}};this.context.sendEvent(this.props.mxEvent.getRoomId(),Xi.b.name,t).catch(e=>{console.error("Failed to submit poll response event:",e),Kt.a.createTrackedDialog("Vote not registered","",Jt.a,{title:Object(Ze.a)("Vote not registered"),description:Object(Ze.a)("Sorry, your vote was not registered. Please try again.")})}),this.setState({selected:e})}fetchPollRelations(){return this.props.getRelationsForEvent?this.props.getRelationsForEvent(this.props.mxEvent.getId(),"m.reference",Xi.b.name):null}collectUserVotes(){return function(e,t,s){const n=new Map;for(const t of e){const e=n.get(t.sender);(!e||e.ts<t.ts)&&n.set(t.sender,t)}s&&n.set(t,new ea(0,t,[s]));return n}((e=this.state.pollRelations)?e.getRelations().filter((function(e){return e.getType()===Xi.b.name&&e.getContent().hasOwnProperty(Xi.b.name)})).map(ta):[],this.context.getUserId(),this.state.selected);var e}totalVotes(e){let t=0;for(const s of e.values())t+=s;return t}render(){var e;const t=this.props.mxEvent.getContent()[Xi.c.name];if(t.answers.length<1||t.answers.length>20)return null;const s=this.props.mxEvent.getId(),n=this.collectUserVotes(),i=function(e,t){const s=new Map,n=t[Xi.c.name],i=n.answers.map(e=>e.id);function a(e){return i.includes(e)}for(const t of e.values())if(t.answers.every(a))for(const[e,n]of t.answers.entries()){if(e>=1)break;s.has(n)?s.set(n,s.get(n)+1):s.set(n,1)}return s}(n,this.props.mxEvent.getContent()),a=this.totalVotes(i),o=this.context.getUserId(),r=null===(e=n.get(o))||void 0===e?void 0:e.answers[0];return d.a.createElement("div",{className:"mx_MPollBody"},d.a.createElement("h2",null,t.question["org.matrix.msc1767.text"]),d.a.createElement("div",{className:"mx_MPollBody_allOptions"},t.answers.map(e=>{var t;const n=r===e.id,o="mx_MPollBody_option"+(n?" mx_MPollBody_option_checked":""),c=null!==(t=i.get(e.id))&&void 0!==t?t:0,l=Math.round(100*c/a);return d.a.createElement("div",{key:e.id,className:o,onClick:()=>this.selectOption(e.id)},d.a.createElement(ti.a,{name:"poll_answer_select-"+s,value:e.id,checked:n,onChange:this.onOptionSelected},d.a.createElement("div",{className:"mx_MPollBody_optionDescription"},d.a.createElement("div",{className:"mx_MPollBody_optionText"},e["org.matrix.msc1767.text"]),d.a.createElement("div",{className:"mx_MPollBody_optionVoteCount"},Object(Ze.a)("%(count)s votes",{count:c})))),d.a.createElement("div",{className:"mx_MPollBody_popularityBackground"},d.a.createElement("div",{className:"mx_MPollBody_popularityAmount",style:{width:l+"%"}})))})),d.a.createElement("div",{className:"mx_MPollBody_totalVotes"},Object(Ze.a)("Based on %(count)s votes",{count:a})))}},Qe()(Yi,"contextType",Ni.a),Ji=Qi))||Ji;class ea{constructor(e,t,s){this.ts=e,this.sender=t,this.answers=s}}function ta(e){const t=e.getContent()[Xi.b.name].answers;return new ea(e.getTs(),e.getSender(),t)}var sa,na=s(202);let ia=Object(h.a)("views.messages.MStickerBody")(sa=class extends Fi.a{constructor(...e){super(...e),Qe()(this,"onClick",e=>{e.preventDefault(),this.state.showImage||this.showImage()})}wrapImage(e,t){let s=null;this.state.showImage||(s=this.onClick);return[d.a.createElement("div",{className:"mx_MStickerBody_wrapper",onClick:s}," ",t," "),this.props.scBubbleGroupTimestamp]}getPlaceholder(e,t){var n;return null!==(n=this.props.mxEvent.getContent().info)&&void 0!==n&&n[na.a]?super.getPlaceholder(e,t):d.a.createElement("img",{src:s(1626),width:"75",height:"75"})}getTooltip(){const e=this.props.mxEvent&&this.props.mxEvent.getContent();return e&&e.body&&e.info&&e.info.w?d.a.createElement("div",{style:{left:e.info.w+"px"},className:"mx_MStickerBody_tooltip"},d.a.createElement(ci.b,{label:e.body})):null}getFileBody(){return null}})||sa;var aa,oa=s(95),ra=s.n(oa),ca=s(710),la=s(89),da=s(382);let ha=Object(h.a)("views.messages.MVideoBody")(aa=class extends d.a.PureComponent{constructor(e){super(e),Qe()(this,"videoRef",d.a.createRef()),Qe()(this,"sizeWatcher",void 0),Qe()(this,"videoOnPlay",async()=>{this.hasContentUrl()||this.state.fetchingData||this.state.error||(this.setState({fetchingData:!0}),this.props.mediaEventHelper.media.isEncrypted?(this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value,fetchingData:!1},()=>{this.videoRef.current&&this.videoRef.current.play()}),this.props.onHeightChanged()):this.setState({error:"No file given in content"}))}),Qe()(this,"getFileBody",()=>this.props.forExport?null:this.props.tileShape&&d.a.createElement(Li.a,ra()({},this.props,{showGenericPlaceholder:!1}))),this.state={fetchingData:!1,decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,posterLoading:!1,blurhashUrl:null}}suggestedDimensions(e){return Object(da.b)(la.b.getValue("Images.size"))}thumbScale(e,t,s,n){if(!e||!t)return;if(!s||!n){const i=this.suggestedDimensions(e<t);s=i.w,n=i.h}if(e<s&&t<n)return 1;return s/e}getContentUrl(){var e;const t=this.props.mxEvent.getContent();if(this.props.forExport)return(null===(e=t.file)||void 0===e?void 0:e.url)||t.url;const s=Object(ut.a)(t);return s.isEncrypted?this.state.decryptedUrl:s.srcHttp}hasContentUrl(){const e=this.getContentUrl();return e&&!e.startsWith("data:")}getThumbUrl(){if(this.props.forExport)return null;const e=this.props.mxEvent.getContent(),t=Object(ut.a)(e);return t.isEncrypted&&this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.posterLoading?this.state.blurhashUrl:t.hasThumbnail?t.thumbnailHttp:null}loadBlurhash(){var e;const t=null===(e=this.props.mxEvent.getContent())||void 0===e?void 0:e.info;if(!t[na.a])return;const s=document.createElement("canvas");let n=t.w,i=t.h;const a=this.thumbScale(t.w,t.h);a&&(n=Math.floor(t.w*a),i=Math.floor(t.h*a)),s.width=n,s.height=i;const o=Object(ca.decode)(t[na.a],n,i),r=s.getContext("2d"),c=r.createImageData(n,i);c.data.set(o),r.putImageData(c,0,0),this.setState({blurhashUrl:s.toDataURL(),posterLoading:!0});const l=this.props.mxEvent.getContent(),d=Object(ut.a)(l);if(d.hasThumbnail){const e=new Image;e.onload=()=>{this.setState({posterLoading:!1})},e.src=d.thumbnailHttp}}async componentDidMount(){if(this.sizeWatcher=la.b.watchSetting("Images.size",null,()=>{this.forceUpdate()}),this.loadBlurhash(),this.props.mediaEventHelper.media.isEncrypted&&null===this.state.decryptedUrl)try{const s=la.b.getValue("autoplayVideo"),n=await this.props.mediaEventHelper.thumbnailUrl.value;if(s)wt.a.log("Preloading video"),this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedThumbnailUrl:n,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value}),this.props.onHeightChanged();else{var e,t;wt.a.log("NOT preloading video");const s=this.props.mxEvent.getContent();this.setState({decryptedUrl:`data:${null==s||null===(e=s.info)||void 0===e?void 0:e.mimetype},`,decryptedThumbnailUrl:n||`data:${null==s||null===(t=s.info)||void 0===t?void 0:t.mimetype},`,decryptedBlob:null})}}catch(e){wt.a.warn("Unable to decrypt attachment: ",e),this.setState({error:e})}}componentWillUnmount(){la.b.unwatchSetting(this.sizeWatcher)}render(){const e=this.props.mxEvent.getContent(),t=la.b.getValue("autoplayVideo");if(null!==this.state.error)return d.a.createElement(d.a.Fragment,null,d.a.createElement("span",{className:"mx_MVideoBody"},d.a.createElement("img",{src:s(270),width:"16",height:"16"}),Object(Ze.a)("Error decrypting video"),this.props.scBubbleActionBar),this.props.scBubbleGroupTimestamp);if(!this.props.forExport&&void 0!==e.file&&null===this.state.decryptedUrl&&t)return d.a.createElement(d.a.Fragment,null,d.a.createElement("span",{className:"mx_MVideoBody"},d.a.createElement("div",{className:"mx_MImageBody_thumbnail mx_MImageBody_thumbnail_spinner"},d.a.createElement(xn.a,null)),this.props.scBubbleActionBar),this.props.scBubbleGroupTimestamp);const n=this.getContentUrl(),i=this.getThumbUrl(),a=this.suggestedDimensions(!1);let o=null,r=null,c=null,l="metadata";e.info&&(e.info.w&&(r=Math.floor(e.info.w)),e.info.h&&(o=Math.floor(e.info.h)),i&&(c=i,l="none"));const h=this.getFileBody();return d.a.createElement("span",{className:"mx_MVideoBody",style:{maxWidth:`min(100%, ${a.w+2}px)`}},d.a.createElement("span",{className:"sc_MVideoBody_video_container"},d.a.createElement("video",{className:"mx_MVideoBody",ref:this.videoRef,src:n,title:e.body,controls:!0,preload:l,muted:t,autoPlay:t,height:o,width:r,poster:c,onPlay:this.videoOnPlay,style:{maxHeight:a.h+"px",maxWidth:`min(100%, ${a.w}px)`}}),h,this.props.scBubbleActionBar),this.props.scBubbleGroupTimestamp)}})||aa;var ua,ma=s(504),pa=s(167);let ga=Object(h.a)("views.messages.MVoiceOrAudioBody")(ua=class extends d.a.PureComponent{render(){return!this.props.forExport&&Object(pa.f)(this.props.mxEvent)?d.a.createElement(ma.a,this.props):d.a.createElement(Ui.a,this.props)}})||ua;var va,fa=s(755),ba=s(718),ya=s(501);let Ea=Object(h.a)("views.messages.MjolnirBody")(va=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onAllowClick",e=>{e.preventDefault(),e.stopPropagation();const t=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;localStorage.setItem(t,"true"),this.props.onMessageAllowed()})}render(){return d.a.createElement("div",{className:"mx_MjolnirBody"},d.a.createElement("i",null,Object(Ze.a)("You have ignored this user, so their message is hidden. <a>Show anyways.</a>",{},{a:e=>d.a.createElement("a",{href:"#",onClick:this.onAllowClick},e)})))}})||va;var Sa,_a=s(763),wa=s(764),Ca=s(765),Oa=s(481);let ka=Object(h.a)("views.messages.RoomAvatarEvent")(Sa=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onAvatarClick",()=>{const e=et.a.get(),t=this.props.mxEvent,s=Object(ut.b)(t.getContent().url).srcHttp,n=e.getRoom(this.props.mxEvent.getRoomId()),i={src:s,name:Object(Ze.a)("%(senderDisplayName)s changed the avatar for %(roomName)s",{senderDisplayName:t.sender&&t.sender.name?t.sender.name:t.getSender(),roomName:n?n.name:""})};Kt.a.createDialog(Rn.a,i,"mx_Dialog_lightbox",null,!0)})}render(){const e=this.props.mxEvent,t=e.sender&&e.sender.name?e.sender.name:e.getSender();if(!e.getContent().url||0===e.getContent().url.trim().length)return d.a.createElement("div",{className:"mx_TextualEvent"},Object(Ze.a)("%(senderDisplayName)s removed the room avatar.",{senderDisplayName:t}));const s=et.a.get().getRoom(e.getRoomId()),n={avatarUrl:e.getContent().url,name:s?s.name:""};return d.a.createElement("div",{className:"mx_RoomAvatarEvent"},Object(Ze.a)("%(senderDisplayName)s changed the room avatar to <img/>",{senderDisplayName:t},{img:()=>d.a.createElement(nn.a,{key:"avatar",className:"mx_RoomAvatarEvent_avatar",onClick:this.onAvatarClick},d.a.createElement(De.a,{width:14,height:14,oobData:n}))}))}})||Sa;var Ra,Ia=s(120);let xa=Object(h.a)("views.messages.RoomCreate")(Ra=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onLinkClicked",e=>{e.preventDefault();const t=this.props.mxEvent.getContent().predecessor;tt.a.dispatch({action:lt.a.ViewRoom,event_id:t.event_id,highlighted:!0,room_id:t.room_id})})}render(){const e=this.props.mxEvent.getContent().predecessor;if(void 0===e)return d.a.createElement("div",null);const t=et.a.get().getRoom(e.room_id),s=new Ia.a(t,e.room_id);s.load();const n=s.forEvent(e.event_id),i=d.a.createElement("a",{href:n,onClick:this.onLinkClicked},Object(Ze.a)("Click here to see older messages."));return d.a.createElement(ji.a,{className:"mx_CreateEvent",title:Object(Ze.a)("This room is a continuation of another conversation."),subtitle:i})}})||Ra;var Ta,ja,Na,Pa=s(375),Da=s(1627),Ma=s(118),Aa=s(255);let Ua=Object(h.a)("views.messages.TextualEvent")((Na=ja=class extends d.a.Component{render(){var e;const t=Aa.b(this.props.mxEvent,!0,null===(e=this.context)||void 0===e?void 0:e.showHiddenEventsInTimeline);return t?d.a.createElement("div",{className:"mx_TextualEvent"},t):null}},Qe()(ja,"contextType",Ma.b),Ta=Na))||Ta;var La,Fa=s(893),Ba=s(719);let Va=Object(h.a)("views.messages.ViewSourceEvent")(La=class extends d.a.PureComponent{constructor(e){super(e),Qe()(this,"onToggle",e=>{e.preventDefault();const{expanded:t}=this.state;this.setState({expanded:!t})}),this.state={expanded:!1}}componentDidMount(){const{mxEvent:e}=this.props;et.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()&&e.once("Event.decrypted",()=>this.forceUpdate())}render(){const{mxEvent:e}=this.props,{expanded:t}=this.state;let s;s=t?d.a.createElement("pre",null,JSON.stringify(e,null,4)):d.a.createElement("code",null,`{ "type": ${e.getType()} }`);const n=ht()("mx_ViewSourceEvent mx_EventTile_content",{mx_ViewSourceEvent_expanded:t});return d.a.createElement("span",{className:n},s,d.a.createElement("a",{className:"mx_ViewSourceEvent_toggle",href:"#",onClick:this.onToggle}))}})||La;var Ka,Wa,Ga,Ha=s(182),qa=s(545),$a=s(394),za=s(949),Ja=s(578),Ya=s(579),Qa=s(417),Xa=s(938),Za=s(400),eo=s(930),to=s(901),so=s(815),no=s(895),io=s(522),ao=s(801),oo=s(1034),ro=s(802),co=s(577),lo=s(1025),ho=s(935),uo=s(594),mo=s(215),po=s(1018),go=s(312),vo=s(134),fo=s(779),bo=s(943),yo=s(1019),Eo=s(1044),So=s(896),_o=s(897),wo=s(403),Co=s(921),Oo=s(890),ko=s(192),Ro=s(717),Io=s(494),xo=s(1033),To=s(907),jo=s(476),No=s(846),Po=s(107),Do=s(138),Mo=s(110),Ao=s.n(Mo),Uo=s(180);function Lo(e){return Object(Uo.b)(e.canonicalAlias,e.aliases)}const Fo=Ao.a.shape({name:Ao.a.string,topic:Ao.a.string,roomId:Ao.a.string,avatarUrl:Ao.a.string,numJoinedMembers:Ao.a.number,canonicalAlias:Ao.a.string,aliases:Ao.a.arrayOf(Ao.a.string),worldReadable:Ao.a.bool,guestCanJoin:Ao.a.bool});let Bo=Object(h.a)("views.rooms.RoomDetailRow")((Ga=Wa=class extends d.a.Component{constructor(e){super(e),Qe()(this,"onClick",e=>{e.preventDefault(),this.props.onClick&&this.props.onClick(e,this.props.room)}),Qe()(this,"onTopicClick",e=>{e.stopPropagation()}),this._topic=Object(l.createRef)()}componentDidMount(){this._linkifyTopic()}componentDidUpdate(){this._linkifyTopic()}_linkifyTopic(){this._topic.current&&Object(Do.g)(this._topic.current)}render(){const e=Po.getComponent("avatars.BaseAvatar"),t=this.props.room,s=t.name||Lo(t)||Object(Ze.a)("Unnamed room"),n=t.worldReadable?d.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(Ze.a)("World readable")):d.a.createElement("div",null),i=t.guestCanJoin?d.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(Ze.a)("Guests can join")):d.a.createElement("div",null),a=n||i?d.a.createElement("div",{className:"mx_RoomDirectory_perms"},n," ",i):d.a.createElement("div",null);let o=null;return t.avatarUrl&&(o=Object(ut.b)(t.avatarUrl).getSquareThumbnailHttp(24)),d.a.createElement("tr",{key:t.roomId,onClick:this.onClick,onMouseDown:this.props.onMouseDown},d.a.createElement("td",{className:"mx_RoomDirectory_roomAvatar"},d.a.createElement(e,{width:24,height:24,resizeMethod:"crop",name:s,idName:s,url:o})),d.a.createElement("td",{className:"mx_RoomDirectory_roomDescription"},d.a.createElement("div",{className:"mx_RoomDirectory_name"},s)," ",a,d.a.createElement("div",{className:"mx_RoomDirectory_topic",ref:this._topic,onClick:this.onTopicClick},t.topic),d.a.createElement("div",{className:"mx_RoomDirectory_alias"},Lo(t))),d.a.createElement("td",{className:"mx_RoomDirectory_roomMemberCount"},t.numJoinedMembers))}},Qe()(Wa,"propTypes",{room:Fo,onClick:Ao.a.func,onMouseDown:Ao.a.func}),Ka=Ga))||Ka;var Vo;let Ko=Object(h.a)("views.rooms.RoomDetailList")(Vo=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onDetailsClick",(e,t)=>{tt.a.dispatch({action:lt.a.ViewRoom,room_id:t.roomId,room_alias:t.getCanonicalAlias()||(t.getAltAliases()||[])[0]})})}getRows(){return this.props.rooms?this.props.rooms.map((e,t)=>d.a.createElement(Bo,{key:t,room:e,onClick:this.onDetailsClick})):[]}render(){let e;return e=0===this.getRows().length?d.a.createElement("i",null,Object(Ze.a)("No rooms to show")):d.a.createElement("table",{className:"mx_RoomDirectory_table"},d.a.createElement("tbody",null,this.getRows())),d.a.createElement("div",{className:ht()("mx_RoomDetailList",this.props.className)},e)}})||Vo;var Wo,Go=s(937),Ho=s(517),qo=s(849),$o=s(931),zo=s(518),Jo=s(519),Yo=s(934),Qo=s(933),Xo=s(942),Zo=s(912);let er=Object(h.a)("views.rooms.SimpleRoomHeader")(Wo=class extends d.a.PureComponent{render(){let e;return this.props.icon&&(e=d.a.createElement("img",{className:"mx_RoomHeader_icon",src:this.props.icon,width:"25",height:"25"})),d.a.createElement("div",{className:"mx_RoomHeader mx_RoomHeader_wrapper"},d.a.createElement("div",{className:"mx_RoomHeader_simpleHeader"},e,this.props.title))}})||Wo;var tr,sr,nr,ir,ar=s(905),or=s(903),rr=s(944),cr=s(908),lr=s(1039),dr=s(445),hr=s(807);!function(e){e.Display="display",e.Uploading="uploading",e.Error="error"}(ir||(ir={}));let ur=Object(h.a)("views.settings.ChangeAvatar")((nr=sr=class extends d.a.Component{constructor(e){super(e),Qe()(this,"avatarSet",!1),Qe()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&"m.room.avatar"===e.getType()&&e.getSender()===et.a.get().getUserId()&&(e.getContent().url||(this.avatarSet=!1,this.setState({})))}),Qe()(this,"onFileSelected",e=>(this.avatarSet=!0,this.setAvatarFromFile(e.target.files[0]))),Qe()(this,"onError",()=>{this.setState({errorText:Object(Ze.a)("Failed to upload profile picture!")})}),this.state={avatarUrl:this.props.initialAvatarUrl,phase:ir.Display}}componentDidMount(){et.a.get().on("RoomState.events",this.onRoomStateEvents)}UNSAFE_componentWillReceiveProps(e){this.avatarSet||this.setState({avatarUrl:e.initialAvatarUrl})}componentWillUnmount(){et.a.get()&&et.a.get().removeListener("RoomState.events",this.onRoomStateEvents)}setAvatarFromFile(e){let t=null;this.setState({phase:ir.Uploading});const s=et.a.get().uploadContent(e).then(e=>(t=e,this.props.room?et.a.get().sendStateEvent(this.props.room.roomId,"m.room.avatar",{url:e},""):et.a.get().setAvatarUrl(e)));return s.then(()=>{this.setState({phase:ir.Display,avatarUrl:Object(ut.b)(t).srcHttp})},()=>{this.setState({phase:ir.Error}),this.onError()}),s}render(){let e,t;switch(e=this.props.room&&!this.avatarSet?d.a.createElement(De.a,{room:this.props.room,width:this.props.width,height:this.props.height,resizeMethod:"crop"}):d.a.createElement(xe.a,{width:this.props.width,height:this.props.height,resizeMethod:"crop",name:"?",idName:et.a.get().getUserIdLocalpart(),url:this.state.avatarUrl}),this.props.showUploadSection&&(t=d.a.createElement("div",{className:this.props.className},Object(Ze.a)("Upload new:"),d.a.createElement("input",{type:"file",accept:"image/*",onChange:this.onFileSelected}),this.state.errorText)),this.state.phase){case ir.Display:case ir.Error:return d.a.createElement("div",null,d.a.createElement("div",{className:this.props.className},e),t);case ir.Uploading:return d.a.createElement(bn.a,null)}}},Qe()(sr,"defaultProps",{showUploadSection:!0,className:"",width:80,height:80}),tr=nr))||tr;var mr;let pr=Object(h.a)("views.settings.ChangeDisplayName")(mr=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"getDisplayName",async()=>{const e=et.a.get();try{return(await e.getProfileInfo(e.getUserId())).displayname}catch(e){throw new Error("Failed to fetch display name")}}),Qe()(this,"changeDisplayName",e=>et.a.get().setDisplayName(e).catch((function(){throw new Error("Failed to set display name")})))}render(){return d.a.createElement(yn,{getInitialValue:this.getDisplayName,placeholder:Object(Ze.a)("No display name"),blurToSubmit:!0,onSubmit:this.changeDisplayName})}})||mr;var gr,vr,fr,br=s(983),yr=s(1001),Er=s(998),Sr=s(999),_r=s(1e3),wr=s(997),Cr=s(1003),Or=s(992),kr=s(994),Rr=s(492),Ir=s(523),xr=s(990),Tr=s(1028),jr=s(652),Nr=s(996),Pr=s(986),Dr=s(987),Mr=s(656),Ar=s(562),Ur=s(1010),Lr=s(980),Fr=s(979),Br=s(981),Vr=s(982),Kr=s(535),Wr=s(806),Gr=s(800),Hr=s(805),qr=s(537),$r=s(804),zr=s(989),Jr=s(651),Yr=s(1009),Qr=s(988),Xr=s(1013),Zr=s(1005),ec=s(1007),tc=s(995),sc=s(561),nc=s(1008),ic=s(870),ac=s(451),oc=s(540),rc=s(300),cc=s(868),lc=s(539),dc=s(782),hc=s(783),uc=s(1038),mc=s(985),pc=s(1020),gc=s(179),vc=s(777),fc=s(970),bc=s(834),yc=s(833),Ec=s(546),Sc=s(881),_c=s(880),wc=s(857),Cc=s(858),Oc=s(559),kc=s(862),Rc=s(861),Ic=s(936),xc=s(860),Tc=s(390),jc=s(826),Nc=s(1036),Pc=s(560),Dc=s(958),Mc=s(948),Ac=s(946),Uc=s(249);let Lc=Object(h.a)("views.context_menus.GroupInviteTileContextMenu")((fr=vr=class extends d.a.Component{constructor(e){super(e),this._onClickReject=this._onClickReject.bind(this)}componentDidMount(){this._unmounted=!1}componentWillUnmount(){this._unmounted=!0}_onClickReject(){const e=Po.getComponent("dialogs.QuestionDialog");Kt.a.createTrackedDialog("Reject community invite","",e,{title:Object(Ze.a)("Reject invitation"),description:Object(Ze.a)("Are you sure you want to reject the invitation?"),onFinished:async e=>{if(!e)return;const t=Po.getComponent("elements.Spinner"),s=Kt.a.createDialog(t,null,"mx_Dialog_spinner");try{await nt.a.leaveGroup(this.props.group.groupId)}catch(e){wt.a.error("Error rejecting community invite: ",e);const t=Po.getComponent("dialogs.ErrorDialog");Kt.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(Ze.a)("Error"),description:Object(Ze.a)("Unable to reject invite")})}finally{s.close()}}}),this.props.onFinished&&this.props.onFinished()}render(){return d.a.createElement("div",null,d.a.createElement(o.e,{className:"mx_RoomTileContextMenu_leave",onClick:this._onClickReject},d.a.createElement("img",{className:"mx_RoomTileContextMenu_tag_icon",src:s(1628),width:"15",height:"15",alt:""}),Object(Ze.a)("Reject")))}},Qe()(vr,"propTypes",{group:Ao.a.instanceOf(Uc.a).isRequired,onFinished:Ao.a.func}),gr=fr))||gr;var Fc,Bc,Vc,Kc=s(456),Wc=s(190),Gc=s(186);let Hc=Object(h.a)("views.context_menus.TagTileContextMenu")((Vc=Bc=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"_onViewCommunityClick",()=>{tt.a.dispatch({action:"view_group",group_id:this.props.tag}),this.props.onFinished()}),Qe()(this,"_onRemoveClick",()=>{tt.a.dispatch(Kc.a.removeTag(this.context,this.props.tag)),this.props.onFinished()}),Qe()(this,"_onCreateSpaceClick",()=>{Object(Gc.b)(this.context,this.props.tag),this.props.onFinished()}),Qe()(this,"_onMoveUp",()=>{tt.a.dispatch(Kc.a.moveTag(this.context,this.props.tag,this.props.index-1)),this.props.onFinished()}),Qe()(this,"_onMoveDown",()=>{tt.a.dispatch(Kc.a.moveTag(this.context,this.props.tag,this.props.index+1)),this.props.onFinished()})}render(){let e,t,s;return this.props.index>0&&(e=d.a.createElement(o.e,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_moveUp",onClick:this._onMoveUp},Object(Ze.a)("Move up"))),this.props.index<(Wc.a.getOrderedTags()||[]).length-1&&(t=d.a.createElement(o.e,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_moveDown",onClick:this._onMoveDown},Object(Ze.a)("Move down"))),nt.a.isUserPrivileged(this.props.tag)&&(s=d.a.createElement(d.a.Fragment,null,d.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}),d.a.createElement(o.e,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_createSpace",onClick:this._onCreateSpaceClick},Object(Ze.a)("Create Space")))),d.a.createElement("div",null,d.a.createElement(o.e,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_viewCommunity",onClick:this._onViewCommunityClick},Object(Ze.a)("View Community")),e||t?d.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}):null,e,t,d.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}),d.a.createElement(o.e,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_hideCommunity",onClick:this._onRemoveClick},Object(Ze.a)("Unpin")),s)}},Qe()(Bc,"propTypes",{tag:Ao.a.string.isRequired,index:Ao.a.number.isRequired,onFinished:Ao.a.func.isRequired}),Qe()(Bc,"contextType",Ni.a),Fc=Vc))||Fc;var qc,$c,zc,Jc=s(955),Yc=s(707),Qc=s(385),Xc=s(956),Zc=s(155);let el=Object(h.a)("views.groups.GroupInviteTile")((zc=$c=class extends d.a.Component{constructor(e,t){super(e,t),Qe()(this,"onClick",e=>{tt.a.dispatch({action:"view_group",group_id:this.props.group.groupId})}),Qe()(this,"onMouseEnter",()=>{const e={hover:!0};this.context.isGuest()||(e.badgeHover=!0),this.setState(e)}),Qe()(this,"onMouseLeave",()=>{this.setState({badgeHover:!1,hover:!1})}),Qe()(this,"onContextMenuButtonClick",e=>{e.stopPropagation(),e.preventDefault(),this._showContextMenu(e.target.getBoundingClientRect())}),Qe()(this,"onContextMenu",e=>{e.preventDefault(),this._showContextMenu({right:e.clientX,top:e.clientY,height:0})}),Qe()(this,"closeMenu",()=>{this.setState({contextMenuPosition:null})}),this.state={hover:!1,badgeHover:!1,menuDisplayed:!1,selected:null===this.props.group.groupId}}_showContextMenu(e){if(et.a.get().isGuest())return;const t={contextMenuPosition:e};this.props.collapsed&&(t.hover=!1),this.setState(t)}render(){const e=Po.getComponent("elements.AccessibleButton"),t=Po.getComponent("avatars.BaseAvatar"),s=this.props.group.name||this.props.group.groupId,n=this.props.group.avatarUrl?Object(ut.b)(this.props.group.avatarUrl).getSquareThumbnailHttp(24):null,i=d.a.createElement(t,{name:s,width:24,height:24,url:n}),a=Boolean(this.state.contextMenuPosition),r=ht()("mx_RoomTile_name mx_RoomTile_invite mx_RoomTile_badgeShown",{mx_RoomTile_badgeShown:this.state.badgeHover||a}),c=d.a.createElement("div",{title:this.props.group.groupId,className:r,tabIndex:-1,dir:"auto"},s),l=this.state.badgeHover||a,h=ht()("mx_RoomTile_badge mx_RoomTile_highlight",{mx_RoomTile_badgeButton:l}),u=l?"···":"!";let m;if(this.props.collapsed&&this.state.hover){const e=Po.getComponent("elements.Tooltip");m=d.a.createElement(e,{className:"mx_RoomTile_tooltip",label:s,dir:"auto"})}const p=ht()("mx_RoomTile mx_RoomTile_highlight",{mx_RoomTile_menuDisplayed:a,mx_RoomTile_selected:this.state.selected,mx_GroupInviteTile:!0});let g;if(a){const e=Po.getComponent("context_menus.GroupInviteTileContextMenu");g=d.a.createElement(o.n,ra()({},Object(o.o)(this.state.contextMenuPosition),{onFinished:this.closeMenu}),d.a.createElement(e,{group:this.props.group,onFinished:this.closeMenu}))}return d.a.createElement(d.a.Fragment,null,d.a.createElement(Zc.d,null,({onFocus:t,isActive:s,ref:n})=>d.a.createElement(e,{onFocus:t,tabIndex:s?0:-1,inputRef:n,className:p,onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onContextMenu:this.onContextMenu},d.a.createElement("div",{className:"mx_RoomTile_avatar"},i),d.a.createElement("div",{className:"mx_RoomTile_nameContainer"},c,d.a.createElement(o.b,{className:h,onClick:this.onContextMenuButtonClick,label:Object(Ze.a)("Options"),isExpanded:a,tabIndex:s?0:-1},u)),m)),g)}},Qe()($c,"propTypes",{group:Ao.a.object.isRequired}),Qe()($c,"contextType",Ni.a),qc=zc))||qc;var tl,sl,nl,il=s(898),al=s(449);let ol=Object(h.a)("views.groups.GroupMemberTile")((nl=sl=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onClick",e=>{tt.a.dispatch({action:"view_group_user",member:this.props.member,groupId:this.props.groupId})})}render(){const e=Po.getComponent("avatars.BaseAvatar"),t=Po.getComponent("rooms.EntityTile"),s=this.props.member.displayname||this.props.member.userId,n=this.props.member.avatarUrl?Object(ut.b)(this.props.member.avatarUrl).getSquareThumbnailHttp(36):null,i=d.a.createElement(e,{"aria-hidden":"true",name:this.props.member.displayname||this.props.member.userId,idName:this.props.member.userId,width:36,height:36,url:n});return d.a.createElement(t,{name:s,avatarJsx:i,onClick:this.onClick,suppressOnHover:!0,presenceState:"online",powerStatus:this.props.member.isPrivileged?t.POWER_STATUS_ADMIN:null})}},Qe()(sl,"propTypes",{groupId:Ao.a.string.isRequired,member:al.a.isRequired}),Qe()(sl,"contextType",Ni.a),tl=nl))||tl;var rl,cl,ll;let dl=Object(h.a)("views.groups.GroupPublicityTile")((ll=cl=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"state",{busy:!1,ready:!1,isGroupPublicised:!1}),Qe()(this,"_onPublicityToggle",()=>{this.setState({busy:!0,isGroupPublicised:!this.state.isGroupPublicised}),nt.a.setGroupPublicity(this.props.groupId,!this.state.isGroupPublicised).then(()=>{this.setState({busy:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}_initGroupStore(e){this._groupStoreToken=nt.a.registerListener(e,()=>{this.setState({isGroupPublicised:Boolean(nt.a.getGroupPublicity(e)),ready:nt.a.isStateReady(e,nt.a.STATE_KEY.Summary)})})}componentWillUnmount(){this._groupStoreToken&&this._groupStoreToken.unregister()}render(){const e=Po.getComponent("groups.GroupTile");return d.a.createElement("div",{className:"mx_GroupPublicity_toggle"},d.a.createElement(e,{groupId:this.props.groupId,showDescription:!1,avatarHeight:40}),d.a.createElement(ri.a,{checked:this.state.isGroupPublicised,disabled:!this.state.ready||this.state.busy,onChange:this._onPublicityToggle}))}},Qe()(cl,"propTypes",{groupId:Ao.a.string.isRequired}),rl=ll))||rl;var hl,ul,ml,pl=s(900),gl=s(899);var vl,fl,bl,yl=Object(h.a)("views.groups.GroupRoomTile")((ml=ul=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"onClick",e=>{tt.a.dispatch({action:"view_group_room",groupId:this.props.groupId,groupRoomId:this.props.groupRoom.roomId})})}render(){const e=Po.getComponent("avatars.BaseAvatar"),t=Po.getComponent("elements.AccessibleButton"),s=this.props.groupRoom.avatarUrl?Object(ut.b)(this.props.groupRoom.avatarUrl).getSquareThumbnailHttp(36):null,n=d.a.createElement(e,{name:this.props.groupRoom.displayname,width:36,height:36,url:s});return d.a.createElement(t,{className:"mx_GroupRoomTile",onClick:this.onClick},d.a.createElement("div",{className:"mx_GroupRoomTile_avatar"},n),d.a.createElement("div",{className:"mx_GroupRoomTile_name"},this.props.groupRoom.displayname))}},Qe()(ul,"propTypes",{groupId:Ao.a.string.isRequired,groupRoom:al.b.isRequired}),Qe()(ul,"contextType",Ni.a),hl=ml))||hl,El=s(183);var Sl=Object(h.a)("views.groups.GroupTile")((bl=fl=class extends d.a.Component{constructor(...e){super(...e),Qe()(this,"state",{profile:null}),Qe()(this,"onClick",e=>{e.preventDefault(),tt.a.dispatch({action:"view_group",group_id:this.props.groupId})}),Qe()(this,"onPinClick",e=>{e.preventDefault(),e.stopPropagation(),tt.a.dispatch(Kc.a.moveTag(this.context,this.props.groupId,0))}),Qe()(this,"onUnpinClick",e=>{e.preventDefault(),e.stopPropagation(),tt.a.dispatch(Kc.a.removeTag(this.context,this.props.groupId))})}componentDidMount(){El.a.getGroupProfileCached(this.context,this.props.groupId).then(e=>{this.setState({profile:e})}).catch(e=>{wt.a.error("Error whilst getting cached profile for GroupTile",e)})}render(){const e=Po.getComponent("avatars.BaseAvatar"),t=Po.getComponent("elements.AccessibleButton"),s=this.state.profile||{},n=s.name||this.props.groupId,i=this.props.avatarHeight,a=this.props.showDescription?d.a.createElement("div",{className:"mx_GroupTile_desc"},s.shortDescription):d.a.createElement("div",null),o=s.avatarUrl?Object(ut.b)(s.avatarUrl).getSquareThumbnailHttp(i):null,r=d.a.createElement("div",{className:"mx_GroupTile_avatar"},d.a.createElement(e,{name:n,idName:this.props.groupId,url:o,width:i,height:i}));return d.a.createElement(t,{className:"mx_GroupTile",onClick:this.onClick},r,d.a.createElement("div",{className:"mx_GroupTile_profile"},d.a.createElement("div",{className:"mx_GroupTile_name"},n),a,d.a.createElement("div",{className:"mx_GroupTile_groupId"},this.props.groupId),(Wc.a.getOrderedTags()||[]).includes(this.props.groupId)?d.a.createElement(t,{kind:"link",onClick:this.onUnpinClick},Object(Ze.a)("Unpin")):d.a.createElement(t,{kind:"link",onClick:this.onPinClick},Object(Ze.a)("Pin"))))}},Qe()(fl,"propTypes",{groupId:Ao.a.string.isRequired,showDescription:Ao.a.bool,avatarHeight:Ao.a.number}),Qe()(fl,"contextType",Ni.a),Qe()(fl,"defaultProps",{showDescription:!0,avatarHeight:50}),vl=bl))||vl,_l=s(1012),wl=s(803),Cl=s(1011);let Ol={};i.a&&(Ol["structures.AutoHideScrollbar"]=i.a),a.a&&(Ol["structures.BackdropPanel"]=a.a),o.n&&(Ol["structures.ContextMenu"]=o.n),r.a&&(Ol["structures.EmbeddedPage"]=r.a),c.a&&(Ol["structures.FilePanel"]=c.a),u&&(Ol["structures.GenericErrorPage"]=u),v.a&&(Ol["structures.GroupFilterPanel"]=v.a),f.a&&(Ol["structures.HomePage"]=f.a),b.a&&(Ol["structures.HostSignupAction"]=b.a),y.a&&(Ol["structures.IndicatorScrollbar"]=y.a),E.b&&(Ol["structures.InteractiveAuth"]=E.b),S.a&&(Ol["structures.LeftPanel"]=S.a),_.a&&(Ol["structures.LeftPanelWidget"]=_.a),w.a&&(Ol["structures.LegacyCommunityPreview"]=w.a),C.a&&(Ol["structures.LoggedInView"]=C.a),O.a&&(Ol["structures.MainSplit"]=O.a),k.a&&(Ol["structures.MatrixChat"]=k.a),R.a&&(Ol["structures.MessagePanel"]=R.a),I.a&&(Ol["structures.NonUrgentToastContainer"]=I.a),x.a&&(Ol["structures.NotificationPanel"]=x.a),T.a&&(Ol["structures.RightPanel"]=T.a),j.a&&(Ol["structures.RoomDirectory"]=j.a),N.a&&(Ol["structures.RoomSearch"]=N.a),P.a&&(Ol["structures.RoomStatusBar"]=P.a),D.a&&(Ol["structures.RoomView"]=D.a),M.a&&(Ol["structures.ScrollPanel"]=M.a),A.a&&(Ol["structures.SearchBox"]=A.a),U.a&&(Ol["structures.SpaceHierarchy"]=U.a),L.a&&(Ol["structures.SpaceRoomView"]=L.a),F.c&&(Ol["structures.TabbedView"]=F.c),B.a&&(Ol["structures.ThreadPanel"]=B.a),V.a&&(Ol["structures.ThreadView"]=V.a),K.a&&(Ol["structures.TimelinePanel"]=K.a),W.a&&(Ol["structures.ToastContainer"]=W.a),G.a&&(Ol["structures.UploadBar"]=G.a),H.a&&(Ol["structures.UserMenu"]=H.a),q.a&&(Ol["structures.UserView"]=q.a),$.a&&(Ol["structures.ViewSource"]=$.a),z.a&&(Ol["structures.auth.CompleteSecurity"]=z.a),J.a&&(Ol["structures.auth.E2eSetup"]=J.a),Y.a&&(Ol["structures.auth.ForgotPassword"]=Y.a),Q.a&&(Ol["structures.auth.Login"]=Q.a),X.a&&(Ol["structures.auth.Registration"]=X.a),Z.a&&(Ol["structures.auth.SetupEncryptionBody"]=Z.a),ee.a&&(Ol["structures.auth.SoftLogout"]=ee.a),te.a&&(Ol["views.audio_messages.AudioPlayer"]=te.a),se.a&&(Ol["views.audio_messages.AudioPlayerBase"]=se.a),ne.a&&(Ol["views.audio_messages.Clock"]=ne.a),ie.a&&(Ol["views.audio_messages.DurationClock"]=ie.a),ae.a&&(Ol["views.audio_messages.LiveRecordingClock"]=ae.a),oe.a&&(Ol["views.audio_messages.LiveRecordingWaveform"]=oe.a),re.a&&(Ol["views.audio_messages.PlayPauseButton"]=re.a),ce.a&&(Ol["views.audio_messages.PlaybackClock"]=ce.a),le.a&&(Ol["views.audio_messages.PlaybackWaveform"]=le.a),de.a&&(Ol["views.audio_messages.RecordingPlayback"]=de.a),he.a&&(Ol["views.audio_messages.SeekBar"]=he.a),ue.a&&(Ol["views.audio_messages.Waveform"]=ue.a),me.a&&(Ol["views.auth.AuthBody"]=me.a),pe.a&&(Ol["views.auth.AuthFooter"]=pe.a),ge.a&&(Ol["views.auth.AuthHeader"]=ge.a),ve.a&&(Ol["views.auth.AuthHeaderLogo"]=ve.a),fe.a&&(Ol["views.auth.AuthPage"]=fe.a),be.a&&(Ol["views.auth.CaptchaForm"]=be.a),ye.a&&(Ol["views.auth.CompleteSecurityBody"]=ye.a),Ee.a&&(Ol["views.auth.CountryDropdown"]=Ee.a),Se.a&&(Ol["views.auth.EmailField"]=Se.a),_e.d&&(Ol["views.auth.InteractiveAuthEntryComponents"]=_e.d),we.a&&(Ol["views.auth.LanguageSelector"]=we.a),Ce.a&&(Ol["views.auth.PassphraseConfirmField"]=Ce.a),Oe.a&&(Ol["views.auth.PassphraseField"]=Oe.a),ke.a&&(Ol["views.auth.PasswordLogin"]=ke.a),Re.b&&(Ol["views.auth.RegistrationForm"]=Re.b),Ie.a&&(Ol["views.auth.Welcome"]=Ie.a),xe.a&&(Ol["views.avatars.BaseAvatar"]=xe.a),Te.a&&(Ol["views.avatars.DecoratedRoomAvatar"]=Te.a),je.a&&(Ol["views.avatars.GroupAvatar"]=je.a),Ne.a&&(Ol["views.avatars.MemberAvatar"]=Ne.a),Pe.a&&(Ol["views.avatars.MemberStatusMessageAvatar"]=Pe.a),De.a&&(Ol["views.avatars.RoomAvatar"]=De.a),Me.a&&(Ol["views.avatars.WidgetAvatar"]=Me.a),Ae.b&&(Ol["views.beta.BetaCard"]=Ae.b),Ue.a&&(Ol["views.context_menus.CallContextMenu"]=Ue.a),Le.a&&(Ol["views.context_menus.DialpadContextMenu"]=Le.a),Fe.a&&(Ol["views.context_menus.GenericElementContextMenu"]=Fe.a),Be.a&&(Ol["views.context_menus.GenericTextContextMenu"]=Be.a),Ve.e&&(Ol["views.context_menus.IconizedContextMenu"]=Ve.e),Ke.b&&(Ol["views.context_menus.MessageContextMenu"]=Ke.b),We.a&&(Ol["views.context_menus.RoomContextMenu"]=We.a),Ge.a&&(Ol["views.context_menus.SpaceContextMenu"]=Ge.a),He.a&&(Ol["views.context_menus.StatusMessageContextMenu"]=He.a),qe.a&&(Ol["views.context_menus.ThreadListContextMenu"]=qe.a),$e.a&&(Ol["views.context_menus.WidgetContextMenu"]=$e.a),ze.a&&(Ol["views.dialogs.AddExistingSubspaceDialog"]=ze.a),Je.d&&(Ol["views.dialogs.AddExistingToSpaceDialog"]=Je.d),Ot&&(Ol["views.dialogs.AddressPickerDialog"]=Ot),kt.a&&(Ol["views.dialogs.AskInviteAnywayDialog"]=kt.a),St.a&&(Ol["views.dialogs.BaseDialog"]=St.a),Rt.a&&(Ol["views.dialogs.BetaFeedbackDialog"]=Rt.a),It.a&&(Ol["views.dialogs.BugReportDialog"]=It.a),xt.a&&(Ol["views.dialogs.ChangelogDialog"]=xt.a),Tt.a&&(Ol["views.dialogs.CommunityPrototypeInviteDialog"]=Tt.a),jt.a&&(Ol["views.dialogs.ConfirmAndWaitRedactDialog"]=jt.a),Nt.b&&(Ol["views.dialogs.ConfirmRedactDialog"]=Nt.b),Pt.a&&(Ol["views.dialogs.ConfirmSpaceUserActionDialog"]=Pt.a),Dt.a&&(Ol["views.dialogs.ConfirmUserActionDialog"]=Dt.a),Mt.a&&(Ol["views.dialogs.ConfirmWipeDeviceDialog"]=Mt.a),At.a&&(Ol["views.dialogs.CreateCommunityPrototypeDialog"]=At.a),Ut.a&&(Ol["views.dialogs.CreateGroupDialog"]=Ut.a),Lt.a&&(Ol["views.dialogs.CreateRoomDialog"]=Lt.a),Ft.b&&(Ol["views.dialogs.CreateSpaceFromCommunityDialog"]=Ft.b),Bt.a&&(Ol["views.dialogs.CreateSubspaceDialog"]=Bt.a),Ht&&(Ol["views.dialogs.CryptoStoreTooNewDialog"]=Ht),qt.a&&(Ol["views.dialogs.DeactivateAccountDialog"]=qt.a),$t.b&&(Ol["views.dialogs.DevtoolsDialog"]=$t.b),zt.a&&(Ol["views.dialogs.EditCommunityPrototypeDialog"]=zt.a),Jt.a&&(Ol["views.dialogs.ErrorDialog"]=Jt.a),Yt.a&&(Ol["views.dialogs.ExportDialog"]=Yt.a),Qt.a&&(Ol["views.dialogs.FeedbackDialog"]=Qt.a),Xt.a&&(Ol["views.dialogs.ForwardDialog"]=Xt.a),Zt.a&&(Ol["views.dialogs.GenericFeatureFeedbackDialog"]=Zt.a),es.a&&(Ol["views.dialogs.HostSignupDialog"]=es.a),ts.a&&(Ol["views.dialogs.IncomingSasDialog"]=ts.a),ss.a&&(Ol["views.dialogs.InfoDialog"]=ss.a),ns.a&&(Ol["views.dialogs.IntegrationsDisabledDialog"]=ns.a),is.a&&(Ol["views.dialogs.IntegrationsImpossibleDialog"]=is.a),as.a&&(Ol["views.dialogs.InteractiveAuthDialog"]=as.a),os.d&&(Ol["views.dialogs.InviteDialog"]=os.d),rs.a&&(Ol["views.dialogs.KeySignatureUploadFailedDialog"]=rs.a),cs.a&&(Ol["views.dialogs.LazyLoadingDisabledDialog"]=cs.a),ls.a&&(Ol["views.dialogs.LazyLoadingResyncDialog"]=ls.a),ds.a&&(Ol["views.dialogs.LeaveSpaceDialog"]=ds.a),hs.a&&(Ol["views.dialogs.LogoutDialog"]=hs.a),us.a&&(Ol["views.dialogs.ManageRestrictedJoinRuleDialog"]=us.a),ms.a&&(Ol["views.dialogs.ManualDeviceKeyVerificationDialog"]=ms.a),ps.a&&(Ol["views.dialogs.MessageEditHistoryDialog"]=ps.a),gs.a&&(Ol["views.dialogs.ModalWidgetDialog"]=gs.a),Wt.a&&(Ol["views.dialogs.QuestionDialog"]=Wt.a),vs.a&&(Ol["views.dialogs.RegistrationEmailPromptDialog"]=vs.a),fs.a&&(Ol["views.dialogs.ReportEventDialog"]=fs.a),bs.c&&(Ol["views.dialogs.RoomSettingsDialog"]=bs.c),ys.a&&(Ol["views.dialogs.RoomUpgradeDialog"]=ys.a),Es.a&&(Ol["views.dialogs.RoomUpgradeWarningDialog"]=Es.a),Ss.a&&(Ol["views.dialogs.ScrollableBaseModal"]=Ss.a),_s.a&&(Ol["views.dialogs.ServerOfflineDialog"]=_s.a),ws.a&&(Ol["views.dialogs.ServerPickerDialog"]=ws.a),Cs.a&&(Ol["views.dialogs.SeshatResetDialog"]=Cs.a),Os.a&&(Ol["views.dialogs.SessionRestoreErrorDialog"]=Os.a),ks.a&&(Ol["views.dialogs.SetEmailDialog"]=ks.a),Rs.a&&(Ol["views.dialogs.ShareDialog"]=Rs.a),Is.a&&(Ol["views.dialogs.SlashCommandHelpDialog"]=Is.a),xs.a&&(Ol["views.dialogs.SpaceSettingsDialog"]=xs.a),Ts.a&&(Ol["views.dialogs.StorageEvictedDialog"]=Ts.a),js.a&&(Ol["views.dialogs.TabbedIntegrationManagerDialog"]=js.a),As&&(Ol["views.dialogs.TermsDialog"]=As),Ls.a&&(Ol["views.dialogs.TextInputDialog"]=Ls.a),Fs.a&&(Ol["views.dialogs.UntrustedDeviceDialog"]=Fs.a),Bs.a&&(Ol["views.dialogs.UploadConfirmDialog"]=Bs.a),Ws&&(Ol["views.dialogs.UploadFailureDialog"]=Ws),$s.b&&(Ol["views.dialogs.UserSettingsDialog"]=$s.b),zs.a&&(Ol["views.dialogs.VerificationRequestDialog"]=zs.a),Js.a&&(Ol["views.dialogs.WidgetCapabilitiesPromptDialog"]=Js.a),Ys.a&&(Ol["views.dialogs.WidgetOpenIDPermissionsDialog"]=Ys.a),Qs.a&&(Ol["views.dialogs.security.AccessSecretStorageDialog"]=Qs.a),Xs.a&&(Ol["views.dialogs.security.ConfirmDestroyCrossSigningDialog"]=Xs.a),Zs.a&&(Ol["views.dialogs.security.CreateCrossSigningDialog"]=Zs.a),en.a&&(Ol["views.dialogs.security.RestoreKeyBackupDialog"]=en.a),tn.a&&(Ol["views.dialogs.security.SetupEncryptionDialog"]=tn.a),sn.b&&(Ol["views.directory.NetworkDropdown"]=sn.b),nn.a&&(Ol["views.elements.AccessibleButton"]=nn.a),an.a&&(Ol["views.elements.AccessibleTooltipButton"]=an.a),on.a&&(Ol["views.elements.ActionButton"]=on.a),ft&&(Ol["views.elements.AddressSelector"]=ft),gt&&(Ol["views.elements.AddressTile"]=gt),rn.a&&(Ol["views.elements.AppPermission"]=rn.a),cn.a&&(Ol["views.elements.AppTile"]=cn.a),ln.a&&(Ol["views.elements.AppWarning"]=ln.a),dn.b&&(Ol["views.elements.DesktopBuildsNotice"]=dn.b),hn.a&&(Ol["views.elements.DesktopCapturerSourcePicker"]=hn.a),un.a&&(Ol["views.elements.DialPadBackspaceButton"]=un.a),_t.a&&(Ol["views.elements.DialogButtons"]=_t.a),mn.a&&(Ol["views.elements.DirectorySearchBox"]=mn.a),pn.a&&(Ol["views.elements.Draggable"]=pn.a),gn.a&&(Ol["views.elements.Dropdown"]=gn.a),vn.a&&(Ol["views.elements.EditableItemList"]=vn.a),fn.a&&(Ol["views.elements.EditableText"]=fn.a),yn&&(Ol["views.elements.EditableTextContainer"]=yn),En.a&&(Ol["views.elements.EffectsOverlay"]=En.a),Sn.a&&(Ol["views.elements.ErrorBoundary"]=Sn.a),_n.a&&(Ol["views.elements.EventListSummary"]=_n.a),wn.a&&(Ol["views.elements.EventTilePreview"]=wn.a),Cn.a&&(Ol["views.elements.FacePile"]=Cn.a),On.a&&(Ol["views.elements.Field"]=On.a),kn.a&&(Ol["views.elements.IRCTimelineProfileResizer"]=kn.a),Rn.a&&(Ol["views.elements.ImageView"]=Rn.a),In.b&&(Ol["views.elements.InfoTooltip"]=In.b),xn.a&&(Ol["views.elements.InlineSpinner"]=xn.a),Tn.a&&(Ol["views.elements.InviteReason"]=Tn.a),jn.a&&(Ol["views.elements.JoinRuleDropdown"]=jn.a),Nn.a&&(Ol["views.elements.LabelledToggleSwitch"]=Nn.a),Pn.a&&(Ol["views.elements.LanguageDropdown"]=Pn.a),Dn.a&&(Ol["views.elements.LazyRenderList"]=Dn.a),Mn.a&&(Ol["views.elements.MemberEventListSummary"]=Mn.a),An.b&&(Ol["views.elements.MiniAvatarUploader"]=An.b),Un.a&&(Ol["views.elements.PersistedElement"]=Un.a),Ln.a&&(Ol["views.elements.PersistentApp"]=Ln.a),Fn.a&&(Ol["views.elements.PollCreateDialog"]=Fn.a),Bn.a&&(Ol["views.elements.PowerSelector"]=Bn.a),Vn.a&&(Ol["views.elements.ProgressBar"]=Vn.a),Kn.a&&(Ol["views.elements.QRCode"]=Kn.a),Wn.a&&(Ol["views.elements.ReplyChain"]=Wn.a),Gn.a&&(Ol["views.elements.ResizeHandle"]=Gn.a),Hn.a&&(Ol["views.elements.RoomAliasField"]=Hn.a),qn.a&&(Ol["views.elements.RoomName"]=qn.a),$n.a&&(Ol["views.elements.RoomTopic"]=$n.a),zn.a&&(Ol["views.elements.SSOButtons"]=zn.a),Jn.a&&(Ol["views.elements.ServerPicker"]=Jn.a),Yn.a&&(Ol["views.elements.SettingsFlag"]=Yn.a),Qn.a&&(Ol["views.elements.Slider"]=Qn.a),Xn.a&&(Ol["views.elements.SpellCheckLanguagesDropdown"]=Xn.a),bn.a&&(Ol["views.elements.Spinner"]=bn.a),Zn.a&&(Ol["views.elements.Spoiler"]=Zn.a),ei.b&&(Ol["views.elements.StyledCheckbox"]=ei.b),ti.a&&(Ol["views.elements.StyledRadioButton"]=ti.a),si.a&&(Ol["views.elements.StyledRadioGroup"]=si.a),ni.a&&(Ol["views.elements.SvgSpinner"]=ni.a),ii.a&&(Ol["views.elements.SyntaxHighlight"]=ii.a),ai.a&&(Ol["views.elements.TagComposer"]=ai.a),oi.a&&(Ol["views.elements.TextWithTooltip"]=oi.a),ri.a&&(Ol["views.elements.ToggleSwitch"]=ri.a),ci.b&&(Ol["views.elements.Tooltip"]=ci.b),li.a&&(Ol["views.elements.TooltipButton"]=li.a),di.a&&(Ol["views.elements.TruncatedList"]=di.a),hi.a&&(Ol["views.elements.UserTagTile"]=hi.a),ui.a&&(Ol["views.elements.Validation"]=ui.a),mi.a&&(Ol["views.elements.crypto.VerificationQRCode"]=mi.a),pi.a&&(Ol["views.emojipicker.Category"]=pi.a),gi.a&&(Ol["views.emojipicker.Emoji"]=gi.a),vi.d&&(Ol["views.emojipicker.EmojiPicker"]=vi.d),fi.a&&(Ol["views.emojipicker.Header"]=fi.a),bi.a&&(Ol["views.emojipicker.Preview"]=bi.a),yi.a&&(Ol["views.emojipicker.QuickReactions"]=yi.a),Ei.a&&(Ol["views.emojipicker.ReactionPicker"]=Ei.a),Si.a&&(Ol["views.emojipicker.Search"]=Si.a),_i.a&&(Ol["views.host_signup.HostSignupContainer"]=_i.a),Ri&&(Ol["views.messages.CallEvent"]=Ri),Ii.a&&(Ol["views.messages.DateSeparator"]=Ii.a),xi.a&&(Ol["views.messages.DownloadActionButton"]=xi.a),Ti.a&&(Ol["views.messages.EditHistoryMessage"]=Ti.a),Ai&&(Ol["views.messages.EncryptionEvent"]=Ai),ji.a&&(Ol["views.messages.EventTileBubble"]=ji.a),Ui.a&&(Ol["views.messages.MAudioBody"]=Ui.a),Li.a&&(Ol["views.messages.MFileBody"]=Li.a),Fi.a&&(Ol["views.messages.MImageBody"]=Fi.a),Bi.a&&(Ol["views.messages.MImageReplyBody"]=Bi.a),Wi&&(Ol["views.messages.MJitsiWidgetEvent"]=Wi),Hi.a&&(Ol["views.messages.MKeyVerificationConclusion"]=Hi.a),zi&&(Ol["views.messages.MKeyVerificationRequest"]=zi),Zi&&(Ol["views.messages.MPollBody"]=Zi),ia&&(Ol["views.messages.MStickerBody"]=ia),ha&&(Ol["views.messages.MVideoBody"]=ha),ma.a&&(Ol["views.messages.MVoiceMessageBody"]=ma.a),ga&&(Ol["views.messages.MVoiceOrAudioBody"]=ga),fa.a&&(Ol["views.messages.MessageActionBar"]=fa.a),ba.a&&(Ol["views.messages.MessageEvent"]=ba.a),ya.a&&(Ol["views.messages.MessageTimestamp"]=ya.a),Ea&&(Ol["views.messages.MjolnirBody"]=Ea),_a.a&&(Ol["views.messages.ReactionsRow"]=_a.a),wa.a&&(Ol["views.messages.ReactionsRowButton"]=wa.a),Ca.a&&(Ol["views.messages.ReactionsRowButtonTooltip"]=Ca.a),Oa.a&&(Ol["views.messages.RedactedBody"]=Oa.a),ka&&(Ol["views.messages.RoomAvatarEvent"]=ka),xa&&(Ol["views.messages.RoomCreate"]=xa),Pa.a&&(Ol["views.messages.SenderProfile"]=Pa.a),Da.a&&(Ol["views.messages.TextualBody"]=Da.a),Ua&&(Ol["views.messages.TextualEvent"]=Ua),Fa.a&&(Ol["views.messages.TileErrorBoundary"]=Fa.a),Ba.a&&(Ol["views.messages.UnknownBody"]=Ba.a),Va&&(Ol["views.messages.ViewSourceEvent"]=Va),Ha.b&&(Ol["views.right_panel.BaseCard"]=Ha.b),qa.b&&(Ol["views.right_panel.EncryptionInfo"]=qa.b),$a.a&&(Ol["views.right_panel.EncryptionPanel"]=$a.a),za.a&&(Ol["views.right_panel.GroupHeaderButtons"]=za.a),Ja.a&&(Ol["views.right_panel.HeaderButton"]=Ja.a),Ya.b&&(Ol["views.right_panel.HeaderButtons"]=Ya.b),Qa.b&&(Ol["views.right_panel.PinnedMessagesCard"]=Qa.b),Xa.a&&(Ol["views.right_panel.RoomHeaderButtons"]=Xa.a),Za.a&&(Ol["views.right_panel.RoomSummaryCard"]=Za.a),eo.a&&(Ol["views.right_panel.TimelineCard"]=eo.a),to.a&&(Ol["views.right_panel.UserInfo"]=to.a),so.a&&(Ol["views.right_panel.VerificationPanel"]=so.a),no.a&&(Ol["views.right_panel.WidgetCard"]=no.a),io.a&&(Ol["views.room_settings.AliasSettings"]=io.a),ao.a&&(Ol["views.room_settings.RoomProfileSettings"]=ao.a),oo.a&&(Ol["views.room_settings.RoomPublishSetting"]=oo.a),ro.a&&(Ol["views.room_settings.UrlPreviewSettings"]=ro.a),co.a&&(Ol["views.rooms.AppsDrawer"]=co.a),lo.a&&(Ol["views.rooms.Autocomplete"]=lo.a),ho.a&&(Ol["views.rooms.AuxPanel"]=ho.a),uo.b&&(Ol["views.rooms.BasicMessageComposer"]=uo.b),mo.b&&(Ol["views.rooms.E2EIcon"]=mo.b),po.a&&(Ol["views.rooms.EditMessageComposer"]=po.a),go.b&&(Ol["views.rooms.EntityTile"]=go.b),vo.b&&(Ol["views.rooms.EventTile"]=vo.b),fo.a&&(Ol["views.rooms.ExtraTile"]=fo.a),bo.a&&(Ol["views.rooms.JumpToBottomButton"]=bo.a),yo.a&&(Ol["views.rooms.LinkPreviewGroup"]=yo.a),Eo.a&&(Ol["views.rooms.LinkPreviewWidget"]=Eo.a),So.a&&(Ol["views.rooms.MemberList"]=So.a),_o.a&&(Ol["views.rooms.MemberTile"]=_o.a),wo.a&&(Ol["views.rooms.MessageComposer"]=wo.a),Co.b&&(Ol["views.rooms.MessageComposerFormatBar"]=Co.b),Oo.a&&(Ol["views.rooms.NewRoomIntro"]=Oo.a),ko.a&&(Ol["views.rooms.NotificationBadge"]=ko.a),Ro.a&&(Ol["views.rooms.PinnedEventTile"]=Ro.a),Io.a&&(Ol["views.rooms.PresenceLabel"]=Io.a),xo.a&&(Ol["views.rooms.ReadReceiptMarker"]=xo.a),To.a&&(Ol["views.rooms.ReplyPreview"]=To.a),jo.a&&(Ol["views.rooms.ReplyTile"]=jo.a),No.a&&(Ol["views.rooms.RoomBreadcrumbs"]=No.a),Ko&&(Ol["views.rooms.RoomDetailList"]=Ko),Go.a&&(Ol["views.rooms.RoomHeader"]=Go.a),Ho.b&&(Ol["views.rooms.RoomList"]=Ho.b),qo.a&&(Ol["views.rooms.RoomListNumResults"]=qo.a),$o.a&&(Ol["views.rooms.RoomPreviewBar"]=$o.a),zo.b&&(Ol["views.rooms.RoomSublist"]=zo.b),Jo.b&&(Ol["views.rooms.RoomTile"]=Jo.b),Yo.a&&(Ol["views.rooms.RoomUpgradeWarningBar"]=Yo.a),Qo.b&&(Ol["views.rooms.SearchBar"]=Qo.b),Xo.a&&(Ol["views.rooms.SearchResultTile"]=Xo.a),Zo.a&&(Ol["views.rooms.SendMessageComposer"]=Zo.a),er&&(Ol["views.rooms.SimpleRoomHeader"]=er),ar.a&&(Ol["views.rooms.Stickerpicker"]=ar.a),or.a&&(Ol["views.rooms.ThirdPartyMemberInfo"]=or.a),rr.a&&(Ol["views.rooms.TopUnreadMessagesBar"]=rr.a),cr.a&&(Ol["views.rooms.VoiceRecordComposerTile"]=cr.a),lr.a&&(Ol["views.rooms.WhoIsTypingTile"]=lr.a),dr.a&&(Ol["views.settings.AvatarSetting"]=dr.a),hr.a&&(Ol["views.settings.BridgeTile"]=hr.a),ur&&(Ol["views.settings.ChangeAvatar"]=ur),pr&&(Ol["views.settings.ChangeDisplayName"]=pr),br.a&&(Ol["views.settings.ChangePassword"]=br.a),yr.a&&(Ol["views.settings.CrossSigningPanel"]=yr.a),Er.a&&(Ol["views.settings.CryptographyPanel"]=Er.a),Sr.a&&(Ol["views.settings.DevicesPanel"]=Sr.a),_r.a&&(Ol["views.settings.DevicesPanelEntry"]=_r.a),wr.a&&(Ol["views.settings.E2eAdvancedPanel"]=wr.a),Cr.a&&(Ol["views.settings.EventIndexPanel"]=Cr.a),Or.a&&(Ol["views.settings.FontScalingPanel"]=Or.a),kr.a&&(Ol["views.settings.ImageSizePanel"]=kr.a),Rr.a&&(Ol["views.settings.IntegrationManager"]=Rr.a),Ir.a&&(Ol["views.settings.JoinRuleSettings"]=Ir.a),xr.a&&(Ol["views.settings.LayoutSwitcher"]=xr.a),Tr.a&&(Ol["views.settings.Notifications"]=Tr.a),jr.a&&(Ol["views.settings.ProfileSettings"]=jr.a),Nr.a&&(Ol["views.settings.SecureBackupPanel"]=Nr.a),Pr.a&&(Ol["views.settings.SetIdServer"]=Pr.a),Dr.a&&(Ol["views.settings.SetIntegrationManager"]=Dr.a),Mr.a&&(Ol["views.settings.SpellCheckSettings"]=Mr.a),Ar.a&&(Ol["views.settings.ThemeChoicePanel"]=Ar.a),Ur.a&&(Ol["views.settings.UpdateCheckButton"]=Ur.a),Lr.a&&(Ol["views.settings.account.EmailAddresses"]=Lr.a),Fr.a&&(Ol["views.settings.account.PhoneNumbers"]=Fr.a),Br.a&&(Ol["views.settings.discovery.EmailAddresses"]=Br.a),Vr.a&&(Ol["views.settings.discovery.PhoneNumbers"]=Vr.a),Kr.a&&(Ol["views.settings.tabs.room.AdvancedRoomSettingsTab"]=Kr.a),Wr.a&&(Ol["views.settings.tabs.room.BridgeSettingsTab"]=Wr.a),Gr.a&&(Ol["views.settings.tabs.room.GeneralRoomSettingsTab"]=Gr.a),Hr.a&&(Ol["views.settings.tabs.room.NotificationSettingsTab"]=Hr.a),qr.a&&(Ol["views.settings.tabs.room.RolesRoomSettingsTab"]=qr.a),$r.a&&(Ol["views.settings.tabs.room.SecurityRoomSettingsTab"]=$r.a),zr.a&&(Ol["views.settings.tabs.user.AppearanceUserSettingsTab"]=zr.a),Jr.a&&(Ol["views.settings.tabs.user.GeneralUserSettingsTab"]=Jr.a),Yr.a&&(Ol["views.settings.tabs.user.HelpUserSettingsTab"]=Yr.a),Qr.a&&(Ol["views.settings.tabs.user.LabsUserSettingsTab"]=Qr.a),Xr.a&&(Ol["views.settings.tabs.user.MjolnirUserSettingsTab"]=Xr.a),Zr.a&&(Ol["views.settings.tabs.user.NotificationUserSettingsTab"]=Zr.a),ec.a&&(Ol["views.settings.tabs.user.PreferencesUserSettingsTab"]=ec.a),tc.a&&(Ol["views.settings.tabs.user.SecurityUserSettingsTab"]=tc.a),sc.a&&(Ol["views.settings.tabs.user.SidebarUserSettingsTab"]=sc.a),nc.a&&(Ol["views.settings.tabs.user.VoiceUserSettingsTab"]=nc.a),ic.a&&(Ol["views.spaces.QuickSettingsButton"]=ic.a),ac.b&&(Ol["views.spaces.SpaceBasicSettings"]=ac.b),oc.a&&(Ol["views.spaces.SpaceChildrenPicker"]=oc.a),rc.d&&(Ol["views.spaces.SpaceCreateMenu"]=rc.d),cc.a&&(Ol["views.spaces.SpacePanel"]=cc.a),lc.a&&(Ol["views.spaces.SpacePublicShare"]=lc.a),dc.a&&(Ol["views.spaces.SpaceSettingsGeneralTab"]=dc.a),hc.a&&(Ol["views.spaces.SpaceSettingsVisibilityTab"]=hc.a),uc.c&&(Ol["views.spaces.SpaceTreeLevel"]=uc.c),mc.a&&(Ol["views.terms.InlineTermsAgreement"]=mc.a),pc.a&&(Ol["views.toasts.GenericExpiringToast"]=pc.a),gc.a&&(Ol["views.toasts.GenericToast"]=gc.a),vc.a&&(Ol["views.toasts.NonUrgentEchoFailureToast"]=vc.a),fc.a&&(Ol["views.toasts.VerificationRequestToast"]=fc.a),bc.a&&(Ol["views.verification.VerificationCancelled"]=bc.a),yc.a&&(Ol["views.verification.VerificationComplete"]=yc.a),Ec.a&&(Ol["views.verification.VerificationShowSas"]=Ec.a),Sc.a&&(Ol["views.voip.AudioFeed"]=Sc.a),_c.a&&(Ol["views.voip.AudioFeedArrayForCall"]=_c.a),wc.a&&(Ol["views.voip.CallContainer"]=wc.a),Cc.a&&(Ol["views.voip.CallPreview"]=Cc.a),Oc.a&&(Ol["views.voip.CallView"]=Oc.a),kc.a&&(Ol["views.voip.CallView.CallViewButtons"]=kc.a),Rc.a&&(Ol["views.voip.CallView.CallViewHeader"]=Rc.a),Ic.a&&(Ol["views.voip.CallViewForRoom"]=Ic.a),xc.a&&(Ol["views.voip.CallViewSidebar"]=xc.a),Tc.a&&(Ol["views.voip.DialPad"]=Tc.a),jc.a&&(Ol["views.voip.DialPadModal"]=jc.a),Nc.a&&(Ol["views.voip.PictureInPictureDragger"]=Nc.a),Pc.a&&(Ol["views.voip.VideoFeed"]=Pc.a),Dc.a&&(Ol["structures.CustomRoomTagPanel"]=Dc.a),Mc.a&&(Ol["structures.GroupView"]=Mc.a),Ac.a&&(Ol["structures.MyGroups"]=Ac.a),Lc&&(Ol["views.context_menus.GroupInviteTileContextMenu"]=Lc),Hc&&(Ol["views.context_menus.TagTileContextMenu"]=Hc),Jc.a&&(Ol["views.elements.DNDTagTile"]=Jc.a),Yc.a&&(Ol["views.elements.Flair"]=Yc.a),Qc.a&&(Ol["views.elements.Pill"]=Qc.a),Xc.a&&(Ol["views.elements.TagTile"]=Xc.a),el&&(Ol["views.groups.GroupInviteTile"]=el),il.a&&(Ol["views.groups.GroupMemberList"]=il.a),ol&&(Ol["views.groups.GroupMemberTile"]=ol),dl&&(Ol["views.groups.GroupPublicityToggle"]=dl),pl.a&&(Ol["views.groups.GroupRoomInfo"]=pl.a),gl.a&&(Ol["views.groups.GroupRoomList"]=gl.a),yl&&(Ol["views.groups.GroupRoomTile"]=yl),Sl&&(Ol["views.groups.GroupTile"]=Sl),_l.a&&(Ol["views.groups.GroupUserSettings"]=_l.a),wl.a&&(Ol["views.room_settings.RelatedGroupSettings"]=wl.a),Bo&&(Ol["views.rooms.RoomDetailRow"]=Bo),Cl.a&&(Ol["views.settings.tabs.user.FlairUserSettingsTab"]=Cl.a)},function(e,t,s){"use strict";s.d(t,"b",(function(){return I})),s.d(t,"a",(function(){return T}));var n=s(83),i=s.n(n),a=s(4),o=s(5),r=s(130),c=s(116),l=s(147),d=s(298),h=s(191),u=s(257);var m=s(460),p=s(143);const g={[u.b.Recent]:new m.a,[u.b.Alphabetic]:new class{sortRooms(e,t){return e.sort((e,t)=>Object(p.a)(e.name,t.name))}},[u.b.Manual]:new class{sortRooms(e,t){const s=e=>e.tags[t].order||0;return e.sort((e,t)=>s(e)-s(t))}}};function v(e,t,s){return function(e){if(!g[e])throw new Error(e+" is not a known algorithm");return g[e]}(s).sortRooms(e,t)}var f=s(1);class b{constructor(e,t){this.tagId=e,i()(this,"cachedOrderedRooms",void 0),i()(this,"sortingAlgorithm",void 0),this.setSortAlgorithm(t)}get orderedRooms(){return this.cachedOrderedRooms||[]}setSortAlgorithm(e){if(!e)throw new Error("A sorting algorithm must be defined");this.sortingAlgorithm=e,this.setRooms(this.orderedRooms)}getRoomIndex(e){let t=this.cachedOrderedRooms.indexOf(e);return-1===t&&(f.a.warn(`Degrading performance to find missing room in "${this.tagId}": ${e.roomId}`),t=this.cachedOrderedRooms.findIndex(t=>t.roomId===e.roomId)),t}}var y=s(184),E=s(173);const S=[y.a.Unsent,y.a.Red,y.a.Grey,y.a.Bold,y.a.None];class _ extends b{constructor(e,t){super(e,t),i()(this,"indices",{})}categorizeRooms(e){const t={[y.a.Unsent]:[],[y.a.Red]:[],[y.a.Grey]:[],[y.a.Bold]:[],[y.a.None]:[]};for(const s of e){t[this.getRoomCategory(s)].push(s)}return t}getRoomCategory(e){return E.a.instance.getRoomState(e).color}setRooms(e){if(this.sortingAlgorithm===u.b.Manual)this.cachedOrderedRooms=v(e,this.tagId,this.sortingAlgorithm);else{const t=this.categorizeRooms(e);for(const e of Object.keys(t)){const s=t[e];t[e]=v(s,this.tagId,this.sortingAlgorithm)}const s=[],n={};for(const e of S)n[e]=s.length,s.push(...t[e]);this.indices=n,this.cachedOrderedRooms=s}}handleSplice(e,t){if(t===l.c.NewRoom){const t=this.getRoomCategory(e);this.alterCategoryPositionBy(t,1,this.indices),this.cachedOrderedRooms.splice(this.indices[t],0,e),this.sortCategory(t)}else{if(t!==l.c.RoomRemoved)throw new Error("Unhandled splice: "+t);{const t=this.getRoomIndex(e);if(-1===t)return f.a.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`),!1;const s=this.getCategoryFromIndices(t,this.indices);this.alterCategoryPositionBy(s,-1,this.indices),this.cachedOrderedRooms.splice(t,1)}}return!0}handleRoomUpdate(e,t){if(t===l.c.NewRoom||t===l.c.RoomRemoved)return this.handleSplice(e,t);if(t!==l.c.Timeline&&t!==l.c.ReadReceipt)throw new Error("Unsupported update cause: "+t);const s=this.getRoomCategory(e);if(this.sortingAlgorithm===u.b.Manual)return;const n=this.getRoomIndex(e);if(-1===n)throw new Error(`Room ${e.roomId} has no index in ${this.tagId}`);const i=this.getCategoryFromIndices(n,this.indices);return i!==s&&(this.moveRoomIndexes(1,i,s,this.indices),this.cachedOrderedRooms.splice(n,1),this.cachedOrderedRooms.splice(this.indices[s],0,e)),this.sortCategory(s),!0}sortCategory(e){const t=e===S[S.length-1]?Number.MAX_SAFE_INTEGER:this.indices[S[S.indexOf(e)+1]],s=this.indices[e],n=t-s,i=v(this.cachedOrderedRooms.splice(s,n),this.tagId,this.sortingAlgorithm);this.cachedOrderedRooms.splice(s,0,...i)}getCategoryFromIndices(e,t){for(let s=0;s<S.length;s++){const n=S[s],i=s===S.length-1,a=t[n],o=i?Number.MAX_SAFE_INTEGER:t[S[s+1]];if(e>=a&&e<o)return n}throw new Error("Programming error: somehow you've ended up with an index that isn't in a category")}moveRoomIndexes(e,t,s,n){this.alterCategoryPositionBy(t,-e,n),this.alterCategoryPositionBy(s,+e,n)}alterCategoryPositionBy(e,t,s){const n=S.indexOf(e)+1;if(t>0)for(let e=n;e<S.length;e++){s[S[e]]+=Math.abs(t)}else if(t<0)for(let e=n;e<S.length;e++){s[S[e]]-=Math.abs(t)}for(let e=1;e<=S.length;e++){const t=S[e-1],n=S[e];s[t]>s[n]&&f.a.warn(`!! Room list index corruption: ${t} (i:${s[t]}) is greater than ${n} (i:${s[n]}) - category indices are likely desynced from reality`)}}}class w extends b{constructor(e,t){super(e,t)}setRooms(e){this.cachedOrderedRooms=v(e,this.tagId,this.sortingAlgorithm)}handleRoomUpdate(e,t){const s=t===l.c.NewRoom||t===l.c.RoomRemoved,n=t===l.c.Timeline||t===l.c.ReadReceipt;if(!s&&!n)throw new Error("Unsupported update cause: "+t);if(t===l.c.NewRoom)this.cachedOrderedRooms.push(e);else if(t===l.c.RoomRemoved){const t=this.getRoomIndex(e);t>=0?this.cachedOrderedRooms.splice(t,1):f.a.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`)}return this.cachedOrderedRooms=v(this.cachedOrderedRooms,this.tagId,this.sortingAlgorithm),!0}}const C={[u.a.Natural]:(e,t)=>new w(e,t),[u.a.Importance]:(e,t)=>new _(e,t)};function O(e,t,s){if(!C[e])throw new Error(e+" is not a known algorithm");return C[e](t,s)}var k=s(599),R=s(106);const I="list_updated_event",x=[l.c.Timeline,l.c.ReadReceipt];class T extends o.EventEmitter{constructor(){super(),i()(this,"_cachedRooms",{}),i()(this,"_cachedStickyRooms",{}),i()(this,"filteredRooms",{}),i()(this,"_stickyRoom",null),i()(this,"_lastStickyRoom",null),i()(this,"sortAlgorithms",void 0),i()(this,"listAlgorithms",void 0),i()(this,"algorithms",void 0),i()(this,"rooms",[]),i()(this,"roomIdsToTags",{}),i()(this,"allowedByFilter",new Map),i()(this,"allowedRoomsByFilters",new Set),i()(this,"updatesInhibited",!1),i()(this,"unifiedRoomList",void 0)}get stickyRoom(){return this._stickyRoom?this._stickyRoom.room:null}get knownRooms(){return this.rooms}get hasTagSortingMap(){return!!this.sortAlgorithms}get hasFilters(){return this.allowedByFilter.size>0}set cachedRooms(e){this._cachedRooms=e,this.recalculateFilteredRooms(),this.recalculateStickyRoom()}get cachedRooms(){return this._cachedRooms}setStickyRoom(e){try{this.updateStickyRoom(e)}catch(e){f.a.warn("Failed to update sticky room",e)}}getTagSorting(e){return this.sortAlgorithms?this.sortAlgorithms[e]:null}setTagSorting(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.sortAlgorithms[e]=t;const s=this.algorithms[e];s.setSortAlgorithm(t),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}getListOrdering(e){return this.listAlgorithms?this.listAlgorithms[e]:null}setListOrdering(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.listAlgorithms[e]=t;const s=O(t,e,this.sortAlgorithms[e]);this.algorithms[e]=s,s.setRooms(this._cachedRooms[e]),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}setUnifiedRoomList(e){this.unifiedRoomList=e}addFilterCondition(e){this.allowedByFilter.set(e,this.rooms.filter(t=>e.isVisible(t))),this.recalculateFilteredRooms(),e.on(d.a,this.handleFilterChange.bind(this))}removeFilterCondition(e){e.off(d.a,this.handleFilterChange.bind(this)),this.allowedByFilter.has(e)&&(this.allowedByFilter.delete(e),this.recalculateFilteredRooms(),this.hasFilters||this.updatesInhibited||this.emit(I))}handleFilterChange(){this.recalculateFilteredRooms(),this.updatesInhibited||this.emit(d.a)}updateStickyRoom(e){this.doUpdateStickyRoom(e),this._lastStickyRoom=null}doUpdateStickyRoom(e){var t,s;if(R.a.spacesEnabled&&null!==(t=e)&&void 0!==t&&t.isSpaceRoom()&&"invite"!==e.getMyMembership()&&(e=null),e&&!k.a.instance.isRoomVisible(e)&&(e=null),this._lastStickyRoom=this._stickyRoom||{},!e){if(this._stickyRoom){const e=this._stickyRoom.room;return this._stickyRoom=null,void this.handleRoomUpdate(e,l.c.NewRoom)}return}let n=null===(s=this.roomIdsToTags[e.roomId])||void 0===s?void 0:s[0];if(!n)throw new Error(e.roomId+" does not belong to a tag and cannot be sticky");let i=(this.getOrderedRoomsWithoutSticky()[n]||[]).indexOf(e);const a=!!this._lastStickyRoom.room&&this._lastStickyRoom.room.roomId===e.roomId;if(this._lastStickyRoom.tag&&n!==this._lastStickyRoom.tag&&a&&i<0&&(f.a.warn(`Sticky room ${e.roomId} changed tags during sticky room handling`),i=0),i<0)throw new Error(e.roomId+" does not appear to be known and cannot be sticky");const o=this._stickyRoom;if(this._stickyRoom=null,this.recalculateStickyRoom(),o&&o.room&&o.room.roomId!==e.roomId&&this.handleRoomUpdate(o.room,l.c.NewRoom),this.handleRoomUpdate(e,l.c.RoomRemoved),this._stickyRoom){if(this._stickyRoom.room!==e){if(this._stickyRoom.room.roomId!==e.roomId)throw new Error("Sticky room changed while the sticky room was changing");f.a.warn("Sticky room changed references")}f.a.warn(`Sticky room changed tag & position from ${n} / ${i} to ${this._stickyRoom.tag} / ${this._stickyRoom.position}`),n=this._stickyRoom.tag,i=this._stickyRoom.position}o&&o.tag===n&&o.position<=i&&i++,this._stickyRoom={room:e,position:i,tag:n},this.recalculateFilteredRoomsForTag(n),o&&o.tag!==n&&this.recalculateFilteredRoomsForTag(o.tag),this.recalculateStickyRoom(),this.updatesInhibited||this.emit(I)}recalculateFilteredRooms(){if(!this.hasFilters)return;f.a.warn("Recalculating filtered room list");const e=Array.from(this.allowedByFilter.keys()),t={};for(const s of Object.keys(this.cachedRooms)){const n=this.cachedRooms[s].map(e=>e);this.tryInsertStickyRoomToFilterSet(n,s);const i=n.map(e=>e),a=[];for(const t of e){const e=i.filter(e=>t.isVisible(e));for(const t of e){const e=i.indexOf(t);e>=0&&i.splice(e,1),a.push(t)}}t[s]=a}const s=Object.values(t).reduce((e,t)=>(e.push(...t),e),[]);this.allowedRoomsByFilters=new Set(s),this.filteredRooms=t,this.updatesInhibited||this.emit(I)}recalculateFilteredRoomsForTag(e){if(!this.hasFilters)return;delete this.filteredRooms[e];const t=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(t,e);const s=t.filter(e=>this.allowedRoomsByFilters.has(e));s.length>0&&(this.filteredRooms[e]=s)}tryInsertStickyRoomToFilterSet(e,t){if(!this._stickyRoom||!this._stickyRoom.room||this._stickyRoom.tag!==t)return;const s=this._stickyRoom.position;s>=e.length?e.push(this._stickyRoom.room):e.splice(s,0,this._stickyRoom.room)}recalculateStickyRoom(e=null){if(!this._stickyRoom){if(this._cachedStickyRooms){if(this._cachedStickyRooms=null,this.updatesInhibited)return;this.emit(I)}return}if(!this._cachedStickyRooms||!e){const e={};for(const t of Object.keys(this.cachedRooms))e[t]=this.cachedRooms[t].map(e=>e);this._cachedStickyRooms=e}e&&(this._cachedStickyRooms[e]=this.cachedRooms[e].map(e=>e));const t=this._stickyRoom;e&&e!==t.tag||this._cachedStickyRooms[t.tag].splice(t.position,0,t.room),this.updatesInhibited||this.emit(I)}populateTags(e,t){if(!e)throw new Error("Sorting map cannot be null or empty");if(!t)throw new Error("Ordering ma cannot be null or empty");if(Object(c.d)(Object.keys(e),Object.keys(t)))throw new Error("Both maps must contain the exact same tags");this.sortAlgorithms=e,this.listAlgorithms=t,this.algorithms={};for(const t of Object.keys(e))this.algorithms[t]=O(this.listAlgorithms[t],t,this.sortAlgorithms[t]);return this.setKnownRooms(this.rooms)}getOrderedRooms(){return this.hasFilters?this.filteredRooms:this._cachedStickyRooms||this.cachedRooms}getUnfilteredRooms(){return this._cachedStickyRooms||this.cachedRooms}getOrderedRoomsWithoutSticky(){return this.hasFilters?this.filteredRooms:this.cachedRooms}setKnownRooms(e){if(Object(a.v)(e))throw new Error("Array of rooms cannot be null");if(!this.sortAlgorithms)throw new Error("Cannot set known rooms without a tag sorting map");this.updatesInhibited||f.a.warn("Resetting known rooms, initiating regeneration");const t=this._stickyRoom;t&&this.updateStickyRoom(null),this.rooms=e;const s={};for(const e in this.sortAlgorithms)s[e]=[];if(!e.length)return this.generateFreshTags(s),void(this.cachedRooms=s);const n=Object(h.e)(e);for(const e of n[h.a.Invite])s[l.a.Invite].push(e);for(const e of n[h.a.Leave])s[l.a.Archived].push(e);for(const e of n[h.a.Join]){const t=this.getTagsOfJoinedRoom(e);let n=!1;if(t.length>0)for(const i of t)Object(a.v)(s[i])||(s[i].push(e),n=!0);n||(r.a.shared().getUserIdForRoomId(e.roomId)?this.unifiedRoomList?s[l.a.Unified].push(e):s[l.a.DM].push(e):this.unifiedRoomList?s[l.a.Unified].push(e):s[l.a.Untagged].push(e))}this.generateFreshTags(s),this.cachedRooms=s,this.updateTagsFromCache(),t&&t.room&&(this.updateStickyRoom(t.room),this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.tag!==t.tag&&(this._stickyRoom.position=0,this.recalculateStickyRoom(this._stickyRoom.tag)))}getTagsForRoom(e){const t=[],s=Object(h.b)(e.getMyMembership());return s===h.a.Invite?t.push(l.a.Invite):s===h.a.Leave?t.push(l.a.Archived):t.push(...this.getTagsOfJoinedRoom(e)),t.length||(this.unifiedRoomList?t.push(l.a.Unified):t.push(l.a.Untagged)),t}getTagsOfJoinedRoom(e){let t=Object.keys(e.tags||{});return 0===t.length&&r.a.shared().getUserIdForRoomId(e.roomId)&&(t=this.unifiedRoomList?[l.a.Unified]:[l.a.DM]),t}updateTagsFromCache(){const e={},t=Object.keys(this.cachedRooms);for(const s of t){const t=this.cachedRooms[s];for(const n of t)e[n.roomId]||(e[n.roomId]=[]),e[n.roomId].push(s)}this.roomIdsToTags=e}generateFreshTags(e){if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");for(const t of Object.keys(e)){const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);s.setRooms(e[t]),e[t]=s.orderedRooms}}handleRoomUpdate(e,t){var s,n;if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");const i=(null===(s=this._stickyRoom)||void 0===s||null===(n=s.room)||void 0===n?void 0:n.roomId)===e.roomId;if(t===l.c.NewRoom){var o;const s=(null===(o=this._lastStickyRoom)||void 0===o?void 0:o.room)===e,n=this.roomIdsToTags[e.roomId],a=n&&n.length>0;a&&!s&&(f.a.warn(e.roomId+" is reportedly new but is already known - assuming TagChange instead"),t=l.c.PossibleTagChange);let r=this.rooms.includes(e);if(a&&!r&&(f.a.warn(e.roomId+" might be a reference change - attempting to update reference"),this.rooms=this.rooms.map(t=>t.roomId===e.roomId?e:t),r=this.rooms.includes(e),r||f.a.warn(e.roomId+" is still not referenced. It may be sticky.")),a&&!r&&!i)throw new Error(e.roomId+" is missing from room array but is known - trying to find duplicate");a&&i&&(this._stickyRoom.room=e),t!==l.c.NewRoom||i||r||this.rooms.push(e)}let r=!1;if(t===l.c.PossibleTagChange){const s=this.roomIdsToTags[e.roomId]||[],n=this.getTagsForRoom(e),a=Object(c.a)(s,n);if(!(a.removed.length>0||a.added.length>0))return!1;for(const t of a.removed){const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);s.handleRoomUpdate(e,l.c.RoomRemoved),this._cachedRooms[t]=s.orderedRooms,this.recalculateFilteredRoomsForTag(t),this.recalculateStickyRoom(t)}for(const t of a.added){const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);s.handleRoomUpdate(e,l.c.NewRoom),this._cachedRooms[t]=s.orderedRooms}this.roomIdsToTags[e.roomId]=n,t=l.c.Timeline,r=!0,r&&i&&(this._lastStickyRoom?this._stickyRoom={room:e,tag:this.roomIdsToTags[e.roomId][0],position:0}:this.setStickyRoom(e))}if(t!==l.c.NewRoom&&t!==l.c.RoomRemoved&&this.stickyRoom===e)return!1;if(!this.roomIdsToTags[e.roomId]){if(x.includes(t))return!1;const s=this.getTagsForRoom(e).filter(e=>!Object(a.v)(this.cachedRooms[e]));if(!s.length)throw new Error("Tags cannot be determined for "+e.roomId);this.roomIdsToTags[e.roomId]=s}const d=this.roomIdsToTags[e.roomId];if(!d)return f.a.warn(`No tags known for "${e.name}" (${e.roomId})`),!1;let h=r;for(const s of d){const n=this.algorithms[s];if(!n)throw new Error("No algorithm for "+s);n.handleRoomUpdate(e,t),this._cachedRooms[s]=n.orderedRooms,this.recalculateFilteredRoomsForTag(s),this.recalculateStickyRoom(s),h=!0}return h}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n=s(83),i=s.n(n),a=s(86),o=s(87),r=s(84),c=s(179),l=s(146),d=s(92),h=s(158);var u=s(90),m=s(392),p=s(188),g=s(230),v=s(96);const f=e=>{switch(e){case S.SET_UP_ENCRYPTION:return Object(r.a)("Set up Secure Backup");case S.UPGRADE_ENCRYPTION:return Object(r.a)("Encryption upgrade available");case S.VERIFY_THIS_SESSION:return Object(r.a)("Verify this session")}},b=e=>{switch(e){case S.SET_UP_ENCRYPTION:case S.UPGRADE_ENCRYPTION:return"secure_backup";case S.VERIFY_THIS_SESSION:return"verification_warning"}},y=e=>{switch(e){case S.SET_UP_ENCRYPTION:return Object(r.a)("Continue");case S.UPGRADE_ENCRYPTION:return Object(r.a)("Upgrade");case S.VERIFY_THIS_SESSION:return Object(r.a)("Verify")}},E=e=>{switch(e){case S.SET_UP_ENCRYPTION:case S.UPGRADE_ENCRYPTION:return Object(r.a)("Safeguard against losing access to encrypted messages & data");case S.VERIFY_THIS_SESSION:return Object(r.a)("Other users may not trust it")}};let S;!function(e){e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session"}(S||(S={}));const _=()=>{j.sharedInstance().dismissEncryptionSetup()},w=e=>{var t;if(null!==(t=g.a.setupEncryptionNeeded)&&void 0!==t&&t.call(g.a,e))return;l.a.sharedInstance().addOrReplaceToast({key:"setupencryption",title:f(e),icon:b(e),props:{description:E(e),acceptLabel:y(e),onAccept:async()=>{if(e===S.VERIFY_THIS_SESSION)u.a.createTrackedDialog("Verify session","Verify session",m.a,{},null,!1,!0);else{const e=u.a.createDialog(v.a,null,"mx_Dialog_spinner",!1,!0);try{await Object(p.b)()}finally{e.close()}}},rejectLabel:Object(r.a)("Later"),onReject:_},component:c.a,priority:e===S.VERIFY_THIS_SESSION?95:40})},C=()=>{l.a.sharedInstance().dismissToast("setupencryption")};function O(e){return"unverified_session_"+e}const k=async e=>{const t=a.a.get(),s=await t.getDevice(e);l.a.sharedInstance().addOrReplaceToast({key:O(e),title:Object(r.a)("New login. Was this you?"),icon:"verification_warning",props:{description:s.display_name,detail:Object(r.a)("%(deviceId)s from %(ip)s",{deviceId:e,ip:s.last_seen_ip}),acceptLabel:Object(r.a)("Check your devices"),onAccept:()=>{j.sharedInstance().dismissUnverifiedSessions([e]),o.a.dispatch({action:d.a.ViewUserSettings,initialTabId:h.a.Security})},rejectLabel:Object(r.a)("Later"),onReject:()=>{j.sharedInstance().dismissUnverifiedSessions([e])}},component:c.a,priority:80})},R=e=>{l.a.sharedInstance().dismissToast(O(e))};var I=s(268),x=s(1026),T=s(1);class j{constructor(){i()(this,"dispatcherRef",void 0),i()(this,"dismissed",new Set),i()(this,"dismissedThisDeviceToast",!1),i()(this,"keyBackupInfo",null),i()(this,"keyBackupFetchedAt",null),i()(this,"ourDeviceIdsAtStart",null),i()(this,"displayingToastsForDeviceIds",new Set),i()(this,"onWillUpdateDevices",async(e,t)=>{if(t)return;const s=a.a.get().getUserId();e.includes(s)&&this.ensureDeviceIdsAtStartPopulated()}),i()(this,"onDevicesUpdated",e=>{e.includes(a.a.get().getUserId())&&this.recheck()}),i()(this,"onDeviceVerificationChanged",e=>{e===a.a.get().getUserId()&&this.recheck()}),i()(this,"onUserTrustStatusChanged",e=>{e===a.a.get().getUserId()&&this.recheck()}),i()(this,"onCrossSingingKeysChanged",()=>{this.recheck()}),i()(this,"onAccountData",e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType())&&this.recheck()}),i()(this,"onSync",(e,t)=>{"PREPARED"===e&&null===t&&this.recheck()}),i()(this,"onRoomStateEvents",e=>{"m.room.encryption"===e.getType()&&this.recheck()}),i()(this,"onAction",({action:e})=>{"on_logged_in"===e&&this.recheck()})}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new j),window.mxDeviceListener}start(){a.a.get().on("crypto.willUpdateDevices",this.onWillUpdateDevices),a.a.get().on("crypto.devicesUpdated",this.onDevicesUpdated),a.a.get().on("deviceVerificationChanged",this.onDeviceVerificationChanged),a.a.get().on("userTrustStatusChanged",this.onUserTrustStatusChanged),a.a.get().on("crossSigning.keysChanged",this.onCrossSingingKeysChanged),a.a.get().on("accountData",this.onAccountData),a.a.get().on("sync",this.onSync),a.a.get().on("RoomState.events",this.onRoomStateEvents),this.dispatcherRef=o.a.register(this.onAction),this.recheck()}stop(){a.a.get()&&(a.a.get().removeListener("crypto.willUpdateDevices",this.onWillUpdateDevices),a.a.get().removeListener("crypto.devicesUpdated",this.onDevicesUpdated),a.a.get().removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),a.a.get().removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged),a.a.get().removeListener("crossSigning.keysChanged",this.onCrossSingingKeysChanged),a.a.get().removeListener("accountData",this.onAccountData),a.a.get().removeListener("sync",this.onSync),a.a.get().removeListener("RoomState.events",this.onRoomStateEvents)),this.dispatcherRef&&(o.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set}async dismissUnverifiedSessions(e){T.a.log("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}ensureDeviceIdsAtStartPopulated(){if(null===this.ourDeviceIdsAtStart){const e=a.a.get();this.ourDeviceIdsAtStart=new Set(e.getStoredDevicesForUser(e.getUserId()).map(e=>e.deviceId))}}async getKeyBackupInfo(){const e=(new Date).getTime();return(!this.keyBackupInfo||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await a.a.get().getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){if(Object(p.d)())return!1;const e=a.a.get();return e&&e.getRooms().some(t=>e.isRoomEncrypted(t.roomId))}async recheck(){const e=a.a.get();if(!await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))return;if(!e.isCryptoEnabled())return;if(!e.isInitialSyncComplete())return;const t=await e.isCrossSigningReady(),s=await e.isSecretStorageReady(),n=t&&s;if(this.dismissedThisDeviceToast||n)C();else if(this.shouldShowSetupEncryptionToast())if(await e.downloadKeys([e.getUserId()]),!e.getCrossSigningId()&&e.getStoredCrossSigningForUser(e.getUserId()))w(S.VERIFY_THIS_SESSION);else{await this.getKeyBackupInfo()?w(S.UPGRADE_ENCRYPTION):(await e.waitForClientWellKnown(),Object(I.e)()&&Object(x.b)()?(C(),Object(p.b)()):w(S.SET_UP_ENCRYPTION))}this.ensureDeviceIdsAtStartPopulated();const i=new Set,u=new Set;if(t){const t=e.getStoredDevicesForUser(e.getUserId());for(const s of t){if(s.deviceId===e.deviceId)continue;(await e.checkDeviceTrust(e.getUserId(),s.deviceId)).isCrossSigningVerified()||this.dismissed.has(s.deviceId)||(this.ourDeviceIdsAtStart.has(s.deviceId)?i.add(s.deviceId):u.add(s.deviceId))}}var m;T.a.log("Old unverified sessions: "+Array.from(i).join(",")),T.a.log("New unverified sessions: "+Array.from(u).join(",")),i.size>0?(m=i,l.a.sharedInstance().addOrReplaceToast({key:"reviewsessions",title:Object(r.a)("You have unverified logins"),icon:"verification_warning",props:{description:Object(r.a)("Review to ensure your account is safe"),acceptLabel:Object(r.a)("Review"),onAccept:()=>{j.sharedInstance().dismissUnverifiedSessions(m),o.a.dispatch({action:d.a.ViewUserSettings,initialTabId:h.a.Security})},rejectLabel:Object(r.a)("Later"),onReject:()=>{j.sharedInstance().dismissUnverifiedSessions(m)}},component:c.a,priority:50})):l.a.sharedInstance().dismissToast("reviewsessions");for(const e of u)k(e);for(const e of this.displayingToastsForDeviceIds)u.has(e)||R(e);this.displayingToastsForDeviceIds=u}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(99),i=s.n(n),a=s(157);class o{constructor(e){i()(this,"timeline",void 0),i()(this,"ourEventIndex",0),i()(this,"paginateTokens",{[a.a.Backward]:null,[a.a.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?a.a.Backward:a.a.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?a.a.Backward:a.a.Forward]=e}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class r{static fromJson(e,t){const s=e.context||{},n=s.events_before||[],i=s.events_after||[],a=new o(t(e.result));return a.setPaginateToken(s.start,!0),a.addEvents(n.map(t),!0),a.addEvents(i.map(t),!1),a.setPaginateToken(s.end,!1),new r(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return b}));var n=s(99),i=s.n(n),a=s(94),o=s(1),r=s(4);function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function l(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class d{constructor(e,t,s){this.client=e,this.indexEvent=t,this.directory=s}get id(){return this.indexEvent.getStateKey()}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,a.i.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,a.i.name,l(l({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,a.i.name,l(l({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=(await this.getFileEvent()).getOriginalContent().file;return{info:e,httpUrl:this.client.mxcUrlToHttp(e.url)}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");const t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t,{emit:!0,isRetry:!0}),t}async createNewVersion(e,t,s,n){const i=await this.directory.createFile(e,t,s,l(l({},null!=n?n:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:a.c.Replace,event_id:this.id}}));await this.client.sendStateEvent(this.roomId,a.i.name,{active:!0,name:e,version:this.version+1},i.event_id),await this.client.sendStateEvent(this.roomId,a.i.name,l(l({},this.indexEvent.getContent()),{},{active:!1}),this.id)}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const s=[...t.getLiveTimeline().getEvents()].reverse();let n,i=await this.getFileEvent();do{if(n=s.find(e=>e.replacingEventId()===i.getId()),n){const t=this.directory.getFile(n.getId());if(!t)break;e.push(t),i=n}}while(n);return e}}var h=s(16),u=s.n(h),m=s(606);function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const v={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[a.a.RoomPowerLevels]:100,[a.a.RoomHistoryVisibility]:100,[a.a.RoomTombstone]:100,[a.a.RoomEncryption]:100,[a.a.RoomName]:50,[a.a.RoomMessage]:50,[a.a.RoomMessageEncrypted]:50,[a.a.Sticker]:50},users:{}};let f;!function(e){e.Viewer="viewer",e.Editor="editor",e.Owner="owner"}(f||(f={}));class b{constructor(e,t){if(this.client=e,this.roomId=t,i()(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(a.a.SpaceParent);return null==e||!e.length||e.every(e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)})}async setName(e){await this.client.sendStateEvent(this.roomId,a.a.RoomName,{name:e},"")}async invite(e,t=!0,s=!0){const n=[this.retryInvite(e)];return t&&n.push(...this.getDirectories().map(n=>n.invite(e,t,s))),Promise.all(n).then(()=>{s&&Object(m.a)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])})}retryInvite(e){return Object(r.H)(async()=>{await this.client.invite(this.roomId,e).catch(e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new u.a.AbortError(e);throw e})})}async setPermissions(e,t){var s;const n=this.room.currentState.getStateEvents(a.a.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");const i=n.getContent()||{},o=i.users_default||0,r=i.events_default||50,c=(null===(s=i.events)||void 0===s?void 0:s[a.a.RoomPowerLevels])||100,l=i.users||{};switch(t){case f.Viewer:l[e]=o;break;case f.Editor:l[e]=r;break;case f.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}i.users=l,await this.client.sendStateEvent(this.roomId,a.a.RoomPowerLevels,i,"")}getPermissions(e){var t,s;const n=this.room.currentState.getStateEvents(a.a.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");const i=n.getContent()||{},o=i.users_default||0,r=i.events_default||50,c=(null===(t=i.events)||void 0===t?void 0:t[a.a.RoomPowerLevels])||100,l=(null===(s=i.users)||void 0===s?void 0:s[e])||o;return l>=c?f.Owner:l>=r?f.Editor:f.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,a.a.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,a.a.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(a.a.SpaceChild);for(const s of t)try{const t=this.client.unstableGetFileTreeSpace(s.getStateKey());t&&e.push(t)}catch(e){o.a.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=["invite","knock","join"],s=this.room.currentState.getStateEvents(a.a.RoomMember);for(const e of s){e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)&&await this.client.kick(this.roomId,e.getStateKey(),"Room deleted")}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map(e=>({roomId:e.getStateKey(),order:e.getContent().order}));return t.sort((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return Object(r.x)(e.order,t.order);{var s,n,i,o;const c=this.client.getRoom(e.roomId),l=this.client.getRoom(t.roomId);if(!c||!l)return Object(r.x)(e.roomId,t.roomId);const d=null!==(s=null===(n=c.currentState.getStateEvents(a.a.RoomCreate,""))||void 0===n?void 0:n.getTs())&&void 0!==s?s:0,h=null!==(i=null===(o=l.currentState.getStateEvents(a.a.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==i?i:0;return d===h?Object(r.x)(e.roomId,t.roomId):d-h}}),t}getParentRoom(){const e=this.room.currentState.getStateEvents(a.a.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=this.client.getRoom(e.getStateKey());if(!t)throw new Error("Unable to locate room for parent");return t}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(a.a.SpaceChild);return this.getOrderedChildren(e).findIndex(e=>e.roomId===this.roomId)}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const s=this.getParentRoom(),n=s.currentState.getStateEvents(a.a.SpaceChild),i=this.getOrderedChildren(n);e=Math.max(Math.min(e,i.length-1),0);const o=this.getOrder()<e;o&&e===i.length-1?e--:o||0!==e||e++;const c=i[o?e:e-1],l=i[o?e+1:e];let d=r.a[0],h=!1;if(c)if(e===i.length-1)null!=l&&l.order&&(d=Object(r.y)(l.order));else{const e=null==c?void 0:c.order,t=null==l?void 0:l.order;e&&t?d=e===t?Object(r.y)(e):Object(r.c)(e,t):e?d=Object(r.y)(e):t?d=Object(r.A)(t):h=!0}else null!=l&&l.order&&(d=Object(r.A)(l.order));if(h){let t;for(let n=0;n<=e;n++){const e=i[n];if(0===n&&(t=e.order),e.order)t=e.order;else{var u;t=t?Object(r.y)(t):r.a[0];const n=s.currentState.getStateEvents(a.a.SpaceChild,e.roomId),i=null!==(u=null==n?void 0:n.getContent())&&void 0!==u?u:{via:[this.client.getDomain()]};await this.client.sendStateEvent(s.roomId,a.a.SpaceChild,g(g({},i),{},{order:t}),e.roomId)}}d=Object(r.y)(t)}const m=s.currentState.getStateEvents(a.a.SpaceChild,this.roomId),p=null!==(t=null==m?void 0:m.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(s.roomId,a.a.SpaceChild,g(g({},p),{},{order:d}),this.roomId)}async createFile(e,t,s,n){var i;const o=await this.client.uploadContent(t,{includeFilename:!1,onlyContentUri:!0,rawResponse:!1});s.url=o;const r={msgtype:a.b.File,body:e,url:o,file:s};(n=null!==(i=n)&&void 0!==i?i:{})["m.new_content"]&&(n["m.new_content"]=r);const c=await this.client.sendMessage(this.roomId,g(g(g({},n),r),{},{[a.j.name]:{}}));return await this.client.sendStateEvent(this.roomId,a.i.name,{active:!0,name:e},c.event_id),c}getFile(e){const t=this.room.currentState.getStateEvents(a.i.name,e);return t?new d(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(a.i.name))&&void 0!==e?e:[]).map(e=>new d(this.client,e,this))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(83),i=s.n(n),a=s(190),o=s(298),r=s(5),c=s(131),l=s(130),d=s(459);class h extends r.EventEmitter{constructor(e){super(),this.community=e,i()(this,"roomIds",new Set),i()(this,"userIds",new Set),i()(this,"onStoreUpdate",async()=>{const e=this.roomIds;this.roomIds=new Set((await c.a.getGroupRooms(this.community.groupId)).map(e=>e.roomId));const t=this.userIds;this.userIds=new Set((await c.a.getGroupMembers(this.community.groupId)).map(e=>e.userId)),(Object(d.a)(e,this.roomIds)||Object(d.a)(t,this.userIds))&&this.emit(o.a)}),c.a.on("update",this.onStoreUpdate),this.onStoreUpdate()}get kind(){return o.b.Prefilter}isVisible(e){return this.roomIds.has(e.roomId)||this.userIds.has(l.a.shared().getUserIdForRoomId(e.roomId))}destroy(){c.a.off("update",this.onStoreUpdate)}}var u=s(116),m=s(1);class p{constructor(e){this.store=e,i()(this,"filters",new Map),i()(this,"onTagsUpdated",()=>{const e=Array.from(this.filters.keys()),t=a.a.getSelectedTags();if(Object(u.d)(e,t)){if(!this.store.matrixClient)return void m.a.warn("Tag update without an associated matrix client - ignoring");const s=new Map,n=t.filter(e=>e.startsWith("+"));for(const e of n){const t=this.store.matrixClient.getGroup(e);if(!t){m.a.warn("Group selected with no group object available: "+e);continue}let n=this.filters.get(e);n||(n=new h(t)),s.set(e,n)}const i=Object(u.a)(e,t);for(const e of i.added){const t=s.get(e);t&&this.store.addFilter(t)}for(const e of i.removed){const t=this.filters.get(e);t&&(this.store.removeFilter(t),t.destroy())}this.filters=s}}),a.a.addListener(this.onTagsUpdated)}}}]]);
//# sourceMappingURL=init.js.map